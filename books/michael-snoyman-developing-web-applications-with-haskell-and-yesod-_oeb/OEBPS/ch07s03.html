---
layout: page
title: "Developing Web Applications with Haskell and Yesod"
prev: OEBPS/ch07s02.html
next: OEBPS/ch07s04.html
book_path: books/michael-snoyman-developing-web-applications-with-haskell-and-yesod-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>
<div class="book" title="The Handler Monad"><div class="book"><div class="book"><div class="book"><h1 class="title2"><a id="I_sect17_d1e3386" class="calibre1"></a>The Handler Monad</h1></div></div></div><p class="calibre7">The vast majority of code you write in Yesod sits in the <code class="literal">Handler</code>
            monad. If you are approaching this from an MVC (Model-View-Controller) background, your
                <code class="literal">Handler</code> code is the Controller. Some important points to know about
                <code class="literal">Handler</code>:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><p class="calibre7">It is an instance of <code class="literal">MonadIO</code>, so you can run any IO
                action in your handlers with <code class="literal">liftIO</code>. By the way, <code class="literal">liftIO</code> is exported by the <code class="literal">Yesod</code> module
                for your convenience.</p></li><li class="listitem"><p class="calibre7">Like <code class="literal">Widget</code>, <code class="literal">Handler</code> is a fake-monad-transformer. It wraps around a <code class="literal">ResourceT IO</code> monad. We discuss this type at length in the
          conduits appendix, but for now, we’ll just say it let’s you safely allocate
          resources.</p></li><li class="listitem"><p class="calibre7">By “fake,” I mean you can’t use the standard <code class="literal">lift</code>
          function provided by the <code class="function">transformers</code> package, you
          must use the Yesod-supplied one (just like with widgets).</p></li><li class="listitem"><p class="calibre7"><code class="literal">Handler</code> is just a type synonym around <code class="literal">GHandler</code>. <code class="literal">GHandler</code> let’s
          you specify exactly which subsite and master site you’re using. The <code class="literal">Handler</code> synonym says that the sub and master sites are your
          application’s type.</p></li><li class="listitem"><p class="calibre7"><code class="literal">Handler</code> provides a lot of different functionality, such as:</p><div class="book"><ul class="itemizedlist2"><li class="listitem"><p class="calibre7 pcalibre">Providing request information.</p></li><li class="listitem"><p class="calibre7 pcalibre">Keeping a list of the extra response headers you’ve added.</p></li><li class="listitem"><p class="calibre7 pcalibre">Allowing you to modify the user’s session.</p></li><li class="listitem"><p class="calibre7 pcalibre">Short-circuiting responses, for redirecting, sending static files, or
                        reporting errors.</p></li></ul></div></li></ul></div><p class="calibre7">The remainder of this chapter will give a brief introduction to some of the most
            common functions living in the <code class="literal">Handler</code> monad. I am specifically <span class="firstname"><em class="calibre4">not</em></span> covering any of the session functions; that will be addressed in
            the sessions chapter.</p><div class="book" title="Application Information"><div class="book"><div class="book"><div class="book"><h2 class="title4"><a id="id3082652" class="calibre1"></a>Application Information</h2></div></div></div><p class="calibre7">There are a number of functions that return information about your application as a whole, and give no information about individual requests. Some of these are:</p><div class="book"><dl class="book"><dt class="calibre9"><span class="firstname">getYesod</span></dt><dd class="calibre10"><p class="calibre7">Returns your application foundation value. If you store configuration values in
              your foundation, you will probably end up using this function a lot.</p></dd><dt class="calibre9"><span class="firstname">getYesodSub</span></dt><dd class="calibre10"><p class="calibre7">Get the subsite foundation value. Unless you are working in a subsite, this will return the same value as <code class="literal">getYesod</code>.</p></dd><dt class="calibre9"><span class="firstname">getUrlRender</span></dt><dd class="calibre10"><p class="calibre7">Returns the <em class="calibre4">URL rendering function</em>, which converts a
              type-safe URL into a <code class="literal">Text</code>. Most of the
              time—like with Hamlet—Yesod calls this function for you, but you may
              occasionally need to call it directly.</p></dd><dt class="calibre9"><span class="firstname">getUrlRenderParams</span></dt><dd class="calibre10"><p class="calibre7">A variant of <code class="literal">getUrlRender</code> that converts both a type-safe URL and a list of query-string parameters. This function handles all percent-encoding necessary.</p></dd></dl></div></div><div class="book" title="Request Information"><div class="book"><div class="book"><div class="book"><h2 class="title4"><a id="id3082719" class="calibre1"></a>Request Information</h2></div></div></div><p class="calibre7">The most common information you will want to get about the current request is the
            requested path, the query string parameters and POSTed form data. The first of those is
            dealt with in the routing, as described above. The other two are best dealt with using
            the forms module.</p><p class="calibre7">That said, you will sometimes need to get the data in a more raw format. For this
        purpose, Yesod exposes the <code class="literal">Request</code> data type along with
        the <code class="literal">getRequest</code> function to retrieve it. This gives you
        access to the full list of GET parameters, cookies, and preferred languages. There are some
        convenient functions to make these lookups easier, such as <code class="literal">lookupGetParam</code>, <code class="literal">lookupCookie</code>, and <code class="literal">languages</code>. For raw access to the POST parameters, you should use
          <code class="literal">runRequest</code>.</p><p class="calibre7">If you need even more raw data, like request headers, you can use <code class="literal">waiRequest</code> to access the Web Application Interface (WAI) request value.
            See the WAI appendix for more details.</p></div><div class="book" title="Short Circuiting"><div class="book"><div class="book"><div class="book"><h2 class="title4"><a id="id3082781" class="calibre1"></a>Short Circuiting</h2></div></div></div><p class="calibre7">The following functions immediately end execution of a handler function and return a result to the user.</p><div class="book"><dl class="book"><dt class="calibre9"><span class="firstname">redirect</span></dt><dd class="calibre10"><p class="calibre7">Sends a redirect response to the user (a 303 response). If you want to use a different
                    response code (e.g., a permanent 301 redirect), you can use
                        <code class="literal">redirectWith</code>.</p><div class="tip" title="Note"><h3 class="title3">Note</h3><p class="calibre7">Yesod uses a 303 response for HTTP/1.1
                        clients, and a 302 response for HTTP/1.0 clients. You can read up on this
                        sordid saga in the HTTP spec.</p></div></dd><dt class="calibre9"><span class="firstname">notFound</span></dt><dd class="calibre10"><p class="calibre7">Return a 404 response. This can be useful if a user requests a database value that
              doesn’t exist.</p></dd><dt class="calibre9"><span class="firstname">permissionDenied</span></dt><dd class="calibre10"><p class="calibre7">Return a 403 response with a specific error message.</p></dd><dt class="calibre9"><span class="firstname">invalidArgs</span></dt><dd class="calibre10"><p class="calibre7">A 400 response with a list of invalid arguments.</p></dd><dt class="calibre9"><span class="firstname">sendFile</span></dt><dd class="calibre10"><p class="calibre7">Sends a file from the filesystem with a specified content type. This is the preferred way to send static files, since the underlying WAI handler may be able to optimize this to a <code class="literal">sendfile</code> system call. Using <code class="literal">readFile</code> for sending static files should not be necessary.</p></dd><dt class="calibre9"><span class="firstname">sendResponse</span></dt><dd class="calibre10"><p class="calibre7">Send a normal <code class="literal">HasReps</code> response with a 200 status code. This is really
                    just a convenience for when you need to break out of some deeply nested code
                    with an immediate response.</p></dd><dt class="calibre9"><span class="firstname">sendWaiResponse</span></dt><dd class="calibre10"><p class="calibre7">When you need to get low-level and send out a raw WAI response. This can be
                    especially useful for creating streaming responses or a technique like
                    server-sent events.</p></dd></dl></div></div><div class="book" title="Response Headers"><div class="book"><div class="book"><div class="book"><h2 class="title4"><a id="id3082881" class="calibre1"></a>Response Headers</h2></div></div></div><div class="book"><dl class="book"><dt class="calibre9"><span class="firstname">setCookie</span></dt><dd class="calibre10"><p class="calibre7">Set a cookie on the client. Instead of taking an expiration date, this function
              takes a cookie duration in minutes. Remember, you won’t see this cookie using <code class="literal">lookupCookie</code> until the <span class="firstname"><em class="calibre4">following</em></span>
              request.</p></dd><dt class="calibre9"><span class="firstname">deleteCookie</span></dt><dd class="calibre10"><p class="calibre7">Tells the client to remove a cookie. Once again, <code class="literal">lookupCookie</code> will not reflect this change until the next request.</p></dd><dt class="calibre9"><span class="firstname">setHeader</span></dt><dd class="calibre10"><p class="calibre7">Set an arbitrary response header.</p></dd><dt class="calibre9"><span class="firstname">setLanguage</span></dt><dd class="calibre10"><p class="calibre7">Set the preferred user language, which will show up in the result of the <code class="literal">languages</code> function.</p></dd><dt class="calibre9"><span class="firstname">cacheSeconds</span></dt><dd class="calibre10"><p class="calibre7">Set a Cache-Control header to indicate how many seconds this response can be cached. This can be particularly useful if you are using <a class="ulink" href="http://www.varnish-cache.org">varnish on your server</a>.</p></dd><dt class="calibre9"><span class="firstname">neverExpires</span></dt><dd class="calibre10"><p class="calibre7">Set the Expires header to the year 2037. You can use this with content which should never expire, such as when the request path has a hash value associated with it.</p></dd><dt class="calibre9"><span class="firstname">alreadyExpired</span></dt><dd class="calibre10"><p class="calibre7">Sets the Expires header to the past.</p></dd><dt class="calibre9"><span class="firstname">expiresAt</span></dt><dd class="calibre10"><p class="calibre7">Sets the Expires header to the specified date/time.</p></dd></dl></div></div></div></div>

{% endraw %}

