---
layout: page
title: "Seven Databases in Seven Weeks: A Guide to Modern Databases and the NoSQL Movement"
prev: None
next: None
book_path: books/seven-databases-in-seven-weeks--_oeb/
---
{% include JB/setup %}
{% raw %}
<div>
<div id="filepos109" class="calibre1"><blockquote class="calibre2"><span class="calibre3"><span class="bold"><span class="calibre4">Seven Databases in Seven Weeks</span></span></span></blockquote><blockquote class="calibre2"><span class="calibre5"><span class="bold"><span class="calibre6">A Guide to Modern Databases</span></span></span><br class="calibre1"/><span class="calibre5"><span class="bold"><span class="calibre6"> and the NoSQL Movement</span></span></span></blockquote><blockquote class="calibre7"><span class="calibre5"><span class="bold"><span class="calibre6">by Eric Redmond, Jim R. Wilson</span></span></span></blockquote><blockquote class="calibre8"><span class="calibre9"><span class="calibre6">Version: P1..0 (May 2012)</span></span></blockquote><blockquote class="calibre10"><span class="calibre9"><span class="calibre11">Copyright © 2012 Pragmatic Programmers, LLC. This book is licensed to the individual who purchased it. We don't copy-protect it because that would limit your ability to use it for your own purposes. Please don't break this trust—you can use this across all of your devices but please do not share this copy with other members of your team, with friends, or via file sharing services. Thanks. </span></span><br class="calibre1"/><span class="calibre9"><span class="calibre11">—Dave &amp; Andy.</span></span></blockquote><div class="calibre1"></div><div class="mbppagebreak"></div></div><div class="calibre1"><p class="calibre12"><span class="calibre3"><span class="bold">
</span></span></p><p class="calibre12"><span class="calibre9"> Many of the designations used by manufacturers and sellers to distinguish their products are claimed as trademarks. Where those designations appear in this book, and The Pragmatic Programmers, LLC was aware of a trademark claim, the designations have been printed in initial capital letters or in all capitals. The Pragmatic Starter Kit, The Pragmatic Programmer, Pragmatic Programming, Pragmatic Bookshelf and the linking </span><span class="calibre9"><span class="italic">g</span></span><span class="calibre9"> device are trademarks of The Pragmatic Programmers, LLC.</span>
</p><p class="calibre12"><span class="calibre9"> Every precaution was taken in the preparation of this book. However, the publisher assumes no responsibility for errors or omissions, or for damages that may result from the use of information (including program listings) contained herein.</span>
</p><p class="calibre12"><span class="calibre9"> Our Pragmatic courses, workshops, and other products can help you and your team create better software and have more fun. For more information, as well as the latest Pragmatic titles, please visit us at </span><a href="http://pragprog.com"><span class="calibre9"><span class="calibre13"><span class="underline">http://pragprog.com</span></span></span></a><span class="calibre9">.</span>
</p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos2777" class="calibre1"><p class="calibre12"><span class="calibre3"><span class="bold">Table of Contents</span></span></p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td><td valign="top" class="calibre16"><a href="#filepos22452"><span class="calibre13"><span class="underline">Foreword</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td><td valign="top" class="calibre16"><a href="#filepos26807"><span class="calibre13"><span class="underline">Acknowledgments</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td><td valign="top" class="calibre16"><a href="#filepos29875"><span class="calibre13"><span class="underline">Preface</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos30651"><span class="calibre13"><span class="underline">Why Seven Databases</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos31701"><span class="calibre13"><span class="underline">What’s in This Book</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos33643"><span class="calibre13"><span class="underline">What This Book Is Not</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos36215"><span class="calibre13"><span class="underline">Code Examples and Conventions</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos37179"><span class="calibre13"><span class="underline">Online Resources</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos39028"><span class="calibre13"><span class="underline">1. </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos39028"><span class="calibre13"><span class="underline">Introduction</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos40209"><span class="calibre13"><span class="underline">1.1 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos40209"><span class="calibre13"><span class="underline">It Starts with a Question</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos44926"><span class="calibre13"><span class="underline">1.2 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos44926"><span class="calibre13"><span class="underline">The Genres</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos57345"><span class="calibre13"><span class="underline">1.3 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos57345"><span class="calibre13"><span class="underline">Onward and Upward</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos58943"><span class="calibre13"><span class="underline">2. </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos58943"><span class="calibre13"><span class="underline">PostgreSQL</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos60528"><span class="calibre13"><span class="underline">2.1 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos60528"><span class="calibre13"><span class="underline">That’s Post-greS-Q-L</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos64308"><span class="calibre13"><span class="underline">2.2 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos64308"><span class="calibre13"><span class="underline">Day 1: Relations, CRUD, and Joins</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos137432"><span class="calibre13"><span class="underline">2.3 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos137432"><span class="calibre13"><span class="underline">Day 2: Advanced Queries, Code, and Rules</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos248194"><span class="calibre13"><span class="underline">2.4 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos248194"><span class="calibre13"><span class="underline">Day 3: Full-Text and Multidimensions</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos352197"><span class="calibre13"><span class="underline">2.5 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos352197"><span class="calibre13"><span class="underline">Wrap-Up</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos359261"><span class="calibre13"><span class="underline">3. </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos359261"><span class="calibre13"><span class="underline">Riak</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos361058"><span class="calibre13"><span class="underline">3.1 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos361058"><span class="calibre13"><span class="underline">Riak Loves the Web</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos363247"><span class="calibre13"><span class="underline">3.2 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos363247"><span class="calibre13"><span class="underline">Day 1: CRUD, Links, and MIMEs</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos436193"><span class="calibre13"><span class="underline">3.3 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos436193"><span class="calibre13"><span class="underline">Day 2: Mapreduce and Server Clusters</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos533699"><span class="calibre13"><span class="underline">3.4 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos533699"><span class="calibre13"><span class="underline">Day 3: Resolving Conflicts and Extending Riak</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos607088"><span class="calibre13"><span class="underline">3.5 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos607088"><span class="calibre13"><span class="underline">Wrap-Up</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos618173"><span class="calibre13"><span class="underline">4. </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos618173"><span class="calibre13"><span class="underline">HBase</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos620664"><span class="calibre13"><span class="underline">4.1 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos620664"><span class="calibre13"><span class="underline">Introducing HBase</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos623045"><span class="calibre13"><span class="underline">4.2 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos623045"><span class="calibre13"><span class="underline">Day 1: CRUD and Table Administration</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos676101"><span class="calibre13"><span class="underline">4.3 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos676101"><span class="calibre13"><span class="underline">Day 2: Working with Big Data</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos801644"><span class="calibre13"><span class="underline">4.4 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos801644"><span class="calibre13"><span class="underline">Day 3: Taking It to the Cloud</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos850171"><span class="calibre13"><span class="underline">4.5 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos850171"><span class="calibre13"><span class="underline">Wrap-Up</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos860653"><span class="calibre13"><span class="underline">5. </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos860653"><span class="calibre13"><span class="underline">MongoDB</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos862229"><span class="calibre13"><span class="underline">5.1 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos862229"><span class="calibre13"><span class="underline">Hu(mongo)us</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos865186"><span class="calibre13"><span class="underline">5.2 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos865186"><span class="calibre13"><span class="underline">Day 1: CRUD and Nesting</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos988582"><span class="calibre13"><span class="underline">5.3 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos988582"><span class="calibre13"><span class="underline">Day 2: Indexing, Grouping, Mapreduce</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos1088295"><span class="calibre13"><span class="underline">5.4 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos1088295"><span class="calibre13"><span class="underline">Day 3: Replica Sets, Sharding, GeoSpatial, and GridFS</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos1139635"><span class="calibre13"><span class="underline">5.5 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos1139635"><span class="calibre13"><span class="underline">Wrap-Up</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1144187"><span class="calibre13"><span class="underline">6. </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos1144187"><span class="calibre13"><span class="underline">CouchDB</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos1145782"><span class="calibre13"><span class="underline">6.1 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos1145782"><span class="calibre13"><span class="underline">Relaxing on the Couch</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos1148254"><span class="calibre13"><span class="underline">6.2 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos1148254"><span class="calibre13"><span class="underline">Day 1: CRUD, Futon, and cURL Redux</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos1195659"><span class="calibre13"><span class="underline">6.3 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos1195659"><span class="calibre13"><span class="underline">Day 2: Creating and Querying Views</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos1308831"><span class="calibre13"><span class="underline">6.4 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos1308831"><span class="calibre13"><span class="underline">Day 3: Advanced Views, Changes API, and Replicating Data</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos1424550"><span class="calibre13"><span class="underline">6.5 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos1424550"><span class="calibre13"><span class="underline">Wrap-Up</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1431213"><span class="calibre13"><span class="underline">7. </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos1431213"><span class="calibre13"><span class="underline">Neo4J</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos1432795"><span class="calibre13"><span class="underline">7.1 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos1432795"><span class="calibre13"><span class="underline">Neo4J Is Whiteboard Friendly</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos1435522"><span class="calibre13"><span class="underline">7.2 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos1435522"><span class="calibre13"><span class="underline">Day 1: Graphs, Groovy, and CRUD</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos1539549"><span class="calibre13"><span class="underline">7.3 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos1539549"><span class="calibre13"><span class="underline">Day 2: REST, Indexes, and Algorithms</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos1626817"><span class="calibre13"><span class="underline">7.4 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos1626817"><span class="calibre13"><span class="underline">Day 3: Distributed High Availability</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos1661850"><span class="calibre13"><span class="underline">7.5 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos1661850"><span class="calibre13"><span class="underline">Wrap-Up</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1669058"><span class="calibre13"><span class="underline">8. </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos1669058"><span class="calibre13"><span class="underline">Redis</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos1670376"><span class="calibre13"><span class="underline">8.1 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos1670376"><span class="calibre13"><span class="underline">Data Structure Server Store</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos1672753"><span class="calibre13"><span class="underline">8.2 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos1672753"><span class="calibre13"><span class="underline">Day 1: CRUD and Datatypes</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos1748759"><span class="calibre13"><span class="underline">8.3 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos1748759"><span class="calibre13"><span class="underline">Day 2: Advanced Usage, Distribution</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos1853806"><span class="calibre13"><span class="underline">8.4 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos1853806"><span class="calibre13"><span class="underline">Day 3: Playing with Other Databases</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos1942585"><span class="calibre13"><span class="underline">8.5 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos1942585"><span class="calibre13"><span class="underline">Wrap-Up</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1949350"><span class="calibre13"><span class="underline">9. </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos1949350"><span class="calibre13"><span class="underline">Wrapping Up</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos1950549"><span class="calibre13"><span class="underline">9.1 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos1950549"><span class="calibre13"><span class="underline">Genres Redux</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos1960351"><span class="calibre13"><span class="underline">9.2 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos1960351"><span class="calibre13"><span class="underline">Making a Choice</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos1963420"><span class="calibre13"><span class="underline">9.3 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos1963420"><span class="calibre13"><span class="underline">Where Do We Go from Here?</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1964837"><span class="calibre13"><span class="underline">A. </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos1964837"><span class="calibre13"><span class="underline">Database Overview Tables</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1996601"><span class="calibre13"><span class="underline">B. </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos1996601"><span class="calibre13"><span class="underline">The CAP Theorem</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos2001014"><span class="calibre13"><span class="underline">A2.1 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos2001014"><span class="calibre13"><span class="underline">Eventual Consistency</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos2004065"><span class="calibre13"><span class="underline">A2.2 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos2004065"><span class="calibre13"><span class="underline">CAP in the Wild</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos2005737"><span class="calibre13"><span class="underline">A2.3 </span></span></a>  </td><td valign="top" class="calibre16"><a href="#filepos2005737"><span class="calibre13"><span class="underline">The Latency Trade-Off</span></span></a>  </td></tr></table><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16"><a href="#filepos2007964"><span class="calibre13"><span class="underline">Bibliography</span></span></a>  </td></tr></table><p class="calibre17"><span class="calibre9"><span class="calibre18"><span class="calibre19">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos19271" class="calibre1"><p class="calibre12"><span class="calibre3"><span class="bold"> What Readers Are Saying About Seven Databases in Seven Weeks </span></span></p><a></a><p class="calibre12"> The flow is perfect. On Friday, you’ll be up and running with a new database. On Saturday, you’ll see what it’s like under daily use. By Sunday, you’ll have learned a few tricks that might even surprise the experts! And next week, you’ll vault to another database and have fun all over again. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">→  </td><td valign="top" class="calibre16">Ian Dees </td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16">Coauthor, <span class="italic">Using JRuby</span>  </td></tr></table><a></a><p class="calibre20"> Provides a great overview of several key databases that will multiply your data modeling options and skills. Read if you want database envy seven times in a row. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">→  </td><td valign="top" class="calibre16">Sean Copenhaver </td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16">Lead Code Commodore, backgroundchecks.com </td></tr></table><a></a><p class="calibre20"> This is by far the best substantive overview of modern databases. Unlike the host of tutorials, blog posts, and documentation I have read, this book taught me why I would want to use each type of database and the ways in which I can use them in a way that made me easily understand and retain the information. It was a pleasure to read. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">→  </td><td valign="top" class="calibre16">Loren Sands-Ramshaw </td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16">Software Engineer, U.S. Department of Defense </td></tr></table><a></a><p class="calibre20"> This is one of the best CouchDB introductions I have seen. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">→  </td><td valign="top" class="calibre16">Jan Lehnardt </td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16">Apache CouchDB Developer and Author </td></tr></table><a></a><p class="calibre20"><span class="italic">Seven Databases in Seven Weeks</span> is an excellent introduction to all aspects of modern database design and implementation. Even spending a day in each chapter will broaden understanding at all skill levels, from novice to expert—there’s something there for everyone. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">→  </td><td valign="top" class="calibre16">Jerry Sievert </td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16">Director of Engineering, Daily Insight Group </td></tr></table><a></a><p class="calibre20"> In an ideal world, the book cover would have been big enough to call this book “Everything you never thought you wanted to know about databases that you can’t possibly live without.” To be fair, <span class="italic">Seven Databases in Seven Weeks</span> will probably sell better. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">→  </td><td valign="top" class="calibre16">Dr Nic Williams </td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  </td><td valign="top" class="calibre16">VP of Technology, Engine Yard </td></tr></table><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos22447" class="calibre1"><a id="filepos22452"></a><br class="calibre1"/><p class="calibre21"><span class="calibre3"><span class="bold"><span class="calibre4">Foreword</span></span></span></p><a></a><p class="calibre12"> Riding up the Beaver Run SuperChair in Breckenridge, Colorado, we wondered where the fresh powder was. Breckenridge made snow, and the slopes were immaculately groomed, but there was an inevitable sameness to the conditions on the mountain. Without fresh snow, the total experience was lacking. </p><a></a><p class="calibre12"> In 1994, as an employee of IBM’s database development lab in Austin, I had very much the same feeling. I had studied object-oriented databases at the University of Texas at Austin because after a decade of relational dominance, I thought that object-oriented databases had a real chance to take root. Still, the next decade brought more of the same relational models as before. I watched dejectedly as Oracle, IBM, and later the open source solutions led by MySQL spread their branches wide, completely blocking out the sun for any sprouting solutions on the fertile floor below. </p><a></a><p class="calibre12"> Over time, the user interfaces changed from green screens to client-server to Internet-based applications, but the coding of the relational layer stretched out to a relentless barrage of sameness, spanning decades of perfectly competent tedium. So, we waited for the fresh blanket of snow. </p><a></a><p class="calibre12"> And then the fresh powder finally came. At first, the dusting wasn’t even enough to cover this morning’s earliest tracks, but the power of the storm took over, replenishing the landscape and delivering the perfect skiing experience with the diversity and quality that we craved. Just this past year, I woke up to the realization that the database world, too, is covered with a fresh blanket of snow. Sure, the relational databases are there, and you can get a surprisingly rich experience with open source RDBMS software. You can do clustering, full-text search, and even fuzzy searching. But you’re no longer limited to that approach. I have not built a fully relational solution in a year. Over that time, I’ve used a document-based database and a couple of key-value datastores. </p><a></a><p class="calibre12"> The truth is that relational databases no longer have a monopoly on flexibility or even scalability. For the kinds of applications that we build, there are more appropriate models that are simpler, faster, and more reliable. As a person who spent ten years at IBM Austin working on databases with our labs and customers, this development is simply stunning to me. In <span class="italic">Seven Databases in Seven Weeks</span>, you’ll work through examples that cover a beautiful cross section of the most critical advances in the databases that back Internet development. Within key-value stores, you’ll learn about the radically scalable and reliable Riak and the beautiful query mechanisms in Redis. From the columnar database community, you’ll sample the power of HBase, a close cousin of the relational database models. And from the document-oriented database stores, you’ll see the elegant solutions for deeply nested documents in the wildly scalable MongoDB. You’ll also see Neo4J’s spin on graph databases, allowing rapid traversal of relationships. </p><a></a><p class="calibre12"> You won’t have to use all of these databases to be a better programmer or database admin. As Eric Redmond and Jim Wilson take you on this magical tour, every step will make you smarter and lend the kind of insight that is invaluable in a modern software professional. You will know where each platform shines and where it is the most limited. You will see where your industry is moving and learn the forces driving it there. </p><a></a><p class="calibre12"> Enjoy the ride. </p><p class="calibre12">
</p><p class="calibre22">Bruce Tate</p><p class="calibre22"><span class="calibre9">author of </span><span class="calibre9"><span class="italic">Seven Languages in Seven Weeks</span></span><span class="calibre9">
</span></p><p class="calibre22"><span class="calibre9">Austin, Texas, May 2012</span></p><p class="calibre17"><span class="calibre9"><span class="calibre18"><span class="calibre19">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos26802" class="calibre1"><a id="filepos26807"></a><br class="calibre1"/><p class="calibre21"><span class="calibre3"><span class="bold"><span class="calibre4">Acknowledgments</span></span></span></p><a></a><p class="calibre12"> A book with the size and scope of this one cannot be done by two mere authors alone. It requires the effort of many very smart people with superhuman eyes spotting as many mistakes as possible and providing valuable insights into the details of these technologies. </p><a></a><p class="calibre12"> We’d like to thank, in no particular order, all of the folks who provided their time and expertise: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  Ian Dees   </td><td valign="top" class="calibre16">  Mark Phillips   </td><td valign="top" class="calibre16">  Jan Lenhardt   </td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  Robert Stam   </td><td valign="top" class="calibre16">  Oleg Bartunov   </td><td valign="top" class="calibre16">  Dave Purrington   </td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  Daniel Bretoi   </td><td valign="top" class="calibre16">  Matt Adams   </td><td valign="top" class="calibre16">  Sean Copenhaver   </td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">  Loren Sands-Ramshaw   </td><td valign="top" class="calibre16">  Emil Eifrem   </td><td valign="top" class="calibre16">  Andreas Kollegger   </td></tr></table><a></a><p class="calibre23"> Finally, thanks to Bruce Tate for his experience and guidance. </p><a></a><p class="calibre12"> We’d also like to sincerely thank the entire team at the Pragmatic Bookshelf. Thanks for entertaining this audacious project and seeing us through it. We’re especially grateful to our editor, Jackie Carter. Your patient feedback made this book what it is today. Thanks to the whole team who worked so hard to polish this book and find all of our mistakes. </p><a></a><p class="calibre12"> Last but not least, thanks to Frederic Dumont, Matthew Flower, Rebecca Skinner, and all of our relentless readers. If it weren’t for your passion to learn, we wouldn’t have had this opportunity to serve you. </p><a></a><p class="calibre12"> For anyone we missed, we hope you’ll accept our apologies. Any omissions were certainly not intentional. </p><a></a><p class="calibre12"> From Eric: Dear Noelle, you’re not special; you’re unique, and that’s so much better. Thanks for living through another book. Thanks also to the database creators and commiters for providing us something to write about and make a living at. </p><a></a><p class="calibre12"> From Jim: First, I have to thank my family; Ruthy, your boundless patience and encouragement have been heartwarming. Emma and Jimmy, you’re two smart cookies, and your daddy loves you always. Also a special thanks to all the unsung heroes who monitor IRC, message boards, mailing lists, and bug systems ready to help anyone who needs you. Your dedication to open source keeps these projects kicking. </p><p class="calibre17"><span class="calibre9"><span class="calibre18"><span class="calibre19">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos29870" class="calibre1"><a id="filepos29875"></a><br class="calibre1"/><p class="calibre21"><span class="calibre3"><span class="bold"><span class="calibre4">Preface</span></span></span></p><a></a><p class="calibre12"> It has been said that data is the new oil. If this is so, then databases are the fields, the refineries, the drills, and the pumps. Data is stored in databases, and if you’re interested in tapping into it, then coming to grips with the modern equipment is a great start. </p><a></a><p class="calibre12"> Databases are tools; they are the means to an end. Each database has its own story and its own way of looking at the world. The more you understand them, the better you will be at harnessing the latent power in the ever-growing corpus of data at your disposal. </p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos30646" class="calibre1"><p class="calibre24" id="filepos30651"><span class="calibre25"><span class="bold"><span class="calibre26">Why Seven Databases</span></span></span></p><a></a><p class="calibre27"> As early as March 2010, we had wanted to write a NoSQL book. The term had been gathering buzz, and although lots of people were talking about it, there seemed to be a fair amount of confusion around it too. What exactly does the term <span class="italic">NoSQL</span> mean? Which types of systems are included? How is this going to impact the practice of making great software? These were questions we wanted to answer—as much for ourselves as for others. </p><a></a><p class="calibre12"> After reading Bruce Tate’s exemplary <span class="italic">Seven Languages in Seven Weeks: A Pragmatic Guide to Learning Programming Languages</span> [Tat10], we knew he was onto something. The progressive style of introducing languages struck a chord with us. We felt teaching databases in the same manner would provide a smooth medium for tackling some of these tough NoSQL questions. </p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos31696" class="calibre1"><p class="calibre24" id="filepos31701"><span class="calibre25"><span class="bold"><span class="calibre26">What’s in This Book</span></span></span></p><a></a><p class="calibre27"> This book is aimed at experienced developers who want a well-rounded understanding of the modern database landscape. Prior database experience is not strictly required, but it helps. </p><a></a><p class="calibre12"> After a brief introduction, this book tackles a series of seven databases chapter by chapter. The databases were chosen to span five different database genres or styles, which are discussed in Chapter 1, <a href="#filepos39028"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Introduction</span></span><span class="calibre13"><span class="underline">​</span></span></a>. In order, they are PostgreSQL, Riak, Apache HBase, MongoDB, Apache CouchDB, Neo4J, and Redis. </p><a></a><p class="calibre12"> Each chapter is designed to be taken as a long weekend’s worth of work, split up into three days. Each day ends with exercises that expand on the topics and concepts just introduced, and each chapter culminates in a wrap-up discussion that summarizes the good and bad points about the database. You may choose to move a little faster or slower, but it’s important to grasp each day’s concepts before continuing. We’ve tried to craft examples that explore each database’s distinguishing features. To really understand what these databases have to offer, you have to spend some time using them, and that means rolling up your sleeves and doing some work. </p><a></a><p class="calibre12"> Although you may be tempted to skip chapters, we designed this book to be read linearly. Some concepts, such as mapreduce, are introduced in depth in earlier chapters and then skimmed over in later ones. The goal of this book is to attain a solid understanding of the modern database field, so we recommend you read them all. </p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos33638" class="calibre1"><p class="calibre24" id="filepos33643"><span class="calibre25"><span class="bold"><span class="calibre26">What This Book Is Not</span></span></span></p><a></a><p class="calibre27"> Before reading this book, you should know what it won’t cover. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">This Is Not an Installation Guide</span></span></span></p><a></a><p class="calibre29"> Installing the databases in this book is sometimes easy, sometimes challenging, and sometimes downright ugly. For some databases, you’ll be able to use stock packages, and for others, you’ll need to compile from source. We’ll point out some useful tips here and there, but by and large you’re on your own. Cutting out installation steps allows us to pack in more useful examples and a discussion of concepts, which is what you really want anyway, right? </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Administration Manual? We Think Not</span></span></span></p><a></a><p class="calibre29"> Along the same lines of installation, this book will not cover everything you’d find in an administration manual. Each of these databases has myriad options, settings, switches, and configuration details, most of which are well documented on the Web. We’re more interested in teaching you useful concepts and full immersion than focusing on the day-to-day operations. Though the characteristics of the databases can change based on operational settings—and we may discuss those characteristics—we won’t be able to go into all the nitty-gritty details of all possible configurations. There simply isn’t space! </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">A Note to Windows Users</span></span></span></p><p class="calibre29" id="filepos35392"> This book is inherently about choices, predominantly open source software on *nix platforms. Microsoft environments tend to strive for an integrated environment, which limits many choices to a smaller predefined set. As such, the databases we cover are open source and are developed by (and largely <span class="italic">for</span>) users of *nix systems. This is not our own bias so much as a reflection of the current state of affairs. Consequently, our tutorial-esque examples are presumed to be run in a *nix shell. If you run Windows and want to give it a try anyway, we recommend setting up Cygwin<a href="#filepos38023"><span class="calibre13"><span class="underline">[1]</span></span></a> to give you the best shot at success. You may also want to consider running a Linux virtual machine. </p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos36210" class="calibre1"><p class="calibre24" id="filepos36215"><span class="calibre25"><span class="bold"><span class="calibre26">Code Examples and Conventions</span></span></span></p><a></a><p class="calibre27"> This book contains code in a variety of languages. In part, this is a consequence of the databases that we cover. We’ve attempted to limit our choice of languages to Ruby/JRuby and JavaScript. We prefer command-line tools to scripts, but we will introduce other languages to get the job done—like PL/pgSQL (Postgres) and Gremlin/Groovy (Neo4J). We’ll also explore writing some server-side JavaScript applications with Node.js. </p><a></a><p class="calibre12"> Except where noted, code listings are provided in full, usually ready to be executed at your leisure. Samples and snippets are syntax highlighted according to the rules of the language involved. Shell commands are prefixed by <span class="calibre9"><span class="calibre30">$</span></span>.</p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos37174" class="calibre1"><p class="calibre24" id="filepos37179"><span class="calibre25"><span class="bold"><span class="calibre26">Online Resources</span></span></span></p><p class="calibre27" id="filepos37302"> The Pragmatic Bookshelf’s page for this book<a href="#filepos38023"><span class="calibre13"><span class="underline">[2]</span></span></a> is a great resource. There you’ll find downloads for all the source code presented in this book. You’ll also find feedback tools such as a community forum and an errata submission form where you can recommend changes to future releases of the book. </p><a></a><p class="calibre12"> Thanks for coming along with us on this journey through the modern database landscape. </p><p class="calibre12">
</p><p class="calibre22">Eric Redmond and Jim R. Wilson</p><p class="calibre23"><span class="calibre9"><span class="bold"><span class="calibre28">Footnotes</span></span></span></p><a id="filepos38023"></a><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos35392"><span class="calibre9"><span class="calibre13"><span class="underline">[1]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://www.cygwin.com/"><span class="calibre9"><span class="calibre13"><span class="underline">http://www.cygwin.com/</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos37302"><span class="calibre9"><span class="calibre13"><span class="underline">[2]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://pragprog.com/book/rwdata/seven-databases-in-seven-weeks"><span class="calibre9"><span class="calibre13"><span class="underline">http://pragprog.com/book/rwdata/seven-databases-in-seven-weeks</span></span></span></a><span class="calibre9">
</span></p></td></tr></table><p class="calibre17"><span class="calibre9"><span class="calibre18"><span class="calibre19">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos39023" class="calibre1"><p class="calibre21" id="filepos39028"><span class="calibre3"><span class="bold"><span class="calibre31"> Chapter 1</span></span></span></p><br class="calibre1"/><p class="calibre32"><span class="calibre3"><span class="bold"><span class="calibre4">Introduction</span></span></span></p><a></a><p class="calibre12"> This is a pivotal time in the database world. For years the relational model has been the <span class="italic">de facto</span> option for problems big and small. We don’t expect relational databases will fade away anytime soon, but people are emerging from the RDBMS fog to discover alternative options, such as schemaless or alternative data structures, simple replication, high availability, horizontal scaling, and new query methods. These options are collectively known as <span class="italic">NoSQL</span> and make up the bulk of this book. </p><a></a><p class="calibre12"> In this book, we explore seven databases across the spectrum of database styles. In the process of reading the book, you will learn the various functionality and trade-offs each database has—durability vs. speed, absolute vs. eventual consistency, and so on—and how to make the best decisions for your use cases. </p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos40204" class="calibre1"><p class="calibre24" id="filepos40209"><span class="calibre25"><span class="bold"><span class="calibre26">1.1 It Starts with a Question</span></span></span></p><a></a><p class="calibre27"> The central question of <span class="italic">Seven Databases in Seven Weeks</span> is this: what database or combination of databases best resolves your problem? If you walk away understanding how to make that choice, given your particular needs and resources at hand, we’re happy. </p><a></a><p class="calibre12"> But to answer that question, you’ll need to understand your options. For that, we’ll take you on a deep dive into each of seven databases, uncovering the good parts and pointing out the not so good. You’ll get your hands dirty with CRUD, flex your schema muscles, and find answers to these questions: </p><div class="calibre33"> </div><ul class="calibre34"><li value="1" class="calibre35"><p class="calibre22"><span class="italic">What type of datastore is this?</span> Databases come in a variety of genres, such as relational, key-value, columnar, document-oriented, and graph. Popular databases—including those covered in this book—can generally be grouped into one of these broad categories. You’ll learn about each type and the kinds of problems for which they’re best suited. We’ve specifically chosen databases to span these categories including one relational database (Postgres), two key-value stores (Riak, Redis), a column-oriented database (HBase), two document-oriented databases (MongoDB, CouchDB), and a graph database (Neo4J). </p></li><li value="2" class="calibre36"><p class="calibre22"><span class="italic">What was the driving force?</span> Databases are not created in a vacuum. They are designed to solve problems presented by real use cases. RDBMS databases arose in a world where query flexibility was more important than flexible schemas. On the other hand, column-oriented datastores were built to be well suited for storing large amounts of data across several machines, while data relationships took a backseat. We’ll cover cases in which to use each database and related examples. </p></li><li value="3" class="calibre36"><p class="calibre22"><span class="italic">How do you talk to it?</span> Databases often support a variety of connection options. Whenever a database has an interactive command-line interface, we’ll start with that before moving on to other means. Where programming is needed, we’ve stuck mostly to Ruby and JavaScript, though a few other languages sneak in from time to time—like PL/pgSQL (Postgres) and Gremlin (Neo4J). At a lower level, we’ll discuss protocols like REST (CouchDB, Riak) and Thrift (HBase). In the final chapter, we present a more complex database setup tied together by a Node.js JavaScript implementation. </p></li><li value="4" class="calibre36"><p class="calibre22"><span class="italic">What makes it unique?</span> Any datastore will support writing data and reading it back out again. What else it does varies greatly from one to the next. Some allow querying on arbitrary fields. Some provide indexing for rapid lookup. Some support ad hoc queries; for others, queries must be planned. Is schema a rigid framework enforced by the database or merely a set of guidelines to be renegotiated at will? Understanding capabilities and constraints will help you pick the right database for the job. </p></li><li value="5" class="calibre36"><p class="calibre22"><span class="italic">How does it perform?</span> How does this database function and at what cost? Does it support sharding? How about replication? Does it distribute data evenly using consistent hashing, or does it keep like data together? Is this database tuned for reading, writing, or some other operation? How much control do you have over its tuning, if any? </p></li><li value="6" class="calibre36"><p class="calibre22"><span class="italic">How does it scale?</span> Scalability is related to performance. Talking about scalability without the context of what you want to <span class="italic">scale to</span> is generally fruitless. This book will give you the background you need to ask the right questions to establish that context. While the discussion on <span class="italic">how</span> to scale each database will be intentionally light, in these pages you’ll find out whether each datastore is geared more for horizontal scaling (MongoDB, HBase, Riak), traditional vertical scaling (Postgres, Neo4J, Redis), or something in between. </p></li></ul><a></a><p class="calibre12"> Our goal is not to guide a novice to mastery of any of these databases. A full treatment of any one of them could (and does) fill entire books. But by the end you should have a firm grasp of the strengths of each, as well as how they differ. </p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos44921" class="calibre1"><p class="calibre24" id="filepos44926"><span class="calibre25"><span class="bold"><span class="calibre26">1.2 The Genres</span></span></span></p><a></a><p class="calibre27"> Like music, databases can be broadly classified into one or more styles. An individual song may share all of the same notes with other songs, but some are more appropriate for certain uses. Not many people blast Bach’s <span class="italic">Mass in B Minor</span> out an open convertible speeding down the 405. Similarly, some databases are better for some situations over others. The question you must always ask yourself is not “Can I use this database to store and refine this data?” but rather, “Should I?” </p><a></a><p class="calibre12"> In this section, we’re going to explore five main database genres. We’ll also take a look at the databases we’re going to focus on for each genre. </p><a></a><p class="calibre12"> It’s important to remember that most of the data problems you’ll face could be solved by most or all of the databases in this book, not to mention other databases. The question is less about whether a given database style could be shoehorned to model your data and more about whether it’s the best fit for your problem space, your usage patterns, and your available resources. You’ll learn the art of divining whether a database is intrinsically useful to you. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Relational</span></span></span></p><a></a><p class="calibre29"> The relational model is generally what comes to mind for most people with database experience. Relational database management systems (RDBMSs) are set-theory-based systems implemented as two-dimensional tables with rows and columns. The canonical means of interacting with an RDBMS is by writing queries in Structured Query Language (SQL). Data values are typed and may be numeric, strings, dates, uninterpreted blobs, or other types. The types are enforced by the system. Importantly, tables can join and morph into new, more complex tables, because of their mathematical basis in relational (set) theory. </p><a></a><p class="calibre12"> There are lots of open source relational databases to choose from, including MySQL, H2, HSQLDB, SQLite, and many others. The one we cover is in Chapter 2, <a href="#filepos58943"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">PostgreSQL</span></span><span class="calibre13"><span class="underline">​</span></span></a>. </p><p class="calibre12"><span class="bold"><span class="calibre28">PostgreSQL</span></span></p><a></a><p class="calibre37"> Battle-hardened PostgreSQL is by far the oldest and most robust database we cover. With its adherence to the SQL standard, it will feel familiar to anyone who has worked with relational databases before, and it provides a solid point of comparison to the other databases we’ll work with. We’ll also explore some of SQL’s unsung features and Postgres’s specific advantages. There’s something for everyone here, from SQL novice to expert. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Key-Value</span></span></span></p><a></a><p class="calibre29"> The key-value (KV) store is the simplest model we cover. As the name implies, a KV store pairs keys to values in much the same way that a map (or hashtable) would in any popular programming language. Some KV implementations permit complex value types such as hashes or lists, but this is not required. Some KV implementations provide a means of iterating through the keys, but this again is an added bonus. A filesystem could be considered a key-value store, if you think of the file path as the key and the file contents as the value. Because the KV moniker demands so little, databases of this type can be incredibly performant in a number of scenarios but generally won’t be helpful when you have complex query and aggregation needs. </p><a></a><p class="calibre12"> As with relational databases, many open source options are available. Some of the more popular offerings include memcached (and its cousins memcachedb and membase), Voldemort, and the two we cover in this book: Redis and Riak. </p><p class="calibre12"><span class="bold"><span class="calibre28">Riak</span></span></p><a></a><p class="calibre37"> More than a key-value store, <span class="italic">Riak</span>—covered in Chapter 3, <a href="#filepos359261"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Riak</span></span><span class="calibre13"><span class="underline">​</span></span></a>—embraces web constructs like HTTP and REST from the ground up. It’s a faithful implementation of Amazon’s Dynamo, with advanced features such as vector clocks for conflict resolution. Values in Riak can be anything, from plain text to XML to image data, and relationships between keys are handled by named structures called <span class="italic">links</span>. One of the lesser known databases in this book, Riak, is rising in popularity, and it’s the first one we’ll talk about that supports advanced querying via mapreduce. </p><p class="calibre12"><span class="bold"><span class="calibre28">Redis</span></span></p><a></a><p class="calibre37"> Redis provides for complex datatypes like sorted sets and hashes, as well as basic message patterns like publish-subscribe and blocking queues. It also has one of the most robust query mechanisms for a KV store. And by caching writes in memory before committing to disk, Redis gains amazing performance in exchange for increased risk of data loss in the case of a hardware failure. This characteristic makes it a good fit for caching noncritical data and for acting as a message broker. We leave it until the end—see Chapter 8, <a href="#filepos1669058"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Redis</span></span><span class="calibre13"><span class="underline">​</span></span></a>—so we can build a multidatabase application with Redis and others working together in harmony. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Columnar</span></span></span></p><a></a><p class="calibre29"> Columnar, or column-oriented, databases are so named because the important aspect of their design is that data from a given column (in the two-dimensional table sense) is stored together. By contrast, a row-oriented database (like an RDBMS) keeps information about a row together. The difference may seem inconsequential, but the impact of this design decision runs deep. In column-oriented databases, adding columns is quite inexpensive and is done on a row-by-row basis. Each row can have a different set of columns, or none at all, allowing tables to remain <span class="italic">sparse</span> without incurring a storage cost for null values. With respect to structure, columnar is about midway between relational and key-value. </p><a></a><p class="calibre12"> In the columnar database market, there’s somewhat less competition than in relational databases or key-value stores. The three most popular are HBase (which we cover in Chapter 4, <a href="#filepos618173"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">HBase</span></span><span class="calibre13"><span class="underline">​</span></span></a>), Cassandra, and Hypertable. </p><p class="calibre12"><span class="bold"><span class="calibre28">HBase</span></span></p><a></a><p class="calibre37"> This column-oriented database shares the most similarities with the relational model of all the nonrelational databases we cover. Using Google’s BigTable paper as a blueprint, HBase is built on Hadoop (a mapreduce engine) and designed for scaling horizontally on clusters of commodity hardware. HBase makes strong consistency guarantees and features tables with rows and columns—which should make SQL fans feel right at home. Out-of-the-box support for versioning and compression sets this database apart in the “Big Data” space. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Document</span></span></span></p><a></a><p class="calibre29"> Document-oriented databases store, well, documents. In short, a document is like a hash, with a unique ID field and values that may be any of a variety of types, including more hashes. Documents can contain nested structures, and so they exhibit a high degree of flexibility, allowing for variable domains. The system imposes few restrictions on incoming data, as long as it meets the basic requirement of being expressible as a document. Different document databases take different approaches with respect to indexing, ad hoc querying, replication, consistency, and other design decisions. Choosing wisely between them requires understanding these differences and how they impact your particular use cases. </p><a></a><p class="calibre12"> The two major open source players in the document database market are MongoDB, which we cover in Chapter 5, <a href="#filepos860653"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">MongoDB</span></span><span class="calibre13"><span class="underline">​</span></span></a>, and CouchDB, covered in Chapter 6, <a href="#filepos1144187"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">CouchDB</span></span><span class="calibre13"><span class="underline">​</span></span></a>. </p><p class="calibre12"><span class="bold"><span class="calibre28">MongoDB</span></span></p><a></a><p class="calibre37"> MongoDB is designed to be <span class="italic">huge</span> (the name <span class="calibre9"><span class="italic"><span class="calibre38">mongo</span></span></span> is extracted from the word hu<span class="italic">mongo</span>us). Mongo server configurations attempt to remain consistent—if you write something, subsequent reads will receive the same value (until the next update). This feature makes it attractive to those coming from an RDBMS background. It also offers atomic read-write operations such as incrementing a value and deep querying of nested document structures. Using JavaScript for its query language, MongoDB supports both simple queries and complex mapreduce jobs. </p><p class="calibre12"><span class="bold"><span class="calibre28">CouchDB</span></span></p><a></a><p class="calibre37"> CouchDB targets a wide variety of deployment scenarios, from the datacenter to the desktop, on down to the smartphone. Written in Erlang, CouchDB has a distinct ruggedness largely lacking in other databases. With nearly incorruptible data files, CouchDB remains highly available even in the face of intermittent connectivity loss or hardware failure. Like Mongo, CouchDB’s native query language is JavaScript. Views consist of mapreduce functions, which are stored as documents and replicated between nodes like any other data. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Graph</span></span></span></p><a></a><p class="calibre29"> One of the less commonly used database styles, graph databases excel at dealing with highly interconnected data. A graph database consists of nodes and relationships between nodes. Both nodes and relationships can have properties—key-value pairs—that store data. The real strength of graph databases is traversing through the nodes by following relationships. </p><a></a><p class="calibre12"> In Chapter 7, <a href="#filepos1431213"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Neo4J</span></span><span class="calibre13"><span class="underline">​</span></span></a>, we discuss the most popular graph database today, Neo4J. </p><p class="calibre12"><span class="bold"><span class="calibre28">Neo4J</span></span></p><a></a><p class="calibre37"> One operation where other databases often fall flat is crawling through self-referential or otherwise intricately linked data. This is exactly where Neo4J shines. The benefit of using a graph database is the ability to quickly traverse nodes and relationships to find relevant data. Often found in social networking applications, graph databases are gaining traction for their flexibility, with Neo4j as a pinnacle implementation. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Polyglot</span></span></span></p><a></a><p class="calibre29"> In the wild, databases are often used alongside other databases. It’s still common to find a lone relational database, but over time it is becoming popular to use several databases together, leveraging their strengths to create an ecosystem that is more powerful, capable, and robust than the sum of its parts. This practice is known as <span class="italic">polyglot persistence</span> and is a topic we consider further in Chapter 9, <a href="#filepos1949350"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Wrapping Up</span></span><span class="calibre13"><span class="underline">​</span></span></a>. </p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos57340" class="calibre1"><p class="calibre24" id="filepos57345"><span class="calibre25"><span class="bold"><span class="calibre26">1.3 Onward and Upward</span></span></span></p><a></a><p class="calibre27"> We’re in the midst of a Cambrian explosion of data storage options; it’s hard to predict exactly what will evolve next. We can be fairly certain, though, that the pure domination of any particular strategy (relational or otherwise) is unlikely. Instead, we’ll see increasingly specialized databases, each suited to a particular (but certainly overlapping) set of ideal problem spaces. And just as there are jobs today that call for expertise specifically in administrating relational databases (DBAs), we are going to see the rise of their nonrelational counterparts. </p><a></a><p class="calibre12"> Databases, like programming languages and libraries, are another set of tools that every developer should know. Every good carpenter must understand what’s in their toolbelt. And like any good builder, you can never hope to be a master without a familiarity of the many options at your disposal. </p><a></a><p class="calibre12"> Consider this a crash course in the workshop. In this book, you’ll swing some hammers, spin some power drills, play with some nail guns, and in the end be able to build so much more than a birdhouse. So, without further ado, let’s wield our first database: PostgreSQL. </p><p class="calibre17"><span class="calibre9"><span class="calibre18"><span class="calibre19">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos58938" class="calibre1"><p class="calibre21" id="filepos58943"><span class="calibre3"><span class="bold"><span class="calibre31"> Chapter 2</span></span></span></p><br class="calibre1"/><p class="calibre32"><span class="calibre3"><span class="bold"><span class="calibre4">PostgreSQL</span></span></span></p><a></a><p class="calibre12"> PostgreSQL is the hammer of the database world. It’s commonly understood, is often readily available, is sturdy, and solves a surprising number of problems if you swing hard enough. No one can hope to be an expert builder without understanding this most common of tools. </p><a></a><p class="calibre12"> PostgreSQL is a relational database management system, which means it’s a set-theory-based system, implemented as two-dimensional tables with data rows and strictly enforced column types. Despite the growing interest in newer database trends, the relational style remains the most popular and probably will for quite some time. </p><a></a><p class="calibre12"> The prevalence of relational databases comes not only from their vast toolkits (triggers, stored procedures, advanced indexes), their data safety (via <span class="bold"><span class="calibre39">ACID</span></span> compliance), or their mind share (many programmers speak and think relationally) but also from their query pliancy. Unlike some other datastores, you needn’t know how you plan to use the data. If a relational schema is normalized, queries are flexible. PostgreSQL is the finest open source example of the relational database management system (<span class="bold"><span class="calibre39">RDBMS</span></span>) tradition. </p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos60523" class="calibre1"><p class="calibre24" id="filepos60528"><span class="calibre25"><span class="bold"><span class="calibre26">2.1 That’s Post-greS-Q-L</span></span></span></p><blockquote class="calibre40"><span class="calibre41"><span class="bold">So, What’s with the Name?</span></span></blockquote><a></a><blockquote class="calibre42"><span class="calibre41"> PostgreSQL has existed in the current project incarnation since 1995, but its roots are considerably older. The original project was written at Berkeley in the early 1970s and called the Interactive Graphics and Retrieval System, or “Ingres” for short. In the 1980s, an improved version was launched post-Ingres—shortened to Postgres. The project ended at Berkeley proper in 1993 but was picked up again by the open source community as Postgres95. It was later renamed to PostgreSQL in 1996 to denote its rather new SQL support and has remained so ever since. </span></blockquote><a></a><p class="calibre43"> PostgreSQL is by far the oldest and most battle-tested database in this book. It has plug-ins for natural-language parsing, multidimensional indexing, geographic queries, custom datatypes, and much more. It has sophisticated transaction handling, has built-in stored procedures for a dozen languages, and runs on a variety of platforms. PostgreSQL has built-in Unicode support, sequences, table inheritance, and subselects, and it is one of the most ANSI SQL--compliant relational databases on the market. It’s fast and reliable, can handle terabytes of data, and has been proven to run in high-profile production projects such as Skype, France’s Caisse Nationale d’Allocations Familiales (CNAF), and the United States’ Federal Aviation Administration (FAA). </p><p class="calibre12" id="filepos62235"> You can install PostgreSQL in many ways, depending on your operating system.<a href="#filepos356660"><span class="calibre13"><span class="underline">[3]</span></span></a> Beyond the basic install, we’ll need to extend Postgres with the following contributed packages: <span class="calibre9"><span class="calibre30">tablefunc</span></span>, <span class="calibre9"><span class="calibre30">dict_xsyn</span></span>, <span class="calibre9"><span class="calibre30">fuzzystrmatch</span></span>, <span class="calibre9"><span class="calibre30">pg_trgm</span></span>, and <span class="calibre9"><span class="calibre30">cube</span></span>. You can refer to the website for installation instructions.<a href="#filepos356660"><span class="calibre13"><span class="underline">[4]</span></span></a>
</p><a></a><p class="calibre12"> Once you have Postgres installed, create a schema called <span class="calibre9"><span class="calibre30">book</span></span> using the following command: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">createdb book</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We’ll be using the <span class="calibre9"><span class="calibre30">book</span></span> schema for the remainder of this chapter. Next, run the following command to ensure your contrib packages have been installed correctly: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">psql book -c "SELECT '1'::cube;"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Seek out the online docs for more information if you receive an error message. </p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos64303" class="calibre1"><p class="calibre24" id="filepos64308"><span class="calibre25"><span class="bold"><span class="calibre26">2.2 Day 1: Relations, CRUD, and Joins</span></span></span></p><a></a><p class="calibre27"> While we won’t assume you’re a relational database expert, we do assume you have confronted a database or two in the past. Odds are good that the database was relational. We’ll start with creating our own schemas and populating them. Then we’ll take a look at querying for values and finally what makes relational databases so special: the table join. </p><a></a><p class="calibre12"> Like most databases we’ll read about, Postgres provides a back-end server that does all of the work and a command-line shell to connect to the running server. The server communicates through port 5432 by default, which you can connect to with the <span class="calibre9"><span class="calibre30">psql</span></span> shell. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">psql book</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> PostgreSQL prompts with the name of the database followed by a hash mark if you run as an administrator and by dollar sign as a regular user. The shell also comes equipped with the best built-in documentation you will find in any console. Typing <span class="calibre9"><span class="calibre30">\h</span></span> lists information about SQL commands, and <span class="calibre9"><span class="calibre30">\?</span></span> helps with <span class="calibre9"><span class="calibre30">psql</span></span>-specific commands, namely, those that begin with a backslash. You can find usage details about each SQL command in the following way: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​book=</span><span class="calibre9"><span class="italic"><span class="calibre46"># \h CREATE INDEX</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Command:     </span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">INDEX</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Description: define a new </span><span class="calibre9"><span class="bold"><span class="calibre44">index</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Syntax:​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> [ </span><span class="calibre9"><span class="bold"><span class="calibre44">UNIQUE</span></span></span><span class="calibre9"> ] </span><span class="calibre9"><span class="bold"><span class="calibre44">INDEX</span></span></span><span class="calibre9"> [ CONCURRENTLY ] [ name ] </span><span class="calibre9"><span class="bold"><span class="calibre44">ON</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">table</span></span></span><span class="calibre9"> [ </span><span class="calibre9"><span class="bold"><span class="calibre44">USING</span></span></span><span class="calibre9"> method ]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    ( { column | ( expression ) } [ opclass ] [ ASC | DESC ] [ NULLS { FIRST | ...​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    [ WITH ( storage_parameter = value [, ... ] ) ]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    [ TABLESPACE tablespace ]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    [ </span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> predicate ]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Before we dig too deeply into Postgres, it would be good to familiarize yourself with this useful tool. It’s worth looking over (or brushing up on) a few common commands, like <span class="calibre9"><span class="calibre30">SELECT</span></span> or <span class="calibre9"><span class="calibre30">CREATE TABLE</span></span>. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Starting with SQL</span></span></span></p><a></a><p class="calibre29"> PostgreSQL follows the <span class="bold"><span class="calibre39">SQL</span></span> convention of calling relations <span class="calibre9"><span class="calibre30">TABLE</span></span>s, attributes <span class="calibre9"><span class="calibre30">COLUMN</span></span>s, and tuples <span class="calibre9"><span class="calibre30">ROW</span></span>s. For consistency we will use this terminology, though you may encounter the mathematical terms <span class="italic">relations</span>, <span class="italic">attributes</span>, and <span class="italic">tuples</span>. For more on these concepts, see <a href="#filepos70903"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Mathematical Relations</span></span><span class="calibre13"><span class="underline">​</span></span></a>. </p><a id="filepos70903"></a><blockquote class="calibre40"><span class="calibre41"><span class="bold">Mathematical Relations</span></span></blockquote><a></a><blockquote class="calibre42"><span class="calibre41"> Relational databases are so named because they contain </span><span class="calibre41"><span class="italic">relations</span></span><span class="calibre41"> (i.e., tables), which are sets of </span><span class="calibre41"><span class="italic">tuples</span></span><span class="calibre41"> (i.e., rows), which map </span><span class="calibre41"><span class="italic">attributes</span></span><span class="calibre41"> to atomic values (for example, </span><span class="calibre9"><span class="calibre30">{name: ’Genghis Khan’, p.died_at_age: 65}</span></span><span class="calibre41">). The available attributes are defined by a </span><span class="calibre41"><span class="italic">header</span></span><span class="calibre41"> tuple of attributes mapped to some </span><span class="calibre41"><span class="italic">domain</span></span><span class="calibre41"> or constraining type (i.e., columns; for example, </span><span class="calibre9"><span class="calibre30">{name: string, age: int}</span></span><span class="calibre41">). That’s the gist of the relational structure. </span></blockquote><a></a><blockquote class="calibre47"><span class="calibre41"> Implementations are much more practically minded than the names imply, despite sounding so mathematical. So, why bring them up? We’re trying to make the point that relational databases are </span><span class="calibre41"><span class="italic">relational</span></span><span class="calibre41"> based on mathematics. They aren’t relational because tables “relate” to each other via foreign keys. Whether any such constraints exist is beside the point. </span></blockquote><a></a><blockquote class="calibre47"><span class="calibre41"> Though much of the math is hidden from you, the power of the model is certainly in the math. This magic allows users to express powerful queries and then lets the system optimize based on predefined patterns. RDBMSs are built atop a set-theory branch called </span><span class="calibre41"><span class="italic">relational algebra</span></span><span class="calibre41">—a combination of selections (</span><span class="calibre9"><span class="calibre30">WHERE ...</span></span><span class="calibre41">), projections (</span><span class="calibre9"><span class="calibre30">SELECT ...</span></span><span class="calibre41">), Cartesian products (</span><span class="calibre9"><span class="calibre30">JOIN ...</span></span><span class="calibre41">), and more, as shown below: </span></blockquote><blockquote class="calibre47"><img src="images/00040.jpg" class="calibre48"/><span class="calibre41">
</span></blockquote><a></a><blockquote class="calibre42"><span class="calibre41"> Imagining a relation as a physical table (an array of arrays, repeated in database introduction classes </span><span class="calibre41"><span class="italic">ad infinitum</span></span><span class="calibre41">) can cause pain in practice, such as writing code that iterates over all rows. Relational queries are much more declarative than that, springing from a branch of mathematics known as </span><span class="calibre41"><span class="italic">tuple relational calculus</span></span><span class="calibre41">, which can be converted to relational algebra. PostgreSQL and other RDBMSs optimize queries by performing this conversion and simplifying the algebra. You can see that the SQL in the diagram below is the same as the previous diagram. </span></blockquote><blockquote class="calibre47"><img src="images/00012.jpg" class="calibre49"/><span class="calibre41">
</span></blockquote><p class="calibre43"><span class="bold"><span class="calibre28">Working with Tables</span></span></p><a></a><p class="calibre37"> PostgreSQL, being of the relational style, is a design-first datastore. First you design the schema, and then you enter data that conforms to the definition of that schema. </p><a></a><p class="calibre12"> Creating a table consists of giving it a name and a list of columns with types and (optional) constraint information. Each table should also nominate a unique identifier column to pinpoint specific rows. That identifier is called a <span class="calibre9"><span class="calibre30">PRIMARY KEY</span></span>. The <span class="bold"><span class="calibre39">SQL</span></span> to create a <span class="calibre9"><span class="calibre30">countries</span></span> table looks like this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">TABLE</span></span></span><span class="calibre9"> countries (​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  country_code </span><span class="calibre9"><span class="bold"><span class="calibre44">char</span></span></span><span class="calibre9">(2) </span><span class="calibre9"><span class="bold"><span class="calibre44">PRIMARY</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">KEY</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  country_name </span><span class="calibre9"><span class="bold"><span class="calibre44">text</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">UNIQUE</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​);​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This new table will store a set of rows, where each is identified by a two-character code and the name is unique. These columns both have <span class="italic">constraints</span>. The <span class="calibre9"><span class="calibre30">PRIMARY KEY</span></span> constrains the <span class="calibre9"><span class="calibre30">country_code</span></span> column to disallow duplicate country codes. Only one <span class="calibre9"><span class="calibre30">us</span></span> and one <span class="calibre9"><span class="calibre30">gb</span></span> may exist. We explicitly gave <span class="calibre9"><span class="calibre30">country_name</span></span> a similar unique constraint, although it is not a primary key. We can populate the <span class="calibre9"><span class="calibre30">countries</span></span> table by inserting a few rows. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">INSERT</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">INTO</span></span></span><span class="calibre9"> countries (country_code, country_name)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">VALUES</span></span></span><span class="calibre9"> (</span><span class="calibre9"><span class="italic"><span class="calibre38">'us'</span></span></span><span class="calibre9">,</span><span class="calibre9"><span class="italic"><span class="calibre38">'United States'</span></span></span><span class="calibre9">), (</span><span class="calibre9"><span class="italic"><span class="calibre38">'mx'</span></span></span><span class="calibre9">,</span><span class="calibre9"><span class="italic"><span class="calibre38">'Mexico'</span></span></span><span class="calibre9">), (</span><span class="calibre9"><span class="italic"><span class="calibre38">'au'</span></span></span><span class="calibre9">,</span><span class="calibre9"><span class="italic"><span class="calibre38">'Australia'</span></span></span><span class="calibre9">),​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​       (</span><span class="calibre9"><span class="italic"><span class="calibre38">'gb'</span></span></span><span class="calibre9">,</span><span class="calibre9"><span class="italic"><span class="calibre38">'United Kingdom'</span></span></span><span class="calibre9">), (</span><span class="calibre9"><span class="italic"><span class="calibre38">'de'</span></span></span><span class="calibre9">,</span><span class="calibre9"><span class="italic"><span class="calibre38">'Germany'</span></span></span><span class="calibre9">), (</span><span class="calibre9"><span class="italic"><span class="calibre38">'ll'</span></span></span><span class="calibre9">,</span><span class="calibre9"><span class="italic"><span class="calibre38">'Loompaland'</span></span></span><span class="calibre9">);​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Let’s test our unique constraint. Attempting to add a duplicate <span class="calibre9"><span class="calibre30">country_name</span></span> will cause our unique constraint to fail, thus disallowing insertion. Constraints are how relational databases like PostgreSQL ensure kosher data. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">INSERT</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">INTO</span></span></span><span class="calibre9"> countries​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">VALUES</span></span></span><span class="calibre9"> (</span><span class="calibre9"><span class="italic"><span class="calibre38">'uk'</span></span></span><span class="calibre9">,</span><span class="calibre9"><span class="italic"><span class="calibre38">'United Kingdom'</span></span></span><span class="calibre9">);​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ERROR:  duplicate key value violates unique constraint "countries_country_name_key"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​DETAIL:  Key (country_name)=(United Kingdom) already exists.​</span><span class="calibre9">​</span></p></td></tr></table><blockquote class="calibre40"><span class="calibre41"><span class="bold">On CRUD</span></span></blockquote><a></a><blockquote class="calibre42"><span class="calibre41"><span class="bold"><span class="calibre39">CRUD</span></span></span><span class="calibre41"> is a useful mnemonic for remembering the basic data management operations: </span><span class="calibre41"><span class="italic">Create</span></span><span class="calibre41">, </span><span class="calibre41"><span class="italic">Read</span></span><span class="calibre41">, </span><span class="calibre41"><span class="italic">Update</span></span><span class="calibre41">, and </span><span class="calibre41"><span class="italic">Delete</span></span><span class="calibre41">. These generally correspond to inserting new records (</span><span class="calibre41"><span class="italic">creating</span></span><span class="calibre41">), modifying existing records (</span><span class="calibre41"><span class="italic">updating</span></span><span class="calibre41">), and removing records you no longer need (</span><span class="calibre41"><span class="italic">deleting</span></span><span class="calibre41">). All of the other operations you use a database for (any crazy query you can dream up) are </span><span class="calibre41"><span class="italic">read operations</span></span><span class="calibre41">. If you can </span><span class="calibre41"><span class="bold"><span class="calibre39">CRUD</span></span></span><span class="calibre41">, you can do anything. </span></blockquote><a></a><p class="calibre43"> We can validate that the proper rows were inserted by reading them using the <span class="calibre9"><span class="calibre30">SELECT...FROM</span></span> table command. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> *​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> countries;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ country_code | country_name​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre46">--------------+---------------</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ us           | United States​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ mx           | Mexico​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ au           | Australia​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ gb           | United Kingdom​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ de           | Germany​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ ll           | Loompaland​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​(6 rows)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> According to any respectable map, Loompaland isn’t a real place—let’s remove it from the table. We specify which row to remove by the <span class="calibre9"><span class="calibre30">WHERE</span></span> clause. The row whose <span class="calibre9"><span class="calibre30">country_code</span></span> equals <span class="calibre9"><span class="calibre30">ll</span></span> will be removed. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">DELETE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> countries​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> country_code = </span><span class="calibre9"><span class="italic"><span class="calibre38">'ll'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> With only real countries left in the <span class="calibre9"><span class="calibre30">countries</span></span> table, let’s add a <span class="calibre9"><span class="calibre30">cities</span></span> table. To ensure any inserted <span class="calibre9"><span class="calibre30">country_code</span></span> also exists in our <span class="calibre9"><span class="calibre30">countries</span></span> table, we add the <span class="calibre9"><span class="calibre30">REFERENCES</span></span> keyword. Since the <span class="calibre9"><span class="calibre30">country_code</span></span> column references another table’s key, it’s known as the <span class="italic">foreign key</span> constraint. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">TABLE</span></span></span><span class="calibre9"> cities (​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  name </span><span class="calibre9"><span class="bold"><span class="calibre44">text</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">NOT</span></span></span><span class="calibre9"> NULL,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  postal_code </span><span class="calibre9"><span class="bold"><span class="calibre44">varchar</span></span></span><span class="calibre9">(9) CHECK (postal_code &lt;&gt; </span><span class="calibre9"><span class="italic"><span class="calibre38">''</span></span></span><span class="calibre9">),​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  country_code </span><span class="calibre9"><span class="bold"><span class="calibre44">char</span></span></span><span class="calibre9">(2) REFERENCES countries,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">PRIMARY</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">KEY</span></span></span><span class="calibre9"> (country_code, postal_code)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​);​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre12"> This time, we constrained the name in cities by disallowing <span class="calibre9"><span class="calibre30">NULL</span></span> values. We constrained <span class="calibre9"><span class="calibre30">postal_code</span></span> by checking that no values are empty strings (<span class="calibre9"><span class="calibre30">&lt;&gt;</span></span> means <span class="italic">not equal</span>). Furthermore, since a <span class="calibre9"><span class="calibre30">PRIMARY KEY</span></span> uniquely identifies a row, we created a compound key: <span class="calibre9"><span class="calibre30">country_code</span></span> + <span class="calibre9"><span class="calibre30">postal_code</span></span>. Together, they uniquely define a row. </p><a></a><p class="calibre12"> Postgres also has a rich set of datatypes. You’ve just seen three different string representations: <span class="calibre9"><span class="calibre30">text</span></span> (a string of any length), <span class="calibre9"><span class="calibre30">varchar(9)</span></span> (a string of variable length up to nine characters), and <span class="calibre9"><span class="calibre30">char(2)</span></span> (a string of exactly two characters). With our schema in place, let’s insert <span class="italic">Toronto, CA</span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">INSERT</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">INTO</span></span></span><span class="calibre9"> cities​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">VALUES</span></span></span><span class="calibre9"> (</span><span class="calibre9"><span class="italic"><span class="calibre38">'Toronto'</span></span></span><span class="calibre9">,</span><span class="calibre9"><span class="italic"><span class="calibre38">'M4C1B5'</span></span></span><span class="calibre9">,</span><span class="calibre9"><span class="italic"><span class="calibre38">'ca'</span></span></span><span class="calibre9">);​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ERROR:  insert or update on table "cities" violates foreign key constraint​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "cities_country_code_fkey"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​DETAIL:  Key (country_code)=(ca) is not present in table "countries".​</span><span class="calibre9">​</span></p></td></tr></table><a id="filepos93797"></a><blockquote class="calibre10"><img src="images/00058.jpg" class="calibre50"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 1. The </span><span class="calibre9"><span class="bold"><span class="calibre30">REFERENCES</span></span></span><span class="bold"> keyword constrains fields to another table’s primary key.</span></blockquote><a></a><p class="calibre12"> This failure is good! Since <span class="calibre9"><span class="calibre30">country_code</span></span> <span class="calibre9"><span class="calibre30">REFERENCES</span></span> <span class="calibre9"><span class="calibre30">countries</span></span>, the <span class="calibre9"><span class="calibre30">country_code</span></span> must exist in the <span class="calibre9"><span class="calibre30">countries</span></span> table. This is called <span class="italic">maintaining referential integrity</span>, as in Figure 1, <a href="#filepos93797"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">The REFERENCES keyword constrains fields to another table's primary key</span></span><span class="calibre13"><span class="underline">​</span></span></a>, and ensures our data is always correct. It’s worth noting that <span class="calibre9"><span class="calibre30">NULL</span></span> is valid for <span class="calibre9"><span class="calibre30">cities</span></span>.<span class="calibre9"><span class="calibre30">country_code</span></span>, since <span class="calibre9"><span class="calibre30">NULL</span></span> represents the lack of a value. If you want to disallow a <span class="calibre9"><span class="calibre30">NULL</span></span> <span class="calibre9"><span class="calibre30">country_code</span></span> reference, you would define the table <span class="calibre9"><span class="calibre30">cities</span></span> column like this: <span class="calibre9"><span class="calibre30">country_code char(2) REFERENCES countries NOT NULL</span></span>. </p><a></a><p class="calibre12"> Now let’s try another insert, this time with a U.S. city. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">INSERT</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">INTO</span></span></span><span class="calibre9"> cities​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">VALUES</span></span></span><span class="calibre9"> (</span><span class="calibre9"><span class="italic"><span class="calibre38">'Portland'</span></span></span><span class="calibre9">,</span><span class="calibre9"><span class="italic"><span class="calibre38">'87200'</span></span></span><span class="calibre9">,</span><span class="calibre9"><span class="italic"><span class="calibre38">'us'</span></span></span><span class="calibre9">);​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​INSERT 0 1​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This is a successful insert, to be sure. But we mistakenly entered the wrong <span class="calibre9"><span class="calibre30">postal_code</span></span>. The correct postal code for Portland is <span class="calibre9"><span class="italic"><span class="calibre38">97205</span></span></span>. Rather than delete and reinsert the value, we can update it inline. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">UPDATE</span></span></span><span class="calibre9"> cities​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SET</span></span></span><span class="calibre9"> postal_code = </span><span class="calibre9"><span class="italic"><span class="calibre38">'97205'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> name = </span><span class="calibre9"><span class="italic"><span class="calibre38">'Portland'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We have now Created, Read, Updated, and Deleted table rows. </p><p class="calibre12"><span class="bold"><span class="calibre28">Join Reads</span></span></p><a></a><p class="calibre37"> All of the other databases we’ll read about in this book perform CRUD operations as well. What sets relational databases like PostgreSQL apart is their ability to join tables together when reading them. Joining, in essence, is an operation taking two separate tables and combining them in some way to return a single table. It’s somewhat like shuffling up Scrabble pieces from existing words to make new words. </p><a></a><p class="calibre12"> The basic form of a join is the <span class="italic">inner join</span>. In the simplest form, you specify two columns (one from each table) to match by, using the <span class="calibre9"><span class="calibre30">ON</span></span> keyword. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> cities.*, country_name​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> cities </span><span class="calibre9"><span class="bold"><span class="calibre44">INNER</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">JOIN</span></span></span><span class="calibre9"> countries​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">ON</span></span></span><span class="calibre9"> cities.country_code = countries.country_code;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ country_code |   name   | postal_code | country_name​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​--------------+----------+-------------+---------------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ us           | Portland | 97205       | United States​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The join returns a single table, sharing all columns’ values of the <span class="calibre9"><span class="calibre30">cities</span></span> table plus the matching <span class="calibre9"><span class="calibre30">country_name</span></span> value from the <span class="calibre9"><span class="calibre30">countries</span></span> table. </p><a></a><p class="calibre12"> We can also join a table like <span class="calibre9"><span class="calibre30">cities</span></span> that has a compound primary key. To test a compound join, let’s create a new table that stores a list of venues. </p><a></a><p class="calibre12"> A venue exists in both a <span class="italic">postal code</span> and a specific <span class="italic">country</span>. The <span class="italic">foreign key</span> must be two columns that reference both <span class="calibre9"><span class="calibre30">cities</span></span> <span class="italic">primary key</span> columns. (<span class="calibre9"><span class="calibre30">MATCH FULL</span></span> is a constraint that ensures either both values exist or both are <span class="calibre9"><span class="calibre30">NULL</span></span>.) </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">TABLE</span></span></span><span class="calibre9"> venues (​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  venue_id SERIAL </span><span class="calibre9"><span class="bold"><span class="calibre44">PRIMARY</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">KEY</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  name </span><span class="calibre9"><span class="bold"><span class="calibre44">varchar</span></span></span><span class="calibre9">(255),​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  street_address </span><span class="calibre9"><span class="bold"><span class="calibre44">text</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  type </span><span class="calibre9"><span class="bold"><span class="calibre44">char</span></span></span><span class="calibre9">(7) CHECK ( type in (</span><span class="calibre9"><span class="italic"><span class="calibre38">'public'</span></span></span><span class="calibre9">,</span><span class="calibre9"><span class="italic"><span class="calibre38">'private'</span></span></span><span class="calibre9">) ) </span><span class="calibre9"><span class="bold"><span class="calibre44">DEFAULT</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="italic"><span class="calibre38">'public'</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  postal_code </span><span class="calibre9"><span class="bold"><span class="calibre44">varchar</span></span></span><span class="calibre9">(9),​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  country_code </span><span class="calibre9"><span class="bold"><span class="calibre44">char</span></span></span><span class="calibre9">(2),​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  FOREIGN </span><span class="calibre9"><span class="bold"><span class="calibre44">KEY</span></span></span><span class="calibre9"> (country_code, postal_code)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    REFERENCES cities (country_code, postal_code) MATCH FULL​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​);​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This <span class="calibre9"><span class="calibre30">venue_id</span></span> column is a common primary key setup: automatically incremented integers (1, 2, 3, 4, and so on…). We make this identifier using the <span class="calibre9"><span class="calibre30">SERIAL</span></span> keyword (MySQL has a similar construct called <span class="calibre9"><span class="calibre30">AUTO_INCREMENT</span></span>). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">INSERT</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">INTO</span></span></span><span class="calibre9"> venues (name, postal_code, country_code)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">VALUES</span></span></span><span class="calibre9"> (</span><span class="calibre9"><span class="italic"><span class="calibre38">'Crystal Ballroom'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'97205'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'us'</span></span></span><span class="calibre9">);​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Although we did not set a <span class="calibre9"><span class="calibre30">venue_id</span></span> value, creating the row populated it. </p><a></a><p class="calibre12"> Back to our compound join. Joining the <span class="calibre9"><span class="calibre30">venues</span></span> table with the <span class="calibre9"><span class="calibre30">cities</span></span> table requires <span class="italic">both</span> foreign key columns. To save on typing, we can alias the table names by following the real table name directly with an alias, with an optional <span class="calibre9"><span class="calibre30">AS</span></span> between (for example, <span class="calibre9"><span class="calibre30">venues v</span></span> or <span class="calibre9"><span class="calibre30">venues AS v</span></span>). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> v.venue_id, v.name, c.name​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> venues v </span><span class="calibre9"><span class="bold"><span class="calibre44">INNER</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">JOIN</span></span></span><span class="calibre9"> cities c​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">ON</span></span></span><span class="calibre9"> v.postal_code=c.postal_code </span><span class="calibre9"><span class="bold"><span class="calibre44">AND</span></span></span><span class="calibre9"> v.country_code=c.country_code;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ venue_id |       name       |   name​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​----------+------------------+----------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        1 | Crystal Ballroom | Portland​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You can optionally request that PostgreSQL return columns after insertion by ending the query with a <span class="calibre9"><span class="calibre30">RETURNING</span></span> statement. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">INSERT</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">INTO</span></span></span><span class="calibre9"> venues (name, postal_code, country_code)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">VALUES</span></span></span><span class="calibre9"> (</span><span class="calibre9"><span class="italic"><span class="calibre38">'Voodoo Donuts'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'97205'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'us'</span></span></span><span class="calibre9">) RETURNING venue_id;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ id​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​- - - -​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  2​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This provides the new <span class="calibre9"><span class="calibre30">venue_id</span></span> without issuing another query. </p><p class="calibre12"><span class="bold"><span class="calibre28">The Outer Limits</span></span></p><a></a><p class="calibre37"> In addition to inner joins, PostgreSQL can also perform <span class="italic">outer joins</span>. Outer joins are a way of merging two tables when the results of one table must always be returned, whether or not any matching column values exist on the other table. </p><a></a><p class="calibre12"> It’s easiest to give an example, but to do that, we’ll create a new table named <span class="calibre9"><span class="calibre30">events</span></span>. This one is up to you. Your <span class="calibre9"><span class="calibre30">events</span></span> table should have these columns: a <span class="calibre9"><span class="calibre30">SERIAL</span></span> integer <span class="calibre9"><span class="calibre30">event_id</span></span>, a <span class="calibre9"><span class="calibre30">title</span></span>, <span class="calibre9"><span class="calibre30">starts</span></span> and <span class="calibre9"><span class="calibre30">ends</span></span> (of type <span class="italic">timestamp</span>), and a <span class="calibre9"><span class="calibre30">venue_id</span></span> (foreign key that references <span class="calibre9"><span class="calibre30">venues</span></span>). A schema definition diagram covering all the tables we’ve made so far is shown in Figure 2, <a href="#filepos115048"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">The crow’s-feet entity relationship diagram (ERD)</span></span><span class="calibre13"><span class="underline">​</span></span></a>. </p><a id="filepos115048"></a><blockquote class="calibre10"><img src="images/00015.jpg" class="calibre53"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 2. The crow’s-feet entity relationship diagram (</span><span class="bold"><span class="calibre39">ERD</span></span><span class="bold">)</span></blockquote><a></a><p class="calibre12"> After creating the <span class="calibre9"><span class="calibre30">events</span></span> table, <span class="calibre9"><span class="calibre30">INSERT</span></span> the following values (timestamps are inserted as a string like <span class="calibre9"><span class="italic"><span class="calibre38">2012-02-15 17:30</span></span></span>), two holidays, and a club we <span class="italic">do not talk about</span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      title     |       starts        |        ends         | venue_id | event_id​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre46">----------------+---------------------+---------------------+----------+---------</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​LARP Club       | 2012-02-15 17:30:00 | 2012-02-15 19:30:00 |        2 |        1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​April Fools Day | 2012-04-01 00:00:00 | 2012-04-01 23:59:00 |          |        2​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Christmas Day   | 2012-12-25 00:00:00 | 2012-12-25 23:59:00 |          |        3​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Let’s first craft a query that returns an event title and venue name as an inner join (the word <span class="calibre9"><span class="calibre30">INNER</span></span> from <span class="calibre9"><span class="calibre30">INNER JOIN</span></span> is not required, so leave it off here). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> e.title, v.name​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> events e </span><span class="calibre9"><span class="bold"><span class="calibre44">JOIN</span></span></span><span class="calibre9"> venues v​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">ON</span></span></span><span class="calibre9"> e.venue_id = v.venue_id;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​       title  |       name​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​--------------+------------------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ LARP Club    | Voodoo Donuts​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"><span class="calibre9"><span class="calibre30">INNER JOIN</span></span> will return a row only <span class="italic">if the column values match</span>. Since we can’t have <span class="calibre9"><span class="calibre30">NULL</span></span>
<span class="calibre9"><span class="calibre30">venues</span></span>.<span class="calibre9"><span class="calibre30">venue_id</span></span>, the two <span class="calibre9"><span class="calibre30">NULL</span></span>
<span class="calibre9"><span class="calibre30">events</span></span>.<span class="calibre9"><span class="calibre30">venue_id</span></span>s refer to nothing. Retrieving all of the events, whether or not they have a venue, requires a <span class="calibre9"><span class="calibre30">LEFT OUTER JOIN</span></span> (shortened to <span class="calibre9"><span class="calibre30">LEFT JOIN</span></span>). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> e.title, v.name​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> events e </span><span class="calibre9"><span class="bold"><span class="calibre44">LEFT</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">JOIN</span></span></span><span class="calibre9"> venues v​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">ON</span></span></span><span class="calibre9"> e.venue_id = v.venue_id;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      title      |      name​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-----------------+----------------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ LARP Club       | Voodoo Donuts​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ April Fools Day |​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Christmas Day   |​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If you require the inverse, all venues and only matching events, use a <span class="calibre9"><span class="calibre30">RIGHT JOIN</span></span>. Finally, there’s the <span class="calibre9"><span class="calibre30">FULL JOIN</span></span>, which is the union of <span class="calibre9"><span class="calibre30">LEFT</span></span> and <span class="calibre9"><span class="calibre30">RIGHT</span></span>; you’re guaranteed all values from each table, joined wherever columns match. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Fast Lookups with Indexing</span></span></span></p><a></a><p class="calibre29"> The speed of PostgreSQL (and any other RDBMS) lies in its efficient management of blocks of data, reducing disk reads, query optimization, and other techniques. But those go only so far in fetching results fast. If we select the title of <span class="calibre9"><span class="italic"><span class="calibre38">Christmas Day</span></span></span> from the <span class="calibre9"><span class="calibre30">events</span></span> table, the algorithm must scan every row for a match to return. Without an <span class="italic">index</span>, each row must be read from disk to know whether a query should return it. See the following. </p><p class="calibre12"><img src="images/00055.jpg" class="calibre54"/></p><a></a><p class="calibre22"> An index is a special data structure built to avoid a full table scan when performing a query. When running <span class="calibre9"><span class="calibre30">CREATE TABLE</span></span> commands, you may have noticed a message like this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">TABLE</span></span></span><span class="calibre9"> / </span><span class="calibre9"><span class="bold"><span class="calibre44">PRIMARY</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">KEY</span></span></span><span class="calibre9"> will </span><span class="calibre9"><span class="bold"><span class="calibre44">create</span></span></span><span class="calibre9"> implicit </span><span class="calibre9"><span class="bold"><span class="calibre44">index</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="italic"><span class="calibre38">"events_pkey"</span></span></span><span class="calibre9"> \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​for </span><span class="calibre9"><span class="bold"><span class="calibre44">table</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="italic"><span class="calibre38">"events"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> PostgreSQL automatically creates an index on the primary key, where the key is the primary key value and where the value points to a row on disk, as shown in the graphic below. Using the <span class="calibre9"><span class="calibre30">UNIQUE</span></span> keyword is another way to force an index on a table column. </p><p class="calibre12"><img src="images/00017.jpg" class="calibre55"/></p><a></a><p class="calibre22"> You can explicitly add a hash index using the <span class="calibre9"><span class="calibre30">CREATE INDEX</span></span> command, where each value must be unique (like a hashtable or a map). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">INDEX</span></span></span><span class="calibre9"> events_title​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">ON</span></span></span><span class="calibre9"> events </span><span class="calibre9"><span class="bold"><span class="calibre44">USING</span></span></span><span class="calibre9"> hash (title);​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> For less-than/greater-than/equals-to matches, we want an index more flexible than a simple hash, like a B-tree (see Figure 3, <a href="#filepos128356"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">A B-tree index can match on ranged queries</span></span><span class="calibre13"><span class="underline">​</span></span></a>). Consider a query to find all events that are on or after April 1. </p><a id="filepos128356"></a><blockquote class="calibre10"><img src="images/00004.jpg" class="calibre56"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 3. A B-tree index can match on ranged queries.</span></blockquote><br class="calibre1"/><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> *​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> events​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> starts &gt;= </span><span class="calibre9"><span class="italic"><span class="calibre38">'2012-04-01'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> For this, a tree is the perfect data structure. To index the <span class="calibre9"><span class="calibre30">starts</span></span> column with a B-tree, use this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">INDEX</span></span></span><span class="calibre9"> events_starts​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">ON</span></span></span><span class="calibre9"> events </span><span class="calibre9"><span class="bold"><span class="calibre44">USING</span></span></span><span class="calibre9"> btree (starts);​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Now our query over a range of dates will avoid a full table scan. It makes a huge difference when scanning millions or billions of rows. </p><a></a><p class="calibre12"> We can inspect our work with this command to list all indexes in the schema:</p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​book=</span><span class="calibre9"><span class="italic"><span class="calibre46"># \di</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> It’s worth noting that when you set a <span class="calibre9"><span class="calibre30">FOREIGN KEY</span></span> constraint, PostgreSQL will automatically create an index on the targeted column(s). Even if you don’t like using database constraints (that’s right, we’re looking at you, Ruby on Rails developers), you will often find yourself creating indexes on columns you plan to join against in order to help speed up foreign key joins. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Day 1 Wrap-Up</span></span></span></p><a></a><p class="calibre29"> We sped through a lot today and covered many terms. Here’s a recap: </p><br class="calibre1"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Term  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Definition  </span></blockquote></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">Column  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">A domain of values of a certain type, sometimes called an   <span class="italic">attribute</span>
</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">Row  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">An object comprised as a set of column values, sometimes called a   <span class="italic">tuple</span>
</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">Table  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">A set of rows with the same columns, sometimes called a   <span class="italic">relation</span>
</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">Primary key  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">The unique value that pinpoints a specific row  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">CRUD  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Create, Read, Update, Delete  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">SQL  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Structured Query Language, the   <span class="italic">lingua franca</span> of a relational database</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">Join  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Combining two tables into one by some matching columns  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">Left join  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Combining two tables into one by some matching columns or   <span class="calibre9"><span class="calibre30">NULL</span></span> if nothing matches the left table</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">Index  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">A data structure to optimize selection of a specific set of columns  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">B-tree  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">A good standard index; values are stored as a balanced tree data structure; very flexible  </blockquote></td></tr></table><a></a><p class="calibre23"> Relational databases have been the <span class="italic">de facto</span> data management strategy for forty years—many of us began our careers in the midst of their evolution. So, we took a look at some of the core concepts of the relational model via basic <span class="bold"><span class="calibre39">SQL</span></span> queries. We will expound on these root concepts tomorrow. </p><p class="calibre12"><span class="bold"><span class="calibre28">Day 1 Homework</span></span></p><p class="calibre37"><span class="bold">Find</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Bookmark the online PostgreSQL FAQ and documents.</p></li><li value="2" class="calibre36"><p class="calibre22">Acquaint yourself with the command-line <span class="calibre9"><span class="calibre30">\?</span></span> and <span class="calibre9"><span class="calibre30">\h</span></span> output.</p></li><li value="3" class="calibre36"><p class="calibre22">In the addresses <span class="calibre9"><span class="calibre30">FOREIGN KEY</span></span>, find in the docs what <span class="calibre9"><span class="calibre30">MATCH FULL</span></span> means.</p></li></ol><p class="calibre12"><span class="bold">Do</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Select all the tables we created (and only those) from <span class="calibre9"><span class="calibre30">pg_class</span></span>.</p></li><li value="2" class="calibre36"><p class="calibre22">Write a query that finds the country name of the LARP Club event.</p></li><li value="3" class="calibre36"><p class="calibre22">Alter the <span class="calibre9"><span class="calibre30">venues</span></span> table to contain a boolean column called <span class="calibre9"><span class="calibre30">active</span></span>, with the default value of <span class="calibre9"><span class="calibre30">TRUE</span></span>.</p></li></ol><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos137427" class="calibre1"><p class="calibre24" id="filepos137432"><span class="calibre25"><span class="bold"><span class="calibre26">2.3 Day 2: Advanced Queries, Code, and Rules</span></span></span></p><a></a><p class="calibre27"> Yesterday we saw how to define schemas, populate them with data, update and delete rows, and perform basic reads. Today we’ll dig even deeper into the myriad ways that PostgreSQL can query data. We’ll see how to group similar values, execute code on the server, and create custom interfaces using <span class="italic">views</span> and <span class="italic">rules</span>. We’ll finish the day by using one of PostgreSQL’s contributed packages to flip tables on their heads. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Aggregate Functions</span></span></span></p><a></a><p class="calibre29"> An aggregate query groups results from several rows by some common criteria. It can be as simple as counting the number of rows in a table or calculating the average of some numerical column. They’re powerful SQL tools and also a lot of fun. </p><a></a><p class="calibre12"> Let’s try some aggregate functions, but first we’ll need some more data in our database. Enter your own country into the <span class="calibre9"><span class="calibre30">countries</span></span> table, your own city into the <span class="calibre9"><span class="calibre30">cities</span></span> table, and your own address as a venue (which we just named <span class="italic">My Place</span>). Then add a few records to the <span class="calibre9"><span class="calibre30">events</span></span> table. </p><a></a><p class="calibre12"> Here’s a quick SQL tip: rather than setting the <span class="calibre9"><span class="calibre30">venue_id</span></span> explicitly, you can sub-<span class="calibre9"><span class="calibre30">SELECT</span></span> it using a more human-readable title. If <span class="calibre9"><span class="italic"><span class="calibre38">Moby</span></span></span> is playing at the <span class="calibre9"><span class="italic"><span class="calibre38">Crystal Ballroom</span></span></span>, set the <span class="calibre9"><span class="calibre30">venue_id</span></span> like this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">INSERT</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">INTO</span></span></span><span class="calibre9"> events (title, starts, ends, venue_id)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">VALUES</span></span></span><span class="calibre9"> (</span><span class="calibre9"><span class="italic"><span class="calibre38">'Moby'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'2012-02-06 21:00'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'2012-02-06 23:00'</span></span></span><span class="calibre9">, (​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> venue_id​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> venues​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> name = </span><span class="calibre9"><span class="italic"><span class="calibre38">'Crystal Ballroom'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​);​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Populate your events table with the following data (to enter <span class="italic">Valentine’s Day</span> in PostgreSQL, you can escape the apostrophe with two, such as <span class="italic">Heaven”s Gate</span>): </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​       title     |       starts        |        ends         |      venue​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-----------------+---------------------+---------------------+---------------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Wedding         | 2012-02-26 21:00:00 | 2012-02-26 23:00:00 | Voodoo Donuts​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Dinner with Mom | 2012-02-26 18:00:00 | 2012-02-26 20:30:00 | My Place​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Valentine’s Day | 2012-02-14 00:00:00 | 2012-02-14 23:59:00 |​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> With our data set up, let’s try some aggregate queries. The simplest aggregate function is <span class="calibre9"><span class="calibre30">count</span></span>, which is fairly self-explanatory. Counting all titles that contain the word <span class="calibre9"><span class="italic"><span class="calibre38">Day</span></span></span> (note: % is a wildcard on <span class="calibre9"><span class="calibre30">LIKE</span></span> searches), you should receive a value of 3. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> count(title)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> events​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> title </span><span class="calibre9"><span class="bold"><span class="calibre44">LIKE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="italic"><span class="calibre38">'%Day%'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> To get the first start time and last end time of all events at the Crystal Ballroom, use <span class="calibre9"><span class="calibre30">min</span></span> (return the smallest value) and <span class="calibre9"><span class="calibre30">max</span></span> (return the largest value). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> min(starts), max(ends)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> events </span><span class="calibre9"><span class="bold"><span class="calibre44">INNER</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">JOIN</span></span></span><span class="calibre9"> venues​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">ON</span></span></span><span class="calibre9"> events.venue_id = venues.venue_id​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> venues.name = </span><span class="calibre9"><span class="italic"><span class="calibre38">'Crystal Ballroom'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​         min         |         max​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre46">---------------------+---------------------</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ 2012-02-06 21:00:00 | 2012-02-06 23:00:00​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Aggregate functions are useful but limited on their own. If we wanted to count all events at each venue, we could write the following for each venue ID: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> count(*) </span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> events </span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> venue_id = 1;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> count(*) </span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> events </span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> venue_id = 2;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> count(*) </span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> events </span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> venue_id = 3;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> count(*) </span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> events </span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> venue_id IS NULL;​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This would be tedious (intractable even) as the number of venues grows. Enter the <span class="calibre9"><span class="calibre30">GROUP BY</span></span> command. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Grouping</span></span></span></p><a></a><p class="calibre29"><span class="calibre9"><span class="calibre30">GROUP BY</span></span> is a shortcut for running the previous queries all at once. With <span class="calibre9"><span class="calibre30">GROUP BY</span></span>, you tell Postgres to place the rows into groups and then perform some aggregate function (such as <span class="calibre9"><span class="calibre30">count</span></span>) on those groups. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> venue_id, count(*)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> events​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">GROUP</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">BY</span></span></span><span class="calibre9"> venue_id;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ venue_id | count​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​----------+-------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        1 |     1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        2 |     2​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        3 |     1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​          |     3​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> It’s a nice list, but can we filter by the <span class="calibre9"><span class="calibre30">count</span></span> function? Absolutely. The <span class="calibre9"><span class="calibre30">GROUP BY</span></span> condition has its own filter keyword: <span class="calibre9"><span class="calibre30">HAVING</span></span>. <span class="calibre9"><span class="calibre30">HAVING</span></span> is like the <span class="calibre9"><span class="calibre30">WHERE</span></span> clause, except it can filter by aggregate functions (whereas <span class="calibre9"><span class="calibre30">WHERE</span></span> cannot). </p><a></a><p class="calibre12"> The following query <span class="calibre9"><span class="calibre30">SELECT</span></span>s the most popular venues, those with two or more events: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> venue_id​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> events​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">GROUP</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">BY</span></span></span><span class="calibre9"> venue_id​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​HAVING count(*) &gt;= 2 </span><span class="calibre9"><span class="bold"><span class="calibre44">AND</span></span></span><span class="calibre9"> venue_id IS </span><span class="calibre9"><span class="bold"><span class="calibre44">NOT</span></span></span><span class="calibre9"> NULL;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ venue_id | count​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​----------+-------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        2 |     2​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You can use <span class="calibre9"><span class="calibre30">GROUP BY</span></span> without any aggregate functions. If you call <span class="calibre9"><span class="calibre30">SELECT...</span></span>
<span class="calibre9"><span class="calibre30">FROM...GROUP BY</span></span> on one column, you get all unique values. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> venue_id </span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> events </span><span class="calibre9"><span class="bold"><span class="calibre44">GROUP</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">BY</span></span></span><span class="calibre9"> venue_id;​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This kind of grouping is so common that SQL has a shortcut in the <span class="calibre9"><span class="calibre30">DISTINCT</span></span> keyword. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> DISTINCT venue_id </span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> events;​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The results of both queries will be identical. </p><blockquote class="calibre40"><span class="calibre41"><span class="bold">GROUP BY in MySQL</span></span></blockquote><a></a><blockquote class="calibre42"><span class="calibre41"> If you tried to run a </span><span class="calibre9"><span class="calibre30">SELECT</span></span><span class="calibre41"> with columns not defined under a </span><span class="calibre9"><span class="calibre30">GROUP BY</span></span><span class="calibre41"> in MySQL, you may be shocked to see that it works. This originally made us question the necessity of window functions. But when we more closely inspected the data MySQL returns, we found it will return only a random row of data along with the count, not all relevant results. Generally, that’s not useful (and quite potentially dangerous). </span></blockquote><p class="calibre61"><span class="calibre5"><span class="bold"><span class="calibre28">Window Functions</span></span></span></p><a></a><p class="calibre29"> If you’ve done any sort of production work with a relational database in the past, you were likely familiar with aggregate queries. They are a common <span class="bold"><span class="calibre39">SQL</span></span> staple. <span class="italic">Window functions</span>, on the other hand, are not quite so common (PostgreSQL is one of the few open source databases to implement them). </p><a></a><p class="calibre12"> Window functions are similar to <span class="calibre9"><span class="calibre30">GROUP BY</span></span> queries in that they allow you to run aggregate functions across multiple rows. The difference is that they allow you to use built-in aggregate functions without requiring every single field to be grouped to a single row. </p><a></a><p class="calibre12"> If we attempt to select the <span class="calibre9"><span class="calibre30">title</span></span> column without grouping by it, we can expect an error. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> title, venue_id, count(*)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> events​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">GROUP</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">BY</span></span></span><span class="calibre9"> venue_id;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ERROR:  column "events.title" must appear in the GROUP BY clause or \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        be used in an aggregate function​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We are counting up the rows by <span class="calibre9"><span class="calibre30">venue_id</span></span>, and in the case of <span class="calibre9"><span class="italic"><span class="calibre38">LARP Club</span></span></span> and <span class="calibre9"><span class="italic"><span class="calibre38">Wedding</span></span></span>, we have two titles for a single <span class="calibre9"><span class="calibre30">venue_id</span></span>. Postgres doesn’t know <span class="italic">which</span> title to display. </p><a id="filepos163772"></a><blockquote class="calibre10"><img src="images/00025.jpg" class="calibre62"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 4. Window function results do not collapse results per group.</span></blockquote><a></a><p class="calibre12"> Whereas a <span class="calibre9"><span class="calibre30">GROUP BY</span></span> clause will return one record per matching group value, a window function can return a separate record for each row. For a visual representation, see Figure 4, <a href="#filepos163772"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Window function results do not collapse results per group</span></span><span class="calibre13"><span class="underline">​</span></span></a>. Let’s see an example of the sweet spot that window functions attempt to hit. </p><a></a><p class="calibre12"> Window functions return all matches and replicate the results of any aggregate function. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> title, count(*) OVER (PARTITION </span><span class="calibre9"><span class="bold"><span class="calibre44">BY</span></span></span><span class="calibre9"> venue_id) </span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> events;​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We like to think of <span class="calibre9"><span class="calibre30">PARTITION BY</span></span> as akin to <span class="calibre9"><span class="calibre30">GROUP BY</span></span>, but rather than grouping the results outside of the <span class="calibre9"><span class="calibre30">SELECT</span></span> attribute list (and thus combining the results into fewer rows), it returns grouped values as any other field (calculating on the grouped variable but otherwise just another attribute). Or in <span class="bold"><span class="calibre39">SQL</span></span> parlance, it returns the results of an aggregate function <span class="calibre9"><span class="calibre30">OVER</span></span> a <span class="calibre9"><span class="calibre30">PARTITION</span></span> of the result set. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Transactions</span></span></span></p><a></a><p class="calibre29"> Transactions are the bulwark of relational database consistency. <span class="italic">All or nothing</span>, that’s the transaction motto. Transactions ensure that every command of a set is executed. If anything fails along the way, all of the commands are rolled back like they never happened. </p><a></a><p class="calibre12"> PostgreSQL transactions follow <span class="bold"><span class="calibre39">ACID</span></span> compliance, which stands for Atomic (all ops succeed or none do), Consistent (the data will always be in a good state—no inconsistent states), Isolated (transactions don’t interfere), and Durable (a committed transaction is safe, even after a server crash). We should note that <span class="italic">consistency</span> in ACID is different from <span class="italic">consistency</span> in CAP (covered in Appendix 2, <a href="#filepos1996601"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">The CAP Theorem</span></span><span class="calibre13"><span class="underline">​</span></span></a>). </p><a></a><blockquote class="calibre40"><span class="calibre41"><span class="bold">Unavoidable Transactions</span></span></blockquote><a></a><blockquote class="calibre42"><span class="calibre41"> Up until now, every command we’ve executed in </span><span class="calibre9"><span class="calibre30">psql</span></span><span class="calibre41"> has been implicitly wrapped in a transaction. If you executed a command, such as </span><span class="calibre9"><span class="calibre30">DELETE FROM account WHERE total &lt; 20;</span></span><span class="calibre41">, and the database crashed halfway through the delete, you wouldn’t be stuck with half a table. When you restart the database server, that command will be rolled back. </span></blockquote><a></a><p class="calibre43"> We can wrap any transaction within a <span class="calibre9"><span class="calibre30">BEGIN TRANSACTION</span></span> block. To verify atomicity, we’ll kill the transaction with the <span class="calibre9"><span class="calibre30">ROLLBACK</span></span> command. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">BEGIN</span></span></span><span class="calibre9"> TRANSACTION;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">DELETE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> events;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ROLLBACK;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> * </span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> events;​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The events all remain. Transactions are useful when you’re modifying two tables that you don’t want out of sync. The classic example is a debit/credit system for a bank, where money is moved from one account to another: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">BEGIN</span></span></span><span class="calibre9"> TRANSACTION;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">UPDATE</span></span></span><span class="calibre9"> account </span><span class="calibre9"><span class="bold"><span class="calibre44">SET</span></span></span><span class="calibre9"> total=total+5000.0 </span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> account_id=1337;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">UPDATE</span></span></span><span class="calibre9"> account </span><span class="calibre9"><span class="bold"><span class="calibre44">SET</span></span></span><span class="calibre9"> total=total-5000.0 </span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> account_id=45887;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">END</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If something happened between the two updates, this bank just lost five grand. But when wrapped in a transaction block, the initial update is rolled back, even if the server explodes. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Stored Procedures</span></span></span></p><a></a><p class="calibre29"> Every command we’ve seen until now has been declarative, but sometimes we need to run some code. At this point, you must make a decision: execute code on the client side or execute code on the database side. </p><a></a><p class="calibre12"> Stored procedures can offer huge performance advantages for huge architectural costs. You may avoid streaming thousands of rows to a client application, but you have also bound your application code to this database. The decision to use stored procedures should not be arrived at lightly. </p><a></a><p class="calibre12"> Warnings aside, let’s create a procedure (or <span class="calibre9"><span class="calibre30">FUNCTION</span></span>) that simplifies <span class="calibre9"><span class="calibre30">INSERT</span></span>ing a new event at a venue without needing the <span class="calibre9"><span class="calibre30">venue_id</span></span>. If the venue doesn’t exist, create it first and reference it in the new event. Also, we’ll return a boolean indicating whether a new venue was added, as a nicety to our users. </p><a></a><blockquote class="calibre40"><span class="calibre41"><span class="bold">What About Vendor Lock?</span></span></blockquote><a></a><blockquote class="calibre42"><span class="calibre41"> When relational databases hit their heyday, they were the Swiss Army knife of technologies. You could store nearly anything—even programming entire projects in them (for example, Microsoft Access). The few companies that provided this software promoted use of proprietary differences and then took advantage of this corporate reliance by charging enormous license and consulting fees. This was the dreaded </span><span class="calibre41"><span class="italic">vendor lock</span></span><span class="calibre41"> that newer programming methodologies tried to mitigate in the 1990s and early 2000s. </span></blockquote><a></a><blockquote class="calibre47"><span class="calibre41"> However, in their zeal to neuter the vendors, maxims arose such as </span><span class="calibre41"><span class="italic">no logic in the database</span></span><span class="calibre41">. This is a shame because relational databases are capable of so many varied data management options. Vendor lock has not disappeared. Many actions we investigate in this book are highly implementation specific. However, it’s worth knowing how to use databases to their fullest extent before deciding to skip tools like stored procedures </span><span class="calibre41"><span class="italic">a priori</span></span><span class="calibre41">. </span></blockquote><br class="calibre1"/><br class="calibre1"/><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/postgres/add_event.sql"><span class="calibre41"><span class="calibre13"><span class="underline">postgres/add_event.sql</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">OR</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">REPLACE</span></span></span><span class="calibre9"> FUNCTION add_event( title </span><span class="calibre9"><span class="bold"><span class="calibre44">text</span></span></span><span class="calibre9">, starts </span><span class="calibre9"><span class="bold"><span class="calibre44">timestamp</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  ends </span><span class="calibre9"><span class="bold"><span class="calibre44">timestamp</span></span></span><span class="calibre9">, venue </span><span class="calibre9"><span class="bold"><span class="calibre44">text</span></span></span><span class="calibre9">, postal </span><span class="calibre9"><span class="bold"><span class="calibre44">varchar</span></span></span><span class="calibre9">(9), country </span><span class="calibre9"><span class="bold"><span class="calibre44">char</span></span></span><span class="calibre9">(2) )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​RETURNS </span><span class="calibre9"><span class="bold"><span class="calibre44">boolean</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">AS</span></span></span><span class="calibre9"> $$​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​DECLARE​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  did_insert </span><span class="calibre9"><span class="bold"><span class="calibre44">boolean</span></span></span><span class="calibre9"> := false;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  found_count </span><span class="calibre9"><span class="bold"><span class="calibre44">integer</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  the_venue_id </span><span class="calibre9"><span class="bold"><span class="calibre44">integer</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">BEGIN</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> venue_id </span><span class="calibre9"><span class="bold"><span class="calibre44">INTO</span></span></span><span class="calibre9"> the_venue_id​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> venues v​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> v.postal_code=postal </span><span class="calibre9"><span class="bold"><span class="calibre44">AND</span></span></span><span class="calibre9"> v.country_code=country </span><span class="calibre9"><span class="bold"><span class="calibre44">AND</span></span></span><span class="calibre9"> v.name ILIKE venue​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  LIMIT 1;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">IF</span></span></span><span class="calibre9"> the_venue_id IS NULL </span><span class="calibre9"><span class="bold"><span class="calibre44">THEN</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">INSERT</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">INTO</span></span></span><span class="calibre9"> venues (name, postal_code, country_code)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">VALUES</span></span></span><span class="calibre9"> (venue, postal, country)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    RETURNING venue_id </span><span class="calibre9"><span class="bold"><span class="calibre44">INTO</span></span></span><span class="calibre9"> the_venue_id;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    did_insert := true;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">END</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">IF</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="italic"><span class="calibre46">-- Note: not an “error”, as in some programming languages</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  RAISE NOTICE </span><span class="calibre9"><span class="italic"><span class="calibre38">'Venue found %'</span></span></span><span class="calibre9">, the_venue_id;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">INSERT</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">INTO</span></span></span><span class="calibre9"> events (title, starts, ends, venue_id)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">VALUES</span></span></span><span class="calibre9"> (title, starts, ends, the_venue_id);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  RETURN did_insert;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">END</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$$ LANGUAGE plpgsql;​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You can import this external file into the current schema by the following command-line argument (if you don’t feel like typing all that code). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​book=</span><span class="calibre9"><span class="italic"><span class="calibre46"># \i add_event.sql</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Running it should return <span class="calibre9"><span class="calibre30">t</span></span> (true), since this is the first use of the venue <span class="calibre9"><span class="italic"><span class="calibre38">Run’s House</span></span></span>. This saves a client two round-trip SQL commands to the database (a select and then an insert) and instead does only one. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> add_event(</span><span class="calibre9"><span class="italic"><span class="calibre38">'House Party'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'2012-05-03 23:00'</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="italic"><span class="calibre38">'2012-05-04 02:00'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'Run''s House'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'97205'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'us'</span></span></span><span class="calibre9">);​</span><span class="calibre9">​</span></p></td></tr></table><blockquote class="calibre40"><span class="calibre41"><span class="bold">Choosing to Execute Database Code</span></span></blockquote><a></a><blockquote class="calibre42"><span class="calibre41"> This is the first of a number of places you’ll see this theme in this book: does the code belong in your application or in the database? It is a difficult decision—one that you’ll have to answer uniquely for every application. </span></blockquote><a></a><blockquote class="calibre47"><span class="calibre41"> The benefit is you’ll often improve performance by as much as an order of magnitude. For example, you might have a complex application-specific calculation that requires custom code. If the calculation involves many rows, a stored procedure will save you from moving thousands of rows instead of a single result. The cost is splitting your application, your code, and your tests, across two different programming paradigms. </span></blockquote><p class="calibre43" id="filepos189169"> The language we used in the procedure we wrote is PL/pgSQL (which stands for Procedural Language/PostgreSQL). Covering the details of an entire programming language is beyond our scope, but you can read much more about it in the online PostgreSQL documentation.<a href="#filepos356660"><span class="calibre13"><span class="underline">[5]</span></span></a>
</p><a></a><p class="calibre12"> In addition to PL/pgSQL, Postgres supports three more core languages for writing procedures: Tcl, Perl, and Python. People have written extensions for a dozen more including Ruby, Java, PHP, Scheme, and others listed in the public documentation. Try this shell command: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">createlang book --list</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><p class="calibre45" id="filepos190236"> It will list the languages installed in your database. The <span class="calibre9"><span class="calibre30">createlang</span></span> command is also used to add new languages, which you can find online.<a href="#filepos356660"><span class="calibre13"><span class="underline">[6]</span></span></a>
</p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Pull the Triggers</span></span></span></p><a></a><p class="calibre29"> Triggers automatically fire stored procedures when some event happens, like an insert or update. They allow the database to enforce some required behavior in response to changing data. </p><a></a><p class="calibre12"> Let’s create a new PL/pgSQL function that logs whenever an event is updated (we want to be sure no one changes an event and tries to deny it later). First, create a <span class="calibre9"><span class="calibre30">logs</span></span> table to store event changes. A primary key isn’t necessary here, since it’s just a log. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">TABLE</span></span></span><span class="calibre9"> logs (​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  event_id </span><span class="calibre9"><span class="bold"><span class="calibre44">integer</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  old_title </span><span class="calibre9"><span class="bold"><span class="calibre44">varchar</span></span></span><span class="calibre9">(255),​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  old_starts </span><span class="calibre9"><span class="bold"><span class="calibre44">timestamp</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  old_ends </span><span class="calibre9"><span class="bold"><span class="calibre44">timestamp</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  logged_at </span><span class="calibre9"><span class="bold"><span class="calibre44">timestamp</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">DEFAULT</span></span></span><span class="calibre9"> current_timestamp​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​);​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Next, we build a function to insert old data into the log. The <span class="calibre9"><span class="calibre30">OLD</span></span> variable represents the row about to be changed (<span class="calibre9"><span class="calibre30">NEW</span></span> represents an incoming row, which we’ll see in action soon enough). Output a notice to the console with the <span class="calibre9"><span class="calibre30">event_id</span></span> before returning. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/postgres/log_event.sql"><span class="calibre41"><span class="calibre13"><span class="underline">postgres/log_event.sql</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">OR</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">REPLACE</span></span></span><span class="calibre9"> FUNCTION log_event() RETURNS </span><span class="calibre9"><span class="bold"><span class="calibre44">trigger</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">AS</span></span></span><span class="calibre9"> $$​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​DECLARE​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">BEGIN</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">INSERT</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">INTO</span></span></span><span class="calibre9"> logs (event_id, old_title, old_starts, old_ends)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">VALUES</span></span></span><span class="calibre9"> (OLD.event_id, OLD.title, OLD.starts, OLD.ends);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  RAISE NOTICE </span><span class="calibre9"><span class="italic"><span class="calibre38">'Someone just changed event #%'</span></span></span><span class="calibre9">, OLD.event_id;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  RETURN NEW;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">END</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$$ LANGUAGE plpgsql;​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Finally, we create our trigger to log changes after any row is updated. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">TRIGGER</span></span></span><span class="calibre9"> log_events​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  AFTER </span><span class="calibre9"><span class="bold"><span class="calibre44">UPDATE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">ON</span></span></span><span class="calibre9"> events​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  FOR EACH ROW EXECUTE PROCEDURE log_event();​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> So, it turns out our party at Run’s House has to end earlier than we hoped. Let’s change the event. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">UPDATE</span></span></span><span class="calibre9"> events​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SET</span></span></span><span class="calibre9"> ends=</span><span class="calibre9"><span class="italic"><span class="calibre38">'2012-05-04 01:00:00'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> title=</span><span class="calibre9"><span class="italic"><span class="calibre38">'House Party'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​NOTICE:  Someone just changed event </span><span class="calibre9"><span class="italic"><span class="calibre46">#9</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> And the old end time was logged. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> event_id, old_title, old_ends, logged_at​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> logs;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​event_id |  old_title  |      old_ends       |        logged_at​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre46">---------+-------------+---------------------+------------------------</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​       9 | House Party | 2012-05-04 02:00:00 | 2011-02-26 15:50:31.939​</span><span class="calibre9">​</span></p></td></tr></table><p class="calibre45" id="filepos203061"> Triggers can also be created before updates and before or after inserts.<a href="#filepos356660"><span class="calibre13"><span class="underline">[7]</span></span></a>
</p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Viewing the World</span></span></span></p><a></a><p class="calibre29"> Wouldn’t it be great if you could use the results of a complex query just like any other table? Well, that’s exactly what <span class="calibre9"><span class="calibre30">VIEW</span></span>s are for. Unlike stored procedures, these aren’t functions being executed but rather aliased queries. </p><a></a><p class="calibre12"> In our database, all holidays contain the word <span class="italic">Day</span> and have no venue. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/postgres/holiday_view_1.sql"><span class="calibre41"><span class="calibre13"><span class="underline">postgres/holiday_view_1.sql</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> VIEW holidays </span><span class="calibre9"><span class="bold"><span class="calibre44">AS</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> event_id </span><span class="calibre9"><span class="bold"><span class="calibre44">AS</span></span></span><span class="calibre9"> holiday_id, title </span><span class="calibre9"><span class="bold"><span class="calibre44">AS</span></span></span><span class="calibre9"> name, starts </span><span class="calibre9"><span class="bold"><span class="calibre44">AS</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">date</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> events​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> title </span><span class="calibre9"><span class="bold"><span class="calibre44">LIKE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="italic"><span class="calibre38">'%Day%'</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">AND</span></span></span><span class="calibre9"> venue_id IS NULL;​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> So, creating a view is as simple as writing a query and prefixing it with <span class="calibre9"><span class="calibre30">CREATE VIEW some_view_name AS</span></span>. Now you can query <span class="calibre9"><span class="calibre30">holidays</span></span> like any other table. Under the covers it’s the plain old <span class="calibre9"><span class="calibre30">events</span></span> table. As proof, add <span class="calibre9"><span class="italic"><span class="calibre38">Valentine’s Day</span></span></span> on <span class="calibre9"><span class="italic"><span class="calibre38">2012-02-14</span></span></span> to <span class="calibre9"><span class="calibre30">events</span></span> and query the <span class="calibre9"><span class="calibre30">holidays</span></span> view. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> name, to_char(</span><span class="calibre9"><span class="bold"><span class="calibre44">date</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'Month DD, YYYY'</span></span></span><span class="calibre9">) </span><span class="calibre9"><span class="bold"><span class="calibre44">AS</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">date</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> holidays​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">date</span></span></span><span class="calibre9"> &lt;= </span><span class="calibre9"><span class="italic"><span class="calibre38">'2012-04-01'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      name       |        date​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-----------------+--------------------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ April Fools Day | April     01, 2012​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Valentine’s Day | February  14, 2012​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Views are powerful tools for opening up complex queried data in a simple way. The query may be a roiling sea of complexity underneath, but all you see is a table. </p><a></a><p class="calibre12"> If you want to add a new column to the view, it will have to come from the underlying table. Let’s alter the <span class="calibre9"><span class="calibre30">events</span></span> table to have an array of associated colors. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ALTER </span><span class="calibre9"><span class="bold"><span class="calibre44">TABLE</span></span></span><span class="calibre9"> events​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ADD colors </span><span class="calibre9"><span class="bold"><span class="calibre44">text</span></span></span><span class="calibre9"> ARRAY;​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Since <span class="calibre9"><span class="calibre30">holidays</span></span> are to have colors associated with them, let’s update the <span class="calibre9"><span class="calibre30">VIEW</span></span> query to contain the <span class="calibre9"><span class="calibre30">colors</span></span> array. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">OR</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">REPLACE</span></span></span><span class="calibre9"> VIEW holidays </span><span class="calibre9"><span class="bold"><span class="calibre44">AS</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> event_id </span><span class="calibre9"><span class="bold"><span class="calibre44">AS</span></span></span><span class="calibre9"> holiday_id, title </span><span class="calibre9"><span class="bold"><span class="calibre44">AS</span></span></span><span class="calibre9"> name, starts </span><span class="calibre9"><span class="bold"><span class="calibre44">AS</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">date</span></span></span><span class="calibre9">, colors​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> events​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> title </span><span class="calibre9"><span class="bold"><span class="calibre44">LIKE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="italic"><span class="calibre38">'%Day%'</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">AND</span></span></span><span class="calibre9"> venue_id IS NULL;​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Now it’s a matter of setting an array or color strings to the holiday of choice. Unfortunately, we cannot update a view directly. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">UPDATE</span></span></span><span class="calibre9"> holidays </span><span class="calibre9"><span class="bold"><span class="calibre44">SET</span></span></span><span class="calibre9"> colors = </span><span class="calibre9"><span class="italic"><span class="calibre38">'{"red","green"}'</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">where</span></span></span><span class="calibre9"> name = </span><span class="calibre9"><span class="italic"><span class="calibre38">'Christmas Day'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ERROR:  cannot update a view​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​HINT:  You need an unconditional ON UPDATE DO INSTEAD rule.​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Looks like we need a <span class="calibre9"><span class="calibre30">RULE</span></span>. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">What RULEs the School?</span></span></span></p><a></a><p class="calibre29"> A <span class="calibre9"><span class="calibre30">RULE</span></span> is a description of how to alter the parsed <span class="italic">query tree</span>. Every time Postgres runs an SQL statement, it parses the statement into a query tree (generally called an <span class="italic">abstract syntax tree</span>). </p><a></a><p class="calibre12"> Operators and values become branches and leaves in the tree, and the tree is walked, pruned, and in other ways edited before execution. This tree is optionally rewritten by Postgres rules, before being sent on to the query planner (which also rewrites the tree in a way to run optimally), and sends this final command to be executed. See Figure 5, <a href="#filepos216592"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">How SQL gets executed in PostgreSQL</span></span><span class="calibre13"><span class="underline">​</span></span></a>. What’s more is that a <span class="calibre9"><span class="calibre30">VIEW</span></span> such as <span class="calibre9"><span class="calibre30">holidays</span></span> <span class="italic">is</span> a <span class="calibre9"><span class="calibre30">RULE</span></span>. </p><a id="filepos216592"></a><blockquote class="calibre10"><img src="images/00010.jpg" class="calibre63"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 5. How SQL gets executed in PostgreSQL</span></blockquote><a></a><p class="calibre12"> We can prove this by taking a look at the execution plan of the <span class="calibre9"><span class="calibre30">holidays</span></span> view using the <span class="calibre9"><span class="calibre30">EXPLAIN</span></span> command (notice <span class="calibre9"><span class="italic"><span class="calibre38">Filter</span></span></span> is the <span class="calibre9"><span class="calibre30">WHERE</span></span> clause, and <span class="calibre9"><span class="italic"><span class="calibre38">Output</span></span></span> is the column list). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​EXPLAIN VERBOSE​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> *​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> holidays;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​                                    QUERY PLAN​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-----------------------------------------------------------------------------------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Seq Scan on public.events  (cost=0.00..1.04 rows=1 width=57)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​   Output: events.event_id, events.title, events.starts, events.colors​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​   Filter: ((events.venue_id IS NULL) AND ((events.title)::text ~~ '%Day%'::text))​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Compare that to running <span class="calibre9"><span class="calibre30">EXPLAIN VERBOSE</span></span> on the query we built the <span class="calibre9"><span class="calibre30">holidays</span></span>  <span class="calibre9"><span class="calibre30">VIEW</span></span> from. They’re functionally identical. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​EXPLAIN VERBOSE​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> event_id </span><span class="calibre9"><span class="bold"><span class="calibre44">AS</span></span></span><span class="calibre9"> holiday_id,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    title </span><span class="calibre9"><span class="bold"><span class="calibre44">AS</span></span></span><span class="calibre9"> name, starts </span><span class="calibre9"><span class="bold"><span class="calibre44">AS</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">date</span></span></span><span class="calibre9">, colors​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> events​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> title </span><span class="calibre9"><span class="bold"><span class="calibre44">LIKE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="italic"><span class="calibre38">'%Day%'</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">AND</span></span></span><span class="calibre9"> venue_id IS NULL;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​                                    QUERY PLAN​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-----------------------------------------------------------------------------------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Seq Scan on public.events  (cost=0.00..1.04 rows=1 width=57)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​   Output: event_id, title, starts, colors​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​   Filter: ((events.venue_id IS NULL) AND ((events.title)::text ~~ '%Day%'::text))​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> So, to allow updates against our <span class="calibre9"><span class="calibre30">holidays</span></span> view, we need to craft a <span class="calibre9"><span class="calibre30">RULE</span></span> that tells Postgres what to do with an <span class="calibre9"><span class="calibre30">UPDATE</span></span>. Our rule will capture updates to the <span class="calibre9"><span class="calibre30">holidays</span></span> view and instead run the update on <span class="calibre9"><span class="calibre30">events</span></span>, pulling values from the pseudorelations <span class="calibre9"><span class="calibre30">NEW</span></span> and <span class="calibre9"><span class="calibre30">OLD</span></span>. <span class="calibre9"><span class="calibre30">NEW</span></span> functionally acts as the relation containing the values we’re setting, while <span class="calibre9"><span class="calibre30">OLD</span></span> contains the values we query by. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/postgres/create_rule.sql"><span class="calibre41"><span class="calibre13"><span class="underline">postgres/create_rule.sql</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> RULE update_holidays </span><span class="calibre9"><span class="bold"><span class="calibre44">AS</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">ON</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">UPDATE</span></span></span><span class="calibre9"> TO holidays DO INSTEAD​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">UPDATE</span></span></span><span class="calibre9"> events​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">SET</span></span></span><span class="calibre9"> title = NEW.name,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      starts = NEW.</span><span class="calibre9"><span class="bold"><span class="calibre44">date</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      colors = NEW.colors​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> title = OLD.name;​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> With this rule in place, now we can update <span class="calibre9"><span class="calibre30">holidays</span></span> directly. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">UPDATE</span></span></span><span class="calibre9"> holidays </span><span class="calibre9"><span class="bold"><span class="calibre44">SET</span></span></span><span class="calibre9"> colors = </span><span class="calibre9"><span class="italic"><span class="calibre38">'{"red","green"}'</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">where</span></span></span><span class="calibre9"> name = </span><span class="calibre9"><span class="italic"><span class="calibre38">'Christmas Day'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Next let’s insert <span class="calibre9"><span class="italic"><span class="calibre38">New Years Day</span></span></span> on <span class="calibre9"><span class="italic"><span class="calibre38">2013-01-01</span></span></span> into <span class="calibre9"><span class="calibre30">holidays</span></span>. As expected, we need a rule for that too. No problem. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> RULE insert_holidays </span><span class="calibre9"><span class="bold"><span class="calibre44">AS</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">ON</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">INSERT</span></span></span><span class="calibre9"> TO holidays DO INSTEAD​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">INSERT</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">INTO</span></span></span><span class="calibre9"> ...​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We’re going to move on from here, but if you’d like to play more with <span class="calibre9"><span class="calibre30">RULE</span></span>s, try to add a <span class="calibre9"><span class="calibre30">DELETE RULE</span></span>. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">I’ll Meet You at the Crosstab</span></span></span></p><a></a><p class="calibre29"> For our last exercise of the day, we’re going to build a monthly calendar of events, where each month in the calendar year counts the number of events in that month. This kind of operation is commonly done by a <span class="italic">pivot table</span>. These constructs “pivot” grouped data around some other output, in our case, a list of months. We’ll build our pivot table using the <span class="calibre9"><span class="calibre30">crosstab</span></span> function. </p><a></a><p class="calibre12"> Start by crafting a query to count the number of events per month, each year. PostgreSQL provides an <span class="calibre9"><span class="calibre30">extract</span></span> function that returns some subfield from a date or timestamp, which aids in our grouping. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> extract(</span><span class="calibre9"><span class="bold"><span class="calibre44">year</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">from</span></span></span><span class="calibre9"> starts) </span><span class="calibre9"><span class="bold"><span class="calibre44">as</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">year</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  extract(month </span><span class="calibre9"><span class="bold"><span class="calibre44">from</span></span></span><span class="calibre9"> starts) </span><span class="calibre9"><span class="bold"><span class="calibre44">as</span></span></span><span class="calibre9"> month, count(*)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> events​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">GROUP</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">BY</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">year</span></span></span><span class="calibre9">, month;​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> To use <span class="calibre9"><span class="calibre30">crosstab</span></span>, the query must return three columns: <span class="calibre9"><span class="calibre30">rowid</span></span>, <span class="calibre9"><span class="calibre30">category</span></span>, and <span class="calibre9"><span class="calibre30">value</span></span>. We’ll be using the <span class="calibre9"><span class="calibre30">year</span></span> as an ID, which means the other fields are category (the month) and value (the count). </p><a></a><p class="calibre12"> The <span class="calibre9"><span class="calibre30">crosstab</span></span> function needs another set of values to represent months. This is how the function knows how many columns we need. These are the values that become the columns (the table to <span class="italic">pivot</span> against). So, let’s create a table to store a temporary list of numbers. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> TEMPORARY </span><span class="calibre9"><span class="bold"><span class="calibre44">TABLE</span></span></span><span class="calibre9"> month_count(month </span><span class="calibre9"><span class="bold"><span class="calibre44">INT</span></span></span><span class="calibre9">);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">INSERT</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">INTO</span></span></span><span class="calibre9"> month_count </span><span class="calibre9"><span class="bold"><span class="calibre44">VALUES</span></span></span><span class="calibre9"> (1),(2),(3),(4),(5),(6),(7),(8),(9),(10),(11),(12);​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Now we’re ready to call <span class="calibre9"><span class="calibre30">crosstab</span></span> with our two queries. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> * </span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> crosstab(​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="italic"><span class="calibre38">'SELECT extract(year from starts) as year,</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre38">    extract(month from starts) as month, count(*)</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre38">   FROM events</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre38">   GROUP BY year, month'</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="italic"><span class="calibre38">'SELECT * FROM month_count'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​);​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ERROR:  a column definition list is required for functions returning </span><span class="calibre9"><span class="italic"><span class="calibre38">"record"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Oops. An error occurred. </p><a></a><p class="calibre12"> It may feel cryptic, but it’s saying the function is returning a set of records (rows), but it doesn’t know how to label them. In fact, it doesn’t even know what datatypes they are. </p><a></a><p class="calibre12"> Remember, the pivot table is using our months as categories, but those months are just integers. So, we define them like this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> * </span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> crosstab(​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="italic"><span class="calibre38">'SELECT extract(year from starts) as year,</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre38">    extract(month from starts) as month, count(*)</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre38">   FROM events</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre38">   GROUP BY year, month'</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="italic"><span class="calibre38">'SELECT * FROM month_count'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​) </span><span class="calibre9"><span class="bold"><span class="calibre44">AS</span></span></span><span class="calibre9"> (​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">year</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">int</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  jan </span><span class="calibre9"><span class="bold"><span class="calibre44">int</span></span></span><span class="calibre9">, feb </span><span class="calibre9"><span class="bold"><span class="calibre44">int</span></span></span><span class="calibre9">, mar </span><span class="calibre9"><span class="bold"><span class="calibre44">int</span></span></span><span class="calibre9">, apr </span><span class="calibre9"><span class="bold"><span class="calibre44">int</span></span></span><span class="calibre9">, may </span><span class="calibre9"><span class="bold"><span class="calibre44">int</span></span></span><span class="calibre9">, jun </span><span class="calibre9"><span class="bold"><span class="calibre44">int</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  jul </span><span class="calibre9"><span class="bold"><span class="calibre44">int</span></span></span><span class="calibre9">, aug </span><span class="calibre9"><span class="bold"><span class="calibre44">int</span></span></span><span class="calibre9">, sep </span><span class="calibre9"><span class="bold"><span class="calibre44">int</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="bold"><span class="calibre44">oct</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">int</span></span></span><span class="calibre9">, nov </span><span class="calibre9"><span class="bold"><span class="calibre44">int</span></span></span><span class="calibre9">, dec </span><span class="calibre9"><span class="bold"><span class="calibre44">int</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​) </span><span class="calibre9"><span class="bold"><span class="calibre44">ORDER</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">BY</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">YEAR</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We have one column year (which is the row ID) and twelve more columns representing the months. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">year</span></span></span><span class="calibre9"> | jan | feb | mar | apr | may | jun | jul | aug | sep | </span><span class="calibre9"><span class="bold"><span class="calibre44">oct</span></span></span><span class="calibre9"> | nov | dec​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre46">------+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​2012 |     |   5 |     |   1 |   1 |     |     |     |     |     |     |   1​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Go ahead and add a couple more events on another year just to see next year’s event counts. Run the crosstab function again, and enjoy the calendar. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Day 2 Wrap-Up</span></span></span></p><a></a><p class="calibre29"> Today finalized the basics of PostgreSQL. What we’re starting to see is that Postgres is more than just a server for storing vanilla datatypes and querying them; it is a data management engine that can reformat output data, store weird datatypes like arrays, execute logic, and provide enough power to rewrite incoming queries. </p><p class="calibre12"><span class="bold"><span class="calibre28">Day 2 Homework</span></span></p><p class="calibre37"><span class="bold">Find</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Find the list of aggregate functions in the PostgreSQL docs.</p></li><li value="2" class="calibre36"><p class="calibre22">Find a GUI program to interact with PostgreSQL, such as Navicat.</p></li></ol><p class="calibre12"><span class="bold">Do</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Create a rule that captures <span class="calibre9"><span class="calibre30">DELETE</span></span>s on venues and instead sets the active flag (created in the Day 1 homework) to <span class="calibre9"><span class="calibre30">FALSE</span></span>.</p></li><li value="2" class="calibre36"><p class="calibre22">A temporary table was not the best way to implement our event calendar pivot table. The <span class="calibre9"><span class="calibre30">generate_series(a, b)</span></span> function returns a set of records, from a to b. Replace the <span class="calibre9"><span class="calibre30">month_count</span></span> table <span class="calibre9"><span class="calibre30">SELECT</span></span> with this.</p></li><li value="3" class="calibre36"><p class="calibre22">Build a pivot table that displays every day in a single month, where each week of the month is a row and each day name forms a column across the top (seven days, starting with <span class="calibre9"><span class="calibre30">Sunday</span></span> and ending with <span class="calibre9"><span class="calibre30">Saturday</span></span>) like a standard month calendar. Each day should contain a count of the number of events for that date or should remain blank if no event occurs.</p></li></ol><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos248189" class="calibre1"><p class="calibre24" id="filepos248194"><span class="calibre25"><span class="bold"><span class="calibre26">2.4 Day 3: Full-Text and Multidimensions</span></span></span></p><a></a><p class="calibre27"> We’ll spend Day 3 investigating the many tools at our disposal to build a movie query system. We’ll begin with the many ways that PostgreSQL can search actor/movie names using fuzzy string matching. Then we’ll discover the cube package by creating a movie suggestion system based on similar genres of movies we already like. Since these are all contributed packages, the implementations are special to PostgreSQL and not part of the SQL standard. </p><a></a><p class="calibre12"> Commonly, when designing a relational database schema, you’ll start with an entity diagram. We’ll be writing a personal movie suggestion system that keeps track of movies, their genres, and their actors, as modeled in Figure 6, <a href="#filepos249267"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Our movie suggestion system</span></span><span class="calibre13"><span class="underline">​</span></span></a>. </p><a id="filepos249267"></a><blockquote class="calibre10"><img src="images/00005.jpg" class="calibre64"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 6. Our movie suggestion system</span></blockquote><a></a><p class="calibre12"> As a reminder, on Day 1 we installed several contributed packages. Today we’ll need them all. Again, the list we’ll need installed is as follows: <span class="calibre9"><span class="calibre30">tablefunc</span></span>, <span class="calibre9"><span class="calibre30">dict_xsyn</span></span>, <span class="calibre9"><span class="calibre30">fuzzystrmatch</span></span>, <span class="calibre9"><span class="calibre30">pg_trgm</span></span>, and <span class="calibre9"><span class="calibre30">cube</span></span>. </p><a></a><p class="calibre12"> Let’s first build the database. It’s often good practice to create indexes on foreign keys to speed up reverse lookups (such as what movies this actor is involved in). You should also set a <span class="calibre9"><span class="calibre30">UNIQUE</span></span> constraint on join tables like <span class="calibre9"><span class="calibre30">movies_actors</span></span> to avoid duplicate join values. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/postgres/create_movies.sql"><span class="calibre41"><span class="calibre13"><span class="underline">postgres/create_movies.sql</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">TABLE</span></span></span><span class="calibre9"> genres (​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        name </span><span class="calibre9"><span class="bold"><span class="calibre44">text</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">UNIQUE</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        position </span><span class="calibre9"><span class="bold"><span class="calibre44">integer</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">TABLE</span></span></span><span class="calibre9"> movies (​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        movie_id SERIAL </span><span class="calibre9"><span class="bold"><span class="calibre44">PRIMARY</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">KEY</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        title </span><span class="calibre9"><span class="bold"><span class="calibre44">text</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        genre cube​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">TABLE</span></span></span><span class="calibre9"> actors (​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        actor_id SERIAL </span><span class="calibre9"><span class="bold"><span class="calibre44">PRIMARY</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">KEY</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        name </span><span class="calibre9"><span class="bold"><span class="calibre44">text</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">TABLE</span></span></span><span class="calibre9"> movies_actors (​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        movie_id </span><span class="calibre9"><span class="bold"><span class="calibre44">integer</span></span></span><span class="calibre9"> REFERENCES movies </span><span class="calibre9"><span class="bold"><span class="calibre44">NOT</span></span></span><span class="calibre9"> NULL,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        actor_id </span><span class="calibre9"><span class="bold"><span class="calibre44">integer</span></span></span><span class="calibre9"> REFERENCES actors </span><span class="calibre9"><span class="bold"><span class="calibre44">NOT</span></span></span><span class="calibre9"> NULL,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        </span><span class="calibre9"><span class="bold"><span class="calibre44">UNIQUE</span></span></span><span class="calibre9"> (movie_id, actor_id)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">INDEX</span></span></span><span class="calibre9"> movies_actors_movie_id </span><span class="calibre9"><span class="bold"><span class="calibre44">ON</span></span></span><span class="calibre9"> movies_actors (movie_id);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">INDEX</span></span></span><span class="calibre9"> movies_actors_actor_id </span><span class="calibre9"><span class="bold"><span class="calibre44">ON</span></span></span><span class="calibre9"> movies_actors (actor_id);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">INDEX</span></span></span><span class="calibre9"> movies_genres_cube </span><span class="calibre9"><span class="bold"><span class="calibre44">ON</span></span></span><span class="calibre9"> movies </span><span class="calibre9"><span class="bold"><span class="calibre44">USING</span></span></span><span class="calibre9"> gist (genre);​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You can download the <span class="calibre9"><span class="calibre30">movies_data.sql</span></span> file as a file alongside the book and populate the tables by piping the file into the database. Any questions you may have about the <span class="calibre9"><span class="calibre30">genre</span></span> <span class="calibre9"><span class="calibre30">cube</span></span> will be covered later today. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Fuzzy Searching</span></span></span></p><p class="calibre29" id="filepos260134"> Opening up a system to text searches means opening your system to inaccurate inputs. You have to expect typos like “Brid of Frankstein.” Sometimes, users can’t remember the full name of “J. Roberts.” In other cases, we just plain don’t know how to spell “Benn Aflek.” We’ll look into a few PostgreSQL packages that make text searching easy. It’s worth noting that as we progress, this kind of string matching blurs the lines between relational queries and searching frameworks like Lucene.<a href="#filepos356660"><span class="calibre13"><span class="underline">[8]</span></span></a> Although some may feel features like full-text search belong with the application code, there can be performance and administrative benefits of pushing these packages to the database, where the data lives. </p><p class="calibre12"><span class="bold"><span class="calibre28">SQL Standard String Matches</span></span></p><a></a><p class="calibre37"> PostgreSQL has many ways of performing text matches, but the two big default methods are <span class="calibre9"><span class="calibre30">LIKE</span></span> and regular expressions. </p><p class="calibre12"><span class="bold">I Like LIKE and ILIKE</span>
</p><a></a><p class="calibre12"><span class="calibre9"><span class="calibre30">LIKE</span></span> and <span class="calibre9"><span class="calibre30">ILIKE</span></span> (case-insensitive <span class="calibre9"><span class="calibre30">LIKE</span></span>) are the simplest forms of text search. They are fairly universal in relational databases. <span class="calibre9"><span class="calibre30">LIKE</span></span> compares column values against a given pattern string. The % and _ characters are wildcards. % matches any number of any characters, and _ matches exactly one character. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> title </span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> movies </span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> title ILIKE </span><span class="calibre9"><span class="italic"><span class="calibre38">'stardust%'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​       title​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre46">-------------------</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Stardust​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Stardust Memories​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If we want to be sure the substring <span class="calibre9"><span class="italic"><span class="calibre38">stardust</span></span></span> is not at the end of the string, we can use the underscore (_) character as a little trick. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> title </span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> movies </span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> title ILIKE </span><span class="calibre9"><span class="italic"><span class="calibre38">'stardust_%'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​       title​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre46">-------------------</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Stardust Memories​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This is useful in basic cases, but <span class="calibre9"><span class="calibre30">LIKE</span></span> is limited to simple wildcards. </p><p class="calibre12"><span class="bold">Regex</span>
</p><a></a><p class="calibre12"> A more powerful string-matching syntax is a <span class="italic">regular expression</span> (regex). Regexes appear often throughout this book, because many databases support them. There are entire books dedicated to writing powerful expressions—the topic is far too wide and complex to cover in depth. Postgres conforms (mostly) to the POSIX style. </p><a></a><p class="calibre12"> In Postgres, a regular expression match is led by the ~ operator, with the optional ! (meaning, <span class="italic">not</span> matching) and * (meaning <span class="italic">case insensitive</span>). So, to count all movies that do <span class="italic">not</span> begin with <span class="calibre9"><span class="italic"><span class="calibre38">the</span></span></span>, the following case-insensitive query will work. The characters inside the string are the regular expression. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> COUNT(*) </span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> movies </span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> title !~* </span><span class="calibre9"><span class="italic"><span class="calibre38">'^the.*'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You can index strings for pattern matching the previous queries by creating a <span class="calibre9"><span class="calibre30">text_pattern_ops</span></span> operator class index, as long as the values are indexed in lowercase. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">INDEX</span></span></span><span class="calibre9"> movies_title_pattern </span><span class="calibre9"><span class="bold"><span class="calibre44">ON</span></span></span><span class="calibre9"> movies (lower(title) text_pattern_ops);​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We used the <span class="calibre9"><span class="calibre30">text_pattern_ops</span></span> because the title is of type <span class="calibre9"><span class="calibre30">text</span></span>. If you need to index varchars, chars, or names, use the related ops: <span class="calibre9"><span class="calibre30">varchar_pattern_ops</span></span>, <span class="calibre9"><span class="calibre30">bpchar_pattern_ops</span></span>, and <span class="calibre9"><span class="calibre30">name_pattern_ops</span></span>. </p><p class="calibre12"><span class="bold"><span class="calibre28">Bride of Levenshtein</span></span></p><a></a><p class="calibre37"> Levenshtein is a string comparison algorithm that compares how similar two strings are by how many <span class="italic">steps</span> are required to change one string into another. Each replaced, missing, or added character counts as a step. The distance is the total number of steps away. In PostgreSQL, the <span class="calibre9"><span class="calibre30">levenshtein</span></span> function is provided by the <span class="calibre9"><span class="calibre30">fuzzystrmatch</span></span> contrib package. Say we have the string <span class="calibre9"><span class="italic"><span class="calibre38">bat</span></span></span> and the string <span class="calibre9"><span class="italic"><span class="calibre38">fads</span></span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> levenshtein(</span><span class="calibre9"><span class="italic"><span class="calibre38">'bat'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'fads'</span></span></span><span class="calibre9">);​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The Levenshtein distance is 3 because—compared to the string <span class="calibre9"><span class="italic"><span class="calibre38">bat</span></span></span>—we replaced two letters (b=&gt;f, t=&gt;d), and we added a letter (+s). Each change increments the distance. We can watch the distance close as we step closer (so to speak). The total goes down until we get zero (the two strings are equal). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> levenshtein(</span><span class="calibre9"><span class="italic"><span class="calibre38">'bat'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'fad'</span></span></span><span class="calibre9">) fad,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  levenshtein(</span><span class="calibre9"><span class="italic"><span class="calibre38">'bat'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'fat'</span></span></span><span class="calibre9">) fat,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  levenshtein(</span><span class="calibre9"><span class="italic"><span class="calibre38">'bat'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'bat'</span></span></span><span class="calibre9">) bat;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ fad | fat | bat​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-----+-----+-----​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​   2 |   1 |   0​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Changes in case cost a point too, so you may find it best to convert all strings to the same case when querying. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> movie_id, title </span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> movies​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> levenshtein(lower(title), lower(</span><span class="calibre9"><span class="italic"><span class="calibre38">'a hard day nght'</span></span></span><span class="calibre9">)) &lt;= 3;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ movie_id |       title​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​----------+--------------------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      245 | A Hard Day’s Night​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This ensures minor differences won’t over-inflate the distance. </p><p class="calibre12"><span class="bold"><span class="calibre28">Try a Trigram</span></span></p><a></a><p class="calibre37"> A trigram is a group of three consecutive characters taken from a string. The <span class="calibre9"><span class="calibre30">pg_trgm</span></span> contrib module breaks a string into as many trigrams as it can. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> show_trgm(</span><span class="calibre9"><span class="italic"><span class="calibre38">'Avatar'</span></span></span><span class="calibre9">);​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​              show_trgm​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-------------------------------------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ {"  a"," av","ar ",ata,ava,tar,vat}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Finding a matching string is as simple as counting the number of matching trigrams. The strings with the most matches are the most similar. It’s useful for doing a search where you’re OK with either slight misspellings or even minor words missing. The longer the string, the more trigrams and the more likely a match—they’re great for something like movie titles, since they have relatively similar lengths. </p><a></a><p class="calibre12"> We’ll create a trigram index against movie names to start (we use Generalized Index Search Tree [<span class="bold"><span class="calibre39">GIST</span></span>], a generic index API made available by the PostgreSQL engine). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">INDEX</span></span></span><span class="calibre9"> movies_title_trigram </span><span class="calibre9"><span class="bold"><span class="calibre44">ON</span></span></span><span class="calibre9"> movies​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">USING</span></span></span><span class="calibre9"> gist (title gist_trgm_ops);​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Now you can query with a few misspellings and still get decent results. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> *​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> movies​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> title % </span><span class="calibre9"><span class="italic"><span class="calibre38">'Avatre'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  title​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​---------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Avatar​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Trigrams are an excellent choice for accepting user input, without weighing them down with wildcard complexity. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Full-Text Fun</span></span></span></p><a></a><p class="calibre29"> Next, we want to allow users to perform full-text searches based on matching words, even if they’re pluralized. If a user wants to search for certain words in a movie title but can remember only some of them, Postgres supports simple natural-language processing. </p><p class="calibre12"><span class="bold"><span class="calibre28">TSVector and TSQuery</span></span></p><a></a><p class="calibre37"> Let’s look for a movie that contains the words <span class="italic">night</span> and <span class="italic">day</span>. This is a perfect job for text search using the @@ full-text query operator. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> title​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> movies​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> title @@ </span><span class="calibre9"><span class="italic"><span class="calibre38">'night &amp; day'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​             title​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-------------------------------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ A Hard Day’s Night​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Six Days Seven Nights​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Long Day’s Journey Into Night​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The query returns titles like <span class="calibre9"><span class="italic"><span class="calibre38">A Hard Day’s Night</span></span></span>, despite the word <span class="calibre9"><span class="italic"><span class="calibre38">Day</span></span></span> being in possessive form, and the two words are out of order in the query. The @@ operator converts the name field into a <span class="calibre9"><span class="calibre30">tsvector</span></span> and converts the query into a <span class="calibre9"><span class="calibre30">tsquery</span></span>. </p><a></a><p class="calibre12"> A <span class="calibre9"><span class="calibre30">tsvector</span></span> is a datatype that splits a string into an array (or a <span class="italic">vector</span>) of tokens, which are searched against the given query, while the <span class="calibre9"><span class="calibre30">tsquery</span></span> represents a query in some language, like English or French. The language corresponds to a dictionary (which we’ll see more of in a few paragraphs). The previous query is equivalent to the following (if your system language is set to English): </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> title​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> movies​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> to_tsvector(title) @@ to_tsquery(</span><span class="calibre9"><span class="italic"><span class="calibre38">'english'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'night &amp;amp; day'</span></span></span><span class="calibre9">);​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You can take a look at how the vector and the query break apart the values by running the conversion functions on the strings outright. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> to_tsvector(</span><span class="calibre9"><span class="italic"><span class="calibre38">'A Hard Day''s Night'</span></span></span><span class="calibre9">), to_tsquery(</span><span class="calibre9"><span class="italic"><span class="calibre38">'english'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'night &amp;amp; day'</span></span></span><span class="calibre9">);​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      to_tsvector         |   to_tsquery​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​----------------------------+-----------------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​'day':3 'hard':2 'night':5 | 'night' &amp; 'day'​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The tokens on a <span class="calibre9"><span class="calibre30">tsvector</span></span> are called <span class="italic">lexemes</span> and are coupled with their positions in the given phrase. </p><a></a><p class="calibre12"> You may have noticed the <span class="calibre9"><span class="calibre30">tsvector</span></span> for <span class="italic">A Hard Day’s Night</span> did not contain the lexeme <span class="italic">a</span>. Moreover, simple English words like <span class="italic">a</span> are missing if you try to query by them. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> *​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> movies​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> title @@ to_tsquery(</span><span class="calibre9"><span class="italic"><span class="calibre38">'english'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'a'</span></span></span><span class="calibre9">);​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​NOTICE:  text-search query contains only stop words or doesn’t \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​       contain lexemes, ignored​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Common words like <span class="italic">a</span> are called <span class="italic">stop words</span> and are generally not useful for performing queries. The English dictionary was used by the parser to normalize our string into useful English components. In your console, you can view the output of the stop words under the English <span class="calibre9"><span class="calibre30">tsearch_data</span></span> directory. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​cat `pg_config --sharedir`/tsearch_data/english.stop​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We could remove <span class="calibre9"><span class="italic"><span class="calibre38">a</span></span></span> from the list, or we could use another dictionary like <span class="calibre9"><span class="calibre30">simple</span></span> that just breaks up strings by nonword characters and makes them lowercase. Compare these two vectors: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> to_tsvector(</span><span class="calibre9"><span class="italic"><span class="calibre38">'english'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'A Hard Day''s Night'</span></span></span><span class="calibre9">);​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      to_tsvector​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​----------------------------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​'day':3 'hard':2 'night':5​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> to_tsvector(</span><span class="calibre9"><span class="italic"><span class="calibre38">'simple'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'A Hard Day''s Night'</span></span></span><span class="calibre9">);​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​            to_tsvector​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​----------------------------------------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​'a':1 'day':3 'hard':2 'night':5 's':4​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> With <span class="calibre9"><span class="calibre30">simple</span></span>, you can retrieve any movie containing the lexeme <span class="calibre9"><span class="italic"><span class="calibre38">a</span></span></span>. </p><p class="calibre12"><span class="bold"><span class="calibre28">Other Languages</span></span></p><a></a><p class="calibre37"> Since Postgres is doing some natural-language processing here, it only makes sense that different configurations would be used for different languages. All of the installed configurations can be viewed with this command: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​book=# \dF​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Dictionaries are part of what Postgres uses to generate <span class="calibre9"><span class="calibre30">tsvector</span></span> lexemes (along with stop words and other tokenizing rules we haven’t covered called <span class="italic">parsers</span> and <span class="italic">templates</span>). You can view your system’s list here: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​book=# \dFd​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You can test any dictionary outright by calling the <span class="calibre9"><span class="calibre30">ts_lexize</span></span> function. Here we find the English stem word of the string <span class="calibre9"><span class="italic"><span class="calibre38">Day’s</span></span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> ts_lexize(</span><span class="calibre9"><span class="italic"><span class="calibre38">'english_stem'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'Day''s'</span></span></span><span class="calibre9">);​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ ts_lexize​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-----------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ {day}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Finally, the previous full-text commands work for other languages too. If you have German installed, try this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> to_tsvector(</span><span class="calibre9"><span class="italic"><span class="calibre38">'german'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'was machst du gerade?'</span></span></span><span class="calibre9">);​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  to_tsvector​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​--------------------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​'gerad':4 'mach':2​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Since <span class="calibre9"><span class="italic"><span class="calibre38">was</span></span></span> (what) and <span class="calibre9"><span class="italic"><span class="calibre38">du</span></span></span> (you) are common, they are marked as stop words in the German dictionary, while <span class="calibre9"><span class="italic"><span class="calibre38">machst</span></span></span> (doing) and <span class="calibre9"><span class="italic"><span class="calibre38">gerade</span></span></span> (now) are stemmed. </p><p class="calibre12"><span class="bold"><span class="calibre28">Indexing Lexemes</span></span></p><a></a><p class="calibre37"> Full-text search is powerful. But if we don’t index our tables, it’s also slow. The <span class="calibre9"><span class="calibre30">EXPLAIN</span></span> command is a powerful tool for digging into how queries are internally planned. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​EXPLAIN​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> *​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> movies​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> title @@ </span><span class="calibre9"><span class="italic"><span class="calibre38">'night &amp; day'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​                                QUERY PLAN​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​---------------------------------------------------------------------------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Seq Scan on movies  (cost=10000000000.00..10000000001.12 rows=1 width=68)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​   Filter: (title @@ 'night &amp; day'::text)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Note the line <span class="calibre9"><span class="italic"><span class="calibre38">Seq Scan on movies</span></span></span>. That’s rarely a good sign in a query, because it means a whole table scan is taking place; each row will be read. So, we need the right index. </p><a></a><p class="calibre12"> We’ll use Generalized Inverted iNdex (GIN)—like GIST, it’s an index API—to create an index of lexeme values we can query against. The term <span class="italic">inverted index</span> may sound familiar to you if you’ve ever used a search engine like Lucene or Sphinx. It’s a common data structure to index full-text searches. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">CREATE</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">INDEX</span></span></span><span class="calibre9"> movies_title_searchable </span><span class="calibre9"><span class="bold"><span class="calibre44">ON</span></span></span><span class="calibre9"> movies​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">USING</span></span></span><span class="calibre9"> gin(to_tsvector(</span><span class="calibre9"><span class="italic"><span class="calibre38">'english'</span></span></span><span class="calibre9">, title));​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> With our index in place, let’s try to search again. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​EXPLAIN​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> *​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> movies​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> title @@ </span><span class="calibre9"><span class="italic"><span class="calibre38">'night &amp; day'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​                                QUERY PLAN​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​---------------------------------------------------------------------------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Seq Scan on movies  (cost=10000000000.00..10000000001.12 rows=1 width=68)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​   Filter: (title @@ 'night &amp; day'::text)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> What happened? Nothing. The index is there, but Postgres isn’t using it. It’s because our GIN index specifically uses the <span class="calibre9"><span class="calibre30">english</span></span> configuration for building its <span class="calibre9"><span class="calibre30">tsvector</span></span>s, but we aren’t specifying that vector. We need to specify it in the <span class="calibre9"><span class="calibre30">WHERE</span></span> clause of the query. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​EXPLAIN​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> *​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> movies​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> to_tsvector(</span><span class="calibre9"><span class="italic"><span class="calibre38">'english'</span></span></span><span class="calibre9">,title) @@ </span><span class="calibre9"><span class="italic"><span class="calibre38">'night &amp; day'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​                                     QUERY PLAN​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre46">------------------------------------------------------------------------------------</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Bitmap Heap Scan </span><span class="calibre9"><span class="bold"><span class="calibre44">on</span></span></span><span class="calibre9"> movies  (cost=4.26..8.28 rows=1 width=68)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​   Recheck Cond: (to_tsvector(</span><span class="calibre9"><span class="italic"><span class="calibre38">'english'</span></span></span><span class="calibre9">::regconfig, title) @@ </span><span class="calibre9"><span class="italic"><span class="calibre38">'''day'''</span></span></span><span class="calibre9">::tsquery)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​   -&gt; Bitmap </span><span class="calibre9"><span class="bold"><span class="calibre44">Index</span></span></span><span class="calibre9"> Scan </span><span class="calibre9"><span class="bold"><span class="calibre44">on</span></span></span><span class="calibre9"> movies_title_searchable  (cost=0.00..4.26 rows=1 width=0)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        </span><span class="calibre9"><span class="bold"><span class="calibre44">Index</span></span></span><span class="calibre9"> Cond: (to_tsvector(</span><span class="calibre9"><span class="italic"><span class="calibre38">'english'</span></span></span><span class="calibre9">::regconfig, title) @@ </span><span class="calibre9"><span class="italic"><span class="calibre38">'''day'''</span></span></span><span class="calibre9">::tsquery)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"><span class="calibre9"><span class="calibre30">EXPLAIN</span></span> is important to ensure indexes are used as you expect them. Otherwise, the index is just wasted overhead. </p><p class="calibre12"><span class="bold"><span class="calibre28">Metaphones</span></span></p><a></a><p class="calibre37"> We’ve inched toward matching less-specific inputs. <span class="calibre9"><span class="calibre30">LIKE</span></span> and regular expressions require crafting patterns that can match strings precisely according to their format. Levenshtein distance allows finding matches that contain minor misspellings but must ultimately be very close to the same string. Trigrams are a good choice for finding reasonable misspelled matches. Finally, full-text searching allows natural-language flexibility, in that it can ignore minor words like <span class="italic">a</span> and <span class="italic">the</span> and can deal with pluralization. Sometimes we just don’t know how to spell words correctly but we know how they sound. </p><a></a><p class="calibre12"> We love Bruce Willis and would love to see what movies he’s in. Unfortunately, we can’t remember exactly how to spell his name, so we sound it out as best we can. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> *​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> actors​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> name = </span><span class="calibre9"><span class="italic"><span class="calibre38">'Broos Wlis'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Even a trigram is no good here (using % rather than =). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> *​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> actors​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> name % </span><span class="calibre9"><span class="italic"><span class="calibre38">'Broos Wlis'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Enter the metaphones, which are algorithms for creating a string representation of word sounds. You can define how many characters are in the output string. For example, the seven-character metaphone of the name Aaron Eckhart is <span class="calibre9"><span class="italic"><span class="calibre38">ARNKHRT</span></span></span>. </p><a></a><p class="calibre12"> To find all films acted by someone sounding like Broos Wils, we can query against the metaphone output. Note that <span class="calibre9"><span class="calibre30">NATURAL JOIN</span></span> is an <span class="calibre9"><span class="calibre30">INNER JOIN</span></span> that automatically joins <span class="calibre9"><span class="calibre30">ON</span></span> matching column names (for example, <span class="calibre9"><span class="calibre30">movies.actor_id=</span></span>
<span class="calibre9"><span class="calibre30">movies_actors.actor_id</span></span>). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> title​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> movies NATURAL </span><span class="calibre9"><span class="bold"><span class="calibre44">JOIN</span></span></span><span class="calibre9"> movies_actors NATURAL </span><span class="calibre9"><span class="bold"><span class="calibre44">JOIN</span></span></span><span class="calibre9"> actors​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> metaphone(name, 6) = metaphone(</span><span class="calibre9"><span class="italic"><span class="calibre38">'Broos Wils'</span></span></span><span class="calibre9">, 6);​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​            title​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-----------------------------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ The Fifth Element​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Twelve Monkeys​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Armageddon​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Die Hard​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Pulp Fiction​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ The Sixth Sense​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​:​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If you peek at the online documentation, you’d see the <span class="calibre9"><span class="italic"><span class="calibre38">fuzzystrmatch</span></span></span> module contains other functions: <span class="calibre9"><span class="calibre30">dmetaphone</span></span> (double metaphone), <span class="calibre9"><span class="calibre30">dmetaphone_alt</span></span> (for alternative name pronunciations), and <span class="calibre9"><span class="calibre30">soundex</span></span> (a really old algorithm from the 1880s made by the U.S. Census to compare common American surnames). </p><a></a><p class="calibre12"> You can dissect the functions’ representations by selecting their output. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> name, dmetaphone(name), dmetaphone_alt(name),​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  metaphone(name, 8), soundex(name)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> actors;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      name      | dmetaphone | dmetaphone_alt | metaphone | soundex​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​----------------+------------+----------------+-----------+--------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ 50 Cent        | SNT        | SNT            | SNT       | C530​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Aaron Eckhart  | ARNK       | ARNK           | ARNKHRT   | A652​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Agatha Hurle   | AK0R       | AKTR           | AK0HRL    | A236​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​:​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> There is no single best function to choose, and the optimal choice depends on your dataset. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Combining String Matches</span></span></span></p><a></a><p class="calibre29"> With all of our string searching ducks in a row, we’re ready to start combining them in interesting ways. </p><a></a><p class="calibre12"> One of the most flexible aspects of metaphones is that their outputs are just strings. This allows you to mix and match with other string matchers. </p><a></a><p class="calibre12"> For example, we could use the trigram operator against <span class="calibre9"><span class="calibre30">metaphone</span></span> outputs and then order the results by the lowest Levenshtein distance. This means “Get me names that sound the most like <span class="calibre9"><span class="calibre30">Robin Williams</span></span>, in order.” </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> * </span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> actors​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> metaphone(name,8) % metaphone(</span><span class="calibre9"><span class="italic"><span class="calibre38">'Robin Williams'</span></span></span><span class="calibre9">,8)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">ORDER</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">BY</span></span></span><span class="calibre9"> levenshtein(lower(</span><span class="calibre9"><span class="italic"><span class="calibre38">'Robin Williams'</span></span></span><span class="calibre9">), lower(name));​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ actor_id |      name​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​----------+-----------------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​     2442 | John Williams​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​     4090 | Robin Shou​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​     4093 | Robin Williams​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​     4479 | Steven Williams​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Note it isn’t perfect. Robin Williams ranked at #3. Unbridled exploitation of this flexibility can yield other funny results, so be careful. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> * </span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> actors </span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> dmetaphone(name) % dmetaphone(</span><span class="calibre9"><span class="italic"><span class="calibre38">'Ron'</span></span></span><span class="calibre9">);​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ actor_id |    name​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​----------+-------------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​     3911 | Renji Ishibashi​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​     3913 | Renée Zellweger​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​:​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The combinations are vast, limited only by your experimentations. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Genres as a Multidimensional Hypercube</span></span></span></p><a></a><p class="calibre29"> The last contributed package we investigate is <span class="calibre9"><span class="calibre30">cube</span></span>. We’ll use the <span class="calibre9"><span class="calibre30">cube</span></span> datatype to map a movie’s genres as a multidimensional vector. We will then use methods to efficiently query for the closest points within the boundary of a hypercube to give us a list of similar movies. </p><a></a><p class="calibre12"> As you may have noticed in the beginning of Day 3, we created a column named <span class="calibre9"><span class="calibre30">genres</span></span> of type <span class="calibre9"><span class="calibre30">cube</span></span>. Each value is a point in 18-dimensional space with each dimension representing a genre. Why represent movie genres as points in n-dimensional space? Movie categorization is not an exact science, and many movies are not 100 percent comedy or 100 percent tragedy—they are something in between. </p><a></a><p class="calibre12"> In our system, each genre is scored from (the totally arbitrary numbers) 0 to 10 based on how strong the movie is within that genre—with 0 being nonexistent and 10 being the strongest. </p><a></a><p class="calibre12"><span class="italic">Star Wars</span> has a genre vector of <span class="calibre9"><span class="calibre30">(0,7,0,0,0,0,0,0,0,7,0,0,0,0,10,0,0,0)</span></span>. The <span class="calibre9"><span class="calibre30">genres</span></span> table describes the <span class="calibre9"><span class="calibre30">position</span></span> of each dimension in the vector. We can decrypt its genre values by extracting the <span class="calibre9"><span class="calibre30">cube_ur_coord(vector,dimension)</span></span> using each <span class="calibre9"><span class="calibre30">genres</span></span>.<span class="calibre9"><span class="calibre30">position</span></span>. For clarity, we filter out genres with scores of 0. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> name,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  cube_ur_coord(</span><span class="calibre9"><span class="italic"><span class="calibre38">'(0,7,0,0,0,0,0,0,0,7,0,0,0,0,10,0,0,0)'</span></span></span><span class="calibre9">, position) </span><span class="calibre9"><span class="bold"><span class="calibre44">as</span></span></span><span class="calibre9"> score​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> genres g​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> cube_ur_coord(</span><span class="calibre9"><span class="italic"><span class="calibre38">'(0,7,0,0,0,0,0,0,0,7,0,0,0,0,10,0,0,0)'</span></span></span><span class="calibre9">, position) &gt; 0;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​   name    | score​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-----------+-------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Adventure |     7​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Fantasy   |     7​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ SciFi     |    10​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We will find similar movies by finding the nearest points. To understand why this works, we can envision two movies on a two-dimensional genre graph, like the graph shown below.. If your favorite movie is <span class="italic">Animal House</span>, you’ll probably want to see <span class="italic">The 40 Year Old Virgin</span> more than <span class="italic">Oedipus</span>—a story distinctly lacking in comedy. In our two-dimensional universe, it’s a simple nearest-neighbor search to find likely matches. </p><p class="calibre12"><img src="images/00057.jpg" class="calibre65"/></p><a></a><p class="calibre22"> We can extrapolate this into more dimensions with more genres, be it 2, 3, or 18. The principle is the same: a nearest-neighbor match to the nearest points in genre space will yield the closest genre matches. </p><a></a><p class="calibre12"> The nearest matches to the genre vector can be discovered by the <span class="calibre9"><span class="calibre30">cube_distance(point1, point2)</span></span>. Here we can find the distance of all movies to the <span class="italic">Star Wars</span> genre vector, nearest first. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> *,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  cube_distance(genre, </span><span class="calibre9"><span class="italic"><span class="calibre38">'(0,7,0,0,0,0,0,0,0,7,0,0,0,0,10,0,0,0)'</span></span></span><span class="calibre9">) dist​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> movies​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">ORDER</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">BY</span></span></span><span class="calibre9"> dist;​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We created the <span class="calibre9"><span class="calibre30">movies_genres_cube</span></span> cube index earlier when we created the tables. However, even with an index, this query is still relatively slow, since it requires a full-table scan. It computes the distance on every row and then sorts them. </p><a></a><p class="calibre12"> Rather than compute the distance of every point, we can instead focus on likely points by way of a <span class="italic">bounding cube</span>. Just like finding the closest five towns on a map will be faster on a state map than a world map, bounding reduces the points we need to look at. </p><a></a><p class="calibre12"> We use <span class="calibre9"><span class="calibre30">cube_enlarge(cube,radius,dimensions)</span></span> to build an 18-dimensional cube that is some length (radius) wider than a point. </p><a></a><p class="calibre12"> Let’s view a simpler example. If we built a two-dimensional square one unit around a point (1,1), the lower-left point of the square would be at (0,0), and the upper-right point would be (2,2). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> cube_enlarge(</span><span class="calibre9"><span class="italic"><span class="calibre38">'(1,1)'</span></span></span><span class="calibre9">,1,2);​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ cube_enlarge​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​---------------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ (0, 0),(2, 2)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The same principle applies in any number of dimensions. With our bounding hypercube, we can use a special cube operator, <span class="calibre9"><span class="calibre30">@&gt;</span></span>, which means <span class="italic">contains</span>. This query finds the distance of all points contained within a five-unit cube of the <span class="italic">Star Wars</span> genre point. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> title, cube_distance(genre, </span><span class="calibre9"><span class="italic"><span class="calibre38">'(0,7,0,0,0,0,0,0,0,7,0,0,0,0,10,0,0,0)'</span></span></span><span class="calibre9">) dist​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> movies​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> cube_enlarge(</span><span class="calibre9"><span class="italic"><span class="calibre38">'(0,7,0,0,0,0,0,0,0,7,0,0,0,0,10,0,0,0)'</span></span></span><span class="calibre9">::cube, 5, 18) @&gt; genre​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">ORDER</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">BY</span></span></span><span class="calibre9"> dist;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​                     title                      |       dist​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​------------------------------------------------+------------------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Star Wars                                      |                0​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Star Wars: Episode V - The Empire Strikes Back |                2​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Avatar                                         |                5​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Explorers                                      | 5.74456264653803​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ Krull                                          | 6.48074069840786​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ E.T. The Extra-Terrestrial                     | 7.61577310586391​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Using a subselect, we can get the genre by movie name and perform our calculations against that genre using a table alias. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> m.movie_id, m.title​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> movies m, (</span><span class="calibre9"><span class="bold"><span class="calibre44">SELECT</span></span></span><span class="calibre9"> genre, title </span><span class="calibre9"><span class="bold"><span class="calibre44">FROM</span></span></span><span class="calibre9"> movies </span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> title = </span><span class="calibre9"><span class="italic"><span class="calibre38">'Mad Max'</span></span></span><span class="calibre9">) s​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">WHERE</span></span></span><span class="calibre9"> cube_enlarge(s.genre, 5, 18) @&gt; m.genre </span><span class="calibre9"><span class="bold"><span class="calibre44">AND</span></span></span><span class="calibre9"> s.title &lt;&gt; m.title​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">ORDER</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">BY</span></span></span><span class="calibre9"> cube_distance(m.genre, s.genre)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​LIMIT 10;​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ movie_id |           title​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​----------+----------------------------​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​     1405 | Cyborg​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​     1391 | Escape from L.A.​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​     1192 | Mad Max Beyond Thunderdome​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​     1189 | Universal Soldier​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​     1222 | Soldier​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​     1362 | Johnny Mnemonic​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      946 | Alive​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      418 | Escape from New York​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​     1877 | The Last Starfighter​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​     1445 | The Rocketeer​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This method of movie suggestion is not perfect, but it’s an excellent start. We will see more dimensional queries in later chapters, such as two-dimensional geographic searches in MongoDB (see <a href="#filepos1121267"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">GeoSpatial Queries</span></span><span class="calibre13"><span class="underline">​</span></span></a>). </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Day 3 Wrap-Up</span></span></span></p><a></a><p class="calibre29"> Today we jumped headlong into PostgreSQL’s flexibility at string searches and used the <span class="calibre9"><span class="calibre30">cube</span></span> package for multidimensional searching. Most importantly, we caught a glimpse of the nonstandard extensions that puts PostgreSQL at the top of the open source RDBMS field. There are dozens (if not hundreds) of more extensions at your disposal, from geographic storage to cryptographic functions, custom datatypes, and language extensions. Beyond the core power of SQL, contrib packages are what makes PostgreSQL shine. </p><p class="calibre12"><span class="bold"><span class="calibre28">Day 3 Homework</span></span></p><p class="calibre37"><span class="bold">Find</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Find online documentation of all contributed packages bundled into Postgres.</p></li><li value="2" class="calibre36"><p class="calibre22">Find online POSIX regex documentation (it will also be handy for future chapters).</p></li></ol><p class="calibre12"><span class="bold">Do</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Create a stored procedure where you can input a movie title or actor’s name you like, and it will return the top five suggestions based on either movies the actor has starred in or films with similar genres.</p></li><li value="2" class="calibre36"><p class="calibre22">Expand the movies database to track user comments and extract keywords (minus English stopwords). Cross-reference these keywords with actors’ last names, and try to find the most talked about actors.</p></li></ol><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos352192" class="calibre1"><p class="calibre24" id="filepos352197"><span class="calibre25"><span class="bold"><span class="calibre26">2.5 Wrap-Up</span></span></span></p><a></a><p class="calibre27"> If you haven’t spent much time with relational databases, we highly recommend digging deeper into PostgreSQL, or another relational database, before deciding to scrap it for a newer variety. Relational databases have been the focus of intense academic research and industrial improvements for more than forty years, and PostgreSQL is one of the top open source relational databases to benefit from these advancements. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">PostgreSQL’s Strengths</span></span></span></p><a></a><p class="calibre29"> PostgreSQL’s strengths are as numerous as any relational model: years of research and production use across nearly every field of computing, flexible queryability, and very consistent and durable data. Most programming languages have battle-tested driver support for Postgres, and many programming models, like object-relational mapping (<span class="bold"><span class="calibre39">ORM</span></span>), assume an underlying relational database. The crux of the matter is the flexibility of the join. You needn’t know how you plan to actually query your model, since you can always perform some joins, filters, views, and indexes—odds are good you will always have the ability to extract the data you want. </p><p class="calibre12"><img src="images/00029.jpg" class="calibre66"/></p><a></a><p class="calibre22"> PostgreSQL is fantastic for what we call “Stepford data” (named for <span class="italic">The Stepford Wives</span>, a story about a neighborhood where nearly everyone was consistent in style and substance), which is data that is fairly homogeneous and conforms well to a structured schema. </p><a></a><p class="calibre12"> Furthermore, PostgreSQL goes beyond the normal open source RDBMS offerings, such as powerful schema constraint mechanisms. You can write your own language extensions, customize indexes, create custom datatypes, and even overwrite the parsing of incoming queries. And where other open source databases may have complex licensing agreements, PostgreSQL is open source in its purest form. No one owns the code. Anyone can do pretty much anything they want with the project (other than hold authors liable). The development and distribution are completely community supported. If you are a fan of free(dom) software or have a long bushy beard, you have to respect their general resistance to cashing in on an amazing product. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">PostgreSQL’s Weaknesses</span></span></span></p><a></a><p class="calibre29"> Although relational databases are undeniably the most successful style of database over the years, there are cases where it may not be a great fit. </p><a></a><p class="calibre12"> Partitioning is not one of the strong suits of relational databases like PostgreSQL. If you need to scale out rather than up (multiple parallel datastores rather than a single beefy machine or cluster), you may be better served looking elsewhere. If your data requirements are too flexible to easily fit into the rigid schema requirements of a relational database or you don’t need the overhead of a full database, require very high-volume reads and writes as key values, or need to store only large blobs of data, then one of the other data-stores might be a better fit. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Parting Thoughts</span></span></span></p><a></a><p class="calibre29"> A relational database is an excellent choice for query flexibility. While PostgreSQL requires you to design your data up front, it makes no assumptions on how you use that data. As long as your schema is designed in a fairly normalized way, without duplication or storage of computable values, you should generally be all set for any queries you might need to create. And if you include the correct modules, tune your engine, and index well, it will perform amazingly well for multiple terabytes of data with very small resource consumption. Finally, to those for whom data safety is paramount, PostgreSQL’s ACID-compliant transactions ensure your commits are completely atomic, consistent, isolated, and durable. </p><p class="calibre23"><span class="calibre9"><span class="bold"><span class="calibre28">Footnotes</span></span></span></p><a id="filepos356660"></a><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos62235"><span class="calibre9"><span class="calibre13"><span class="underline">[3]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://www.postgresql.org/download/"><span class="calibre9"><span class="calibre13"><span class="underline">http://www.postgresql.org/download/</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos62235"><span class="calibre9"><span class="calibre13"><span class="underline">[4]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://www.postgresql.org/docs/9.0/static/contrib.html"><span class="calibre9"><span class="calibre13"><span class="underline">http://www.postgresql.org/docs/9.0/static/contrib.html</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos189169"><span class="calibre9"><span class="calibre13"><span class="underline">[5]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://www.postgresql.org/docs/9.0/static/plpgsql.html"><span class="calibre9"><span class="calibre13"><span class="underline">http://www.postgresql.org/docs/9.0/static/plpgsql.html</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos190236"><span class="calibre9"><span class="calibre13"><span class="underline">[6]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://www.postgresql.org/docs/9.0/static/app-createlang.html"><span class="calibre9"><span class="calibre13"><span class="underline">http://www.postgresql.org/docs/9.0/static/app-createlang.html</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos203061"><span class="calibre9"><span class="calibre13"><span class="underline">[7]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://www.postgresql.org/docs/9.0/static/triggers.html"><span class="calibre9"><span class="calibre13"><span class="underline">http://www.postgresql.org/docs/9.0/static/triggers.html</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos260134"><span class="calibre9"><span class="calibre13"><span class="underline">[8]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://lucene.apache.org/"><span class="calibre9"><span class="calibre13"><span class="underline">http://lucene.apache.org/</span></span></span></a><span class="calibre9">
</span></p></td></tr></table><p class="calibre17"><span class="calibre9"><span class="calibre18"><span class="calibre19">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos359256" class="calibre1"><p class="calibre21" id="filepos359261"><span class="calibre3"><span class="bold"><span class="calibre31"> Chapter 3</span></span></span></p><br class="calibre1"/><p class="calibre32"><span class="calibre3"><span class="bold"><span class="calibre4">Riak</span></span></span></p><a></a><p class="calibre12"> Anyone who has worked construction knows that rebar is a steel beam used to reinforce concrete. Just like Riak (“Ree-ahck”), you never use only one, but the multiple parts working together make the overall system durable. Each component is cheap and expendable, but when used right, it’s hard to find a simpler or stronger structure upon which to build a foundation. </p><a></a><p class="calibre12"> Riak is a distributed key-value database where values can be anything—from plain text, JSON, or XML to images or video clips—all accessible through a simple HTTP interface. Whatever data you have, Riak can store it. </p><a></a><p class="calibre12"> Riak is also fault-tolerant. Servers can go up or down at any moment with no single point of failure. Your cluster continues humming along as servers are added, removed, or (ideally not) crash. Riak won’t keep you up nights worrying about your cluster—a failed node is not an emergency, and you can wait to deal with it in the morning. As core developer Justin Sheehy once noted, “[The Riak team] focused so hard on things like write availability…to go back to sleep.” </p><a></a><p class="calibre12"> But this flexibility has some trade-offs. Riak lacks robust support for ad hoc queries, and key-value stores, by design, have trouble linking values together (in other words, they have no foreign keys). Riak attacks these problems on several fronts, which we’ll discover in the next few days. </p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos361053" class="calibre1"><p class="calibre24" id="filepos361058"><span class="calibre25"><span class="bold"><span class="calibre26">3.1 Riak Loves the Web</span></span></span></p><a></a><p class="calibre27"> Riak speaks <span class="italic">web</span> better than any other database we’ll see in this book (though CouchDB is a close second). You query via URLs, headers, and verbs, and Riak returns assets and standard HTTP response codes. </p><a></a><blockquote class="calibre40"><span class="calibre41"><span class="bold">Riak and cURL</span></span></blockquote><a></a><blockquote class="calibre42"><span class="calibre41"> Since the goal of this book is to investigate seven databases and their concepts, and not teach new programming languages, we try to avoid introducing new languages where possible. Riak supplies an HTTP REST interface, so we’re going to interact with it via the URL tool cURL. In production, you’ll almost always use a driver in your language of choice. Using cURL allows us to peek at the underlying API without resorting to a particular driver or programming language. </span></blockquote><p class="calibre43" id="filepos362110"> Riak is a great choice for datacenters like Amazon that must serve many requests with low latency. If every millisecond spent waiting is a potential customer loss, Riak is hard to beat. It’s easy to manage, easy to set up, and can grow with your needs. If you’ve ever used Amazon Web Services, like SimpleDB or S3, you may notice some similarities in form and function. This is no coincidence. Riak is inspired by Amazon’s Dynamo paper.<a href="#filepos611603"><span class="calibre13"><span class="underline">[9]</span></span></a>
</p><a></a><p class="calibre12"> In this chapter, we’ll investigate how Riak stores and retrieves values and how to tie data together using <span class="calibre9"><span class="calibre30">Link</span></span>s. Then we’ll explore a data-retrieval concept used heavily throughout this book: mapreduce. We’ll see how Riak clusters its servers and handles requests, even in the face of server failure. Finally, we’ll look at how Riak resolves conflict that arises from writing to distributed servers, and we’ll look at some extensions to the basic server. </p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos363242" class="calibre1"><p class="calibre24" id="filepos363247"><span class="calibre25"><span class="bold"><span class="calibre26">3.2 Day 1: CRUD, Links, and MIMEs</span></span></span></p><p class="calibre27" id="filepos363387"> You can download and install a build of Riak provided by Basho<a href="#filepos611603"><span class="calibre13"><span class="underline">[10]</span></span></a> (the company that funds its development), but we actually prefer to build this one since you get some preconfigured examples. If you really don’t want to build it, just install a prebuilt version, and then grab the source code and extract the example dev servers. Erlang<a href="#filepos611603"><span class="calibre13"><span class="underline">[11]</span></span></a> is also required to run Riak (R14B03 or greater). </p><a></a><p class="calibre12"> Building Riak from source requires three things: Erlang, the source code, and general Unix build tools like Make. Installing Erlang is easy enough (you’ll also need Erlang for CouchDB in Chapter 6, <a href="#filepos1144187"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">CouchDB</span></span><span class="calibre13"><span class="underline">​</span></span></a>), though it can take a while. We get the Riak source from its repository (link available via the Basho website—if you don’t have Git or Mercurial installed, you can download a zipped package). All of the examples in this chapter were run on version 1.0.2. </p><a></a><p class="calibre12"> The Riak creators played Santa Claus for us new users, slipping a cool toy into our stockings. In the same directory you built Riak, run this command: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">make devrel</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> When complete, we find three example servers. Just fire them up: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">dev/dev1/bin/riak start</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">dev/dev2/bin/riak start</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">dev/dev3/bin/riak start</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If you have a server fail to start because a port is in use, don’t panic. You can change the dev1, dev2, or dev3 port by opening the offending server’s <span class="calibre9"><span class="calibre30">etc/app.config</span></span> file and altering the line that looks like this to use another port: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{http, [ {"127.0.0.1", 8091 } ]}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We should now have three Erlang processes running named <span class="calibre9"><span class="calibre30">beam.smp</span></span>, representing individual Riak nodes (server instances), unaware of each other’s presence. To create a cluster, we need to join the nodes using each server’s <span class="calibre9"><span class="calibre30">riak-admin</span></span> command named <span class="calibre9"><span class="calibre30">join</span></span> and point them to any other cluster node. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">dev/dev2/bin/riak-admin join dev1@127.0.0.1</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> It doesn’t really matter which servers we point them at—in Riak, all nodes are equal. Now that dev1 and dev2 are in a cluster, we can point dev3 at either one. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">dev/dev3/bin/riak-admin join dev2@127.0.0.1</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Verify your servers are healthy by checking their stats in a web browser: <span class="calibre9"><span class="calibre30">http://localhost:8091/stats</span></span>. It may prompt you to download the file, which contains lots of information about the cluster. It should look something like this (edited for readability): </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "vnode_gets":0,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "vnode_puts":0,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "vnode_index_reads":0,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  ...​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "connected_nodes":[​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre38">"dev2@127.0.0.1"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre38">"dev3@127.0.0.1"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  ],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  ...​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "ring_members":[​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre38">"dev1@127.0.0.1"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre38">"dev2@127.0.0.1"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre38">"dev3@127.0.0.1"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  ],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "ring_num_partitions":64,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "ring_ownership":​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre38">"[{'dev3@127.0.0.1',21},{'dev2@127.0.0.1',21},{'dev1@127.0.0.1',22}]"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  ...​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We can see that all servers are equal participants in the ring by pinging the other servers for stats on ports 8092 (dev2) and 8093 (dev3). For now, we’ll stick with the stats from dev1. </p><a></a><p class="calibre12"> Look for the <span class="calibre9"><span class="italic"><span class="calibre38">ring_members</span></span></span> property—it should contain all our node names and will be the same for each server. Next, find the value for <span class="calibre9"><span class="italic"><span class="calibre38">connected_nodes</span></span></span>. This should be a list of the other servers in the ring. </p><a></a><p class="calibre12"> We can change the values reported by <span class="calibre9"><span class="italic"><span class="calibre38">connected_nodes</span></span></span> by stopping a node… </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">dev/dev2/bin/riak stop</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre12"> …and reloading the <span class="calibre9"><span class="calibre30">/stats</span></span>. Notice that <span class="calibre9"><span class="calibre30">dev2@127.0.0.1</span></span> is now gone from the <span class="calibre9"><span class="italic"><span class="calibre38">connected_nodes</span></span></span> list. Start <span class="calibre9"><span class="calibre30">dev2</span></span>, and it will rejoin itself to the <span class="italic">Riak ring</span> (we’ll discuss the ring on Day 2). </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">REST Is Best (or Doing cURLs)</span></span></span></p><a></a><p class="calibre29"><span class="bold"><span class="calibre39">REST</span></span> stands for REpresentational State Transfer. It sounds like a mouthful of jargon, but it has become the <span class="italic">de facto</span> architecture of web applications, so it’s worth knowing. REST is a guideline for mapping resources to <span class="bold"><span class="calibre39">URL</span></span>s and interacting with them using <span class="bold"><span class="calibre39">CRUD</span></span> verbs: <span class="calibre9"><span class="calibre30">POST</span></span> (Create), <span class="calibre9"><span class="calibre30">GET</span></span> (Read), <span class="calibre9"><span class="calibre30">PUT</span></span> (Update), and <span class="calibre9"><span class="calibre30">DELETE</span></span> (Delete). </p><a></a><p class="calibre12"> If you don’t already have it installed, install the <span class="bold"><span class="calibre39">HTTP</span></span> client program cURL. We use it as our REST interface, because it’s easy to specify verbs (like <span class="calibre9"><span class="calibre30">GET</span></span> and <span class="calibre9"><span class="calibre30">PUT</span></span>) and HTTP header information (like <span class="calibre9"><span class="calibre30">Content-Type</span></span>). With the <span class="calibre9"><span class="calibre30">curl</span></span> command, we speak directly to the Riak server’s HTTP REST interface without the need for an interactive console or, say, a Ruby driver. </p><a></a><p class="calibre12"> You can validate the <span class="calibre9"><span class="calibre30">curl</span></span> command works with Riak by pinging a node. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:8091/ping</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​OK​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Let’s issue a bad query. <span class="calibre9"><span class="calibre30">-I</span></span> tells cURL that we want only the header response. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -I http://localhost:8091/riak/no_bucket/no_key</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​HTTP/1.1 404 Object Not Found​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Server: MochiWeb/1.1 WebMachine/1.7.3 (participate in the frantic)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Date: Thu, 04 Aug 2011 01:25:49 GMT​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Type: text/plain​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Length: 10​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Since Riak leverages HTTP URLs and actions, it uses HTTP headers and error codes. The 404 response means the same as a 404 when you encounter a missing web page: nothing to see here. So, let’s <span class="calibre9"><span class="calibre30">PUT</span></span> something in Riak. </p><a></a><p class="calibre12"> The <span class="calibre9"><span class="calibre30">-X PUT</span></span> parameter tells cURL that we want to perform an HTTP <span class="calibre9"><span class="calibre30">PUT</span></span> action to store and retrieve on an explicit key. The <span class="calibre9"><span class="calibre30">-H</span></span> attribute sets the following text as HTTP header information. In this case, we set the MIME content type to HTML. Everything passed to <span class="calibre9"><span class="calibre30">-d</span></span> (also known as the body data) is what Riak will add as a new value. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -v -X PUT http://localhost:8091/riak/favs/db \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -H "Content-Type: text/html" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -d "&lt;html&gt;&lt;body&gt;&lt;h1&gt;My new favorite DB is RIAK&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If you navigate to <span class="calibre9"><span class="calibre30">http://localhost:8091/riak/favs/db</span></span> in a browser, you’ll get a nice message from yourself. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">PUT the Value in the Bucket</span></span></span></p><a></a><p class="calibre29"> Riak is a key-value store, so it expects you to pass in a key to retrieve a value. Riak breaks up classes of keys into <span class="italic">buckets</span> to avoid key collisions—for example, a key for <span class="calibre9"><span class="calibre30">java</span></span> the <span class="italic">language</span> will not collide with <span class="calibre9"><span class="calibre30">java</span></span> the <span class="italic">drink</span>. </p><a></a><p class="calibre12"> We’re going to create a system to keep track of animals in a dog hotel. We’ll start by creating a bucket of <span class="calibre9"><span class="calibre30">animals</span></span> that contain each furry guest’s details. The URL follows this pattern: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​http://SERVER:PORT/riak/BUCKET/KEY​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> A straightforward way of populating a Riak bucket is to know your key in advance. We’ll first add <span class="calibre9"><span class="italic"><span class="calibre38">Ace, The Wonder Dog</span></span></span> and give him the key <span class="calibre9"><span class="calibre30">ace</span></span> with the value <span class="calibre9"><span class="calibre30">{"nickname" : "The Wonder Dog", "breed" : "German Shepherd"}</span></span>. You don’t need to explicitly create a bucket—putting a first value into a bucket name will create that bucket. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -v -X PUT http://localhost:8091/riak/animals/ace \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -H "Content-Type: application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -d '{"nickname" : "The Wonder Dog", "breed" : "German Shepherd"}'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Putting a new value returns a 204 code. The <span class="calibre9"><span class="calibre30">-v</span></span> (verbose) attribute in the <span class="calibre9"><span class="calibre30">curl</span></span> command outputs this header line. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&lt; HTTP/1.1 204 No Content​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We can view our list of buckets that have been created. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -X GET http://localhost:8091/riak?buckets=true</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"buckets":["favs","animals"]}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Optionally, you can return the set results with the <span class="calibre9"><span class="calibre30">?returnbody=true</span></span> parameter, which we’ll test by adding another animal, Polly: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -v -X PUT http://localhost:8091/riak/animals/polly?returnbody=true \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -H "Content-Type: application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -d '{"nickname" : "Sweet Polly Purebred", "breed" : "Purebred"}'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This time you’ll see a 200 code. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&lt; HTTP/1.1 200 OK​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If we aren’t picky about our key name, Riak will generate one when using <span class="calibre9"><span class="calibre30">POST</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -i -X POST http://localhost:8091/riak/animals \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -H "Content-Type: application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -d '{"nickname" : "Sergeant Stubby", "breed" : "Terrier"}'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The generated key will be in the header under Location—also note the 201 success code in the header. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​HTTP/1.1 201 Created​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Vary: Accept-Encoding​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Server: MochiWeb/1.1 WebMachine/1.7.3 (participate in the frantic)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Location: /riak/animals/6VZc2o7zKxq2B34kJrm1S0ma3PO​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Date: Tue, 05 Apr 2011 07:45:33 GMT​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Type: application/json​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Length: 0​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> A <span class="calibre9"><span class="calibre30">GET</span></span> request (cURL’s default if left unspecified) to that location will retrieve the value. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:8091/riak/animals/6VZc2o7zKxq2B34kJrm1S0ma3PO</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"><span class="calibre9"><span class="calibre30">DELETE</span></span> will remove it. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -i -X DELETE http://localhost:8091/riak/animals/6VZc2o7zKxq2B34kJrm1S0ma3PO</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​HTTP/1.1 204 No Content​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Vary: Accept-Encoding​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Server: MochiWeb/1.1 WebMachine/1.7.3 (participate in the frantic)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Date: Mon, 11 Apr 2011 05:08:39 GMT​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Type: application/x-www-form-urlencoded​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Length: 0​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> DELETE won’t return any body, but the HTTP code will be 204 if successful. Otherwise, as you’d expect, it returns a 404. </p><a></a><p class="calibre12"> If we’ve forgotten any of our keys in a bucket, we can get them all with <span class="calibre9"><span class="calibre30">keys=true</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:8091/riak/animals?keys=true</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You can also get them as a stream with <span class="calibre9"><span class="calibre30">keys=stream</span></span>, which can be a safer choice for huge datasets—it just keeps sending chunks of keys array objects and ends with an empty array. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Links</span></span></span></p><a></a><p class="calibre29"><span class="calibre9"><span class="calibre30">Link</span></span>s are metadata that associate one key to other keys. The basic structure is this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Link: &lt;/riak/bucket/key&gt;; riaktag=\"whatever\"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The key to where this value links is in pointy brackets (&lt;…&gt;), followed by a semicolon and then a tag describing how the link relates to this value (it can be whatever string we like). </p><p class="calibre12"><span class="bold"><span class="calibre28">Link Walking</span></span></p><a></a><p class="calibre37"> Our little dog hotel has quite a few (large, comfortable, and humane) cages. To keep track of which animal is in what cage, we’ll use a link. Cage 1 <span class="calibre9"><span class="calibre30">contains</span></span> Polly by linking to her key (this also creates a new bucket named <span class="calibre9"><span class="calibre30">cages</span></span>). The cage is installed in room 101, so we set that value as JSON data. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -X PUT http://localhost:8091/riak/cages/1 \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -H "Content-Type: application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -H "Link: &lt;/riak/animals/polly&gt;; riaktag=\"contains\"" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -d '{"room" : 101}'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Note that this link relationship is one-directional. In effect, the cage we’ve just created knows that Polly is inside it, but no changes have been made to Polly. We can confirm this by pulling up Polly’s data and checking that there have been no changes to the <span class="calibre9"><span class="calibre30">Link</span></span> headers. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -i http://localhost:8091/riak/animals/polly</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​HTTP/1.1 200 OK​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​X-Riak-Vclock: a85hYGBgzGDKBVIcypz/fvrde/U5gymRMY+VwZw35gRfFgA=​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Vary: Accept-Encoding​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Server: MochiWeb/1.1 WebMachine/1.9.0 (participate in the frantic)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Link: &lt;/riak/animals&gt;; rel="up"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Last-Modified: Tue, 13 Dec 2011 17:53:59 GMT​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ETag: "VD0ZAfOTsIHsgG5PM3YZW"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Date: Tue, 13 Dec 2011 17:54:51 GMT​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Type: application/json​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Length: 59​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"nickname" : "Sweet Polly Purebred", "breed" : "Purebred"}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You can have as many metadata <span class="calibre9"><span class="calibre30">Link</span></span>s as necessary, separated by commas. We’ll put Ace in cage 2 and also point to cage 1 tagged with <span class="calibre9"><span class="italic"><span class="calibre38">next_to</span></span></span> so we know that it’s nearby. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -X PUT http://localhost:8091/riak/cages/2 \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">-H "Content-Type: application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">-H "Link:&lt;/riak/animals/ace&gt;;riaktag=\"contains\",</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  &lt;/riak/cages/1&gt;;riaktag=\"next_to\"" \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-d '{"room" : 101}'​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> What makes <span class="calibre9"><span class="calibre30">Link</span></span>s special in Riak is <span class="italic">link walking</span> (and a more powerful variant, linked mapreduce queries, which we investigate tomorrow). Getting the linked data is achieved by appending a <span class="italic">link spec</span> to the URL that is structured like this: <span class="calibre9"><span class="calibre30">/_,_,_</span></span>. The underscores (_) in the URL represent wildcards to each of the link criteria: bucket, tag, keep. We’ll explain those terms shortly. First let’s retrieve all links from cage 1. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:8091/riak/cages/1/_,_,_</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​--4PYi9DW8iJK5aCvQQrrP7mh7jZs​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Type: multipart/mixed; boundary=Av1fawIA4WjypRlz5gHJtrRqklD​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​--Av1fawIA4WjypRlz5gHJtrRqklD​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​X-Riak-Vclock: a85hYGBgzGDKBVIcypz/fvrde/U5gymRMY+VwZw35gRfFgA=​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Location: /riak/animals/polly​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Type: application/json​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Link: &lt;/riak/animals&gt;; rel="up"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Etag: VD0ZAfOTsIHsgG5PM3YZW​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Last-Modified: Tue, 13 Dec 2011 17:53:59 GMT​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"nickname" : "Sweet Polly Purebred", "breed" : "Purebred"}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​--Av1fawIA4WjypRlz5gHJtrRqklD--​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​--4PYi9DW8iJK5aCvQQrrP7mh7jZs--​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> It returns a <span class="calibre9"><span class="calibre30">multipart/mixed</span></span> dump of headers plus bodies of all linked keys/values. It’s also a headache to look at. Tomorrow we’ll find a more powerful way to get link-walked data that also happens to return nicer values—but today we’ll dig a bit more into this syntax. </p><a></a><p class="calibre12"> If you’re not familiar with reading the <span class="calibre9"><span class="calibre30">multipart/mixed</span></span> MIME type, the <span class="calibre9"><span class="calibre30">Content-Type</span></span> definition describes a boundary string, which denotes the beginning and end of some HTTP header and body data. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​--BcOdSWMLuhkisryp0GidDLqeA64​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​some HTTP header and body data​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​--BcOdSWMLuhkisryp0GidDLqeA64--​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> In our case, the data is what cage 1 links to: Polly Purebred. You may have noticed that the headers returned don’t actually display the link information. This is OK; that data is still stored under the linked-to key. </p><a></a><p class="calibre12"> When link walking, we can replace the underscores in the link spec to filter only values we want. Cage 2 has two links, so performing a link spec request will return both the animal Ace contained in the cage and the cage 1 <span class="calibre9"><span class="calibre30">next_to</span></span> it. To specify only following the <span class="calibre9"><span class="calibre30">animals</span></span> bucket, replace the first underscore with the bucket name. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:8091/riak/cages/2/animals,_,_</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Or follow the cages <span class="italic">next to</span> this one by populating the <span class="calibre9"><span class="calibre30">tag</span></span> criteria. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:8091/riak/cages/2/_,next_to,_</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The final underscore—<span class="calibre9"><span class="calibre30">keep</span></span>—accepts a 1 or 0. <span class="calibre9"><span class="calibre30">keep</span></span> is useful when following second-order links, or links following other links, which you can do by just appending another link spec. Let’s follow the keys <span class="calibre9"><span class="calibre30">next_to</span></span> cage 2, which will return cage 1. Next, we walk to the animals linked to cage 1. Since we set <span class="calibre9"><span class="calibre30">keep</span></span> to 0, Riak will not return the intermediate step (the cage 1 data). It will return only Polly’s information, who is next to Ace’s cage. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:8091/riak/cages/2/_,next_to,0/animals,_,_</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​--6mBdsboQ8kTT6MlUHg0rgvbLhzd​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Type: multipart/mixed; boundary=EZYdVz9Ox4xzR4jx1I2ugUFFiZh​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​--EZYdVz9Ox4xzR4jx1I2ugUFFiZh​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​X-Riak-Vclock: a85hYGBgzGDKBVIcypz/fvrde/U5gymRMY+VwZw35gRfFgA=​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Location: /riak/animals/polly​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Type: application/json​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Link: &lt;/riak/animals&gt;; rel="up"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Etag: VD0ZAfOTsIHsgG5PM3YZW​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Last-Modified: Tue, 13 Dec 2011 17:53:59 GMT​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"nickname" : "Sweet Polly Purebred", "breed" : "Purebred"}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​--EZYdVz9Ox4xzR4jx1I2ugUFFiZh--​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​--6mBdsboQ8kTT6MlUHg0rgvbLhzd--​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If we want Polly’s information and cage 1, set <span class="calibre9"><span class="calibre30">keep</span></span> to 1. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:8091/riak/cages/2/_,next_to,1/_,_,_</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​--PDVOEl7Rh1AP90jGln1mhz7x8r9​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Type: multipart/mixed; boundary=YliPQ9LPNEoAnDeAMiRkAjCbmed​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​--YliPQ9LPNEoAnDeAMiRkAjCbmed​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​X-Riak-Vclock: a85hYGBgzGDKBVIcypz/fvrde/U5gymRKY+VIYo35gRfFgA=​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Location: /riak/cages/1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Type: application/json​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Link: &lt;/riak/animals/polly&gt;; riaktag="contains", &lt;/riak/cages&gt;; rel="up"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Etag: 6LYhRnMRrGIqsTmpE55PaU​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Last-Modified: Tue, 13 Dec 2011 17:54:34 GMT​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"room" : 101}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​--YliPQ9LPNEoAnDeAMiRkAjCbmed--​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​--PDVOEl7Rh1AP90jGln1mhz7x8r9​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Type: multipart/mixed; boundary=GS9J6KQLsI8zzMxJluDITfwiUKA​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​--GS9J6KQLsI8zzMxJluDITfwiUKA​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​X-Riak-Vclock: a85hYGBgzGDKBVIcypz/fvrde/U5gymRMY+VwZw35gRfFgA=​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Location: /riak/animals/polly​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Type: application/json​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Link: &lt;/riak/animals&gt;; rel="up"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Etag: VD0ZAfOTsIHsgG5PM3YZW​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Last-Modified: Tue, 13 Dec 2011 17:53:59 GMT​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"nickname" : "Sweet Polly Purebred", "breed" : "Purebred"}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​--GS9J6KQLsI8zzMxJluDITfwiUKA--​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​--PDVOEl7Rh1AP90jGln1mhz7x8r9--​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This returns the objects in the path to the final result. In other words, <span class="italic">keep</span> the step. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Beyond Links</span></span></p><a></a><p class="calibre37"> Along with <span class="calibre9"><span class="calibre30">Link</span></span>s, you can store arbitrary metadata by using the <span class="calibre9"><span class="calibre30">X-Riak-Meta-</span></span> header prefix. If we wanted to keep track of the color of a cage but it wasn’t necessarily important in the day-to-day cage-managing tasks at hand, we could mark cage 1 as having the color pink. Getting the URL’s header (the -I flag) will return your metadata name and value. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -X PUT http://localhost:8091/riak/cages/1 \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -H "Content-Type: application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -H "X-Riak-Meta-Color: Pink" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -H "Link: &lt;/riak/animals/polly&gt;; riaktag=\"contains\"" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -d '{"room" : 101}'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">MIME Types in Riak</span></span></span></p><a></a><p class="calibre29"> Riak stores everything as a binary-encoded value, just like normal HTTP. The MIME type gives the binary data context—we’ve been dealing only with plain text up until now. MIME types are stored on the Riak server but are really just a flag to the client so that when it downloads the binary data, it knows how to render it. </p><a></a><p class="calibre12"> We’d like our dog hotel to keep images of our guests. We need only use the <span class="calibre9"><span class="calibre30">data-binary</span></span> flag on the <span class="calibre9"><span class="calibre30">curl</span></span> command to upload an image to the server and specify the MIME type as <span class="calibre9"><span class="calibre30">image/jpeg</span></span>. We’ll add a link back to the <span class="calibre9"><span class="calibre30">/animals/polly</span></span> key so we know who we are looking at. </p><a></a><p class="calibre12"> First, create an image called <span class="calibre9"><span class="calibre30">polly_image.jpg</span></span> and place it in the same directory you’ve been using to issue the <span class="calibre9"><span class="calibre30">curl</span></span> commands. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -X PUT http://localhost:8091/riak/photos/polly.jpg \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -H "Content-type: image/jpeg" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -H "Link: &lt;/riak/animals/polly&gt;; riaktag=\"photo\"" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  --data-binary @polly_image.jpg</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Now visit the URL in a web browser, which will be delivered and rendered exactly as you’d expect any web client-server request to function. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​http://localhost:8091/riak/photos/polly.jpg​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Since we pointed the image to <span class="calibre9"><span class="calibre30">/animals/polly</span></span>, we could link walk from the image key <span class="italic">to</span> Polly but not vice versa. Unlike a relational database, there is no “has a” or “is a” rule concerning links. You link the direction you need to walk. If we believe our use case will require accessing image data from the <span class="calibre9"><span class="calibre30">animals</span></span> bucket, a link should exist on that object instead (or in addition). </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Day 1 Wrap-Up</span></span></span></p><a></a><p class="calibre29"> We hope you’re seeing a glimmer of Riak’s potential as a flexible storage option. So far, we’ve covered only standard key-value practice with some links thrown in. When designing a Riak schema, think somewhere in between a caching system and PostgreSQL. You will break up your data into different logical classifications (buckets), and values can tacitly relate to each other. But you will not go so far as to normalize into fine components like you would in a relational database, since Riak performs no sense of relational joins to recompose values. </p><p class="calibre12"><span class="bold"><span class="calibre28">Day 1 Homework</span></span></p><p class="calibre37"><span class="bold">Find</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Bookmark the online Riak project documentation and discover the REST API documentation.</p></li><li value="2" class="calibre36"><p class="calibre22">Find a good list of browser-supported MIME types.</p></li><li value="3" class="calibre36"><p class="calibre22">Read the example Riak config <span class="calibre9"><span class="calibre30">dev/dev1/etc/app.config</span></span>, and compare it to the other dev configurations.</p></li></ol><p class="calibre12"><span class="bold">Do</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Using <span class="calibre9"><span class="calibre30">PUT</span></span>, update <span class="calibre9"><span class="calibre30">animals/polly</span></span> to have a Link pointing to <span class="calibre9"><span class="calibre30">photos/polly.jpg</span></span>.</p></li><li value="2" class="calibre36"><p class="calibre22"><span class="calibre9"><span class="calibre30">POST</span></span> a file of a MIME type we haven’t tried (such as <span class="calibre9"><span class="calibre30">application/pdf</span></span>), find the generated key, and hit that URL from a web browser.</p></li><li value="3" class="calibre36"><p class="calibre22">Create a new bucket type called <span class="calibre9"><span class="italic"><span class="calibre38">medicines</span></span></span>, <span class="calibre9"><span class="calibre30">PUT</span></span> a JPEG image value (with the proper MIME type) keyed as <span class="calibre9"><span class="italic"><span class="calibre38">antibiotics</span></span></span>, and link to the animal Ace (poor, sick puppy).</p></li></ol><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos436188" class="calibre1"><p class="calibre24" id="filepos436193"><span class="calibre25"><span class="bold"><span class="calibre26">3.3 Day 2: Mapreduce and Server Clusters</span></span></span></p><a></a><p class="calibre27"> Today we’ll dive into the mapreduce framework to perform more powerful queries than the standard key-value paradigm can normally provide. We’ll then expand on this power by including link walking with mapreduce. Finally, we will investigate the server architecture of Riak and how it uses a novel server layout to provide flexibility in consistency or availability, even in the face of network partitions. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Population Script</span></span></span></p><a></a><p class="calibre29"> We’ll need a bit more data in this section. To achieve that, we’ll switch to an example using a different kind of hotel, one for people and not pets. A quick populator script in Ruby will create data for a gigantic 10,000-room hotel. </p><p class="calibre12" id="filepos437173"> If you are not familiar with Ruby, it is a popular general-purpose programming language. It’s quite useful for writing quick scripts in a straightforward and readable manner. You can learn more about Ruby in <span class="italic">Programming Ruby: The Pragmatic Programmer’s Guide</span> [TH01] by Dave Thomas and Andy Hunt, as well as online.<a href="#filepos611603"><span class="calibre13"><span class="underline">[12]</span></span></a>
</p><p class="calibre12" id="filepos437603"> You’ll also need Ruby’s package manager called RubyGems.<a href="#filepos611603"><span class="calibre13"><span class="underline">[13]</span></span></a> With Ruby and RubyGems installed, next install the Riak driver.<a href="#filepos611603"><span class="calibre13"><span class="underline">[14]</span></span></a> You may also require the json driver and can run both to make sure. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">gem install riak-client json</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Each room in our hotel will have a random capacity from one to eight people and be of a random style such as a single room or a suite. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/riak/hotel.rb"><span class="calibre41"><span class="calibre13"><span class="underline">riak/hotel.rb</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre46"># generate loads and loads of rooms with random styles and capacities</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​require </span><span class="calibre9"><span class="italic"><span class="calibre38">'rubygems'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​require </span><span class="calibre9"><span class="italic"><span class="calibre38">'riak'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​STYLES = </span><span class="calibre9"><span class="italic"><span class="calibre38">%w{single double queen king suite}</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​client = Riak::Client.new(:http_port =&gt; 8091)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​bucket = client.bucket(</span><span class="calibre9"><span class="italic"><span class="calibre38">'rooms'</span></span></span><span class="calibre9">)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre46"># Create 100 floors to the building</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">for</span></span></span><span class="calibre9"> floor </span><span class="calibre9"><span class="bold"><span class="calibre44">in</span></span></span><span class="calibre9"> 1..100​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  current_rooms_block = floor * 100​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  puts </span><span class="calibre9"><span class="italic"><span class="calibre38">"Making rooms </span></span></span><span class="calibre9">#{current_rooms_block}</span><span class="calibre9"><span class="italic"><span class="calibre38"> - </span></span></span><span class="calibre9">#{current_rooms_block + 100}</span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="italic"><span class="calibre46"># Put 100 rooms on each floor (huge hotel!)</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">for</span></span></span><span class="calibre9"> room </span><span class="calibre9"><span class="bold"><span class="calibre44">in</span></span></span><span class="calibre9"> 1...100​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre46"># Create a unique room number as the key</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    ro = Riak::RObject.new(bucket, (current_rooms_block + room))​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre46"># Randomly grab a room style, and make up a capacity</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    style = STYLES[rand(STYLES.length)]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    capacity = rand(8) + 1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre46"># Store the room information as a JSON value</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    ro.content_type = </span><span class="calibre9"><span class="italic"><span class="calibre38">"application/json"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    ro.data = {</span><span class="calibre9"><span class="italic"><span class="calibre38">'style'</span></span></span><span class="calibre9"> =&gt; style, </span><span class="calibre9"><span class="italic"><span class="calibre38">'capacity'</span></span></span><span class="calibre9"> =&gt; capacity}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    ro.store​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">ruby hotel.rb</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We’ve now populated a human hotel we’ll mapreduce against. </p><p class="calibre12" id="filepos447830"><span class="calibre5"><span class="bold"><span class="calibre28">Introducing Mapreduce</span></span></span></p><p class="calibre29" id="filepos447945"> One of Google’s greatest lasting contributions to computer science is the popularization of mapreduce as an algorithmic framework for executing jobs in parallel over several nodes. It is described in Google’s seminal paper<a href="#filepos611603"><span class="calibre13"><span class="underline">[15]</span></span></a> on the topic and has become a valuable tool for executing custom queries in the class of partition-tolerant datastores. </p><a></a><p class="calibre12"> Mapreduce breaks down problems into two parts. Part 1 is to convert a list of data into another type of list by way of a <span class="calibre9"><span class="calibre30">map</span></span> function. Part 2 is to convert this second list to one or more scalar values by way of a <span class="calibre9"><span class="calibre30">reduce</span></span> function. Following this pattern allows a system to divide tasks into smaller components and run them across a massive cluster of servers in parallel. We could count up all Riak values containing <span class="calibre9"><span class="calibre30">{country : ’CA’}</span></span> by mapping each matching document to <span class="calibre9"><span class="calibre30">{count : 1}</span></span> and reducing the sum of all of these counts. </p><a></a><p class="calibre12"> If there were 5,012 Canadian values in our dataset, the reduce result would be <span class="calibre9"><span class="calibre30">{count : 5012}</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​map = function(v) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  var parsedData = JSON.parse(v.values[0].data);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  if(parsedData.country === 'CA')​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    return [{count : 1}];​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  else​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    return [{count : 0}];​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​reduce = function(mappedVals) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  var sums = {count : 0};​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  for (var i in mappedVals) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    sums[count] += mappedVals[i][count];​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  return [sums];​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> In one way, mapreduce is the opposite of how we normally run queries. A Ruby on Rails system might grab data like this (via its ActiveRecord interface): </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre46"># Construct a Hash to store room capacity count keyed by room style</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​capacity_by_style = {}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​rooms = Room.all​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">for</span></span></span><span class="calibre9"> room </span><span class="calibre9"><span class="bold"><span class="calibre44">in</span></span></span><span class="calibre9"> rooms​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  total_count = capacity_by_style[room.style]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  capacity_by_style[room.style] = total_count.to_i + room.capacity​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"><span class="calibre9"><span class="calibre30">Room.all</span></span> runs an SQL query against the backing database similar to this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​SELECT * FROM rooms;​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The database sends all of the results to the app server, and the app server code performs some action on that data. In this case, we’re looping through each room in the hotel and then counting the total capacity for each room style (for example, the capacity of all the suites in the hotel may be 448 guests). This is acceptable for small datasets. But as room count grows, the system slows as the database continues to stream each room’s data to the application. </p><a></a><p class="calibre12"> Mapreduce runs in an inverse manner. Rather than grabbing data from the database and running it on a client (or app server), mapreduce is a pattern to pass an algorithm to all of the database nodes, which are then each responsible for returning a result. <span class="italic">Each object on the server is “mapped” to some common key that groups the data together, and then all matching keys are “reduced” into some single value.</span>
</p><a id="filepos457270"></a><blockquote class="calibre10"><img src="images/00002.jpg" class="calibre67"/></blockquote><a></a><blockquote class="calibre68">The map function outputs feed into the reduce outputs and then to other reducers.</blockquote><hr class="calibre51"/><blockquote class="calibre10"><span class="bold">Figure 7. The map function outputs </span></blockquote><a></a><p class="calibre12"> For Riak, that means the database servers are responsible for mapping and reducing the values on each node. Those reduced values are passed around, where some other server (usually the requesting server) reduces those values further, until a final result is passed to the requesting client (or Rails application server, as the case may be). </p><a></a><p class="calibre12"> This simple reversal is a powerful way to allow complex algorithms to run locally on each server and return a very small result to the calling client. <span class="italic">It’s faster to send the algorithm to the data and then send the data to the algorithm.</span> In Figure 7, <a href="#filepos457270"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">The map function outputs</span></span><span class="calibre13"><span class="underline">​</span></span></a>, we can see how a bucket of phone bills keyed by phone number may calculate the total charged against all numbers across three servers, where each server contains all numbers with a similar prefix. </p><a></a><p class="calibre12"> The results of map functions will populate reduce functions; however, a combination of the results of map <span class="italic">and</span> previous reduce function calls populate successive reduce functions. We’ll revisit this idea in later chapters because it’s an important yet subtle component to the art of writing effective mapreduce queries. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Mapreduce in Riak</span></span></span></p><a></a><p class="calibre29"> Let’s create mapreduce functions for our Riak dataset that work like the previous hotel capacity counter. A neat feature of Riak’s mapreduce is that you can run the <span class="calibre9"><span class="calibre30">map</span></span> function alone and see what all the results are mid-run (assuming you even want to run a reduce). Let’s take it slow and look at the results for rooms 101, 102, and 103 only. </p><a></a><p class="calibre12"> The map setting needs the language we’re using and the source code; only then do we actually write the JavaScript map function (the function is just a string, so we always need to escape any characters accordingly). </p><a></a><p class="calibre12"> Using the @- command in cURL keeps the console’s standard input open until receiving <span class="calibre69"><span class="calibre30">Ctrl</span></span>+<span class="calibre69"><span class="calibre30">D</span></span>. This data will populate the HTTP body sent to the URL, which we post to the <span class="calibre9"><span class="calibre30">/mapred</span></span> command (look carefully—the URL is <span class="calibre9"><span class="calibre30">/mapred</span></span>, not <span class="calibre9"><span class="calibre30">/riak/mapred</span></span>). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -X POST -H "content-type:application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">http://localhost:8091/mapred --data @-</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "inputs":[​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    ["rooms","101"],["rooms","102"],["rooms","103"]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  ],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "query":[​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    {"map":{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "language":"javascript",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "source":​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "function(v) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​          /* From the Riak object, pull data and parse it as JSON */​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​          var parsed_data = JSON.parse(v.values[0].data);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​          var data = {};​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​          /* Key capacity number by room style string */​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​          data[parsed_data.style]</span><span class="calibre9"><span class="bold"><span class="calibre44"> = parsed_data.capacity;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​          return [data];​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        }"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  ]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"><span class="calibre69"><span class="calibre30">Ctrl</span></span>-<span class="calibre69"><span class="calibre30">D</span></span>
</p><a></a><p class="calibre12"> The <span class="calibre9"><span class="calibre30">/mapred</span></span> command expects valid JSON, and here we specified the form of our mapreduce commands. We choose the three rooms we want by setting the “inputs” value to be an array containing <span class="calibre9"><span class="calibre30">[bucket, key]</span></span> pairs. But the real meat of the settings is under the <span class="calibre9"><span class="italic"><span class="calibre38">query</span></span></span> value, which accepts an array of JSON objects containing objects, keyed by <span class="calibre9"><span class="italic"><span class="calibre38">map</span></span></span>, <span class="calibre9"><span class="italic"><span class="calibre38">reduce</span></span></span>, and/or <span class="calibre9"><span class="italic"><span class="calibre38">links</span></span></span> (more on links later). </p><a></a><p class="calibre12"> All this does is dig down into the data (<span class="calibre9"><span class="calibre30">v.values[0].data</span></span>), parse the value as a JSON object (<span class="calibre9"><span class="calibre30">JSON.parse(...)</span></span>), and return the capacity (<span class="calibre9"><span class="calibre30">parsed_data.capacity</span></span>) keyed by room style (<span class="calibre9"><span class="calibre30">parsed_data.style</span></span>). You’ll get a result like this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[{"suite":6},{"single":1},{"double":1}]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> It’s just the three objects’ JSON data from rooms 101, 102, and 103. </p><a></a><p class="calibre12"> We didn’t need to simply output the data as JSON. We could have converted the value of each key value into anything we wanted. We dug into the body data only but could have retrieved metadata, link information, the key, or data. Anything is possible after that—we are mapping each key value into some other value. </p><a></a><p class="calibre12"> If you feel up to it, you can return the maps of all 10,000 rooms by replacing the input-specific [bucket, key] arrays with the <span class="calibre9"><span class="calibre30">rooms</span></span> bucket name, like this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​"inputs":"rooms"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Fair warning: it will dump a lot of data. Finally, it’s worth mentioning that since Riak version 1.0, mapreduce functions are handled by a subsystem called Riak Pipe. Any older systems will use the legacy mapred_system. This should not affect you much as an end user, but it’s certainly a boost in speed and stability. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Stored Functions</span></span></p><a></a><p class="calibre37"> Another option Riak provides us with is to store the map function in a bucket value. This is another example of moving the algorithm to the database. This is a stored procedure or, more specifically, a user-defined function—of similar philosophy to those used in relational databases for years. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -X PUT -H "content-type:application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">http://localhost:8091/riak/my_functions/map_capacity --data @-</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​function(v) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  var parsed_data = JSON.parse(v.values[0].data);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  var data = {};​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  data[parsed_data.style]</span><span class="calibre9"><span class="bold"><span class="calibre44"> = parsed_data.capacity;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  return [data];​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> With your function safely stored, we’ll run the function by pointing to the new bucket and key containing the function. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -X POST -H "content-type:application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">http://localhost:8091/mapred --data @-</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "inputs":[​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    ["rooms","101"],["rooms","102"],["rooms","103"]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  ],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "query":[​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    {"map":{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "language":"javascript",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "bucket":"my_functions",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "key":"map_capacity"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  ]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You should receive the same results you received by putting the JavaScript source inline. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Built-in Functions</span></span></p><a></a><p class="calibre37"> You can use some of Riak’s built-in functions attached to the JavaScript object <span class="calibre9"><span class="calibre30">Riak</span></span>. If you run the following code, your room objects will map the values into JSON and return them. The <span class="calibre9"><span class="calibre30">Riak.mapValuesJson</span></span> function returns values as JSON. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​curl -X POST http://localhost:8091/mapred \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-H "content-type:application/json" --data @-​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "inputs":[​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    ["rooms","101"],["rooms","102"],["rooms","103"]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  ],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "query":[​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    {"map":{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "language":"javascript",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "name":"Riak.mapValuesJson"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  ]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Riak provides more of these in a file named <span class="calibre9"><span class="calibre30">mapred_builtins.js</span></span>, which you can find online (or, deep in the code). You can also use this syntax to call your own built-in functions, which is something we’ll investigate tomorrow. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Reducing</span></span></p><a></a><p class="calibre37"> Mapping is useful, but you’re limited to converting individual values into other individual values. Performing some sort of analysis over that set of data, even something as simple as counting the records, requires another step. This is where reduce comes into play. </p><a></a><p class="calibre12"> The SQL/Ruby example that we looked at earlier (in <a href="#filepos447830"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Introducing Mapreduce</span></span><span class="calibre13"><span class="underline">​</span></span></a>) showed how each value could be iterated over and how capacity was totaled for each style of room. We will perform this in our <span class="calibre9"><span class="calibre30">reduce</span></span> function in JavaScript. </p><a></a><p class="calibre12"> Most of the command we pass to <span class="calibre9"><span class="calibre30">/mapred</span></span> will be the same. This time, we add the <span class="calibre9"><span class="calibre30">reduce</span></span> function. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -X POST -H "content-type:application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">http://localhost:8091/mapred --data @-</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "inputs":"rooms",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "query":[​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    {"map":{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "language":"javascript",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "bucket":"my_functions",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "key":"map_capacity"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }},​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    {"reduce":{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "language":"javascript",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "source":​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "function(v) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​          var totals = {};​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​          for (var i in v) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​            for(var style in v[i]) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​              if( totals[style] ) totals[style] += v[i][style];​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​              else                totals[style] = v[i][style];​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​            }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​          }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​          return [totals];​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        }"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  ]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Running this on all rooms should return total counts of capacity, keyed by room style. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[{"single":7025,"queen":7123,"double":6855,"king":6733,"suite":7332}]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Your totals won’t match the previous exactly, since we randomly generated room data. </p><a></a><blockquote class="calibre40"><span class="calibre41"><span class="bold">Reducer Patterns</span></span></blockquote><a></a><blockquote class="calibre42"><span class="calibre41"> It’s easier to write a </span><span class="calibre9"><span class="calibre30">reduce</span></span><span class="calibre41"> function if it follows the same pattern as your map function. Meaning, if you map a single value as... </span></blockquote><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre41">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​[{name:'Eric', count:1}]​</span><span class="calibre9">​</span></blockquote></td></tr></table><a></a><blockquote class="calibre70"><span class="calibre41"> ...then the result of </span><span class="calibre9"><span class="calibre30">reduce</span></span><span class="calibre41"> should be like this: </span></blockquote><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre41">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​[{name:'Eric', count:105}, {name:'Jim', count:215}, …]​</span><span class="calibre9">​</span></blockquote></td></tr></table><a></a><blockquote class="calibre70"><span class="calibre41"> This certainly isn’t a requirement; it’s just practical. Since reducers can feed into other reducers, you don’t know whether the values you receive on any particular </span><span class="calibre9"><span class="calibre30">reduce</span></span><span class="calibre41"> function call will be populated by map output, reduce output, or a combination of both. However, if they follow the same object pattern, you don’t need to care; they’re all the same! Otherwise, your </span><span class="calibre9"><span class="calibre30">reduce</span></span><span class="calibre41"> function must always check for the type of data it’s receiving and make a decision accordingly. </span></blockquote><a></a><p class="calibre43"><span class="bold"><span class="calibre28">Key Filters</span></span></p><a></a><p class="calibre37"> A rather recent addition to Riak is the concept of key filters. A key filter is a collection of commands that process each key before executing mapreduce on it. This shortcut saves the operation the pain of loading unwanted values. In the following example, we’ll convert each room number key into an integer and check that it’s less than 1,000 (one of the first ten floors; any room over the tenth floor will be ignored). </p><a></a><p class="calibre12"> In our mapreduce to return room capacity, replace <span class="calibre9"><span class="calibre30">“inputs”:”rooms”,</span></span> with the following block (it must end with a comma): </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​"inputs":{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "bucket":"rooms",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "key_filters":[["string_to_int"], ["less_than", 1000]]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​},​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You should notice two things: the query ran much faster (since we processed only the values we needed), and the totals were fewer (since we added only the first ten floors). </p><a></a><p class="calibre12"> Mapreduce is a powerful tool for bundling data and performing some overarching analysis on it. It’s a concept we’ll revisit often in this book, but the core concept is the same. Riak has one slight tweak to the basic mapreduce form, and that’s the addition of links. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Link Walking with Mapreduce</span></span></p><a></a><p class="calibre37"> Yesterday we introduced link walking. Today we’ll look at how to do the same thing using mapreduce. The query section has one more value option along with <span class="calibre9"><span class="calibre30">map</span></span> and <span class="calibre9"><span class="calibre30">reduce</span></span>. It’s <span class="calibre9"><span class="calibre30">link</span></span>. </p><a></a><p class="calibre12"> Let’s return to our <span class="calibre9"><span class="calibre30">cages</span></span> bucket from yesterday’s dog hotel example and write a mapper that returns only cage 2 (remember, the one housing Ace the dog). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -X POST -H "content-type:application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">http://localhost:8091/mapred --data @-</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "inputs":{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "bucket":"cages",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "key_filters":[["eq", "2"]]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "query":[​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    {"link":{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "bucket":"animals",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "keep":false​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }},​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    {"map":{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "language":"javascript",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "source":​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "function(v) { return [v]; }"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  ]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Although we ran the mapreduce query against the <span class="calibre9"><span class="calibre30">cages</span></span> bucket, this will return <span class="italic">Ace the dog</span>’s information, because he was linked to cage 2. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "bucket":"animals",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "key":"ace",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "vclock":"a85hYGBgzmDKBVIsrDJPfTKYEhnzWBn6LfiP80GFWVZay0KF5yGE2ZqTGPmCLiJLZAEA",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "values":[{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "metadata":{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "Links":[],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "X-Riak-VTag":"4JVlDcEYRIKuyUhw8OUYJS",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "content-type":"application/json",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "X-Riak-Last-Modified":"Tue, 05 Apr 2011 06:54:22 GMT",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "X-Riak-Meta":[]},​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "data":"{\"nickname\" : \"The Wonder Dog\", \"breed\" : \"German Shepherd\"}"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Both data and metadata (which would normally be returned in the HTTP header) appear under a values array. </p><a></a><p class="calibre12"> Put map, reduce, link walking, and key filters together, and you can execute arbitrary queries on a wide array of Riak keys. It’s considerably more efficient than scanning all data from a client. Since these queries are generally run across several servers simultaneously, you should never have to wait long. But if you really cannot wait, a query has one more option: <span class="calibre9"><span class="calibre30">timeout</span></span>. Set <span class="calibre9"><span class="calibre30">timeout</span></span> to a value in milliseconds (the default is <span class="calibre9"><span class="calibre30">"timeout": 60000</span></span>, or 60 seconds), and if the query does not complete in the allotted time, it will abort. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Of Consistency and Durability</span></span></span></p><a></a><p class="calibre29"> Riak server architecture removes single points of failure (all nodes are peers) and allows you to grow or shrink the cluster at will. This is important when dealing with large-scale deployments, since it allows your database to remain available even if several nodes fail or are otherwise unresponsive. </p><a></a><p class="calibre12"> Distributing data across several servers is saddled with an inherent problem. If you want your database to continue running when a network partition occurs (meaning, some messages were lost), it means you must make a trade-off. Either you can remain <span class="italic">available</span> to server requests or you can refuse requests and ensure the <span class="italic">consistency</span> of your data. It is not possible to create a distributed database that is fully consistent, available, and partition tolerant. You can have only two (partition tolerant and consistent, partition tolerant and available, or consistent and available but not distributed). This is known as the CAP theorem (Consistency, Availability, Partition tolerance). See Appendix 2, <a href="#filepos1996601"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">The CAP Theorem</span></span><span class="calibre13"><span class="underline">​</span></span></a> for more details, but suffice to say it is a problem in system design. </p><a></a><p class="calibre12"> But the theorem has a loophole. The reality is that at <span class="italic">any moment in time</span> you cannot be consistent, available, and partition tolerant. Riak takes advantage of this fact by allowing you to trade availability for consistency on a per-request basis. We’ll first look at how Riak clusters its servers and then how to tune reads and writes to interact with the cluster. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">The Riak Ring</span></span></p><a></a><p class="calibre37"> Riak divides its server configuration into partitions denoted by a 160-bit number (that’s 2^160). The Riak team likes to represent this massive integer as a circle, which they call the <span class="italic">ring</span>. When a key is hashed to a partition, the ring helps direct which Riak servers store the value. </p><a></a><p class="calibre12"> One of the first decisions you’ll make when setting up a Riak cluster is how many partitions you’d like. Let’s consider the case where you have 64 partitions (Riak’s default). If you divide those sixty-four partitions across three nodes (or, servers), then Riak will give each node twenty-one or twenty-two partitions (64 / 3). Each partition is called a virtual node, or <span class="italic">vnode</span>. Each Riak service counts around the ring on boot, claiming partitions in turn until all vnodes are claimed, as shown in Figure 8, <a href="#filepos508118"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">“The Riak ring” of sixty-four vnodes, assigned across three physical nodes</span></span><span class="calibre13"><span class="underline">​</span></span></a>. </p><a id="filepos508118"></a><blockquote class="calibre10"><img src="images/00003.jpg" class="calibre71"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 8. “The Riak ring” of sixty-four vnodes, assigned across three physical nodes</span></blockquote><a></a><p class="calibre12"> Node A manages vnodes 1, 4, 7, 10...63. These vnodes are mapped to partitions of the 160-bit ring. If you view the status of your three development servers (remember <span class="calibre9"><span class="calibre30">curl -H "Accept: text/plain" http://localhost:8091/stats</span></span> from yesterday), you can see a line like this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​"ring_ownership": \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​"[{'dev3@127.0.0.1',21},{'dev2@127.0.0.1',21},{'dev1@127.0.0.1',22}]"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The second number of each object is the number of vnodes each node owns. They will total sixty-four (21 + 21 + 22). </p><p class="calibre12"><img src="images/00062.jpg" class="calibre72"/></p><a></a><p class="calibre22"> Each vnode represents a range of hashed keys. When we insert the room data for key <span class="calibre9"><span class="italic"><span class="calibre38">101</span></span></span>, it may get hashed into the vnode 2 range, so then the key-value object gets stored onto Node B. The benefit is that if we need to find which server the key lives on, Riak just hashes the key to find the corresponding vnode. Specifically, Riak will convert the hash into a list of potential vnodes and use the first value. </p><p class="calibre12" id="filepos510169"><span class="bold"><span class="calibre28">Nodes/​Writes/​Reads</span></span></p><a></a><p class="calibre37"> Riak allows us to control reads and writes into the cluster by altering three values: N, W, and R. <span class="italic">N</span> is the number of nodes a write ultimately replicates to, in other words, the number of copies in the cluster. <span class="italic">W</span> is the number of nodes that must be successfully written to before a successful response. If W is less than N, a write will be considered successful even while Riak is still copying the value. Finally, <span class="italic">R</span> is the number of nodes required to read a value successfully. If R is greater than the number of copies available, the request will fail. </p><a></a><p class="calibre12"> Let’s investigate each of these in more detail. </p><a></a><p class="calibre12"> When we write an object in Riak, we have the choice to replicate that value across multiple nodes. The benefit here is that if one server goes down, then a copy is available on another. The <span class="calibre9"><span class="calibre30">n_val</span></span> bucket property stores the number of nodes to replicate a value to (the N value); it’s <span class="calibre9"><span class="calibre30">3</span></span> by default. We can alter a bucket’s properties by putting a new value in the <span class="calibre9"><span class="calibre30">props</span></span> object. Here we set animals to have an <span class="calibre9"><span class="calibre30">n_val</span></span> of 4: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -X PUT http://localhost:8091/riak/animals \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -H "Content-Type: application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -d '{"props":{"n_val":4}}'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"><span class="italic">N</span> is simply the total number of nodes that will <span class="italic">eventually</span> contain the correct value. This doesn’t mean we must wait for the value to replicate to <span class="italic">all</span> of those nodes in order to return. Sometimes we just want our client to return immediately and let Riak replicate in the background. Or sometimes we want to wait until Riak has replicated to all <span class="italic">N</span> nodes (just to be safe) before returning. </p><a></a><p class="calibre12"> We can set the <span class="italic">W</span> value to the number of successful writes that must occur before our operation is considered a success. Although we’re writing to four nodes eventually, if we set W to 2, a write operation will return after only two copies are made. The remaining two will replicate in the background. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​curl -X PUT http://localhost:8091/riak/animals \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  -H "Content-Type: application/json" \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  -d '{"props":{"w":2}}'​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Finally, we can use the <span class="italic">R</span> value. <span class="italic">R</span> is the number of nodes that must be read in order to be considered a successful read. You can set a default <span class="italic">R</span> like we did earlier with <span class="calibre9"><span class="calibre30">n_val</span></span> and <span class="calibre9"><span class="calibre30">w</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​curl -X PUT http://localhost:8091/riak/animals \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  -H "Content-Type: application/json" \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  -d '{"props":{"r":3}}'​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> But Riak provides a more flexible solution. We may choose the number of nodes we want to read by setting an <span class="calibre9"><span class="calibre30">r</span></span> parameter in the URL <span class="italic">per request</span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​curl http://localhost:8091/riak/animals/ace?r=3​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You may be asking yourself why we would ever need to read from more than one node. After all, values we write will eventually be replicated to <span class="italic">N</span> nodes, and we can read from any of them. We find the idea is easier to visualize. </p><a id="filepos516524"></a><blockquote class="calibre10"><img src="images/00047.jpg" class="calibre73"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 9. Eventual consistency: W+R &lt;= N</span></blockquote><a></a><p class="calibre12"> Let’s say we set our NRW values to <span class="calibre9"><span class="calibre30">{"n_val":3, "r":2, "w":1}</span></span>, like Figure 9, <a href="#filepos516524"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Eventual consistency: W+R &lt;= N</span></span><span class="calibre13"><span class="underline">​</span></span></a>. This makes our system more responsive on writes, since only one node needs to be written before returning. But there is a chance that another operation could perform a read before the nodes had a chance to synchronize. Even if we read from two nodes, it’s possible we could receive an old value. </p><a></a><p class="calibre12"> One way to be certain we have the most current value is to set W=N and R=1 like this: <span class="calibre9"><span class="calibre30">{"n_val":3, "r":1, "w":3}</span></span> (see Figure 10, <a href="#filepos518047"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Consistency by writes: W=N, R=1</span></span><span class="calibre13"><span class="underline">​</span></span></a>). In essence, this is what relational databases do; they enforce consistency by ensuring a write is complete before returning. We can certainly read faster, since we need to access only one node. But this can really slow down writes. </p><a id="filepos518047"></a><blockquote class="calibre10"><img src="images/00044.jpg" class="calibre74"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 10. Consistency by writes: W=N, R=1</span></blockquote><a></a><p class="calibre12"> Or you could just write to a single node but read from all of them. This would be setting W=1 and R=N like this: <span class="calibre9"><span class="calibre30">{"n_val":3, "r":3, "w":1}</span></span> (see Figure 11, <a href="#filepos519013"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Consistency by reads: W=1, R=N</span></span><span class="calibre13"><span class="underline">​</span></span></a>). Although you may read a few old values, you are guaranteed to retrieve the most recent value, too. You’ll just have to resolve which one that is (using a vector clock, which we’ll cover tomorrow). Of course, this has the opposite problem as shown earlier and slows down reads. </p><a id="filepos519013"></a><blockquote class="calibre10"><img src="images/00043.jpg" class="calibre75"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 11. Consistency by reads: W=1, R=N</span></blockquote><a></a><p class="calibre12"> Or you could set W=2 and R=2 as <span class="calibre9"><span class="calibre30">{"n_val":3, "r":2, "w":2}</span></span> (see Figure 12, <a href="#filepos519894"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Consistency by quorum: W+R &gt; N</span></span><span class="calibre13"><span class="underline">​</span></span></a>). This way, you need only write to more than half of the nodes and read from more than half, but you still get the benefits of consistency while sharing the time delays between reads and writes. This is called a <span class="italic">quorum</span> and is the minimum amount to keep consistent data. </p><a id="filepos519894"></a><blockquote class="calibre10"><img src="images/00059.jpg" class="calibre75"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 12. Consistency by quorum: W+R &gt; N</span></blockquote><a></a><p class="calibre12"> You are free to set your R or W to any values between 1 and N but will generally want to stick with one, all, or a quorum. These are such common values that R and W can accept string values representing them, defined in the following table: </p><br class="calibre1"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Term  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Definition  </span></blockquote></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">One  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">This is just the value 1. Setting W or R means only one node need respond for the request to succeed.  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">All  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">This is the same value as N. Setting W or R to this means all replicated nodes must respond.  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">Quorum  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">This equals setting the value to N/2+1. Setting W or R means most nodes must respond to succeed.  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">Default  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Whatever the W or R value is set for the bucket. Generally defaults to 3.  </blockquote></td></tr></table><a></a><p class="calibre23"> In addition to the previous values as valid bucket properties, you can also use them as query parameter values. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​curl http://localhost:8091/riak/animals/ace?r=all​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The danger with requiring reading from all nodes is that if one goes down, Riak may be unable to fulfill your request. As an experiment, let’s shut down dev server 3. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">dev/dev3/bin/riak stop</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Now if we attempt to read from all nodes, there’s a good chance our request will fail (if it doesn’t, try shutting down dev2 as well, or possibly shut down dev1 and read from port 8092 or 8093; we cannot control what vnodes Riak writes to). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -i http://localhost:8091/riak/animals/ace?r=all</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​HTTP/1.1 404 Object Not Found​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Server: MochiWeb/1.1 WebMachine/1.7.3 (participate in the frantic)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Date: Thu, 02 Jun 2011 17:18:18 GMT​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Type: text/plain​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Length: 10​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​not found​</span><span class="calibre9">​</span></p></td></tr></table><p class="calibre45" id="filepos525694"> If your request cannot be fulfilled, you’ll get a 404 code (Object Not Found), which makes sense in the scope of the request. That object cannot be found, because there aren’t enough copies to fulfill the URL request. This isn’t a good thing, of course, so this kicks Riak to do a <span class="italic">read repair</span>: to request <span class="italic">N</span> replications of the key across the servers still available. If you attempt to access the same URL again, you’ll get the key’s value rather than another 404. The online Riak docs have an excellent example<a href="#filepos611603"><span class="calibre13"><span class="underline">[16]</span></span></a> using Erlang. </p><a></a><p class="calibre12"> But a safer play is to require a quorum (data from most, but not all, vnodes). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​curl http://localhost:8091/riak/animals/polly?r=quorum​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> As long as you write to a quorum, which you can force on a per-write basis, your reads should be consistent. Another value you can set on-the-fly is W. If you don’t want to wait for Riak to write to any nodes, you can set W to 0 (zero), which means “I trust you’ll write it, Riak; just return.” </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​curl -X PUT http://localhost:8091/riak/animals/jean?w=0 \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-H "Content-Type: application/json"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-d '{"nickname" : "Jean", "breed" : "Border Collie"}' \​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> All this power aside, much of the time you’ll want to stick with the default values unless you have a good reason. Logs are great for setting W=0, and you can set W=N and R=1 for seldom written data for extra-fast reads. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Writes and Durable Writes</span></span></p><a></a><p class="calibre37"> We’ve been keeping a secret from you. Writes in Riak aren’t necessarily durable, meaning they aren’t immediately written to disk. Although a <span class="italic">node write</span> may be considered successful, it’s still possible that a failure could occur where a node loses data; even if W=N, servers may fail and lose data. A write is buffered in memory for a moment before being stored on disk, and that split millisecond is a danger zone. </p><a></a><p class="calibre12"> That’s the bad news. The good news is Riak has provided us with a separate setting named <span class="bold"><span class="calibre39">DW</span></span> for <span class="italic">durable write</span>. This is slower but further reduces risk, since Riak will not return a success until after the object is written to disk on the given number of nodes. Just like we did with writes, you can set this property on the bucket. Here we’re setting <span class="calibre9"><span class="calibre30">dw</span></span> to be <span class="calibre9"><span class="calibre30">one</span></span> to be certain at least one node has stored our data. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -X PUT http://localhost:8091/riak/animals \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">-H "Content-Type: application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">-d '{"props":{"dw":"one"}}'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Or, if you like, you can override this on a per-write basis using the <span class="calibre9"><span class="calibre30">dw</span></span> query parameter in the URL. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">A Note on Hinted Handoff</span></span></p><a></a><p class="calibre37"> Attempting to write to nodes that aren’t available still succeeds with a “204 No Content.” This is because Riak will write the value to a nearby node that holds that data until such a time that it can hand it to the unavailable node. This is a fantastic safety net in the short-term, since if a server goes down, another Riak node will take over. Of course, if all of server A’s requests get routed to server B, then server B is now dealing with double the load. There is a danger this will cause B to fail, which might spread to C and D, and so on. This is known as a <span class="italic">cascading failure</span>, and it’s rare but possible. Consider this a fair warning not to tax every Riak server at full capacity, since you never know when one will have to pick up the slack. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Day 2 Wrap-Up</span></span></span></p><p class="calibre29" id="filepos531836"> Today you saw two of the biggest topics in Riak: the powerful mapreduce method and its flexible server clustering ability. Mapreduce is used by many of the other databases in this book, so if you still have any questions about it, we recommend rereading the first part of Day 2 and checking out the Riak online documentation<a href="#filepos611603"><span class="calibre13"><span class="underline">[17]</span></span></a> and Wikipedia<a href="#filepos611603"><span class="calibre13"><span class="underline">[18]</span></span></a> articles. </p><p class="calibre12"><span class="bold"><span class="calibre28">Day 2 Homework</span></span></p><p class="calibre37"><span class="bold">Find</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Read the online Riak mapreduce documentation.</p></li><li value="2" class="calibre36"><p class="calibre22">Find the Riak contrib functions repository, with lots of prebuilt mapreduce functions.</p></li><li value="3" class="calibre36"><p class="calibre22">Find the online documentation for a complete list of key filters, which range from converting strings <span class="calibre9"><span class="calibre30">to_upper</span></span> to finding numerical values between some range to even some simple Levenshtein distance string matches and logical and/or/not operations.</p></li></ol><p class="calibre12"><span class="bold">Do</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Write map and reduce functions against the <span class="calibre9"><span class="calibre30">rooms</span></span> bucket to find the total guest capacity per floor.</p></li><li value="2" class="calibre36"><p class="calibre22">Extend the previous function with a filter to find the capacities only for rooms on floors 42 and 43.</p></li></ol><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos533694" class="calibre1"><p class="calibre24" id="filepos533699"><span class="calibre25"><span class="bold"><span class="calibre26">3.4 Day 3: Resolving Conflicts and Extending Riak</span></span></span></p><a></a><p class="calibre27"> Today we delve into some of the edges of Riak. We’ve seen how Riak is a simple key-value database across a cluster of servers. When dealing with multiple nodes, data conflicts can occur, and sometimes we have to resolve them. Riak provides a mechanism to sort out which writes happened most recently by way of vector clocks and sibling resolution. </p><a></a><p class="calibre12"> We’ll also see how we can validate incoming data by way of pre- and post-commit hooks. We’ll extend Riak into our own personal search engine with Riak search (with the SOLR interface) and faster queries with secondary indexing. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Resolving Conflicts with Vector Clocks</span></span></span></p><p class="calibre29" id="filepos534650"> A <span class="italic">vector clock</span>
<a href="#filepos611603"><span class="calibre13"><span class="underline">[19]</span></span></a> is a token that distributed systems like Riak use to keep the order of conflicting key-value updates intact. It’s important to keep track of which updates happen in what order, since several clients may connect to different servers, and while one client updates one server, another client updates another server (you can’t control which server you write to). </p><a></a><p class="calibre12"> You may think “just timestamp the values and let the last value win,” but in a server cluster this works only if all server clocks are perfectly synchronous. Riak makes no such requirement, since keeping clocks synchronized is at best difficult and in many cases an impossible requirement. Using a centralized clock system would be anathema to the Riak philosophy, since it presents a single point of failure. </p><a></a><p class="calibre12"> Vector clocks help by tagging each key-value event (create, update, or delete) with which client made the change, in which order. This way, the clients, or application developer, can decide who wins in the case of conflict. If you are familiar with version control systems like Git or Subversion, this is not dissimilar to resolving version conflicts when two people change the same file. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Vector Clocks in Theory</span></span></p><a></a><p class="calibre37"> Let’s say that your dog hotel is doing well so you must start being more selective of the clientele. To help make the best decision, you’ve gathered a panel of three animal experts to help decide which new dogs are a good fit. They give each dog a score from 1 (not a good fit) to 4 (a perfect candidate). All of these panelists—named Bob, Jane, and Rakshith—must reach a unanimous decision. </p><a></a><p class="calibre12"> Each panelist has their own client connecting to a database server, and each client stamps a unique client ID onto each request. This client ID is used to build the vector clock, as well as keep track of the last updating client in the object header. Let’s look at a simple pseudocode example and later try the example in Riak. </p><a></a><p class="calibre12"> Bob creates the object first, with a respectable score of 3 for a new puppy named Bruiser. The vector clock encodes his name and the version 1. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​vclock: bob[1]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​value:  {score : 3}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Jane pulls this record and gives Bruiser a score of 2. The vclock created for her update succeeded Bob’s, so her version 1 is added to the end of the vector. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​vclock: bob[1], jane[1]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​value:  {score : 2}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Simultaneously, Rakshith pulled the version that Bob created but not Jane’s. He loved Bruiser and set a score of 4. Just like Jane’s, his client name is appended to the end of the vector clock as version 1. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​vclock: bob[1], rakshith[1]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​value:  {score : 4}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Later that day, Jane (as the panel chair) rechecks the scores. Since Rakshith’s update vector did not occur after Jane’s but rather alongside hers, the updates are in conflict and need to be resolved. She receives both values, and it’s up to her to resolve them. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​vclock: bob[1], jane[1]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​value:  {score : 2}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​---​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​vclock: bob[1], rakshith[1]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​value:  {score : 4}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> She chooses a middle value so updates the score to 3. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​vclock: bob[1], rakshith[1], jane[2]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​value:  {score : 3}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Having been resolved, anyone who pulls a request after this point will get this most recent value. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Vector Clocks in Practice</span></span></p><a></a><p class="calibre37"> Let’s run through the previous example scenario using Riak. </p><a></a><p class="calibre12"> For this example we want to see all conflicting versions so we can resolve them manually. Let’s keep multiple versions by setting the <span class="calibre9"><span class="calibre30">allow_mult</span></span> property on the <span class="calibre9"><span class="calibre30">animals</span></span> bucket. Any key with multiple values are called <span class="italic">sibling</span> values. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ curl -X PUT http://localhost:8091/riak/animals \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  -H "Content-Type: application/json" \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  -d '{"props":{"allow_mult":true}}'​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Here, Bob puts Bruiser in the system with his chosen score of 3 and a client ID of <span class="calibre9"><span class="italic"><span class="calibre38">bob</span></span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ curl -i -X PUT http://localhost:8091/riak/animals/bruiser \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  -H "X-Riak-ClientId: bob" \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  -H "Content-Type: application/json" \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  -d '{"score" : 3}'​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Jane and Rakshith both pull Bruiser’s data that Bob created (you’ll have much more header information; we’re just showing the vector clock here). </p><a></a><p class="calibre12"> Note that Riak encoded Bob’s vclock, but under the covers it’s a client and a version (and timestamp, so yours will be different from the one shown). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ curl -i http://localhost:8091/riak/animals/bruiser?return_body=true​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​X-Riak-Vclock: a85hYGBgzGDKBVIs7NtEXmUwJTLmsTI8FMs5zpcFAA==​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"score" : 3}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Jane makes her update to score 2 and includes the most recent vector clock she received from Bob’s version. This is a signal to Riak that her value is an update of Bob’s version. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ curl -i -X PUT http://localhost:8091/riak/animals/bruiser \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  -H "X-Riak-ClientId: jane" \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  -H "X-Riak-Vclock: a85hYGBgzGDKBVIs7NtEXmUwJTLmsTI8FMs5zpcFAA==" \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  -H "Content-Type: application/json" \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  -d '{"score" : 2}'​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Since Jane and Rakshith pulled Bob’s data at the same time, he also submits an update (of score 4) using Bob’s vector clock. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ curl -i -X PUT http://localhost:8091/riak/animals/bruiser \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  -H "X-Riak-ClientId: rakshith" \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  -H "X-Riak-Vclock: a85hYGBgzGDKBVIs7NtEXmUwJTLmsTI8FMs5zpcFAA==" \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  -H "Content-Type: application/json" \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  -d '{"score" : 4}'​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> When Jane rechecks the score, she sees not a value, as expected, but rather an HTTP code for multiple choices and a body containing two “sibling” values. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ curl http://localhost:8091/riak/animals/bruiser?return_body=true​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Siblings:​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​637aZSiky628lx1YrstzH5​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​7F85FBAIW8eiD9ubsBAeVk​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Riak stored these versions in a multipart format, so she can retrieve the entire object by accepting that MIME type. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ curl -i http://localhost:8091/riak/animals/bruiser?return_body=true \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  -H "Accept: multipart/mixed"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​HTTP/1.1 300 Multiple Choices​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​X-Riak-Vclock: a85hYGBgyWDKBVHs20Re...OYn9XY4sskQUA​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Type: multipart/mixed; boundary=1QwWn1ntX3gZmYQVBG6mAZRVXlu​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Length: 409​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​--1QwWn1ntX3gZmYQVBG6mAZRVXlu​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Type: application/json​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Etag: 637aZSiky628lx1YrstzH5​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"score" : 4}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​--1QwWn1ntX3gZmYQVBG6mAZRVXlu​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Type: application/json​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Etag: 7F85FBAIW8eiD9ubsBAeVk​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"score" : 2}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​--1QwWn1ntX3gZmYQVBG6mAZRVXlu--​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Notice that the “siblings” shown earlier are HTTP etags (which Riak called vtags) to specific values. As a side note, you can use the vtag parameter in the URL to retrieve only that version: <span class="calibre9"><span class="calibre30">curl http://localhost:8091/riak/animals/bruiser?vtag=7F85FBAIW8eiD9ubsBAeVk</span></span> will return <span class="calibre9"><span class="calibre30">{"score" : 2}</span></span>. Jane’s job now is to use this information to make a reasonable update. She decides to average the two scores and update to 3, using the vector clock given to resolve the conflict. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ curl -i -X PUT http://localhost:8091/riak/animals/bruiser?return_body=true \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-H "X-Riak-ClientId: jane" \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-H "X-Riak-Vclock: a85hYGBgyWDKBVHs20Re...OYn9XY4sskQUA" \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-H "Content-Type: application/json" \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-d '{"score" : 3}'​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Now when Bob and Rakshith retrieve <span class="calibre9"><span class="calibre30">bruiser</span></span>’s information, they’ll get the resolved score. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ curl -i http://localhost:8091/riak/animals/bruiser?return_body=true​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​HTTP/1.1 200 OK​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​X-Riak-Vclock: a85hYGBgyWDKBVHs20Re...CpQmAkonCcHFM4CAA==​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"score" : 3}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Any future requests will receive score 3. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Time Keeps on Growing</span></span></p><a></a><p class="calibre37"> You may have noticed that the vector clock keeps growing as more clients update values. This is a fundamental problem with vector clocks, which the Riak developers understood. They extended vector clocks to be “pruned” over time, thus keeping their size small. The rate at which Riak prunes old vector clock values are bucket properties, which can be viewed (along with all other properties) by reading the bucket. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ curl http://localhost:8091/riak/animals​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You’ll see some of the following properties, which dictate how Riak will prune the clock before it gets too large. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​"small_vclock":10,"big_vclock":50,"young_vclock":20,"old_vclock":86400​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"><span class="calibre9"><span class="italic"><span class="calibre38">small_vclock</span></span></span> and <span class="calibre9"><span class="italic"><span class="calibre38">big_vclock</span></span></span> determine the minimum and maximum length of the vector, while <span class="calibre9"><span class="italic"><span class="calibre38">young_vclock</span></span></span> and <span class="calibre9"><span class="italic"><span class="calibre38">old_vclock</span></span></span> describe the minimum and maximum age of a vclock before pruning happens. </p><p class="calibre12" id="filepos561539"> You can read more about vector clocks and pruning online.<a href="#filepos611603"><span class="calibre13"><span class="underline">[20]</span></span></a>
</p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Pre/Post-commit Hooks</span></span></p><a></a><p class="calibre37"> Riak can transform data before or after saving an object, by way of hooks. Pre- and post-commit hooks are simply JavaScript (or Erlang) functions that get executed before or after a commit occurs. Pre-commit functions can modify the incoming object in some way (and even cause it to fail), while post-commits can respond to a successful commit (such as writing to a log or sending an email to something). </p><a></a><p class="calibre12"> Each server has an <span class="calibre9"><span class="calibre30">app.config</span></span> file, which needs to reference the location of any custom JavaScript code. First open your file for server dev1, under <span class="calibre9"><span class="calibre30">dev/dev1/etc/app.config</span></span>, and find the line containing <span class="calibre9"><span class="calibre30">js_source_dir</span></span>. Replace it with any directory path you want (note that the line may be commented out with a % character, so uncomment it first by removing the character). Our line looks like this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{js_source_dir, "~/riak/js_source"},​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You’ll need to make this change in triplicate, once for each dev server. </p><a></a><p class="calibre12"> Let’s create a validator that runs pre-commit to parse incoming data, ensures that a score exists, and ensures that the score is between 1 and 4. If any of those criteria fail, an error will be thrown, and our validator will return the JSON object containing only <span class="calibre9"><span class="calibre30">{"fail" : message}</span></span>, where <span class="calibre9"><span class="calibre30">message</span></span> is whatever we want to relay to the user. If the data is as expected, you need return only the object, and Riak will store the value. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/riak/my_validators.js"><span class="calibre41"><span class="calibre13"><span class="underline">riak/my_validators.js</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9"> good_score(object) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">try</span></span></span><span class="calibre9"> {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre46">/* from the Riak object, pull data and parse it as JSON */</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> data = JSON.parse( object.values[0].data );​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre46">/* if score is not found, fail here */</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9">( !data.score || data.score === </span><span class="calibre9"><span class="italic"><span class="calibre38">''</span></span></span><span class="calibre9"> ) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="bold"><span class="calibre44">throw</span></span></span><span class="calibre9">( </span><span class="calibre9"><span class="italic"><span class="calibre38">'Score is required'</span></span></span><span class="calibre9"> );​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre46">/* if score is not within range, fail here */</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9">( data.score &lt; 1 || data.score &gt; 4 ) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="bold"><span class="calibre44">throw</span></span></span><span class="calibre9">( </span><span class="calibre9"><span class="italic"><span class="calibre38">'Score must be from 1 to 4'</span></span></span><span class="calibre9"> );​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  } </span><span class="calibre9"><span class="bold"><span class="calibre44">catch</span></span></span><span class="calibre9">( message ) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre46">/* Riak expects the following JSON if a failure occurs */</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">return</span></span></span><span class="calibre9"> { "fail" : message };​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="italic"><span class="calibre46">/* No problems found, so continue */</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">return</span></span></span><span class="calibre9"> object;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Store this file in the <span class="calibre9"><span class="calibre30">js_source_dir</span></span> directory you set. Since we’re making core server changes, we need to restart all of the development servers using the <span class="calibre9"><span class="calibre30">restart</span></span> argument. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">dev/dev1/bin/riak restart</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">dev/dev2/bin/riak restart</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">dev/dev3/bin/riak restart</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Riak will scan for any files ending in <span class="calibre9"><span class="calibre30">.js</span></span> and load those into memory. You can now set a bucket’s <span class="calibre9"><span class="calibre30">precommit</span></span> property to use the JavaScript <span class="italic">function</span> name (not the filename). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​curl -X PUT http://localhost:8091/riak/animals \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-H "content-type:application/json" \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-d '{"props":{"precommit":[{"name" : "good_score"}]}}'​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Let’s test our new hook by setting a score greater than 4. Our pre-commit hook enforces that a score must be from 1 to 4, so the following will fail: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​curl -i -X PUT http://localhost:8091/riak/animals/bruiser \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-H "Content-Type: application/json" -d '{"score" : 5}'​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​HTTP/1.1 403 Forbidden​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Type: text/plain​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Length: 25​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Score must be 1 to 4​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You’ll get a 403 Forbidden code, as well as a plain-text error message that was returned under the “fail” field. If you <span class="calibre9"><span class="calibre30">GET</span></span> the <span class="calibre9"><span class="calibre30">bruiser</span></span> value, its score remains 3. Try setting the score to 2, and you’ll have more success. </p><a></a><p class="calibre12"> Post-commit is similar to pre-commit but happens after the commit is successful. We’re skipping it here, since you can write postcommit hooks only in Erlang. If you’re an Erlang developer, the online docs can help guide you through installing your own modules. In fact, you can write Erlang mapreduce functions, too. But our Riak journey continues to other prebuilt modules and extensions. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Extending Riak</span></span></span></p><a></a><p class="calibre29"> Riak ships with several extensions that are turned off by default yet add new behaviors you may find useful. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Searching Riak</span></span></p><a></a><p class="calibre37"> Riak search scans data inside your Riak cluster and builds an inverted index against it. You may recall the term <span class="italic">inverted index</span> from the PostgreSQL chapter (the GIN index stands for Generalized Inverted Index). Just like GIN, the Riak index exists to make many varieties of string searching fast and efficient but in a distributed manner. </p><a></a><p class="calibre12"> Using Riak search requires enabling it in your <span class="calibre9"><span class="calibre30">app.config</span></span> files and setting the Riak search config to <span class="calibre9"><span class="calibre30">enabled, true</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​%% Riak Search Config​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{riak_search, [​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  %% To enable Search functionality set this 'true'.​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  {enabled, true}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​]},​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If you’re familiar with search engine solutions such as Lucene, this part should be a cakewalk. If not, it’s easy to get the hang of it. </p><a></a><p class="calibre12"> We need to let the search know when we change values in the database by way of a pre-commit hook. You can install <span class="calibre9"><span class="calibre30">riak_search_kv_hook</span></span>, Erlang module’s <span class="calibre9"><span class="calibre30">precommit</span></span> function, in a new <span class="calibre9"><span class="calibre30">animals</span></span> bucket with the following command: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ curl -X PUT http://localhost:8091/riak/animals \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-H "Content-Type: application/json" \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-d '{"props":{"precommit":​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[{"mod": "riak_search_kv_hook","fun":"precommit"}]}}'​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Calling <span class="calibre9"><span class="calibre30">curl http://localhost:8091/riak/animals</span></span> will show that the hook has been added to the <span class="calibre9"><span class="calibre30">animals</span></span> bucket’s <span class="calibre9"><span class="calibre30">precommit</span></span> property. Now, when you put data that is encoded as JSON or XML into the <span class="calibre9"><span class="calibre30">animals</span></span> bucket, Riak search will index the field names and values. Let’s upload a few animals. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ curl -X PUT http://localhost:8091/riak/animals/dragon \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-H "Content-Type: application/json" \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-d '{"nickname" : "Dragon", "breed" : "Briard", "score" : 1 }'​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ curl -X PUT http://localhost:8091/riak/animals/ace \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-H "Content-Type: application/json" \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-d '{"nickname" : "The Wonder Dog", "breed" : "German Shepherd", "score" : 3 }'​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ curl -X PUT http://localhost:8091/riak/animals/rtt \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-H "Content-Type: application/json" \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-d '{"nickname" : "Rin Tin Tin", "breed" : "German Shepherd", "score" : 4 }'​</span><span class="calibre9">​</span></p></td></tr></table><p class="calibre45" id="filepos583868"> There are several options for querying this data, but let’s use Riak’s HTTP Solr interface (which implements the Apache Solr<a href="#filepos611603"><span class="calibre13"><span class="underline">[21]</span></span></a> search interface). To search <span class="calibre9"><span class="calibre30">/animals</span></span>, we access <span class="calibre9"><span class="calibre30">/solr</span></span>, followed by the bucket name <span class="calibre9"><span class="calibre30">/animals</span></span> and the <span class="calibre9"><span class="calibre30">/select</span></span> command. The parameters specify the search terms. Here we select any <span class="calibre9"><span class="italic"><span class="calibre38">breed</span></span></span> that contains the word <span class="calibre9"><span class="italic"><span class="calibre38">Shepherd</span></span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ curl http://localhost:8091/solr/animals/select?q=breed:Shepherd​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&lt;?xml version="1.0" encoding="UTF-8"?&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&lt;response&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  &lt;lst name="responseHeader"&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    &lt;int name="status"&gt;0&lt;/int&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    &lt;int name="QTime"&gt;1&lt;/int&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    &lt;lst name="params"&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      &lt;str name="indent"&gt;on&lt;/str&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      &lt;str name="start"&gt;0&lt;/str&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      &lt;str name="q"&gt;breed:Shepherd&lt;/str&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      &lt;str name="q.op"&gt;or&lt;/str&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      &lt;str name="df"&gt;value&lt;/str&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      &lt;str name="wt"&gt;standard&lt;/str&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      &lt;str name="version"&gt;1.1&lt;/str&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      &lt;str name="rows"&gt;2&lt;/str&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    &lt;/lst&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  &lt;/lst&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  &lt;result name="response" numFound="2" start="0" maxScore="0.500000"&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    &lt;doc&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      &lt;str name="id"&gt;ace&lt;/str&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      &lt;str name="breed"&gt;German Shepherd&lt;/str&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      &lt;str name="nickname"&gt;The Wonder Dog&lt;/str&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      &lt;str name="score"&gt;3&lt;/str&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    &lt;/doc&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    &lt;doc&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      &lt;str name="id"&gt;rtt&lt;/str&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      &lt;str name="breed"&gt;German Shepherd&lt;/str&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      &lt;str name="nickname"&gt;Rin Tin Tin&lt;/str&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      &lt;str name="score"&gt;4&lt;/str&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    &lt;/doc&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  &lt;/result&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&lt;/response&gt;​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If you prefer that the query returns JSON, add the parameter <span class="calibre9"><span class="calibre30">wt=json</span></span>. You can combine multiple parameters in the query by separating them with a space (or %20 in URL-encoded form) and setting the <span class="calibre9"><span class="calibre30">q.op</span></span> parameter with the value <span class="calibre9"><span class="calibre30">and</span></span>. To find a breed with a nickname containing the word <span class="italic">rin</span> and a breed of shepherd, perform the following: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ curl http://localhost:8091/solr/animals/select\​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​?wt=json&amp;q=nickname:rin%20breed:shepherd&amp;q.op=and​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Riak search allows for more colorful query syntaxes, such as wildcards (using * to match multiple characters and using ? to match one character), though only at the end of the term. The query <span class="calibre9"><span class="calibre30">nickname:Drag*</span></span> would match Dragon, but <span class="calibre9"><span class="calibre30">nickname:*ragon</span></span> would not match. Range searches are also nice options: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​nickname:[dog TO drag]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> More-complex queries based on boolean operators, grouping, and proximity searches are available. Beyond that, you can specify custom data encodings, create custom indexes, and even choose between them when you search. You can find other URL parameters in the following table: </p><br class="calibre1"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Param  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Description  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Default  </span></blockquote></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">q  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">The given query string  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">q.op  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Query terms are either   <span class="calibre9"><span class="calibre30">and</span></span> or <span class="calibre9"><span class="calibre30">or</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">or</span></span>
</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">sort  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Field name to sort by  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">none  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">start  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">The first object in the matching list to return  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">0  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">rows  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">The max number of results to return  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">20  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">wt  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Output either   <span class="calibre9"><span class="calibre30">xml</span></span> or <span class="calibre9"><span class="calibre30">json</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">xml</span></span>
</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">index  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Specifies the index to use  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">  </blockquote></td></tr></table><a></a><p class="calibre23"> There is plenty more to learn about the Riak search extension, far more than we can reasonably cover here. Ideally you’ve gotten a feel for its power. It’s a clear choice if you plan to provide search functionality for a large web application, but it also deserves a second look if you need a lot of simple ad hoc querying. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Indexing Riak</span></span></p><a></a><p class="calibre37"> As of version 1.0, Riak supports secondary indexes. These are similar to the indexes we saw in PostgreSQL but with a slight twist. Rather than indexing on a specific column or columns of data, Riak allows you to index on metadata attached to the header of the object. </p><a></a><p class="calibre12"> Once again, we must make a change to the <span class="calibre9"><span class="calibre30">app.config</span></span> file. Switch the storage back end from bitcask to eLevelDB, as shown here, and then restart the servers: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{riak_kv, [​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  %% Storage_backend specifies the Erlang module defining the​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  %% storage mechanism that will be used on this node.​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  {storage_backend, riak_kv_eleveldb_backend},​</span><span class="calibre9">​</span></p></td></tr></table><p class="calibre45" id="filepos601279"> eLevelDB is an Erlang implementation of the Google key-value store called LevelDB.<a href="#filepos611603"><span class="calibre13"><span class="underline">[22]</span></span></a> This new back-end implementation allowed for secondary indexing in Riak to take place. </p><a></a><p class="calibre12"> With our system ready to go, we can index any object with any number of header tags known as an <span class="italic">index entries</span> that define how an object is indexed. The field names begin with <span class="calibre9"><span class="calibre30">x-riak-index-</span></span> and end with either <span class="calibre9"><span class="calibre30">_int</span></span> or <span class="calibre9"><span class="calibre30">_bin</span></span> for integer or binary (anything not an integer) values, respectively. </p><a></a><p class="calibre12"> To add Blue II, the Butler Bulldogs mascot, we’d like to index by the university name that this dog is a mascot for (<span class="calibre9"><span class="calibre30">butler</span></span>), as well as the version number (Blue 2 is the second bulldog mascot). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ curl -X PUT http://localhost:8098/riak/animals/blue​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-H "x-riak-index-mascot_bin: butler"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-H "x-riak-index-version_int: 2"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-d '{"nickname" : "Blue II", "breed" : "English Bulldog"}'​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You may have noticed that the indexes have nothing to do with the value stored in the key. This is actually a powerful feature, since it allows us to index data orthogonal to any data we may store. If you want to store a video as a value, you may still index it. </p><a></a><p class="calibre12"> Getting the value by the index is fairly straightforward. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ curl http://localhost:8098/riak/animals/index/mascot_bin/butler​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Though secondary indexing in Riak is a big step in the right direction, it still has a way to go. If you want to index dates, for example, you must store a string that can be sorted in order—such as <span class="calibre9"><span class="calibre30">"YYYYMMDD"</span></span>. Storing any floating digits requires to you first multiply the float by some significant precision multiple of 10 and then store it as an integer—such as 1.45 * 100 == 145. Your client is responsible for doing this conversion. But between mapreduce, Riak search, and now secondary indexing, Riak is providing many tools to loosen up the classic constraints of the key-value store design by other means of value access beyond simple keys. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Day 3 Wrap-Up</span></span></span></p><a></a><p class="calibre29"> We finished Riak with some of its more advanced concepts: how to deal with version conflicts by using vector clocks and how to ensure or modify incoming data with commit hooks. We also dug into using a couple Riak extensions: activating Riak search and indexing data to allow for a little more query flexibility. </p><a></a><p class="calibre12"> Using these concepts along with mapreduce from Day 2 and <span class="calibre9"><span class="calibre30">Link</span></span>s from Day 1, you can create a flexible combination of tools far beyond your standard key-value store. </p><p class="calibre12"><span class="bold"><span class="calibre28">Day 3 Homework</span></span></p><p class="calibre37"><span class="bold">Find</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Find the Riak function contrib list repository (hint: it’s in GitHub).</p></li><li value="2" class="calibre36"><p class="calibre22">Read more about vector clocks.</p></li><li value="3" class="calibre36"><p class="calibre22">Learn to create your own index configuration.</p></li></ol><p class="calibre12"><span class="bold">Do</span>
</p><div id="filepos606293" class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Create your own index that defines the <span class="calibre9"><span class="calibre30">animals</span></span> schema. Specifically, set the <span class="calibre9"><span class="calibre30">score</span></span> field to integer type, and query it as a range.</p></li><li value="2" class="calibre36"><p class="calibre22"> Start up a small cluster of three servers (such as three laptops or EC2<a href="#filepos611603"><span class="calibre13"><span class="underline">[23]</span></span></a> instances), and install Riak on each. Set up the servers as a cluster. Install the Google stock dataset, located on the Basho website.<a href="#filepos611603"><span class="calibre13"><span class="underline">[24]</span></span></a>
</p></li></ol><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos607083" class="calibre1"><p class="calibre24" id="filepos607088"><span class="calibre25"><span class="bold"><span class="calibre26">3.5 Wrap-Up</span></span></span></p><a></a><p class="calibre27"> Riak is the first NoSQL style database we’ve covered. It is a distributed, data-replicating, enhanced key-value store without a single point of failure. </p><a></a><p class="calibre12"> If your experience with databases until now has been only relational, Riak may seem like an alien beast. There are no transactions, no SQL, no schema. There are keys, but linking between buckets is not at all like a table join, and mapreduce can be a daunting methodology to grok. </p><a></a><p class="calibre12"> The trade-offs, however, are worth it for a certain class of problems. Riak’s ability to scale out with more servers (rather than scale up with larger single servers) and its ease of use are excellent attempts at solving the unique scalability problems of the Web. And rather than reinventing the wheel, Riak piggybacks on the HTTP structure, allowing maximum flexibility for any framework or web-enabled system. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Riak’s Strengths</span></span></span></p><p class="calibre29" id="filepos608290"> If you want to design a large-scale ordering system a la Amazon, or in any situation where high availability is your paramount concern, you should consider Riak. Hands down, one of Riak’s strengths lies in its focus on removing single points of failure in an attempt to support maximum uptime and grow (or shrink) to meet changing demands. If you do not have complex data, Riak keeps things simple but still allows for some pretty sophisticated data diving should you need it. There is currently support for about a dozen languages (which you can find on the Riak website) but is extendable to its core if you like to write in Erlang. And if you require more speed than HTTP can handle, you can also try your hand at communicating via Protobuf,<a href="#filepos611603"><span class="calibre13"><span class="underline">[25]</span></span></a> which is a more efficient binary encoding and transport protocol. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Riak’s Weaknesses</span></span></span></p><a></a><p class="calibre29"> If you require simple queryability, complex data structures, or a rigid schema or if you have no need to scale horizontally with your servers, Riak is probably not your best choice. One of our major gripes about Riak is it still lags in terms of an easy and robust ad hoc querying framework, although it is certainly on the right track. Mapreduce provides fantastic and powerful functionality, but we’d like to see more built-in URL-based or other <span class="calibre9"><span class="calibre30">PUT</span></span> query actions. The addition of indexing was a major step in the right direction and a concept we’d love to see expanded upon. Finally, if you don’t want to write Erlang, you may see a few limitations using JavaScript, such as the unavailability of post-commit or slower mapreduce execution. However, the Riak team is working on these relatively minor hiccups. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Riak on CAP</span></span></span></p><a></a><p class="calibre29"> Riak provides a clever way of circumventing the constraints that CAP places on all distributed databases. How it dances around the problem is astounding, compared to a system like PostgreSQL that can (largely) only support strong write consistency. Riak leverages the Amazon Dynamo paper’s insight that CAP can be changed on a per-bucket, or per-request, basis. It’s a big step forward for robust and flexible open source database systems. As you read about other databases in this book, keep Riak in mind, and you’ll continue to be impressed by its flexibility. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Parting Thoughts</span></span></span></p><a></a><p class="calibre29"> If you need to store a huge catalog of data, you could do worse than Riak. Though relational databases have been researched and tweaked for more than forty years, not every problem needs ACID compliance or the ability to enforce a schema. If you want to embed a database into a device or handle financial transactions, you should avoid Riak. If you want to scale out or serve up loads of data on the Web, take a look. </p><p class="calibre23"><span class="calibre9"><span class="bold"><span class="calibre28">Footnotes</span></span></span></p><a id="filepos611603"></a><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos362110"><span class="calibre9"><span class="calibre13"><span class="underline">[9]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://allthingsdistributed.com/files/amazon-dynamo-sosp2007.pdf"><span class="calibre9"><span class="calibre13"><span class="underline">http://allthingsdistributed.com/files/amazon-dynamo-sosp2007.pdf</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos363387"><span class="calibre9"><span class="calibre13"><span class="underline">[10]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://www.basho.com/"><span class="calibre9"><span class="calibre13"><span class="underline">http://www.basho.com/</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos363387"><span class="calibre9"><span class="calibre13"><span class="underline">[11]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://www.erlang.org/"><span class="calibre9"><span class="calibre13"><span class="underline">http://www.erlang.org/</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos437173"><span class="calibre9"><span class="calibre13"><span class="underline">[12]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://ruby-lang.org"><span class="calibre9"><span class="calibre13"><span class="underline">http://ruby-lang.org</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos437603"><span class="calibre9"><span class="calibre13"><span class="underline">[13]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://rubygems.org"><span class="calibre9"><span class="calibre13"><span class="underline">http://rubygems.org</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos437603"><span class="calibre9"><span class="calibre13"><span class="underline">[14]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://rubygems.org/gems/riak-client"><span class="calibre9"><span class="calibre13"><span class="underline">http://rubygems.org/gems/riak-client</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos447945"><span class="calibre9"><span class="calibre13"><span class="underline">[15]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://research.google.com/archive/mapreduce.html"><span class="calibre9"><span class="calibre13"><span class="underline">http://research.google.com/archive/mapreduce.html</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos525694"><span class="calibre9"><span class="calibre13"><span class="underline">[16]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://wiki.basho.com/Replication.html"><span class="calibre9"><span class="calibre13"><span class="underline">http://wiki.basho.com/Replication.html</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos531836"><span class="calibre9"><span class="calibre13"><span class="underline">[17]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://wiki.basho.com/MapReduce.html"><span class="calibre9"><span class="calibre13"><span class="underline">http://wiki.basho.com/MapReduce.html</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos531836"><span class="calibre9"><span class="calibre13"><span class="underline">[18]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://en.wikipedia.org/wiki/MapReduce"><span class="calibre9"><span class="calibre13"><span class="underline">http://en.wikipedia.org/wiki/MapReduce</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos534650"><span class="calibre9"><span class="calibre13"><span class="underline">[19]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://en.wikipedia.org/wiki/Vector_clock"><span class="calibre9"><span class="calibre13"><span class="underline">http://en.wikipedia.org/wiki/Vector_clock</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos561539"><span class="calibre9"><span class="calibre13"><span class="underline">[20]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://wiki.basho.com/Vector-Clocks.html"><span class="calibre9"><span class="calibre13"><span class="underline">http://wiki.basho.com/Vector-Clocks.html</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos583868"><span class="calibre9"><span class="calibre13"><span class="underline">[21]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://lucene.apache.org/solr/"><span class="calibre9"><span class="calibre13"><span class="underline">http://lucene.apache.org/solr/</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos601279"><span class="calibre9"><span class="calibre13"><span class="underline">[22]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://code.google.com/p/leveldb/"><span class="calibre9"><span class="calibre13"><span class="underline">http://code.google.com/p/leveldb/</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos606293"><span class="calibre9"><span class="calibre13"><span class="underline">[23]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://aws.amazon.com/ec2/"><span class="calibre9"><span class="calibre13"><span class="underline">http://aws.amazon.com/ec2/</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos606293"><span class="calibre9"><span class="calibre13"><span class="underline">[24]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://wiki.basho.com/Loading-Data-and-Running-MapReduce-Queries.html"><span class="calibre9"><span class="calibre13"><span class="underline">http://wiki.basho.com/Loading-Data-and-Running-MapReduce-Queries.html</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos608290"><span class="calibre9"><span class="calibre13"><span class="underline">[25]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://code.google.com/p/protobuf/"><span class="calibre9"><span class="calibre13"><span class="underline">http://code.google.com/p/protobuf/</span></span></span></a><span class="calibre9">
</span></p></td></tr></table><p class="calibre17"><span class="calibre9"><span class="calibre18"><span class="calibre19">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos618168" class="calibre1"><p class="calibre21" id="filepos618173"><span class="calibre3"><span class="bold"><span class="calibre31"> Chapter 4</span></span></span></p><br class="calibre1"/><p class="calibre32"><span class="calibre3"><span class="bold"><span class="calibre4">HBase</span></span></span></p><a></a><p class="calibre12"> Apache HBase is made for big jobs, like a nail gun. You would never use HBase to catalog your corporate sales list, just like you’d never use a nail gun to build a dollhouse. If your data is not measured by many gigabytes, you probably need a smaller tool. </p><a></a><p class="calibre12"> HBase, at first glance, looks a lot like a relational database—so much so that if you didn’t know any better, you might think that it is one. The most challenging part of learning HBase isn’t the technology; it’s that many of the words used in HBase are coaxingly, deceptively familiar. For example, HBase stores data in buckets it calls <span class="italic">tables</span>, which contain <span class="italic">cells</span> that appear at the intersection of <span class="italic">rows</span> and <span class="italic">columns</span>. So far so good, right? </p><a></a><p class="calibre12"> Wrong! In HBase, tables don’t behave like relations, rows don’t act like records, and columns are completely variable (not enforced by a schema description). Schema design is still important, since it informs the performance characteristics of the system, but it won’t keep your house in order. HBase is the evil twin, the bizarro, if you will, of RDBMS. </p><a></a><p class="calibre12"> So, why would you use this database? Aside from scalability, there are a few reasons. First, HBase has some built-in features that other databases lack, such as versioning, compression, garbage collection (for expired data), and in-memory tables. Having these features available right out of the box means less code that you have to write when your requirements demand them. HBase also makes strong consistency guarantees, making it easier to transition from relational databases. </p><a></a><p class="calibre12"> For all of these reasons, HBase really shines as the cornerstone of an online analytics processing system. While individual operations may be slower than equivalent operations in other databases, scanning through enormous datasets is something HBase takes to with relish. So, for genuinely big queries, HBase often outpaces other databases. This also explains why HBase is often employed at big companies to back logging and search systems. </p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos620659" class="calibre1"><p class="calibre24" id="filepos620664"><span class="calibre25"><span class="bold"><span class="calibre26">4.1 Introducing HBase</span></span></span></p><p class="calibre27" id="filepos620792"> HBase is a <span class="italic">column-oriented</span> database that prides itself on consistency and scaling out. It is based on BigTable, a high-performance, proprietary database developed by Google and described in the 2006 white paper “Bigtable: A Distributed Storage System for Structured Data.”<a href="#filepos856135"><span class="calibre13"><span class="underline">[26]</span></span></a> Initially created for natural-language processing, HBase started life as a contrib package for Apache Hadoop. Since then, it has become a top-level Apache project. </p><a></a><p class="calibre12"> On the architecture front, HBase is designed to be fault tolerant. Hardware failures may be uncommon for individual machines, but in a large cluster, node failure is the norm. By using write-ahead logging and distributed configuration, HBase can quickly recover from individual server failures. </p><a></a><p class="calibre12"> Additionally, HBase lives in an ecosystem that has its own complementary benefits. HBase is built on Hadoop—a sturdy, scalable computing platform that provides a distributed file system and mapreduce capabilities. Wherever you find HBase, you’ll find Hadoop and other infrastructural components that you can lever in your own applications. </p><a></a><p class="calibre12"> It is actively used and developed by a number of high-profile companies for their “Big Data” problems. Notably, Facebook chose HBase as a principal component of its new messaging infrastructure announced in November 2010. Stumbleupon has been using HBase for real-time data storage and analytics for several years, serving various site features directly from HBase. Twitter uses HBase extensively, ranging from data generation (for applications such as people search) to storing monitoring/performance data. The parade of companies using HBase also includes the likes of eBay, Meetup, Ning, Yahoo!, and many others. </p><a></a><p class="calibre12"> With all of this activity, new versions of HBase are coming out at a fairly rapid clip. At the time of this writing, the current stable version is 0.90.3, so that’s what we’ll be using. Go ahead and download HBase, and we’ll get started. </p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos623040" class="calibre1"><p class="calibre24" id="filepos623045"><span class="calibre25"><span class="bold"><span class="calibre26">4.2 Day 1: CRUD and Table Administration</span></span></span></p><a></a><p class="calibre27"> Today’s goal is to learn the nuts and bolts of working with HBase. We’ll get a local instance of HBase running in stand-alone mode, and then we’ll use the HBase shell to create and alter tables and to insert and modify data using basic commands. After that, we’ll explore how to perform some of those operations programmatically by using the HBase Java API in JRuby. Along the way, we’ll uncover some HBase architectural concepts, such as the relationship between rows, column families, columns, and values in a table. </p><a></a><p class="calibre12"> A fully operational, production-quality HBase cluster should really consist of no fewer than five nodes, or so goes the conventional wisdom. Such a setup would be overkill for our needs. Fortunately, HBase supports three running modes: </p><div class="calibre33"> </div><ul class="calibre34"><li value="1" class="calibre35"><p class="calibre22">Stand-alone mode is a single machine acting alone.</p></li><li value="2" class="calibre36"><p class="calibre22">Pseudodistributed mode is a single node pretending to be a cluster.</p></li><li value="3" class="calibre36"><p class="calibre22">Fully distributed mode is a cluster of nodes working together.</p></li></ul><a></a><p class="calibre12"> For most of this chapter, we’ll be running HBase in stand-alone mode. Even that can be a bit of a challenge, so although we won’t cover every aspect of installation and administration, we’ll give some relevant troubleshooting tips where appropriate. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Configuring HBase</span></span></span></p><a></a><p class="calibre29"> Before using HBase, it has to be configured. Configuration settings for HBase are kept in a file called <span class="calibre9"><span class="calibre30">hbase-site.xml</span></span>, which can be found in the <span class="calibre9"><span class="calibre30">${HBASE_HOME}/</span></span>
<span class="calibre9"><span class="calibre30">conf/</span></span> directory. Note that <span class="calibre9"><span class="calibre30">HBASE_HOME</span></span> is an environment variable pointing to the directory where HBase has been installed. </p><a></a><p class="calibre12"> Initially, this file contains just an empty <span class="calibre9"><span class="calibre30">&lt;configuration&gt;</span></span> tag. You can add any number of property definitions to your configuration using this format: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;property&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;name&gt;</span></span></span><span class="calibre9">some.property.name</span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;/name&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;value&gt;</span></span></span><span class="calibre9">A property value</span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;/value&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;/property&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> A full list of available properties, along with default values and descriptions, is available in <span class="calibre9"><span class="calibre30">hbase-default.xml</span></span> under <span class="calibre9"><span class="calibre30">${HBASE_HOME}/src/main/resources</span></span>. </p><a></a><p class="calibre12"> By default, HBase uses a temporary directory to store its data files. This means you’ll lose <span class="italic">all your data</span> whenever the operating system decides to reclaim the disk space. </p><a></a><p class="calibre12"> To keep your data around, you should specify an involatile storage location. Set the <span class="calibre9"><span class="calibre30">hbase.rootdir</span></span> property to an appropriate path like so: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;property&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;name&gt;</span></span></span><span class="calibre9">hbase.rootdir</span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;/name&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;value&gt;</span></span></span><span class="calibre9">file:///path/to/hbase</span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;/value&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;/property&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> To start HBase, open a terminal (command prompt) and run this command: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​${HBASE_HOME}/bin/start-hbase.sh​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> To shut down HBase, use the <span class="calibre9"><span class="calibre30">stop-hbase.sh</span></span> command in the same directory. </p><a></a><p class="calibre12"> If anything goes wrong, take a look at the most recently modified files in the <span class="calibre9"><span class="calibre30">${HBASE_HOME}/logs</span></span> directory. On *nix-based systems, the following command will pipe the latest log data to the console as it’s written: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">cd</span></span></span><span class="calibre9"> ${HBASE_HOME}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​find ./logs -name </span><span class="calibre9"><span class="italic"><span class="calibre38">"hbase-*.log"</span></span></span><span class="calibre9"> -exec tail -f {} \;​</span><span class="calibre9">​</span></p></td></tr></table><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">The HBase Shell</span></span></span></p><a></a><p class="calibre29"> The HBase shell is a JRuby-based command-line program you can use to interact with HBase. In the shell, you can add and remove tables, alter table schema, add or delete data, and do a bunch of other tasks. Later we’ll explore other means of connecting to HBase, but for now the shell will be our home. </p><a></a><p class="calibre12"> With HBase running, open a terminal and fire up the HBase shell: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​${HBASE_HOME}/bin/hbase shell​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> To confirm that it’s working properly, try asking it for version information. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​hbase&gt;</span><span class="calibre9"><span class="bold"><span class="calibre44"> version</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​0.90.3, r1100350, Sat May  7 13:31:12 PDT 2011​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You can enter <span class="calibre9"><span class="calibre30">help</span></span> at any time to see a list of available commands or to get usage information about a particular command. </p><a></a><p class="calibre12"> Next, execute the <span class="calibre9"><span class="calibre30">status</span></span> command to see how your HBase server is holding up.</p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​hbase&gt;</span><span class="calibre9"><span class="bold"><span class="calibre44"> status</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1 servers, 0 dead, 2.0000 average load​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If an error occurs for any of these commands or if the shell hangs, it could be a connection problem. HBase does its best to automatically configure its services based on your network setup, but sometimes it gets it wrong. If you’re seeing these symptoms, check out <a href="#filepos634523"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">HBase Network Settings</span></span><span class="calibre13"><span class="underline">​</span></span></a>. </p><a id="filepos634523"></a><blockquote class="calibre40"><span class="calibre41"><span class="bold">HBase Network Settings</span></span></blockquote><a></a><blockquote class="calibre42"><span class="calibre41"> By default, HBase tries to make its services available to external clients, but in our case, we simply need to connect from the same machine. So, it might help to add some or all of the following properties to your </span><span class="calibre9"><span class="calibre30">hbase-site.xml</span></span><span class="calibre41"> file (your mileage may vary). Note that the values in the following table will help only if you plan to connect locally and not remotely: </span></blockquote><br class="calibre1"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><th valign="top" class="calibre57"><span class="calibre41"><span class="bold"><span class="calibre58">   </span></span></span><blockquote class="calibre59"><span class="calibre41"><span class="bold">property name  </span></span></blockquote></th><th valign="top" class="calibre57"><span class="calibre41"><span class="bold"><span class="calibre58">   </span></span></span><blockquote class="calibre59"><span class="calibre41"><span class="bold">value  </span></span></blockquote></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre41">   </span><blockquote class="calibre59"><span class="calibre41">hbase.master.dns.interface  </span></blockquote></td><td valign="top" class="calibre16"><span class="calibre41">   </span><blockquote class="calibre59"><span class="calibre41">lo  </span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre41">   </span><blockquote class="calibre59"><span class="calibre41">hbase.master.info.bindAddress  </span></blockquote></td><td valign="top" class="calibre16"><span class="calibre41">   </span><blockquote class="calibre59"><span class="calibre41">127.0.0.1  </span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre41">   </span><blockquote class="calibre59"><span class="calibre41">hbase.regionserver.info.bindAddress  </span></blockquote></td><td valign="top" class="calibre16"><span class="calibre41">   </span><blockquote class="calibre59"><span class="calibre41">127.0.0.1  </span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre41">   </span><blockquote class="calibre59"><span class="calibre41">hbase.regionserver.dns.interface  </span></blockquote></td><td valign="top" class="calibre16"><span class="calibre41">   </span><blockquote class="calibre59"><span class="calibre41">lo  </span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre41">   </span><blockquote class="calibre59"><span class="calibre41">hbase.zookeeper.dns.interface  </span></blockquote></td><td valign="top" class="calibre16"><span class="calibre41">   </span><blockquote class="calibre59"><span class="calibre41">lo  </span></blockquote></td></tr></table><a></a><blockquote class="calibre76"><span class="calibre41"> The properties tell HBase how to establish connections for the master server and region servers (both of which we’ll discuss later) and the zookeeper configuration service. The properties with the value “lo” refer to the so-called loopback interface. On *nix systems, the loopback interface is not a real network interface (like your Ethernet or wireless cards) but rather a software-only interface for the computer to use to connect to itself. The </span><span class="calibre9"><span class="calibre30">bindAddress</span></span><span class="calibre41"> properties tell HBase what IP address to try to listen on. </span></blockquote><p class="calibre61"><span class="calibre5"><span class="bold"><span class="calibre28">Creating a Table</span></span></span></p><a></a><p class="calibre29"> A map is a key-value pair, like a hash in Ruby or a hashmap in Java. A table in HBase is basically a big map. Well, more accurately, it’s a map of maps. </p><a></a><p class="calibre12"> In an HBase table, keys are arbitrary strings that each map to a <span class="italic">row</span> of data. A row is itself a map, in which keys are called <span class="italic">columns</span> and values are uninterpreted arrays of bytes. Columns are grouped into <span class="italic">column families</span>, so a column’s full name consists of two parts: the column family name and the <span class="italic">column qualifier</span>. Often these are concatenated together using a colon (for example, <span class="calibre9"><span class="calibre30">’family:qualifier’</span></span>). </p><a></a><p class="calibre12"> To illustrate these concepts, take a look at Figure 13, <a href="#filepos639079"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">HBase tables consist of rows, keys, column families, columns, and values</span></span><span class="calibre13"><span class="underline">​</span></span></a>. </p><a id="filepos639079"></a><blockquote class="calibre10"><img src="images/00034.jpg" class="calibre77"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 13. HBase tables consist of rows, keys, column families, columns, and values.</span></blockquote><a></a><p class="calibre12"> In this figure, we have a hypothetical table with two column families: <span class="calibre9"><span class="calibre30">color</span></span> and <span class="calibre9"><span class="calibre30">shape</span></span>. The table has two rows—denoted by dashed boxes—identified by their row keys: <span class="calibre9"><span class="calibre30">first</span></span> and <span class="calibre9"><span class="calibre30">second</span></span>. Looking at just the <span class="calibre9"><span class="calibre30">first</span></span> row, we see that it has three columns in the <span class="calibre9"><span class="calibre30">color</span></span> column family (with qualifiers <span class="calibre9"><span class="calibre30">red</span></span>, <span class="calibre9"><span class="calibre30">blue</span></span>, and <span class="calibre9"><span class="calibre30">yellow</span></span>) and one column in the <span class="calibre9"><span class="calibre30">shape</span></span> column family (<span class="calibre9"><span class="calibre30">square</span></span>). The combination of row key and column name (including both family and qualifier) creates an address for locating data. In this example, the tuple <span class="calibre9"><span class="calibre30">first/color:red</span></span> points us to the value <span class="calibre9"><span class="calibre30">’#F00’</span></span>. </p><a></a><p class="calibre12"> Now let’s take what we’ve learned about table structure and use it to do something fun—we’re going to make a wiki! </p><a></a><p class="calibre12"> There are lots of juicy info bits we might want to associate with a wiki, but we’ll start with the bare minimum. A wiki contains pages, each of which has a unique title string and contains some article text. </p><a></a><p class="calibre12"> Use the <span class="calibre9"><span class="calibre30">create</span></span> command to make our wiki table: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​hbase&gt;</span><span class="calibre9"><span class="bold"><span class="calibre44"> create 'wiki', 'text'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​0 row(s) in 1.2160 seconds​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Here, we’re creating a table called <span class="calibre9"><span class="calibre30">wiki</span></span> with a single column family called <span class="calibre9"><span class="calibre30">text</span></span>. The table is currently empty; it has no rows and thus no columns. Unlike a relational database, in HBase a column is specific to the row that contains it. When we start adding rows, we’ll add columns to store data at the same time. </p><a></a><p class="calibre12"> Visualizing our table architecture, we arrive at something like Figure 14, <a href="#filepos643068"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">The wiki table has one column family</span></span><span class="calibre13"><span class="underline">​</span></span></a>. By our own convention, we expect each row to have exactly one column within the <span class="calibre9"><span class="calibre30">text</span></span> family, qualified by the empty string (<span class="calibre9"><span class="calibre30">”</span></span>). So, the full column name containing the text of a page will be <span class="calibre9"><span class="calibre30">’text:’</span></span>. </p><a></a><p class="calibre12"> Of course, for our wiki table to be useful, it’s going to need content. Let’s add some! </p><a id="filepos643068"></a><blockquote class="calibre10"><img src="images/00028.jpg" class="calibre77"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 14. The wiki table has one column family.</span></blockquote><p class="calibre23"><span class="calibre5"><span class="bold"><span class="calibre28">Inserting, Updating, and Retrieving Data</span></span></span></p><a></a><p class="calibre29"> Our wiki needs a Home page, so we’ll start with that. To add data to an HBase table, use the <span class="calibre9"><span class="calibre30">put</span></span> command: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​hbase&gt;</span><span class="calibre9"><span class="bold"><span class="calibre44"> put 'wiki', 'Home', 'text:', 'Welcome to the wiki!'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This command inserts a new row into the wiki table with the key <span class="calibre9"><span class="calibre30">’Home’</span></span>, adding <span class="calibre9"><span class="calibre30">’Welcome to the wiki!’</span></span> to the column called <span class="calibre9"><span class="calibre30">’text:’</span></span>. </p><a></a><p class="calibre12"> We can query the data for the <span class="calibre9"><span class="calibre30">’Home’</span></span> row using <span class="calibre9"><span class="calibre30">get</span></span>, which requires two parameters: the table name and the row key. You can optionally specify a list of columns to return. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​hbase&gt;</span><span class="calibre9"><span class="bold"><span class="calibre44"> get 'wiki', 'Home', 'text:'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​COLUMN    CELL​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ text:    timestamp=1295774833226, value=Welcome to the wiki!​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1 row(s) in 0.0590 seconds​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Notice the <span class="calibre9"><span class="calibre30">timestamp</span></span> field in the output. HBase stores an integer timestamp for all data values, representing time in milliseconds since the epoch (00:00:00 UTC on January 1, 1970). When a new value is written to the same cell, the old value hangs around, indexed by its timestamp. This is a pretty awesome feature. Most databases require you to specifically handle historical data yourself, but in HBase, versioning is baked right in! </p><a id="filepos646517"></a><blockquote class="calibre40"><span class="calibre41"><span class="bold">Case Study: Facebook's Messaging Index Table</span></span></blockquote><a></a><blockquote class="calibre42"><span class="calibre41"> Facebook uses HBase as a principal component of its messaging infrastructure, both for storing message data and for maintaining an inverted index for search. </span></blockquote><a></a><blockquote class="calibre47"><span class="calibre41"> In its index table schema: </span></blockquote><div class="calibre78"> </div><ul class="calibre34"><li value="1" class="calibre35"><blockquote class="calibre42"><span class="calibre41">The row keys are user IDs.</span></blockquote></li><li value="2" class="calibre79"><blockquote class="calibre42"><span class="calibre41">Column qualifiers are words that appear in that user’s messages.</span></blockquote></li><li value="3" class="calibre79"><blockquote class="calibre42"><span class="calibre41">Timestamps are message IDs of messages that contain that word.</span></blockquote></li></ul><a></a><blockquote class="calibre47"><span class="calibre41"> Since messages between users are immutable, the index entries for a message are static as well. The concept of versioned values doesn’t make sense. </span></blockquote><a></a><blockquote class="calibre47"><span class="calibre41"> For Facebook, manipulating the timestamp to match message IDs gives them another dimension for storing data. </span></blockquote><p class="calibre43"><span class="bold"><span class="calibre28">Put and Get</span></span></p><a></a><p class="calibre37"> The <span class="calibre9"><span class="calibre30">put</span></span> and <span class="calibre9"><span class="calibre30">get</span></span> commands allow you to specify a timestamp explicitly. If using milliseconds since the epoch doesn’t strike your fancy, you can specify another integer value of your choice. This gives you an extra dimension to work with if you need it. If you don’t specify a timestamp, HBase will use the current time when inserting, and it will return the most recent version when reading. </p><a></a><p class="calibre12"> For an example of how one company chose to overload the timestamp field, see <a href="#filepos646517"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Case Study: Facebook’s Messaging Index Table</span></span><span class="calibre13"><span class="underline">​</span></span></a>. In the rest of this chapter, we’ll continue to use the default timestamp interpretation. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Altering Tables</span></span></span></p><a></a><p class="calibre29"> So far, our wiki schema has pages with titles, text, and an integrated version history but nothing else. Let’s expand our requirements to include the following: </p><div class="calibre33"> </div><ul class="calibre34"><li value="1" class="calibre35"><p class="calibre22">In our wiki, a page is uniquely identified by its title.</p></li><li value="2" class="calibre36"><p class="calibre22">A page can have unlimited revisions.</p></li><li value="3" class="calibre36"><p class="calibre22">A revision is identified by its timestamp.</p></li><li value="4" class="calibre36"><p class="calibre22">A revision contains text and optionally a commit comment.</p></li><li value="5" class="calibre36"><p class="calibre22">A revision was made by an author, identified by name.</p></li></ul><a></a><p class="calibre12"> Visually, our requirements can be sketched, like in Figure 15, <a href="#filepos651504"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Requirements for a wiki page (including time dimension)</span></span><span class="calibre13"><span class="underline">​</span></span></a>. In this abstract representation of our requirements for a page, we see that each revision has an author, a commit comment, some article text, and a timestamp. The title of a page is not part of a revision, because it’s the identifier we use to denote revisions belonging to the same page. </p><a></a><p class="calibre12"> Mapping our vision to an HBase table takes a somewhat different form, as illustrated in Figure 16, <a href="#filepos651806"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Updated wiki table architecture (time dimension not shown)</span></span><span class="calibre13"><span class="underline">​</span></span></a>. Our wiki table uses the title as the row key and will group other page data into two column families called <span class="calibre9"><span class="calibre30">text</span></span> and <span class="calibre9"><span class="calibre30">revision</span></span>. The <span class="calibre9"><span class="calibre30">text</span></span> column family is the same as before; we expect each row to have exactly one column, qualified by the empty string (<span class="calibre9"><span class="calibre30">”</span></span>), to hold the article contents. The job of the <span class="calibre9"><span class="calibre30">revision</span></span> column family is to hold other revision-specific data, such as the author and commit comment. </p><a id="filepos651504"></a><blockquote class="calibre10"><img src="images/00030.jpg" class="calibre80"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 15. Requirements for a wiki page (including time dimension)</span></blockquote><a id="filepos651806"></a><blockquote class="calibre2"><img src="images/00035.jpg" class="calibre77"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 16. Updated wiki table architecture (time dimension not shown)</span></blockquote><p class="calibre23"><span class="bold"><span class="calibre28">Defaults</span></span></p><a></a><p class="calibre37"> We created the wiki table with no special options, so all the HBase default values were used. One such default value is to keep only three <span class="calibre9"><span class="calibre30">VERSIONS</span></span> of column values, so let’s increase that. To make schema changes, first we have to take the table offline with the <span class="calibre9"><span class="calibre30">disable</span></span> command. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​hbase&gt;</span><span class="calibre9"><span class="bold"><span class="calibre44"> disable 'wiki'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​0 row(s) in 1.0930 seconds​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Now we can modify column family characteristics using the <span class="calibre9"><span class="calibre30">alter</span></span> command. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​hbase&gt;</span><span class="calibre9"><span class="bold"><span class="calibre44"> alter 'wiki', { NAME =&gt; 'text', VERSIONS =&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre38">hbase*</span></span></span><span class="calibre9">   </span><span class="calibre9"><span class="bold"><span class="calibre44">org.apache.hadoop.hbase.HConstants::ALL_VERSIONS }</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​0 row(s) in 0.0430 seconds​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Here, we’re instructing HBase to alter the <span class="calibre9"><span class="calibre30">text</span></span> column family’s <span class="calibre9"><span class="calibre30">VERSIONS</span></span> attribute. There are a number of other attributes we could have set, some of which we’ll discuss in Day 2. The <span class="calibre9"><span class="calibre30">hbase*</span></span> line means that it’s a continuation of the previous line. </p><p class="calibre12"><span class="bold"><span class="calibre28">Altering a Table</span></span></p><a></a><p class="calibre37"> Operations that alter column family characteristics can be very expensive because HBase has to create a new column family with the chosen specifications and then copy all the data over. In a production system, this may incur significant downtime. For this reason, settling on column family options up front is a good thing. </p><a></a><p class="calibre12"> With the wiki table still disabled, let’s add the <span class="calibre9"><span class="calibre30">revision</span></span> column family, again using the <span class="calibre9"><span class="calibre30">alter</span></span> command: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​hbase&gt;</span><span class="calibre9"><span class="bold"><span class="calibre44"> alter 'wiki', { NAME =&gt; 'revision', VERSIONS =&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre38">hbase*</span></span></span><span class="calibre9">   </span><span class="calibre9"><span class="bold"><span class="calibre44">org.apache.hadoop.hbase.HConstants::ALL_VERSIONS }</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​0 row(s) in 0.0660 seconds​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Just as before, with the <span class="calibre9"><span class="calibre30">text</span></span> family, we’re only adding a <span class="calibre9"><span class="calibre30">revision</span></span> <span class="italic">column family</span> to the table schema, not individual <span class="italic">columns</span>. Though we expect each row to eventually contain a <span class="calibre9"><span class="calibre30">revision:author</span></span> and <span class="calibre9"><span class="calibre30">revision:comment</span></span>, it’s up to the client to honor this expectation; it’s not written into any formal schema. If someone wants to add a <span class="calibre9"><span class="calibre30">revision:foo</span></span> for a page, HBase won’t stop them. </p><p class="calibre12"><span class="bold"><span class="calibre28">Moving On</span></span></p><a></a><p class="calibre37"> With these additions in place, let’s reenable our wiki: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​hbase&gt;</span><span class="calibre9"><span class="bold"><span class="calibre44"> enable 'wiki'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​0 row(s) in 0.0550 seconds​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Now that our wiki table has been modified to support our growing requirements list, we can start adding data to columns in the <span class="calibre9"><span class="calibre30">revision</span></span> column family. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Adding Data Programmatically</span></span></span></p><a></a><p class="calibre29"> As we’ve seen, the HBase shell is great for tasks such as manipulating tables. Sadly, the shell’s data insertion support isn’t the best. The <span class="calibre9"><span class="calibre30">put</span></span> command only allows setting one column value at a time, and in our newly updated schema, we need to add multiple column values simultaneously so they all share the same timestamp. We’re going to need to start scripting. </p><a></a><p class="calibre12"> The following script can be executed directly in the HBase shell, since the shell is also a JRuby interpreter. When run, it adds a new version of the text for the Home page, setting the author and comment fields at the same time. JRuby runs on the Java virtual machine (JVM), giving it access to the HBase Java code. These examples will not work with non-JVM Ruby. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/hbase/put_multiple_columns.rb"><span class="calibre41"><span class="calibre13"><span class="underline">hbase/put_multiple_columns.rb</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​import </span><span class="calibre9"><span class="italic"><span class="calibre38">'org.apache.hadoop.hbase.client.HTable'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​import </span><span class="calibre9"><span class="italic"><span class="calibre38">'org.apache.hadoop.hbase.client.Put'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">def</span></span></span><span class="calibre9"> jbytes( *args )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  args.map { |arg| arg.to_s.to_java_bytes }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​table = HTable.new( @hbase.configuration, </span><span class="calibre9"><span class="italic"><span class="calibre38">"wiki"</span></span></span><span class="calibre9"> )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​p = Put.new( *jbytes( </span><span class="calibre9"><span class="italic"><span class="calibre38">"Home"</span></span></span><span class="calibre9"> ) )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​p.add( *jbytes( </span><span class="calibre9"><span class="italic"><span class="calibre38">"text"</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">""</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">"Hello world"</span></span></span><span class="calibre9"> ) )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​p.add( *jbytes( </span><span class="calibre9"><span class="italic"><span class="calibre38">"revision"</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">"author"</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">"jimbo"</span></span></span><span class="calibre9"> ) )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​p.add( *jbytes( </span><span class="calibre9"><span class="italic"><span class="calibre38">"revision"</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">"comment"</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">"my first edit"</span></span></span><span class="calibre9"> ) )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​table.put( p )​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The <span class="calibre9"><span class="calibre30">import</span></span> lines bring references to useful HBase classes into the shell. This saves us from having to write out the full namespace later. Next, the <span class="calibre9"><span class="calibre30">jbytes</span></span> function takes any number of arguments and returns an array converted to Java byte arrays, as the HBase API methods demand. </p><a></a><p class="calibre12"> After that, we create a local variable (<span class="calibre9"><span class="calibre30">table</span></span>) pointing to our wiki table, using the <span class="calibre9"><span class="calibre30">@hbase</span></span> administration object for configuration information. </p><a></a><p class="calibre12"> Next we stage a commit operation by creating and preparing a new instance of <span class="calibre9"><span class="calibre30">Put</span></span>, which takes the row to be modified. In this case, we’re sticking with the Home page we’ve been working with thus far. Finally, we <span class="calibre9"><span class="calibre30">add</span></span> properties to our <span class="calibre9"><span class="calibre30">Put</span></span> instance and then call on the <span class="calibre9"><span class="calibre30">table</span></span> object to execute the <span class="calibre9"><span class="calibre30">put</span></span> operation we’ve prepared. The <span class="calibre9"><span class="calibre30">add</span></span> method has several forms; in our case, we used the three-argument version: <span class="calibre9"><span class="calibre30">add(column_family, column_qualifier, value)</span></span>. </p><p class="calibre12"><span class="bold"><span class="calibre28">Why Column Families?</span></span></p><a></a><p class="calibre37"> You may be tempted to build your whole structure without column families; why not store all of a row’s data in a single column family? That solution would be simpler to implement. But there are downsides to avoiding column families, namely, missing out on fine-grained performance tuning. Each column family’s performance options are configured independently. These settings affect things such as read and write speed and disk space consumption. </p><a></a><p class="calibre12"> All operations in HBase are atomic at the <span class="italic">row level</span>. No matter how many columns are affected, the operation will have a consistent view of the particular row being accessed or modified. This design decision helps clients reason intelligently about the data. </p><a></a><p class="calibre12"> Our <span class="calibre9"><span class="calibre30">put</span></span> operation affects several columns and doesn’t specify a timestamp, so all column values will have the same timestamp (the current time in milliseconds). Let’s verify by invoking <span class="calibre9"><span class="calibre30">get</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​hbase&gt;</span><span class="calibre9"><span class="bold"><span class="calibre44"> get 'wiki', 'Home'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​COLUMN             CELL​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ revision:author   timestamp=1296462042029, value=jimbo​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ revision:comment  timestamp=1296462042029, value=my first edit​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ text:             timestamp=1296462042029, value=Hello world​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​3 row(s) in 0.0300 seconds​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> As you can see, each column value listed previously has the same <span class="calibre9"><span class="calibre30">timestamp</span></span>. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Day 1 Wrap-Up</span></span></span></p><a></a><p class="calibre29"> Today, we got a firsthand look at a running HBase server. We learned how to configure it and monitor log files for troubleshooting. Using the HBase shell, we performed basic administration and data manipulation tasks. </p><a></a><p class="calibre12"> In modeling a wiki system, we explored schema design in HBase. We learned how to create tables and manipulate column families. Designing an HBase schema means making choices about column family options and, just as important, our semantic interpretation of features like timestamps and row keys. </p><a></a><p class="calibre12"> We also started poking around in the HBase Java API by executing JRuby code in the shell. In Day 2, we’ll take this a step further, using the shell to run custom scripts for big jobs like data import. </p><a></a><p class="calibre12"> Ideally you’ve begun to shrug off some of the relational concepts that burden terms such as <span class="italic">table</span>, <span class="italic">row</span>, and <span class="italic">column</span>. The difference between how HBase uses these terms and what they mean in other systems will become even starker as we explore deeper into HBase’s features. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Day 1 Homework</span></span></span></p><a></a><p class="calibre29"> HBase documentation online generally comes in two flavors: extremely technical and nonexistent. This is slowly changing as “getting started” guides start to appear, but be prepared to spend some time trolling through Javadoc or source code to find answers. </p><p class="calibre12"><span class="bold"><span class="calibre28">Find</span></span></p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Figure out how to use the shell to do the following:</p><div class="calibre33"> </div><ul class="calibre81"><li value="1" class="calibre35"><p class="calibre22">Delete individual column values in a row</p></li><li value="2" class="calibre36"><p class="calibre22">Delete an entire row</p></li></ul></li><li value="2" class="calibre36"><p class="calibre22">Bookmark the HBase API documentation for the version of HBase you’re using.</p></li></ol><p class="calibre12"><span class="bold"><span class="calibre28">Do</span></span></p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22"> Create a function called <span class="calibre9"><span class="calibre30">put_many</span></span> that creates a <span class="calibre9"><span class="calibre30">Put</span></span> instance, adds any number of column-value pairs to it, and commits it to a table. The signature should look like this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">def</span></span></span><span class="calibre9"> put_many( table_name, row, column_values )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="italic"><span class="calibre46"># your code here</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table></li><li value="2" class="calibre82"><p class="calibre22"> Define your <span class="calibre9"><span class="calibre30">put_many</span></span> function by pasting it in the HBase shell, and then call it like so: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​hbase&gt;</span><span class="calibre9"><span class="bold"><span class="calibre44"> put_many 'wiki', 'Some title', {</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre38">hbase*</span></span></span><span class="calibre9">   </span><span class="calibre9"><span class="bold"><span class="calibre44">"text:" =&gt; "Some article text",</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre38">hbase*</span></span></span><span class="calibre9">   </span><span class="calibre9"><span class="bold"><span class="calibre44">"revision:author" =&gt; "jschmoe",</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre38">hbase*</span></span></span><span class="calibre9">   </span><span class="calibre9"><span class="bold"><span class="calibre44">"revision:comment" =&gt; "no comment" }</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table></li></ol><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos676096" class="calibre1"><p class="calibre24" id="filepos676101"><span class="calibre25"><span class="bold"><span class="calibre26">4.3 Day 2: Working with Big Data</span></span></span></p><a></a><p class="calibre27"> With Day 1’s table creation and manipulation under our belts, it’s time to start adding some serious data to our wiki table. Today, we’ll script against the HBase APIs, ultimately streaming Wikipedia content right into our wiki! Along the way, we’ll pick up some performance tricks for making faster import jobs. Finally, we’ll poke around in HBase’s internals to see how it partitions data into regions, achieving both performance and disaster recovery goals. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Importing Data, Invoking Scripts</span></span></span></p><a></a><p class="calibre29"> One common problem people face when trying a new database system is how to migrate data into it. Handcrafting <span class="calibre9"><span class="calibre30">Put</span></span> operations with static strings, like we did in Day 1, is all well and good, but we can do better. </p><a></a><p class="calibre12"> Fortunately, pasting commands into the shell is not the only way to execute them. When you start the HBase shell from the command line, you can specify the name of a JRuby script to run. HBase will execute that script as though it were entered directly into the shell. The syntax looks like this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​${HBASE_HOME}/bin/hbase shell &lt;your_script&gt; [&lt;optional_arguments&gt; ...]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Since we’re interested specifically in “Big Data,” let’s create a script for importing Wikipedia articles into our wiki table. The WikiMedia Foundation—which oversees Wikipedia, Wictionary, and other projects—periodically publishes data dumps we can use. These dumps are in the form of enormous XML files. Here’s an example record from the English Wikipedia: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;page&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;title&gt;</span></span></span><span class="calibre9">Anarchism</span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;/title&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;id&gt;</span></span></span><span class="calibre9">12</span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;/id&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;revision&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;id&gt;</span></span></span><span class="calibre9">408067712</span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;/id&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;timestamp&gt;</span></span></span><span class="calibre9">2011-01-15T19:28:25Z</span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;/timestamp&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;contributor&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;username&gt;</span></span></span><span class="calibre9">RepublicanJacobite</span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;/username&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;id&gt;</span></span></span><span class="calibre9">5223685</span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;/id&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;/contributor&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;comment&gt;</span></span></span><span class="calibre9">Undid revision 408057615 by [[Special:Contributions...</span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;/comment&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;text</span></span></span><span class="calibre9"> xml:space=</span><span class="calibre9"><span class="italic"><span class="calibre38">"preserve"</span></span></span><span class="calibre9"><br class="calibre1"/></span><span class="calibre9"><span class="bold"><span class="calibre44">&gt;</span></span></span><span class="calibre9">{{Redirect|Anarchist|the fictional character|​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​...​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[[bat-smg:Anarkėzmos]]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;/text&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;/revision&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;/page&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Because we were so smart, this contains all the information we’ve already accounted for in our schema: title (row key), text, timestamp, and author. So, we ought to be able to write a script to import revisions without too much trouble. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Streaming XML</span></span></span></p><a></a><p class="calibre29"> First things first. We’ll need to parse the huge XML files in a streaming (SAX) fashion, so let’s start with that. The basic outline for parsing an XML file in JRuby, record by record, looks like this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/hbase/basic_xml_parsing.rb"><span class="calibre41"><span class="calibre13"><span class="underline">hbase/basic_xml_parsing.rb</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​import </span><span class="calibre9"><span class="italic"><span class="calibre38">'javax.xml.stream.XMLStreamConstants'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​factory = javax.xml.stream.XMLInputFactory.newInstance​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​reader = factory.createXMLStreamReader(java.lang.System.in)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">while</span></span></span><span class="calibre9"> reader.has_next​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  type = reader.next​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> type == XMLStreamConstants::START_ELEMENT​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    tag = reader.local_name​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre46"># do something with tag</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">elsif</span></span></span><span class="calibre9"> type == XMLStreamConstants::CHARACTERS​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    text = reader.text​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre46"># do something with text</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">elsif</span></span></span><span class="calibre9"> type == XMLStreamConstants::END_ELEMENT​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre46"># same as START_ELEMENT</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Breaking this down, there are a few parts worth mentioning. First, we produce an <span class="calibre9"><span class="calibre30">XMLStreamReader</span></span> and wire it up to <span class="calibre9"><span class="calibre30">java.lang.System.in</span></span>, which means it’ll be reading from standard input. </p><a></a><p class="calibre12"> Next, we set up a <span class="calibre9"><span class="calibre30">while</span></span> loop, which will continuously pull out tokens from the XML stream until there are none left. Inside the <span class="calibre9"><span class="calibre30">while</span></span> loop, we process the current token. What to do depends on whether the token is the start of an XML tag, the end of a tag, or the text in between. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Streaming Wikipedia</span></span></span></p><a></a><p class="calibre29"> Now we can combine this basic XML processing framework with our previous exploration of the <span class="calibre9"><span class="calibre30">HTable</span></span> and <span class="calibre9"><span class="calibre30">Put</span></span> interfaces. Here’s the resultant script. Most of it should look familiar, and we’ll discuss a few novel parts. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/hbase/import_from_wikipedia.rb"><span class="calibre41"><span class="calibre13"><span class="underline">hbase/import_from_wikipedia.rb</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​require </span><span class="calibre9"><span class="italic"><span class="calibre38">'time'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​import </span><span class="calibre9"><span class="italic"><span class="calibre38">'org.apache.hadoop.hbase.client.HTable'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​import </span><span class="calibre9"><span class="italic"><span class="calibre38">'org.apache.hadoop.hbase.client.Put'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​import </span><span class="calibre9"><span class="italic"><span class="calibre38">'javax.xml.stream.XMLStreamConstants'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">def</span></span></span><span class="calibre9"> jbytes( *args )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  args.map { |arg| arg.to_s.to_java_bytes }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​factory = javax.xml.stream.XMLInputFactory.newInstance​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​reader = factory.createXMLStreamReader(java.lang.System.in)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">① </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​document = nil ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​buffer = nil​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​count = 0​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​table = HTable.new( @hbase.configuration, </span><span class="calibre9"><span class="italic"><span class="calibre38">'wiki'</span></span></span><span class="calibre9"> )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">② </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​table.setAutoFlush( false ) ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">while</span></span></span><span class="calibre9"> reader.has_next​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  type = reader.next​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">③ </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> type == XMLStreamConstants::START_ELEMENT ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">case</span></span></span><span class="calibre9"> reader.local_name​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">when</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="italic"><span class="calibre38">'page'</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">then</span></span></span><span class="calibre9"> document = {}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">when</span></span></span><span class="calibre9"> /title|timestamp|username|comment|text/ </span><span class="calibre9"><span class="bold"><span class="calibre44">then</span></span></span><span class="calibre9"> buffer = []​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">④ </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">elsif</span></span></span><span class="calibre9"> type == XMLStreamConstants::CHARACTERS ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    buffer &lt;&lt; reader.text </span><span class="calibre9"><span class="bold"><span class="calibre44">unless</span></span></span><span class="calibre9"> buffer.nil?​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">⑤ </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">elsif</span></span></span><span class="calibre9"> type == XMLStreamConstants::END_ELEMENT ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">case</span></span></span><span class="calibre9"> reader.local_name​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">when</span></span></span><span class="calibre9"> /title|timestamp|username|comment|text/​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      document[reader.local_name] = buffer.join​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">when</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="italic"><span class="calibre38">'revision'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      key = document[</span><span class="calibre9"><span class="italic"><span class="calibre38">'title'</span></span></span><span class="calibre9">].to_java_bytes​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      ts = ( Time.parse document[</span><span class="calibre9"><span class="italic"><span class="calibre38">'timestamp'</span></span></span><span class="calibre9">] ).to_i​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      p = Put.new( key, ts )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      p.add( *jbytes( </span><span class="calibre9"><span class="italic"><span class="calibre38">"text"</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">""</span></span></span><span class="calibre9">, document[</span><span class="calibre9"><span class="italic"><span class="calibre38">'text'</span></span></span><span class="calibre9">] ) )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      p.add( *jbytes( </span><span class="calibre9"><span class="italic"><span class="calibre38">"revision"</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">"author"</span></span></span><span class="calibre9">, document[</span><span class="calibre9"><span class="italic"><span class="calibre38">'username'</span></span></span><span class="calibre9">] ) )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      p.add( *jbytes( </span><span class="calibre9"><span class="italic"><span class="calibre38">"revision"</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">"comment"</span></span></span><span class="calibre9">, document[</span><span class="calibre9"><span class="italic"><span class="calibre38">'comment'</span></span></span><span class="calibre9">] ) )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      table.put( p )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      count += 1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      table.flushCommits() </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> count % 10 == 0​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> count % 500 == 0​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        puts </span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">#{count}</span><span class="calibre9"><span class="italic"><span class="calibre38"> records inserted (</span></span></span><span class="calibre9">#{document[</span><span class="calibre9"><span class="italic"><span class="calibre38">'title'</span></span></span><span class="calibre9">]}</span><span class="calibre9"><span class="italic"><span class="calibre38">)"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​table.flushCommits()​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​exit​</span><span class="calibre9">​</span></p></td></tr></table><p class="calibre12">①</p><a></a><blockquote class="calibre42"> The first difference of note is the introduction of a few variables: </blockquote><div class="calibre33"> </div><ul class="calibre34"><li value="1" class="calibre35"><blockquote class="calibre42"><span class="calibre9"><span class="calibre30">document</span></span>: Holds the current article and revision data</blockquote></li><li value="2" class="calibre36"><blockquote class="calibre42"><span class="calibre9"><span class="calibre30">buffer</span></span>: Holds character data for the current field within the document (text, title, author, and so on)</blockquote></li><li value="3" class="calibre36"><blockquote class="calibre42"><span class="calibre9"><span class="calibre30">count</span></span>: Keeps track of how many articles we’ve imported so far</blockquote></li></ul><p class="calibre12">②</p><a></a><blockquote class="calibre42"> Pay special attention to the use of <span class="calibre9"><span class="calibre30">table</span></span>.<span class="calibre9"><span class="calibre30">setAutoFlush(false)</span></span>. In HBase, data is <span class="italic">automatically flushed</span> to disk periodically. This is preferred in most applications. By disabling autoflush in our script, any <span class="calibre9"><span class="calibre30">put</span></span> operations we execute will be buffered until we call <span class="calibre9"><span class="calibre30">table</span></span>.<span class="calibre9"><span class="calibre30">flushCommits</span></span>. This allows us to batch up writes and execute them when it’s convenient for us. </blockquote><p class="calibre12">③</p><a></a><blockquote class="calibre42"> Next, let’s look at what happens in parsing. If the start tag is a <span class="calibre9"><span class="calibre30">&lt;page&gt;</span></span>, then reset <span class="calibre9"><span class="calibre30">document</span></span> to an empty hash. Otherwise, if it’s another tag we care about, reset <span class="calibre9"><span class="calibre30">buffer</span></span> for storing its text. </blockquote><p class="calibre12">④</p><a></a><blockquote class="calibre42"> We handle character data by appending it to the buffer. </blockquote><p class="calibre12">⑤</p><a></a><blockquote class="calibre42"> For most closing tags, we just stash the buffered contents into the <span class="calibre9"><span class="calibre30">document</span></span>. If the closing tag is a <span class="calibre9"><span class="calibre30">&lt;/revision&gt;</span></span>, however, we create a new <span class="calibre9"><span class="calibre30">Put</span></span> instance, fill it with the <span class="calibre9"><span class="calibre30">document</span></span>’s fields, and submit it to the table. After that, we use <span class="calibre9"><span class="calibre30">flushCommits</span></span> if we haven’t done so in a while and report progress to standard out (<span class="calibre9"><span class="calibre30">puts</span></span>). </blockquote><p class="calibre12" id="filepos716429"><span class="calibre5"><span class="bold"><span class="calibre28">Compression and Bloom Filters</span></span></span></p><a></a><p class="calibre29"> We’re almost ready to run the script; we just have one more bit of housecleaning to do first. The <span class="calibre9"><span class="calibre30">text</span></span> column family is going to contain big blobs of text content; it would benefit from some compression. Let’s enable compression and fast lookups: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​hbase&gt;</span><span class="calibre9"><span class="bold"><span class="calibre44"> alter 'wiki', {NAME=&gt;'text', COMPRESSION=&gt;'GZ', BLOOMFILTER=&gt;'ROW'}</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​0 row(s) in 0.0510 seconds​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> HBase supports two compression algorithms: Gzip (GZ) and Lempel-Ziv-Oberhumer (LZO). The HBase community highly recommends using LZO over Gzip, pretty much unilaterally, but here we’re using GZ. </p><a></a><p class="calibre12"> The problem with LZO is the implementation’s license. While open source, it’s not compatible with Apache’s licensing philosophy, so LZO can’t be bundled with HBase. Detailed instructions are available online for installing and configuring LZO support. If you want high-performance compression, get LZO. </p><a></a><p class="calibre12"> A Bloom filter is a really cool data structure that efficiently answers the question, “Have I ever seen this thing before?” Originally developed by Burton Howard Bloom in 1970 for use in spell-checking applications, Bloom filters have become popular in data storage applications for determining quickly whether a key exists. If you’re unfamiliar with Bloom filters, they’re explained briefly in <a href="#filepos718808"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">How Do Bloom Filters Work?</span></span><span class="calibre13"><span class="underline">​</span></span></a>. </p><a id="filepos718808"></a><blockquote class="calibre40"><span class="calibre41"><span class="bold">How Do Bloom Filters Work?</span></span></blockquote><a></a><blockquote class="calibre42"><span class="calibre41"> Without going too deep into implementation details, a Bloom filter manages a statically sized array of bits initially set to 0. Each time a new blob of data is presented to the filter, some of the bits are flipped to 1. Determining which bits to flip depends on generating a hash from the data and turning that hash into a set of bit positions. </span></blockquote><a></a><blockquote class="calibre47"><span class="calibre41"> Later, to test whether the filter has been presented with a particular blob in the past, the filter figures out which bits would have to be 1 and checks them. If any are 0, then the filter can unequivocally say “no.” If all of the bits are 1, then it reports “yes”; chances are it has been presented with that blob before, but false positives are increasingly likely as more blobs are entered. </span></blockquote><a></a><blockquote class="calibre47"><span class="calibre41"> This is the trade-off of using a Bloom filter as opposed to a simple hash. A hash will never produce a false positive, but the space needed to store that data is unbounded. Bloom filters use a constant amount of space but will occasionally produce false positives at a predictable rate based on saturation. </span></blockquote><a></a><p class="calibre43"> HBase supports using Bloom filters to determine whether a particular column exists for a given row key (<span class="calibre9"><span class="calibre30">BLOOMFILTER=&gt;’ROWCOL’</span></span>) or just whether a given row key exists at all (<span class="calibre9"><span class="calibre30">BLOOMFILTER=&gt;’ROW’</span></span>). The number of columns within a column family and the number of rows are both potentially unbounded. Bloom filters offer a fast way of determining whether data exists before incurring an expensive disk read. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Engage!</span></span></span></p><a></a><p class="calibre29"> Now we’re ready to kick off the script. Remember that these files are enormous, so downloading and unzipping them is pretty much out of the question. So, what are we going to do? </p><a></a><p class="calibre12"> Fortunately, through the magic of *nix pipes, we can download, extract, and feed the XML into the script all at once. The command looks like this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​curl &lt;dump_url&gt; | bzcat | \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​${HBASE_HOME}/bin/hbase shell import_from_wikipedia.rb​</span><span class="calibre9">​</span></p></td></tr></table><p class="calibre45" id="filepos721894"> Note that you should replace <span class="calibre9"><span class="calibre30">&lt;dump_url&gt;</span></span> with the URL of a WikiMedia Foundation dump file of some kind.<a href="#filepos856135"><span class="calibre13"><span class="underline">[27]</span></span></a> You should use <span class="calibre9"><span class="calibre30">[project]-latest-pages-articles.xml.bz2</span></span> for either the English Wikipedia (~6GB)<a href="#filepos856135"><span class="calibre13"><span class="underline">[28]</span></span></a> or the English Wiktionary (~185MB).<a href="#filepos856135"><span class="calibre13"><span class="underline">[29]</span></span></a> These files contain all the most recent revisions of pages in the <span class="calibre9"><span class="calibre30">Main</span></span> namespace. That is, they omit user pages, discussion pages, and so on. </p><a></a><p class="calibre12"> Plug in the URL and run it! You should see output like this (eventually): </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​500 records inserted (Ashmore and Cartier Islands)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1000 records inserted (Annealing)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1500 records inserted (Ajanta Caves)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> It’ll happily chug along as long as you let it or until it encounters an error, but you’ll probably want to shut it off after a while. When you’re ready to kill the script, press <span class="calibre69"><span class="calibre30">Ctrl</span></span>+<span class="calibre69"><span class="calibre30">C</span></span>. For now, though, let’s leave it running so we can take a peek under the hood and learn about how HBase achieves its horizontal scalability. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Introduction to Regions and Monitoring Disk Usage</span></span></span></p><a></a><p class="calibre29"> In HBase, rows are kept in order, sorted by the row key. A region is a chunk of rows, identified by the starting key (inclusive) and ending key (exclusive). Regions never overlap, and each is assigned to a specific region server in the cluster. In our simplistic stand-alone server, there is only one region server, which will always be responsible for all regions. A fully distributed cluster would consist of many region servers. </p><a></a><p class="calibre12"> So, let’s take a look at your HBase server’s disk usage, which will give us insight into how the data is laid out. You can inspect HBase’s disk usage by opening a command prompt to the <span class="calibre9"><span class="calibre30">hbase.rootdir</span></span> location you specified earlier and executing the <span class="calibre9"><span class="calibre30">du</span></span> command. <span class="calibre9"><span class="calibre30">du</span></span> is a standard *nix command-line utility that tells you how much space is used by a directory and its children, recursively. The <span class="calibre9"><span class="calibre30">-h</span></span> option tells <span class="calibre9"><span class="calibre30">du</span></span> to report numbers in human-readable form. </p><a></a><p class="calibre12"> Here’s what ours looked like after about 12,000 pages had been inserted and the import was still running: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">du -h</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​231M    ./.logs/localhost.localdomain,38556,1300092965081​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​231M    ./.logs​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​4.0K    ./.META./1028785192/info​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​12K     ./.META./1028785192/.oldlogs​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​28K     ./.META./1028785192​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​32K     ./.META.​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​12K     ./-ROOT-/70236052/info​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​12K     ./-ROOT-/70236052/.oldlogs​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​36K     ./-ROOT-/70236052​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​40K     ./-ROOT-​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​72M     ./wiki/517496fecabb7d16af7573fc37257905/text​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1.7M    ./wiki/517496fecabb7d16af7573fc37257905/revision​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​61M     ./wiki/517496fecabb7d16af7573fc37257905/.tmp​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​12K     ./wiki/517496fecabb7d16af7573fc37257905/.oldlogs​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​134M    ./wiki/517496fecabb7d16af7573fc37257905​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​134M    ./wiki​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​4.0K    ./.oldlogs​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​365M    .​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This output tells us a lot about how much space HBase is using and how it’s allocated. The lines starting with <span class="calibre9"><span class="calibre30">/wiki</span></span> describe the space usage for the <span class="calibre9"><span class="calibre30">wiki</span></span> table. The long-named subdirectory <span class="calibre9"><span class="calibre30">517496fecabb7d16af7573fc37257905</span></span> represents an individual region (the only region so far). Under that, the directories <span class="calibre9"><span class="calibre30">/text</span></span> and <span class="calibre9"><span class="calibre30">/revision</span></span> correspond to the <span class="calibre9"><span class="calibre30">text</span></span> and <span class="calibre9"><span class="calibre30">revision</span></span> column families, respectively. Finally, the last line sums up all these values, telling us that HBase is using 365MB of disk space. </p><a></a><p class="calibre12"> One more thing. The first two lines at the top of output, starting with <span class="calibre9"><span class="calibre30">/.logs</span></span>, show us the space used by the write-ahead log (WAL) files. HBase uses write-ahead logging to provide protection against node failures. This is a fairly typical disaster recovery technique. For instance, write-ahead logging in file systems is called <span class="italic">journaling</span>. In HBase, logs are appended to the WAL before any edit operations (put and increment) are persisted to disk. </p><a></a><p class="calibre12"> For performance reasons, edits are not necessarily written to disk immediately. The system does much better when I/O is buffered and written to disk in chunks. If the <span class="italic">region server</span> responsible for the affected region were to crash during this limbo period, HBase would use the WAL to determine which operations were successful and take corrective action. </p><a></a><p class="calibre12"> Writing to the WAL is optional and enabled by default. Edit classes like <span class="calibre9"><span class="calibre30">Put</span></span> and <span class="calibre9"><span class="calibre30">Increment</span></span> have a setter method called <span class="calibre9"><span class="calibre30">setWriteToWAL</span></span> that can be used to exclude the operation from being written to the WAL. Generally you’ll want to keep the default option, but in some instances it might make sense to change it. For example, if you’re running an import job that you can rerun any time, like our Wikipedia import script, you might want to take the performance benefit of disabling WAL writes over the disaster recovery protection. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Regional Interrogation</span></span></span></p><a></a><p class="calibre29"> If you let the script run long enough, you’ll see HBase split the table into multiple regions. Here’s our <span class="calibre9"><span class="calibre30">du</span></span> output again, after about 150,000 pages have been added: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">du -h</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​40K     ./.logs/localhost.localdomain,55922,1300094776865​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​44K     ./.logs​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​24K     ./.META./1028785192/info​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​4.0K    ./.META./1028785192/recovered.edits​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​4.0K    ./.META./1028785192/.tmp​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​12K     ./.META./1028785192/.oldlogs​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​56K     ./.META./1028785192​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​60K     ./.META.​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​4.0K    ./.corrupt​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​12K     ./-ROOT-/70236052/info​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​4.0K    ./-ROOT-/70236052/recovered.edits​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​4.0K    ./-ROOT-/70236052/.tmp​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​12K     ./-ROOT-/70236052/.oldlogs​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​44K     ./-ROOT-/70236052​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​48K     ./-ROOT-​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​138M    ./wiki/0a25ac7e5d0be211b9e890e83e24e458/text​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​5.8M    ./wiki/0a25ac7e5d0be211b9e890e83e24e458/revision​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​4.0K    ./wiki/0a25ac7e5d0be211b9e890e83e24e458/.tmp​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​144M    ./wiki/0a25ac7e5d0be211b9e890e83e24e458​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​149M    ./wiki/15be59b7dfd6e71af9b828fed280ce8a/text​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​6.5M    ./wiki/15be59b7dfd6e71af9b828fed280ce8a/revision​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​4.0K    ./wiki/15be59b7dfd6e71af9b828fed280ce8a/.tmp​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​155M    ./wiki/15be59b7dfd6e71af9b828fed280ce8a​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​145M    ./wiki/0ef3903982fd9478e09d8f17b7a5f987/text​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​6.3M    ./wiki/0ef3903982fd9478e09d8f17b7a5f987/revision​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​4.0K    ./wiki/0ef3903982fd9478e09d8f17b7a5f987/.tmp​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​151M    ./wiki/0ef3903982fd9478e09d8f17b7a5f987​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​135M    ./wiki/a79c0f6896c005711cf6a4448775a33b/text​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​6.0M    ./wiki/a79c0f6896c005711cf6a4448775a33b/revision​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​4.0K    ./wiki/a79c0f6896c005711cf6a4448775a33b/.tmp​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​141M    ./wiki/a79c0f6896c005711cf6a4448775a33b​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​591M    ./wiki​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​4.0K    ./.oldlogs​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​591M    .​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The biggest change is that the old region (<span class="calibre9"><span class="calibre30">517496fecabb7d16af7573fc37257905</span></span>) is now gone, replaced by four new ones. In our stand-alone server, all the regions are served by our singular server, but in a distributed environment, these would be parceled out to the various region servers. </p><a></a><p class="calibre12"> This raises a few questions, such as “How do the region servers know which regions they’re responsible for serving?” and “How can you find which region (and, by extension, which region server) is serving a given row?” </p><a></a><p class="calibre12"> If we drop back into the HBase shell, we can query the <span class="calibre9"><span class="calibre30">.META.</span></span> table to find out more about the current regions. <span class="calibre9"><span class="calibre30">.META.</span></span> is a special table whose sole purpose is to keep track of all the user tables and which region servers are responsible for serving the regions of those tables. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​hbase&gt;</span><span class="calibre9"><span class="bold"><span class="calibre44"> scan '.META.', { COLUMNS =&gt; [ 'info:server', 'info:regioninfo' ] }</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Even for a small number of regions, you should get a lot of output. Here’s a fragment of ours, formatted and truncated for readability: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ROW​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ wiki,,1300099733696.a79c0f6896c005711cf6a4448775a33b.​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​COLUMN+CELL​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  column=info:server, timestamp=1300333136393, value=localhost.localdomain:3555​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  column=info:regioninfo, timestamp=1300099734090, value=REGION =&gt; {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    NAME =&gt; 'wiki,,1300099733696.a79c0f6896c005711cf6a4448775a33b.',​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    STARTKEY =&gt; '',​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    ENDKEY =&gt; 'Demographics of Macedonia',​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    ENCODED =&gt; a79c0f6896c005711cf6a4448775a33b,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    TABLE =&gt; {{...}}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ROW​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  wiki,Demographics of Macedonia,1300099733696.0a25ac7e5d0be211b9e890e83e24e458.​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​COLUMN+CELL​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  column=info:server, timestamp=1300333136402, value=localhost.localdomain:35552​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  column=info:regioninfo, timestamp=1300099734011, value=REGION =&gt; {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    NAME =&gt; 'wiki,Demographics of Macedonia,1300099733696.0a25...e458.',​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    STARTKEY =&gt; 'Demographics of Macedonia',​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    ENDKEY =&gt; 'June 30',​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    ENCODED =&gt; 0a25ac7e5d0be211b9e890e83e24e458,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    TABLE =&gt; {{...}}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Both of the regions listed previously are served by the same server, <span class="calibre9"><span class="calibre30">localhost.localdomain:35552</span></span>. The first region starts at the empty string row (<span class="calibre9"><span class="calibre30">”</span></span>) and ends with <span class="calibre9"><span class="calibre30">’Demographics of Macedonia’</span></span>. The second region starts at <span class="calibre9"><span class="calibre30">’Demographics of Macedonia’</span></span> and goes to <span class="calibre9"><span class="calibre30">’June 30’</span></span>. </p><a></a><p class="calibre12"><span class="calibre9"><span class="calibre30">STARTKEY</span></span> is inclusive, while <span class="calibre9"><span class="calibre30">ENDKEY</span></span> is exclusive. So, if we were looking for the <span class="calibre9"><span class="calibre30">’Demographics of Macedonia’</span></span> row, we’d find it in the second region. </p><a></a><p class="calibre12"> Since rows are kept in sorted order, we can use the information stored in <span class="calibre9"><span class="calibre30">.META.</span></span> to look up the region and server where any given row should be found. But where is the <span class="calibre9"><span class="calibre30">.META.</span></span> table stored? </p><a></a><p class="calibre12"> It turns out that the <span class="calibre9"><span class="calibre30">.META.</span></span> table is split into regions and served by region servers just like any other table would be. To find out which servers have which parts of the <span class="calibre9"><span class="calibre30">.META.</span></span> table, we have to scan <span class="calibre9"><span class="calibre30">-ROOT-</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​hbase&gt;</span><span class="calibre9"><span class="bold"><span class="calibre44"> scan '-ROOT-', { COLUMNS =&gt; [ 'info:server', 'info:regioninfo' ] }</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ROW​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  .META.,,1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​COLUMN+CELL​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  column=info:server, timestamp=1300333135782, value=localhost.localdomain:35552​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  column=info:regioninfo, timestamp=1300092965825, value=REGION =&gt; {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    NAME =&gt; '.META.,,1',​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    STARTKEY =&gt; '',​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    ENDKEY =&gt; '',​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    ENCODED =&gt; 1028785192,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    TABLE =&gt; {{...}}​</span><span class="calibre9">​</span></p></td></tr></table><blockquote class="calibre40"><span class="calibre41"><span class="bold">Where's My TABLE Schema?</span></span></blockquote><a></a><blockquote class="calibre42"><span class="calibre41"> The </span><span class="calibre9"><span class="calibre30">TABLE</span></span><span class="calibre41"> schema has been removed from the example output of </span><span class="calibre9"><span class="calibre30">regioninfo</span></span><span class="calibre41"> scans. This reduces clutter, and we’ll be talking about performance-tuning options later. If you’re dying to see the schema definition for a table, use the </span><span class="calibre9"><span class="calibre30">describe</span></span><span class="calibre41"> command. Here’s an example: </span></blockquote><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre41">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​hbase&gt;</span><span class="calibre9"><span class="bold"><span class="calibre44"> describe 'wiki'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre41">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​hbase&gt;</span><span class="calibre9"><span class="bold"><span class="calibre44"> describe '.META.'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre41">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​hbase&gt;</span><span class="calibre9"><span class="bold"><span class="calibre44"> describe '-ROOT-'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></blockquote></td></tr></table><a></a><p class="calibre43"> The assignment of regions to region servers, including <span class="calibre9"><span class="calibre30">.META.</span></span> regions, is handled by the <span class="italic">master</span> node, often referred to as <span class="calibre9"><span class="calibre30">HBaseMaster</span></span>. The master server can also be a region server, performing both duties simultaneously. </p><a></a><p class="calibre12"> When a region server fails, the master server steps in and reassigns responsibility for regions previously assigned to the failed node. The new stewards of those regions would look to the WAL to see what, if any, recovery steps are needed. If the master server fails, responsibility defers to any of the other region servers that step up to become the master. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Scanning One Table to Build Another</span></span></span></p><a></a><p class="calibre29"> Providing you’ve stopped the import script from running, we can move on to the next task: extracting information from the imported wiki contents. </p><a></a><p class="calibre12"> Wiki syntax is filled with links, some of which link internally to other articles and some of which link to external resources. This interlinking contains a wealth of topological data. Let’s capture it! </p><a></a><p class="calibre12"> Our goal is to capture the relationships between articles as directional links, pointing one article <span class="italic">to</span> another or receiving a link <span class="italic">from</span> another. An internal article link in wikitext looks like this: <span class="calibre9"><span class="italic"><span class="calibre38">[[&lt;target name&gt;|&lt;alt text&gt;]]</span></span></span>, where <span class="calibre9"><span class="italic"><span class="calibre38">&lt;target name&gt;</span></span></span> is the article to link to, and <span class="calibre9"><span class="italic"><span class="calibre38">&lt;alt text&gt;</span></span></span> is the alternative text to display (optional). </p><a></a><p class="calibre12"> For example, if the text of the article on <span class="italic">Star Wars</span> contains the string <span class="calibre9"><span class="italic"><span class="calibre38">"[[Yoda|jedi master]]"</span></span></span>, we want to store that relationship twice—once as an outgoing link from <span class="italic">Star Wars</span> and once as an incoming link to Yoda. Storing the relationship twice means that it’s fast to look up both a page’s outgoing links and its incoming links. </p><a></a><p class="calibre12"> To store this additional link data, we’ll create a new table. Head over to the shell and enter this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​hbase&gt;</span><span class="calibre9"><span class="bold"><span class="calibre44"> create 'links', {</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  NAME =&gt; 'to', VERSIONS =&gt; 1, BLOOMFILTER =&gt; 'ROWCOL'​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​},{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  NAME =&gt; 'from', VERSIONS =&gt; 1, BLOOMFILTER =&gt; 'ROWCOL'​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> In principle, we could have chosen to shove the link data into an existing column family or merely added one or more additional column families to the <span class="calibre9"><span class="calibre30">wiki</span></span> table, rather than create a new one. Creating a separate table has the advantage that the tables have separate regions. This means that the cluster can more effectively split regions as necessary. </p><a></a><p class="calibre12"> The general guidance for column families in the HBase community is to try to keep the number of families per table down. You can do this either by combining more columns into the same families or by putting families in different tables entirely. The choice is largely decided by whether and how often clients will need to get an entire row of data (as opposed to needing just a few column values). </p><a></a><p class="calibre12"> In our wiki case, we need the <span class="calibre9"><span class="calibre30">text</span></span> and <span class="calibre9"><span class="calibre30">revision</span></span> column families to be on the same table so that when we put new revisions in, the metadata and the text share the same timestamp. The <span class="calibre9"><span class="calibre30">links</span></span> content, by contrast, will never have the same timestamp as the article from which the data came. Further, most client actions will be interested either in the article text or in the extracted information about article links but probably not in both at the same time. So, splitting out the <span class="calibre9"><span class="calibre30">to</span></span> and <span class="calibre9"><span class="calibre30">from</span></span> column families into a separate table makes sense. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Constructing the Scanner</span></span></span></p><a></a><p class="calibre29"> With the <span class="calibre9"><span class="calibre30">links</span></span> table created, we’re ready to implement a script that will scan all the rows of the <span class="calibre9"><span class="calibre30">wiki</span></span> table. Then, for each row, retrieve the wikitext and parse out the links. Finally, for each link found, create incoming and outgoing <span class="calibre9"><span class="calibre30">link</span></span> table records. The bulk of this script should be pretty familiar to you by now. Most of the pieces are recycled, and we’ll discuss the few novel bits. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/hbase/generate_wiki_links.rb"><span class="calibre41"><span class="calibre13"><span class="underline">hbase/generate_wiki_links.rb</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​import </span><span class="calibre9"><span class="italic"><span class="calibre38">'org.apache.hadoop.hbase.client.HTable'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​import </span><span class="calibre9"><span class="italic"><span class="calibre38">'org.apache.hadoop.hbase.client.Put'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​import </span><span class="calibre9"><span class="italic"><span class="calibre38">'org.apache.hadoop.hbase.client.Scan'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​import </span><span class="calibre9"><span class="italic"><span class="calibre38">'org.apache.hadoop.hbase.util.Bytes'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">def</span></span></span><span class="calibre9"> jbytes( *args )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">return</span></span></span><span class="calibre9"> args.map { |arg| arg.to_s.to_java_bytes }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​wiki_table = HTable.new( @hbase.configuration, </span><span class="calibre9"><span class="italic"><span class="calibre38">'wiki'</span></span></span><span class="calibre9"> )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​links_table = HTable.new( @hbase.configuration, </span><span class="calibre9"><span class="italic"><span class="calibre38">'links'</span></span></span><span class="calibre9"> )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​links_table.setAutoFlush( false )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">① </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​scanner = wiki_table.getScanner( Scan.new ) ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​linkpattern = /\[\[([^\[\]\|\:\#][^\[\]\|:]*)(?:\|([^\[\]\|]+))?\]\]/​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​count = 0​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">while</span></span></span><span class="calibre9"> (result = scanner.next())​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">② </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  title = Bytes.toString( result.getRow() ) ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  text = Bytes.toString( result.getValue( *jbytes( </span><span class="calibre9"><span class="italic"><span class="calibre38">'text'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">''</span></span></span><span class="calibre9"> ) ) )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> text​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    put_to = nil​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">③ </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    text.scan(linkpattern) </span><span class="calibre9"><span class="bold"><span class="calibre44">do</span></span></span><span class="calibre9"> |target, label| ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="bold"><span class="calibre44">unless</span></span></span><span class="calibre9"> put_to​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        put_to = Put.new( *jbytes( title ) )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        put_to.setWriteToWAL( false )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      target.strip!​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      target.capitalize!​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      label = </span><span class="calibre9"><span class="italic"><span class="calibre38">''</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">unless</span></span></span><span class="calibre9"> label​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      label.strip!​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      put_to.add( *jbytes( </span><span class="calibre9"><span class="italic"><span class="calibre38">"to"</span></span></span><span class="calibre9">, target, label ) )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      put_from = Put.new( *jbytes( target ) )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      put_from.add( *jbytes( </span><span class="calibre9"><span class="italic"><span class="calibre38">"from"</span></span></span><span class="calibre9">, title, label ) )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      put_from.setWriteToWAL( false )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">④ </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      links_table.put( put_from ) ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">⑤ </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    links_table.put( put_to ) </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> put_to ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    links_table.flushCommits()​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  count += 1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  puts </span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">#{count}</span><span class="calibre9"><span class="italic"><span class="calibre38"> pages processed (</span></span></span><span class="calibre9">#{title}</span><span class="calibre9"><span class="italic"><span class="calibre38">)"</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> count % 500 == 0​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​links_table.flushCommits()​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​exit​</span><span class="calibre9">​</span></p></td></tr></table><p class="calibre12">①</p><a></a><blockquote class="calibre42"> First, we grab a <span class="calibre9"><span class="calibre30">Scan</span></span> object, which we’ll use to scan through the <span class="calibre9"><span class="calibre30">wiki</span></span> table. </blockquote><p class="calibre12">②</p><a></a><blockquote class="calibre42"> Extracting row and column data requires some byte wrangling but generally isn’t too bad either. </blockquote><p class="calibre12">③</p><a></a><blockquote class="calibre42"> Each time the <span class="calibre9"><span class="calibre30">linkpattern</span></span> appears in the page text, we extract the target article and text of the link and then use those values to add to our <span class="calibre9"><span class="calibre30">Put</span></span> instances. </blockquote><p class="calibre12">④⑤</p><a></a><blockquote class="calibre42"> Finally, we tell the table to execute our accumulated <span class="calibre9"><span class="calibre30">Put</span></span> operations. It’s possible (though unlikely) for an article to contain no links at all, which is the reason for the <span class="calibre9"><span class="calibre30">if put_to</span></span> clause. </blockquote><a></a><blockquote class="calibre83"> Using <span class="calibre9"><span class="calibre30">setWriteToWAL(false)</span></span> for these puts is a judgment call. Since this exercise is for educational purposes and since we could simply rerun the script if anything went wrong, we’ll take the speed bonus and accept our fate should the node fail. </blockquote><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Running the Script</span></span></span></p><a></a><p class="calibre29"> If you’re ready to throw caution to the wind with reckless abandon, kick off the script. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​${HBASE_HOME}/bin/hbase shell generate_wiki_links.rb​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> It should produce output like this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​500 pages processed (10 petametres)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1000 pages processed (1259)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1500 pages processed (1471 BC)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​2000 pages processed (1683)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​...​</span><span class="calibre9">​</span></p></td></tr></table><a></a><blockquote class="calibre76"><img src="images/00056.jpg" class="calibre84"/><span class="calibre9">        </span></blockquote><blockquote class="calibre42"><span class="calibre9"><span class="bold"><span class="calibre31">Joe asks:</span></span></span></blockquote><blockquote class="calibre85"><span class="bold"><span class="calibre4">Couldn’t We Have Done This with Mapreduce?</span></span></blockquote><a></a><blockquote class="calibre83"><span class="calibre9"> In the introduction, we explained that our examples would be in (J)Ruby and JavaScript. JRuby does not play nice with Hadoop, but if you wanted to use mapreduce using Java, you’d have written this scanner code as a mapreduce job and sent it off to Hadoop. </span></blockquote><a></a><blockquote class="calibre86"><span class="calibre9"> Generally speaking, tasks like this are ideally suited for a mapreduce implementation. There’s a bulk of input in a regular format to be handled by a mapper (scanning an HBase table) and a bulk of output operations to be executed in batches by a reducer (writing rows out to an HBase table). </span></blockquote><a></a><blockquote class="calibre86"><span class="calibre9"> The Hadoop architecture expects </span><span class="calibre9"><span class="calibre30">Job</span></span><span class="calibre9"> instances to be written in Java and wholly encapsulated (including all dependencies) into a jar file that can be sent out to all the nodes of the cluster. Newer versions of JRuby can extend Java classes, but the version that ships with HBase can’t. </span></blockquote><a></a><blockquote class="calibre86"><span class="calibre9"> There are a few open source projects that provide a bridge for running JRuby on Hadoop but nothing yet that specifically works well with HBase. There are rumors that in the future the HBase infrastructure will contain abstractions to make JRuby MR (mapreduce) jobs possible. So, there’s hope for the future. </span></blockquote><a></a><p class="calibre23"> As with the previous script, you can let it run as long as you like, even to completion. If you want to stop it, press <span class="calibre69"><span class="calibre30">Ctrl</span></span>+<span class="calibre69"><span class="calibre30">C</span></span>. </p><a></a><p class="calibre12"> You can monitor the disk usage of the script using <span class="calibre9"><span class="calibre30">du</span></span> as we’ve done before. You’ll see new entries for the <span class="calibre9"><span class="calibre30">links</span></span> table we just created, and the size counts will increase as the script runs. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Examining the Output</span></span></span></p><a></a><p class="calibre29"> We just created a scanner programmatically to perform a sophisticated task. Now we’ll use the shell’s <span class="calibre9"><span class="calibre30">scan</span></span> command to simply dump part of a table’s contents to the console. For each link the script finds in a <span class="calibre9"><span class="calibre30">text:</span></span> blob, it will indiscriminately create both <span class="calibre9"><span class="calibre30">to</span></span> and <span class="calibre9"><span class="calibre30">from</span></span> entries in the <span class="calibre9"><span class="calibre30">links</span></span> table. To see the kinds of links being created, head over to the shell and <span class="calibre9"><span class="calibre30">scan</span></span> the table. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​hbase&gt;</span><span class="calibre9"><span class="bold"><span class="calibre44"> scan 'links', STARTROW =&gt; "Admiral Ackbar", ENDROW =&gt; "It's a Trap!"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You should get a whole bunch of output. Of course, you can use the <span class="calibre9"><span class="calibre30">get</span></span> command to see the links for just a single article. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​hbase&gt;</span><span class="calibre9"><span class="bold"><span class="calibre44"> get 'links', 'Star Wars'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​COLUMN CELL​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ ...​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ links:from:Admiral Ackbar           timestamp=1300415922636, value=​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ links:from:Adventure                timestamp=1300415927098, value=​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ links:from:Alamogordo, New Mexico   timestamp=1300415953549, value=​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ links:to:"weird al" yankovic        timestamp=1300419602350, value=​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ links:to:20th century fox           timestamp=1300419602350, value=​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ links:to:3-d film                   timestamp=1300419602350, value=​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ links:to:Aayla secura               timestamp=1300419602350, value=​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ ...​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> In the <span class="calibre9"><span class="calibre30">wiki</span></span> table, the rows are very regular with respect to columns. As you recall, each row has <span class="calibre9"><span class="calibre30">text:</span></span>, <span class="calibre9"><span class="calibre30">revision:author</span></span>, and <span class="calibre9"><span class="calibre30">revision:comment</span></span> columns. The <span class="calibre9"><span class="calibre30">links</span></span> table has no such regularity. Each row may have one column or hundreds. And the variety of column names is as diverse as the row keys themselves (titles of Wikipedia articles). That’s OK! HBase is a so-called sparse data store for exactly this reason. </p><a></a><p class="calibre12"> To find out just how many rows are now in your table, you can use the <span class="calibre9"><span class="calibre30">count</span></span> command. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​hbase&gt;</span><span class="calibre9"><span class="bold"><span class="calibre44"> count 'wiki', INTERVAL =&gt; 100000, CACHE =&gt; 10000</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Current count: 100000, row: Alexander wilson (vauxhall)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Current count: 200000, row: Bachelor of liberal studies​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Current count: 300000, row: Brian donlevy​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​...​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Current count: 2000000, row: Thomas Hobbes​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Current count: 2100000, row: Vardousia​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Current count: 2200000, row: Wörrstadt (verbandsgemeinde)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​2256081 row(s) in 173.8120 seconds​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Because of its distributed architecture, HBase doesn’t immediately know how many rows are in each table. To find out, it has to count them (by performing a table scan). Fortunately, HBase’s region-based storage architecture lends itself to fast distributed scanning. So, even if the operation at hand requires a table scan, we don’t have to worry quite as much as we would with other databases. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Day 2 Wrap-Up</span></span></span></p><a></a><p class="calibre29"> Whew, that was a pretty big day! We learned how to write an import script for HBase that parses data out of a stream of XML. Then we used those techniques to stream Wikipedia dumps directly into our <span class="calibre9"><span class="calibre30">wiki</span></span> table. </p><a></a><p class="calibre12"> We learned more of the HBase API, including some client-controllable performance levers such as <span class="calibre9"><span class="calibre30">setAutoFlush</span></span>, <span class="calibre9"><span class="calibre30">flushCommits</span></span>, and <span class="calibre9"><span class="calibre30">setWriteToWAL</span></span>. Along those lines, we discussed some HBase architectural features such as disaster recovery, provided via the write-ahead log. </p><a></a><p class="calibre12"> Speaking of architecture, we discovered table regions and how HBase divvies up responsibility for them among the region servers in the cluster. We scanned the <span class="calibre9"><span class="calibre30">.META.</span></span> and <span class="calibre9"><span class="calibre30">-ROOT-</span></span> tables to get a feel for HBase internals. </p><a></a><p class="calibre12"> Finally, we discussed some of the performance implications of HBase’s sparse design. In so doing, we touched on some community best practices regarding the use of columns, families, and tables. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Day 2 Homework</span></span></span></p><p class="calibre87"><span class="bold"><span class="calibre28">Find</span></span></p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22"> Find a discussion or article describing the pros and cons of compression in HBase. </p></li><li value="2" class="calibre36"><p class="calibre22"> Find an article explaining how Bloom filters work in general and how they benefit HBase. </p></li><li value="3" class="calibre36"><p class="calibre22"> Aside from which algorithm to use, what other column family options relate to compression? </p></li><li value="4" class="calibre36"><p class="calibre22"> How does the type of data and expected usage patterns inform column family compression options? </p></li></ol><p class="calibre12"><span class="bold"><span class="calibre28">Do</span></span></p><a></a><p class="calibre37"> Expanding on the idea of data import, let’s build a database containing nutrition facts. </p><p class="calibre12" id="filepos799969"> Download the MyPyramid Raw Food Data set from Data.gov.<a href="#filepos856135"><span class="calibre13"><span class="underline">[30]</span></span></a> Extract the zipped contents to find <span class="calibre9"><span class="calibre30">Food_Display_Table.xml</span></span>. </p><a></a><p class="calibre12"> This data consists of many pairs of <span class="calibre9"><span class="calibre30">&lt;Food_Display_Row&gt;</span></span> tags. Inside these, each row has a <span class="calibre9"><span class="calibre30">&lt;Food_Code&gt;</span></span> (integer value), <span class="calibre9"><span class="calibre30">&lt;Display_Name&gt;</span></span> (string), and other facts about the food in appropriately named tags. </p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22"> Create a new table called <span class="calibre9"><span class="calibre30">foods</span></span> with a single column family to store the facts. What should you use for the row key? What column family options make sense for this data? </p></li><li value="2" class="calibre36"><p class="calibre22"> Create a new JRuby script for importing the food data. Use the SAX parsing style we used earlier for the Wikipedia import script and tailor it for the food data. </p></li><li value="3" class="calibre36"><p class="calibre22"> Pipe the food data into your import script on the command line to populate the table. </p></li><li value="4" class="calibre36"><p class="calibre22"> Finally, using the HBase shell, query the <span class="calibre9"><span class="calibre30">foods</span></span> table for information about your favorite foods. </p></li></ol><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos801639" class="calibre1"><p class="calibre24" id="filepos801644"><span class="calibre25"><span class="bold"><span class="calibre26">4.4 Day 3: Taking It to the Cloud</span></span></span></p><a></a><p class="calibre27"> In Days 1 and 2, we got a lot of hands-on experience using HBase in stand-alone mode. Our experimentation so far has focused on accessing a single local server. In reality, if you choose to use HBase, you’ll want to have a good sized cluster in order to realize the performance benefits of its distributed architecture. </p><a></a><p class="calibre12"> Here in Day 3, we’ll turn our attention toward operating and interacting with a remote HBase cluster. First we’ll develop a client application in Ruby and connect to our local server using a binary protocol called Thrift. Then we’ll bring up a multinode cluster with a cloud service provider—Amazon EC2—using a cluster management technology called Apache Whirr. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Developing a Thrifty HBase Application</span></span></span></p><a></a><p class="calibre29"> So far, we’ve been using the HBase shell, but HBase supports a number of protocols for client connectivity. The following is a full list: </p><br class="calibre1"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Name  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Connection Method  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Production Ready?  </span></blockquote></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">Shell  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Direct  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Yes  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">Java API  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Direct  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Yes  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">Thrift  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Binary protocol  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Yes  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">REST  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">HTTP  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Yes  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">Avro  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Binary protocol  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No (still experimental)  </blockquote></td></tr></table><a></a><p class="calibre23"> In the previous table, the connection method describes whether the protocol makes Java calls directly, shuttles data over HTTP, or moves data using a compact binary format. All of them are production-grade, except for Avro, which is relatively new and should be treated as experimental. </p><a></a><p class="calibre12"> Of all these options, Thrift is probably the most popular for developing client applications. A mature binary protocol with little overhead, Thrift was originally developed and open sourced by Facebook, later to become an Apache Incubator project. Let’s get your machine ready to connect with Thrift. </p><p class="calibre12"><span class="bold"><span class="calibre28">Installing Thrift</span></span></p><a></a><p class="calibre37"> Like many things in the database realm, working with Thrift requires a little setup. To connect to our HBase server via Thrift, we’ll need to do the following: </p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Have HBase run the Thrift service.</p></li><li value="2" class="calibre36"><p class="calibre22">Install the Thrift command-line tool. </p></li><li value="3" class="calibre36"><p class="calibre22">Install libraries for your chosen client language.</p></li><li value="4" class="calibre36"><p class="calibre22">Generate HBase model files for your language.</p></li><li value="5" class="calibre36"><p class="calibre22">Create and run a client application. </p></li></ol><a></a><p class="calibre12"> We’ll start by running the Thrift service, which is pretty easy. Start the daemon from the command line like this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​${HBASE_HOME}/bin/hbase-daemon.sh start thrift -b 127.0.0.1​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Next, you’ll need to install the <span class="calibre9"><span class="calibre30">thrift</span></span> command-line tool. The steps for this depend greatly on your particular environment and generally require compiling binaries. To test whether you have this installed correctly, call it on the command line with the <span class="calibre9"><span class="calibre30">-version</span></span> flag. You should see something like this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">thrift -version</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Thrift version 0.6.0​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> For the client language, we’ll use Ruby, although the steps are similar for other languages. Install the Thrift Ruby gem on the command line like so: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">gem install thrift</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> To check whether the gem is installed correctly, we can run this Ruby one-liner: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">ruby -e "require 'thrift'"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If you see no output on the command line, that’s good! An error message stating “<span class="calibre9"><span class="calibre30">no such file to load</span></span>” means you should stop here and troubleshoot before moving on. </p><p class="calibre12" id="filepos809539"><span class="bold"><span class="calibre28">Generate the Models</span></span></p><a></a><p class="calibre37"> Next, we’ll generate the language-specific HBase model files. These model files will be the glue that connects our specific HBase version with the particular Thrift version you have installed, so they have to be generated (rather than coming premade). </p><a></a><p class="calibre12"> First, locate the <span class="calibre9"><span class="calibre30">Hbase.thrift</span></span> file under the <span class="calibre9"><span class="calibre30">${HBASE_HOME}/src</span></span> directory. The path should be something like this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​${HBASE_HOME}/src/main/resources/org/apache/hadoop/hbase/thrift/Hbase.thrift​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> With the path identified, generate the model files with the following command, replacing your path as indicated: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">thrift --gen rb &lt;path_to_Hbase.thrift&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This will create a new folder called <span class="calibre9"><span class="calibre30">gen-rb</span></span>, which contains the following model files: </p><div class="calibre33"> </div><ul class="calibre34"><li value="1" class="calibre35"><p class="calibre22"><span class="calibre9"><span class="calibre30">hbase_constants.rb</span></span>
</p></li><li value="2" class="calibre36"><p class="calibre22"><span class="calibre9"><span class="calibre30">hbase.rb</span></span>
</p></li><li value="3" class="calibre36"><p class="calibre22"><span class="calibre9"><span class="calibre30">hbase_types.rb</span></span>
</p></li></ul><a></a><p class="calibre12"> We’ll be using these files next as we build a simple client application. </p><p class="calibre12"><span class="bold"><span class="calibre28">Building a Client Application</span></span></p><a></a><p class="calibre37"> Our program will connect to HBase over Thrift and then list any tables it finds along with their column families. These would be the first steps toward building an administrative interface for HBase. Unlike our previous examples, this script is meant to be run by good old normal Ruby, not JRuby. It could be suitable for inclusion in a Ruby-based web application, for example. </p><a></a><p class="calibre12"> Key this into a new text file (we called ours <span class="calibre9"><span class="calibre30">thrift_example.rb</span></span>): </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/hbase/thrift_example.rb"><span class="calibre41"><span class="calibre13"><span class="underline">hbase/thrift_example.rb</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$:.push(</span><span class="calibre9"><span class="italic"><span class="calibre38">'./gen-rb'</span></span></span><span class="calibre9">)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​require </span><span class="calibre9"><span class="italic"><span class="calibre38">'thrift'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​require </span><span class="calibre9"><span class="italic"><span class="calibre38">'hbase'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​socket = Thrift::Socket.new( </span><span class="calibre9"><span class="italic"><span class="calibre38">'localhost'</span></span></span><span class="calibre9">, 9090 )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​transport = Thrift::BufferedTransport.new( socket )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​protocol = Thrift::BinaryProtocol.new( transport )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​client = Apache::Hadoop::Hbase::Thrift::Hbase::Client.new( protocol )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​transport.open()​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​client.getTableNames().sort.each </span><span class="calibre9"><span class="bold"><span class="calibre44">do</span></span></span><span class="calibre9"> |table|​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  puts </span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">#{table}</span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  client.getColumnDescriptors( table ).each </span><span class="calibre9"><span class="bold"><span class="calibre44">do</span></span></span><span class="calibre9"> |col, desc|​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    puts </span><span class="calibre9"><span class="italic"><span class="calibre38">"  </span></span></span><span class="calibre9">#{desc.name}</span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    puts </span><span class="calibre9"><span class="italic"><span class="calibre38">"    maxVersions: </span></span></span><span class="calibre9">#{desc.maxVersions}</span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    puts </span><span class="calibre9"><span class="italic"><span class="calibre38">"    compression: </span></span></span><span class="calibre9">#{desc.compression}</span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    puts </span><span class="calibre9"><span class="italic"><span class="calibre38">"    bloomFilterType: </span></span></span><span class="calibre9">#{desc.bloomFilterType}</span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​transport.close()​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> In the previous code, the first thing we do is make sure Ruby can find the model files by adding <span class="calibre9"><span class="calibre30">gen-rb</span></span> to the path and including <span class="calibre9"><span class="calibre30">thrift</span></span> and <span class="calibre9"><span class="calibre30">hbase</span></span>. After that, we create a connection to the Thrift server and wire it up to an HBase client instance. The <span class="calibre9"><span class="calibre30">client</span></span> object will be our means for communicating with HBase. </p><a></a><p class="calibre12"> After opening the <span class="calibre9"><span class="calibre30">transport</span></span>, we iterate over the tables brought back by <span class="calibre9"><span class="calibre30">getTableNames</span></span>. For each table, we iterate over the list of column families returned by <span class="calibre9"><span class="calibre30">getColumnDescriptors</span></span> and output some properties to standard output. </p><a></a><p class="calibre12"> Now, let’s run the program on the command line. Your output should look similar since we’re connecting to the local HBase server we started with earlier.</p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$&gt; ruby thrift_example.rb​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​links​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  from:​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    maxVersions: 1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    compression: NONE​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    bloomFilterType: ROWCOL​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  to:​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    maxVersions: 1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    compression: NONE​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    bloomFilterType: ROWCOL​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​wiki​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  revision:​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    maxVersions: 2147483647​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    compression: NONE​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    bloomFilterType: NONE​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  text:​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    maxVersions: 2147483647​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    compression: GZ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    bloomFilterType: ROW​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You’ll find that the Thrift API for HBase has most of the same functionality as the Java API we used previously, but many of the concepts are expressed differently. For example, instead of creating a <span class="calibre9"><span class="calibre30">Put</span></span> instance, in Thrift you create a <span class="calibre9"><span class="calibre30">Mutation</span></span> to update a single column or a <span class="calibre9"><span class="calibre30">BatchMutation</span></span> to update several columns in one transaction. </p><a></a><p class="calibre12"> The <span class="calibre9"><span class="calibre30">Hbase.thrift</span></span> file we used earlier to generate the model files—see <a href="#filepos809539"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Generate the Models</span></span><span class="calibre13"><span class="underline">​</span></span></a>—has a lot of good inline documentation to describe the structures and methods available to you. Check it out! </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Introducing Whirr</span></span></span></p><a></a><p class="calibre29"> Setting up a functioning cluster using a cloud service used to be <span class="italic">a lot</span> of work. Fortunately, Whirr is changing all that. Currently in the Apache Incubator program, Whirr provides tools for launching, connecting to, and destroying clusters of virtual machines. It supports popular services like Amazon’s Elastic Compute Cloud (EC2) and RackSpace’s Cloud Servers. Whirr currently supports setting up Hadoop, HBase, Cassandra, Voldemort, and ZooKeeper clusters, with support for more technologies like MongoDB and ElasticSearch on the way. </p><a></a><p class="calibre12"> Though service providers like Amazon often supply some means of persisting data after virtual machines have been terminated, we won’t be using them. For our purposes, it will suffice to have temporary clusters that lose all data upon termination. If you decide to use HBase in a production capacity later, you may want to set up persistent storage. If so, it’s worth considering whether dedicated hardware would better suit your needs. Dynamic services like EC2 are great for horsepower on-the-fly, but you’ll generally get more bang for the buck out of a cluster of dedicated physical or virtual machines. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Getting Set Up with EC2</span></span></span></p><a></a><p class="calibre29"> Before you use Whirr to power up a cluster, you’ll need to have an account with a supported cloud service provider. In this chapter, we’ll describe how to use Amazon’s EC2, but you’re welcome to use another provider of your choice. </p><p class="calibre12" id="filepos829026"> If you don’t have an Amazon account already, head over to Amazon’s Web Services (AWS) portal and make one.<a href="#filepos856135"><span class="calibre13"><span class="underline">[31]</span></span></a> Log in, and then enable EC2 for your account if it isn’t activated already.<a href="#filepos856135"><span class="calibre13"><span class="underline">[32]</span></span></a> Finally, open the EC2 AWS console page under Accounts Amazon EC2.<a href="#filepos856135"><span class="calibre13"><span class="underline">[33]</span></span></a> It should look something like Figure 17, <a href="#filepos829723"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Amazon EC2 console showing no instances</span></span><span class="calibre13"><span class="underline">​</span></span></a>. </p><a id="filepos829723"></a><blockquote class="calibre10"><img src="images/00049.jpg" class="calibre88"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 17. Amazon EC2 console showing no instances</span></blockquote><a></a><p class="calibre12"> You’ll need your AWS credentials in order to start up EC2 nodes. Head back to the AWS main page and then choose Account→Security Credentials. Scroll down to the section called Access Credentials, and make a note of your Access Key ID. Under Secret Access Key, click Show, and make a note of this value as well. Respectively, we’ll refer to these keys as <span class="calibre9"><span class="calibre30">AWS_ACCESS_KEY_ID</span></span> and <span class="calibre9"><span class="calibre30">AWS_SECRET_ACCESS_KEY</span></span> later when we configure Whirr. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Preparing Whirr</span></span></span></p><p class="calibre29" id="filepos830682"> With your EC2 credentials in hand, let’s get Whirr. Go to the Apache Whirr site<a href="#filepos856135"><span class="calibre13"><span class="underline">[34]</span></span></a> and download the latest version. Unzip the downloaded file, and then open a command prompt in this directory. We can test that Whirr is ready to roll by executing the <span class="calibre9"><span class="calibre30">version</span></span> command. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">bin/whirr version</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Apache Whirr 0.6.0-incubating​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Next, we’ll create some passwordless SSH keys for Whirr to use when launching instances (virtual machines). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">mkdir keys</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">ssh-keygen -t rsa -P '' -f keys/id_rsa</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This will create a directory called <span class="calibre9"><span class="calibre30">keys</span></span> and add to it an <span class="calibre9"><span class="calibre30">id_rsa</span></span> file and an <span class="calibre9"><span class="calibre30">id_rsa.pub</span></span> file. With these details out of the way, it’s time to start configuring our cluster. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Configuring the Cluster</span></span></span></p><a></a><p class="calibre29"> To specify details about a cluster, we’ll supply Whirr with a <span class="calibre9"><span class="calibre30">properties</span></span> file containing the relevant settings. Create a file in the Whirr directory called <span class="calibre9"><span class="calibre30">hbase.properties</span></span> with the following contents (inserting your <span class="calibre9"><span class="calibre30">AWS_ACCESS_KEY_ID</span></span> and <span class="calibre9"><span class="calibre30">AWS_SECRET_ACCESS_KEY</span></span> as indicated): </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/hbase/hbase.properties"><span class="calibre41"><span class="calibre13"><span class="underline">hbase/hbase.properties</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​# service provider​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​whirr.provider=aws-ec2​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​whirr.identity=your AWS_ACCESS_KEY_ID here​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​whirr.credential=your AWS_SECRET_ACCESS_KEY here​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​# ssh credentials​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​whirr.private-key-file=keys/id_rsa​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​whirr.public-key-file=keys/id_rsa.pub​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​# cluster configuration​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​whirr.cluster-name=myhbasecluster​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​whirr.instance-templates=\​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  1 zookeeper+hadoop-namenode+hadoop-jobtracker+hbase-master,\​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  5 hadoop-datanode+hadoop-tasktracker+hbase-regionserver​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​# HBase and Hadoop version configuration​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​whirr.hbase.tarball.url=\​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  http://apache.cu.be/hbase/hbase-0.90.3/hbase-0.90.3.tar.gz​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​whirr.hadoop.tarball.url=\​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  http://archive.cloudera.com/cdh/3/hadoop-0.20.2-cdh3u1.tar.gz​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The first two sections identify the service provider and all relevant credentials—largely boilerplate—while the latter two sections are specific to the HBase cluster that we’re going to create. The <span class="calibre9"><span class="calibre30">whirr.cluster-name</span></span> is unimportant unless you plan on running more than one cluster simultaneously, in which case they should each have different names. The <span class="calibre9"><span class="calibre30">whirr.instance-templates</span></span> property contains a comma-separated list describing which roles the nodes will play and how many of each there should be. In our case, we want one master and five region servers. Finally, the <span class="calibre9"><span class="calibre30">whirr.hbase.tarball.url</span></span> forces Whirr to use the same version of HBase we’ve been using so far. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Launching the Cluster</span></span></span></p><a></a><p class="calibre29"> With all the configuration details saved to <span class="calibre9"><span class="calibre30">hbase.properties</span></span>, it’s time to launch the cluster. On the command line, in the Whirr directory, execute the <span class="calibre9"><span class="calibre30">launch-cluster</span></span> command, providing it with the properties file we just made. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">bin/whirr launch-cluster --config hbase.properties</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This will produce a lot of output and may take a while. You can monitor the progress of the launch by returning to the AWS EC2 console. It should look something like Figure 18, <a href="#filepos841556"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Amazon EC2 console showing HBase instances starting up</span></span><span class="calibre13"><span class="underline">​</span></span></a>. </p><a id="filepos841556"></a><blockquote class="calibre10"><img src="images/00050.jpg" class="calibre89"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 18. Amazon EC2 console showing HBase instances starting up</span></blockquote><a></a><p class="calibre12"> More information about the launch status is available in the <span class="calibre9"><span class="calibre30">whirr.log</span></span> file in the Whirr directory. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Connecting to the Cluster</span></span></span></p><a></a><p class="calibre29"> Only secure traffic is allowed to the cluster by default, so to connect to HBase, we’ll need to open an SSH session. First, we’ll need to know the name of a server in the cluster to connect to. In your user’s home directory, Whirr created a directory called <span class="calibre9"><span class="calibre30">.whirr/myhbasecluster</span></span>. In here, you’ll find a tab-delimited file called <span class="calibre9"><span class="calibre30">instances</span></span> that lists all of the cluster’s running Amazon instances. The third column contains the publicly addressable domain names of the servers. Take the first one and plug it into this command: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">ssh -i keys/id_rsa ${USER}@&lt;SERVER_NAME&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Once connected, start up the HBase shell: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">/usr/local/hbase-0.90.3/bin/hbase shell</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Once the shell has started up, you can check on the health of the cluster with the <span class="calibre9"><span class="calibre30">status</span></span> command. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​hbase&gt;</span><span class="calibre9"><span class="bold"><span class="calibre44"> status</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​6 servers, 0 dead, 2.0000 average load​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> From here, you can perform all the same operations we did on Days 1 and 2 such as creating tables and inserting data. Connecting the sample Thrift-based client application to the cluster is left as an exercise in the homework. </p><a></a><p class="calibre12"> Of course, one more thing is worth talking about before we finish out the day: destroying a cluster. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Destroying the Cluster</span></span></span></p><a></a><p class="calibre29"> When you’re done with your remote HBase EC2 cluster, use Whirr’s <span class="calibre9"><span class="calibre30">destroy-cluster</span></span> command to shut it down. Note that you will lose any and all data that had been inserted into the cluster when you do so, since we have not configured the instances to use persistent storage. </p><a></a><p class="calibre12"> At the command prompt, in the Whirr directory, run the following: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">bin/whirr destroy-cluster --config hbase.properties</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Destroying myhbasecluster cluster​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Cluster myhbasecluster destroyed​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This should take only a little while. Confirm that the instances are shutting down in the AWS console, which should resemble Figure 19, <a href="#filepos846920"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Amazon EC2 console showing HBase instances shutting down</span></span><span class="calibre13"><span class="underline">​</span></span></a>. </p><a id="filepos846920"></a><blockquote class="calibre10"><img src="images/00054.jpg" class="calibre90"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 19. Amazon EC2 console showing HBase instances shutting down</span></blockquote><a></a><p class="calibre12"> If anything goes wrong when shutting these things down, remember that you can still terminate them directly using the AWS console. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Day 3 Wrap-Up</span></span></span></p><a></a><p class="calibre29"> Today we stepped outside the HBase shell to look at other connection options, including a binary protocol called Thrift. We developed a Thrifty client application, and then we created and administrated a remote cluster in Amazon EC2 using Apache Whirr. Coming up in the homework, you’ll string these two things together, querying your remote EC2 cluster from your locally running Thrift app. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Day 3 Homework</span></span></span></p><a></a><p class="calibre29"> In today’s homework, you’ll connect your local Thrift application to a remotely running HBase cluster. To do this, you’ll need to open your cluster to insecure incoming TCP connections. If this were a production environment, a better first step would be to create a secure channel for Thrift—for example by setting up a virtual private network (VPN) with endpoints inside EC2 and our principal network. Such a setup is outside the scope of this book; suffice it to say that we strongly recommend securing your traffic when it matters to do so. </p><p class="calibre12"><span class="bold"><span class="calibre28">Do</span></span></p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22"> With your EC2 cluster running, open an SSH session to a node, start the <span class="calibre9"><span class="calibre30">hbase</span></span> shell, and then create a table with at least one column family. </p></li><li value="2" class="calibre36"><p class="calibre22"> In the same SSH session, start the Thrift service. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">sudo /usr/local/hbase-0.90.3/bin/hbase-daemon.sh start thrift -b 0.0.0.0</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table></li><li value="3" class="calibre82"><p class="calibre22"> Use the Amazon EC2 web interface console to open TCP port 9090 in the security group for your cluster (Network &amp; Security &gt; Security Groups &gt; Inbound &gt; Create a new rule). </p></li><li value="4" class="calibre36"><p class="calibre22"> Modify the simple Thrift-based Ruby client app you developed to hit the EC2 node running Thrift instead of localhost. Run the program and confirm that it displays the correct information about your newly created table. </p></li></ol><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos850166" class="calibre1"><p class="calibre24" id="filepos850171"><span class="calibre25"><span class="bold"><span class="calibre26">4.5 Wrap-Up</span></span></span></p><a></a><p class="calibre27"> HBase is a juxtaposition of simplicity and complexity. The data storage model is pretty straightforward, with a few built-in schema constraints. It doesn’t help, though, that many terms are overloaded with baggage from the relational world (for example, words like <span class="italic">table</span> and <span class="italic">column</span>). Most of HBase schema design is deciding on the performance characteristics of your tables and columns. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">HBase’s Strengths</span></span></span></p><a></a><p class="calibre29"> Noteworthy features of HBase include a robust scale-out architecture and built-in versioning and compression capabilities. HBase’s built-in versioning capability can be a compelling feature for certain use cases. Keeping the version history of wiki pages is a crucial feature for policing and maintenance, for instance. By choosing HBase, we don’t have to take any special steps to implement page history—we get it for free. </p><a></a><p class="calibre12"> On the performance front, HBase is meant to scale out. If you have huge amounts of data, measured in many gigabytes or terabytes, HBase may be for you. HBase is rack-aware, replicating data within and between datacenter racks so that node failures can be handled gracefully and quickly. </p><p class="calibre12" id="filepos851637"> The HBase community is pretty awesome. There’s almost always somebody on the IRC channel<a href="#filepos856135"><span class="calibre13"><span class="underline">[35]</span></span></a> or mailing lists<a href="#filepos856135"><span class="calibre13"><span class="underline">[36]</span></span></a> ready to help with questions and get you pointed in the right direction. Although a number of high-profile companies use HBase for their projects, there is no corporate HBase service provider. This means the people of the HBase community do it for the love of the project and the common good. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">HBase’s Weaknesses</span></span></span></p><a></a><p class="calibre29"> Although HBase is designed to scale out, it doesn’t scale down. The HBase community seems to agree that five nodes is the minimum number you’ll want to use. Because it’s designed to be big, it can also be harder to administrate. Solving small problems isn’t what HBase is about, and nonexpert documentation is tough to come by, which steepens the learning curve. </p><a></a><p class="calibre12"> Additionally, HBase is almost never deployed alone. Rather, it’s part of an ecosystem of scale-ready pieces. These include Hadoop (an implementation of Google’s MapReduce), the Hadoop distributed file system (HDFS), and Zookeeper (a headless service that aids internode coordination). This ecosystem is both a strength and a weakness; it simultaneously affords a great deal of architectural sturdiness but also encumbers the administrator with the burden of maintaining it. </p><a></a><p class="calibre12"> One noteworthy characteristic of HBase is that it doesn’t offer any sorting or indexing capabilities aside from the row keys. Rows are kept in sorted order by their row keys, but no such sorting is done on any other field, such as column names and values. So, if you want to find rows by something other than their key, you need to scan the table or maintain your own index. </p><a></a><p class="calibre12"> Another missing concept is datatypes. All field values in HBase are treated as uninterpreted arrays of bytes. There is no distinction between, say, an integer value, a string, and a date. They’re all bytes to HBase, so it’s up to your application to interpret the bytes. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">HBase on CAP</span></span></span></p><a></a><p class="calibre29"> With respect to CAP, HBase is decidedly CP. HBase makes strong consistency guarantees. If a client succeeds in writing a value, other clients will receive the updated value on the next request. Some databases, like Riak, allow you to tweak the CAP equation on a per-operation basis. Not so with HBase. In the face of reasonable amounts of partitioning—for example, a node failing—HBase will remain available, shunting the responsibility off to other nodes in the cluster. However, in the pathological example, where only one node is left alive, HBase has no choice but to refuse requests. </p><a></a><p class="calibre12"> The CAP discussion gets a little more complex when you introduce cluster-to-cluster replication, an advanced feature we didn’t cover in this chapter. A typical multicluster setup could have clusters separated geographically by some distance. In this case, for a given column family, one cluster is the system of record, while the other clusters merely provide access to the replicated data. This system is <span class="italic">eventually consistent</span> since the replication clusters will serve up the most recent values they’re aware of, which may not be the most recent values in the master cluster. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Parting Thoughts</span></span></span></p><a></a><p class="calibre29"> As one of the first nonrelational databases we had ever encountered, HBase was quite a challenge for us. The terminology can be deceptively reassuring, and the installation and configuration are not for the faint of heart. On the plus side, some of the features HBase offers, such as versioning and compression, are quite unique. These aspects can make HBase quite appealing for solving certain problems. And of course, it scales out to many nodes of commodity hardware quite well. All in all, HBase—like a nail gun—is a pretty big tool, so watch your thumbs. </p><p class="calibre23"><span class="calibre9"><span class="bold"><span class="calibre28">Footnotes</span></span></span></p><a id="filepos856135"></a><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos620792"><span class="calibre9"><span class="calibre13"><span class="underline">[26]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://research.google.com/archive/bigtable.html"><span class="calibre9"><span class="calibre13"><span class="underline">http://research.google.com/archive/bigtable.html</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos721894"><span class="calibre9"><span class="calibre13"><span class="underline">[27]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://dumps.wikimedia.org"><span class="calibre9"><span class="calibre13"><span class="underline">http://dumps.wikimedia.org</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos721894"><span class="calibre9"><span class="calibre13"><span class="underline">[28]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://dumps.wikimedia.org/enwiki/latest/enwiki-latest-pages-articles.xml.bz2"><span class="calibre9"><span class="calibre13"><span class="underline">http://dumps.wikimedia.org/enwiki/latest/enwiki-latest-pages-articles.xml.bz2</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos721894"><span class="calibre9"><span class="calibre13"><span class="underline">[29]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://dumps.wikimedia.org/enwiktionary/latest/enwiktionary-latest-pages-articles.xml.bz2"><span class="calibre9"><span class="calibre13"><span class="underline">http://dumps.wikimedia.org/enwiktionary/latest/enwiktionary-latest-pages-articles.xml.bz2</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos799969"><span class="calibre9"><span class="calibre13"><span class="underline">[30]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://explore.data.gov/Health-and-Nutrition/MyPyramid-Food-Raw-Data/b978-7txq"><span class="calibre9"><span class="calibre13"><span class="underline">http://explore.data.gov/Health-and-Nutrition/MyPyramid-Food-Raw-Data/b978-7txq</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos829026"><span class="calibre9"><span class="calibre13"><span class="underline">[31]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://aws.amazon.com/"><span class="calibre9"><span class="calibre13"><span class="underline">http://aws.amazon.com/</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos829026"><span class="calibre9"><span class="calibre13"><span class="underline">[32]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://aws.amazon.com/ec2/"><span class="calibre9"><span class="calibre13"><span class="underline">http://aws.amazon.com/ec2/</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos829026"><span class="calibre9"><span class="calibre13"><span class="underline">[33]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="https://console.aws.amazon.com/ec2/#s=Instances"><span class="calibre9"><span class="calibre13"><span class="underline">https://console.aws.amazon.com/ec2/#s=Instances</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos830682"><span class="calibre9"><span class="calibre13"><span class="underline">[34]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://incubator.apache.org/whirr/"><span class="calibre9"><span class="calibre13"><span class="underline">http://incubator.apache.org/whirr/</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos851637"><span class="calibre9"><span class="calibre13"><span class="underline">[35]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"><span class="calibre30">irc://irc.freenode.net/#hbase</span></span><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos851637"><span class="calibre9"><span class="calibre13"><span class="underline">[36]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://hbase.apache.org/mail-lists.html"><span class="calibre9"><span class="calibre13"><span class="underline">http://hbase.apache.org/mail-lists.html</span></span></span></a><span class="calibre9">
</span></p></td></tr></table><p class="calibre17"><span class="calibre9"><span class="calibre18"><span class="calibre19">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos860648" class="calibre1"><p class="calibre21" id="filepos860653"><span class="calibre3"><span class="bold"><span class="calibre31"> Chapter 5</span></span></span></p><br class="calibre1"/><p class="calibre32"><span class="calibre3"><span class="bold"><span class="calibre4">MongoDB</span></span></span></p><a></a><p class="calibre12"> MongoDB is in many ways like a power drill. Your ability to complete a task is framed largely by the components you choose to use (from drill bits of varying size to sander adapters). MongoDB’s strength lies in versatility, power, ease of use, and ability to handle jobs both large and small. Although it’s a much newer invention than the hammer, it is increasingly a tool builders reach for quite often. </p><a></a><p class="calibre12"> First publicly released in 2009, MongoDB is a rising star in the NoSQL world. It was designed as a scalable database—the name Mongo comes from “hu<span class="italic">mongo</span>us”—with performance and easy data access as core design goals. It is a document database, which allows data to persist in a nested state, and importantly, it can query that nested data in an ad hoc fashion. It enforces no schema (similar to Riak but unlike Postgres), so documents can optionally contain fields or types that no other document in the collection contains. </p><a></a><p class="calibre12"> But don’t think that MongoDB’s flexibility makes it a toy. There are some huge production MongoDB (often just called <span class="italic">Mongo</span>) deployments out there, like Foursquare, bit.ly, and CERN, for collecting Large Hadron Collider data. </p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos862224" class="calibre1"><p class="calibre24" id="filepos862229"><span class="calibre25"><span class="bold"><span class="calibre26">5.1 Hu(mongo)us</span></span></span></p><a></a><p class="calibre27"> Mongo hits a sweet spot between the powerful queryability of a relational database and the distributed nature of other datastores like Riak or HBase. Project founder Dwight Merriman has said that MongoDB is the database he wishes he’d had at DoubleClick, where as the CTO he had to house large-scale data while still being able to satisfy ad hoc queries. </p><a id="filepos862749"></a><blockquote class="calibre10"><img src="images/00051.jpg" class="calibre91"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 20. A Mongo document printed as JSON</span></blockquote><a></a><p class="calibre12"> Mongo is a JSON document database (though technically data is stored in a binary form of JSON known as BSON). A Mongo document can be likened to a relational table row without a schema, whose values can nest to an arbitrary depth. To get an idea of what a JSON document is, check out Figure 20, <a href="#filepos862749"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">A Mongo document printed as JSON</span></span><span class="calibre13"><span class="underline">​</span></span></a>. </p><a></a><p class="calibre12"> Mongo is an excellent choice for an ever-growing class of web projects with large-scale data storage requirements but very little budget to buy big-iron hardware. Thanks to its lack of structured schema, Mongo can grow and change along with your data model. If you’re in a web startup with dreams of enormity or are already large with the need to scale servers horizontally, consider MongoDB. </p><a></a><blockquote class="calibre76"><img src="images/00007.jpg" class="calibre92"/><span class="calibre9">        </span></blockquote><blockquote class="calibre42"><span class="calibre9"><span class="bold"><span class="calibre31">Eric says:</span></span></span></blockquote><blockquote class="calibre85"><span class="bold"><span class="calibre4">On the Fence</span></span></blockquote><a></a><blockquote class="calibre83"><span class="calibre9"> I was on the fence about using a document datastore before making the switch in my own production code. Coming from the relational database world, I found Mongo to be an easy move with its ad hoc queries. And its ability to scale out mirrored my own web-scale dreams. But beyond the structure, I trusted the development team. They readily admitted that Mongo wasn’t perfect, but their clear plans (and general adherence to those plans) were based on general web infrastructure use cases, rather than idyllic debates on scalability and replication. This pragmatic focus on usability should shine as you use MongoDB. A trade-off of this evolutionary behavior is that there are several paths to performing any given function in Mongo. </span></blockquote><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos865181" class="calibre1"><p class="calibre24" id="filepos865186"><span class="calibre25"><span class="bold"><span class="calibre26">5.2 Day 1: CRUD and Nesting</span></span></span></p><p class="calibre27" id="filepos865320"> We’ll spend today working on some CRUD operations and finish up with performing nested queries in MongoDB. As usual, we won’t walk you through the installation steps, but if you visit the Mongo website,<a href="#filepos1142834"><span class="calibre13"><span class="underline">[37]</span></span></a> you can download a build for your OS or find instructions on how to build from source. If you have OS X, we recommend installing via Homebrew (<span class="calibre9"><span class="calibre30">brew install mongodb </span></span>). If you use some Debian/Ubuntu variant, try Mongodb.org’s own apt-get package. </p><a></a><p class="calibre12"> To prevent typos, Mongo requires you to first create the directory where <span class="calibre9"><span class="calibre30">mongod</span></span> will store its data. A common location is <span class="calibre9"><span class="calibre30">/data/db</span></span>. Ensure the user you run the server under has permission to read and write to this directory. If it’s not already running, you can fire up the Mongo service by running <span class="calibre9"><span class="calibre30">mongod</span></span>. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Command-Line Fun</span></span></span></p><a></a><p class="calibre29"> To create a new database named <span class="calibre9"><span class="calibre30">book</span></span>, first run this command in your terminal. It will connect to the MySQL-inspired command-line interface. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">mongo book</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Typing <span class="calibre9"><span class="calibre30">help</span></span> in the console is a good start. We’re currently in the <span class="calibre9"><span class="calibre30">book</span></span> database, but you can view others via <span class="calibre9"><span class="calibre30">show dbs</span></span> and switch databases with the <span class="calibre9"><span class="calibre30">use</span></span>command.</p><a></a><p class="calibre12"> Creating a collection (similar to a <span class="italic">bucket</span> in Riak nomenclature) in Mongo is as easy as adding an initial record to the collection. Since Mongo is schemaless, there is no need to define anything up front; merely using it is enough. What’s more, our <span class="calibre9"><span class="calibre30">book</span></span> database doesn’t really exist until we first add values into it. The following code creates/inserts a <span class="calibre9"><span class="calibre30">towns</span></span> collection: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; db.towns.insert({​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  name: </span><span class="calibre9"><span class="italic"><span class="calibre38">"New York"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  population: 22200000,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  last_census: ISODate(</span><span class="calibre9"><span class="italic"><span class="calibre38">"2009-07-31"</span></span></span><span class="calibre9">),​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  famous_for: [ </span><span class="calibre9"><span class="italic"><span class="calibre38">"statue of liberty"</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">"food"</span></span></span><span class="calibre9"> ],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  mayor : {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    name : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Michael Bloomberg"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    party : </span><span class="calibre9"><span class="italic"><span class="calibre38">"I"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​})​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> In the previous section, we said documents were JSON (well, really BSON), so we add new documents in JSON format, where brackets like {...} denote an object (aka a hashtable or Map) with keyed values and where brackets like [...] denote an array. You can nest these values to any depth. </p><a></a><p class="calibre12"> With the <span class="calibre9"><span class="calibre30">show collections</span></span> command, you can verify the collection now exists. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; show collections​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​system.indexes​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​towns​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We just created <span class="calibre9"><span class="calibre30">towns</span></span>, whereas <span class="calibre9"><span class="calibre30">system.indexes</span></span> always exists. We can list the contents of a collection via <span class="calibre9"><span class="calibre30">find</span></span>. We formatted the output here for readability, but yours may just output as a single wrapped line. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; db.towns.find()​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "_id" : ObjectId(</span><span class="calibre9"><span class="italic"><span class="calibre38">"4d0ad975bb30773266f39fe3"</span></span></span><span class="calibre9">),​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"New York"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "population": 22200000,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "last_census": </span><span class="calibre9"><span class="italic"><span class="calibre38">"Fri Jul 31 2009 00:00:00 GMT-0700 (PDT)"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "famous_for" : [ </span><span class="calibre9"><span class="italic"><span class="calibre38">"statue of liberty"</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">"food"</span></span></span><span class="calibre9"> ],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "mayor" : { "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Michael Bloomberg"</span></span></span><span class="calibre9">, "party" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"I"</span></span></span><span class="calibre9"> }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Unlike a relational database, Mongo does not support server-side joins. A single JavaScript call will retrieve a document <span class="italic">and</span> all of its nested content, free of charge. </p><a></a><p class="calibre12"> You may have noticed that the JSON output of your newly inserted town contains an <span class="calibre9"><span class="calibre30">_id</span></span> field of <span class="calibre9"><span class="calibre30">ObjectId</span></span>. This is akin to <span class="calibre9"><span class="calibre30">SERIAL</span></span> incrementing a numeric primary key in PostgreSQL. The <span class="calibre9"><span class="calibre30">ObjectId</span></span> is always 12 bytes, composed of a timestamp, client machine ID, client process ID, and a 3-byte incremented counter. Bytes are laid out as depicted in Figure 21, <a href="#filepos876954"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">An ObjectId layout example</span></span><span class="calibre13"><span class="underline">​</span></span></a>. </p><a id="filepos876954"></a><blockquote class="calibre10"><img src="images/00061.jpg" class="calibre93"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 21. An </span><span class="calibre9"><span class="bold"><span class="calibre30">ObjectId</span></span></span><span class="bold"> layout example</span></blockquote><a></a><p class="calibre12"> What’s great about this autonumbering scheme is that each process on every machine can handle its own ID generation without colliding with other <span class="calibre9"><span class="calibre30">mongod</span></span> instances. This design choice gives a hint of Mongo’s distributed nature. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">JavaScript</span></span></p><a></a><p class="calibre37"> Mongo’s native tongue is JavaScript, be it as complex as mapreduce queries or as simple as asking for help. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; db.help()​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; db.towns.help()​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> These commands will list available functions related to the given object. <span class="calibre9"><span class="calibre30">db</span></span> is a JavaScript object that contains information about the current database. <span class="calibre9"><span class="calibre30">db.x</span></span> is a JavaScript object representing a collection (named <span class="calibre9"><span class="calibre30">x</span></span>). Commands are just JavaScript functions. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; </span><span class="calibre9"><span class="bold"><span class="calibre44">typeof</span></span></span><span class="calibre9"> db​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​object​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; </span><span class="calibre9"><span class="bold"><span class="calibre44">typeof</span></span></span><span class="calibre9"> db.towns​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​object​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; </span><span class="calibre9"><span class="bold"><span class="calibre44">typeof</span></span></span><span class="calibre9"> db.towns.insert​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If you want to inspect the source code for a function, call it without parameters or parentheses (think more Python than Ruby). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.towns.insert​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9"> (obj, _allow_dot) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> (!obj) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        </span><span class="calibre9"><span class="bold"><span class="calibre44">throw</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="italic"><span class="calibre38">"no object passed to insert!"</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> (!_allow_dot) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        this._validateForStorage(obj);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> (</span><span class="calibre9"><span class="bold"><span class="calibre44">typeof</span></span></span><span class="calibre9"> obj._id == </span><span class="calibre9"><span class="italic"><span class="calibre38">"undefined"</span></span></span><span class="calibre9">) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> tmp = obj;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        obj = {_id:</span><span class="calibre9"><span class="bold"><span class="calibre44">new</span></span></span><span class="calibre9"> ObjectId};​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        </span><span class="calibre9"><span class="bold"><span class="calibre44">for</span></span></span><span class="calibre9"> (</span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> key </span><span class="calibre9"><span class="bold"><span class="calibre44">in</span></span></span><span class="calibre9"> tmp) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​            obj[key] = tmp[key];​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    this._mongo.insert(this._fullName, obj);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    this._lastID = obj._id;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Let’s populate a few more documents into our <span class="calibre9"><span class="calibre30">towns</span></span> collection by creating our own JavaScript function. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/mongo/insert_city.js"><span class="calibre41"><span class="calibre13"><span class="underline">mongo/insert_city.js</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9"> insertCity(​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  name, population, last_census,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  famous_for, mayor_info​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  db.towns.insert({​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    name:name,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    population:population,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    last_census: ISODate(last_census),​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    famous_for:famous_for,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    mayor : mayor_info​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  });​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You can just paste the code into the shell. Then we can call it. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​insertCity(</span><span class="calibre9"><span class="italic"><span class="calibre38">"Punxsutawney"</span></span></span><span class="calibre9">, 6200, </span><span class="calibre9"><span class="italic"><span class="calibre38">'2008-31-01'</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  [</span><span class="calibre9"><span class="italic"><span class="calibre38">"phil the groundhog"</span></span></span><span class="calibre9">], { name : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Jim Wehrle"</span></span></span><span class="calibre9"> }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​insertCity(</span><span class="calibre9"><span class="italic"><span class="calibre38">"Portland"</span></span></span><span class="calibre9">, 582000, </span><span class="calibre9"><span class="italic"><span class="calibre38">'2007-20-09'</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  [</span><span class="calibre9"><span class="italic"><span class="calibre38">"beer"</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">"food"</span></span></span><span class="calibre9">], { name : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Sam Adams"</span></span></span><span class="calibre9">, party : </span><span class="calibre9"><span class="italic"><span class="calibre38">"D"</span></span></span><span class="calibre9"> }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We should now have three <span class="calibre9"><span class="calibre30">towns</span></span> in our collection, which you can confirm by calling <span class="calibre9"><span class="calibre30">db.towns.find</span></span> as before. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Reading: More Fun in Mongo</span></span></span></p><a></a><p class="calibre29"> Earlier we called the <span class="calibre9"><span class="calibre30">find</span></span> function without params to get all documents. To access a specific one, you only need to set an <span class="calibre9"><span class="calibre30">_id</span></span> property. <span class="calibre9"><span class="calibre30">_id</span></span> is of type <span class="calibre9"><span class="calibre30">ObjectId</span></span>, and so to query, you must convert a string by wrapping it in an <span class="calibre9"><span class="calibre30">ObjectId(str)</span></span> function. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.towns.find({ "_id" : ObjectId(</span><span class="calibre9"><span class="italic"><span class="calibre38">"4d0ada1fbb30773266f39fe4"</span></span></span><span class="calibre9">) })​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "_id" : ObjectId(</span><span class="calibre9"><span class="italic"><span class="calibre38">"4d0ada1fbb30773266f39fe4"</span></span></span><span class="calibre9">),​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Punxsutawney"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "population" : 6200,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "last_census" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Thu Jan 31 2008 00:00:00 GMT-0800 (PST)"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "famous_for" : [ </span><span class="calibre9"><span class="italic"><span class="calibre38">"phil the groundhog"</span></span></span><span class="calibre9"> ],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "mayor" : { "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Jim Wehrle"</span></span></span><span class="calibre9"> }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The <span class="calibre9"><span class="calibre30">find</span></span> function also accepts an optional second parameter: a fields object we can use to filter which fields are retrieved. If we want only the town name (along with <span class="calibre9"><span class="calibre30">_id</span></span>), pass in <span class="calibre9"><span class="calibre30">name</span></span> with a value resolving to <span class="calibre9"><span class="calibre30">1</span></span> (or <span class="calibre9"><span class="calibre30">true</span></span>). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.towns.find({ _id : ObjectId(</span><span class="calibre9"><span class="italic"><span class="calibre38">"4d0ada1fbb30773266f39fe4"</span></span></span><span class="calibre9">) }, { name : 1 })​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "_id" : ObjectId(</span><span class="calibre9"><span class="italic"><span class="calibre38">"4d0ada1fbb30773266f39fe4"</span></span></span><span class="calibre9">),​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Punxsutawney"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> To retrieve all fields <span class="italic">except</span> <span class="calibre9"><span class="calibre30">name</span></span>, set <span class="calibre9"><span class="calibre30">name</span></span> to <span class="calibre9"><span class="calibre30">0</span></span> (or <span class="calibre9"><span class="calibre30">false</span></span> or <span class="calibre9"><span class="calibre30">null</span></span>). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.towns.find({ _id : ObjectId(</span><span class="calibre9"><span class="italic"><span class="calibre38">"4d0ada1fbb30773266f39fe4"</span></span></span><span class="calibre9">) }, { name : 0 })​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "_id" : ObjectId(</span><span class="calibre9"><span class="italic"><span class="calibre38">"4d0ada1fbb30773266f39fe4"</span></span></span><span class="calibre9">),​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "population" : 6200,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "last_census" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Thu Jan 31 2008 00:00:00 GMT-0800 (PST)"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "famous_for" : [ </span><span class="calibre9"><span class="italic"><span class="calibre38">"phil the groundhog"</span></span></span><span class="calibre9"> ]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><p class="calibre45" id="filepos902266"> Like PostgreSQL, in Mongo you can construct ad hoc queries by field values, ranges, or a combination of criteria. To find all towns that begin with the letter <span class="calibre9"><span class="italic"><span class="calibre38">P</span></span></span> and have a population less than 10,000, you can use a Perl-compatible regular expression (PCRE)<a href="#filepos1142834"><span class="calibre13"><span class="underline">[38]</span></span></a> and a range operator. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.towns.find(​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { name : /^P/, population : { $lt : 10000 } },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { name : 1, population : 1 }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Punxsutawney"</span></span></span><span class="calibre9">, "population" : 6200 }​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Conditional operators in Mongo follow the format of <span class="calibre9"><span class="calibre30">field : { $op : value }</span></span>, where <span class="calibre9"><span class="calibre30">$op</span></span> is an operation like <span class="calibre9"><span class="calibre30">$ne</span></span> (not equal to). You may want a terser syntax, like <span class="calibre9"><span class="calibre30">field &lt; value</span></span>. But this is JavaScript code, not a domain-specific query language, so queries must comply with JavaScript syntax rules (later today we’ll see how to use the shorter syntax in a certain case, but we’ll skip that for now). </p><a></a><p class="calibre12"> The good news about the query language being JavaScript is you can construct operations as you would objects. Here, we build criteria where the population must be between 10,000 and 1 million people. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> population_range = {}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​population_range[</span><span class="calibre9"><span class="italic"><span class="calibre38">'$lt'</span></span></span><span class="calibre9">] = 1000000​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​population_range[</span><span class="calibre9"><span class="italic"><span class="calibre38">'$gt'</span></span></span><span class="calibre9">] = 10000​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.towns.find(​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { name : /^P/, population : population_range },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { name: 1 }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​)​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ "_id" : ObjectId(</span><span class="calibre9"><span class="italic"><span class="calibre38">"4d0ada87bb30773266f39fe5"</span></span></span><span class="calibre9">), "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Portland"</span></span></span><span class="calibre9"> }​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We are not limited to number ranges but can also retrieve date ranges. We can find all names with a <span class="calibre9"><span class="italic"><span class="calibre38">last_census</span></span></span> less than or equal to January 31, 2008, like this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.towns.find(​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { last_census : { $lte : ISODate(</span><span class="calibre9"><span class="italic"><span class="calibre38">'2008-31-01'</span></span></span><span class="calibre9">) } },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { _id : 0, name: 1 }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​)​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Punxsutawney"</span></span></span><span class="calibre9"> }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Portland"</span></span></span><span class="calibre9"> }​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Notice how we suppressed the <span class="calibre9"><span class="calibre30">_id</span></span> field in the output explicitly by setting it to <span class="calibre9"><span class="calibre30">0</span></span>. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Digging Deep</span></span></span></p><a></a><p class="calibre29"> Mongo loves nested array data. You can query by matching exact values… </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.towns.find(​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { famous_for : </span><span class="calibre9"><span class="italic"><span class="calibre38">'food'</span></span></span><span class="calibre9"> },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { _id : 0, name : 1, famous_for : 1 }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​)​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"New York"</span></span></span><span class="calibre9">, "famous_for" : [ </span><span class="calibre9"><span class="italic"><span class="calibre38">"statue of liberty"</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">"food"</span></span></span><span class="calibre9"> ] }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Portland"</span></span></span><span class="calibre9">, "famous_for" : [ </span><span class="calibre9"><span class="italic"><span class="calibre38">"beer"</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">"food"</span></span></span><span class="calibre9"> ] }​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> …as well as matching partial values… </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.towns.find(​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { famous_for : /statue/ },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { _id : 0, name : 1, famous_for : 1 }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​)​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"New York"</span></span></span><span class="calibre9">, "famous_for" : [ </span><span class="calibre9"><span class="italic"><span class="calibre38">"statue of liberty"</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">"food"</span></span></span><span class="calibre9"> ] }​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> …or query by all matching values… </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.towns.find(​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { famous_for : { $all : [</span><span class="calibre9"><span class="italic"><span class="calibre38">'food'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'beer'</span></span></span><span class="calibre9">] } },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { _id : 0, name:1, famous_for:1 }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​)​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Portland"</span></span></span><span class="calibre9">, "famous_for" : [ </span><span class="calibre9"><span class="italic"><span class="calibre38">"beer"</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">"food"</span></span></span><span class="calibre9"> ] }​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> …or the lack of matching values: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.towns.find(​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { famous_for : { $nin : [</span><span class="calibre9"><span class="italic"><span class="calibre38">'food'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'beer'</span></span></span><span class="calibre9">] } },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { _id : 0, name : 1, famous_for : 1 }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​)​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Punxsutawney"</span></span></span><span class="calibre9">, "famous_for" : [ </span><span class="calibre9"><span class="italic"><span class="calibre38">"phil the groundhog"</span></span></span><span class="calibre9"> ] }​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> But the true power of Mongo stems from its ability to dig down into a document and return the results of deeply nested subdocuments. To query a subdocument, your field name is a string separating nested layers with a dot. For instance, you can find towns with independent mayors… </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.towns.find(​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { 'mayor.party' : </span><span class="calibre9"><span class="italic"><span class="calibre38">'I'</span></span></span><span class="calibre9"> },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { _id : 0, name : 1, mayor : 1 }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​)​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"New York"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "mayor" : {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Michael Bloomberg"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "party" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"I"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> …or those with mayors who don’t have a party: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.towns.find(​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { 'mayor.party' : { $exists : false } },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { _id : 0, name : 1, mayor : 1 }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​)​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Punxsutawney"</span></span></span><span class="calibre9">, "mayor" : { "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Jim Wehrle"</span></span></span><span class="calibre9"> } }​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The previous queries are great if you want to find documents with a single matching field, but what if we need to match several fields of a subdocument? </p><p class="calibre12"><span class="bold"><span class="calibre28">elemMatch</span></span></p><a></a><p class="calibre37"> We’ll round out our dig with the <span class="calibre9"><span class="calibre30">$elemMatch</span></span> directive. Let’s create another collection that stores countries. This time we’ll override each <span class="calibre9"><span class="calibre30">_id</span></span> to be a string of our choosing. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.countries.insert({​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  _id : </span><span class="calibre9"><span class="italic"><span class="calibre38">"us"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  name : </span><span class="calibre9"><span class="italic"><span class="calibre38">"United States"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  exports : {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    foods : [​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      { name : </span><span class="calibre9"><span class="italic"><span class="calibre38">"bacon"</span></span></span><span class="calibre9">, tasty : true },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      { name : </span><span class="calibre9"><span class="italic"><span class="calibre38">"burgers"</span></span></span><span class="calibre9"> }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    ]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​})​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.countries.insert({​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  _id : </span><span class="calibre9"><span class="italic"><span class="calibre38">"ca"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  name : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Canada"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  exports : {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    foods : [​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      { name : </span><span class="calibre9"><span class="italic"><span class="calibre38">"bacon"</span></span></span><span class="calibre9">, tasty : false },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      { name : </span><span class="calibre9"><span class="italic"><span class="calibre38">"syrup"</span></span></span><span class="calibre9">, tasty : true }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    ]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​})​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.countries.insert({​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  _id : </span><span class="calibre9"><span class="italic"><span class="calibre38">"mx"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  name : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Mexico"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  exports : {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    foods : [{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      name : </span><span class="calibre9"><span class="italic"><span class="calibre38">"salsa"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      tasty : true,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      condiment : true​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​})​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> To validate the countries were added, we can execute the count function, expecting the number 3. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; print( db.countries.count() )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​3​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Let’s find a country that not only exports bacon but exports <span class="italic">tasty</span> bacon. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.countries.find(​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { 'exports.foods.name' : </span><span class="calibre9"><span class="italic"><span class="calibre38">'bacon'</span></span></span><span class="calibre9">,  'exports.foods.tasty' : true },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { _id : 0, name : 1 }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​)​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"United States"</span></span></span><span class="calibre9"> }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Canada"</span></span></span><span class="calibre9"> }​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> But this isn’t what we wanted. Mongo returned <span class="italic">Canada</span> because it exports bacon and exports tasty syrup. <span class="calibre9"><span class="calibre30">$elemMatch</span></span> helps us here. It specifies that if a document (or nested document) matches <span class="italic">all</span> of our criteria, the document counts as a match. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.countries.find(​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    'exports.foods' : {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      $elemMatch : {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        name : </span><span class="calibre9"><span class="italic"><span class="calibre38">'bacon'</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        tasty : true​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { _id : 0, name : 1 }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​)​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"United States"</span></span></span><span class="calibre9"> }​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"><span class="calibre9"><span class="calibre30">$elemMatch</span></span> criteria can utilize advanced operators, too. You can find any country that exports a tasty food that also has a condiment label: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.countries.find(​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    'exports.foods' : {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      $elemMatch : {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        tasty : true,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        condiment : { $exists : true }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { _id : 0, name : 1 }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​)​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Mexico"</span></span></span><span class="calibre9"> }​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Mexico is just what we wanted. </p><p class="calibre12"><span class="bold"><span class="calibre28">Boolean Ops</span></span></p><a></a><p class="calibre37"> So far, all of our criteria are implicitly <span class="italic">and</span> operations. If you try to find a country with the name <span class="calibre9"><span class="italic"><span class="calibre38">United States</span></span></span> and an <span class="calibre9"><span class="calibre30">_id</span></span> of <span class="calibre9"><span class="italic"><span class="calibre38">mx</span></span></span>, Mongo will yield no results. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.countries.find(​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { _id : </span><span class="calibre9"><span class="italic"><span class="calibre38">"mx"</span></span></span><span class="calibre9">, name : </span><span class="calibre9"><span class="italic"><span class="calibre38">"United States"</span></span></span><span class="calibre9"> },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { _id : 1 }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> However, searching for one <span class="italic">or</span> the other with <span class="calibre9"><span class="calibre30">$or</span></span> will return two results. Think of this layout like <span class="italic">prefix notation</span>: <span class="calibre9"><span class="calibre30">OR A B</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.countries.find(​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    $or : [​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      { _id : </span><span class="calibre9"><span class="italic"><span class="calibre38">"mx"</span></span></span><span class="calibre9"> },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      { name : </span><span class="calibre9"><span class="italic"><span class="calibre38">"United States"</span></span></span><span class="calibre9"> }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    ]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { _id:1 }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​)​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ "_id" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"us"</span></span></span><span class="calibre9"> }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ "_id" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"mx"</span></span></span><span class="calibre9"> }​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> There are so many operators we can’t cover them all here, but we hope this has given you a taste of MongoDB’s powerful query ability. The following is is not a complete list of the commands but a good chunk of them. </p><br class="calibre1"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Command  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Description  </span></blockquote></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">$regex  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Match by any PCRE-compliant regular expression string (or just use the // delimiters as shown earlier)  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">$ne  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Not equal to  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">$lt  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Less than  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">$lte  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Less than or equal to  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">$gt  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Greater than  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">$gte  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Greater than or equal to  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">$exists  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Check for the existence of a field  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">$all  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Match all elements in an array  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">$in  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Match any elements in an array  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">$nin  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Does not match any elements in an array  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">$elemMatch  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Match all fields in an array of nested documents  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">$or  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">or  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">$nor  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Not or  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">$size  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Match array of given size  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">$mod  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Modulus  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">$type  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Match if field is a given datatype  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">$not  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Negate the given operator check  </blockquote></td></tr></table><a></a><p class="calibre23"> You can find all the commands on the MongoDB online documentation or grab a cheat sheet from the Mongo website. We will revisit querying in the days to come. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Updating</span></span></span></p><a></a><p class="calibre29"> We have a problem. New York and Punxsutawney are unique enough, but did we add Portland, Oregon, or Portland, Maine (or Texas or the others)? Let’s update our <span class="calibre9"><span class="calibre30">towns</span></span> collection to add some U.S. states. </p><a></a><p class="calibre12"> The <span class="calibre9"><span class="calibre30">update(criteria,operation)</span></span> function requires two parameters. The first is a criteria query—the same sort of object you would pass to <span class="calibre9"><span class="calibre30">find</span></span>. The second parameter is either an object whose fields will replace the matched document(s) or a modifier operation. In this case, the modifier is to <span class="calibre9"><span class="calibre30">$set</span></span> the field <span class="calibre9"><span class="calibre30">state</span></span> with the string <span class="calibre9"><span class="italic"><span class="calibre38">OR</span></span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.towns.update(​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { _id : ObjectId(</span><span class="calibre9"><span class="italic"><span class="calibre38">"4d0ada87bb30773266f39fe5"</span></span></span><span class="calibre9">) },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { $set : { "state" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"OR"</span></span></span><span class="calibre9"> } }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​);​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You may wonder why the <span class="calibre9"><span class="calibre30">$set</span></span> operation is even required. Mongo doesn’t think in terms of attributes; it has only an internal, implicit understanding of attributes for optimization reasons. But nothing about the interface is <span class="italic">attribute</span>-oriented. Mongo is <span class="italic">document</span>-oriented. You will rarely want something like this (notice the lack of <span class="calibre9"><span class="calibre30">$set</span></span> operation): </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.towns.update(​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { _id : ObjectId(</span><span class="calibre9"><span class="italic"><span class="calibre38">"4d0ada87bb30773266f39fe5"</span></span></span><span class="calibre9">) },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { state : </span><span class="calibre9"><span class="italic"><span class="calibre38">"OR"</span></span></span><span class="calibre9"> }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​);​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This would replace the <span class="italic">entire</span> matching document with the document you gave it (<span class="calibre9"><span class="calibre30">{ state : "OR" }</span></span>). Since you didn’t give it a command like <span class="calibre9"><span class="calibre30">$set</span></span>, Mongo assumes you just want to switch them up, so be careful. </p><a></a><p class="calibre12"> We can verify our update was successful by finding it (note our use of <span class="calibre9"><span class="calibre30">findOne</span></span> to retrieve only one matching object). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.towns.findOne({ _id : ObjectId(</span><span class="calibre9"><span class="italic"><span class="calibre38">"4d0ada87bb30773266f39fe5"</span></span></span><span class="calibre9">) })​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "_id" : ObjectId(</span><span class="calibre9"><span class="italic"><span class="calibre38">"4d0ada87bb30773266f39fe5"</span></span></span><span class="calibre9">),​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "famous_for" : [​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre38">"beer"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre38">"food"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  ],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "last_census" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Thu Sep 20 2007 00:00:00 GMT-0700 (PDT)"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "mayor" : {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Sam Adams"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "party" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"D"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Portland"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "population" : 582000,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "state" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"OR"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You can do more than <span class="calibre9"><span class="calibre30">$set</span></span> a value. <span class="calibre9"><span class="calibre30">$inc</span></span> (increment a number) is a pretty useful one. Let’s increment Portland’s <span class="calibre9"><span class="calibre30">population</span></span> by 1,000. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.towns.update(​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { _id : ObjectId(</span><span class="calibre9"><span class="italic"><span class="calibre38">"4d0ada87bb30773266f39fe5"</span></span></span><span class="calibre9">) },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { $inc : { population : 1000} }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> There are more directives than this, such as the <span class="calibre9"><span class="calibre30">$</span></span> positional operator for arrays. New operations are added frequently and are updated in the online documentation. Here are the major directives: </p><br class="calibre1"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Command  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Description  </span></blockquote></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">$set  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Sets the given field with the given value  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">$unset  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Removes the field  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">$inc  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Adds the given field by the given number  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">$pop  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Removes the last (or first) element from an array  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">$push  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Adds the value to an array  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">$pushAll  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Adds all values to an array  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">$addToSet  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Similar to push, but won’t duplicate values  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">$pull  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Removes matching value from an array  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">$pullAll  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Removes all matching values from an array  </blockquote></td></tr></table><blockquote class="calibre94"><span class="calibre41"><span class="bold">Spelling Bee Warning</span></span></blockquote><a></a><blockquote class="calibre42"><span class="calibre41"> Mongo is not very friendly when it comes to misspellings. If you haven’t run across this problem yet, you probably will at some point, so be warned. You can draw parallels between static and dynamic programming languages. You define static up front, while dynamic will accept values you may not have intended, even nonsensical types like </span><span class="calibre9"><span class="calibre30">person_name = 5</span></span><span class="calibre41">. </span></blockquote><a></a><blockquote class="calibre47"><span class="calibre41"> Documents are schemaless, so Mongo has no way of knowing if you intended on inserting </span><span class="calibre9"><span class="calibre30">pipulation</span></span><span class="calibre41"> into your city or meant to querying on </span><span class="calibre9"><span class="calibre30">lust_census</span></span><span class="calibre41">; it will happily insert those fields or return no matching values. </span></blockquote><a></a><blockquote class="calibre47"><span class="calibre41"> Flexibility has its price. </span><span class="calibre41"><span class="italic">Caveat emptor</span></span><span class="calibre41">. </span></blockquote><p class="calibre61"><span class="calibre5"><span class="bold"><span class="calibre28">References</span></span></span></p><a></a><p class="calibre29"> As we mentioned previously, Mongo isn’t built to perform joins. Because of its distributed nature, joins are pretty inefficient operations. Still, it’s sometimes useful for documents to reference each other. In these cases, the Mongo development team suggests you use a construct like <span class="calibre9"><span class="calibre30">{ $ref : "collection_name", $id : "reference_id" }</span></span>. For example, we can update the <span class="calibre9"><span class="calibre30">towns</span></span> collection to contain a reference to a document in <span class="calibre9"><span class="calibre30">countries</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.towns.update(​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { _id : ObjectId(</span><span class="calibre9"><span class="italic"><span class="calibre38">"4d0ada87bb30773266f39fe5"</span></span></span><span class="calibre9">) },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { $set : { country: { $ref: </span><span class="calibre9"><span class="italic"><span class="calibre38">"countries"</span></span></span><span class="calibre9">, $id: </span><span class="calibre9"><span class="italic"><span class="calibre38">"us"</span></span></span><span class="calibre9"> } } }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Now you can retrieve Portland from your <span class="calibre9"><span class="calibre30">towns</span></span> collection. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> portland = db.towns.findOne({ _id : ObjectId(</span><span class="calibre9"><span class="italic"><span class="calibre38">"4d0ada87bb30773266f39fe5"</span></span></span><span class="calibre9">) })​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Then, to retrieve the town’s country, you can query the <span class="calibre9"><span class="calibre30">countries</span></span> collection using the stored <span class="calibre9"><span class="calibre30">$id</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.countries.findOne({ _id: portland.country.$id })​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Better yet, in JavaScript, you can ask the town document the name of the collection stored in the fields reference. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db[ portland.country.$ref ].findOne({ _id: portland.country.$id })​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The last two queries are equivalent; the second is just a bit more data-driven. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Deleting</span></span></span></p><a></a><p class="calibre29"> Removing documents from a collection is simple. Merely replace the find function with a call to <span class="calibre9"><span class="calibre30">remove</span></span>, and all matched criteria will be removed. It’s important to note that the entire matching document will be removed, not simply a matching element or a matching subdocument. </p><a></a><p class="calibre12"> We recommend running <span class="calibre9"><span class="calibre30">find</span></span> to verify your criteria before running <span class="calibre9"><span class="calibre30">remove</span></span>. Mongo won’t think twice before running your operation. Let’s remove all countries that export bacon that isn’t tasty. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> bad_bacon = {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  'exports.foods' : {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    $elemMatch : {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      name : </span><span class="calibre9"><span class="italic"><span class="calibre38">'bacon'</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      tasty : false​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.countries.find( bad_bacon )​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "_id" : ObjectId(</span><span class="calibre9"><span class="italic"><span class="calibre38">"4d0b7b84bb30773266f39fef"</span></span></span><span class="calibre9">),​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Canada"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "exports" : {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "foods" : [​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"bacon"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "tasty" : false​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"syrup"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "tasty" : true​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    ]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Everything looks good. Let’s remove it. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.countries.remove( bad_bacon )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.countries.count()​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​2​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Now when you run <span class="calibre9"><span class="calibre30">count</span></span>, verify we are left with only two countries. If so, our delete was successful! </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Reading with Code</span></span></span></p><a></a><p class="calibre29"> Let’s close out this day with one more interesting query option: code. You can request that MongoDB run a decision function across your documents. We placed this last because it should always be a last resort. These queries run quite slowly, you can’t index them, and Mongo can’t optimize them. But sometimes it’s hard to beat the power of custom code. </p><a></a><p class="calibre12"> Say we’re looking for a population between 6,000 and 600,000 people. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.towns.find( </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">() {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">return</span></span></span><span class="calibre9"> this.population &gt; 6000 &amp;&amp; this.population &lt; 600000;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​} )​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Mongo even has a shortcut for simple decision functions. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.towns.find(</span><span class="calibre9"><span class="italic"><span class="calibre38">"this.population &gt; 6000 &amp;&amp; this.population &lt; 600000"</span></span></span><span class="calibre9">)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You can run custom code with other criteria using the <span class="calibre9"><span class="calibre30">$where</span></span> clause. In this example, the query also filters for towns famous for groundhogs. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.towns.find( {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  $where : </span><span class="calibre9"><span class="italic"><span class="calibre38">"this.population &gt; 6000 &amp;&amp; this.population &lt; 600000"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  famous_for : /groundhog/​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​} )​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> A word of warning: Mongo will brutishly run this function against each document, and there is no guarantee that the given field exists. For example, if you assume a <span class="calibre9"><span class="italic"><span class="calibre38">population</span></span></span> field exists and <span class="calibre9"><span class="italic"><span class="calibre38">population</span></span></span> is missing in even a single document, the entire query will fail, since the JavaScript cannot properly execute. Be careful when you write custom JavaScript functions, and be comfortable using JavaScript before attempting custom code. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Day 1 Wrap-Up</span></span></span></p><a></a><p class="calibre29"> Today we took a peek at our first document database, MongoDB. We saw how we can store nested structured data as JSON objects and query that data at any depth. You learned that a <span class="italic">document</span> can be envisioned as a schemaless row in the relational model, keyed by a generated <span class="calibre9"><span class="calibre30">_id</span></span>. A set of documents is called a <span class="italic">collection</span> in Mongo, similar to a <span class="italic">table</span> in PostgreSQL. </p><a></a><p class="calibre12"> Unlike the previous styles we’ve encountered, with collections of sets of simple datatypes, Mongo stores complex, denormalized documents, stored and retrieved as collections of arbitrary JSON structures. Mongo tops off this flexible storage strategy with a powerful query mechanism not constrained by any predefined schema. </p><a></a><p class="calibre12"> Its denormalized nature makes a document datastore a superb choice for storing data with unknown qualities, while other styles (such as relational or columnar) prefer you know in advance and require schema migrations to add or edit fields. </p><p class="calibre12"><span class="bold"><span class="calibre28">Day 1 Homework</span></span></p><p class="calibre37"><span class="bold">Find</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Bookmark the online MongoDB documentation.</p></li><li value="2" class="calibre36"><p class="calibre22">Look up how to construct regular expressions in Mongo.</p></li><li value="3" class="calibre36"><p class="calibre22">Acquaint yourself with command-line <span class="calibre9"><span class="calibre30">db.help</span></span> and <span class="calibre9"><span class="calibre30">db.collections.help</span></span> output.</p></li><li value="4" class="calibre36"><p class="calibre22">Find a Mongo driver in your programming language of choice (Ruby, Java, PHP, and so on).</p></li></ol><p class="calibre12"><span class="bold">Do</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Print a JSON document containing <span class="calibre9"><span class="calibre30">{ "hello" : "world" }</span></span>.</p></li><li value="2" class="calibre36"><p class="calibre22">Select a town via a case-insensitive regular expression containing the word <span class="italic">new</span>.</p></li><li value="3" class="calibre36"><p class="calibre22">Find all cities whose names contain an <span class="italic">e</span> and are famous for food or beer.</p></li><li value="4" class="calibre36"><p class="calibre22">Create a new database named <span class="calibre9"><span class="italic"><span class="calibre38">blogger</span></span></span> with a collection named <span class="calibre9"><span class="italic"><span class="calibre38">articles</span></span></span>—insert a new article with an author name and email, creation date, and text.</p></li><li value="5" class="calibre36"><p class="calibre22">Update the article with an array of comments, containing a comment with an author and text.</p></li><li value="6" class="calibre36"><p class="calibre22">Run a query from an external JavaScript file.</p></li></ol><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos988577" class="calibre1"><p class="calibre24" id="filepos988582"><span class="calibre25"><span class="bold"><span class="calibre26">5.3 Day 2: Indexing, Grouping, Mapreduce</span></span></span></p><a></a><p class="calibre27"> Increasing MongoDB’s query performance is the first item on today’s docket, followed by some more powerful and complex grouped queries. Finally, we’ll round out the day with some data analysis using mapreduce, similar to what we did with Riak. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Indexing: When Fast Isn’t Fast Enough</span></span></span></p><a></a><p class="calibre29"> One of Mongo’s useful built-in features is indexing to increase query performance—something, as we’ve seen, that’s not available on all NoSQL databases. MongoDB provides several of the best data structures for indexing, such as the classic B-tree, and other additions such as two-dimensional and spherical GeoSpatial indexes. </p><a></a><p class="calibre12"> For now we’re going to do a little experiment to see the power of MongoDB’s B-tree index by populating a series of phone numbers with a random country prefix (feel free to replace this code with your own country code). Enter the following code into your console. This will generate 100,000 phone numbers (it may take a while), between <span class="calibre9"><span class="italic"><span class="calibre38">1-800-555-0000</span></span></span> and <span class="calibre9"><span class="italic"><span class="calibre38">1-800-565-9999</span></span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/mongo/populate_phones.js"><span class="calibre41"><span class="calibre13"><span class="underline">mongo/populate_phones.js</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​populatePhones = </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(area,start,stop) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">for</span></span></span><span class="calibre9">(</span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> i=start; i &lt; stop; i++) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> country = 1 + ((Math.random() * 8) &lt;&lt; 0);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> num = (country * 1e10) + (area * 1e7) + i;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    db.phones.insert({​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      _id: num,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      components: {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        country: country,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        area: area,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        prefix: (i * 1e-4) &lt;&lt; 0,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        number: i​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      display: </span><span class="calibre9"><span class="italic"><span class="calibre38">"+"</span></span></span><span class="calibre9"> + country + </span><span class="calibre9"><span class="italic"><span class="calibre38">" "</span></span></span><span class="calibre9"> + area + </span><span class="calibre9"><span class="italic"><span class="calibre38">"-"</span></span></span><span class="calibre9"> + i​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    });​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Run the function with a three-digit area code (like 800) and a range of seven-digit numbers (5,550,000 to 5,650,000—please verify your zeros when typing). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​populatePhones( 800, 5550000, 5650000 )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.phones.find().limit(2)​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ "_id" : 18005550000, "components" : { "country" : 1, "area" : 800,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "prefix" : 555, "number" : 5550000 }, "display" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"+1 800-5550000"</span></span></span><span class="calibre9"> }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ "_id" : 88005550001, "components" : { "country" : 8, "area" : 800,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "prefix" : 555, "number" : 5550001 }, "display" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"+8 800-5550001"</span></span></span><span class="calibre9"> }​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Whenever a new collection is created, Mongo automatically creates an index by the <span class="calibre9"><span class="calibre30">_id</span></span>. These indexes can be found in the <span class="calibre9"><span class="calibre30">system.indexes</span></span> collection. The following query shows all indexes in the database: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.system.indexes.find()​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"_id_"</span></span></span><span class="calibre9">, "ns" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"book.phones"</span></span></span><span class="calibre9">, "key" : { "_id" : 1 } }​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Most queries will include more fields than just the <span class="calibre9"><span class="calibre30">_id</span></span>, so we need to make indexes on those fields. </p><a></a><p class="calibre12"> We’re going to create a B-tree index on the <span class="calibre9"><span class="calibre30">display</span></span> field. But first, let’s verify that the index will improve speed. To do this, we’ll first check a query without an index. The <span class="calibre9"><span class="calibre30">explain</span></span> method is used to output details of a given operation. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.phones.find({display: </span><span class="calibre9"><span class="italic"><span class="calibre38">"+1 800-5650001"</span></span></span><span class="calibre9">}).explain()​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "cursor" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"BasicCursor"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "nscanned" : 109999,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "nscannedObjects" : 109999,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "n" : 1,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "millis" : 52,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "indexBounds" : {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Your output will not equal ours, but note the <span class="calibre9"><span class="calibre30">millis</span></span> field—milliseconds to complete the query—will likely be double digits. </p><a></a><p class="calibre12"> We create an index by calling <span class="calibre9"><span class="calibre30">ensureIndex(fields,options)</span></span> on the collection. The <span class="calibre9"><span class="calibre30">fields</span></span> parameter is an object containing the fields to be indexed against. The <span class="calibre9"><span class="calibre30">options</span></span> parameter describes the type of index to make. In this case, we’re building a unique index on <span class="calibre9"><span class="calibre30">display</span></span> that should just drop duplicate entries. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.phones.ensureIndex(​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { display : 1 },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  { unique : true, dropDups : true }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Now try <span class="calibre9"><span class="calibre30">find</span></span> again, and check <span class="calibre9"><span class="calibre30">explain</span></span> to see whether the situation improves. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.phones.find({ display: </span><span class="calibre9"><span class="italic"><span class="calibre38">"+1 800-5650001"</span></span></span><span class="calibre9"> }).explain()​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "cursor" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"BtreeCursor display_1"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "nscanned" : 1,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "nscannedObjects" : 1,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "n" : 1,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "millis" : 0,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "indexBounds" : {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "display" : [​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      [​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        </span><span class="calibre9"><span class="italic"><span class="calibre38">"+1 800-5650001"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        </span><span class="calibre9"><span class="italic"><span class="calibre38">"+1 800-5650001"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      ]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    ]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The millis value changed from 52 to 0—an infinity improvement (52 / 0)! Just kidding, but it is an orders of magnitude speedup. Also notice the cursor changed from a Basic to a B-tree cursor (it’s called a cursor because it points to where values are stored; it doesn’t contain them). Mongo is no longer doing a full collection scan but instead walking the tree to retrieve the value. Importantly, scanned objects dropped from 109999 to 1—since it has become just a unique lookup. </p><a></a><p class="calibre12"><span class="calibre9"><span class="calibre30">explain</span></span> is a useful function, but you’ll use it only when testing specific query calls. If you need to profile in a normal test or production environment, you’ll need the <span class="italic">system profiler</span>. </p><a></a><p class="calibre12"> Let’s set the profiling level to 2 (level 2 stores all queries; profiling level 1 stores only slower queries greater than 100 milliseconds) and then run <span class="calibre9"><span class="calibre30">find</span></span> as normal. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.setProfilingLevel(2)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.phones.find({ display : </span><span class="calibre9"><span class="italic"><span class="calibre38">"+1 800-5650001"</span></span></span><span class="calibre9"> })​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This will create a new object in the <span class="calibre9"><span class="calibre30">system.profile</span></span> collection, which you can read as any other table. <span class="calibre9"><span class="italic"><span class="calibre38">ts</span></span></span> is the timestamp of when the query was performed, <span class="calibre9"><span class="italic"><span class="calibre38">info</span></span></span> is a string description of the operation, and <span class="calibre9"><span class="italic"><span class="calibre38">millis</span></span></span> is the length of time it took. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.system.profile.find()​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "ts" : ISODate(</span><span class="calibre9"><span class="italic"><span class="calibre38">"2011-12-05T19:26:40.310Z"</span></span></span><span class="calibre9">),​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "op" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"query"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "ns" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"book.phones"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "query" : { "display" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"+1 800-5650001"</span></span></span><span class="calibre9"> },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "responseLength" : 146,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "millis" : 0,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "client" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"127.0.0.1"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "user" : </span><span class="calibre9"><span class="italic"><span class="calibre38">""</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Like yesterday’s nested queries, Mongo can build your index on nested values. If you wanted to index on all area codes, use the dot-notated field representation: <span class="calibre9"><span class="calibre30">components.area</span></span>. In production, you should always build indexes in the background using the <span class="calibre9"><span class="calibre30">{ background : 1 }</span></span> option. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.phones.ensureIndex({ "components.area": 1 }, { background : 1 })​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If we <span class="calibre9"><span class="calibre30">find</span></span> all of the system indexes for our <span class="calibre9"><span class="calibre30">phones</span></span> collection, the new one should appear last. The first index is always automatically created to quickly look up by <span class="calibre9"><span class="calibre30">_id</span></span>, and the second is the unique index we made previously. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.system.indexes.find({ "ns" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"book.phones"</span></span></span><span class="calibre9"> })​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"_id_"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "ns" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"book.phones"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "key" : { "_id" : 1 }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "_id" : ObjectId(</span><span class="calibre9"><span class="italic"><span class="calibre38">"4d2c96d1df18c2494fa3061c"</span></span></span><span class="calibre9">),​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "ns" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"book.phones"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "key" : { "display" : 1 },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"display_1"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "unique" : true,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "dropDups" : true​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "_id" : ObjectId(</span><span class="calibre9"><span class="italic"><span class="calibre38">"4d2c982bdf18c2494fa3061d"</span></span></span><span class="calibre9">),​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "ns" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"book.phones"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "key" : { "components.area" : 1 },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"components.area_1"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Our <span class="calibre9"><span class="italic"><span class="calibre38">book.phones</span></span></span> indexes have rounded out quite nicely. </p><a></a><p class="calibre12"> We should close this section by noting that creating an index on a large collection can be slow and resource-intensive. You should always consider these impacts when building an index by creating indexes off-peak times, running index creation in the background, and running them manually rather than using automated index creation. There are plenty more indexing tricks and tips online, but these are the basics that are good to know. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Aggregated Queries</span></span></span></p><a></a><p class="calibre29"> The queries we investigated yesterday are useful for basic extraction of data, but any post-processing would be up to you to handle. For example, say we wanted to count the phone numbers greater than 559--9999; we would prefer the database perform such a count on the back end. Like in PostgreSQL, <span class="calibre9"><span class="calibre30">count</span></span> is the most basic aggregator. It takes a query and returns a number (of matches). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.phones.count({'components.number': { $gt : 5599999 } })​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​50000​</span><span class="calibre9">​</span></p></td></tr></table><blockquote class="calibre40"><span class="calibre41"><span class="bold">Change Is Good</span></span></blockquote><a></a><blockquote class="calibre42"><span class="calibre41"> Aggregated queries return a structure other than the individual documents we’re used to. </span><span class="calibre9"><span class="calibre30">count</span></span><span class="calibre41"> aggregates the result into a count of documents, </span><span class="calibre9"><span class="calibre30">distinct</span></span><span class="calibre41"> aggregates the results into an array of results, and </span><span class="calibre9"><span class="calibre30">group</span></span><span class="calibre41"> returns documents of its own design. Even mapreduce generally takes a bit of effort to retrieve objects that resemble your internal stored documents. </span></blockquote><a></a><p class="calibre43"> To see the power of the next few aggregating queries, let’s add another 100,000 phone numbers to our <span class="calibre9"><span class="calibre30">phones</span></span> collection, this time with a different area code. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​populatePhones( 855, 5550000, 5650000 )​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The <span class="calibre9"><span class="calibre30">distinct</span></span> command returns each matching value (not a full document) where one or more exists. We can get the distinct component numbers that are less than 5,550,005 in this way: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.phones.distinct(</span><span class="calibre9"><span class="italic"><span class="calibre38">'components.number'</span></span></span><span class="calibre9">, {'components.number': { $lt : 5550005 } })​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[ 5550000, 5550001, 5550002, 5550003, 5550004 ]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Although we have two 5,550,000 numbers (one with an 800 area code and one with 855), it appears in the list only once. </p><a></a><p class="calibre12"> The <span class="calibre9"><span class="calibre30">group</span></span> aggregate query is akin to <span class="calibre9"><span class="calibre30">GROUP BY</span></span> in SQL. It’s also the most complex basic query in Mongo. We can count all phone numbers greater than 5,599,999 and group the results into different buckets keyed by area code. <span class="calibre9"><span class="calibre30">key</span></span> is the field we want to group by, <span class="calibre9"><span class="calibre30">cond</span></span> (condition) is the range of values we’re interested in, and <span class="calibre9"><span class="calibre30">reduce</span></span> takes a function that manages how the values are to be output. </p><a></a><p class="calibre12"> Remember mapreduce from the Riak chapter? Our data is already <span class="italic">mapped</span> into our existing collection of documents. No more mapping is necessary; simply reduce the documents. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.phones.group({​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  initial: { count:0 },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  reduce:  </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(phone, output) { output.count++; },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  cond:    { 'components.number': { $gt : 5599999 } },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  key:     { 'components.area' : true }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​})​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[ { "800" : 50000, "855" : 50000 } ]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The following two examples are, admittedly, odd use cases. They serve only to show the flexibility of <span class="calibre9"><span class="calibre30">group</span></span>. </p><a></a><p class="calibre12"> You can easily replicate the <span class="calibre9"><span class="calibre30">count</span></span> function with the following <span class="calibre9"><span class="calibre30">group</span></span> call. Here we leave off the aggregating <span class="calibre9"><span class="calibre30">key</span></span>: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.phones.group({​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  initial: { count:0 },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  reduce:  </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(phone, output) { output.count++; },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  cond:    { 'components.number': { $gt : 5599999 } }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​})​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[ { "count" : 100000 } ]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The first thing we did here was set an initial object with a field named <span class="calibre9"><span class="calibre30">count</span></span> set to 0—fields created here will appear in the output. Next we describe what to do with this field by declaring a reduce function that adds one for every document we encounter. Finally, we gave group a condition restricting which documents to reduce over. Our result was the same as <span class="calibre9"><span class="calibre30">count</span></span> because our condition was the same. We left off a key, since we want every document encountered added to our list. </p><a></a><p class="calibre12"> We can also replicate the <span class="calibre9"><span class="calibre30">distinct</span></span> function. For performance sake, we’ll start by creating an object to store the numbers as fields (we’re effectively creating an ad hoc <span class="italic">set</span>). In the reduce function (which is run for each matching document), we just set the value to 1 as a placeholder (it’s the field we want). </p><a></a><p class="calibre12"> Technically this is all we need. However, if we want to really replicate <span class="calibre9"><span class="calibre30">distinct</span></span>, we should return an array of integers. So, we add a <span class="calibre9"><span class="calibre30">finalize(out)</span></span> method that is run one last time before returning a value to convert the object into an array of field values. The function then converts those number strings into integers (if you really want to see the sausage being made, run the following without the <span class="calibre9"><span class="calibre30">finalize</span></span> function set). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.phones.group({​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  initial: { prefixes : {} },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  reduce:  </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(phone, output) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    output.prefixes[phone.components.prefix] = 1;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  finalize: </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(out) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> ary = [];​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">for</span></span></span><span class="calibre9">(</span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> p </span><span class="calibre9"><span class="bold"><span class="calibre44">in</span></span></span><span class="calibre9"> out.prefixes) { ary.push( parseInt( p ) ); }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    out.prefixes = ary;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​})[0].prefixes​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[ 555, 556, 557, 558, 559, 560, 561, 562, 563, 564 ]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The <span class="calibre9"><span class="calibre30">group</span></span> function is powerful—like <span class="bold"><span class="calibre39">SQL</span></span>’s <span class="calibre9"><span class="calibre30">GROUP BY</span></span>—but Mongo’s implementation has a downside, too. First, you are limited to a result of 10,000 documents. Moreover, if you shard your Mongo collection (which we will tomorrow) <span class="calibre9"><span class="calibre30">group</span></span> won’t work. There are also much more flexible ways of crafting queries. For these and other reasons, we’ll dive into MongoDB’s version of mapreduce in just a bit. But first, we’ll touch on the boundary between client-side and server-side commands, which is a distinction that has important consequences for your applications. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Server-Side Commands</span></span></span></p><a></a><p class="calibre29"> If you were to run the following function through a command line (or through a driver), the client will pull each phone locally, all 100,000 of them, and save each phone document one by one to the server. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/mongo/update_area.js"><span class="calibre41"><span class="calibre13"><span class="underline">mongo/update_area.js</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​update_area = </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">() {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  db.phones.find().forEach(​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(phone) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      phone.components.area++;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      phone.display = </span><span class="calibre9"><span class="italic"><span class="calibre38">"+"</span></span></span><span class="calibre9">+​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        phone.components.country+</span><span class="calibre9"><span class="italic"><span class="calibre38">" "</span></span></span><span class="calibre9">+​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        phone.components.area+</span><span class="calibre9"><span class="italic"><span class="calibre38">"-"</span></span></span><span class="calibre9">+​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        phone.components.number;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      db.phone.update({ _id : phone._id }, phone, false);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> However, the Mongo <span class="calibre9"><span class="calibre30">db</span></span> object provides a command named <span class="calibre9"><span class="calibre30">eval</span></span>, which passes the given function to the server. This dramatically reduces chatter between the client and server since the code is executed remotely. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; db.eval(update_area)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> In addition to evaluating JavaScript functions, there are several other prebuilt commands in Mongo, most of which are executed on the server, although some require executing only under the admin database (which you can access by entering <span class="calibre9"><span class="calibre30">use admin</span></span>). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; use admin​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; db.runCommand(</span><span class="calibre9"><span class="italic"><span class="calibre38">"top"</span></span></span><span class="calibre9">)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The <span class="calibre9"><span class="calibre30">top</span></span> command will output access details about all collections on the server. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; use book​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; db.listCommands()​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> On running <span class="calibre9"><span class="calibre30">listCommands</span></span>, you may notice a lot of commands we’ve used. In fact, you can execute many common commands through the <span class="calibre9"><span class="calibre30">runCommand</span></span> method, such as counting the number of phones. However, you may notice a slightly different output. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; db.runCommand({ "count" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"phones"</span></span></span><span class="calibre9"> })​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ "n" : 100000, "ok" : 1 }​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The number (<span class="calibre9"><span class="italic"><span class="calibre38">n</span></span></span>) returned is correct (100,000), but the format is an object with an <span class="calibre9"><span class="italic"><span class="calibre38">ok</span></span></span> field. That’s because <span class="calibre9"><span class="calibre30">db.phones.count</span></span> is a wrapper function created for our convenience by the shell’s JavaScript interface, whereas <span class="calibre9"><span class="calibre30">runCommand</span></span> is a count executed on the server. Remember that we can play detective on how a function like <span class="calibre9"><span class="calibre30">count</span></span> works by leaving off the calling parentheses. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; db.phones.count​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9"> (x) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">return</span></span></span><span class="calibre9"> this.find(x).count();​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Interesting! <span class="calibre9"><span class="calibre30">collection.count</span></span> is just a convenience wrapper for calling <span class="calibre9"><span class="calibre30">count</span></span> on the results of <span class="calibre9"><span class="calibre30">find</span></span> (which itself is just a wrapper for a native query object that returns a cursor pointing to results). If you run <span class="italic">that</span> query... </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; db.phones.find().count​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> you will get a much larger function (too much to print here). But look in the code, and after a bunch of setup, you’ll find lines like this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> res = this._db.runCommand(cmd);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> (res &amp;&amp; res.n != null) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">return</span></span></span><span class="calibre9"> res.n;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Double interesting! <span class="calibre9"><span class="calibre30">count</span></span> executes <span class="calibre9"><span class="calibre30">runCommand</span></span> and returns the value from the <span class="calibre9"><span class="calibre30">n</span></span> field. </p><p class="calibre12"><span class="bold"><span class="calibre28">runCommand</span></span></p><a></a><p class="calibre37"> And while we’re digging into how methods work, let’s take a look at the <span class="calibre9"><span class="calibre30">runCommand</span></span> function. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; db.runCommand​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9"> (obj) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> (</span><span class="calibre9"><span class="bold"><span class="calibre44">typeof</span></span></span><span class="calibre9"> obj == </span><span class="calibre9"><span class="italic"><span class="calibre38">"string"</span></span></span><span class="calibre9">) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> n = {};​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        n[obj] = 1;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        obj = n;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">return</span></span></span><span class="calibre9"> this.getCollection(</span><span class="calibre9"><span class="italic"><span class="calibre38">"$cmd"</span></span></span><span class="calibre9">).findOne(obj);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> It turns out that <span class="calibre9"><span class="calibre30">runCommand</span></span> is also a helper function that wraps a call to a collection named <span class="calibre9"><span class="calibre30">$cmd</span></span>. You can execute any command using a call directly to this collection. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; db.$cmd.findOne({'count' : </span><span class="calibre9"><span class="italic"><span class="calibre38">'phones'</span></span></span><span class="calibre9">})​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ "n" : 100000, "ok" : 1 }​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This is bare-metal and how drivers generally communicate to the Mongo server. </p><p class="calibre12"><span class="bold"><span class="calibre28">Diversion</span></span></p><a></a><p class="calibre37"> We took this diversion for two reasons: </p><div class="calibre33"> </div><ul class="calibre34"><li value="1" class="calibre35"><p class="calibre22"> To drive home the idea that most of the magic you execute on the <span class="calibre9"><span class="calibre30">mongo</span></span> console is executed on the server, not the client, which just provides convenient wrapper functions. </p></li><li value="2" class="calibre36"><p class="calibre22"> We can leverage the concept of executing server-side code for our own gain to create something in MongoDB that’s similar to the <span class="italic">stored procedures</span> we saw in PostgreSQL. </p></li></ul><a></a><p class="calibre12"> Any JavaScript function can be stored in a special collection named <span class="calibre9"><span class="calibre30">system.js</span></span>. This is a normal collection; you just save the function by setting the name as the <span class="calibre9"><span class="calibre30">_id</span></span>, and <span class="calibre9"><span class="calibre30">value</span></span> is the function object. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; db.system.js.save({​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    _id:</span><span class="calibre9"><span class="italic"><span class="calibre38">'getLast'</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    value:</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(collection){​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="bold"><span class="calibre44">return</span></span></span><span class="calibre9"> collection.find({}).sort({'_id':1}).limit(1)[0]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​})​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> What we normally would do next is execute it on the server directly. The <span class="calibre9"><span class="calibre30">eval</span></span> function passes the string to the server, evaluates it as JavaScript code, and returns the results. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; db.eval(</span><span class="calibre9"><span class="italic"><span class="calibre38">'getLast(db.phones)'</span></span></span><span class="calibre9">)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> It should return the same values as calling <span class="calibre9"><span class="calibre30">getLast(collection)</span></span> locally. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; db.system.js.findOne({'_id': </span><span class="calibre9"><span class="italic"><span class="calibre38">'getLast'</span></span></span><span class="calibre9">}).value(db.phones)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> It’s worth mentioning that <span class="calibre9"><span class="calibre30">eval</span></span> blocks the <span class="calibre9"><span class="calibre30">mongod</span></span> as it runs, so it’s mainly useful for quick one-offs and tests, not common production procedures. You can use this function inside <span class="calibre9"><span class="calibre30">$where</span></span> and mapreduce, too. We have the last weapon in our arsenal to begin executing mapreduce in MongoDB. </p><p class="calibre12" id="filepos1058957"><span class="calibre5"><span class="bold"><span class="calibre28">Mapreduce (and Finalize)</span></span></span></p><a></a><p class="calibre29"> The Mongo mapreduce pattern is similar to Riak’s, with a few small differences. Rather than the <span class="calibre9"><span class="calibre30">map</span></span> function returning a converted value, Mongo requires your mapper to call an <span class="calibre9"><span class="calibre30">emit</span></span> function with a key. The benefit here is that you can emit more than once per document. The <span class="calibre9"><span class="calibre30">reduce</span></span> function accepts a single key and a list of values that were emitted to that key. Finally, Mongo provides an optional third step called <span class="calibre9"><span class="calibre30">finalize</span></span>, which is executed only once per mapped value after the reducers are run. This allows you to perform any final calculations or cleanup you may need. </p><a></a><p class="calibre12"> Since we already know the basics of mapreduce, we’ll skip the intro wading-pool example and go right to the high-dive. Let’s generate a report that counts all phone numbers that contain the same digits for each country. First we’ll store a helper function that extracts an array of all distinct numbers (understanding how this helper works is not imperative to understanding the overall mapreduce). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/mongo/distinct_digits.js"><span class="calibre41"><span class="calibre13"><span class="underline">mongo/distinct_digits.js</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​distinctDigits = </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(phone){​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    number = phone.components.number + </span><span class="calibre9"><span class="italic"><span class="calibre38">''</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    seen = [],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    result = [],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    i = number.length;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">while</span></span></span><span class="calibre9">(i--) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    seen[+number[i]] = 1;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">for</span></span></span><span class="calibre9"> (i=0; i&lt;10; i++) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> (seen[i]) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      result[result.length] = i;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">return</span></span></span><span class="calibre9"> result;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.system.js.save({_id: </span><span class="calibre9"><span class="italic"><span class="calibre38">'distinctDigits'</span></span></span><span class="calibre9">, value: distinctDigits})​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Load the file in the <span class="calibre9"><span class="calibre30">mongo</span></span> command line. If the file exists in the same directory you launched <span class="calibre9"><span class="calibre30">mongo</span></span> from, you need only the filename; otherwise, a full path is required. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; load(</span><span class="calibre9"><span class="italic"><span class="calibre38">'distinct_digits.js'</span></span></span><span class="calibre9">)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> With all that in, we can do a quick test (if you have some trouble, don’t feel shy about adding a smattering of <span class="calibre9"><span class="calibre30">print</span></span> functions). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​db.eval(</span><span class="calibre9"><span class="italic"><span class="calibre38">"distinctDigits(db.phones.findOne({ 'components.number' : 5551213 }))"</span></span></span><span class="calibre9">)​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[ 1, 2, 3, 5 ]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Now we can get to work on the mapper. As with any mapreduce function, deciding what fields to map by is a crucial decision, since it dictates the aggregated values that you return. Since our report is finding distinct numbers, the array of distinct values is one field. But since we also need to query by country, that is another field. We add both values as a compound key: <span class="calibre9"><span class="calibre30">{digits : X, country : Y}</span></span>. </p><a></a><p class="calibre12"> Our goal is to simply count these values, so we emit the value 1 (each document represents one item to count). The reducer’s job is to sum all those 1s together. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/mongo/map_1.js"><span class="calibre41"><span class="calibre13"><span class="underline">mongo/map_1.js</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​map = </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">() {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> digits = distinctDigits(this);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  emit({digits : digits, country : this.components.country}, {count : 1});​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/mongo/reduce_1.js"><span class="calibre41"><span class="calibre13"><span class="underline">mongo/reduce_1.js</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​reduce = </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(key, values) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> total = 0;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">for</span></span></span><span class="calibre9">(</span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> i=0; i&lt;values.length; i++) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    total += values[i].count;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">return</span></span></span><span class="calibre9"> { count : total };​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​results = db.runCommand({​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  mapReduce: </span><span class="calibre9"><span class="italic"><span class="calibre38">'phones'</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  map:       map,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  reduce:    reduce,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  out:       </span><span class="calibre9"><span class="italic"><span class="calibre38">'phones.report'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​})​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Since we set the collection name via the <span class="calibre9"><span class="calibre30">out</span></span> parameter (<span class="calibre9"><span class="calibre30">out : ’phones.report’</span></span>), you can query the results like any other. It’s a materialized view that you can see in the <span class="calibre9"><span class="calibre30">show tables</span></span> list. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; db.phones.report.find({'_id.country' : 8})​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "_id" : { "digits" : [ 0, 1, 2, 3, 4, 5, 6 ], "country" : 8 },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "value" : { "count" : 19 }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "_id" : { "digits" : [ 0, 1, 2, 3, 5 ], "country" : 8 },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "value" : { "count" : 3 }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "_id" : { "digits" : [ 0, 1, 2, 3, 5, 6 ], "country" : 8 },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "value" : { "count" : 48 }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "_id" : { "digits" : [ 0, 1, 2, 3, 5, 6, 7 ], "country" : 8 },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "value" : { "count" : 12 }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​has more​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Type <span class="calibre9"><span class="calibre30">it</span></span> to continue iterating through the results. Note the unique emitted keys are under the field <span class="calibre9"><span class="calibre30">_id</span></span>s, and all of the data returned from the reducers are under the field <span class="calibre9"><span class="calibre30">value</span></span>. </p><a></a><p class="calibre12"> If you prefer that the mapreducer just output the results, rather than outputting to a collection, you can set the <span class="calibre9"><span class="calibre30">out</span></span> value to <span class="calibre9"><span class="calibre30">{ inline : 1 }</span></span>, but bear in mind there is a limit to the size of a result you can output. As of Mongo 2.0, that limit is 16MB. </p><a></a><p class="calibre12"> Recall from the Riak chapter that reducers can have either mapped (emitted) results or other reducer results as inputs. Why would the output of one reducer feed into the input of another if they are mapped to the same key? Think of how this would look if run on separate servers, as shown in Figure 22, <a href="#filepos1080636"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">A Mongo map reduce call over two servers</span></span><span class="calibre13"><span class="underline">​</span></span></a>. </p><a id="filepos1080636"></a><blockquote class="calibre10"><img src="images/00027.jpg" class="calibre95"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 22. A Mongo map reduce call over two servers</span></blockquote><a></a><p class="calibre12"> Each server must run its own <span class="calibre9"><span class="calibre30">map</span></span> and <span class="calibre9"><span class="calibre30">reduce</span></span> functions and then push those results to be merged with the service that initiated the call, gathering them up. Classic divide and conquer. If we had renamed the output of the reducer to <span class="calibre9"><span class="calibre30">total</span></span> instead of <span class="calibre9"><span class="calibre30">count</span></span>, we would have needed to handle both cases in the loop, as shown here: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/mongo/reduce_2.js"><span class="calibre41"><span class="calibre13"><span class="underline">mongo/reduce_2.js</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​reduce = </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(key, values) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> total = 0;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">for</span></span></span><span class="calibre9">(</span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> i=0; i&lt;values.length; i++) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> data = values[i];​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9">(</span><span class="calibre9"><span class="italic"><span class="calibre38">'total'</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">in</span></span></span><span class="calibre9"> data) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      total += data.total;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    } </span><span class="calibre9"><span class="bold"><span class="calibre44">else</span></span></span><span class="calibre9"> {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      total += data.count;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">return</span></span></span><span class="calibre9"> { total : total };​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> However, Mongo predicted that you might need to perform some final changes, such as rename a field or some other calculations. If we really need the output field to be <span class="calibre9"><span class="calibre30">total</span></span>, we can implement a <span class="calibre9"><span class="calibre30">finalize</span></span> function, which works the same way as the <span class="calibre9"><span class="calibre30">finalize</span></span> function under <span class="calibre9"><span class="calibre30">group</span></span>. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Day 2 Wrap-Up</span></span></span></p><a></a><p class="calibre29"> On Day 2 we’ve expanded our query power by including several aggregate queries: <span class="calibre9"><span class="calibre30">count</span></span>, <span class="calibre9"><span class="calibre30">distinct</span></span>, and topped off by <span class="calibre9"><span class="calibre30">group</span></span>. To speed up the response time of these queries, we used MongoDB’s indexing options. When more power is required, the ever-present <span class="calibre9"><span class="calibre30">mapReduce</span></span> is available. </p><p class="calibre12"><span class="bold"><span class="calibre28">Day 2 Homework</span></span></p><p class="calibre37"><span class="bold">Find</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">A shortcut for admin commands.</p></li><li value="2" class="calibre36"><p class="calibre22">The online documentation for queries and cursors.</p></li><li value="3" class="calibre36"><p class="calibre22">The MongoDB documentation for mapreduce.</p></li><li value="4" class="calibre36"><p class="calibre22">Through the JavaScript interface, investigate the code for three collections functions: <span class="calibre9"><span class="calibre30">help</span></span>, <span class="calibre9"><span class="calibre30">findOne</span></span>, and <span class="calibre9"><span class="calibre30">stats</span></span>.</p></li></ol><p class="calibre12"><span class="bold">Do</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Implement a finalize method to output the count as the total.</p></li><li value="2" class="calibre36"><p class="calibre22">Install a Mongo driver for a language of your choice, and connect to the database. Populate a collection through it, and index one of the fields.</p></li></ol><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos1088290" class="calibre1"><p class="calibre24" id="filepos1088295"><span class="calibre25"><span class="bold"><span class="calibre26">5.4 Day 3: Replica Sets, Sharding, GeoSpatial, and GridFS</span></span></span></p><a></a><p class="calibre27"> Mongo has a powerful ability to store and query data in a variety of ways. But then again, so can other databases. What makes document databases unique is their ability to efficiently handle arbitrarily nested, schemaless data documents. What makes Mongo special in the realm of document stores is its ability to scale across several servers, by replicating (copying data to other servers) or sharding collections (splitting a collection into pieces) and performing queries in parallel. Both promote availability. </p><p class="calibre12"><img src="images/00022.jpg" class="calibre96"/></p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Replica Sets</span></span></span></p><a></a><p class="calibre29"> Mongo was built to scale out, not to run stand-alone. It was built for data consistency and partition tolerance, but sharding data has a cost: if one part of a collection is lost, the whole thing is compromised. What good is querying against a collection of countries that contains only the western hemisphere? Mongo deals with this implicit sharding weakness in a simple manner: duplication. You should rarely run a single Mongo instance in production but rather replicate the stored data across multiple services. </p><a></a><p class="calibre12"> Rather than muck with our existing database, today we’ll start from scratch and spawn a few new servers. Mongo’s default port is 27017, so we’ll start up each server on other ports. Recall you must create the data directories first, so create three of them: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ mkdir  ./mongo1 ./mongo2 ./mongo3​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Next we’ll fire up the Mongo servers. This time we’ll add the <span class="calibre9"><span class="calibre30">replSet</span></span> flag with the name <span class="calibre9"><span class="italic"><span class="calibre38">book</span></span></span> and specify the ports. While we’re at it, let’s turn on the REST flag so we can use the web interface. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ mongod --replSet book --dbpath ./mongo1 --port 27011 --rest​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Open another terminal window, and run the next command, which launches another server, pointing to a different directory, available on another port. Then open a third terminal to start the third server. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ mongod --replSet book --dbpath ./mongo2 --port 27012 --rest​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ mongod --replSet book --dbpath ./mongo3 --port 27013 --rest​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Notice that you get a lot of this noise on the output. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[startReplSets] replSet can't get local.system.replset config from self \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  or any seed (EMPTYCONFIG)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> That’s a good thing; we’ve yet to initialize our replica set, and Mongo is letting us know that. Fire up a <span class="calibre9"><span class="calibre30">mongo</span></span> shell to one of the servers, and execute the <span class="calibre9"><span class="calibre30">rs.initiate</span></span> function. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ mongo localhost:27011​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; rs.initiate({​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  _id: </span><span class="calibre9"><span class="italic"><span class="calibre38">'book'</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  members: [​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    {_id: 1, host: </span><span class="calibre9"><span class="italic"><span class="calibre38">'localhost:27011'</span></span></span><span class="calibre9">},​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    {_id: 2, host: </span><span class="calibre9"><span class="italic"><span class="calibre38">'localhost:27012'</span></span></span><span class="calibre9">},​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    {_id: 3, host: </span><span class="calibre9"><span class="italic"><span class="calibre38">'localhost:27013'</span></span></span><span class="calibre9">}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  ]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​})​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; rs.status()​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Notice we’re using a new object called <span class="calibre9"><span class="calibre30">rs</span></span> (replica set). Like other objects, it has a <span class="calibre9"><span class="calibre30">help</span></span> method you can call. Running the <span class="calibre9"><span class="calibre30">status</span></span> command will let us know when our replica set is running, so just keep checking the status for completion before continuing. If you watch the three server outputs, you should see that one server outputs this line: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[rs Manager] replSet PRIMARY​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> And two servers will have the following output: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[rs_sync] replSet SECONDARY​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"><span class="calibre9"><span class="calibre30">PRIMARY</span></span> will be the master server. Chances are, this will be the server on port 27011 (since it started first); however, if it’s not, go ahead and fire up a console to the primary. Just insert any old thing on the command line, and we’ll try an experiment. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; db.echo.insert({ say : </span><span class="calibre9"><span class="italic"><span class="calibre38">'HELLO!'</span></span></span><span class="calibre9"> })​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> After the insert, exit the console, and then let’s test that our change has been replicated by shutting down the master node; pressing <span class="calibre69"><span class="calibre30">Ctrl</span></span>+<span class="calibre69"><span class="calibre30">C</span></span> is sufficient. If you watch the logs of the remaining two servers, you should see that one of the two has now been promoted to master (it will output the <span class="calibre9"><span class="calibre30">replSet PRIMARY</span></span> line). Open a console into that machine (for us it was <span class="calibre9"><span class="italic"><span class="calibre38">localhost:27012</span></span></span>), and <span class="calibre9"><span class="calibre30">db.echo.find</span></span> should contain your value. </p><a></a><p class="calibre12"> We’ll play one more round of our console-shuffle game. Open a console into the remaining <span class="calibre9"><span class="calibre30">SECONDARY</span></span> server. Just to be sure, run the <span class="calibre9"><span class="calibre30">isMaster</span></span> function. Ours looked like this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ mongo localhost:27013​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​MongoDB shell version: 1.6.2​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​connecting to: localhost:27013/test​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; db.isMaster()​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "setName" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"book"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "ismaster" : false,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "secondary" : true,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "hosts" : [​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre38">"localhost:27013"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre38">"localhost:27012"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre38">"localhost:27011"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  ],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "primary" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"localhost:27012"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "ok" : 1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> In this shell, let’s attempt to insert another value. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; db.echo.insert({ say : </span><span class="calibre9"><span class="italic"><span class="calibre38">'is this thing on?'</span></span></span><span class="calibre9"> })​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​not master​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The message <span class="calibre9"><span class="italic"><span class="calibre38">not master</span></span></span> is letting us know that we cannot write to a secondary node. Nor can you directly read from it. There is only one master per replica set, and you must interact with it. It is the gatekeeper to the set. </p><a></a><p class="calibre12"> Replicating data has its own issues not found in single-source databases. In the Mongo setup, one problem is deciding who gets promoted when a master node goes down. Mongo deals with this by giving each <span class="calibre9"><span class="calibre30">mongod</span></span> service a vote, and the one with the freshest data is elected the new master. Right now you should still have two <span class="calibre9"><span class="calibre30">mongod</span></span> services running. Go ahead and shut down the current master. Remember, when we did this with three nodes, one of the others just got promoted to be the new master. But this time something different happened. The output of the last remaining server will be something like this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[ReplSetHealthPollTask] replSet info localhost:27012 is now down (or...​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[rs Manager] replSet can</span><span class="calibre9"><span class="italic"><span class="calibre38">'t see a majority, will not try to elect self</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This comes down to the Mongo philosophy of server setups and the reason we should always have an odd number of servers (three, five, and so on). </p><a></a><p class="calibre12"> Go ahead and relaunch the other servers and watch the logs. When the nodes are brought back up, they go into a recovery state and attempt to resync their data with the new master node. “What a minute!?” (we hear you cry). “So, what if the original master had data that did not yet propagate?” Those operations are dropped. A write in a Mongo replica set isn’t considered successful until most nodes have a copy of the data. </p><p class="calibre12"><span class="bold"><span class="calibre28">The Problem with Even Nodes</span></span></p><a></a><p class="calibre37"> The concept of replication is easy enough to grasp: you write to one MongoDB server, and that data is duplicated across others within the replica set. If one server is unavailable, then one of the others can be promoted and serve requests. But there are more ways a server can be unavailable than a server crash. Sometimes, the network connection between nodes is down. In that case, Mongo dictates that <span class="italic">a majority of nodes that can still communicate make up the network</span>. </p><a></a><p class="calibre12"> MongoDB expects an odd number of total nodes in the replica set. Consider a five-node network, for example. If connection issues split it into a three-node fragment and a two-node fragment, the larger fragment has a clear majority and can elect a master and continue servicing requests. With no clear majority, a quorum couldn’t be reached. </p><a></a><p class="calibre12"> To see why an odd number of nodes is preferred, consider what might happen to a four-node replica set. Say a network partition causes two of the servers to lose connectivity from the other two. One set will have the original master, but since it can’t see a <span class="italic">clear majority</span> of the network, the master steps down. The other set will similarly be unable to elect a master because it too can’t communicate with a clear majority of nodes. Both sets are now unable to process requests and the system is effectively down. Having an odd number of total nodes would have made this particular scenario—a fragmented network where each fragment has less than a clear majority—less likely to occur. </p><a></a><p class="calibre12"> Some databases (e.g., CouchDB) are built to allow multiple masters, but Mongo is not, and so it isn’t prepared to resolve data updates between them. MongoDB deals with conflicts between multiple masters by simply not allowing them. </p><a></a><p class="calibre12"> Unlike, say, Riak, Mongo always knows the most recent value; the client needn’t decide. Mongo’s concern is strong consistency on writes, and preventing a multimaster scenario is not a bad method for achieving it. </p><blockquote class="calibre40"><span class="calibre41"><span class="bold">Voting and Arbiters</span></span></blockquote><a></a><blockquote class="calibre42"><span class="calibre41"> You may not always want to have an odd number of servers replicating data. In that case, you can either launch an arbiter (generally recommended) or increase voting rights on your servers (generally not recommended). In Mongo, an arbiter is a voting but nonreplicating server in the replica set. You launch it just like any other server, but on configuration set a flag, like this: </span><span class="calibre9"><span class="calibre30">{_id: 3, host: ’localhost:27013’, arbiterOnly : true}.</span></span><span class="calibre41"> Arbiters are useful for breaking ties, like the U.S. vice president in the Senate. By default each </span><span class="calibre9"><span class="calibre30">mongod</span></span><span class="calibre41"> instance has a single vote. </span></blockquote><p class="calibre61"><span class="calibre5"><span class="bold"><span class="calibre28">Sharding</span></span></span></p><a></a><p class="calibre29"> One of the central reasons for Mongo to exist is to safely and quickly handle very large datasets. The clearest method of achieving this is through horizontal sharding by value ranges—or just <span class="italic">sharding</span> for brevity. Rather than a single server hosting all values in a collection, some range of values are split (or in other words, sharded) onto other servers. For example, in our phone numbers collection, we may put all phone numbers less than 1-500-000-0000 onto Mongo server A and put numbers greater than or equal to 1-500-000-0001 onto a server B. Mongo makes this easier by autosharding, managing this division for you. </p><a></a><p class="calibre12"> Let’s launch a couple of (nonreplicating) <span class="calibre9"><span class="calibre30">mongod</span></span> servers. Like replica sets, there’s a special parameter necessary to be considered a shard server (which just means this server is capable of sharding). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ mkdir ./mongo4 ./mongo5​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ mongod --shardsvr --dbpath ./mongo4 --port 27014​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ mongod --shardsvr --dbpath ./mongo5 --port 27015​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Now we need a server to actually keep track of our keys. Imagine we created a table to store city names alphabetically. We need some way to know that (for example) cities starting with A--N go to server mongo4 and O--Z go to server mongo5. In Mongo you create a <span class="italic">config server</span> (which is just a regular <span class="calibre9"><span class="calibre30">mongod</span></span>) that keeps track of which server (mongo4 or mongo5) owns what values. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ mkdir ./mongoconfig​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ mongod --configsvr --dbpath ./mongoconfig --port 27016​</span><span class="calibre9">​</span></p></td></tr></table><blockquote class="calibre40"><span class="calibre41"><span class="bold">mongos vs. mongoconfig</span></span></blockquote><a></a><blockquote class="calibre42"><span class="calibre41"> You may wonder why Mongo separates </span><span class="calibre9"><span class="calibre30">configuration</span></span><span class="calibre41"> and the </span><span class="calibre9"><span class="calibre30">mongos</span></span><span class="calibre41"> </span><span class="calibre41"><span class="italic">point of entry</span></span><span class="calibre41"> into two different servers. This is because in production environments they will generally live on different physical servers. The config server (itself replicated) manages the sharded information for other sharded servers, while </span><span class="calibre9"><span class="calibre30">mongos</span></span><span class="calibre41"> will likely live on your local application server where clients can easily connect (without needing to manage which shards to connect to). </span></blockquote><a></a><p class="calibre43"> Finally, we need to run a fourth server called <span class="calibre9"><span class="calibre30">mongos</span></span>, which is the single point of entry for our clients. The <span class="calibre9"><span class="calibre30">mongos</span></span> server will connect to the <span class="calibre9"><span class="calibre30">mongoconfig</span></span> config server to keep track of the sharding information stored there. We’ll set it on port 27020 with a <span class="calibre9"><span class="calibre30">chunkSize</span></span> of 1. (Our <span class="calibre9"><span class="calibre30">chunkSize</span></span> is 1MB, which is the smallest value allowed. This is just for our small dataset, so we can watch sharding take place. In production you’d use the default or a much bigger number.) We point <span class="calibre9"><span class="calibre30">mongos</span></span> to the config server:port with the <span class="calibre9"><span class="calibre30">--configdb</span></span> flag. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ mongos --configdb localhost:27016 --chunkSize 1 --port 27020​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> A neat thing about <span class="calibre9"><span class="calibre30">mongos</span></span> is that it is a lightweight clone of a full <span class="calibre9"><span class="calibre30">mongod</span></span> server. Nearly any command you can throw at a <span class="calibre9"><span class="calibre30">mongod</span></span>, you can throw at a <span class="calibre9"><span class="calibre30">mongos</span></span>, which makes it the perfect go-between for clients to connect to multiple sharded servers. A picture of our server setup may help (Figure 23, <a href="#filepos1115946"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Our little baby sharded cluster</span></span><span class="calibre13"><span class="underline">​</span></span></a>). </p><a id="filepos1115946"></a><blockquote class="calibre10"><img src="images/00039.jpg" class="calibre97"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 23. Our little baby sharded cluster</span></blockquote><a></a><p class="calibre12"> Now let’s jump into the <span class="calibre9"><span class="calibre30">mongos</span></span> server console on the admin database. We’re going to configure some sharding. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ mongo localhost:27020/admin​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; db.runCommand( { addshard : </span><span class="calibre9"><span class="italic"><span class="calibre38">"localhost:27014"</span></span></span><span class="calibre9"> } )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ "shardAdded" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"shard0000"</span></span></span><span class="calibre9">, "ok" : 1 }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; db.runCommand( { addshard : </span><span class="calibre9"><span class="italic"><span class="calibre38">"localhost:27015"</span></span></span><span class="calibre9"> } )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ "shardAdded" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"shard0001"</span></span></span><span class="calibre9">, "ok" : 1 }​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> With that set up, now we have to give it the database and collection to shard and the field to shard by (in our case, the city name). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; db.runCommand( { enablesharding : </span><span class="calibre9"><span class="italic"><span class="calibre38">"test"</span></span></span><span class="calibre9"> } )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ "ok" : 1 }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; db.runCommand( { shardcollection : </span><span class="calibre9"><span class="italic"><span class="calibre38">"test.cities"</span></span></span><span class="calibre9">, key : {name : 1} } )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ "collectionsharded" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"test.cities"</span></span></span><span class="calibre9">, "ok" : 1 }​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> With all that setup out of the way, let’s load some data. If you download the book code, you’ll find a 12MB data file named <span class="calibre9"><span class="calibre30">mongo_cities1000.json</span></span> that contains data for every city in the world with a population of more than 1,000 people. Download that file, and run the following import script that imports the data into our <span class="calibre9"><span class="calibre30">mongos</span></span> server: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ mongoimport -h localhost:27020 -db test --collection cities \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  --type json mongo_cities1000.json​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> From the <span class="calibre9"><span class="calibre30">mongos</span></span> console, type <span class="calibre9"><span class="calibre30">use test</span></span> to go back to the <span class="calibre9"><span class="calibre30">test</span></span> environment from the <span class="calibre9"><span class="calibre30">admin</span></span> environment. </p><p class="calibre12" id="filepos1121267"><span class="calibre5"><span class="bold"><span class="calibre28">GeoSpatial Queries</span></span></span></p><a></a><p class="calibre29"> Mongo has a neat trick built into it. Although we’ve focused on server setups today, no day would be complete without a little bit of razzle-dazzle, and that’s Mongo’s ability to quickly perform geospatial queries. First connect to the <span class="calibre9"><span class="calibre30">mongos</span></span> sharded server. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ mongo localhost:27020​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The core of the geospatial secret lies in indexing. It’s a special form of indexing geographic data called <span class="italic">geohash</span> that not only finds values of a specific value or range quickly but finds nearby values quickly in ad hoc queries. Conveniently, at the end of our previous section, we installed a lot of geographic data. So to query it, step 1 is to index the data on the location field. The <span class="calibre9"><span class="italic"><span class="calibre38">2d</span></span></span> index must be set on any two value fields, in our case a hash (for example, <span class="calibre9"><span class="calibre30">{ longitude:1.48453, latitude:42.57205 }</span></span>), but it could easily have been an array (for example, <span class="calibre9"><span class="calibre30">[1.48453, 42.57205]</span></span>). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; db.cities.ensureIndex({ location : </span><span class="calibre9"><span class="italic"><span class="calibre38">"2d"</span></span></span><span class="calibre9"> })​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If we were not dealing with a sharded collection, we could easily query for cities at or near a location. However, the following will work only with nonsharded collections in our current version of Mongo. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; db.cities.find({ location : { $near : [45.52, -122.67] } }).limit(5)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This should be patched in future versions for sharded collections. But in the meantime, to query a sharded <span class="calibre9"><span class="calibre30">cities</span></span> collection for other cities near a location, use the <span class="calibre9"><span class="calibre30">geoNear</span></span> command. Here is a sample of what it can return: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; db.runCommand({geoNear : </span><span class="calibre9"><span class="italic"><span class="calibre38">'cities'</span></span></span><span class="calibre9">, near : [45.52, -122.67],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  num : 5, maxDistance : 1})​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "ns" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"test.cities"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "near" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"1000110001000000011100101011100011001001110001111110"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "results" : [​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "dis" : 0.007105400003747849,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "obj" : {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "_id" : ObjectId(</span><span class="calibre9"><span class="italic"><span class="calibre38">"4d81c216a5d037634ca98df6"</span></span></span><span class="calibre9">),​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "name" : </span><span class="calibre9"><span class="italic"><span class="calibre38">"Portland"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        ...​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    ...​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  ],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "stats" : {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "time" : 0,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "btreelocs" : 53,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "nscanned" : 49,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "objectsLoaded" : 6,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "avgDistance" : 0.02166813996454613,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "maxDistance" : 0.07991909980773926​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "ok" : 1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"><span class="calibre9"><span class="calibre30">geoNear</span></span> also helps with troubleshooting geospatial commands. It returns a gold mine of useful information such as distance from the queried point, average and max distance of the returned set, and index information. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">GridFS</span></span></span></p><a></a><p class="calibre29"> One downside of a distributed system can be the lack of a single coherent filesystem. Say you operate a website where users can upload images of themselves. If you run several web servers on several different nodes, you must manually replicate the uploaded image to each web server’s disk or create some alternative central system. Mongo handles this scenario by its own distributed filesystem called GridFS. </p><a></a><p class="calibre12"> Mongo comes bundled with a command-line tool for interacting with the GridFS. The great thing is we don’t have to set up anything special to use it. If we list the files in the <span class="calibre9"><span class="calibre30">mongos</span></span> managed shards using the command <span class="calibre9"><span class="calibre30">mongofiles</span></span>, we get an empty list. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ mongofiles -h localhost:27020 list​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​connected to: localhost:27020​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> But upload any file. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ mongofiles -h localhost:27020 put my_file.txt​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​connected to: localhost:27020​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​added file: { _id: ObjectId('4d81cc96939936015f974859'), filename: "my_file.txt", \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  chunkSize: 262144, uploadDate: new Date(1300352150507), \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  md5: "844ab0d45e3bded0d48c2e77ed4f3b0e", length: 3067 }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​done!​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> And <span class="italic">voila</span>! If we list the contents of <span class="calibre9"><span class="calibre30">mongofiles</span></span>, we’ll find the uploaded name name. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ mongofiles -h localhost:27020 list​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​connected to: localhost:27020​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​my_file.txt     3067​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Back in our <span class="calibre9"><span class="calibre30">mongo</span></span> console, we can see the collections Mongo stores the data in. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​&gt; show collections​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​cities​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​fs.chunks​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​fs.files​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​system.indexes​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Since they’re just plain old collections, they can be replicated or queried like any other. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Day 3 Wrap-Up</span></span></span></p><a></a><p class="calibre29"> This wraps up our investigation of MongoDB. Today we focused on how Mongo enhances data durability with replica sets and supports horizontal scaling with sharding. We looked at good server configurations and how Mongo provides the <span class="calibre9"><span class="calibre30">mongos</span></span> server to act as a relay for handling autosharding between multiple nodes. Finally, we toyed with some of Mongo’s built-in tools, such as geospatial queries and GridFS. </p><p class="calibre12"><span class="bold"><span class="calibre28">Day 3 Homework</span></span></p><p class="calibre37"><span class="bold">Find</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Read the full replica set configuration options in the online docs.</p></li><li value="2" class="calibre36"><p class="calibre22">Find out how to create a spherical geo index.</p></li></ol><p class="calibre12"><span class="bold">Do</span>
</p><div id="filepos1139030" class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Mongo has support for bounding shapes (namely, squares and circles). Find all cities within a 50-mile box around the center of London.<a href="#filepos1142834"><span class="calibre13"><span class="underline">[39]</span></span></a>
</p></li><li value="2" class="calibre36"><p class="calibre22">Run six servers: three servers in a replica set, and each replica set is one of two shards. Run a config server and mongos. Run GridFS across them (this is the final exam).</p></li></ol><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos1139630" class="calibre1"><p class="calibre24" id="filepos1139635"><span class="calibre25"><span class="bold"><span class="calibre26">5.5 Wrap-Up</span></span></span></p><a></a><p class="calibre27"> We hope this taste of MongoDB has piqued your fancy and showed you how it earns the moniker of the “humongous” database. We covered a lot in a single chapter, but as usual, we only clawed at the surface. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Mongo’s Strengths</span></span></span></p><a></a><p class="calibre29"> Mongo’s primary strength lies in its ability to handle huge amounts of data (and huge amounts of requests) by replication and horizontal scaling. But it also has an added benefit of a very flexible data model, since you needn’t ever conform to a schema and can simply nest any values you would generally join using SQL in an RDBMS anyway. </p><a></a><p class="calibre12"> Finally, MongoDB was built to be easy to use. You may have noticed the similarity between Mongo commands and SQL database concepts (minus the server-side joins). This is not by accident and is one reason Mongo is gaining so much mind share from former object-relational model (ORM) users. It’s different enough to scratch a lot of developer itches but not so different it becomes a wholly different and scary monster. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Mongo’s Weaknesses</span></span></span></p><a></a><p class="calibre29"> How Mongo encourages denormalization of schemas (by not having any) might be a bit too much for some to swallow. Some developers find the cold, hard constraints of a relational database reassuring. It can be dangerous to insert any old value of any type into any collection. A single typo can cause hours of headache if you don’t think to look at field names and collection names as a possible culprit. Mongo’s flexibility is generally not important if your data model is already fairly mature and locked down. </p><a></a><p class="calibre12"> Because Mongo is focused on large datasets, it works best in large clusters, which can require some effort to design and manage. Unlike Riak, where adding new nodes is transparent and relatively painless for operations, setting up a Mongo cluster requires a little more forethought. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Parting Thoughts</span></span></span></p><a></a><p class="calibre29"> Mongo is an excellent choice if you are currently using a relational database to store your data through an ORM out of habit. We often recommend it to Rails, Django, and Model-View-Controller (MVC) developers, since they can then perform validations and field management through the models at the application layer and because schema migrations become a thing of the past (for the most part). Adding new fields to a document is as easy as adding a new field to your data model, and Mongo will happily accept the new terms. We find Mongo to be a much more natural answer to many common problem scopes for application-driven datasets than relational databases. </p><p class="calibre23"><span class="calibre9"><span class="bold"><span class="calibre28">Footnotes</span></span></span></p><a id="filepos1142834"></a><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos865320"><span class="calibre9"><span class="calibre13"><span class="underline">[37]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://www.mongodb.org/downloads"><span class="calibre9"><span class="calibre13"><span class="underline">http://www.mongodb.org/downloads</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos902266"><span class="calibre9"><span class="calibre13"><span class="underline">[38]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://www.pcre.org/"><span class="calibre9"><span class="calibre13"><span class="underline">http://www.pcre.org/</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1139030"><span class="calibre9"><span class="calibre13"><span class="underline">[39]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://www.mongodb.org/display/DOCS/Geospatial+Indexing"><span class="calibre9"><span class="calibre13"><span class="underline">http://www.mongodb.org/display/DOCS/Geospatial+Indexing</span></span></span></a><span class="calibre9">
</span></p></td></tr></table><p class="calibre17"><span class="calibre9"><span class="calibre18"><span class="calibre19">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos1144182" class="calibre1"><p class="calibre21" id="filepos1144187"><span class="calibre3"><span class="bold"><span class="calibre31"> Chapter 6</span></span></span></p><br class="calibre1"/><p class="calibre32"><span class="calibre3"><span class="bold"><span class="calibre4">CouchDB</span></span></span></p><a></a><p class="calibre12"> Ratchet wrenches are light and convenient tools you carry around for a range of big and small jobs. Like power drills, you can swap out variously sized bits like sockets or screws. Unlike a power drill that needs to be plugged into 120 volts of AC power, however, a wrench is happy to rest in your pocket and run on elbow grease. Apache CouchDB is like that. Able to scale down as well as up, CouchDB fits problem spaces of varying size and complexity with ease. </p><a></a><p class="calibre12"> CouchDB is the quintessential JSON- and REST-based document-oriented database. First released in 2005, CouchDB was designed with the Web in mind and all the innumerable flaws, faults, failures, and glitches that come with it. Consequently, CouchDB offers a robustness unmatched by most other databases. Whereas other systems tolerate occasional network drops, CouchDB thrives even when connectivity is only rarely available. </p><a></a><p class="calibre12"> Somewhat like MongoDB, CouchDB stores <span class="italic">documents</span>—JSON objects consisting of key-value pairs where values may be any of several types, including other objects nested to any depth. There is no ad hoc querying, though; indexed views produced by incremental mapreduce are the principal way you find documents. </p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos1145777" class="calibre1"><p class="calibre24" id="filepos1145782"><span class="calibre25"><span class="bold"><span class="calibre26">6.1 Relaxing on the Couch</span></span></span></p><a></a><p class="calibre27"> CouchDB lives up to its tag line: relax. Instead of focusing only on big-iron cluster installations, CouchDB aims to support a variety of deployment scenarios from the datacenter down to the smartphone. You can run CouchDB on your Android phone, on your MacBook, and in your datacenter. Written in Erlang, CouchDB is heartily built—the only way to shut it down is to kill the process! With its append-only storage model, your data is virtually incorruptible and easy to replicate, back up, and restore. </p><a></a><p class="calibre12"> CouchDB is document-oriented, using JSON as its storage and communication language. Like Riak, all calls to CouchDB happen over its REST interface. Replication can be one-way or bidirectional and ad hoc or continuous. CouchDB gives you a lot of flexibility to decide how to structure, protect, and distribute your data. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Comparing CouchDB and MongoDB</span></span></span></p><a></a><p class="calibre29"> One of the big questions we wanted to address in this book is “What’s the difference between CouchDB and MongoDB?” On the surface, CouchDB and MongoDB—which we covered in Chapter 5, <a href="#filepos860653"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">MongoDB</span></span><span class="calibre13"><span class="underline">​</span></span></a>—can seem quite similar. They’re both document-oriented datastores with an affinity for JavaScript that use JSON for data transport. There are many differences, though, ranging from project philosophy to implementation to scalability characteristics. We’ll cover many of these as we explore the beautiful simplicity of CouchDB. </p><a></a><p class="calibre12"> During our three-day tour we’ll explore many of CouchDB’s compelling features and design choices. We’ll start, as always, with individual CRUD commands and then move on to indexing through mapreduce views. As we’ve done with other databases, we’ll import some structured data and then use it to explore some advanced concepts. Finally, we’ll develop some simple event-driven client-side applications using Node.js and learn how CouchDB’s master-master replication strategy deals with conflicting updates. Let’s get to it! </p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos1148249" class="calibre1"><p class="calibre24" id="filepos1148254"><span class="calibre25"><span class="bold"><span class="calibre26">6.2 Day 1: CRUD, Futon, and cURL Redux</span></span></span></p><a></a><p class="calibre27"> Today we’re going to kick-start our CouchDB exploration by using CouchDB’s friendly Futon web interface to perform basic CRUD operations. After that, we’ll revisit cURL—which we used to communicate with Riak in Chapter 3, <a href="#filepos359261"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Riak</span></span><span class="calibre13"><span class="underline">​</span></span></a>—to make REST calls. All libraries and drivers for CouchDB end up sending REST requests under the hood, so it makes sense to start by understanding how they work. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Getting Comfortable with Futon</span></span></span></p><a id="filepos1149087"></a><blockquote class="calibre10"><img src="images/00052.jpg" class="calibre98"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 24. CouchDB Futon: Overview page</span></blockquote><a></a><p class="calibre12"> CouchDB comes with a useful web interface called Futon. Once you have CouchDB installed and running, open a web browser to <span class="calibre9"><span class="calibre30">http://localhost:5984/_utils/</span></span>. This will open the Overview page pictured in Figure 24, <a href="#filepos1149087"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">CouchDB Futon: Overview page</span></span><span class="calibre13"><span class="underline">​</span></span></a>. </p><a id="filepos1149821"></a><blockquote class="calibre10"><img src="images/00038.jpg" class="calibre99"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 25. CouchDB Futon: creating a document</span></blockquote><a></a><p class="calibre12"> Before we can start working with documents, we need to create a database to house them. We’re going to create a database to store musicians along with their album and track data. Click the Create Database... button. In the pop-up, enter <span class="calibre9"><span class="italic"><span class="calibre38">music</span></span></span> and click Create. This will redirect you automatically to the database’s page. From here, we can create new documents or open existing ones. </p><a></a><p class="calibre12"> On the music database’s page, click the New Document button. This will take you to a new page that looks like Figure 25, <a href="#filepos1149821"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">CouchDB Futon: creating a document</span></span><span class="calibre13"><span class="underline">​</span></span></a>. </p><blockquote class="calibre40"><span class="calibre41"><span class="bold">Welcome to Admin Party!</span></span></blockquote><a></a><blockquote class="calibre42"><span class="calibre41"> In Futon, you may notice the warning at the bottom of the right column explaining that everyone is an admin. Were this destined to become a production server, your next step would be to click the “Fix this” link and create an admin user to restrict who can do what. In our case, leaving it open is fine for now and will make our other tasks easier. </span></blockquote><a></a><p class="calibre43"> Just as in MongoDB, a document consists of a JSON object containing key-value pairs called <span class="italic">fields</span>. All documents in CouchDB have an <span class="calibre9"><span class="calibre30">_id</span></span> field, which must be unique and can never be changed. You can specify an <span class="calibre9"><span class="calibre30">_id</span></span> explicitly, but if you don’t, CouchDB will generate one for you. In our case, the default is fine, so click Save Document to finish. </p><a></a><p class="calibre12"> Immediately after saving the document, CouchDB will assign it an additional field called <span class="calibre9"><span class="calibre30">_rev</span></span>. The <span class="calibre9"><span class="calibre30">_rev</span></span> field will get a new value every time the document changes. The format for the revision string consists of an integer followed by a dash and then a pseudorandom unique string. The integer at the beginning denotes the numerical revision—in this case <span class="calibre9"><span class="calibre30">1</span></span>. </p><a></a><p class="calibre12"> Field names that begin with an underscore have special meaning to CouchDB, and <span class="calibre9"><span class="calibre30">_id</span></span> and <span class="calibre9"><span class="calibre30">_rev</span></span> are particularly important. To update or delete an existing document, you must provide <span class="italic">both</span> an <span class="calibre9"><span class="calibre30">_id</span></span> and the matching <span class="calibre9"><span class="calibre30">_rev</span></span>. If either of these do not match, CouchDB will reject the operation. This is how it prevents conflicts—by ensuring only the most recent document revisions are modified. </p><a></a><p class="calibre12"> There are no transactions or locking in CouchDB. To modify an existing record, you first read it out, taking note of the <span class="calibre9"><span class="calibre30">_id</span></span> and <span class="calibre9"><span class="calibre30">_rev</span></span>. Then, you request an update by providing the full document, including the <span class="calibre9"><span class="calibre30">_id</span></span> and <span class="calibre9"><span class="calibre30">_rev</span></span>. All operations are first come, first served. By requiring a matching <span class="calibre9"><span class="calibre30">_rev</span></span>, CouchDB ensures that the document you think you’re modifying hasn’t been altered behind your back while you weren’t looking. </p><a></a><p class="calibre12"> With the document page still open, click the Add Field button. In the Field column, enter <span class="calibre9"><span class="italic"><span class="calibre38">name</span></span></span>, and in the Value column, enter <span class="calibre9"><span class="italic"><span class="calibre38">The Beatles</span></span></span>. Click the green check mark next to the value to ensure it sticks, and then click the Save Document button. Notice how the <span class="calibre9"><span class="calibre30">_rev</span></span> field now begins with <span class="calibre9"><span class="calibre30">2</span></span>. </p><a></a><p class="calibre12"> CouchDB is not limited to storing string values. It can handle any JSON structure nested to any depth. Click the Add Field button again. This time, set Field to <span class="calibre9"><span class="italic"><span class="calibre38">albums</span></span></span>, and for Value enter the following (this is not an exhaustive list): </p><a id="filepos1154700"></a><blockquote class="calibre10"><img src="images/00036.jpg" class="calibre100"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 26. CouchDB Futon: document with an array value</span></blockquote><br class="calibre1"/><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="italic"><span class="calibre38">"Help!"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="italic"><span class="calibre38">"Sgt. Pepper's Lonely Hearts Club Band"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="italic"><span class="calibre38">"Abbey Road"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> After you click Save Document, it should look like Figure 26, <a href="#filepos1154700"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">CouchDB Futon: document with an array value</span></span><span class="calibre13"><span class="underline">​</span></span></a>. </p><a id="filepos1156821"></a><blockquote class="calibre10"><img src="images/00053.jpg" class="calibre101"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 27. CouchDB Futon: document with deep nested values</span></blockquote><a></a><p class="calibre12"> There’s more relevant information about an album than just its name, so let’s add some. Modify the <span class="calibre9"><span class="calibre30">albums</span></span> field and replace the value you just set with this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "title": </span><span class="calibre9"><span class="italic"><span class="calibre38">"Help!"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "year": 1965​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​},{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "title": </span><span class="calibre9"><span class="italic"><span class="calibre38">"Sgt. Pepper's Lonely Hearts Club Band"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "year": 1967​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​},{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "title": </span><span class="calibre9"><span class="italic"><span class="calibre38">"Abbey Road"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "year": 1969​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> After you save the document, this time you should be able to expand the <span class="calibre9"><span class="calibre30">albums</span></span> value to expose the nested documents underneath. It should resemble Figure 27, <a href="#filepos1156821"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">CouchDB Futon: document with deep nested values</span></span><span class="calibre13"><span class="underline">​</span></span></a>. </p><a></a><p class="calibre12"> Clicking the Delete Document button would do what you might expect; it would remove the document from the <span class="calibre9"><span class="calibre30">music</span></span> database. But don’t do it just yet. Instead, let’s drop down to the command line and take a look at how to communicate with CouchDB over REST. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Performing RESTful CRUD Operations with cURL</span></span></span></p><a></a><p class="calibre29"> All communication with CouchDB is REST-based, and this means issuing commands over HTTP. CouchDB isn’t the first database we’ve talked about with this quality. Riak—covered in Chapter 3, <a href="#filepos359261"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Riak</span></span><span class="calibre13"><span class="underline">​</span></span></a>—also relies on REST for all client communication. And like we did with Riak, we can communicate with CouchDB using the command-line tool cURL. </p><a></a><p class="calibre12"> Here we’ll perform some basic CRUD operations before moving on to the topic of views. To start, open a command prompt and run the following: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:5984/</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"couchdb":"Welcome","version":"1.1.1"}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Issuing <span class="calibre9"><span class="calibre30">GET</span></span> requests (cURL’s default) retrieves information about the thing indicated in the URL. Accessing the root as you just did merely informs you that CouchDB is up and running and what version is installed. Next let’s get some information about the <span class="calibre9"><span class="calibre30">music</span></span> database we created earlier (output formatted here for readability): </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:5984/music/</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "db_name":"music",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "doc_count":1,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "doc_del_count":0,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "update_seq":4,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "purge_seq":0,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "compact_running":false,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "disk_size":16473,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "instance_start_time":"1326845777510067",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "disk_format_version":5,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "committed_update_seq":4​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This returns some information about how many documents are in the database, how long the server has been up, and how many operations have been performed. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Reading a Document with GET</span></span></span></p><a></a><p class="calibre29"> To retrieve a specific document, append its <span class="calibre9"><span class="calibre30">_id</span></span> to the database URL like so: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:5984/music/74c7a8d2a8548c8b97da748f43000ac4</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "_id":"74c7a8d2a8548c8b97da748f43000ac4",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "_rev":"4-93a101178ba65f61ed39e60d70c9fd97",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "name":"The Beatles",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "albums": [​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "title":"Help!",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "year":1965​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    },{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "title":"Sgt. Pepper's Lonely Hearts Club Band",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "year":1967​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    },{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "title":"Abbey Road",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "year":1969​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  ]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> In CouchDB, issuing <span class="calibre9"><span class="calibre30">GET</span></span> requests is always safe. CouchDB won’t make any changes to documents as the result of a <span class="calibre9"><span class="calibre30">GET</span></span>. To make changes, you have to use other HTTP commands like <span class="calibre9"><span class="calibre30">PUT</span></span>, <span class="calibre9"><span class="calibre30">POST</span></span>, and <span class="calibre9"><span class="calibre30">DELETE</span></span>. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Creating a Document with POST</span></span></span></p><a></a><p class="calibre29"> To create a new document, use <span class="calibre9"><span class="calibre30">POST</span></span>. Make sure to specify a Content-Type header with the value <span class="calibre9"><span class="italic"><span class="calibre38">application/json</span></span></span>; otherwise, CouchDB will refuse the request. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -i -X POST "http://localhost:5984/music/" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44"> -H "Content-Type: application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44"> -d '{ "name": "Wings" }'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​HTTP/1.1 201 Created​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Server: CouchDB/1.1.1 (Erlang OTP/R14B03)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Location: http://localhost:5984/music/74c7a8d2a8548c8b97da748f43000f1b​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Date: Wed, 18 Jan 2012 00:37:51 GMT​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Type: text/plain;charset=utf-8​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Length: 95​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Cache-Control: must-revalidate​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "ok":true,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "id":"74c7a8d2a8548c8b97da748f43000f1b",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "rev":"1-2fe1dd1911153eb9df8460747dfe75a0"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The HTTP response code <span class="calibre9"><span class="calibre30">201 Created</span></span> tells us that our creation request was successful. The body of the response contains a JSON object with useful information such as the <span class="calibre9"><span class="calibre30">_id</span></span> and <span class="calibre9"><span class="calibre30">_rev</span></span> values. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Updating a Document with PUT</span></span></span></p><a></a><p class="calibre29"> The <span class="calibre9"><span class="calibre30">PUT</span></span> command is used to update an existing document or create a new one with a specific <span class="calibre9"><span class="calibre30">_id</span></span>. Just like <span class="calibre9"><span class="calibre30">GET</span></span>, the URL for a <span class="calibre9"><span class="calibre30">PUT</span></span> URL consists of the database URL followed by the document’s <span class="calibre9"><span class="calibre30">_id</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -i -X PUT \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  "http://localhost:5984/music/74c7a8d2a8548c8b97da748f43000f1b" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -H "Content-Type: application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -d '{</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "_id": "74c7a8d2a8548c8b97da748f43000f1b",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "_rev": "1-2fe1dd1911153eb9df8460747dfe75a0",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "name": "Wings",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "albums": ["Wild Life", "Band on the Run", "London Town"]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }'​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​HTTP/1.1 201 Created​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Server: CouchDB/1.1.1 (Erlang OTP/R14B03)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Location: http://localhost:5984/music/74c7a8d2a8548c8b97da748f43000f1b​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Etag: "2-17e4ce41cd33d6a38f04a8452d5a860b"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Date: Wed, 18 Jan 2012 00:43:39 GMT​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Type: text/plain;charset=utf-8​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Length: 95​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Cache-Control: must-revalidate​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "ok":true,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "id":"74c7a8d2a8548c8b97da748f43000f1b",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "rev":"2-17e4ce41cd33d6a38f04a8452d5a860b"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Unlike MongoDB, in which you modify documents <span class="italic">in place</span>, with CouchDB you always overwrite the entire document to make any change. The Futon web interface we saw earlier may have made it look like you could modify a single field in isolation, but behind the scenes it was rerecording the whole document when you hit Save. </p><a></a><p class="calibre12"> As we mentioned earlier, both the <span class="calibre9"><span class="calibre30">_id</span></span> and <span class="calibre9"><span class="calibre30">_rev</span></span> fields must exactly match the document being updated, or the operation will fail. To see how, try executing the same <span class="calibre9"><span class="calibre30">PUT</span></span> operation again. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​HTTP/1.1 409 Conflict​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Server: CouchDB/1.1.1 (Erlang OTP/R14B03)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Date: Wed, 18 Jan 2012 00:44:12 GMT​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Type: text/plain;charset=utf-8​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Length: 58​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Cache-Control: must-revalidate​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"error":</span><span class="calibre9"><span class="italic"><span class="calibre38">"conflict"</span></span></span><span class="calibre9">,"reason":</span><span class="calibre9"><span class="italic"><span class="calibre38">"Document update conflict."</span></span></span><span class="calibre9">}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You’ll get an HTTP <span class="calibre9"><span class="calibre30">409 Conflict</span></span> response with a JSON object describing the problem. This is how CouchDB enforces consistency. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Removing a Document with DELETE</span></span></span></p><a></a><p class="calibre29"> Finally, we can use the <span class="calibre9"><span class="calibre30">DELETE</span></span> operation to remove a document from the database. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -i -X DELETE \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  "http://localhost:5984/music/74c7a8d2a8548c8b97da748f43000f1b" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -H "If-Match: 2-17e4ce41cd33d6a38f04a8452d5a860b"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​HTTP/1.1 200 OK​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Server: CouchDB/1.1.1 (Erlang OTP/R14B03)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Etag: "3-42aafb7411c092614ce7c9f4ab79dc8b"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Date: Wed, 18 Jan 2012 00:45:36 GMT​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Type: text/plain;charset=utf-8​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Length: 95​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Cache-Control: must-revalidate​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "ok":true,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "id":"74c7a8d2a8548c8b97da748f43000f1b",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "rev":"3-42aafb7411c092614ce7c9f4ab79dc8b"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The <span class="calibre9"><span class="calibre30">DELETE</span></span> operation will supply a new revision number, even though the document is gone. It’s worth noting that the document wasn’t really removed from disk, but rather a new empty document was appended, flagging the document as deleted. Just like with an update, CouchDB does not modify documents in place. But for all intents and purposes, it’s deleted. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Day 1 Wrap-Up</span></span></span></p><a></a><p class="calibre29"> Now that we’ve learned how to do basic CRUD operations in Futon and cURL, we’re about ready to move onto more advanced topics. In Day 2 we’ll dig into creating indexed <span class="italic">views</span>, which will provide other avenues for retrieving documents than just specifying them by their <span class="calibre9"><span class="calibre30">_id</span></span> values. </p><p class="calibre12"><span class="bold"><span class="calibre28">Day 1 Homework</span></span></p><p class="calibre37"><span class="bold">Find</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Find the CouchDB HTTP Document API documentation online.</p></li><li value="2" class="calibre36"><p class="calibre22">We’ve already used <span class="calibre9"><span class="calibre30">GET</span></span>, <span class="calibre9"><span class="calibre30">POST</span></span>, <span class="calibre9"><span class="calibre30">PUT</span></span>, and <span class="calibre9"><span class="calibre30">DELETE</span></span>. What other HTTP commands are supported?</p></li></ol><p class="calibre12"><span class="bold">Do</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Use cURL to <span class="calibre9"><span class="calibre30">PUT</span></span> a new document into the music database with a specific <span class="calibre9"><span class="calibre30">_id</span></span> of your choice.</p></li><li value="2" class="calibre36"><p class="calibre22">Use <span class="calibre9"><span class="calibre30">curl</span></span> to create a new database with a name of your choice, and then delete that database also via cURL.</p></li><li value="3" class="calibre36"><p class="calibre22">Again using cURL, create a new document that contains a text document as an attachment. Lastly, craft and execute a cURL request that will return just that document’s attachment.</p></li></ol><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos1195654" class="calibre1"><p class="calibre24" id="filepos1195659"><span class="calibre25"><span class="bold"><span class="calibre26">6.3 Day 2: Creating and Querying Views</span></span></span></p><a></a><p class="calibre27"> In CouchDB, a <span class="italic">view</span> is a window into the documents contained in a database. Views are the principal way that documents are accessed in all but trivial cases—like those individual CRUD operations we saw in Day 1. Today, we’ll discover how to create the functions that make up a view. We’ll also learn how to perform ad hoc queries against views using cURL. Finally, we’ll import music data, which will make the views more salient and demonstrate how to use couchrest, a popular Ruby library for working with CouchDB. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Accessing Documents Through Views</span></span></span></p><a></a><p class="calibre29"> A view consists of mapper and reducer functions that are used to generate an ordered list of key-value pairs. Both keys and values can be any valid JSON. The simplest view is called <span class="calibre9"><span class="calibre30">_all_docs</span></span>. It is provided out of the box for all databases and contains an entry for each document in the database, keyed by its string <span class="calibre9"><span class="calibre30">_id</span></span>. </p><a></a><p class="calibre12"> To retrieve all the things in the database, issue a <span class="calibre9"><span class="calibre30">GET</span></span> request for the <span class="calibre9"><span class="calibre30">_all_docs</span></span> view. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:5984/music/_all_docs</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "total_rows":1,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "offset":0,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "rows":[{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "id":"74c7a8d2a8548c8b97da748f43000ac4",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "key":"74c7a8d2a8548c8b97da748f43000ac4",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "value":{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "rev":"4-93a101178ba65f61ed39e60d70c9fd97"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You can see in the previous output the one document we’ve created so far. The response is a JSON object that contains an array of <span class="calibre9"><span class="calibre30">rows</span></span>. Each row is an object with three fields: </p><div class="calibre33"> </div><ul class="calibre34"><li value="1" class="calibre35"><p class="calibre22"><span class="calibre9"><span class="calibre30">id</span></span> is the document’s <span class="calibre9"><span class="calibre30">_id</span></span>.</p></li><li value="2" class="calibre36"><p class="calibre22"><span class="calibre9"><span class="calibre30">key</span></span> is the JSON key produced by the mapreduce functions.</p></li><li value="3" class="calibre36"><p class="calibre22"><span class="calibre9"><span class="calibre30">value</span></span> is the associated JSON value, also produced through mapreduce.</p></li></ul><a></a><p class="calibre12"> In the case of <span class="calibre9"><span class="calibre30">_all_docs</span></span>, the <span class="calibre9"><span class="calibre30">id</span></span> and <span class="calibre9"><span class="calibre30">key</span></span> fields match, but for custom views this will almost never be the case. </p><a></a><p class="calibre12"> By default, views won’t include all of each document’s content in the <span class="calibre9"><span class="calibre30">value</span></span> returned. To retrieve all of the document’s fields, add the <span class="calibre9"><span class="calibre30">include_docs=true</span></span> URL parameter. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:5984/music/_all_docs?include_docs=true</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "total_rows":1,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "offset":0,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "rows":[{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "id":"74c7a8d2a8548c8b97da748f43000ac4",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "key":"74c7a8d2a8548c8b97da748f43000ac4",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "value":{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "rev":"4-93a101178ba65f61ed39e60d70c9fd97"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "doc":{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "_id":"74c7a8d2a8548c8b97da748f43000ac4",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "_rev":"4-93a101178ba65f61ed39e60d70c9fd97",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "name":"The Beatles",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "albums":[{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "title":"Help!",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "year":1965​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      },{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "title":"Sgt. Pepper's Lonely Hearts Club Band",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "year":1967​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      },{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "title":"Abbey Road",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "year":1969​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      }]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Here you can see that the other properties <span class="calibre9"><span class="calibre30">name</span></span> and <span class="calibre9"><span class="calibre30">albums</span></span> have been added to the <span class="calibre9"><span class="calibre30">value</span></span> object in the output. With this basic structure in mind, let’s make our own views. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Writing Your First View</span></span></span></p><a id="filepos1209741"></a><blockquote class="calibre10"><img src="images/00041.jpg" class="calibre102"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 28. CouchDB Futon: temporary view</span></blockquote><a></a><p class="calibre12"> Now that we’ve gotten a rough overview of how views work, let’s try creating our own views. To start, we’ll reproduce the behavior of the <span class="calibre9"><span class="calibre30">_all_docs</span></span> view, and after that, we’ll make increasingly complex views to extract deeper information from our documents for indexing. </p><p class="calibre12" id="filepos1210384"> To execute a temporary view, open a browser to Futon<a href="#filepos1428346"><span class="calibre13"><span class="underline">[40]</span></span></a> as we did in Day 1. Next open the <span class="calibre9"><span class="calibre30">music</span></span> database by clicking the link. In the upper-right corner of the music database’s page, choose “Temporary view...” from the View drop-down. It should bring you to a page that resembles Figure 28, <a href="#filepos1209741"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">CouchDB Futon: temporary view</span></span><span class="calibre13"><span class="underline">​</span></span></a>. </p><a></a><p class="calibre12"> The code in the left Map Function box should look like this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​function(doc) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  emit(null, doc);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If you click the Run button underneath the map function, CouchDB will execute this function once for each document in the database, passing in that document as the <span class="calibre9"><span class="calibre30">doc</span></span> parameter each time. This will generate a table with a single row of results resembling the following: </p><br class="calibre1"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Key  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Value  </span></blockquote></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">null</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">{_id: "74c7a8d2a8548c8b97da748f43000ac4", _rev: "4-93a101178ba65f61ed39e60d70c9fd97", name: "The Beatles", albums: [{title: "Help!", year: 1965}, {title: "Sgt. Pepper’s Lonely Hearts Club Band", year: 1967}, {title: "Abbey Road", year: 1969}]}</span></span>
</blockquote></td></tr></table><a></a><p class="calibre23"> The secret to this output, and all views, is the <span class="calibre9"><span class="calibre30">emit</span></span> function (this works just like the MongoDB function of the same name). <span class="calibre9"><span class="calibre30">emit</span></span> takes two arguments: the key and the value. A given map function may call emit one time, many times, or no times for a given document. In the previous case, the map function emits the key-value pair <span class="calibre9"><span class="calibre30">null</span></span>/<span class="calibre9"><span class="calibre30">doc</span></span>. As we see in the output table, the key is indeed <span class="calibre9"><span class="calibre30">null</span></span>, and the value is the same object we saw in Day 1 when we requested it directly from cURL. </p><a></a><p class="calibre12"> To make a mapper that achieves the same thing as <span class="calibre9"><span class="calibre30">_all_docs</span></span>, we need to emit something a little different. Recall that <span class="calibre9"><span class="calibre30">_all_docs</span></span> emits the document’s <span class="calibre9"><span class="calibre30">_id</span></span> field for the key and a simple object containing only the <span class="calibre9"><span class="calibre30">_rev</span></span> field for the value. With that in mind, change the Map Function code to the following, and then click Run. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​function(doc) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  emit(doc._id, { rev: doc._rev });​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The output table should now resemble the following table, echoing the same key-value pair we saw earlier when enumerating records via <span class="calibre9"><span class="calibre30">_all_docs</span></span>: </p><br class="calibre1"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Key  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Value  </span></blockquote></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">"74c7a8d2a8548c8b97da748f43000ac4"</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">{rev: "4-93a101178ba65f61ed39e60d70c9fd97"}</span></span>
</blockquote></td></tr></table><a></a><p class="calibre23"> Note that you don’t have to use Futon to execute temporary views. You may also send a <span class="calibre9"><span class="calibre30">POST</span></span> request to the <span class="calibre9"><span class="calibre30">_temp_view</span></span> handler. In this case, you pass in your map function as a JSON object in the request body. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -X POST \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  http://localhost:5984/music/_temp_view \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -H "Content-Type: application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -d '{"map":"function(doc){emit(doc._id,{rev:doc._rev});}"}'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "total_rows":1,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "offset":0,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "rows":[{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "id":"74c7a8d2a8548c8b97da748f43000ac4",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "key":"74c7a8d2a8548c8b97da748f43000ac4",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "value":{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "rev":"4-93a101178ba65f61ed39e60d70c9fd97"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The response is now identical to what we’d expect from <span class="calibre9"><span class="calibre30">_all_docs</span></span>. But what happens when we add the <span class="calibre9"><span class="calibre30">include_docs=true</span></span> parameter? Let’s find out! </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -X POST \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  http://localhost:5984/music/_temp_view?include_docs=true \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -H "Content-Type: application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -d '{"map":"function(doc){emit(doc._id,{rev:doc._rev});}"}'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "total_rows":1,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "offset":0,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "rows":[{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "id":"74c7a8d2a8548c8b97da748f43000ac4",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "key":"74c7a8d2a8548c8b97da748f43000ac4",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "value":{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "rev":"4-93a101178ba65f61ed39e60d70c9fd97"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "doc":{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "_id":"74c7a8d2a8548c8b97da748f43000ac4",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "_rev":"4-93a101178ba65f61ed39e60d70c9fd97",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "name":"The Beatles",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "albums":[...]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This time, instead of integrating additional fields into the <span class="calibre9"><span class="calibre30">value</span></span> object, a separate property called <span class="calibre9"><span class="calibre30">doc</span></span> is added to the row result containing the full document. </p><a></a><p class="calibre12"> A custom view may emit any value, even <span class="calibre9"><span class="calibre30">null</span></span>. Providing a separate <span class="calibre9"><span class="calibre30">doc</span></span> property prevents problems that might otherwise arise with combining the row value with the document. Next, let’s see how to save a view so that CouchDB can index the results. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Saving a View as a Design Document</span></span></span></p><a></a><p class="calibre29"> When CouchDB executes a temporary view, it must execute the provided map function for <span class="italic">each and every document</span> in the database. This is extremely resource-intensive, chewing up a lot of processing power, and it’s slow. You should use temporary views only for development purposes. For production, you should store your views in <span class="italic">design documents</span>. </p><a></a><p class="calibre12"> A design document is a real document in the database, just like the Beatles document we created earlier. As such, it can show up in views and be replicated to other CouchDB servers in the usual fashion. To save a temporary view as a design document in Futon, click the Save As... button, and then fill in the Design Document and View Name fields. </p><a></a><p class="calibre12"> Design documents always have IDs that start with <span class="calibre9"><span class="calibre30">_design/</span></span> and contain one or more views. The view name distinguishes this view from others housed in the same design document. Deciding which views belong in which design documents is largely application-specific and subject to taste. As a general rule, you should group views based on what they do relative to your data. We’ll see examples of this as we create more interesting views. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Finding Artists by Name</span></span></span></p><a></a><p class="calibre29"> Now that we’ve covered the basics of view creation, let’s develop an application-specific view. Recall that our <span class="calibre9"><span class="calibre30">music</span></span> database stores artist information, including a <span class="calibre9"><span class="calibre30">name</span></span> field that contains the band’s name. Using the normal <span class="calibre9"><span class="calibre30">GET</span></span> access pattern or the <span class="calibre9"><span class="calibre30">_all_docs</span></span> view, we can access documents by their <span class="calibre9"><span class="calibre30">_id</span></span> values, but we’re more interested in looking up bands by name. </p><a></a><p class="calibre12"> In other words, today we can look up the document with <span class="calibre9"><span class="calibre30">_id</span></span> equal to <span class="calibre9"><span class="calibre30">74c7a8d2a8548c8b97da748f43000ac4</span></span>, but how do we find the document with <span class="calibre9"><span class="calibre30">name</span></span> equal to <span class="calibre9"><span class="italic"><span class="calibre38">The Beatles</span></span></span>? For this, we need a view. In Futon, head back to the Temporary View page, enter the following Map Function code, and click Run. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/couchdb/artists_by_name_mapper.js"><span class="calibre41"><span class="calibre13"><span class="underline">couchdb/artists_by_name_mapper.js</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(doc) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> (</span><span class="calibre9"><span class="italic"><span class="calibre38">'name'</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">in</span></span></span><span class="calibre9"> doc) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    emit(doc.name, doc._id);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This function checks whether the current document has a <span class="calibre9"><span class="calibre30">name</span></span> field and, if so, emits the name and document <span class="calibre9"><span class="calibre30">_id</span></span> as the relevant key-value pair. This should produce a table like this: </p><br class="calibre1"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Key  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Value  </span></blockquote></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">"The Beatles"</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">"74c7a8d2a8548c8b97da748f43000ac4"</span></span>
</blockquote></td></tr></table><a></a><p class="calibre23"> Click the Save As... button; then for Design Document, enter <span class="calibre9"><span class="italic"><span class="calibre38">artists</span></span></span> and for View Name enter <span class="calibre9"><span class="italic"><span class="calibre38">by_name</span></span></span>. Click Save to persist the change. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Finding Albums by Name</span></span></span></p><a></a><p class="calibre29"> Finding artists by name is pretty useful, but we can do more. This time, let’s make a view that lets us find albums. This will be the first example where the map function will emit more than one result per document. </p><a></a><p class="calibre12"> Again return to the Temporary View page; then enter the following mapper: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/couchdb/albums_by_name_mapper.js"><span class="calibre41"><span class="calibre13"><span class="underline">couchdb/albums_by_name_mapper.js</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(doc) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> (</span><span class="calibre9"><span class="italic"><span class="calibre38">'name'</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">in</span></span></span><span class="calibre9"> doc &amp;&amp; </span><span class="calibre9"><span class="italic"><span class="calibre38">'albums'</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">in</span></span></span><span class="calibre9"> doc) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    doc.albums.forEach(</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(album){​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        key = album.title || album.name,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        value = { by: doc.name, album: album };​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      emit(key, value);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    });​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This function checks whether the current document has a <span class="calibre9"><span class="calibre30">name</span></span> field and an <span class="calibre9"><span class="calibre30">albums</span></span> field. If so, it emits a key-value pair for each album where the key is the album’s title or name and the value is a compound object containing the artist’s name and the original album object. It produces a table like this: </p><br class="calibre1"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Key  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Value  </span></blockquote></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">"Abbey Road"</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">{by: "The Beatles", album: {title: "Abbey Road", year: 1969}}</span></span>
</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">"Help!"</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">{by: "The Beatles", album: {title: "Help!", year: 1965}}</span></span>
</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">"Sgt. Pepper’s Lonely Hearts Club Band"</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">{by: "The Beatles", album: {title: "Sgt. Pepper’s Lonely Hearts Club Band", year: 1967}}</span></span>
</blockquote></td></tr></table><a></a><p class="calibre23"> Just like we did with the Artists By Name view, click the Save As... button. This time, for Design Document, enter <span class="calibre9"><span class="italic"><span class="calibre38">albums</span></span></span>, and for View Name enter <span class="calibre9"><span class="italic"><span class="calibre38">by_name</span></span></span>. Click Save to persist the change. Now let’s see how to query these documents. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Querying Our Custom Artist and Album Views</span></span></span></p><a></a><p class="calibre29"> Now that we have a couple of custom design documents saved, let’s jump back to the command line and query them with the <span class="calibre9"><span class="calibre30">curl</span></span> command. We’ll start with the Artists By Name view. On the command line, execute the following: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:5984/music/_design/artists/_view/by_name</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "total_rows":1,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "offset":0,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "rows":[{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "id":"74c7a8d2a8548c8b97da748f43000ac4",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "key":"The Beatles",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "value":"74c7a8d2a8548c8b97da748f43000ac4"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> To query a view, construct the path <span class="calibre9"><span class="calibre30">/&lt;database_name&gt;/</span></span>
<span class="calibre9"><span class="calibre30">_design/</span></span>
<span class="calibre9"><span class="calibre30">&lt;design_doc&gt;/</span></span>
<span class="calibre9"><span class="calibre30">_view/</span></span>
<span class="calibre9"><span class="calibre30">&lt;view_name&gt;</span></span>, replacing the parts as appropriate. In our case, we’re querying the <span class="calibre9"><span class="calibre30">by_name</span></span> view in the <span class="calibre9"><span class="calibre30">artists</span></span> design document of the <span class="calibre9"><span class="calibre30">music</span></span> database. No surprise here that the output includes our one document, keyed by the band name. </p><a></a><p class="calibre12"> Next, let’s try to find Albums By Name: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:5984/music/_design/albums/_view/by_name</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "total_rows":3,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "offset":0,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "rows":[{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "id":"74c7a8d2a8548c8b97da748f43000ac4",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "key":"Abbey Road",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "value":{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "by":"The Beatles",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "album":{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "title":"Abbey Road",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "year":1969​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  },{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "id":"74c7a8d2a8548c8b97da748f43000ac4",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "key":"Help!",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "value":{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "by":"The Beatles",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "album":{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "title":"Help!",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "year":1965​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  },{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "id":"74c7a8d2a8548c8b97da748f43000ac4",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "key":"Sgt. Pepper's Lonely Hearts Club Band",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "value":{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "by":"The Beatles",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "album":{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "title":"Sgt. Pepper's Lonely Hearts Club Band",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "year":1967​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> CouchDB will ensure that the records are presented in alphanumerical order by the emitted keys. In effect, this is the indexing that CouchDB offers. When designing your views, it’s important to pick emitted keys that will make sense when ordered. Requesting a view in this fashion returns the whole set, but what if we want just a subset? One way to do that is to use the <span class="calibre9"><span class="calibre30">key</span></span> URL parameter. When you specify a key, only rows with that exact key are returned. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl 'http://localhost:5984/music/_design/albums/_view/by_name?key="Help!"'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "total_rows":3,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "offset":1,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "rows":[{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "id":"74c7a8d2a8548c8b97da748f43000ac4",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "key":"Help!",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "value":{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "by":"The Beatles",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "album":{"title":"Help!","year":1965}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Notice the <span class="calibre9"><span class="calibre30">total_rows</span></span> and <span class="calibre9"><span class="calibre30">offset</span></span> fields in the response. The <span class="calibre9"><span class="calibre30">total_rows</span></span> field counts the total number of records in the view, not just the subset returned for this request. The <span class="calibre9"><span class="calibre30">offset</span></span> field tells us how far into that full set the first record presented appears. Based on these two numbers and the length of the <span class="calibre9"><span class="calibre30">rows</span></span>, we can calculate how many more records there are in the view on both sides. </p><a></a><p class="calibre12"> Requests for views can be sliced a few other ways beyond the <span class="calibre9"><span class="calibre30">keys</span></span> parameter, but to really see them in action, we’re going to need more data. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Importing Data Into CouchDB Using Ruby</span></span></span></p><a></a><p class="calibre29"> Importing data is a recurring problem that you’ll face no matter what database you end up using. CouchDB is no exception here. In this section, we’ll use Ruby to import structured data into our <span class="calibre9"><span class="calibre30">music</span></span> database. Through this you’ll see how to perform bulk imports into CouchDB, and it’ll also give us a nice pool of data to work with when we create more advanced views. </p><p class="calibre12" id="filepos1259824"> We’ll use music data from Jamendo.com,<a href="#filepos1428346"><span class="calibre13"><span class="underline">[41]</span></span></a> a site devoted to hosting freely licensed music. Jamendo provides all their artist, album, and track data in a structured XML format, making it ideal for importing into a document-oriented database like CouchDB. </p><p class="calibre12" id="filepos1260180"> Head over to Jamendo’s NewDatabaseDumps page<a href="#filepos1428346"><span class="calibre13"><span class="underline">[42]</span></span></a> and download <span class="calibre9"><span class="calibre30">dbdump_</span></span>
<span class="calibre9"><span class="calibre30">artistalbumtrack.xml.gz</span></span>.<a href="#filepos1428346"><span class="calibre13"><span class="underline">[43]</span></span></a> The zipped file is only about 15MB. To parse Jamendo’s XML file, we’ll use the <span class="calibre9"><span class="calibre30">libxml-ruby</span></span> gem. </p><p class="calibre12" id="filepos1260683"> Rather than writing our own Ruby-CouchDB driver or issuing HTTP requests directly, we’ll use a popular Ruby gem called <span class="calibre9"><span class="calibre30">couchrest</span></span> that wraps these calls into a convenient Ruby API. We’ll be using only a few methods from the API, but if you want to continue using this driver for your own projects, the documentation is quite good.<a href="#filepos1428346"><span class="calibre13"><span class="underline">[44]</span></span></a>
</p><a></a><p class="calibre12"> On the command line, install the necessary gems: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">gem install libxml-ruby couchrest</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Just like we did for Wikipedia data in Chapter 4, <a href="#filepos618173"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">HBase</span></span><span class="calibre13"><span class="underline">​</span></span></a>, we’ll use a SAX-style parser to process documents sequentially for insert as they’re streamed in through standard input. Here’s the code: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/couchdb/import_from_jamendo.rb"><span class="calibre41"><span class="calibre13"><span class="underline">couchdb/import_from_jamendo.rb</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">① </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​require </span><span class="calibre9"><span class="italic"><span class="calibre38">'rubygems'</span></span></span><span class="calibre9"> ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​require </span><span class="calibre9"><span class="italic"><span class="calibre38">'libxml'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​require </span><span class="calibre9"><span class="italic"><span class="calibre38">'couchrest'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​include LibXML​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">② </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">class</span></span></span><span class="calibre9"> JamendoCallbacks ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  include XML::SaxParser::Callbacks​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">③ </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">def</span></span></span><span class="calibre9"> initialize() ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    @db = CouchRest.database!(</span><span class="calibre9"><span class="italic"><span class="calibre38">"http://localhost:5984/music"</span></span></span><span class="calibre9">)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    @count = 0​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    @max = 100 </span><span class="calibre9"><span class="italic"><span class="calibre46"># maximum number to insert</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    @stack = []​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    @artist = nil​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    @album = nil​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    @track = nil​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    @tag = nil​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    @buffer = nil​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">④ </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">def</span></span></span><span class="calibre9"> on_start_element(element, attributes) ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">case</span></span></span><span class="calibre9"> element​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">when</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="italic"><span class="calibre38">'artist'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      @artist = { :albums =&gt; [] }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      @stack.push @artist​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">when</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="italic"><span class="calibre38">'album'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      @album = { :tracks =&gt; [] }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      @artist[:albums].push @album​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      @stack.push @album​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">when</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="italic"><span class="calibre38">'track'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      @track = { :tags =&gt; [] }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      @album[:tracks].push @track​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      @stack.push @track​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">when</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="italic"><span class="calibre38">'tag'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      @tag = {}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      @track[:tags].push @tag​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      @stack.push @tag​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">when</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="italic"><span class="calibre38">'Artists'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'Albums'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'Tracks'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'Tags'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="italic"><span class="calibre46"># ignore</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">else</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      @buffer = []​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">⑤ </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">def</span></span></span><span class="calibre9"> on_characters(chars) ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    @buffer &lt;&lt; chars </span><span class="calibre9"><span class="bold"><span class="calibre44">unless</span></span></span><span class="calibre9"> @buffer.nil?​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">⑥ </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">def</span></span></span><span class="calibre9"> on_end_element(element) ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">case</span></span></span><span class="calibre9"> element​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">when</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="italic"><span class="calibre38">'artist'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      @stack.pop​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      @artist[</span><span class="calibre9"><span class="italic"><span class="calibre38">'_id'</span></span></span><span class="calibre9">] = @artist[</span><span class="calibre9"><span class="italic"><span class="calibre38">'id'</span></span></span><span class="calibre9">] </span><span class="calibre9"><span class="italic"><span class="calibre46"># reuse Jamendo's artist id for doc _id</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      @artist[:random] = rand​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      @db.save_doc(@artist, false, true)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      @count += 1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> !@max.nil? &amp;&amp; @count &gt;= @max​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        on_end_document​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> @count % 500 == 0​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        puts </span><span class="calibre9"><span class="italic"><span class="calibre38">"  </span></span></span><span class="calibre9">#{@count}</span><span class="calibre9"><span class="italic"><span class="calibre38"> records inserted"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">when</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="italic"><span class="calibre38">'album'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'track'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'tag'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      top = @stack.pop​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      top[:random] = rand​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">when</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="italic"><span class="calibre38">'Artists'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'Albums'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'Tracks'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'Tags'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="italic"><span class="calibre46"># ignore</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">else</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> @stack[-1] &amp;&amp; @buffer​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        @stack[-1][element] = @buffer.join.force_encoding(</span><span class="calibre9"><span class="italic"><span class="calibre38">'utf-8'</span></span></span><span class="calibre9">)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        @buffer = nil​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">def</span></span></span><span class="calibre9"> on_end_document()​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    puts </span><span class="calibre9"><span class="italic"><span class="calibre38">"TOTAL: </span></span></span><span class="calibre9">#{@count}</span><span class="calibre9"><span class="italic"><span class="calibre38"> records inserted"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    exit(1)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">⑦ </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​parser = XML::SaxParser.io(ARGF) ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​parser.callbacks = JamendoCallbacks.new​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​parser.parse​</span><span class="calibre9">​</span></p></td></tr></table><p class="calibre12">①</p><a></a><blockquote class="calibre42"> To kick things off, we bring in the <span class="calibre9"><span class="calibre30">rubygems</span></span> module and the specific gems that we need. </blockquote><p class="calibre12">②</p><a></a><blockquote class="calibre42"> The standard way to use LibXML is by defining a callbacks class. Here we define a <span class="calibre9"><span class="calibre30">JamendoCallbacks</span></span> class to encapsulate our SAX handlers for various events. </blockquote><p class="calibre12">③</p><a></a><blockquote class="calibre42"> The first thing our class does during initialization is connect to our local CouchDB server using the CouchRest API and then create the <span class="calibre9"><span class="calibre30">music</span></span> database (if it doesn’t exist already). After that, it sets up some instance variables for storing state information during the parse. Note that if you set the <span class="calibre9"><span class="calibre30">@max</span></span> parameter to <span class="calibre9"><span class="calibre30">nil</span></span>, all documents will be imported, not just the first 100. </blockquote><p class="calibre12">④</p><a></a><blockquote class="calibre42"> Once parsing has started, the <span class="calibre9"><span class="calibre30">on_start_element</span></span> method will handle any opening tags. Here we watch for certain especially interesting tags like <span class="calibre9"><span class="calibre30">&lt;artist&gt;</span></span>, <span class="calibre9"><span class="calibre30">&lt;album&gt;</span></span>, <span class="calibre9"><span class="calibre30">&lt;track&gt;</span></span>, and <span class="calibre9"><span class="calibre30">&lt;tag&gt;</span></span>. We specifically ignore certain container elements—<span class="calibre9"><span class="calibre30">&lt;Artists&gt;</span></span>, <span class="calibre9"><span class="calibre30">&lt;Albums&gt;</span></span>, <span class="calibre9"><span class="calibre30">&lt;Tracks&gt;</span></span>, and <span class="calibre9"><span class="calibre30">&lt;Tags&gt;</span></span>—and treat all others as properties to be set on the nearest container items. </blockquote><p class="calibre12">⑤</p><a></a><blockquote class="calibre42"> Whenever the parser encounters character data, we buffer it to be added as a property to the current container element (the end of <span class="calibre9"><span class="calibre30">@stack</span></span>). </blockquote><p class="calibre12">⑥</p><a></a><blockquote class="calibre42"> Much of the interesting stuff happens in the <span class="calibre9"><span class="calibre30">on_end_element</span></span> method. Here, we close out the current container element by popping it off the stack. If the tag closes an <span class="calibre9"><span class="calibre30">&lt;artist&gt;</span></span> element, we take the opportunity to save off the document in CouchDB with the <span class="calibre9"><span class="calibre30">@db.save_doc</span></span> method. For any container element, we also add a <span class="calibre9"><span class="calibre30">random</span></span> property containing a freshly generated random number. We’ll use this later when selecting a random track, album, or artist. </blockquote><p class="calibre12">⑦</p><a></a><blockquote class="calibre42"> Ruby’s <span class="calibre9"><span class="calibre30">ARGF</span></span> stream combines standard input and any files specified on the command line. We feed this into LibXML and specify an instance of our <span class="calibre9"><span class="calibre30">JamendoCallbacks</span></span> class to handle the tokens—start tags, end tags, and character data—as they’re encountered. </blockquote><a></a><p class="calibre12"> To run the script, pipe the unzipped XML content into the import script: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">zcat dbdump_artistalbumtrack.xml.gz | ruby import_from_jamendo.rb</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​TOTAL: 100 records inserted​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> When the import has finished, drop back down to the command line, and we’ll see how our views look. First let’s pull up a few artists. The <span class="calibre9"><span class="calibre30">limit</span></span> URL parameter specifies that we want only that number of documents in the response (or less). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:5984/music/_design/artists/_view/by_name?limit=5</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"total_rows":100,"offset":0,"rows":[​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"id":"370255","key":"\"\"ATTIC\"\"","value":"370255"},​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"id":"353262","key":"10centSunday","value":"353262"},​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"id":"367150","key":"abdielyromero","value":"367150"},​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"id":"276","key":"AdHoc","value":"276"},​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"id":"364713","key":"Adversus","value":"364713"}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​]}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The previous request started at the very beginning of the list of artists. To jump to the middle, we can use the <span class="calibre9"><span class="calibre30">startkey</span></span> parameter: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:5984/music/_design/artists/_view/by_name?\</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">limit=5\&amp;startkey=%22C%22</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"total_rows":100,"offset":16,"rows":[​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"id":"340296","key":"CalexB","value":"340296"},​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"id":"353888","key":"carsten may","value":"353888"},​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"id":"272","key":"Chroma","value":"272"},​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"id":"351138","key":"Compartir D\u00f3na Gustet","value":"351138"},​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"id":"364714","key":"Daringer","value":"364714"}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​]}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Previously, we started with artists whose names began with <span class="italic">C</span>. Specifying an <span class="calibre9"><span class="calibre30">endkey</span></span> provides another way to limit the returned content. Here we specify that we want artists only between <span class="italic">C</span> and <span class="italic">D</span>: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:5984/music/_design/artists/_view/by_name?\</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">startkey=%22C%22\&amp;endkey=%22D%22</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"total_rows":100,"offset":16,"rows":[​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"id":"340296","key":"CalexB","value":"340296"},​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"id":"353888","key":"carsten may","value":"353888"},​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"id":"272","key":"Chroma","value":"272"},​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"id":"351138","key":"Compartir D\u00f3na Gustet","value":"351138"}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​]}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> To get the rows in reverse order, use the <span class="calibre9"><span class="calibre30">descending</span></span> URL parameter. Be sure to reverse your <span class="calibre9"><span class="calibre30">startkey</span></span> and <span class="calibre9"><span class="calibre30">endkey</span></span> as well. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:5984/music/_design/artists/_view/by_name?\</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">startkey=%22D%22\&amp;endkey=%22C%22\&amp;descending=true</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"total_rows":100,"offset":16,"rows":[​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"id":"351138","key":"Compartir D\u00f3na Gustet","value":"351138"},​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"id":"272","key":"Chroma","value":"272"},​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"id":"353888","key":"carsten may","value":"353888"},​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"id":"340296","key":"CalexB","value":"340296"}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​]}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> A number of other URL parameters are available for modifying view requests, but these are the most common and are the ones you’ll reach for most often. Some of the URL parameters have to do with grouping, which comes from the reducer part of CouchDB mapreduce views. We’ll explore these tomorrow. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Day 2 Wrap-Up</span></span></span></p><a></a><p class="calibre29"> Today we covered some good ground. We learned how to create basic views in CouchDB and save them into design documents. We explored different ways of querying views to get subsets of the indexed content. Using Ruby and a popular gem called <span class="calibre9"><span class="calibre30">couchrest</span></span>, we imported structured data and used it to support our views. Leading into tomorrow, we’ll expand on these ideas by creating more advanced views by adding reducers and then move on to other APIs that CouchDB supports. </p><p class="calibre12"><span class="bold"><span class="calibre28">Day 2 Homework</span></span></p><p class="calibre37"><span class="bold">Find</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">We’ve seen that the <span class="calibre9"><span class="calibre30">emit</span></span> method can output keys that are strings. What other types of values does it support? What happens when you emit an array of values as a key?</p></li><li value="2" class="calibre36"><p class="calibre22">Find a list of available URL parameters (like <span class="calibre9"><span class="calibre30">limit</span></span> and <span class="calibre9"><span class="calibre30">startkey</span></span>) that can be appended to view requests and what they do.</p></li></ol><p class="calibre12"><span class="bold">Do</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">The import script <span class="calibre9"><span class="calibre30">import_from_jamendo.rb</span></span> assigned a random number to each artist by adding a property called <span class="calibre9"><span class="calibre30">random</span></span>. Create a mapper function that will emit key-value pairs where the key is the random number and the value is the band’s name. Save this in a new design document named <span class="calibre9"><span class="calibre30">_design/random</span></span> with the view name <span class="calibre9"><span class="calibre30">artist</span></span>.</p></li><li value="2" class="calibre36"><p class="calibre22">Craft a cURL request that will retrieve a random artist.</p><p class="calibre12"><span class="italic">Hint: You’ll need to use the </span><span class="calibre9"><span class="italic"><span class="calibre30">startkey</span></span></span><span class="italic"> parameter, and you can produce a random number on the command line via </span><span class="calibre9"><span class="italic"><span class="calibre30">‘ruby -e ’puts rand’‘</span></span></span><span class="italic">.</span>
</p></li><li value="3" class="calibre36"><p class="calibre22">The import script also added a <span class="calibre9"><span class="calibre30">random</span></span> property for each album, track, and tag. Create three additional views in the <span class="calibre9"><span class="calibre30">_design/random</span></span> design document with the view names <span class="calibre9"><span class="calibre30">album</span></span>, <span class="calibre9"><span class="calibre30">track</span></span>, and <span class="calibre9"><span class="calibre30">tag</span></span> to match the earlier <span class="calibre9"><span class="calibre30">artist</span></span> view.</p></li></ol><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos1308826" class="calibre1"><p class="calibre24" id="filepos1308831"><span class="calibre25"><span class="bold"><span class="calibre26">6.4 Day 3: Advanced Views, Changes API, and Replicating Data</span></span></span></p><a></a><p class="calibre27"> In Days 1 and 2 we learned how to perform basic CRUD operations and interact with views for finding data. Building on this experience, today we’ll take a closer look at views, dissecting the reduce part of the mapreduce equation. After that, we’ll develop some Node.js applications in JavaScript to leverage CouchDB’s unique Changes API. Lastly, we’ll discuss replication and how CouchDB handles conflicting data. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Creating Advanced Views with Reducers</span></span></span></p><a></a><p class="calibre29"> Mapreduce-based views provide the means by which we can harness CouchDB’s indexing and aggregation facilities. In Day 2, all our views consisted of only mappers. Now we’re going to add reducers to the mix, developing new capabilities against the Jamendo data we imported in Day 2. </p><a></a><p class="calibre12"> One great thing about the Jamendo data is its depth. Artists have albums, which have tracks. Tracks, in turn, have attributes including tags. We’ll now turn our attention to tags to see whether we can write a deep inspecting view to collect and count them. </p><a></a><p class="calibre12"> First, return to the Temporary View page, and then enter the following map function: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/couchdb/tags_by_name_mapper.js"><span class="calibre41"><span class="calibre13"><span class="underline">couchdb/tags_by_name_mapper.js</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(doc) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  (doc.albums || []).forEach(</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(album){​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    (album.tracks || []).forEach(</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(track){​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      (track.tags || []).forEach(</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(tag){​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        emit(tag.idstr, 1);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      });​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    });​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  });​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This function digs into the artist document and then down into each album, each track, and finally each tag. For each tag, it emits a key-value pair consisting of the tag’s <span class="calibre9"><span class="calibre30">idstr</span></span> property (a string representation of the tag, like <span class="calibre9"><span class="italic"><span class="calibre38">"rock"</span></span></span>) and the number 1. </p><a></a><p class="calibre12"> With the map function in place, enter the following under Reduce Function: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/couchdb/simple_count_reducer.js"><span class="calibre41"><span class="calibre13"><span class="underline">couchdb/simple_count_reducer.js</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(key, values, rereduce) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">return</span></span></span><span class="calibre9"> sum(values);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This code merely sums the numbers in the <span class="calibre9"><span class="calibre30">values</span></span> list—which we’ll talk about momentarily once we’ve run the view. Finally, click the Run button. The output should resemble the following table: </p><br class="calibre1"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Key  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Value  </span></blockquote></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">"17sonsrecords"</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">1</span></span>
</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">"17sonsrecords"</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">1</span></span>
</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">"17sonsrecords"</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">1</span></span>
</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">"17sonsrecords"</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">1</span></span>
</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">"17sonsrecords"</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">1</span></span>
</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">"acid"</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">1</span></span>
</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">"acousticguitar"</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">1</span></span>
</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">"acousticguitar"</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">1</span></span>
</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">"action"</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">1</span></span>
</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">"action"</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">1</span></span>
</blockquote></td></tr></table><a></a><p class="calibre23"> This shouldn’t be too surprising. The value is always <span class="calibre9"><span class="calibre30">1</span></span> as we indicated in the mapper, and the Key fields exhibit as much repetition as there is in the tracks themselves. Notice, however, the Reduce checkbox in the top-right corner of the output table. Check that box, and then look at the table again. It should now look something like this: </p><br class="calibre1"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Key  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Value  </span></blockquote></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">"17sonsrecords"</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">5</span></span>
</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">"acid"</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">1</span></span>
</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">"acousticguitar"</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">2</span></span>
</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">"action"</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">2</span></span>
</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">"adventure"</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">3</span></span>
</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">"aksband"</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">1</span></span>
</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">"alternativ"</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">1</span></span>
</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">"alternativ"</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">3</span></span>
</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">"ambient"</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">28</span></span>
</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">"autodidacta"</span></span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">   <span class="calibre9"><span class="calibre30">17</span></span>
</blockquote></td></tr></table><a></a><p class="calibre23"> What happened? In short, the reducer <span class="italic">reduced</span> the output by combining like mapper rows in accordance with our Reducer Function. The CouchDB mapreduce engine works conceptually like the other mapreducers we’ve seen before (Riak’s <a href="#filepos447830"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Introducing Mapreduce</span></span><span class="calibre13"><span class="underline">​</span></span></a>, and MongoDB’s <a href="#filepos1058957"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Mapreduce (and Finalize)</span></span><span class="calibre13"><span class="underline">​</span></span></a>). Specifically, here’s a high-level outline of the steps CouchDB takes to build a view: </p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Send documents off to the mapper function.</p></li><li value="2" class="calibre36"><p class="calibre22">Collect all the emitted values.</p></li><li value="3" class="calibre36"><p class="calibre22">Sort emitted rows by their keys.</p></li><li value="4" class="calibre36"><p class="calibre22">Send chunks of rows with the same keys to the reduce function.</p></li><li value="5" class="calibre36"><p class="calibre22">If there was too much data to handle all reductions in a single call, call the reduce function again but with previously reduced values.</p></li><li value="6" class="calibre36"><p class="calibre22">Repeat recursive calls to the reduce function as necessary until no duplicate keys remain.</p></li></ol><a></a><p class="calibre12"> Reduce functions in CouchDB take three arguments: <span class="calibre9"><span class="calibre30">key</span></span>, <span class="calibre9"><span class="calibre30">values</span></span>, and <span class="calibre9"><span class="calibre30">rereduce</span></span>. The first argument, <span class="calibre9"><span class="calibre30">key</span></span>, is an array of tuples—two element arrays containing the key emitted by the mapper and the <span class="calibre9"><span class="calibre30">_id</span></span> of the document that produced it. The second argument, <span class="calibre9"><span class="calibre30">values</span></span>, is an array of values corresponding to the keys. </p><a></a><p class="calibre12"> The third argument, <span class="calibre9"><span class="calibre30">rereduce</span></span>, is a boolean value that will be true if this invocation is a <span class="italic">rereduction</span>. That is, rather than being sent keys and values that were emitted from mapper calls, this call is sent the products of previous reducer calls. In this case, the <span class="calibre9"><span class="calibre30">key</span></span> parameter will be <span class="calibre9"><span class="calibre30">null</span></span>. </p><p class="calibre12"><span class="bold"><span class="calibre28">Stepping Through Reducer Calls</span></span></p><a></a><p class="calibre37"> Let’s work through an example based on the output we just saw. </p><a></a><p class="calibre12"> Consider documents (artists) with tracks that have been tagged as “ambient.” The mappers run on the documents and emit key-value pairs of the form “ambient”/1.</p><a></a><p class="calibre12"> At some point, enough of these have been emitted that CouchDB invokes a reducer. That call might look like this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​reduce(​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  [[</span><span class="calibre9"><span class="italic"><span class="calibre38">"ambient"</span></span></span><span class="calibre9">, id1], [</span><span class="calibre9"><span class="italic"><span class="calibre38">"ambient"</span></span></span><span class="calibre9">, id2], ...],    </span><span class="calibre9"><span class="italic"><span class="calibre46">// keys are the same</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  [1, 1, ...],                                  </span><span class="calibre9"><span class="italic"><span class="calibre46">// values are all 1</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  false                                         </span><span class="calibre9"><span class="italic"><span class="calibre46">// rereduce is false</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Recall that in our reducer function we take the <span class="calibre9"><span class="calibre30">sum</span></span> of <span class="calibre9"><span class="calibre30">values</span></span>. Since they’re all 1, the sum will simply be the length—effectively a count of how many tracks have the “ambient” tag. CouchDB keeps this return value for later processing. For the sake of this example, let’s call that number <span class="calibre9"><span class="calibre30">10</span></span>. </p><a></a><p class="calibre12"> Some time later, after CouchDB has run these kinds of calls several times, it decides to combine the intermediate reducer results by executing a rereduce: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​reduce(​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  null,                </span><span class="calibre9"><span class="italic"><span class="calibre46">// key array is null</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  [10, 10, 8],         </span><span class="calibre9"><span class="italic"><span class="calibre46">// values are outputs from previous reducer calls</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  true                 </span><span class="calibre9"><span class="italic"><span class="calibre46">// rereduce is true</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Our reducer function again takes the <span class="calibre9"><span class="calibre30">sum</span></span> of <span class="calibre9"><span class="calibre30">values</span></span>. This time, the values add up to <span class="calibre9"><span class="calibre30">28</span></span>. Rereduce calls may be recursive. They go on as long as there is reduction to be done, until all the intermediate values have been combined into one. </p><a></a><p class="calibre12"> Most mapreduce systems, including the ones used by other databases we’ve covered in this book like Riak and MongoDB, throw away the output of mappers and reducers after the work is done. In those systems, mapreduce is seen as a means to an end—something to be executed whenever the need arises, each time starting from scratch. Not so with CouchDB. </p><a></a><p class="calibre12"> Once a view is codified into a design document, CouchDB will keep the intermediate mapper and reducer values until a change to a document would invalidate the data. At that time, CouchDB will incrementally run mappers and reducers to correct for the updated data. It won’t start from scratch, recalculating everything each time. This is the genius of CouchDB views. CouchDB is able to use mapreduce as its primary indexing mechanism by not tossing away intermediate data values. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Watching CouchDB for Changes</span></span></span></p><a></a><p class="calibre29"> CouchDB’s incremental approach to mapreduce is an innovative feature, to be sure; it’s one of many that set CouchDB apart from other databases. The next feature we’ll investigate is the Changes API. This interface provides mechanisms for watching a database for changes and getting updates instantly. </p><a></a><p class="calibre12"> The Changes API makes CouchDB a perfect candidate for a system of record. Imagine a multidatabase system where data is streaming in from several directions and other systems need to be kept up-to-date (we’ll actually do this in the next chapter, Section 8.4, <a href="#filepos1853806"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Day 3: Playing with Other Databases</span></span><span class="calibre13"><span class="underline">​</span></span></a>). Examples might include a search engine backed by Lucene or ElasticSeach or a caching layer implemented on memcached or Redis. You could have different maintenance scripts kick off in response to changes too—performing tasks such as database compaction and remote backups. In short, this simple API opens up a world of possibilities. Today we’ll learn how to harness it. </p><p class="calibre12" id="filepos1333328"> To make use of the API, we’re going to develop some simple client applications using Node.js.<a href="#filepos1428346"><span class="calibre13"><span class="underline">[45]</span></span></a> Node.js is a server-side JavaScript platform built on the V8 JavaScript engine—the same one used in Google’s Chrome browser. Because Node.js is event-driven and code for it is written in JavaScript, it’s a natural fit for integrating with CouchDB. If you don’t already have Node.js, head over to the Node.js site and install the latest stable version (we use version 0.6). </p><a></a><p class="calibre12"> The three flavors of the Changes API are polling, long-polling, and continuous. We’ll talk about each of these in turn. As always, we’ll start with cURL to get close to the bare metal and then follow up with a programmatic approach. </p><p class="calibre12"><span class="bold"><span class="calibre28">cURLing for Changes</span></span></p><a></a><p class="calibre37"> The first and simplest way to access the Changes API is through the polling interface. Head to the command line, and try the following (the output was truncated for brevity; yours may differ): </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:5984/music/_changes</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "results":[{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "seq":1,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "id":"370255",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "changes":[{"rev":"1-a7b7cc38d4130f0a5f3eae5d2c963d85"}]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  },{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "seq":2,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "id":"370254",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "changes":[{"rev":"1-2c7e0deec3ffca959ba0169b0e8bfcef"}]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  },{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    ... 97 more records ...​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  },{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "seq":100,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "id":"357995",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "changes":[{"rev":"1-aa649aa53f2858cb609684320c235aee"}]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "last_seq":100​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> When you send a <span class="calibre9"><span class="calibre30">GET</span></span> request for <span class="calibre9"><span class="calibre30">_changes</span></span> with no other parameters, CouchDB will respond with everything it has. Just like accessing views, you can specify a <span class="calibre9"><span class="calibre30">limit</span></span> parameter to request just a subset of the data, and adding <span class="calibre9"><span class="calibre30">include_docs=true</span></span> will cause full documents to be returned. </p><a></a><p class="calibre12"> Typically you won’t want all the changes from the beginning of time. You’re more likely to want the changes that have occurred since you last checked. For this, use the <span class="calibre9"><span class="calibre30">since</span></span> parameter. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:5984/music/_changes?since=99</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "results":[{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "seq":100,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "id":"357995",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "changes":[{"rev":"1-aa649aa53f2858cb609684320c235aee"}]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "last_seq":100​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If you specify a <span class="calibre9"><span class="calibre30">since</span></span> value that’s higher than the last sequence number, you’ll get an empty response: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:5984/music/_changes?since=9000</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "results":[​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  ],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "last_seq":9000​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Using this method, the client application would check back periodically to find out whether any new changes have occurred, taking application-specific actions accordingly. </p><a></a><p class="calibre12"> Polling is a fine solution if your need for up-to-date changes can suffer delays between updates. If updates are relatively rare, this would be the case. For example, if you were pulling blog entries, polling every five minutes might be just fine. </p><a></a><p class="calibre12"> If you want updates quicker, without incurring the overhead of reopening connections, then longpolling is a better option. When you specify the URL parameter <span class="calibre9"><span class="calibre30">feed=longpoll</span></span>, CouchDB will leave the connection open for some time, waiting for changes to happen before finishing the response. Try this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl 'http://localhost:5984/music/_changes?feed=longpoll&amp;since=9000'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"results":[​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You should see the beginning of a JSON response but nothing else. If you leave the terminal open long enough, CouchDB will eventually close the connection by finishing it: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​"last_seq":9000}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> From a development perspective, writing a driver that watches CouchDB for changes using polling is equivalent to writing one for longpolling. The difference is essentially just how long CouchDB is willing to leave the connection open. Now let’s turn our attention to writing a Node.js application that watches and uses the change feed. </p><p class="calibre12" id="filepos1347455"><span class="bold"><span class="calibre28">Polling for Changes with Node.js</span></span></p><a></a><p class="calibre37"> Node.js is a strongly event-driven system, so our CouchDB watcher will adhere to this principle as well. Our driver will watch the changes feed and emit change events whenever CouchDB reports changed documents. To get started, we’ll look at a skeletal outline of our driver, talk about the major pieces, and then fill in the feed-specific details. </p><a></a><p class="calibre12"> Without further ado, here’s the outline of our watcher program, as well as a brief discussion of what it does: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/couchdb/watch_changes_skeleton.js"><span class="calibre41"><span class="calibre13"><span class="underline">couchdb/watch_changes_skeleton.js</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  http = require(</span><span class="calibre9"><span class="italic"><span class="calibre38">'http'</span></span></span><span class="calibre9">),​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  events = require(</span><span class="calibre9"><span class="italic"><span class="calibre38">'events'</span></span></span><span class="calibre9">);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre46">/**</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre46"> * create a CouchDB watcher based on connection criteria;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre46"> * follows node.js EventEmitter pattern, emits 'change' events.</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre46"> */</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">① </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​exports.createWatcher = </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(options) { ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">② </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> watcher = </span><span class="calibre9"><span class="bold"><span class="calibre44">new</span></span></span><span class="calibre9"> events.EventEmitter(); ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  watcher.host = options.host || </span><span class="calibre9"><span class="italic"><span class="calibre38">'localhost'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  watcher.port = options.port || 5984;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  watcher.last_seq = options.last_seq || 0;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  watcher.db = options.db || </span><span class="calibre9"><span class="italic"><span class="calibre38">'_users'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">③ </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  watcher.start = </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">() { ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre46">// ... feed-specific implementation ...</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  };​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">return</span></span></span><span class="calibre9"> watcher;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​};​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre46">// start watching CouchDB for changes if running as main script</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">④ </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> (!module.parent) { ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  exports.createWatcher({​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    db: process.argv[2],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    last_seq: process.argv[3]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  })​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    .on(</span><span class="calibre9"><span class="italic"><span class="calibre38">'change'</span></span></span><span class="calibre9">, console.log)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    .on(</span><span class="calibre9"><span class="italic"><span class="calibre38">'error'</span></span></span><span class="calibre9">, console.error)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    .start();​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><p class="calibre12">①</p><a></a><blockquote class="calibre42"><span class="calibre9"><span class="calibre30">exports</span></span> is a standard object provided by the CommonJS Module API that Node.js implements. Adding the <span class="calibre9"><span class="calibre30">createWatcher</span></span> method to <span class="calibre9"><span class="calibre30">exports</span></span> makes it available to other Node.js scripts that might want to use this as a library. The <span class="calibre9"><span class="calibre30">options</span></span> argument allows the caller to specify which database to watch as well as override other connection settings. </blockquote><p class="calibre12">②</p><a></a><blockquote class="calibre42"><span class="calibre9"><span class="calibre30">createWatcher</span></span> produces an <span class="calibre9"><span class="calibre30">EventEmitter</span></span> object that the caller can use to listen for change events. The relevant capabilities of an <span class="calibre9"><span class="calibre30">EventEmitter</span></span> is that you can listen to events by calling its <span class="calibre9"><span class="calibre30">on</span></span> method and trigger events by calling its <span class="calibre9"><span class="calibre30">emit</span></span> method. </blockquote><p class="calibre12">③</p><a></a><blockquote class="calibre42"><span class="calibre9"><span class="calibre30">watcher.start</span></span> is responsible for issuing HTTP requests to watch CouchDB for changes. When changes to documents happen, <span class="calibre9"><span class="calibre30">watcher</span></span> should emit them as change events. All of the feed-specific implementation details will be in here. </blockquote><p class="calibre12">④</p><a></a><blockquote class="calibre42"> The last chunk of code at the bottom specifies what the script should do if it’s called directly from the command line. In this case, the script will invoke the <span class="calibre9"><span class="calibre30">createWatcher</span></span> method and then set up listeners on the returned object that dump results to standard output. Which database to connect to and what sequence ID number to start from can be set via command-line arguments. </blockquote><a></a><p class="calibre12"> So far, there’s nothing specific to CouchDB at all in this code. It’s all just Node.js’s way of doing things. This code may look foreign to you, especially if you haven’t developed with an event-driven server technology before, but it’s one we’ll be using increasingly in this book going forward. </p><a></a><p class="calibre12"> With the skeleton in place, let’s add the code to connect to CouchDB via longpolling and emit events. The following is just the code that goes inside the <span class="calibre9"><span class="calibre30">watcher.start</span></span> method. Written inside the previous outline (where the comment says <span class="italic">feed-specific implementation</span>), the new complete file should be called <span class="calibre9"><span class="calibre30">watch_changes_longpolling.js</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/couchdb/watch_changes_longpolling_impl.js"><span class="calibre41"><span class="calibre13"><span class="underline">couchdb/watch_changes_longpolling_impl.js</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">① </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  http_options = { ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    host: watcher.host,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    port: watcher.port,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    path:​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="italic"><span class="calibre38">'/'</span></span></span><span class="calibre9"> + watcher.db + </span><span class="calibre9"><span class="italic"><span class="calibre38">'/_changes'</span></span></span><span class="calibre9"> +​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="italic"><span class="calibre38">'?feed=longpoll&amp;include_docs=true&amp;since='</span></span></span><span class="calibre9"> + watcher.last_seq​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  };​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">② </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​http.get(http_options, </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(res) { ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> buffer = </span><span class="calibre9"><span class="italic"><span class="calibre38">''</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  res.on(</span><span class="calibre9"><span class="italic"><span class="calibre38">'data'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9"> (chunk) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    buffer += chunk;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  });​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  res.on(</span><span class="calibre9"><span class="italic"><span class="calibre38">'end'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">() {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">③ </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> output = JSON.parse(buffer); ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> (output.results) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      watcher.last_seq = output.last_seq;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      output.results.forEach(</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(change){​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        watcher.emit(</span><span class="calibre9"><span class="italic"><span class="calibre38">'change'</span></span></span><span class="calibre9">, change);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      });​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      watcher.start();​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    } </span><span class="calibre9"><span class="bold"><span class="calibre44">else</span></span></span><span class="calibre9"> {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      watcher.emit(</span><span class="calibre9"><span class="italic"><span class="calibre38">'error'</span></span></span><span class="calibre9">, output);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  })​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​})​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​.on(</span><span class="calibre9"><span class="italic"><span class="calibre38">'error'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(err) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  watcher.emit(</span><span class="calibre9"><span class="italic"><span class="calibre38">'error'</span></span></span><span class="calibre9">, err);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​});​</span><span class="calibre9">​</span></p></td></tr></table><p class="calibre12">①</p><a></a><blockquote class="calibre42"> The first thing this script does is set up the <span class="calibre9"><span class="calibre30">http_options</span></span> configuration object in preparation for the request. The <span class="calibre9"><span class="calibre30">path</span></span> points to the same <span class="calibre9"><span class="calibre30">_changes</span></span> URL we’ve been using, with <span class="calibre9"><span class="calibre30">feed</span></span> set to <span class="calibre9"><span class="calibre30">longpoll</span></span> and <span class="calibre9"><span class="calibre30">include_docs=true</span></span>. </blockquote><p class="calibre12">②</p><a></a><blockquote class="calibre42"> After that, the script calls <span class="calibre9"><span class="calibre30">http.get</span></span>, a Node.js library method that fires off a <span class="calibre9"><span class="calibre30">GET</span></span> request according to our settings. The second parameter to <span class="calibre9"><span class="calibre30">http.get</span></span> is a callback that will receive an <span class="calibre9"><span class="calibre30">HTTPResponse</span></span>. The response object emits <span class="calibre9"><span class="calibre30">data</span></span> events as the content is streamed back, which we add to the <span class="calibre9"><span class="calibre30">buffer</span></span>. </blockquote><p class="calibre12">③</p><a></a><blockquote class="calibre42"> Finally, when the response object emits an <span class="calibre9"><span class="calibre30">end</span></span> event, we parse the buffer (which should contain JSON). From this we learn the new <span class="calibre9"><span class="calibre30">last_seq</span></span> value, emit a <span class="calibre9"><span class="calibre30">change</span></span> event, and then reinvoke <span class="calibre9"><span class="calibre30">watcher.start</span></span> to wait for the next change. </blockquote><a></a><p class="calibre12"> To run this script in command-line mode, execute it like this (output truncated for brevity): </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">node watch_changes_longpolling.js music</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ seq: 1,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  id: '370255',​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  changes: [ { rev: '1-a7b7cc38d4130f0a5f3eae5d2c963d85' } ],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  doc:​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​   { _id: '370255',​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​     _rev: '1-a7b7cc38d4130f0a5f3eae5d2c963d85',​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​     albums: [ [Object] ],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​     id: '370255',​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​     name: '""ATTIC""',​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​     url: 'http://www.jamendo.com/artist/ATTIC_(3)',​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​     mbgid: '',​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​     random: 0.4121620435325435 } }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{ seq: 2,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  id: '370254',​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  changes: [ { rev: '1-2c7e0deec3ffca959ba0169b0e8bfcef' } ],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  doc:​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​   { _id: '370254',​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​     _rev: '1-2c7e0deec3ffca959ba0169b0e8bfcef',​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  ... 98 more entries ...​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Hurrah, our app works! After outputting a record for each document, the process will keep running, polling CouchDB for future changes. </p><a></a><p class="calibre12"> Feel free to modify a document in Futon directly or increase the <span class="calibre9"><span class="calibre30">@max</span></span> value on <span class="calibre9"><span class="calibre30">import_from_jamendo.rb</span></span> and run it again. You’ll see those changes reflected on the command line. Next we’ll see how to go full-steam ahead and use the continuous feed to get even snappier updates. </p><p class="calibre12"><span class="bold"><span class="calibre28">Watching for Changes Continuously</span></span></p><a></a><p class="calibre37"> The polling and longpolling feeds produced by the <span class="calibre9"><span class="calibre30">_changes</span></span> service both produce proper JSON results. The <span class="italic">continuous</span> feed does things a little differently. Instead of combining all available changes into a <span class="calibre9"><span class="calibre30">results</span></span> array and closing the stream afterward, it sends each change separately and keeps the connection open. This way, it’s ready to return more JSON serialized change notification objects as changes become available. </p><a></a><p class="calibre12"> To see how this works, try the following (output truncated for readability): </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl 'http://localhost:5984/music/_changes?since=97&amp;feed=continuous'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"seq":98,"id":"357999","changes":[{"rev":"1-0329f5c885...87b39beab0"}]}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"seq":99,"id":"357998","changes":[{"rev":"1-79c3fd2fe6...1e45e4e35f"}]}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"seq":100,"id":"357995","changes":[{"rev":"1-aa649aa53f...320c235aee"}]}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Eventually, if no changes have happened for a while, CouchDB will close the connection after outputting a line like this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"last_seq":100}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The benefit of this method over polling or longpolling is the reduced overhead that accompanies leaving the connection open. There’s no time lost reestablishing the HTTP connections. On the other hand, the output isn’t straight JSON, which means it’s a bit more of a chore to parse. Also, it’s not a good fit if your client is a web browser. A browser downloading the feed asynchronously might not receive any of the data until the entire connection finishes (better to use longpolling in this case). </p><p class="calibre12"><span class="bold"><span class="calibre28">Filtering Changes</span></span></p><a></a><p class="calibre37"> As we’ve just seen, the Changes API provides a unique window into the goings on of a CouchDB database. On the plus side, it provides all the changes in a single stream. However, sometimes you may want just a subset of changes, rather than the fire hose of everything that has ever changed. For example, you may be interested only in document deletions or maybe only in documents that have a particular quality. This is where <span class="italic">filter functions</span> come in. </p><a></a><p class="calibre12"> A filter is a function that takes in a document (and request information) and makes a decision as to whether that document ought to be allowed through the filter. This is gated by the return value. Let’s explore how this works. Considering our <span class="calibre9"><span class="calibre30">music</span></span> database, most artist documents we’ve been inserting have a <span class="calibre9"><span class="calibre30">country</span></span> property that contains a three-letter code. Say we were interested only in bands from Russia (RUS). Our filter function might look like the following:</p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(doc) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">return</span></span></span><span class="calibre9"> doc.country === </span><span class="calibre9"><span class="italic"><span class="calibre38">"RUS"</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If we added this to a design document under the key <span class="calibre9"><span class="calibre30">filters</span></span>, we’d be able to specify it when issuing requests for <span class="calibre9"><span class="calibre30">_changes</span></span>. But before we do, let’s expand the example. Rather than always wanting Russian bands, it’d be better if we could parameterize the input so the country could be specified in the URL. </p><a></a><p class="calibre12"> Here’s a parameterized country-based filter function: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(doc, req) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">return</span></span></span><span class="calibre9"> doc.country === req.query.country;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Notice this time how we’re comparing the document’s <span class="calibre9"><span class="calibre30">country</span></span> property to a parameter of the same name passed in the request’s query string. To see this in action, let’s create a new design document just for geography-based filters and add it: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -X PUT \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  http://localhost:5984/music/_design/wherabouts \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -H "Content-Type: application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -d '{"language":"javascript","filters":{"by_country":</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "function(doc,req){return doc.country === req.query.country;}"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }}'​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "ok":true,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "id":"_design/wherabouts",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "rev":"1-c08b557d676ab861957eaeb85b628d74"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Now we can make a country-filtered changes request: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl "http://localhost:5984/music/_changes?\</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">filter=wherabouts/by_country&amp;\</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">country=RUS"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"results":[​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"seq":10,"id":"5987","changes":[{"rev":"1-2221be...a3b254"}]},​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"seq":57,"id":"349359","changes":[{"rev":"1-548bde...888a83"}]},​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{"seq":73,"id":"364718","changes":[{"rev":"1-158d2e...5a7219"}]},​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​...​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Using filters, you have the power to set up a sort of pseudosharding, where only a subset of records are replicated between nodes. It’s not quite the same as truly sharded systems like MongoDB or HBase, but it does afford a means of splitting the responsibility of servicing certain kinds of requests. For instance, your main CouchDB server might have separate filters for users, orders, messages, and inventory. Separate CouchDB servers could replicate changes based on these filters, each supporting a different aspect of the business. </p><a></a><p class="calibre12"> Since filter functions may contain arbitrary JavaScript, more sophisticated logic can be put into them. Testing for deeply nested fields would be similar to what we did for creating views. You could also use regular expressions for testing properties or compare them mathematically (for example, filtering by a date range). There’s even a user context property on the request object (<span class="calibre9"><span class="calibre30">req.userCtx</span></span>) you can use to find out more about the credentials provided with the request. </p><a></a><p class="calibre12"> We’ll revisit Node.js and the CouchDB Changes API in Chapter 8, <a href="#filepos1669058"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Redis</span></span><span class="calibre13"><span class="underline">​</span></span></a> when we build a multidatabase application. For now, though, it’s time to move on to the last distinguishing feature of CouchDB we’re going to cover: replication. </p><blockquote class="calibre40"><span class="calibre41"><span class="bold">CouchDB or BigCouch?</span></span></blockquote><a></a><blockquote class="calibre42"><span class="calibre41"> CouchDB’s approach makes sense in a lot of use cases. It certainly fills a niche that the other databases we’ve discussed largely don’t address. On the other hand, sometimes it’s nice to selectively replicate data between nodes in order to capitalize on available disk space. That is, instead of having all nodes have all the data, keep only a certain number of copies. This is the </span><span class="calibre41"><span class="italic">N</span></span><span class="calibre41"> in NWR—discussed in </span><a href="#filepos510169"><span class="calibre41"><span class="calibre13"><span class="underline">​</span></span></span><span class="calibre41"><span class="italic"><span class="calibre13">Nodes/​Writes/​Reads</span></span></span><span class="calibre41"><span class="calibre13"><span class="underline">​</span></span></span></a><span class="calibre41">. </span></blockquote><a id="filepos1396090"></a><blockquote class="calibre47"><span class="calibre41"> This isn’t a feature that CouchDB offers out of the box, but don’t worry! BigCouch has you covered. Developed and maintained by Cloudant, BigCouch offers a CouchDB-compatible interface (with only a few minor differences</span><a href="#filepos1428346"><span class="calibre41"><span class="calibre13"><span class="underline">[46]</span></span></span></a><span class="calibre41">). Under the surface, though, it implements the sharding and replication strategy of a Dynamo-inspired database like Riak. </span></blockquote><a></a><blockquote class="calibre47"><span class="calibre41"> Installing BigCouch is quite a chore—much harder than vanilla CouchDB—but may be worth it if your deployment scenario consists of a big-iron datacenter. </span></blockquote><p class="calibre61"><span class="calibre5"><span class="bold"><span class="calibre28">Replicating Data in CouchDB</span></span></span></p><a id="filepos1396976"></a><blockquote class="calibre10"><img src="images/00042.jpg" class="calibre103"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 29. CouchDB Futon: Replicator</span></blockquote><a></a><p class="calibre12"> CouchDB is all about asynchronous environments and data durability. According to CouchDB, the safest place to store your data is everywhere, and it gives you the tools to do it. Some other databases we’ve looked at maintain a single master node to guarantee consistency. Still others ensure it with a quorum of agreeing nodes. CouchDB does neither of these; instead, it supports something called multi-master or master-master replication. </p><a></a><p class="calibre12"> Each CouchDB server is equally able to receive updates, respond to requests, and delete data, regardless of whether it’s able to connect to any other server. In this model, changes are selectively replicated in one direction, and all data is subject to replication in the same way. In other words, there is no sharding. Servers participating in replication will all have all of the data. </p><a></a><p class="calibre12"> Replication is the last major topic in CouchDB that we’ll be discussing. First we’ll see how to set up ad hoc and continuous replication between databases. Then we’ll work through the implications of conflicting data and how to make applications capable of handling these cases gracefully. </p><a></a><p class="calibre12"> To begin, click the Replicator link in the Tools menu on the right side of the page. It should open a page that looks like Figure 29, <a href="#filepos1396976"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">CouchDB Futon: Replicator</span></span><span class="calibre13"><span class="underline">​</span></span></a>. In the “Replicate changes from” dialog, choose <span class="calibre9"><span class="italic"><span class="calibre38">music</span></span></span> from the left drop-down menu and enter <span class="calibre9"><span class="italic"><span class="calibre38">music-repl</span></span></span> in the right-side slot. Leave the Continuous checkbox unchecked, and then click Replicate. Click OK to create the <span class="calibre9"><span class="calibre30">music-repl</span></span> database when prompted. This should produce an event message in the event log below the form. </p><a></a><p class="calibre12"> To confirm that the replication request worked, go back to the Futon Overview page. There should now be a new database called <span class="calibre9"><span class="calibre30">music-repl</span></span> with the same number of documents as the <span class="calibre9"><span class="calibre30">music</span></span> database. If it has fewer, give it some time and refresh the page—CouchDB may be in the process of catching up. Don’t be concerned if the Update Seq values don’t match. That’s because the original <span class="calibre9"><span class="calibre30">music</span></span> database had deletions and updates to documents, whereas the <span class="calibre9"><span class="calibre30">music-repl</span></span> database had only insertions to bring it up to speed. </p><p class="calibre12"><span class="bold"><span class="calibre28">Creating Conflicts</span></span></p><a></a><p class="calibre37"> Next we’ll create a conflict and then explore how to deal with it. Keep the Replicator page handy because we’re going to be triggering ad hoc replication between <span class="calibre9"><span class="calibre30">music</span></span> and <span class="calibre9"><span class="calibre30">music-repl</span></span> frequently. </p><a></a><p class="calibre12"> Drop back to the command line, and enter this to create a document in the <span class="calibre9"><span class="calibre30">music</span></span> database: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -X PUT "http://localhost:5984/music/theconflicts" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44"> -H "Content-Type: application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44"> -d '{ "name": "The Conflicts" }'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "ok":true,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "id":"theconflicts",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "rev":"1-e007498c59e95d23912be35545049174"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> On the Replicator page, click Replicate to trigger another synchronization. We can confirm that the document was successfully replicated by retrieving it from the <span class="calibre9"><span class="calibre30">music-repl</span></span> database. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl "http://localhost:5984/music-repl/theconflicts"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "_id":"theconflicts",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "_rev":"1-e007498c59e95d23912be35545049174",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "name":"The Conflicts"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Next, let’s update it in <span class="calibre9"><span class="calibre30">music-repl</span></span> by adding an album called <span class="calibre9"><span class="italic"><span class="calibre38">Conflicts of Interest</span></span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -X PUT "http://localhost:5984/music-repl/theconflicts" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -H "Content-Type: application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -d '{</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "_id": "theconflicts",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "_rev": "1-e007498c59e95d23912be35545049174",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "name": "The Conflicts",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "albums": ["Conflicts of Interest"]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }'​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "ok":true,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "id":"theconflicts",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "rev":"2-0c969fbfa76eb7fcdf6412ef219fcac5"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> And create a conflicting update in <span class="calibre9"><span class="calibre30">music</span></span> proper by adding a different album: <span class="calibre9"><span class="italic"><span class="calibre38">Conflicting Opinions</span></span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -X PUT "http://localhost:5984/music/theconflicts" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -H "Content-Type: application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">  -d '{</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "_id": "theconflicts",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "_rev": "1-e007498c59e95d23912be35545049174",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "name": "The Conflicts",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "albums": ["Conflicting Opinions"]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }'​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "ok":true,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "id":"theconflicts",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "rev":"2-cab47bf4444a20d6a2d2204330fdce2a"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> At this point, both the <span class="calibre9"><span class="calibre30">music</span></span> and <span class="calibre9"><span class="calibre30">music-repl</span></span> databases have a document with an <span class="calibre9"><span class="calibre30">_id</span></span> value of <span class="calibre9"><span class="calibre30">theconflicts</span></span>. Both documents are at version <span class="calibre9"><span class="calibre30">2</span></span> and derived from the same base revision (<span class="calibre9"><span class="calibre30">1-e007498c59e95d23912be35545049174</span></span>). Now the question is, what happens when we try to replicate between them? </p><p class="calibre12"><span class="bold"><span class="calibre28">Resolving Conflicts</span></span></p><a></a><p class="calibre37"> With our document now in a conflicting state between the two databases, head back to the Replicator page and kick off another replication. If you were expecting this to fail, you may be shocked to learn that the operation succeeds just fine. So, how did CouchDB deal with the discrepancy? </p><a></a><p class="calibre12"> It turns out that CouchDB basically just picks one and calls that one the winner. Using a deterministic algorithm, all CouchDB nodes will pick the same winner when a conflict is detected. However, the story doesn’t end there. CouchDB stores the unselected “loser” documents as well so that a client application can review the situation and resolve it at a later date. </p><a></a><p class="calibre12"> To find out which version of our document won during the last replication, we can request it using the normal <span class="calibre9"><span class="calibre30">GET</span></span> request channel. By adding the <span class="calibre9"><span class="calibre30">conflicts=true</span></span> URL parameter, CouchDB will also include information about the conflicting revisions. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:5984/music-repl/theconflicts?conflicts=true</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "_id":"theconflicts",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "_rev":"2-cab47bf4444a20d6a2d2204330fdce2a",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "name":"The Conflicts",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "albums":["Conflicting Opinions"],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "_conflicts":[​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "2-0c969fbfa76eb7fcdf6412ef219fcac5"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  ]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> So, we see that the second update won. Notice the <span class="calibre9"><span class="calibre30">_conflicts</span></span> field in the response. It contains a list of other revisions that conflicted with the chosen one. By adding a <span class="calibre9"><span class="calibre30">rev</span></span> parameter to a <span class="calibre9"><span class="calibre30">GET</span></span> request, we can pull down those conflicting revisions and decide what to do about them. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:5984/music-repl/theconflicts?rev=2-0c969f...</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "_id":"theconflicts",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "_rev":"2-0c969fbfa76eb7fcdf6412ef219fcac5",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "name":"The Conflicts",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "albums":["Conflicts of Interest"]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The takeaway here is that CouchDB does not try to intelligently merge conflicting changes. How to merge two documents is highly application-specific, and a general solution isn’t practical. In our case, combining the two <span class="calibre9"><span class="calibre30">albums</span></span> arrays by concatenating them makes sense, but one could easily think of scenarios where the appropriate action is not obvious. </p><a></a><p class="calibre12"> For example, consider you’re maintaining a database of calendar events. One copy is on your smartphone; another is on your laptop. You get a text message from a party planner specifying the venue for the party you’re hosting, so you update your phone database accordingly. Later, back at the office, you receive another email from the planner specifying a <span class="italic">different</span> venue. So, you update your laptop database and then replicate between them. CouchDB has no way of knowing which of the two venues is correct. The best it can do is make them consistent, keeping the old value around so you can verify which of the conflicting values should be kept. It would be up to the application to determine the right user interface for presenting this situation and asking for a decision. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Day 3 Wrap-Up</span></span></span></p><a></a><p class="calibre29"> And so ends our tour of CouchDB. Here in Day 3 we started out by learning how to add reducer functions to our mapreduce-generated views. After that, we took a deep dive into the Changes API, including a jaunt into the world of event-driven server-side JavaScript development with Node.js. Lastly, we took a brief look at how CouchDB achieves its master-master replication strategy and how client applications can detect and correct for conflicts. </p><p class="calibre12"><span class="bold"><span class="calibre28">Day 3 Homework</span></span></p><p class="calibre37"><span class="bold">Find</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">What native reducers are available in CouchDB? What are the benefits of using native reducers over custom JavaScript reducers?</p></li><li value="2" class="calibre36"><p class="calibre22">How can you filter the changes coming out of the <span class="calibre9"><span class="calibre30">_changes</span></span> API on the server side?</p></li><li value="3" class="calibre36"><p class="calibre22">Like everything in CouchDB, the tasks of initializing and canceling replication are controlled by HTTP commands under the hood. What are the REST commands to set up and remove replication relationships between servers?</p></li><li value="4" class="calibre36"><p class="calibre22">How can you use the <span class="calibre9"><span class="calibre30">_replicator</span></span> database to persist replication relationships?</p></li></ol><p class="calibre12"><span class="bold">Do</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22"> Create a new module called <span class="calibre9"><span class="calibre30">watch_changes_continuous.js</span></span> based on the skeletal Node.js module described in the section <a href="#filepos1347455"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Polling for Changes with Node.js</span></span><span class="calibre13"><span class="underline">​</span></span></a>. </p></li><li value="2" class="calibre36"><p class="calibre22"> Implement <span class="calibre9"><span class="calibre30">watcher.start</span></span> such that it monitors the continuous <span class="calibre9"><span class="calibre30">_changes</span></span> feed. Confirm that it produces the same output as <span class="calibre9"><span class="calibre30">watch_changes_longpolling.js</span></span>. </p><p class="calibre12"><span class="italic">Hint: If you get stuck, you can find an example implementation in the downloads that accompany this book.</span>
</p></li><li value="3" class="calibre36"><p class="calibre22"> Documents with conflicting revisions have a <span class="calibre9"><span class="calibre30">_conflicts</span></span> property. Create a view that emits conflicting revisions and maps them to the doc <span class="calibre9"><span class="calibre30">_id</span></span>. </p></li></ol><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos1424545" class="calibre1"><p class="calibre24" id="filepos1424550"><span class="calibre25"><span class="bold"><span class="calibre26">6.5 Wrap-Up</span></span></span></p><a></a><p class="calibre27"> Through this chapter we’ve seen how to do a pretty wide range of tasks with CouchDB, from performing basic CRUD operations to building views out of mapreduce functions. We saw how to watch for changes, and we explored developing nonblocking event-driven client applications. Finally, we learned how to perform ad hoc replication between databases and how to detect and resolve conflicts. Despite all of this content, there’s still a lot we didn’t cover, but now it’s time to wrap things up before heading off to our next database. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">CouchDB’s Strengths</span></span></span></p><a></a><p class="calibre29"> CouchDB is a robust and stable member of the NoSQL community. Built on the philosophy that networks are unreliable and hardware failure is imminent, CouchDB offers a heartily decentralized approach to data storage. Small enough to live in your smartphone and big enough to support the enterprise, CouchDB affords a variety of deployment situations. </p><a></a><p class="calibre12"> CouchDB is as much an API as a database. In this chapter, we focused on the canonical Apache CouchDB project, but there are an increasing number of alternative implementations and CouchDB service providers built on hybrid back ends. Because CouchDB is made “of the Web, for the Web,” it’s fairly straightforward to layer in web technologies—such as load balancers and caching layers—and still end up with something that’s true to CouchDB’s APIs. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">CouchDB’s Weaknesses</span></span></span></p><a></a><p class="calibre29"> Of course, CouchDB isn’t for everything. CouchDB’s mapreduce-based views, while novel, can’t perform all the fancy data slicing you’d expect from a relational database. In fact, you shouldn’t be running ad hoc queries <span class="italic">at all</span> in production. Also, CouchDB’s replication strategy isn’t always the right choice. CouchDB replication is all or nothing, meaning all replicated servers will have the same contents. There is no sharding to distribute content around the datacenter. The principal reason for adding more CouchDB nodes is not to spread the data around so much as to increase throughput for read and write operations. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Parting Thoughts</span></span></span></p><a></a><p class="calibre29"> CouchDB’s attention to robustness in the face of uncertainty makes it a great choice if your system must stand up to the harsh realities of the wild Internet. By leveraging standard webisms like HTTP/REST and JSON, CouchDB fits in easily wherever web technologies are prevalent, which is increasingly everywhere. Inside the walled garden of a datacenter, CouchDB can still make sense if you commit to managing conflicts when they arise or if you pursue an alternative implementation like BigCouch, but don’t expect to get sharding right out of the box. </p><a></a><p class="calibre12"> There are plenty of other features that make CouchDB unique and special that we didn’t have time to cover. A short list would include ease of backups, binary attachments to documents, and CouchApps—a system for developing and deploying web apps directly through CouchDB with no other middleware. Having said that, we hope we’ve provided enough of an overview to whet your appetite for more. Try CouchDB for your next data-driven web app; you won’t be disappointed! </p><p class="calibre23"><span class="calibre9"><span class="bold"><span class="calibre28">Footnotes</span></span></span></p><a id="filepos1428346"></a><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1210384"><span class="calibre9"><span class="calibre13"><span class="underline">[40]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://localhost:5984/_utils/"><span class="calibre9"><span class="calibre13"><span class="underline">http://localhost:5984/_utils/</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1259824"><span class="calibre9"><span class="calibre13"><span class="underline">[41]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://www.jamendo.com/"><span class="calibre9"><span class="calibre13"><span class="underline">http://www.jamendo.com/</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1260180"><span class="calibre9"><span class="calibre13"><span class="underline">[42]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://developer.jamendo.com/en/wiki/NewDatabaseDumps"><span class="calibre9"><span class="calibre13"><span class="underline">http://developer.jamendo.com/en/wiki/NewDatabaseDumps</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1260180"><span class="calibre9"><span class="calibre13"><span class="underline">[43]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://img.jamendo.com/data/dbdump_artistalbumtrack.xml.gz"><span class="calibre9"><span class="calibre13"><span class="underline">http://img.jamendo.com/data/dbdump_artistalbumtrack.xml.gz</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1260683"><span class="calibre9"><span class="calibre13"><span class="underline">[44]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://rdoc.info/github/couchrest/couchrest/master/"><span class="calibre9"><span class="calibre13"><span class="underline">http://rdoc.info/github/couchrest/couchrest/master/</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1333328"><span class="calibre9"><span class="calibre13"><span class="underline">[45]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://nodejs.org/"><span class="calibre9"><span class="calibre13"><span class="underline">http://nodejs.org/</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1396090"><span class="calibre9"><span class="calibre13"><span class="underline">[46]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://bigcouch.cloudant.com/api"><span class="calibre9"><span class="calibre13"><span class="underline">http://bigcouch.cloudant.com/api</span></span></span></a><span class="calibre9">
</span></p></td></tr></table><p class="calibre17"><span class="calibre9"><span class="calibre18"><span class="calibre19">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos1431208" class="calibre1"><p class="calibre21" id="filepos1431213"><span class="calibre3"><span class="bold"><span class="calibre31"> Chapter 7</span></span></span></p><br class="calibre1"/><p class="calibre32"><span class="calibre3"><span class="bold"><span class="calibre4">Neo4J</span></span></span></p><a></a><p class="calibre12"> A bungee cord may not seem a standard carpentry tool, just like Neo4j may not seem like a standard database. Bungee cord is used to tie things together—no matter how awkwardly shaped the objects may be. If your ability to tie a table to a column to a pickup truck in the most organic way is of the utmost importance, this is your go-to tool. </p><a></a><p class="calibre12"> Neo4j is a new type of NoSQL datastore called a <span class="italic">graph database</span>. As the name implies, it stores data as a graph (in the mathematical sense). It’s known for being “whiteboard friendly,” meaning if you can draw a design as boxes and lines on a whiteboard, you can store it in Neo4j. Neo4j focuses more on the <span class="italic">relationships between</span> values than on the commonalities <span class="italic">among sets of</span> values (such as collections of documents or tables of rows). In this way, it can store highly variable data in a natural and straightforward way. </p><a></a><p class="calibre12"> Neo4j is small enough to be embedded into nearly any application. On the other end of the spectrum, Neo4j can store tens of billions of nodes and as many edges. And with its cluster support with master-slave replication across many servers, it can handle most any sized problem you can throw at it. </p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos1432790" class="calibre1"><p class="calibre24" id="filepos1432795"><span class="calibre25"><span class="bold"><span class="calibre26">7.1 Neo4J Is Whiteboard Friendly</span></span></span></p><a></a><p class="calibre27"> Imagine you must create a wine suggestion engine where wines have different varieties, regions, wineries, vintages, and designations. Perhaps you need to keep track of articles by authors describing wines. Perhaps you want to let users track their favorites. </p><a id="filepos1433234"></a><blockquote class="calibre10"><img src="images/00060.jpg" class="calibre104"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 30. Wine suggestion schema in relational UML</span></blockquote><a></a><p class="calibre12"> A relational model may create a category table and a many-to-many relationship between a single winery’s wine and some combination of categories and other data. But this isn’t quite how humans mentally model data. Compare these two figures: Figure 30, <a href="#filepos1433234"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Wine suggestion schema in relational UML</span></span><span class="calibre13"><span class="underline">​</span></span></a> and Figure 31, <a href="#filepos1434943"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Wine suggestion data on a whiteboard</span></span><span class="calibre13"><span class="underline">​</span></span></a>. There’s an old saying in the relational database world: <span class="italic">on a long enough timeline, all fields become optional</span>. Neo4j handles this implicitly by providing values and structure only where necessary. If a wine blend has no vintage, instead add a bottle year and point the vintages to the blend node. There is no schema to adjust. </p><a></a><p class="calibre12"> Over the next three days we’ll learn how to interact with Neo4j through a console and then through REST and search indexes. We’ll work with some larger graphs with graph algorithms. Finally, on Day 3, we’ll take a peek at the enterprise tools Neo4j provides for mission-critical applications, from full ACID-compliant transactions to high-availability clustering and incremental backups. </p><a id="filepos1434943"></a><blockquote class="calibre10"><img src="images/00016.jpg" class="calibre105"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 31. Wine suggestion data on a whiteboard</span></blockquote><a></a><p class="calibre12"> In this chapter, we’ll use the Neo4j 1.7 Enterprise edition. Most of the actions we perform can actually use the GPL Community edition, but we’ll require some enterprise functionality for Day 3: high availability. </p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos1435517" class="calibre1"><p class="calibre24" id="filepos1435522"><span class="calibre25"><span class="bold"><span class="calibre26">7.2 Day 1: Graphs, Groovy, and CRUD</span></span></span></p><a></a><p class="calibre27"> Today we’re really going to jump in with both feet. In addition to exploring the Neo4j web interface, we’ll get deep into graph database terminology and CRUD. Much of today will be learning how to query a graph database through a process called <span class="italic">walking</span>. The concepts here differ significantly from other databases we’ve looked at so far, which have largely taken a document- or record-based view of the world. In Neo4j, it’s all about relationships. </p><a></a><p class="calibre12"> But before we get to all that, let’s start with the web interface to see how Neo4j represents data in graph form and how to walk around that graph. After you’ve downloaded and unzipped the Neo4j package, <span class="calibre9"><span class="calibre30">cd</span></span> into the directory and start up the server with this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ bin/neo4j start​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> To make sure you’re up and running, try <span class="calibre9"><span class="calibre30">curl</span></span>ing this URL: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ curl http://localhost:7474/db/data/​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Like CouchDB, the default Neo4j package comes equipped with a substantial web administration tool and data browser, which is excellent for playing with toy commands. If that weren’t enough, it has one of the coolest graph data browsers we’ve ever seen. This is perfect for getting started, since graph traversal can feel very awkward at first try. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Neo4j’s Web Interface</span></span></span></p><a></a><p class="calibre29"> Launch a web browser, and navigate to the administration page. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​http://localhost:7474/webadmin/​</span><span class="calibre9">​</span></p></td></tr></table><a id="filepos1438202"></a><blockquote class="calibre10"><img src="images/00021.jpg" class="calibre106"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 32. The web administration page dashboard</span></blockquote><a></a><p class="calibre12"> You’ll be greeted by a colorful yet empty graph like the one pictured in Figure 32, <a href="#filepos1438202"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">The web administration page dashboard</span></span><span class="calibre13"><span class="underline">​</span></span></a>. Click the Data Browser option at the top. A new Neo4j install will have a preexisting reference node: node 0. </p><a></a><p class="calibre12"> A <span class="italic">node</span> in a graph database is not entirely unlike the nodes we talked about in prior chapters. Previously, when we spoke of a <span class="italic">node</span>, we meant a physical server in a network. If you viewed the entire network as a huge interconnected graph, a server node was a point, or <span class="italic">vertex</span>, between the server <span class="italic">relationships</span>, or <span class="italic">edges</span>. </p><a></a><p class="calibre12"> In Neo4j, a node is conceptually similar; it’s a vertex between edges that may hold data, as a set of key-values. Click the + Property button and set the key to <span class="calibre9"><span class="italic"><span class="calibre38">name</span></span></span> and value to <span class="calibre9"><span class="italic"><span class="calibre38">Prancing Wolf Ice Wine 2007</span></span></span> to represent a specific wine and vintage. Next, click the + Node button pictured below: </p><p class="calibre12"><img src="images/00020.jpg" class="calibre107"/></p><a></a><p class="calibre22"> To the new node, add the property <span class="calibre9"><span class="calibre30">name</span></span> with a value of <span class="calibre9"><span class="italic"><span class="calibre38">Wine Expert Monthly</span></span></span> (we’ll write it in shorthand like this: <span class="calibre9"><span class="calibre30">[name : "Wine Expert Monthly"]</span></span>). The node number will be automatically incremented. </p><a></a><p class="calibre12"> Now we have two nodes sitting out there but nothing connecting them. Since Wine Expert reported on the Prancing Wolf wine, we need to relate the two by creating an edge. Click the + Relationship button, and set from node 1 to node 0 with type <span class="calibre9"><span class="calibre30">reported_on</span></span>. </p><a></a><p class="calibre12"> You’ll get a URL to this specific relationship... </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​http://localhost:7474/db/data/relationship/0​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> that shows <span class="calibre9"><span class="italic"><span class="calibre38">Node 1 reported_on Node 0</span></span></span>. </p><a></a><p class="calibre12"> Just like nodes, relationships can contain properties. Click the + Add Property button and enter the property <span class="calibre9"><span class="calibre30">[rating : 92]</span></span> so we can keep track of what score the wine received. </p><a></a><p class="calibre12"> This particular ice wine is created from the <span class="italic">riesling</span> grape, so let’s add that information too. We could add the property directly to the wine node, but riesling is a general category that could apply to other wines, so let’s create a new node and set its property to <span class="calibre9"><span class="calibre30">[name : "riesling"]</span></span>. Next add another relationship from node 0 to 2 as <span class="calibre9"><span class="calibre30">grape_type</span></span> and give it the property <span class="calibre9"><span class="calibre30">[style : "ice wine"]</span></span>. </p><a></a><p class="calibre12"> But what does our graph look like? If you click the “switch view mode” button (the squiggle-looking one beside + Relationship), you’ll see something like Figure 33, <a href="#filepos1442363"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">A graph of nodes related to the current one</span></span><span class="calibre13"><span class="underline">​</span></span></a>. </p><a id="filepos1442363"></a><blockquote class="calibre10"><img src="images/00032.jpg" class="calibre108"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 33. A graph of nodes related to the current one</span></blockquote><a></a><p class="calibre12"> The Style button brings up a menu where you can choose which profile is used for rendering the graph visualization. To see more useful information on the diagram, click Style and then New Profile. This will take you to the “Create new visualization profile” page. Enter the name <span class="calibre9"><span class="italic"><span class="calibre38">wines</span></span></span> at the top, and then change the label from <span class="calibre9"><span class="calibre30">{id}</span></span> to <span class="calibre9"><span class="calibre30">{id}: {prop.name}</span></span>. Click Save to bring you back to the visualization page. Now you can choose <span class="italic">wines</span> from the Style menu, which should produce something like Figure 34, <a href="#filepos1443531"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">A graph of nodes using a custom profile</span></span><span class="calibre13"><span class="underline">​</span></span></a>. </p><a id="filepos1443531"></a><blockquote class="calibre10"><img src="images/00023.jpg" class="calibre109"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 34. A graph of nodes using a custom profile</span></blockquote><a></a><p class="calibre12"> Although the web interface is an easy way to make a few edits, we need a more powerful interface for production work. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Neo4j via Gremlin</span></span></span></p><a></a><p class="calibre29"> There are several languages that interoperate with Neo4j: Java code, REST, Cypher, Ruby console, and others. The one we’ll use today is called Gremlin, which is a graph traversal language written in the Groovy programming language. You needn’t actually know Groovy to use Gremlin, however, so think of it as just another declarative domain-specific language, like SQL. </p><a></a><p class="calibre12"> Like other consoles we’ve explored, Gremlin provides access to the underlying language infrastructure on which it’s based. This means you can use Groovy constructs and Java libraries in Gremlin. We found it a powerful and more natural way of interacting with graphs than Neo4j’s native Java code. And even better, the Gremlin console is available in the Web Admin; just click the Console link at the top, and choose Gremlin. </p><a></a><p class="calibre12"> As a matter of convention, <span class="calibre9"><span class="calibre30">g</span></span> is a variable that represents the graph object. Graph <span class="italic">actions</span> are functions called on it. </p><a></a><p class="calibre12"> Since Gremlin is a general-purpose graph traversal language, it uses general mathematic graph terms. Where Neo4j calls a graph data point a <span class="italic">node</span>, Gremlin prefers <span class="italic">vertex</span>, and rather than <span class="italic">relationship</span>, Gremlin calls it an <span class="italic">edge</span>. </p><a></a><p class="calibre12"> To access all of the vertices in this graph, there is a property simply named <span class="calibre9"><span class="calibre30">V</span></span> for vertices. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; g.V​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt;v[0]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt;v[1]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt;v[2]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> along with a sister property named <span class="calibre9"><span class="calibre30">E</span></span>, for edges. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; g.E​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; e[0][1-reported_on-&gt;0]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; e[1][0-grape_type-&gt;2]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You can grab a particular vertex by passing a node number into the <span class="calibre9"><span class="calibre30">v</span></span> (lowercase) method. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; g.v(0)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; v[0]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> To make sure you have the correct vertex, you can list its properties via the <span class="calibre9"><span class="calibre30">map</span></span> method. Note that you can chain method calls in Groovy/Gremlin. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; g.v(0).map()​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; name=Prancing Wolf Ice Wine 2007​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Although using <span class="calibre9"><span class="calibre30">v(0)</span></span> will retrieve the exact node, you could also filter out all nodes by some value you want. For example, to retrieve <span class="italic">riesling</span> by name, you can use the {…} filter syntax, which in Groovy code is called a <span class="italic">closure</span>. All of the code between the curly braces, {…}, define the function that, if it returns true, will walk that vertex. The <span class="calibre9"><span class="calibre30">it</span></span> keyword inside the closure represents the current object and is automatically populated for your use. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; g.V.filter{it.name=='riesling'}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; v[2]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Once you have a vertex, you can get the outgoing edges by calling <span class="calibre9"><span class="calibre30">outE</span></span> on the returned vertex. Incoming edges are retrieved by <span class="calibre9"><span class="calibre30">inE</span></span>, and both incoming and outgoing are called by <span class="calibre9"><span class="calibre30">bothE</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; g.V.filter{it.name=='Wine Expert Monthly'}.outE()​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; e[0][1-reported_on-&gt;0]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Note that in Groovy, like Ruby, method parentheses are optional for methods, so calling <span class="calibre9"><span class="calibre30">outE</span></span> is fine too. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; g.V.filter{it.name=='Wine Expert Monthly'}.outE​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; e[0][1-reported_on-&gt;0]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> From the out edges, you can walk to incoming vertices with <span class="calibre9"><span class="calibre30">inV</span></span>—that is, the vertices into which the edges point. The <span class="calibre9"><span class="calibre30">reported_on</span></span> edge from Wine Expert points into the <span class="italic">Prancing Wolf Ice Wine 2007</span> vertex, so <span class="calibre9"><span class="calibre30">outE.inV</span></span> will return it. Then retrieve the <span class="calibre9"><span class="calibre30">name</span></span> property by calling it on the vertex. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; g.V.filter{it.name=='Wine Expert Monthly'}.outE.inV.name​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; Prancing Wolf Ice Wine 2007​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The expression <span class="calibre9"><span class="calibre30">outE.inV</span></span> asks for any vertices to which the input vertices have edges. The reverse operation (asking for all vertices that have edges <span class="italic">into</span> the input vertices) is achieved with <span class="calibre9"><span class="calibre30">inE.outV</span></span>. Because these two operations are so common, Gremlin has shorthand versions of both. The expression <span class="calibre9"><span class="calibre30">out</span></span> is short for <span class="calibre9"><span class="calibre30">outE.inV</span></span>, and <span class="calibre9"><span class="calibre30">in</span></span> is short for <span class="calibre9"><span class="calibre30">inE.outV</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; g.V.filter{it.name=='Wine Expert Monthly'}.out.name​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; Prancing Wolf Ice Wine 2007​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> A winery makes more than one wine, so if we plan to add more, we should add the winery as a joining node and add an edge to the Prancing Wolf. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; pwolf = g.addVertex([name : 'Prancing Wolf Winery'])​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; v[3]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; g.addEdge(pwolf, g.v(0), 'produced')​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; e[2][3-produced-&gt;0]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> From here we’ll add a couple more rieslings: Kabinett and Spatlese. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; kabinett = g.addVertex([name : 'Prancing Wolf Kabinett 2002'])​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; v[4]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; g.addEdge(pwolf, kabinett, 'produced')​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; e[3][3-produced-&gt;4]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; spatlese = g.addVertex([name : 'Prancing Wolf Spatlese 2007'])​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; v[5]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; g.addEdge(pwolf, spatlese, 'produced')​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; e[4][3-produced-&gt;5]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Let’s wrap up this little graph by adding some edges from the riesling vertex to the newly added vertices. We’ll set the riesling variable by filtering the riesling node; <span class="calibre9"><span class="calibre30">next</span></span> is necessary to grab the first vertex out of the pipeline—something we will go over in more detail shortly. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; riesling = g.V.filter{it.name=='riesling'}.next()​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; v[2]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; g.addEdge([style:'kabinett'], kabinett, riesling, 'grape_type')​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; e[5][4-grape_type-&gt;2]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The Spatlese can be pointed to riesling in a similar way, but with the <span class="calibre9"><span class="calibre30">style</span></span> set to <span class="calibre9"><span class="calibre30">spatlese</span></span>. With all this data added, in the visualizer your graph should look like Figure 35, <a href="#filepos1460462"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">A graph of nodes after adding data with Gremlin</span></span><span class="calibre13"><span class="underline">​</span></span></a>. </p><a id="filepos1460462"></a><blockquote class="calibre10"><img src="images/00033.jpg" class="calibre110"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 35. A graph of nodes after adding data with Gremlin</span></blockquote><a></a><p class="calibre23"><span class="calibre5"><span class="bold"><span class="calibre28">The Power of Pipes</span></span></span></p><a></a><p class="calibre29"> You can think of Gremlin operations as a series of pipes. Each pipe takes a collection as input and pushes a collection as output. A collection may have one item, many items, or no items at all. The items may be vertices, edges, or property values. </p><a></a><p class="calibre12"> For example, the <span class="calibre9"><span class="calibre30">outE</span></span> pipe takes in a collection of vertices and sends out a collection of edges. The series of pipes is called a <span class="italic">pipeline</span> and expresses <span class="italic">declaratively</span> what the problem is. Contrast this with a typical <span class="italic">imperative</span> programming approach, which would require you to describe the steps to solve the problem. Using pipes is one of the most concise ways to query a graph database. </p><a></a><p class="calibre12"> At its heart, Gremlin is a language to build these pipes. Specifically, it is built on top of a Java project named Pipes. To explore the pipe concept, let’s return to our wine graph. Suppose we want to find wines that are similar to a given wine—that is, they have the same type. We can follow an ice wine that also shares a <span class="calibre9"><span class="calibre30">grape_type</span></span> edge with other out nodes (ignoring the initial wine node). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ice_wine = g.v(0)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ice_wine.out('grape_type').in('grape_type').filter{ !it.equals(ice_wine) }​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If you’ve worked in Smalltalk or Rails with scopes, this style of method chaining will seem familiar to you. But compare the previous to using the standard Neo4j Java API shown next, where a node’s relationships must be iterated through in order to access the varietal nodes. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">enum</span></span></span><span class="calibre9"> WineRelationshipType </span><span class="calibre9"><span class="bold"><span class="calibre44">implements</span></span></span><span class="calibre9"> RelationshipType {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  grape_type​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">import</span></span></span><span class="calibre9"> static WineRelationshipType.grape_type;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">public</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">static</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">List</span></span></span><span class="calibre9">&lt;Node&gt; same_variety( Node wine ) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">List</span></span></span><span class="calibre9">&lt;Node&gt; wine_list = </span><span class="calibre9"><span class="bold"><span class="calibre44">new</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">ArrayList</span></span></span><span class="calibre9">&lt;Node&gt;();​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="italic"><span class="calibre46">// walk into all out edges from this vertex</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">for</span></span></span><span class="calibre9">( Relationship outE : wine.getRelationships( grape_type ) ) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre46">// walk into all in edges from this edge's out vertex</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">for</span></span></span><span class="calibre9">( Edge inE : outE.getEndNode().getRelationships( grape_type ) ) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="italic"><span class="calibre46">// only add vertices that are not the given vertex</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9">( !inE.getStartNode().equals( wine ) ) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        wine_list.add( inE.getStartNode() );​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">return</span></span></span><span class="calibre9"> wine_list;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Rather than nesting and iterating as shown earlier, the Pipes project designed a way to declare incoming and outgoing vertices. You create a sequence of in and out pipes, filters, and request values from the pipeline. Then iteratively call the pipeline’s <span class="calibre9"><span class="calibre30">hasNext</span></span> method, which returns the next matching node. In other words, the pipeline walks the tree for you. Until the pipeline is requested, you’re simply declaring how the walk will occur. </p><a></a><blockquote class="calibre76"><img src="images/00014.jpg" class="calibre92"/><span class="calibre9">        </span></blockquote><blockquote class="calibre42"><span class="calibre9"><span class="bold"><span class="calibre31">Jim says:</span></span></span></blockquote><blockquote class="calibre85"><span class="bold"><span class="calibre4">jQuery and Gremlin</span></span></blockquote><a></a><blockquote class="calibre83"><span class="calibre9"> Users of the popular jQuery JavaScript library may find Gremlin’s collection-oriented traversal method to be quite familiar. Consider this HTML snippet: </span></blockquote><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;ul</span></span></span><span class="calibre9"> id=</span><span class="calibre9"><span class="italic"><span class="calibre38">"navigation"</span></span></span><span class="calibre9"><br class="calibre1"/></span><span class="calibre9"><span class="bold"><span class="calibre44">&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;li&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;a</span></span></span><span class="calibre9"> name=</span><span class="calibre9"><span class="italic"><span class="calibre38">"section1"</span></span></span><span class="calibre9"><br class="calibre1"/></span><span class="calibre9"><span class="bold"><span class="calibre44">&gt;</span></span></span><span class="calibre9">section 1</span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;/a&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;/li&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;li&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;a</span></span></span><span class="calibre9"> name=</span><span class="calibre9"><span class="italic"><span class="calibre38">"section2"</span></span></span><span class="calibre9"><br class="calibre1"/></span><span class="calibre9"><span class="bold"><span class="calibre44">&gt;</span></span></span><span class="calibre9">section 2</span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;/a&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;/li&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">&lt;/ul&gt;</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></blockquote></td></tr></table><a></a><blockquote class="calibre111"><span class="calibre9"> Now suppose we want to find the text of all tags with the name </span><span class="calibre9"><span class="calibre30">section1</span></span><span class="calibre9"> that are children of list items (</span><span class="calibre9"><span class="calibre30">&lt;li&gt;</span></span><span class="calibre9">) under the navigation element (</span><span class="calibre9"><span class="calibre30">id=navigation</span></span><span class="calibre9">). One way to do that in jQuery is with code like this: </span></blockquote><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​$('[id=navigation]').children('li').children('[name=section1]').text()​</span><span class="calibre9">​</span></blockquote></td></tr></table><a></a><blockquote class="calibre111"><span class="calibre9"> Next, consider what a Gremlin query might look like for a similar data set, imagining that each parent node has an edge pointing to each of its children. Pretty similar, eh? </span></blockquote><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​g.V.filter{it.id=='navigation'}.out.filter{it.tag=='li'}.​</span><span class="calibre9">​</span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​out.filter{it.name=='section1'}.text​</span><span class="calibre9">​</span></blockquote></td></tr></table><a></a><p class="calibre23"> To illustrate, here’s another implementation of the <span class="calibre9"><span class="calibre30">same_variety</span></span> method, which uses Pipes rather than explicitly looping: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">public</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">static</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">void</span></span></span><span class="calibre9"> same_variety( Vertex wine ) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">List</span></span></span><span class="calibre9">&lt;Vertex&gt; wine_list = </span><span class="calibre9"><span class="bold"><span class="calibre44">new</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">ArrayList</span></span></span><span class="calibre9">&lt;Vertex&gt;();​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">Pipe</span></span></span><span class="calibre9"> inE       = </span><span class="calibre9"><span class="bold"><span class="calibre44">new</span></span></span><span class="calibre9"> InPipe( </span><span class="calibre9"><span class="italic"><span class="calibre38">"grape_type"</span></span></span><span class="calibre9"> );​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">Pipe</span></span></span><span class="calibre9"> outE      = </span><span class="calibre9"><span class="bold"><span class="calibre44">new</span></span></span><span class="calibre9"> OutPipe( </span><span class="calibre9"><span class="italic"><span class="calibre38">"grape_type"</span></span></span><span class="calibre9"> );​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">Pipe</span></span></span><span class="calibre9"> not_wine = </span><span class="calibre9"><span class="bold"><span class="calibre44">new</span></span></span><span class="calibre9"> ObjectFilterPipe( wine, true );​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">Pipe</span></span></span><span class="calibre9">&lt;Vertex,Vertex&gt; pipeline =​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">new</span></span></span><span class="calibre9"> Pipeline&lt;Vertex,Vertex&gt;( outE, inE, not_wine );​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  pipeline.setStarts( </span><span class="calibre9"><span class="bold"><span class="calibre44">Arrays</span></span></span><span class="calibre9">.asList( wine ) );​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">while</span></span></span><span class="calibre9">( pipeline.hasNext() ) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    wine_list.add( pipeline.next() );​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">return</span></span></span><span class="calibre9"> wine_list;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Deep down Gremlin is a <span class="calibre9"><span class="calibre30">Pipe</span></span>-building language. The work of walking the graph is still being done on the Neo4j server, but Gremlin simplifies the effort of building queries that Neo4j can understand. </p><a></a><blockquote class="calibre76"><img src="images/00007.jpg" class="calibre92"/><span class="calibre9">        </span></blockquote><blockquote class="calibre42"><span class="calibre9"><span class="bold"><span class="calibre31">Eric says:</span></span></span></blockquote><blockquote class="calibre85"><span class="bold"><span class="calibre4">Cypher Language</span></span></blockquote><a></a><blockquote class="calibre83"><span class="calibre9"> Cypher is the other graph query language supported by Neo4j, based on pattern matching and a SQL-like syntax. The clauses feel familiar, making it easy to understand what’s going on. Particularly, the </span><span class="calibre9"><span class="calibre30">MATCH</span></span><span class="calibre9"> clause is very intuitive, resulting in ASCII art--like expressions. </span></blockquote><a></a><blockquote class="calibre86"><span class="calibre9"> At first I didn’t like Cypher’s verbosity, but over time as my eyes adjusted to reading its grammar, I’ve become a fan. </span></blockquote><a></a><blockquote class="calibre86"><span class="calibre9"> Look at this Cypher equivalent of our “similar wines” query: </span></blockquote><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​START ice_wine=node(0)​</span><span class="calibre9">​</span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​MATCH (ice_wine) -[:grape_type]-&gt; () &lt;-[:grape_type]- (similar)​</span><span class="calibre9">​</span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​RETURN similar​</span><span class="calibre9">​</span></blockquote></td></tr></table><a></a><blockquote class="calibre111"><span class="calibre9"> We’ve started by binding </span><span class="calibre9"><span class="calibre30">ice_wine</span></span><span class="calibre9"> to node 0. The </span><span class="calibre9"><span class="calibre30">MATCH</span></span><span class="calibre9"> clause uses identifiers within parentheses to indicate nodes and typed “arrows” like </span><span class="calibre9"><span class="calibre30">-[:grape_type]-&gt;</span></span><span class="calibre9"> for directional relationships. I actually like this construct, because it’s easy to visualize the node walk. </span></blockquote><a></a><blockquote class="calibre86"><span class="calibre9"> It can quickly get advanced, however. This is a more real-world style example—every bit as powerful and wordy as SQL. </span></blockquote><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​START ice_wine=node:wines(name=”Prancing Wolf Ice Wine 2007”)​</span><span class="calibre9">​</span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​MATCH ice_wine -[:grape_type]-&gt; wine_type &lt;-[:grape_type]- similar​</span><span class="calibre9">​</span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​WHERE wine_type =~ /(?i)riesl.*)/​</span><span class="calibre9">​</span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​RETURN wine_type.name, collect(similar) as wines, count(*) as wine_count​</span><span class="calibre9">​</span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​ORDER BY wine_count desc​</span><span class="calibre9">​</span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​LIMIT 10​</span><span class="calibre9">​</span></blockquote></td></tr></table><a></a><blockquote class="calibre111"><span class="calibre9"> While I chose to focus on Gremlin in the main chapter, the two languages are natural complements and happily coexist. In day-to-day work, you’ll find reasons to use either, depending on how you think about the problem at hand. </span></blockquote><a></a><p class="calibre43"><span class="calibre5"><span class="bold"><span class="calibre28">Pipeline vs. Vertex</span></span></span></p><a></a><p class="calibre29"> To grab a collection containing just one specific vertex, we can filter it from the list of all nodes. This is what we have been doing when we call, for example, <span class="calibre9"><span class="calibre30">g.V.filter{it.name==’reisling’}</span></span>. The <span class="calibre9"><span class="calibre30">V</span></span> property is the list of all nodes, from which we’re culling a sublist. But when we want the vertex itself, we need to call <span class="calibre9"><span class="calibre30">next</span></span>. This method retrieves the first vertex from the pipeline. It’s akin to the difference between an array of one element and the element itself. </p><a></a><p class="calibre12"> If you look at the class constructed by calling the filter’s <span class="calibre9"><span class="calibre30">class</span></span> property, notice it returns <span class="calibre9"><span class="calibre30">GremlinPipeline</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; g.V.filter{it.name=='Prancing Wolf Winery'}.class​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt;class com.tinkerpop.gremlin.pipes.GremlinPipeline​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Compare that to the class of the next node from the pipeline. It returns something else, the <span class="calibre9"><span class="calibre30">Neo4jVertex</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; g.V.filter{it.name=='Prancing Wolf Winery'}.next().class​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt;class com.tinkerpop.blueprints.pgm.impls.neo4j.Neo4jVertex​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Although the console conveniently lists the nodes retrieved from the pipeline, it remains a pipeline until you retrieve something from it. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Schemaless Social</span></span></span></p><a></a><p class="calibre29"> Creating a social aspect to the graph is as easy as adding more nodes. Suppose we want to add three people—two who know each other and one stranger, each with their own wine preferences. </p><a></a><p class="calibre12"> Alice has a bit of a sweet tooth and so is a big ice wine fan. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​alice = g.addVertex([name:'Alice'])​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ice_wine = g.V.filter{it.name=='Prancing Wolf Ice Wine 2007'}.next()​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​g.addEdge(alice, ice_wine, 'likes')​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Tom loves Kabinett and ice wine and trusts anything written by <span class="italic">Wine Expert Monthly</span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​tom = g.addVertex([name:'Tom'])​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​kabinett = g.V.filter{it.name=='Prancing Wolf Kabinett 2002'}.next()​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​g.addEdge(tom, kabinett, 'likes')​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​g.addEdge(tom, ice_wine, 'likes')​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​g.addEdge(tom, g.V.filter{it.name=='Wine Expert Monthly'}.next(), 'trusts')​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Patty is friends with both Tom and Alice but is new to wine and has yet to choose any favorites. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​patty = g.addVertex([name:'Patty'])​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​g.addEdge(patty, tom, 'friends')​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​g.addEdge(patty, alice, 'friends')​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Without changing any fundamental structure of our existing graph, we were able to superimpose behavior beyond our original intent. The new nodes are related, as visualized in the following: </p><p class="calibre12"><img src="images/00046.jpg" class="calibre112"/></p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Stepping Stones</span></span></span></p><a></a><p class="calibre29"> We’ve looked at a few core Gremlin <span class="italic">steps</span>, or Pipe-processing units. Gremlin provides many more. Let’s take a look at more of these building blocks that not only walk the graph but also transform objects, filter steps, and produce side effects like counting nodes grouped by criteria. </p><a></a><p class="calibre12"> We’ve seen <span class="calibre9"><span class="calibre30">inE</span></span>, <span class="calibre9"><span class="calibre30">outE</span></span>, <span class="calibre9"><span class="calibre30">inV</span></span>, and <span class="calibre9"><span class="calibre30">outV</span></span>, which are <span class="italic">transform steps</span> for retrieving the incoming and outgoing edges and vertices. Two other types are <span class="calibre9"><span class="calibre30">bothE</span></span> and <span class="calibre9"><span class="calibre30">bothV</span></span>, which just follow an edge, regardless of whether it is directed <span class="italic">in</span> or <span class="italic">out</span>. </p><a></a><p class="calibre12"> This retrieves both Alice and all of her friends. We’ll tack <span class="calibre9"><span class="calibre30">name</span></span> to the end to get each vertice’s <span class="calibre9"><span class="calibre30">name</span></span> property. Since we don’t care which direction the <span class="calibre9"><span class="calibre30">friend</span></span> edge goes, we’ll use <span class="calibre9"><span class="calibre30">bothE</span></span> and <span class="calibre9"><span class="calibre30">bothV</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​alice.bothE('friends').bothV.name​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; Alice​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; Patty​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If we don’t want Alice, the <span class="calibre9"><span class="calibre30">except</span></span> filter lets us pass in a list of nodes we don’t want, and it walks the rest. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​alice.bothE('friends').bothV.except([alice]).name​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; Patty​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The opposite of <span class="calibre9"><span class="calibre30">except</span></span> is <span class="calibre9"><span class="calibre30">retain</span></span>, which, as you may have guessed, walks only matching nodes. </p><a></a><p class="calibre12"> Another option is to instead filter the last vertex with a code block, where the current step is not equal to the <span class="calibre9"><span class="calibre30">alice</span></span> vertex. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​alice.bothE('friends').bothV.filter{!it.equals(alice)}.name​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> What if you wanted to know friends of Alice’s friends? You could just repeat the steps like so: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​alice.bothE('friends').bothV.except([alice]).​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​bothE('friends').bothV.except([alice])​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> In the same fashion, we could get friends of Alice’s friends’ friends by adding more <span class="calibre9"><span class="calibre30">bothE</span></span>/<span class="calibre9"><span class="calibre30">bothV</span></span>/<span class="calibre9"><span class="calibre30">except</span></span> calls to the chain. But that’s a lot of typing, and it’s not possible to write this for a variable number of steps in this manner. The <span class="calibre9"><span class="calibre30">loop</span></span> method does just that. It repeats some number of previous steps and continues while the given closure is still true. </p><a></a><p class="calibre12"> The following code will loop the previous three steps by counting periods back from the loop call. So, <span class="calibre9"><span class="calibre30">except</span></span> is one, <span class="calibre9"><span class="calibre30">bothV</span></span> is two, and <span class="calibre9"><span class="calibre30">bothE</span></span> is three. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​alice.bothE('friends').bothV.except([alice]).loop(3){​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  it.loops &lt;= 2​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}.name​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> After each time through the looped series of steps, <span class="calibre9"><span class="calibre30">loop</span></span> invokes the given in the closure—that is, the code between the <span class="calibre9"><span class="calibre30">{...}</span></span> brackets. In here, the <span class="calibre9"><span class="calibre30">it.loops</span></span> property keeps track of how many times the current loop has been executed. In our case, we check and return whether this number is less than or equal to 2, meaning the loop will execute two times and stop. In effect, the closure is very much like the clause for a <span class="calibre9"><span class="calibre30">while</span></span> loop in a typical programming language. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt;Tom​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt;Patty​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt;Patty​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The loop worked, correctly finding both Tom and Patty. But now we have two copies of Patty. That’s because one matches Patty as a friend of Alice, and the other matches because she is friends with Tom. So, now we need a way to filter out duplicate objects, which the <span class="calibre9"><span class="calibre30">dedup</span></span> (de-duplicate) filter provides. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​alice.bothE('friends').bothV.except([alice]).loop(3){​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  it.loops &lt;= 2​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}.dedup.name​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt;Tom​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt;Patty​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> To get more insight into the path taken to arrive at these values, you can follow the friend-&gt;friend path by using the <span class="calibre9"><span class="calibre30">paths</span></span> transform. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​alice.bothE('friends').bothV.except([alice]).loop(3){​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  it.loops &lt;= 2​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}.dedup.name.paths​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; [v[7], e[12][9-friends-&gt;7], v[9], e[11][9-friends-&gt;8], v[8], Tom]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; [v[7], e[12][9-friends-&gt;7], v[9], e[11][9-friends-&gt;8], v[9], Patty]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> All traversals you’ve done so far have been to walk forward through a graph. Sometimes you need to take two steps forward and two steps back. Starting with the Alice node, we walk out two steps and then back two, which returns us to the Alice node. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; alice.outE.inV.back(2).name​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; Alice​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The last commonly used step we’ll investigate is <span class="calibre9"><span class="calibre30">groupCount</span></span>, which walks through the nodes and counts duplicate values, capturing them in a map. </p><a></a><p class="calibre12"> Consider this example that collects all the <span class="calibre9"><span class="calibre30">name</span></span> properties of all vertices in the graph and counts how many of each there are: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; name_map = [:]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; g.V.name.groupCount( name_map )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; name_map​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; Prancing Wolf Ice Wine 2007=1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; Wine Expert Monthly=1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; riesling=1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; Prancing Wolf Winery=1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; Prancing Wolf Kabinett 2002=1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; Prancing Wolf Spatlese 2007=1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; Alice=1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; Tom=1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; Patty=1​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> In Groovy/Gremlin, a map is denoted by the nomenclature <span class="calibre9"><span class="calibre30">[:]</span></span> and is pretty much identical to the Ruby/JavaScript object literal <span class="calibre9"><span class="calibre30">{}</span></span>. Notice how all of the values are <span class="calibre9"><span class="calibre30">1</span></span>. This is exactly what we’d expect, since we haven’t repeated any names, and the <span class="calibre9"><span class="calibre30">V</span></span> collection has exactly one copy of each node in our graph. </p><a></a><p class="calibre12"> Next, let’s count up the number of wines liked by each person in our system. We can get all of the liked vertices and count up the numbers per name. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; wines_count = [:]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; g.V.outE('likes').outV.name.groupCount( wines_count )​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; wines_count​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; Alice=1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; Tom=2​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> As we should expect, Alice liked one wine, and Tom liked two. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Getting Groovy</span></span></p><a></a><p class="calibre37"> Besides the Gremlin steps, we also get the wide array of Groovy language constructs and methods. Groovy has a map function (a la mapreduce) named <span class="calibre9"><span class="calibre30">collect</span></span> and a reduce function named <span class="calibre9"><span class="calibre30">inject</span></span>. Using these, we can preform mapreduce-like queries. </p><a></a><p class="calibre12"> Consider the case where we want to count how many wines have not yet been rated. We can do this by first mapping out a list of true/false values indicating whether each wine has been rated. Then, we can run that list through a reducer to count up all the trues and falses. The mapping part uses <span class="calibre9"><span class="calibre30">collect</span></span> and looks like this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​rated_list = g.V.in('grape_type').collect{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  !it.inE('reported_on').toList().isEmpty()​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> In the previous code, the expression <span class="calibre9"><span class="calibre30">g.V.in(’grape_type’)</span></span> returns all the nodes that have an incoming <span class="calibre9"><span class="calibre30">grape_type</span></span> relationship. Only wines will have this type of edge, so we have our list of all wines in the system. Next, in the <span class="calibre9"><span class="calibre30">collect</span></span>closure, we determine whether the wine in question has any incoming <span class="calibre9"><span class="calibre30">reported_on</span></span> edges. The <span class="calibre9"><span class="calibre30">toList</span></span> call forces the pipeline to become a true list, which we can then test for emptiness. The <span class="calibre9"><span class="calibre30">rated_list</span></span> produced by this code will be a list of true and false values. </p><a></a><p class="calibre12"> To count how many wines have not been rated, we can run that list through a reducer using the <span class="calibre9"><span class="calibre30">inject</span></span> method. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​rated_list.inject(0){ count, is_rated -&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  if (is_rated) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    count​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  } else {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    count + 1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> In Groovy, the arrow operator (<span class="calibre9"><span class="calibre30">-&gt;</span></span>) separates the input arguments for a closure from the body of the closure. In our reducer, we need to keep track of the accumulated count and process whether the current wine has been rated or not, which is the reason for <span class="calibre9"><span class="calibre30">count</span></span> and <span class="calibre9"><span class="calibre30">is_rated</span></span>. The <span class="calibre9"><span class="calibre30">0</span></span> part of <span class="calibre9"><span class="calibre30">inject(0)</span></span> initialized <span class="calibre9"><span class="calibre30">count</span></span> to 0 before the first invocation. Then, within the body of the closure function, we either return the current count if the wine has already been rated or return that value plus 1 if it hasn’t been rated. The final output will be the number of false values in the list (that is, the count of unrated wines). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; 2​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> So, it turns out that two of our wines are as yet unrated. </p><a></a><p class="calibre12"> With all these tools available, you can craft many powerful combinations of graph traversals and transformations. Suppose we want to find all of the pairs of friends in our graph. To do that, first we need to find all edges with a <span class="calibre9"><span class="calibre30">friends</span></span> type and then output the names of both people who share that edge by using the <span class="calibre9"><span class="calibre30">transform</span></span> operation. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​g.V.outE('friends').transform{[it.outV.name.next(), it.inV.name.next()]}​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; [Patty, Tom]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; [Patty, Alice]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> In the previous code, the return value of the <span class="calibre9"><span class="calibre30">transform</span></span> closure is an array literal (<span class="calibre9"><span class="calibre30">[...]</span></span>) with two elements: the output and input vertices to the <span class="calibre9"><span class="calibre30">friend</span></span> edge. </p><a></a><p class="calibre12"> To find all people and the wines they like, we transform our output of people (identified as vertices with friends) into a list with two elements: the name of the person and a list of wines they like. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​g.V.both('friends').dedup.transform{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  [ it.name, it.out('likes').name.toList() ]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; [Alice, [Prancing Wolf Ice Wine 2007]]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; [Patty, []]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; [Tom, [Prancing Wolf Ice Wine 2007, Prancing Wolf Kabinett 2002]]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Gremlin definitely takes a little getting used to, especially if you haven’t done much Groovy programming before. Once you get the hang of it, you’ll find it’s an expressive and powerful way to perform queries against Neo4j. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Domain-Specific Steps</span></span></span></p><a></a><p class="calibre29"> Graph traversal is nice, but businesses and organizations tend to converse in domain-specific languages. For example, we wouldn’t normally ask “What is the vertex with the incoming edge of grape_type sharing the outgoing edge of this wine’s vertex?” but rather “What varietal is this wine?” </p><a></a><p class="calibre12"> Gremlin is already a language specific to the domain of querying graph databases, but what about making the language even more specific? Gremlin lets us do this by creating new steps that are semantically meaningful to the data stored in the graph. </p><a></a><p class="calibre12"> Let’s start by creating a new step named <span class="calibre9"><span class="calibre30">varietal</span></span> that seeks to answer the question posed before. When <span class="calibre9"><span class="calibre30">varietal</span></span> is called on a vertex, it will look for outgoing edges of type <span class="calibre9"><span class="calibre30">grape_type</span></span> and step to those related vertices. </p><a></a><p class="calibre12"> We’re getting into a bit of Groovy-foo here, so we’ll first look at our code to create the step and then describe it line by line. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/neo4j/varietal.groovy"><span class="calibre41"><span class="calibre13"><span class="underline">neo4j/varietal.groovy</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Gremlin.defineStep( </span><span class="calibre9"><span class="italic"><span class="calibre38">'varietal'</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  [Vertex, </span><span class="calibre9"><span class="bold"><span class="calibre44">Pipe</span></span></span><span class="calibre9">],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  {_().out(</span><span class="calibre9"><span class="italic"><span class="calibre38">'grape_type'</span></span></span><span class="calibre9">).dedup}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> First we tell the Gremlin engine we’re adding a new step called <span class="calibre9"><span class="calibre30">varietal</span></span>. The second line tells Gremlin that this new step should attach to both <span class="calibre9"><span class="calibre30">Vertex</span></span> and <span class="calibre9"><span class="calibre30">Pipe</span></span> classes (when in double, just use both). The last line is where the magic happens. Effectively, this creates a closure that contains the code this step should execute. The underscore and parentheses represent the current pipeline object. From this object, we walk to any neighbor nodes related by a <span class="calibre9"><span class="calibre30">grape_type</span></span> edge—that is, the varietal node. We end with <span class="calibre9"><span class="calibre30">dedup</span></span> to remove any possible duplicates. </p><a></a><p class="calibre12"> Calling our new step is just like any other step. For example, the following gets the name of the ice wine’s varietal: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​g.V.filter{it.name=='Prancing Wolf Ice Wine 2007'}.varietal.name​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; riesling​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Let’s try another one. This time we’re making a step for a commonly requested action: get all friends’ favorite wines. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/neo4j/friendsuggest.groovy"><span class="calibre41"><span class="calibre13"><span class="underline">neo4j/friendsuggest.groovy</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Gremlin.defineStep( </span><span class="calibre9"><span class="italic"><span class="calibre38">'friendsuggest'</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  [Vertex, </span><span class="calibre9"><span class="bold"><span class="calibre44">Pipe</span></span></span><span class="calibre9">],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    _().sideEffect{start = it}.both(</span><span class="calibre9"><span class="italic"><span class="calibre38">'friends'</span></span></span><span class="calibre9">).​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    except([start]).out(</span><span class="calibre9"><span class="italic"><span class="calibre38">'likes'</span></span></span><span class="calibre9">).dedup​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Just like last time, we give Gremlin our new <span class="calibre9"><span class="calibre30">friendsuggest</span></span> step name and bind it to <span class="calibre9"><span class="calibre30">Vertex</span></span> and <span class="calibre9"><span class="calibre30">Pipe</span></span>. This time, our code will filter out the current person. We do that by setting the current vertex/pipe to a variable (start) by using the <span class="calibre9"><span class="calibre30">sideEffect{start = it}</span></span> function. Then we get all <span class="calibre9"><span class="calibre30">friends</span></span> nodes, except for the current person (we don’t want to list Alice as her own friend). </p><a></a><p class="calibre12"> Now we’re cooking with pipes! We can call this new step as we normally would. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​g.V.filter{it.name=='Patty'}.friendsuggest.name​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; Prancing Wolf Ice Wine 2007​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; Prancing Wolf Kabinett 2002​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Since <span class="calibre9"><span class="calibre30">varietal</span></span> and <span class="calibre9"><span class="calibre30">friendsuggest</span></span> are just normal <span class="calibre9"><span class="calibre30">Pipe</span></span>-building steps, you can chain them together to make more interesting queries. The following finds the varietals that Patty’s friends like best: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​g.V.filter{it.name=='Patty'}.friendsuggest.varietal.name​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; riesling​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Using Groovy metaprogramming to create new steps is a powerful force for crafting domain-specific languages. But like Gremlin itself, the practice can take some getting used to. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Update, Delete, Done</span></span></span></p><a></a><p class="calibre29"> You’ve inserted and stepped through a graph, but what about updating and deleting data? It’s easy enough, once you find the vertex or edge you want to alter. Let’s add a weight to how much Alice likes the Prancing Wolf Ice Wine 2007. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; e=g.V.filter{it.name=='Alice'}.outE('likes').next()​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; e.weight = 95​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; e.save​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We can remove the value just as easily. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; e.removeProperty('weight')​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; e.save​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Before we call it a day and go into some homework, we should cover how to clean up our database. </p><a></a><p class="calibre12"><span class="italic">Don’t run these commands until you’ve finished the homework for the day!</span>
</p><a></a><p class="calibre12"> The graph object has functions to remove vertices and edges, <span class="calibre9"><span class="calibre30">removeVertex</span></span> and <span class="calibre9"><span class="calibre30">removeEdge</span></span>, respectively. We could destroy our graph by removing all vertices and edges. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; g.V.each{ g.removeVertex(it) }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; g.E.each{ g.removeEdge(it) }​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You can validate they are gone by calling <span class="calibre9"><span class="calibre30">g.V</span></span> and <span class="calibre9"><span class="calibre30">g.E</span></span>. Or you can achieve the same thing with the ridiculously dangerous <span class="calibre9"><span class="calibre30">clear</span></span> method. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; g.clear()​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If you’re running your own Gremlin instance (outside of the web interface), it’s a good idea to cleanly shut down the graph connection with the <span class="calibre9"><span class="calibre30">shutdown</span></span> method. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; g.shutdown()​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If you don’t, it may corrupt the database. But usually it will just yell at you the next time you connect to the graph. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Day 1 Wrap-Up</span></span></span></p><a></a><p class="calibre29"> Today we got to peek at the graph database Neo4j—and what a different beast it is. Although we didn’t cover specific design patterns, our brains were buzzing with possibilities when we first began working with Neo4j. If you can draw it on a whiteboard, you can store it in a graph database. </p><p class="calibre12"><span class="bold"><span class="calibre28">Day 1 Homework</span></span></p><p class="calibre37"><span class="bold">Find</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Bookmark the Neo4j wiki.</p></li><li value="2" class="calibre36"><p class="calibre22">Bookmark the Gremlin steps from the wiki or API.</p></li><li value="3" class="calibre36"><p class="calibre22">Find two other Neo4j shells (such as the Cypher shell in the admin console).</p></li></ol><p class="calibre12"><span class="bold">Do</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Query all node names with another shell (such as the Cypher query language).</p></li><li value="2" class="calibre36"><p class="calibre22">Delete all the nodes and edges in your database.</p></li><li value="3" class="calibre36"><p class="calibre22">Create a new graph that represents your family.</p></li></ol><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos1539544" class="calibre1"><p class="calibre24" id="filepos1539549"><span class="calibre25"><span class="bold"><span class="calibre26">7.3 Day 2: REST, Indexes, and Algorithms</span></span></span></p><a></a><p class="calibre27"> Today we’ll start with Neo4j’s REST interface. We’ll create nodes and relationships using REST and then use REST to index and execute a full-text search. We’ll then look at a plug-in that lets us execute Gremlin queries on the server through REST, freeing our code from the confines of the Gremlin console—or even running Java at all in our application server or clients. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Taking a REST</span></span></span></p><a></a><p class="calibre29"> Just like Riak, HBase, Mongo, and CouchDB, Neo4j ships with a REST interface. One of the reasons all of these databases support REST is because it allows language-agnostic interactions in a standard connection interface. We can connect to Neo4j—which requires Java to work—from a separate machine with no trace of Java whatsoever. And with the Gremlin plug-in, we’ll see how to gain the power of its terse query syntax over REST. </p><a></a><p class="calibre12"> First you might want to check that the REST server is running by issuing a <span class="calibre9"><span class="calibre30">GET</span></span> against the base URL, which retrieves the root node. It runs on the same port as the web admin tool you used yesterday, at the <span class="calibre9"><span class="calibre30">/db/data/</span></span> path. We’ll use our trusty friend <span class="calibre9"><span class="calibre30">curl</span></span> to issue the REST commands. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:7474/db/data/</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "relationship_index" : "http://localhost:7474/db/data/index/relationship",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "node" : "http://localhost:7474/db/data/node",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "relationship_types" : "http://localhost:7474/db/data/relationship/types",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "extensions_info" : "http://localhost:7474/db/data/ext",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "node_index" : "http://localhost:7474/db/data/index/node",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "extensions" : {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> It will return a nice JSON object describing the URLs of other commands, like node actions or indices. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Creating Nodes and Relationships Using REST</span></span></p><a></a><p class="calibre37"> It’s as easy to create nodes and relationships in Neo4j REST as in CouchDB or Riak. Creating a node is a <span class="calibre9"><span class="calibre30">POST</span></span> to the <span class="calibre9"><span class="calibre30">/db/data/node</span></span> path with JSON data. As matter of convention, it pays to give each node a <span class="calibre9"><span class="calibre30">name</span></span> property. This makes viewing any node’s information easy: just call <span class="calibre9"><span class="calibre30">name</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -i -X POST http://localhost:7474/db/data/node \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">-H "Content-Type: application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">-d '{"name": "P.G. Wodehouse", "genre": "British Humour"}'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> When posted, you’ll get the node path in the header and a body of metadata about the node (both are truncated here for brevity). All of this data is retrievable by calling <span class="calibre9"><span class="calibre30">GET</span></span> on the given header <span class="calibre9"><span class="calibre30">Location</span></span> value (or the <span class="calibre9"><span class="calibre30">self</span></span> property in the metadata). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​HTTP/1.1 201 Created​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Location: http://localhost:7474/db/data/node/9​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Content-Type: application/json​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "outgoing_relationships" :​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "http://localhost:7474/db/data/node/9/relationships/out",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "data" : {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "genre" : "British Humour",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "name" : "P.G. Wodehouse"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "traverse" : "http://localhost:7474/db/data/node/9/traverse/{returnType}",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "all_typed_relationships" :​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "http://localhost:7474/db/data/node/9/relationships/all/{-list|&amp;|types}",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "property" : "http://localhost:7474/db/data/node/9/properties/{key}",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "self" : "http://localhost:7474/db/data/node/9",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "properties" : "http://localhost:7474/db/data/node/9/properties",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "outgoing_typed_relationships" :​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "http://localhost:7474/db/data/node/9/relationships/out/{-list|&amp;|types}",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "incoming_relationships" :​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "http://localhost:7474/db/data/node/9/relationships/in",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "extensions" : {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "create_relationship" : "http://localhost:7474/db/data/node/9/relationships",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "paged_traverse" :​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "http://localhost:7474/db/.../{returnType}{?pageSize,leaseTime}",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "all_relationships" : "http://localhost:7474/db/data/node/9/relationships/all",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "incoming_typed_relationships" :​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "http://localhost:7474/db/data/node/9/relationships/in/{-list|&amp;|types}"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If you just want the node properties (not the metadata), you can <span class="calibre9"><span class="calibre30">GET</span></span> that by appending <span class="calibre9"><span class="calibre30">/properties</span></span> to the node URL or even an individual property by further appending the property name. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:7474/db/data/node/9/properties/genre</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​"British Humour"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> One node doesn’t do us much good, so go ahead and create another one with the properties <span class="calibre9"><span class="calibre30">["name" : "Jeeves Takes Charge", "style" : "short story"]</span></span>. </p><a></a><p class="calibre12"> Since P.G. Wodehouse wrote the short story “Jeeves Takes Charge,” we can make a relationship between them. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -i -X POST http://localhost:7474/db/data/node/9/relationships \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">-H "Content-Type: application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">-d '{"to": "http://localhost:7474/db/data/node/10", "type": "WROTE",</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "data": {"published": "November 28, 1916"}}'​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> A nice thing about the REST interface is that it actually reported on how to create a relationship early in the body metadata’s <span class="calibre9"><span class="calibre30">create_relationship</span></span> property. In this way, the REST interfaces tend to be mutually discoverable. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Finding Your Path</span></span></p><a></a><p class="calibre37"> Through the REST interface, you can find the path between two nodes by posting the request data to the starting node’s <span class="calibre9"><span class="calibre30">/paths</span></span> URL. The <span class="calibre9"><span class="calibre30">POST</span></span> request data must be a JSON string denoting the node you want the path to, the type of relationships you want to follow, and the path-finding algorithm to use. </p><a></a><p class="calibre12"> For example, here we’re looking for a path following relationships of the type <span class="calibre9"><span class="calibre30">WROTE</span></span> from node 1 using the <span class="calibre9"><span class="calibre30">shortestPath</span></span> algorithm and capping out at a depth of 10. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -X POST http://localhost:7474/db/data/node/9/paths \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">-H "Content-Type: application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">-d '{"to":"http://localhost:7474/db/data/node/10",</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "relationships": {"type" : "WROTE"},​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "algorithm":"shortestPath", "max_depth":10}'​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[ {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "start" : "http://localhost:7474/db/data/node/9",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "nodes" : [​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "http://localhost:7474/db/data/node/9",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    "http://localhost:7474/db/data/node/10"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  ],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "length" : 1,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "relationships" : [ "http://localhost:7474/db/data/relationship/14" ],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "end" : "http://localhost:7474/db/data/node/10"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​} ]​</span><span class="calibre9">​</span></p></td></tr></table><p class="calibre45" id="filepos1563540"> The other path algorithm choices are <span class="calibre9"><span class="calibre30">allPaths</span></span>, <span class="calibre9"><span class="calibre30">allSimplePaths</span></span>, and <span class="calibre9"><span class="calibre30">dijkstra</span></span>. Details on these algorithms can be found in the online documentation,<a href="#filepos1666371"><span class="calibre13"><span class="underline">[47]</span></span></a> but covering them in detail is outside the scope of this book. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Indexing</span></span></p><a></a><p class="calibre37"> Like other databases we’ve seen, Neo4j supports fast data lookups by constructing indexes. There is a twist, though. Unlike other database indexes where you perform queries in much the same way as without one, Neo4j indexes have a different path. This is because the indexing service is actually a separate service. </p><a></a><p class="calibre12"> The simplest index is the key-value or hash style. You key the index by some node data, and the value is a REST URL, which points to the node in the graph. You can have as many indexes as you like, so we’ll name this one “authors.” The end of the URL will contain the author name we want to index and pass in node 1 as the value (or whatever your Wodehouse node was). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -X POST http://localhost:7474/db/data/index/node/authors \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">-H "Content-Type: application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">-d '{ "uri" : "http://localhost:7474/db/data/node/9",</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​"key" : "name", "value" : "P.G.+Wodehouse"}'​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Retrieving the node is simply a call to the index, which you’ll notice doesn’t return the URL we set but instead the actual node data. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:7474/db/data/index/node/authors/name/P.G.+Wodehouse</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Besides key-value, Neo4j provides a full-text search inverted index, so you can perform queries like this: “Give me all books that have names beginning with ’Jeeves.’” To build this index, we need to build it against the entire dataset, rather than our one-offs earlier. Like Riak, Neo4j incorporates Lucene to build our inverted index. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -X POST http://localhost:7474/db/data/index/node \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">-H "Content-Type: application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">-d '{"name":"fulltext", "config":{"type":"fulltext","provider":"lucene"}}'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The <span class="calibre9"><span class="calibre30">POST</span></span> will return a JSON response containing information about the newly added index. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "template" : "http://localhost:7474/db/data/index/node/fulltext/{key}/{value}",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "provider" : "lucene",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "type" : "fulltext"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Now if we add Wodehouse to the full-text index, we get this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​curl -X POST http://localhost:7474/db/data/index/node/fulltext \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-H "Content-Type: application/json" \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-d '{ "uri" : "http://localhost:7474/db/data/node/9",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​"key" : "name", "value" : "P.G.+Wodehouse"}'​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Then a search is as easy as a Lucene syntax query on the index URL. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl http://localhost:7474/db/data/index/node/fulltext?query=name:P*</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Indexes can also be built on edges like earlier; just replace the instances of <span class="calibre9"><span class="italic"><span class="calibre38">node</span></span></span> in the URLs with <span class="calibre9"><span class="italic"><span class="calibre38">relationship</span></span></span>, for example <span class="calibre9"><span class="calibre30">http://localhost:7474/db/data/index/relationship/published/date/1916-11-28</span></span>. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">REST and Gremlin</span></span></p><p class="calibre37" id="filepos1572436"> We spent much of Day 1 using Gremlin and the first half of today using the REST interface. If you wondered which you should use, fear not. The Neo4j REST interface has a Gremlin plug-in (which is installed by default in the version of Neo4j we’re using).<a href="#filepos1666371"><span class="calibre13"><span class="underline">[48]</span></span></a> You can send through REST any commands you could in the Gremlin console. This allows you the power and flexibility of both tools in production. This is a great combination, since Gremlin is better geared toward powerful queries, where REST is geared toward deployment and language flexibility. </p><a></a><p class="calibre12"> The following code will return all vertex names. You only need to send the data to the plug-in URL as a JSON string value, under the field <span class="calibre9"><span class="calibre30">script</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">curl -X POST \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">http://localhost:7474/db/data/ext/GremlinPlugin/graphdb/execute_script \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">-H "content-type:application/json" \</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">-d '{"script":"g.V.name"}'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[ "P.G. Wodehouse", "Jeeves Takes Charge" ]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Although code samples from here on out will use Gremlin, bear in mind that you could instead choose to use REST. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Big Data</span></span></span></p><a></a><p class="calibre29"> Up until now we’ve dealt with very small data sets, so now it’s time to see what Neo4j can do with some big data. </p><p class="calibre12" id="filepos1575575"> Let’s explore some movie data by grabbing a dataset from Freebase.com. We’ll be using the “performance” tab-separated set.<a href="#filepos1666371"><span class="calibre13"><span class="underline">[49]</span></span></a> Download the file and use the following script, which iterates through each line and creates a relationship between new or existing nodes (matches are found by name in the index). </p><a></a><p class="calibre12"> Be warned, this dataset contains a vast amount of movie information, from blockbusters to foreign films to, well, adult entertainment. You will need the <span class="calibre9"><span class="calibre30">json</span></span> and <span class="calibre9"><span class="calibre30">faraday</span></span> Ruby gems installed to run this script. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/neo4j/importer.rb"><span class="calibre41"><span class="calibre13"><span class="underline">neo4j/importer.rb</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​REST_URL = </span><span class="calibre9"><span class="italic"><span class="calibre38">'http://localhost:7474/'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​HEADER = { </span><span class="calibre9"><span class="italic"><span class="calibre38">'Content-Type'</span></span></span><span class="calibre9"> =&gt; </span><span class="calibre9"><span class="italic"><span class="calibre38">'application/json'</span></span></span><span class="calibre9"> }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre38">%w{rubygems json cgi faraday}</span></span></span><span class="calibre9">.each{|r| require r}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre46"># make a connection to the Neo4j REST server</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​conn = Faraday.new(:url =&gt; REST_URL) </span><span class="calibre9"><span class="bold"><span class="calibre44">do</span></span></span><span class="calibre9"> |builder|​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  builder.adapter :net_http​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre46"># method to get existing node from the index, or create one</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">def</span></span></span><span class="calibre9"> get_or_create_node(conn, index, value)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="italic"><span class="calibre46"># look for node in the index</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  r = conn.get(</span><span class="calibre9"><span class="italic"><span class="calibre38">"/db/data/index/node/</span></span></span><span class="calibre9">#{index}</span><span class="calibre9"><span class="italic"><span class="calibre38">/name/</span></span></span><span class="calibre9">#{CGI.escape(value)}</span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  node = (JSON.parse(r.body).first || {})[</span><span class="calibre9"><span class="italic"><span class="calibre38">'self'</span></span></span><span class="calibre9">] </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> r.status == 200​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">unless</span></span></span><span class="calibre9"> node​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre46"># no indexed node found, so create a new one</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    r = conn.post(</span><span class="calibre9"><span class="italic"><span class="calibre38">"/db/data/node"</span></span></span><span class="calibre9">, JSON.unparse({</span><span class="calibre9"><span class="italic"><span class="calibre38">"name"</span></span></span><span class="calibre9"> =&gt; value}), HEADER)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    node = (JSON.parse(r.body) || {})[</span><span class="calibre9"><span class="italic"><span class="calibre38">'self'</span></span></span><span class="calibre9">] </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> [200, 201].include? r.status​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre46"># add new node to an index</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    node_data = </span><span class="calibre9"><span class="italic"><span class="calibre38">"{</span></span></span><span class="calibre9">\"</span><span class="calibre9"><span class="italic"><span class="calibre38">uri</span></span></span><span class="calibre9">\"</span><span class="calibre9"><span class="italic"><span class="calibre38"> : </span></span></span><span class="calibre9">\"#{node}\"</span><span class="calibre9"><span class="italic"><span class="calibre38">, </span></span></span><span class="calibre9">\"</span><span class="calibre9"><span class="italic"><span class="calibre38">key</span></span></span><span class="calibre9">\"</span><span class="calibre9"><span class="italic"><span class="calibre38"> : </span></span></span><span class="calibre9">\"</span><span class="calibre9"><span class="italic"><span class="calibre38">name</span></span></span><span class="calibre9">\"</span><span class="calibre9"><span class="italic"><span class="calibre38">,</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​\"</span><span class="calibre9"><span class="italic"><span class="calibre38">value</span></span></span><span class="calibre9">\"</span><span class="calibre9"><span class="italic"><span class="calibre38"> : </span></span></span><span class="calibre9">\"#{CGI.escape(value)}\"</span><span class="calibre9"><span class="italic"><span class="calibre38">}"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    conn.post(</span><span class="calibre9"><span class="italic"><span class="calibre38">"/db/data/index/node/</span></span></span><span class="calibre9">#{index}</span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">, node_data, HEADER)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  node​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​puts </span><span class="calibre9"><span class="italic"><span class="calibre38">"begin processing..."</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​count = 0​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​File.open(ARGV[0]).each </span><span class="calibre9"><span class="bold"><span class="calibre44">do</span></span></span><span class="calibre9"> |line|​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  _, _, actor, movie = line.split(</span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">\t</span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">next</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> actor.empty? || movie.empty?​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="italic"><span class="calibre46"># build the actor and movie nodes</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  actor_node = get_or_create_node(conn, </span><span class="calibre9"><span class="italic"><span class="calibre38">'actors'</span></span></span><span class="calibre9">, actor)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  movie_node = get_or_create_node(conn, </span><span class="calibre9"><span class="italic"><span class="calibre38">'movies'</span></span></span><span class="calibre9">, movie)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="italic"><span class="calibre46"># create relationship between actor and movie</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  conn.post(</span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">#{actor_node}</span><span class="calibre9"><span class="italic"><span class="calibre38">/relationships"</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    JSON.unparse({ :to =&gt; movie_node, :type =&gt; </span><span class="calibre9"><span class="italic"><span class="calibre38">'ACTED_IN'</span></span></span><span class="calibre9"> }), HEADER)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  puts </span><span class="calibre9"><span class="italic"><span class="calibre38">"  </span></span></span><span class="calibre9">#{count}</span><span class="calibre9"><span class="italic"><span class="calibre38"> relationships loaded"</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> (count += 1) % 100 == 0​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​puts </span><span class="calibre9"><span class="italic"><span class="calibre38">"done!"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> With everything set up, just run the script and point it to the downloaded <span class="calibre9"><span class="calibre30">performance.tsv</span></span> file. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">ruby importer.rb performance.tsv</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This can take hours to run the whole dataset, but you can stop the process at any time for a partial movie/actor list. If you’re running Ruby 1.9, you might have better luck replacing the line <span class="calibre9"><span class="calibre30">builder.adapter :net_http</span></span> with <span class="calibre9"><span class="calibre30">builder.adapter :em_synchrony</span></span>, which creates a nonblocking connection. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Fancy Algorithms</span></span></span></p><a></a><p class="calibre29"> With our big movie dataset, it’s time to hang up our REST interface for a while and jump back into Gremlin. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Of Course, Kevin Bacon</span></span></p><a></a><p class="calibre37"> Let’s have a little fun implementing one of the more famous graph algorithms in existence: the Kevin Bacon algorithm. This algorithm is based on a game to find the shortest distance between any actor and Kevin Bacon through commonly acted movies. For instance, Alec Guinness acted in <span class="italic">Kafka</span> with Theresa Russell, who was in <span class="italic">Wild Things</span> with Kevin Bacon. </p><a></a><p class="calibre12"> Before continuing, fire up your Gremlin console and start up the graph. Then we’ll create the <span class="calibre9"><span class="calibre30">costars</span></span> custom step with the following code. This is similar to the <span class="calibre9"><span class="calibre30">friendsuggest</span></span> from yesterday. It finds the costars of an actor node (actors who share an edge with the initial actor’s movies). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/neo4j/costars.groovy"><span class="calibre41"><span class="calibre13"><span class="underline">neo4j/costars.groovy</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Gremlin.defineStep( </span><span class="calibre9"><span class="italic"><span class="calibre38">'costars'</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  [Vertex, </span><span class="calibre9"><span class="bold"><span class="calibre44">Pipe</span></span></span><span class="calibre9">],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    _().sideEffect{start = it}.outE(</span><span class="calibre9"><span class="italic"><span class="calibre38">'ACTED_IN'</span></span></span><span class="calibre9">).​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    inV.inE(</span><span class="calibre9"><span class="italic"><span class="calibre38">'ACTED_IN'</span></span></span><span class="calibre9">).outV.filter{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      !start.equals(it)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }.dedup​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> In Neo4j you don’t so much “query” for a set of values as you “walk” the graph. The nice thing about this concept is that generally the first node walked to will be the closest to your starting node (in terms of raw edge/node distance, not of weighted distance). Let’s begin by finding our starting and ending nodes. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; bacon = g.V.filter{it.name=='Kevin Bacon'}.next()​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; elvis = g.V.filter{it.name=='Elvis Presley'}.next()​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We start by finding an actor’s costars’ costars’ costars…the classic stopping distance is six degrees, but practically we can stop at four (if you don’t find a match, you can try again). Here we can loop through the graph four times, which finds all actors with “four degrees of separation.” We’ll use the costars step we just created. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​elvis.costars.loop(1){it.loops &lt; 4}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Only vertices that end with Bacon are to be retained. All others are ignored. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​elvis.costars.loop(1){​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  it.loops &lt; 4​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}.filter{it.equals(bacon)}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Just to ensure we don’t want to continue looping back to the Kevin Bacon node for a second pass, hitting the bacon node short-circuits the loop. Or, in other words, loop as long as the loop hasn’t occurred four times and we are not on the bacon node. Then we can output the paths taken to arrive at each bacon node. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​elvis.costars.loop(1){​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  it.loops &lt; 4 &amp; !it.object.equals(bacon)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}.filter{it.equals(bacon)}.paths​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> With that, we only need to pop the first path off the top of the list of possible paths—the shortest path will be arrived at first. The <span class="calibre9"><span class="calibre30">&gt;&gt;</span></span> nomenclature just pops the first item off the list of all nodes. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​(elvis.costars.loop(1){​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  it.loops &lt; 4 &amp; !it.object.equals(bacon)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}.filter{it.equals(bacon)}.paths &gt;&gt; 1)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Finally, we get the name of each vertex and filter out any null edge data using the Groovy grep command. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​(elvis.costars.loop(1){​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  it.loops &lt; 4 &amp; !it.object.equals(bacon)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}.filter{it.equals(bacon)}.paths &gt;&gt; 1).name.grep{it}​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt;Elvis Presley​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt;Double Trouble​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt;Roddy McDowall​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt;The Big Picture​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt;Kevin Bacon​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We didn’t know who Roddy McDowall was, but that’s the beauty of our graph database. We didn’t have to know to get a good answer. Feel free to sharpen your Groovy-foo if you want the output to be fancier than our simple list, but the data is all there. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Random Walk</span></span></p><a></a><p class="calibre37"> When looking for good sample from a large data set, a useful trick is the “random walk.” You start with a random number generator. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​rand = new Random()​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Then you filter out some target ratio of the total. If we want to return only about one-third of Kevin Bacon’s ~60 movies, we could filter out any random number less than 0.33. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​bacon.outE.filter{rand.nextDouble() &lt;= 0.33}.inV.name​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The count should be somewhere around twenty random titles from the Bacon canon. </p><a></a><p class="calibre12"> Taking a second-degree step away from Kevin Bacon, his costars’ costars, creates quite a list (more than 300,000 in our data set). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​bacon.outE.inV.inE.outV.loop(4){​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  it.loops &lt; 3​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}.count()​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; 316198​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> But if you need only about 1 percent of that list, add a filter. Also note the filter is itself a step, so you’ll need to add one more to your loop number. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​bacon.outE{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  rand.nextDouble() &lt;= 0.01​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}.inV.inE.outV.loop(5){​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  it.loops &lt; 3​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}.name​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We received Elijah Wood, who we can run through our Bacon path algorithm and reasonably expect two steps (Elijah Wood acted in <span class="italic">Deep Impact</span> with Ron Eldard, who was in <span class="italic">Sleepers</span> with Kevin Bacon). </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Centrality Park</span></span></p><a></a><p class="calibre37"> Centrality is a measure of individual nodes against a full graph. For example, if we wanted to measure how important each node in a network is based on its distance to all the other nodes, that would require a centrality algorithm. </p><a></a><p class="calibre12"> The most famous centrality algorithm is probably Google’s PageRank, but there are several styles. We’ll execute a simple version called <span class="italic">eigenvector centrality</span>, which just counts the number of in or out edges related to a node. We’re going to give each actor a number related to how many roles they have played. </p><a></a><p class="calibre12"> We need a map for <span class="calibre9"><span class="calibre30">groupCount</span></span> to populate and a <span class="calibre9"><span class="calibre30">count</span></span> to set a maximum number or loops. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​role_count = [:]; count = 0​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​g.V.in.groupCount(role_count).loop(2){ count++ &lt; 1000 }; ''​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The <span class="calibre9"><span class="calibre30">role_count</span></span> map will be keyed by vertices, with values of the count of edges the vertex has. The easiest way to read the output is by sorting the map. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​role_count.sort{a,b -&gt; a.value &lt;=&gt; b.value}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The last value will be the actor with the greatest number of acting credits. In our dataset that honor belonged to legendary voice actor Mel Blanc with 424 credits (which you can list by running <span class="calibre9"><span class="calibre30">g.V.filter{it.name==’Mel Blanc’}.out.name</span></span>). </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">External Algorithms</span></span></p><a></a><p class="calibre37"> Writing your own algorithms is fine, but most of this work has already been done for you. The Java Universal Network/Graph (JUNG) Framework is a collection of common graph algorithms and other tools for modeling and visualizing graphs. Thanks to the Gremlin/Blueprint project, it’s easy to access JUNG’s algorithms, such as PageRank, HITS, Voltage, centrality algorithms, and graph-as-a-matrix tools. </p><p class="calibre12" id="filepos1614212"> To use JUNG, we need to wrap the Neo4j Graph into a new JUNG Graph.<a href="#filepos1666371"><span class="calibre13"><span class="underline">[50]</span></span></a> To access the JUNG graph, we need to do one of two options: download and install all of the Blueprint and JUNG jars into your Neo4j server libs directory and restart the server, or download the prepackaged Gremlin console. We recommend the latter option for this project, since it will save you the hassle of hunting down several Java archive files (jars). </p><a></a><p class="calibre12"> Assuming you’ve downloaded the gremlin console, shut down your neo4j server and start up Gremlin. You’ll have to create the Neo4jGraph object and point it to your installation’s <span class="calibre9"><span class="calibre30">data/graph</span></span> directory. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​g = new Neo4jGraph('/users/x/neo4j-enterprise-1.7/data/graph.db')​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We’ll keep the Gremlin graph named <span class="calibre9"><span class="calibre30">g</span></span>. The Neo4jGraph object needs to be wrapped in a GraphJung object, which we’ll call <span class="calibre9"><span class="calibre30">j</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​j = new GraphJung( g )​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Part of the reason Kevin Bacon was chosen as the ultimate path destination is his relative closeness to other actors. He has starred in movies with other popular stars. To be important, he didn’t need to be in many roles himself but simply be connected to those who are well connected. </p><a></a><p class="calibre12"> This raises the question: can we find a better actor than Kevin Bacon, in terms of distance from other actors? </p><a></a><p class="calibre12"> JUNG contains a scoring algorithm called BarycenterScorer that gives a score to each vertex based on its distance to all other vertices. If Kevin Bacon is indeed the best choice, we would expect his score to be the lowest, meaning he is “closest” to all other actors. </p><a></a><p class="calibre12"> Our JUNG algorithm should apply only to actors, so we construct a <span class="italic">transformer</span> to filter only actor nodes. The <span class="calibre9"><span class="calibre30">EdgeLabelTransformer</span></span> permits only those nodes with an edge of <span class="calibre9"><span class="calibre30">ACTED_IN</span></span> to the algorithm. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​t = new EdgeLabelTransformer(['ACTED_IN'] as Set, false)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Next, we need to import the algorithm itself, passing in our GraphJung and transformer. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​import edu.uci.ics.jung.algorithms.scoring.BarycenterScorer​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​barycenter = new BarycenterScorer&lt;Vertex,Edge&gt;( j, t )​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> With that, we can get the BarycenterScorer score of any node. Let’s find out what Kevin Bacon’s score is. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​bacon = g.V.filter{it.name=='Kevin Bacon'}.next()​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​bacon_score = barycenter.getVertexScore(bacon)​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​~0.0166​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Once we have Kevin Bacon’s score, we can go through every vertex and store any that have a score lower than his. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​connected = [:]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> It could take a really long time to execute the BarycenterScorer score for each actor in our database. So, instead, let’s just run the algorithm against each of Kevin’s costars. This may take a few minutes, depending on your hardware. BarycenterScorer is fast, but executing over each of Bacon’s costars adds up. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​bacon.costars.each{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  score = b.getVertexScore(it);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  if(score &lt; bacon_score) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    connected[it] = score;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> All of the keys that exist in the <span class="calibre9"><span class="calibre30">connected</span></span> map represent a better choice than Kevin Bacon. But it’s good to have a name we recognize, so let’s output them all and pick one we like. Your output will vary from ours, since the public movie dataset is always in flux. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​connected.collect{k,v -&gt; k.name + " =&gt; " + v}​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; Donald Sutherland =&gt; 0.00925​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; Clint Eastwood =&gt; 0.01488​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​...​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Donald Sutherland appeared in the list with a respectable ~0.00925. So, hypothetically, the Six Degrees of Donald Sutherland should be an easier game to play with your friends than the traditional Six Degrees of Kevin Bacon. </p><a></a><p class="calibre12"> With our <span class="calibre9"><span class="calibre30">j</span></span> graph we can now run any JUNG algorithm on our dataset, for example PageRank. Like BarycenterScorer, you need to import the class first. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​import edu.uci.ics.jung.algorithms.scoring.PageRank​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​pr = new PageRank&lt;Vertex,Edge&gt;( j, t, 0.25d )​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The full list of JUNG algorithms can be found in their online Javadoc API. More are added all the time, so it’s a good place to look before implementing your own. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Day 2 Wrap-Up</span></span></span></p><a></a><p class="calibre29"> On Day 2 we broadened our ability to interact with Neo4j by taking a look at the REST interface. We saw how, using the Gremlin plug-in, we can execute Gremlin code on the server and have the REST interface return results. We played around with a larger dataset and finally finished up with a handful of algorithms for diving into that data. </p><p class="calibre12"><span class="bold"><span class="calibre28">Day 2 Homework</span></span></p><p class="calibre37"><span class="bold">Find</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Bookmark the documentation for the Neo4j REST API.</p></li><li value="2" class="calibre36"><p class="calibre22">Bookmark the API for the JUNG project and the algorithms it implements.</p></li><li value="3" class="calibre36"><p class="calibre22">Find a binding or REST interface for your favorite programming language.</p></li></ol><p class="calibre12"><span class="bold">Do</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Turn the path-finding portion of the Kevin Bacon algorithm into its own step. Then implement a general-purpose Groovy function (for example, <span class="calibre9"><span class="calibre30">def actor_path(g, name1, name2) {…}</span></span>) that accepts the graph and two names and compares the distance.</p></li><li value="2" class="calibre36"><p class="calibre22">Choose and run one of the many JUNG algorithms on a node (or the data set, if the API demands it).</p></li><li value="3" class="calibre36"><p class="calibre22">Install your driver of choice, and use it to manage your company graph with the people and the roles they play, with edges describing their interactions (reports to, works with). If your company is huge, just try your close teams; if you’re with a small organization, try including some customers. Find the most well-connected person in the organization by closest distance to all other nodes.</p></li></ol><p class="calibre12"><img src="images/00018.jpg" class="calibre96"/></p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos1626812" class="calibre1"><p class="calibre24" id="filepos1626817"><span class="calibre25"><span class="bold"><span class="calibre26">7.4 Day 3: Distributed High Availability</span></span></span></p><a></a><p class="calibre27"> We’re going to wrap up our Neo4j investigation by learning how to make Neo4j more attuned to mission-critical uses. We’ll see how Neo4j keeps data stable via ACID-compliant transactions. Then we’ll install and configure a Neo4j high availability (HA) cluster to improve availability when serving high-read traffic. Then we’re going to look into backup strategies to ensure our data remains safe. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Transactions</span></span></span></p><a></a><p class="calibre29"> Neo4j is an Atomic, Consistent, Isolated, Durable (ACID) transaction database, similar to PostgreSQL. This makes it a good option for important data you may have otherwise picked a relational database for. Just like transactions we’ve seen before, Neo4j transactions are all-or-nothing operations. When a transaction starts, every following operation will succeed or fail as an atomic unit—failure of one means failure of all. </p><a></a><p class="calibre12"> The details of how transactions are handled goes beyond Gremlin into the underlying Neo4j wrapper project called Blueprint. Specific details can change from version to version. We’re using Gremlin 1.3, which uses Blueprints 1.0. If you’re using a different version of either, you can find the specifics in the Blueprint API Javadocs. </p><a></a><p class="calibre12"> Just like PostgreSQL, basic one-line functions are automatically wrapped in an implicit transaction. To demonstrate multiline transactions, we need to flag the graph object to turn off automatic transaction mode, letting Neo4j know that we plan to handle transactions manually. You can change the transaction mode through the <span class="calibre9"><span class="calibre30">setTransactionMode</span></span> function. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; g.setTransactionMode(TransactionalGraph.Mode.MANUAL)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You start and stop the transaction on the graph object using <span class="calibre9"><span class="calibre30">startTransaction</span></span> and <span class="calibre9"><span class="calibre30">stopTransaction(conclusion)</span></span>. When you stop the transaction, you also need to mark whether the transaction was successful. If not, Neo4j can roll back all commands executed since the start. It’s a good idea to wrap the transaction within a <span class="calibre9"><span class="calibre30">try/catch</span></span> block to ensure that any exceptions will trigger a rollback. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​g.startTransaction()​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​try {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  // execute some multi-step graph stuff here...​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  g.stopTransaction(TransactionalGraph.Conclusion.SUCCESS)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​} catch(e) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  g.stopTransaction(TransactionalGraph.Conclusion.FAILURE)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If you want to operate outside the Gremlin confines and work directly with the Neo4j <span class="calibre9"><span class="calibre30">EmbeddedGraphDatabase</span></span>, you can use the Java API syntax for transactions. You may have to use this style if you write Java code or use a language that is Java under the covers—like JRuby. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​r = g.getRawGraph()​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​tx = r.beginTx()​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​try {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  // execute some multistep graph stuff here...​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  tx.success()​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​} finally {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  tx.finish()​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Both varieties provide you with full ACID transaction guarantees. Even system failure will ensure any writes are rolled back when the server is fired back up. If you don’t need to manually handle transactions, you’re better off keeping the transaction mode on <span class="calibre9"><span class="calibre30">TransactionalGraph.Mode.AUTOMATIC</span></span>. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">High Availability</span></span></span></p><a></a><p class="calibre29"> High availability mode is Neo4j’s answer to the question, “Can a graph database scale?” Yes, but with some caveats. A write to one slave is not immediately synchronized with all other slaves, so there is a danger of losing consistency (in the CAP sense) for a brief moment (making it eventually consistent). HA will lose pure ACID-compliant transactions. It’s for this reason that Neo4j HA is touted as a solution largely for increasing capacity for reads. </p><a></a><p class="calibre12"> Just like Mongo, the servers in the cluster will elect a master that is the gold copy of data. Unlike Mongo, however, slaves accept writes. Slave writes will synchronize with the master node, which then propagates those changes to the other slaves. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">HA Cluster</span></span></p><a></a><p class="calibre37"> To use Neo4j HA, we must first set up a cluster. Neo4j uses an external cluster coordinator service called Zookeeper. Zookeeper is yet another excellent project to arise from the Apache Hadoop project. It’s a general-purpose service to coordinate distributed applications. Neo4j HA uses this to manage its life-cycle activities. Each Neo4j server has its own related coordinator—tasked with managing its place in the cluster—as shown in Figure 36, <a href="#filepos1636164"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">A three-server Neo4j cluster and their coordinators</span></span><span class="calibre13"><span class="underline">​</span></span></a>. </p><a id="filepos1636164"></a><blockquote class="calibre10"><img src="images/00048.jpg" class="calibre113"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 36. A three-server Neo4j cluster and their coordinators</span></blockquote><p class="calibre12" id="filepos1636462"> Happily, Neo4j Enterprise comes bundled with Zookeeper as well as some files to help us configure a cluster. We’re going to run three instances of Neo4j Enterprise version 1.7. You can download a copy from the website for your operating system (be sure you select the correct edition)<a href="#filepos1666371"><span class="calibre13"><span class="underline">[51]</span></span></a> and then unzip it and create two more copies of the directory. We suffixed ours with 1, 2, and 3 and will refer to them as such. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​tar fx neo4j-enterprise-1.7-unix.tar​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​mv neo4j-enterprise-1.7 neo4j-enterprise-1.7-1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​cp -R neo4j-enterprise-1.7-1 neo4j-enterprise-1.7-2​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​cp -R neo4j-enterprise-1.7-1 neo4j-enterprise-1.7-3​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Now we have three identical copies of our database. </p><a></a><p class="calibre12"> Normally you would unpack one copy per server and configure the cluster to be aware of the other servers. But since we’re running them locally, we’ll instead run them on different directories using different ports. </p><a></a><p class="calibre12"> We will follow five steps to create our cluster, starting by configuring the Zookeeper cluster coordinators and then the Neo4j servers. </p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Set unique IDs for each coordinator server.</p></li><li value="2" class="calibre36"><p class="calibre22">Configure each coordinator server to communicate with the other servers and its hosted Neo4j server.</p></li><li value="3" class="calibre36"><p class="calibre22">Start up all three coordinator servers.</p></li><li value="4" class="calibre36"><p class="calibre22">Configure each Neo4j server to run in HA mode, give them unique ports, and make them aware of the coordinator cluster.</p></li><li value="5" class="calibre36"><p class="calibre22">Start up all three Neo4j servers.</p></li></ol><a></a><p class="calibre12"> Zookeeper tracks each server by way of an ID unique to the cluster. This number is the only value in the file <span class="calibre9"><span class="calibre30">data/coordinator/myid</span></span>. For server 1 we’ll keep it at the default 1; for server 2 we’ll set it to 2 and set server 3 to contain 3. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​echo "2" &gt; neo4j-enterprise-1.7-2/data/coordinator/myid​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​echo "3" &gt; neo4j-enterprise-1.7-3/data/coordinator/myid​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We must also indicate some communication settings internal to the cluster. Each server will have a file named <span class="calibre9"><span class="calibre30">conf/coord.cfg</span></span>. By default, notice the <span class="calibre9"><span class="calibre30">server.1</span></span> variable has the server as <span class="calibre9"><span class="calibre30">localhost</span></span> and two ports set: the quorum election port (<span class="calibre9"><span class="calibre30">2888</span></span>) and the master election port (<span class="calibre9"><span class="calibre30">3888</span></span>). </p><p class="calibre12"><span class="bold">Building the Cluster</span>
</p><a></a><p class="calibre12"> A Zookeeper quorum is a group of servers in the cluster and the ports they communicate through (this should not to be confused with a Riak quorum, which is a minimal majority for enforcing consistency). The master election port is used when the master goes down—this special port is used so the remaining servers can elect a new master. We’ll keep <span class="calibre9"><span class="calibre30">server.1</span></span> as is and add <span class="calibre9"><span class="calibre30">server.2</span></span> and <span class="calibre9"><span class="calibre30">server.3</span></span> to use successive ports. The <span class="calibre9"><span class="calibre30">coord.cfg</span></span> files under servers 1, 2, and 3 must all contain the same three lines. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​server.1=localhost:2888:3888​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​server.2=localhost:2889:3889​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​server.3=localhost:2890:3890​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Finally, we must set the public port to which Neo4j may connect. This <span class="calibre9"><span class="calibre30">clientPort</span></span> defaults to 2181, so for server 1 we’ll leave it alone. We set <span class="calibre9"><span class="calibre30">clientPort=2182</span></span> for server 2 and <span class="calibre9"><span class="calibre30">clientPort=2183</span></span> for server 3. If any of these ports are in use on your machine, feel free to change this as necessary, but we’ll assume the previous ports are in use for the remaining steps. </p><p class="calibre12"><span class="bold">Coordinate</span>
</p><a></a><p class="calibre12"> We start up the Zookeeper coordinator with a handy script provided by the Neo4j team. Run the following command in each of the three server directories: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​bin/neo4j-coordinator start​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Starting Neo4j Coordinator...WARNING: not changing user​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  process [36542]... waiting for coordinator to be ready. OK.​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The coordinator is now running, but Neo4j is not. </p><p class="calibre12"><span class="bold">Wiring in Neo4j</span>
</p><a></a><p class="calibre12"> Next we need to set up Neo4j to run in high availability mode and then connect to a coordinator server. Open <span class="calibre9"><span class="calibre30">conf/neo4j-server.properties</span></span>, and add the following line under each server: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​org.neo4j.server.database.mode=HA​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This sets Neo4j to run in high availability mode; up until now we’ve been running in SINGLE mode. While we’re in this file, let’s set the web server port to a unique number. Normally the default port 7474 is fine, but since we’re running three neo4j instances on one box, we can’t let them overlap for http/https. We chose ports 7471/7481 for server 1, 7472/7482 for server 3, and 7473/7483 for server 3. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​org.neo4j.server.webserver.port=7471​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​org.neo4j.server.webserver.https.port=7481​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Finally, we set each Neo4j instance to connect to one of the coordinator servers. If you open the <span class="calibre9"><span class="calibre30">conf/neo4j.properties</span></span> file for server 1, you should see a few commented lines starting with <span class="calibre9"><span class="calibre30">ha</span></span>. These are high availability settings that convey three things: the current cluster machine number, the list of zookeeper servers, and the port that the neo4j servers will use to communicate with each other. For server 1, add the following fields to <span class="calibre9"><span class="calibre30">neo4j.properties</span></span>: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ha.server_id=1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ha.coordinators=localhost:2181,localhost:2182,localhost:2183​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ha.server=localhost:6001​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ha.pull_interval=1​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> These settings will be similar on the other two servers, with two provisos: <span class="calibre9"><span class="calibre30">ha.server_id=2</span></span> for server 2 and <span class="calibre9"><span class="calibre30">ha.server_id=3</span></span> for server 3. And the <span class="calibre9"><span class="calibre30">ha.server</span></span> must use a different port (we chose 6002 for server 2 and 6003 for server 3). Again, the server ports needn’t change when you run them on separate machines. Server 2 will contain the following (and so on for server 3): </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ha.server_id=2​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ha.coordinators=localhost:2181,localhost:2182,localhost:2183​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ha.server=localhost:6002​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ha.pull_interval=1​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We set <span class="calibre9"><span class="calibre30">pull_interval</span></span> to 1, which means each slave should check the master for updates every second. Generally, you won’t go this low, but it lets us see updates for the example data we’ll soon insert. </p><a></a><p class="calibre12"> With our Neo4j HA servers configured, it’s time to start them up. Just like the coordinator server startup script, start the neo4j server in each install directory. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​bin/neo4j start​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You can watch the server output by tailing the log file. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​tail -f data/log/console.log​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Each server will attach to its configured coordinator. </p><p class="calibre12"><span class="bold">Verifying Cluster Status</span>
</p><p class="calibre12" id="filepos1650896"> Whatever coordinator was first launched will be the master server—probably server 1. You can verify this by opening the attached Neo4j instance’s web admin (previously we set server 1 to port 7471). Click the Server Info link at the top and then High Availability on the side menu.<a href="#filepos1666371"><span class="calibre13"><span class="underline">[52]</span></span></a>
</p><a></a><p class="calibre12"> The properties under High Availability list information about this cluster. If this server is the master server, the property will be true. If not, you can find which server has been elected master by looking under InstancesInCluster. This lists each connected server, its machine ID, whether it is the master server, and other info. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Verifying Replication</span></span></p><a></a><p class="calibre37"> With our cluster up and running, you can verify that your servers are replicating correctly. If all goes according to plan, any writes to a slave should propagate to the master node and then eventually to the other slave server. If you open the web consoles for each of the three servers, you can use the built-in Gremlin consoles in the web admin. Notice that the Gremlin graph object has changed to wrap a HighlyAvailableGraphDatabase. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​g = neo4jgraph[HighlyAvailableGraphDatabase [/…/neo4j-ent-1.7-2/data/graph.db]]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> To test our servers, we’re going to populate our new graph with some nodes containing the names of some famous paradoxes. In one of the slave consoles, let’s set the root node to store Zeno’s paradox. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; root = g.v(0)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; root.paradox = "Zeno's"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; root.save​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Now let’s switch to the master server’s console and output the vertex paradox values. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; g.V.paradox​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; Zeno's​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Now if you switch to the other slave server and add Russell’s paradox, a quick look at our list will reveal both nodes exist in the second slave, having added only one directly to this server. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; g.addVertex(["paradox" : "Russell's"])​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​gremlin&gt; g.V.paradox​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; Zeno's​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​==&gt; Russell's​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If one of your slave servers does not yet have the changes propagated to it, you can go back to the Server Info, High Availability screen. Look for all instances of <span class="calibre9"><span class="calibre30">lastCommittedTransactionId</span></span>. When these values are equal, the system data is consistent. The lower the number, the older the version of data in that server. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Master Election</span></span></p><a></a><p class="calibre37"> If you shut down the master server and refresh the server info in one of the remaining servers, you will see that another server has been elected the new master. Starting the server again will add it back to the cluster, but now the old master will remain a slave (until another server goes down). </p><a></a><p class="calibre12"> High availability allows very read-heavy systems to deal with replicating a graph across multiple servers and thus sharing the load. Although the cluster as a whole is only eventually consistent, there are tricks you can apply to reduce the chance of reading stale data in your own applications, such as assigning a session to one server. With the right tools, planning, and a good setup, you can build a graph database large enough to handle billions of nodes and edges and nearly any number of requests you may need. Just add regular backups, and you have the recipe for a solid production system. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Backups</span></span></span></p><a></a><p class="calibre29"> Backups are a necessary aspect of any professional database use. Although backups are effectively built in when using replication, nightly backups that are stored off-site are always a good idea for disaster recovery. It’s hard to plan for a server room fire or an earthquake shaking a building to rubble. </p><a></a><p class="calibre12"> Neo4j Enterprise offers a simple backup tool named neo4j-backup. </p><a></a><p class="calibre12"> The most powerful method when running an HA server is to craft a full backup command to copy the database file from the cluster to a date-stamped file on a mounted drive. Pointing the copy to every server in the cluster will ensure you get the most recent data available. The backup directory created is a fully usable copy. If you need to recover, just replace each installation’s data directory with the backup directory, and you’re ready to go. </p><a></a><p class="calibre12"> You must start with a full backup. Here we back up our HA cluster to a directory that ends with today’s date (uses the *nix date command). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​bin/neo4j-backup -full -from ha://localhost:2181,localhost:2182,localhost:2183 \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-to /mnt/backups/neo4j-`date +%Y.%m.%d`.db​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If you’re not running in HA mode, just change the mode in the URI to single. Once you have done a full backup, you can choose to do an incremental backup that will store changes only since the last backup. If we want to do a full backup on a single server at midnight and then grab the incremental changes every two hours, you could execute this command: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​bin/neo4j-backup -incremental -from single://localhost \​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​-to /mnt/backups/neo4j-`date +%Y.%m.%d`.db​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> But keep in mind incremental works only on a fully backed-up directory, so ensure the previous command is run on the same day. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Day 3 Wrap-Up</span></span></span></p><a></a><p class="calibre29"> Today we spent some time keeping Neo4j data stable via ACID-compliant transactions, high availability, and backup tools. </p><a></a><p class="calibre12"> It’s important to note that all of the tools we used today require the Neo4j Enterprise edition, and so use a dual license—GPL/AGPL. If you want to keep your server closed source, you should look into switching to the Community edition or getting an OEM from Neo Technology (the company behind Neo4j). Contact the Neo4j team for more information. </p><p class="calibre12"><span class="bold"><span class="calibre28">Day 3 Homework</span></span></p><p class="calibre37"><span class="bold">Find</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Find the Neo4j licensing guide.</p></li><li value="2" class="calibre36"><p class="calibre22">Answer the question, “What is the maximum number of nodes supported?” (Hint: it’s in Questions &amp; Answers in the website docs.)</p></li></ol><p class="calibre12"><span class="bold">Do</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Replicate Neo4j across three physical servers.</p></li><li value="2" class="calibre36"><p class="calibre22">Set up a load balancer using a web server like Apache or Nginx, and connect to the cluster using the REST interface. Execute a Gremlin script command.</p></li></ol><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos1661845" class="calibre1"><p class="calibre24" id="filepos1661850"><span class="calibre25"><span class="bold"><span class="calibre26">7.5 Wrap-Up</span></span></span></p><a></a><p class="calibre27"> Neo4j is a top open source implementation of the (relatively rare) class of graph databases. Graph databases focus on the relationships between data, rather than the commonalities among values. Modeling graph data is simple. You just create nodes and relationships between them and optionally hang key-value pairs from them. Querying is as easy as declaring how to walk the graph from a starting node. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Neo4j’s Strengths</span></span></span></p><a></a><p class="calibre29"> Neo4j is one of the finest examples of open source graph databases. Graph databases are perfect for unstructured data, in many ways even more so than document datastores. Not only is Neo4j typeless and schemaless, but it puts no constraints on how data is related. It is, in the best sense, a free-for-all. Currently, Neo4j can support 34.4 billion nodes and 34.4 billion relationships, which is more than enough for most uses (Neo4j could hold more than 42 nodes for each of Facebook’s 800 million users in a single graph). </p><a></a><p class="calibre12"> The Neo4j distributions provide several tools for fast lookups with Lucene and easy-to-use (if sometimes cryptic) language extensions like Gremlin and the REST interface. Beyond ease of use, Neo4j is fast. Unlike join operations in relational databases or map-reduce operations in other databases, graph traversals are constant time. Like data is only a node step away, rather than joining values in bulk and filtering the desired results—as most of the databases we’ve seen operate. It doesn’t matter how large the graph becomes; moving from node A to node B is always one step if they share a relationship. Finally, the Enterprise edition provides for highly available and high read-traffic sites by way of Neo4j HA. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Neo4j’s Weaknesses</span></span></span></p><a></a><p class="calibre29"> Neo4j does have a few shortcomings. Edges in Neo4j cannot direct a vertex back on itself. We also found its choice of nomenclature (<span class="italic">node</span> rather than <span class="italic">vertex</span>, and <span class="italic">relationship</span> rather than <span class="italic">edge</span>) to add complexity when communicating. Although HA is excellent at replication, it can only replicate a full graph to other servers. It cannot currently shard subgraphs, which still places a limit on graph size (though, to be fair, that limit measures in the tens of billions). Finally, if you are looking for a business-friendly open source license (like MIT), Neo4j may not be for you. Where the Community edition (everything we used in the first two days) is GPL, if you want to run a production environment using the Enterprise tools (which includes HA and backups), you’ll probably need to purchase a license. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Neo4j on CAP</span></span></span></p><a></a><p class="calibre29"> If you choose to distribute, the name “high availability” cluster should give away their strategy. Neo4j HA is available and partition tolerant (AP). Each slave will return only what it currently has, which may be out of sync with the master node temporarily. Although you can reduce the update latency by increasing a slave’s pull interval, it’s still technically eventually consistent. This is why Neo4j HA is recommended for read-mostly requirements. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Parting Thoughts</span></span></span></p><a></a><p class="calibre29"> Neo4j’s simplicity can be off-putting if you’re not used to modeling graph data. It provides a powerful open source API with years of production use and yet still has relatively few users. We chalk this up to lack of knowledge, since graph databases mesh so naturally with how humans tend to conceptualize data. We imagine our families as trees, or our friends as graphs; most of us don’t imagine personal relationships as self-referential datatypes. For certain classes of problems, like social networks, Neo4j is an obvious choice. But you should give it some serious consideration for nonobvious problems as well—it just may surprise you how powerful and easy it is. </p><p class="calibre23"><span class="calibre9"><span class="bold"><span class="calibre28">Footnotes</span></span></span></p><a id="filepos1666371"></a><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1563540"><span class="calibre9"><span class="calibre13"><span class="underline">[47]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://api.neo4j.org/current/org/neo4j/graphalgo/GraphAlgoFactory.html"><span class="calibre9"><span class="calibre13"><span class="underline">http://api.neo4j.org/current/org/neo4j/graphalgo/GraphAlgoFactory.html</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1572436"><span class="calibre9"><span class="calibre13"><span class="underline">[48]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://docs.neo4j.org/chunked/stable/gremlin-plugin.html"><span class="calibre9"><span class="calibre13"><span class="underline">http://docs.neo4j.org/chunked/stable/gremlin-plugin.html</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1575575"><span class="calibre9"><span class="calibre13"><span class="underline">[49]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://download.freebase.com/datadumps/latest/browse/film/performance.tsv"><span class="calibre9"><span class="calibre13"><span class="underline">http://download.freebase.com/datadumps/latest/browse/film/performance.tsv</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1614212"><span class="calibre9"><span class="calibre13"><span class="underline">[50]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://blueprints.tinkerpop.com"><span class="calibre9"><span class="calibre13"><span class="underline">http://blueprints.tinkerpop.com</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1636462"><span class="calibre9"><span class="calibre13"><span class="underline">[51]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://neo4j.org/download/"><span class="calibre9"><span class="calibre13"><span class="underline">http://neo4j.org/download/</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1650896"><span class="calibre9"><span class="calibre13"><span class="underline">[52]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://localhost:7471/webadmin/#/info/org.neo4j/High%20Availability/"><span class="calibre9"><span class="calibre13"><span class="underline">http://localhost:7471/webadmin/#/info/org.neo4j/High%20Availability/</span></span></span></a><span class="calibre9">
</span></p></td></tr></table><p class="calibre17"><span class="calibre9"><span class="calibre18"><span class="calibre19">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos1669053" class="calibre1"><p class="calibre21" id="filepos1669058"><span class="calibre3"><span class="bold"><span class="calibre31"> Chapter 8</span></span></span></p><br class="calibre1"/><p class="calibre32"><span class="calibre3"><span class="bold"><span class="calibre4">Redis</span></span></span></p><a></a><p class="calibre12"> Redis is like grease. It’s most often used to lubricate moving parts and keep them working smoothly by reducing friction and speeding up their overall function. Whatever the machinery of your system, it could very well be improved with a bit poured over it. Sometimes the answer to your problem is simply a judicious use of more Redis. </p><a></a><p class="calibre12"> First released in 2009, Redis (REmote DIctionary Service) is a simple-to-use key-value store with a sophisticated set of commands. And when it comes to speed, Redis is hard to beat. Reads are fast, and writes are even faster, handling upwards of 100,000 <span class="calibre9"><span class="calibre30">SET</span></span> operations per second by some benchmarks. Redis creator Salvatore Sanfilippo refers to his project as a “data structure server” to capture its nuanced handling of complex datatypes and other features. Exploring this super-fast, more-than-just-a-key-value-store will round out our view of the modern database landscape. </p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos1670371" class="calibre1"><p class="calibre24" id="filepos1670376"><span class="calibre25"><span class="bold"><span class="calibre26">8.1 Data Structure Server Store</span></span></span></p><a></a><p class="calibre27"> It can be a bit difficult to classify exactly what Redis <span class="italic">is</span>. At a basic level, it’s a key-value store, of course, but that simple label doesn’t really do it justice. Redis supports advanced data structures, though not to the degree that a document-oriented database would. It supports set-based query operations but not with the granularity or type support you’d find in a relational database. And, of course, it’s <span class="italic">fast</span>, trading durability for raw speed. </p><a></a><p class="calibre12"> In addition to being an advanced data structure server, Redis is a blocking queue (or stack) and a publish-subscribe system. It features configurable expiry policies, durability levels, and replication options. All of this makes Redis more of a toolkit of useful data structure algorithms and processes than a member of any specific database genre. </p><a></a><p class="calibre12"> Redis’ expansive list of client libraries makes it a drop-in option for many programming languages. It’s not simply easy to use; it’s a joy. If an API is UX for programmers, then Redis should be in the Museum of Modern Art alongside the Mac Cube. </p><a></a><p class="calibre12"> In Days 1 and 2 we’ll explore Redis’s features, conventions, and configuration. Starting with simple CRUD operations like always, we’ll quickly move on to more advanced operations involving more powerful data structures: lists, hashes, sets, and sorted sets. We’ll create transactions and manipulate data expiry characteristics. We’ll use Redis to create a simple message queue and explore its publish-subscribe functionality. Then we’ll dive into Redis’s configuration and replication options, learning how to strike an application-appropriate balance between data durability and speed. </p><a></a><p class="calibre12"> Databases are often and increasingly used in concert with each other. Redis is introduced last in this book so that we can use it in just such a manner. In Day 3, we’ll build our capstone system, a rich multidatabase music solution including Redis, CouchDB, Neo4J, and Postgres—using Node.js to cement it together. </p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos1672748" class="calibre1"><p class="calibre24" id="filepos1672753"><span class="calibre25"><span class="bold"><span class="calibre26">8.2 Day 1: CRUD and Datatypes</span></span></span></p><a></a><p class="calibre27"> Since the command-line interface (CLI) is of such primary importance to the Redis development team—and loved by users everywhere—we’re going to spend Day 1 looking at many of the 124 commands available. Of primary importance is its sophisticated datatypes and how they can query in more ways than simply “retrieve the value of this key.” </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Getting Started</span></span></span></p><p class="calibre29" id="filepos1673387"> Redis is available through a few package builders like Homebrew for Mac but is also rather painless to build.<a href="#filepos1946379"><span class="calibre13"><span class="underline">[53]</span></span></a> We’ll be working off version 2.4. Once you have it installed, you can start up the server by calling this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">redis-server</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> It won’t run in the background by default, but you can make that happen by appending &amp;, or you can just open another terminal. Next run the command-line tool, which should connect to the default port 6379 automatically. </p><a></a><p class="calibre12"> After you connect, let’s try to ping the server. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">redis-cli</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; PING​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​PONG​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If you cannot connect, you’ll receive an error message. Typing <span class="calibre9"><span class="italic"><span class="calibre38">help</span></span></span> will display a list of help options. Type <span class="calibre9"><span class="italic"><span class="calibre38">help</span></span></span> followed by a space and then start typing any command. If you don’t know any Redis commands, just start pressing Tab to cycle through your options. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; help​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Type: "help @&lt;group&gt;" to get a list of commands in &lt;group&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "help &lt;command&gt;" for help on &lt;command&gt;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "help &lt;tab&gt;" to get a list of possible help topics​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "quit" to exit​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Today we’re going to use Redis to build the back end for a URL shortener, like tinyurl.com or bit.ly. A URL shortener is a service that takes a really long URL and maps it to a shorter version on their own domain—like mapping <span class="calibre9"><span class="calibre30">http://www.myveryververylongdomain.com/somelongpath.php</span></span> to <span class="calibre9"><span class="calibre30">http://bit.ly/VLD</span></span>. Visiting that short URL redirects users to the longer mapped URL, saves the visitors from text messaging long strings, and also provides the short URL creator some statistics like a count of visits. </p><a></a><p class="calibre12"> In Redis we can use <span class="calibre9"><span class="calibre30">SET</span></span> to key a short code like <span class="calibre9"><span class="calibre30">7wks</span></span> to a value like <span class="calibre9"><span class="calibre30">http://www.sevenweeks.org</span></span>. <span class="calibre9"><span class="calibre30">SET</span></span> always requires two parameters, a key and a value. Retrieving the value just needs <span class="calibre9"><span class="calibre30">GET</span></span> and the key name. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; SET 7wks http://www.sevenweeks.org/​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​OK​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; GET 7wks​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​"http://www.sevenweeks.org/"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> To reduce traffic, we can also set multiple values with <span class="calibre9"><span class="calibre30">MSET</span></span>, like any number of key-value pairs. Here we map Google.com to <span class="calibre9"><span class="calibre30">gog</span></span> and Yahoo.com to <span class="calibre9"><span class="calibre30">yah</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; MSET gog http://www.google.com yah http://www.yahoo.com​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​OK​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Correlatively, <span class="calibre9"><span class="calibre30">MGET</span></span> grabs multiple keys and returns values as an ordered list. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; MGET gog yah​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1) "http://www.google.com/"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​2) "http://www.yahoo.com/"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Although Redis stores strings, it recognizes integers and provides some simple operations for them. If we want to keep a running total of how many short keys are in our dataset, we can create a count and then increment it with the <span class="calibre9"><span class="calibre30">INCR</span></span> command. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; SET count 2​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​OK​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; INCR count​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​(integer) 3​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; GET count​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​"3"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Although <span class="calibre9"><span class="calibre30">GET</span></span> returns <span class="calibre9"><span class="calibre30">count</span></span> as a string, <span class="calibre9"><span class="calibre30">INCR</span></span> recognized it as an integer and added one to it. Any attempt to increment a noninteger ends poorly. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; SET bad_count "a"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​OK​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; INCR bad_count​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​(error) ERR value is not an integer or out of range​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If the value can’t be resolved to an integer, Redis rightly complains. You can also increment by any integer (<span class="calibre9"><span class="calibre30">INCRBY</span></span>) or decrement (<span class="calibre9"><span class="calibre30">DECR</span></span>, <span class="calibre9"><span class="calibre30">DECRBY</span></span>). </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Transactions</span></span></span></p><a></a><p class="calibre29"> We’ve seen transactions in previous databases (Postgres and Neo4j), and Redis’ <span class="calibre9"><span class="calibre30">MULTI</span></span> block atomic commands are a similar concept. Wrapping two operations like <span class="calibre9"><span class="calibre30">SET</span></span> and <span class="calibre9"><span class="calibre30">INCR</span></span> in a single block will complete either successfully or not at all. But you will never end up with a partial operation. </p><a></a><p class="calibre12"> Let’s key another short code to a URL and also increment the count all in one transaction. We begin the transaction with the <span class="calibre9"><span class="calibre30">MULTI</span></span> command and execute it with <span class="calibre9"><span class="calibre30">EXEC</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; MULTI​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​OK​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; SET prag http://pragprog.com​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​QUEUED​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; INCR count​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​QUEUED​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; EXEC​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1) OK​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​2) (integer) 2​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> When using <span class="calibre9"><span class="calibre30">MULTI</span></span>, the commands aren’t actually executed when we define them (similar to Postgres transactions). Instead, they are queued and then executed in sequence. </p><a></a><p class="calibre12"> Similar to <span class="calibre9"><span class="calibre30">ROLLBACK</span></span> in SQL, you can stop a transaction with the <span class="calibre9"><span class="calibre30">DISCARD</span></span> command, which will clear the transaction queue. Unlike <span class="calibre9"><span class="calibre30">ROLLBACK</span></span>, it won’t revert the database; it will simply not run the transaction at all. The effect is identical, although the underlying concept is a different mechanism (transaction rollback vs. operation cancellation). </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Complex Datatypes</span></span></span></p><a></a><p class="calibre29"> So far, we haven’t seen much complex behavior. Storing string and integer values under keys—even as transactions—is all fine and good, but most programming and data storage problems deal with many types of data. Storing lists, hashes, sets, and sorted sets natively helps explain Redis’ popularity, and after exploring the complex operations you can enact on them, you may find you agree. </p><a></a><p class="calibre12"> These collection datatypes can contain a huge number of values (up to 2^32 elements or more than 4 billion) per key. That’s more than enough for all Facebook accounts to live as a list under a single key. </p><a></a><p class="calibre12"> While some Redis commands may appear cryptic, they generally follow a good pattern. <span class="calibre9"><span class="calibre30">SET</span></span> commands begin with <span class="calibre9"><span class="calibre30">S</span></span>, hashes with <span class="calibre9"><span class="calibre30">H</span></span>, and sorted sets with <span class="calibre9"><span class="calibre30">Z</span></span>. List commands generally start with either an <span class="calibre9"><span class="calibre30">L</span></span> (for left) or an <span class="calibre9"><span class="calibre30">R</span></span> (for right), depending on the direction of the operation (such as <span class="calibre9"><span class="calibre30">LPUSH</span></span>). </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Hash</span></span></p><a></a><p class="calibre37"> Hashes are like nested Redis objects that can take any number of key-value pairs. Let’s use a hash to keep track of users who sign up for our URL-shortening service. </p><a></a><p class="calibre12"> Hashes are nice because they help you avoid storing data with artificial key prefixes. (Note that we used colons [:] within our key. This is a valid character that often logically separates a key into segments. It’s merely a matter of convention, with no deeper meaning in Redis.) </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; MSET user:eric:name "Eric Redmond" user:eric:password s3cret​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​OK​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; MGET user:eric:name user:eric:password​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1) "Eric Redmond"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​2) "s3cret"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Instead of separate keys, we can create a hash that contains its own key-value pairs. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; HMSET user:eric name "Eric Redmond" password s3cret​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​OK​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We need only keep track of the single Redis key to retrieve all values of the hash. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; HVALS user:eric​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1) "Eric Redmond"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​2) "s3cret"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Or we can retrieve all hash keys. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; HKEYS user:eric​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1) "name"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​2) "password"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Or we can get a single value, by passing in the Redis key, followed by the hash key. Here we get just the password. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; HGET user:eric password​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​"s3cret"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Unlike the document datastores Mongo and CouchDB, hashes in Redis cannot nest (nor can any other complex datatype such as lists). In other words, hashes can store only string values. </p><a></a><p class="calibre12"> More commands exist to delete hash fields (<span class="calibre9"><span class="calibre30">HDEL</span></span>), increment an integer field value by some count (<span class="calibre9"><span class="calibre30">HINCRBY</span></span>), or retrieve the number of fields in a hash (<span class="calibre9"><span class="calibre30">HLEN</span></span>). </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">List</span></span></p><a></a><p class="calibre37"> Lists contain multiple ordered values that can act both as queues (first value in, first value out) and as stacks (last value in, first value out). They also have more sophisticated actions for inserting somewhere in the middle of a list, constraining list size, and moving values between lists. </p><a></a><p class="calibre12"> Since our URL-shortening service can now track users, we want to allow them to keep a wishlist of URLs they’d like to visit. To create a list of short-coded websites we’d like to visit, we set the key to <span class="calibre9"><span class="calibre30">USERNAME:wishlist</span></span> and push any number of values to the right (end) of the list. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; RPUSH eric:wishlist 7wks gog prag​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​(integer) 3​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Like most collection value insertions, the Redis command returns the number of values pushed. In other words, we pushed three values into the list so it returns 3. You can get the list length at any time with <span class="calibre9"><span class="calibre30">LLEN</span></span>. </p><a></a><p class="calibre12"> Using the list range command <span class="calibre9"><span class="calibre30">LRANGE</span></span>, we can retrieve any part of the list by specifying the first and last positions. All list operations in Redis use a zero-based index. A negative position means the number of steps from the end. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; LRANGE eric:wishlist 0 -1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1) "7wks"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​2) "gog"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​3) "prag"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> LREM removes from the given key some matching values. It also requires a number to know how many matches to remove. Setting the count to 0 as we do here just removes them all: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; LREM eric:wishlist 0 gog​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Setting the count greater than 0 will remove only that number of matches, and setting the count to a negative number will remove that number of matches but scan the list from the end (right side). </p><a></a><p class="calibre12"> To remove and retrieve each value in the order we added them (like a queue), we can pop them off from the left (head) of the list. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; LPOP eric:wishlist​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​"7wks"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> To act as a stack, after you <span class="calibre9"><span class="calibre30">RPUSH</span></span> the values, you would <span class="calibre9"><span class="calibre30">RPOP</span></span> from the end of the list. All of these operations are performed in constant time. </p><a></a><p class="calibre12"> On the previous combination of commands, you can use <span class="calibre9"><span class="calibre30">LPUSH</span></span> and <span class="calibre9"><span class="calibre30">RPOP</span></span> to similar effect (a queue) or <span class="calibre9"><span class="calibre30">LPUSH</span></span> and <span class="calibre9"><span class="calibre30">LPOP</span></span> to be a stack. </p><a></a><p class="calibre12"> Suppose we wanted to remove values from our wishlist and move them to another list of visited sites. To execute this move atomically, we could wrap pop and push actions within a multiblock. In Ruby these steps might look something like this (you can’t use the CLI here because you must save the popped value, so we used the <span class="calibre9"><span class="calibre30">redis-rb</span></span> gem): </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis.multi </span><span class="calibre9"><span class="bold"><span class="calibre44">do</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  site = redis.rpop(</span><span class="calibre9"><span class="italic"><span class="calibre38">'eric:wishlist'</span></span></span><span class="calibre9">)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  redis.lpush(</span><span class="calibre9"><span class="italic"><span class="calibre38">'eric:visited'</span></span></span><span class="calibre9">, site)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> But Redis provides a single command for popping values from the tail of one list and pushing to the head of another. It’s called <span class="calibre9"><span class="calibre30">RPOPLPUSH</span></span> (right pop, left push). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; RPOPLPUSH eric:wishlist eric:visited​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​"prag"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If you find the range of the wishlist, <span class="calibre9"><span class="calibre30">prag</span></span> will be gone; it now lives under <span class="calibre9"><span class="calibre30">visited</span></span>. This is a useful mechanism for queuing commands. </p><a></a><p class="calibre12"> If you looked through the Redis docs to find <span class="calibre9"><span class="calibre30">RPOPRPUSH</span></span>, <span class="calibre9"><span class="calibre30">LPOPLPUSH</span></span>, and <span class="calibre9"><span class="calibre30">LPOPRPUSH</span></span> commands, you may be dismayed to learn they don’t exist. <span class="calibre9"><span class="calibre30">RPOPLPUSH</span></span> is your only option, and you must build your list accordingly. </p><a></a><p class="calibre12"><span class="bold">Blocking Lists</span>
</p><a></a><p class="calibre12"> Now that our URL shortener is taking off, let’s add some social activities—like a real-time commenting system—where people can post about the websites they have visited. </p><a></a><p class="calibre12"> Let’s write a simple messaging system where multiple clients can push comments and one client (the digester) pops messages from the queue. We’d like the digester to just listen for new comments and pop them as they arrive. Redis provides a few blocking commands for this sort of purpose. </p><a></a><p class="calibre12"> First open another terminal and start another <span class="calibre9"><span class="calibre30">redis-cli</span></span> client. This will be our digester. The command to block until a value exists to pop is <span class="calibre9"><span class="calibre30">BRPOP</span></span>. It requires the key to pop a value from and a timeout in seconds, which we’ll set to five minutes. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; BRPOP comments 300​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Then switch back to the first console and push a message to comments. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; LPUSH comments "Prag is great! I buy all my books there."​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If you switch back to the digester console, two lines will be returned: the key and the popped value. The console will also output the length of time it spent blocking. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1) "comments"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​2) "Prag is great! I buy all my books there."​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​(50.22s)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> There’s also a blocking version of left pop (<span class="calibre9"><span class="calibre30">BLPOP</span></span>) and right pop, left push (<span class="calibre9"><span class="calibre30">BRPOPLPUSH</span></span>). </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Set</span></span></p><a></a><p class="calibre37"> Our URL shortener is shaping up nicely, but it would be nice to group common URLs in some way. </p><a></a><p class="calibre12"> Sets are unordered collections with no duplicate values and are an excellent choice for performing complex operations between two or more key values, such as unions or intersections. </p><a></a><p class="calibre12"> If we wanted to categorize sets of URLs with a common key, we can add multiple values with <span class="calibre9"><span class="calibre30">SADD</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; SADD news nytimes.com pragprog.com​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​(integer) 2​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Redis added two values. We can retrieve the full set, in no particular order, via <span class="calibre9"><span class="calibre30">SMEMBERS</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; SMEMBERS news​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1) "pragprog.com"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​2) "nytimes.com"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Let’s add another category called <span class="italic">tech</span> for technology-related sites. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; SADD tech pragprog.com apple.com​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​(integer) 2​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> To find the intersection of websites that both provide news and are technology focused, we use the <span class="calibre9"><span class="calibre30">SINTER</span></span> command. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; SINTER news tech​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1) "pragprog.com"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Just as easily, we can remove any matching values in one set from another. To find all news sites that are not tech sites, use <span class="calibre9"><span class="calibre30">SDIFF</span></span>: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; SDIFF news tech​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1) "nytimes.com"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We can also build a union of websites that are either news or tech. Since it’s a set, any duplicates are dropped. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; SUNION news tech​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1) "apple.com"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​2) "pragprog.com"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​3) "nytimes.com"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> That set of values can also be stored directly into a new set (<span class="calibre9"><span class="calibre30">SUNIONSTORE destination key [key …]</span></span>). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; SUNIONSTORE websites news tech​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This also provides a useful trick for cloning a single key’s values to another key, such as <span class="calibre9"><span class="calibre30">SUNIONSTORE news_copy news</span></span>. Similar commands exist for storing intersections (<span class="calibre9"><span class="calibre30">SINTERSTORE</span></span>) and diffs (<span class="calibre9"><span class="calibre30">SDIFFSTORE</span></span>). </p><a></a><p class="calibre12"> Just like <span class="calibre9"><span class="calibre30">RPOPLPUSH</span></span> moved values from one list to another, <span class="calibre9"><span class="calibre30">SMOVE</span></span> does the same for sets; it’s just easier to remember. </p><a></a><p class="calibre12"> And like <span class="calibre9"><span class="calibre30">LLEN</span></span> finds the length of a list, <span class="calibre9"><span class="calibre30">SCARD</span></span> (set cardinality) counts the set; it’s just harder to remember. </p><a></a><p class="calibre12"> Since sets are not ordered, there are no left, right, or other positional commands. Popping a random value from a set just requires <span class="calibre9"><span class="calibre30">SPOP key</span></span>, and removing values is <span class="calibre9"><span class="calibre30">SREM key value [value …]</span></span>. </p><a></a><p class="calibre12"> Unlike lists, there are no blocking commands for sets. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Sorted Sets</span></span></p><a></a><p class="calibre37"> Whereas other Redis datatypes we’ve looked at so far easily map to common programming language constructs, sorted sets take something from each of the previous datatypes. They are ordered like lists and are unique like sets. They have field-value pairs like hashes, but rather than string fields, they are instead numeric scores that denote the order of the values. You can think of sorted sets as like a random access priority queue. This power has a trade-off, however. Internally, sorted sets keep values in order, so inserts can take log(N) time to insert (where N is the size of the set), rather than the constant time complexity of hashes or lists. </p><a></a><p class="calibre12"> Next we want to keep track of the popularity of specific shortcodes. Every time someone visits a URL, the score gets increased. Like a hash, adding a value to a sorted set requires two values after the Redis key name: the score and the member. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; ZADD visits 500 7wks 9 gog 9999 prag​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​(integer) 3​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> To increment a score, we can either re-add it with the new score, which just updates the score but does not add a new value, or increment by some number, which will return the new value. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; ZINCRBY visits 1 prag​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​"10000"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You can decrement also by setting a negative number for <span class="calibre9"><span class="calibre30">ZINCRBY</span></span>. </p><p class="calibre12"><span class="bold">Ranges</span>
</p><a></a><p class="calibre12"> To get values from our visits set, we can issue a range command, <span class="calibre9"><span class="calibre30">ZRANGE</span></span>, which returns by position, just like the list datatype’s <span class="calibre9"><span class="calibre30">LRANGE</span></span> command. Except in the case of a sorted set, the position is ordered by score from lowest to highest. So, to get the top two scoring visited sites (zero-based), use this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; ZRANGE visits 0 1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1) "gog"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​2) "7wks"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> To get the scores of each element as well, append <span class="calibre9"><span class="calibre30">WITHSCORES</span></span> to the previous code. To get them in reverse, insert the word <span class="calibre9"><span class="calibre30">REV</span></span>, as in <span class="calibre9"><span class="calibre30">ZREVRANGE</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; ZREVRANGE visits 0 -1 WITHSCORES​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1) "prag"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​2) "10000"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​3) "7wks"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​4) "500"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​5) "gog"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​6) "9"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> But if we’re using a sorted set, it’s more likely we want to range by score, rather than by position. <span class="calibre9"><span class="calibre30">ZRANGEBYSCORE</span></span> has a slightly different syntax from <span class="calibre9"><span class="calibre30">ZRANGE</span></span>. Since the low and high range numbers are <span class="italic">inclusive</span> by default, we can make a score number <span class="italic">exclusive</span> by prefixing it with an opening paren: <span class="calibre9"><span class="calibre30">(</span></span>. So, this will return all scores where <span class="calibre9"><span class="calibre30">9 &lt;= score &lt;= 10,000</span></span>: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; ZRANGEBYSCORE visits 9 9999​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1) "gog"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​2) "7wks"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> But the following will return <span class="calibre9"><span class="calibre30">9 &lt; score &lt;= 10,000</span></span>: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; ZRANGEBYSCORE visits (9 9999​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1) "7wks"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We can also range by both positive and negative values, including infinities. This returns the entire set. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; ZRANGEBYSCORE visits -inf inf​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You can list them in reverse too, with <span class="calibre9"><span class="calibre30">ZREVRANGEBYSCORE</span></span>. </p><a></a><p class="calibre12"> Along with retrieving a range of values by rank (index) or score, <span class="calibre9"><span class="calibre30">ZREMRANGEBYRANK</span></span> and <span class="calibre9"><span class="calibre30">ZREMRANGEBYSCORE</span></span>, respectively, remove values by rank or score. </p><p class="calibre12"><span class="bold">Unions</span>
</p><a></a><p class="calibre12"> Just like the set datatype, we can create a destination key that contains the union or intersection of one or more keys. This is one of the more complex commands in Redis, since it must not only join the keys—a relatively simple operation—but also merge (possibly) differing scores. The union operation looks like this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ZUNIONSTORE destination numkeys key [key ...]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  [WEIGHTS weight [weight ...]] [AGGREGATE SUM|MIN|MAX]​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"><span class="calibre9"><span class="calibre30">destination</span></span> is the key to store into, and <span class="calibre9"><span class="calibre30">key</span></span> is one or more keys to union. <span class="calibre9"><span class="calibre30">numkeys</span></span> is simply the number of keys you’re about to join, while <span class="calibre9"><span class="calibre30">weight</span></span> is the optional number to multiply each score of the relative key by (if you have two keys, you can have two weights, and so on). Finally, <span class="calibre9"><span class="calibre30">aggregate</span></span> is the optional rule for resolving each weighted score and summing by default, but you can also choose the min or max between many scores. </p><a></a><p class="calibre12"> Let’s use this command to measure the importance of a sorted set of shortcodes. </p><a></a><p class="calibre12"> First we’ll create another key that scores our short codes by votes. Each visitor to a site can vote if they like the site or not, and each vote adds a point. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; ZADD votes 2 7wks 0 gog 9001 prag​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​(integer) 3​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We want to figure out the most important websites in our system, as some combination of votes and visits. Votes are important, but to a lesser extent, website visits also carry some weight (perhaps people are so enchanted by the website, they simply forget to vote). We want to add the two types of scores together to compute a new importance score, while giving votes a weight of double importance—multiplied by two. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​ZUNIONSTORE importance 2 visits votes WEIGHTS 1 2 AGGREGATE SUM​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​(integer) 3​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; ZRANGEBYSCORE importance -inf inf WITHSCORES​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1) "gog"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​2) "9"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​3) "7wks"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​4) "504"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​5) "prag"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​6) "28002"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This command is powerful in other ways too. For example, if we need to double all scores of a set, we can union a single key with a weight of 2 and store it back into itself. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; ZUNIONSTORE votes 1 votes WEIGHTS 2​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​(integer) 2​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; ZRANGE votes 0 -1 WITHSCORES​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1) "gog"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​2) "0"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​3) "7wks"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​4) "4"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​5) "prag"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​6) "18002"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Sorted sets contain a similar command (<span class="calibre9"><span class="calibre30">ZINTERSTORE</span></span>)to perform intersections.</p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Expiry</span></span></span></p><a></a><p class="calibre29"> A common use case for a key-value system like Redis is as a fast-access cache for data that’s more expensive to retrieve or compute. Expiration helps keep the total key set from growing unbounded, by tasking Redis to delete a key-value after a certain time has passed. </p><a></a><p class="calibre12"> Marking a key for expiration requires the <span class="calibre9"><span class="calibre30">EXPIRE</span></span> command, an existing key, and a time to live in seconds. Here we set a key and set it to expire in ten seconds. We can check whether the key <span class="calibre9"><span class="calibre30">EXISTS</span></span> within ten seconds and it returns a 1 (true). If we wait to execute, it will eventually return a 0 (false). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; SET ice "I'm melting…"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​OK​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; EXPIRE ice 10​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​(integer) 1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; EXISTS ice​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​(integer) 1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; EXISTS ice​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​(integer) 0​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Setting and expiring keys is so common that Redis provides a shortcut command called <span class="calibre9"><span class="calibre30">SETEX</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; SETEX ice 10 "I'm melting…"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You can query the time a key has to live with <span class="calibre9"><span class="calibre30">TTL</span></span>. Setting <span class="calibre9"><span class="calibre30">ice</span></span> to expire as shown earlier and checking its TTL will return the number of seconds left. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; TTL ice​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​(integer) 4​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> At any moment before the key expires, you can remove the timeout by running <span class="calibre9"><span class="calibre30">PERSIST key</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; PERSIST ice​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> For marking a countdown to a specific time, <span class="calibre9"><span class="calibre30">EXPIREAT</span></span> accepts a Unix timestamp (as seconds since January 1, 1970) rather than a number of seconds to count up to. In other words, <span class="calibre9"><span class="calibre30">EXPIREAT</span></span> is for absolute timeouts, and <span class="calibre9"><span class="calibre30">EXPIRE</span></span> is for relative timeouts. </p><a></a><p class="calibre12"> A common trick for keeping only recently used keys is to update the expire time whenever you retrieve a value. This is the most recently used (MRU) caching algorithm to ensure your most recently used keys will remain in Redis, while the neglected keys will just expire as normal. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Database Namespaces</span></span></span></p><a></a><p class="calibre29"> So far, we’ve interacted only with a single namespace. Just like buckets in Riak, sometimes we need to separate keys by namespace. For example, if you wrote an internationalized key-value store, you could store different translated responses in different namespaces. The key <span class="calibre9"><span class="calibre30">greeting</span></span> could be set to “guten tag” in a German namespace and “bonjour” in French. When a user selects their language, the application just pulls all values from the namespace assigned. </p><a></a><p class="calibre12"> In Redis nomenclature, a namespace is called a <span class="italic">database</span> and is keyed by number. So far, we’ve always interacted with the default namespace 0 (also known as database 0). Here we set <span class="calibre9"><span class="calibre30">greeting</span></span> to the English <span class="calibre9"><span class="calibre30">hello</span></span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; SET greeting hello​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​OK​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; GET greeting​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​"hello"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> But if we switch to another database via the <span class="calibre9"><span class="calibre30">SELECT</span></span> command, that key is unavailable. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; SELECT 1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​OK​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379[1]&gt; GET greeting​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​(nil)​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> And setting a value to this database’s namespace will not affect the value of the original. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379[1]&gt; SET greeting "guten tag"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​OK​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379[1]&gt; SELECT 0​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​OK​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; GET greeting​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​"hello"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Since all databases are running in the same server instance, Redis lets us shuffle keys around with the <span class="calibre9"><span class="calibre30">MOVE</span></span> command. Here we move <span class="calibre9"><span class="calibre30">greeting</span></span> to database 2: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; MOVE greeting 2​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​(integer) 2​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; SELECT 2​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​OK​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379[2]&gt; GET greeting​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​"hello"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This can be useful for running different applications against a single Redis server but still allow these multiple applications to trade data between each other. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">And There’s More</span></span></span></p><a></a><p class="calibre29"> Redis has plenty of other commands for actions such as renaming keys (<span class="calibre9"><span class="calibre30">RENAME</span></span>), determining the type of a key’s value (<span class="calibre9"><span class="calibre30">TYPE</span></span>), and deleting a key-value (<span class="calibre9"><span class="calibre30">DEL</span></span>). There’s also the painfully dangerous <span class="calibre9"><span class="calibre30">FLUSHDB</span></span>, which removes all keys from this Redis database, and its apocalyptic cousin, <span class="calibre9"><span class="calibre30">FLUSHALL</span></span>, which removes all keys from all Redis databases. Check out the online documentation for the full list of Redis commands. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Day 1 Wrap-Up</span></span></span></p><a></a><p class="calibre29"> The datatypes of Redis and the complex queries it can perform make it much more than a standard key-value store. It can act as a stack, queue, or priority queue; can be an object store (via hashes); and even can perform complex set operations such as unions, intersections, and subtractions (diff). It provides many atomic commands, and for those multistep commands, it provides a transaction mechanism. It has a built-in ability to expire keys, which is useful as a cache. </p><p class="calibre12"><span class="bold"><span class="calibre28">Day 1 Homework</span></span></p><p class="calibre37"><span class="bold">Find</span>
</p><a></a><p class="calibre12">Find the complete Redis commands documentation, as well as the Big-O notated (O(x)) time complexity under the command details.</p><p class="calibre12"><span class="bold">Do</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Install your favorite programming language driver and connect to the Redis server. Insert and increment a value within a transaction.</p></li><li value="2" class="calibre36"><p class="calibre22">Using your driver of choice, create a program that reads a blocking list and outputs somewhere (console, file, Socket.io, and so on) and another that writes to the same list.</p></li></ol><p class="calibre12"><img src="images/00045.jpg" class="calibre66"/></p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos1748754" class="calibre1"><p class="calibre24" id="filepos1748759"><span class="calibre25"><span class="bold"><span class="calibre26">8.3 Day 2: Advanced Usage, Distribution</span></span></span></p><a></a><p class="calibre27"> Day 1 introduced us to Redis as a data structure server. Today we’ll build on that foundation by looking at some of the advanced functions provided by Redis, such as pipelining, the publish-subscribe model, system configuration, and replication. Beyond that, we’ll look at how to create a Redis cluster, store a lot of data quickly, and use an advanced technique introducing Bloom filters. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">A Simple Interface</span></span></span></p><a></a><p class="calibre29"> At 20,000 lines of source code, Redis is a fairly simple project. But beyond code size, it has a simple interface that accepts the very strings we have been writing in the console. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Telnet</span></span></p><a></a><p class="calibre37"> We can interact without the command-line interface by streaming commands through TCP on our own via telnet and terminating the command with a carriage return line feed (CRLF, or <span class="calibre9"><span class="calibre30">\r\n</span></span>). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/redis/telnet.sh"><span class="calibre41"><span class="calibre13"><span class="underline">redis/telnet.sh</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ telnet localhost 6379​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Trying 127.0.0.1...​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Connected to localhost.​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Escape character is </span><span class="calibre9"><span class="italic"><span class="calibre38">'^]'</span></span></span><span class="calibre9">.​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">SET</span></span></span><span class="calibre9"> test hello​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">① </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​+OK ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​GET test​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">② </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$5 ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​hello​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​SADD stest 1 99​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">③ </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​:2 ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​SMEMBERS stest​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold">④ </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​*2 ​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$2​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​99​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"><span class="calibre69"><span class="calibre30">Ctrl</span></span>-<span class="calibre69"><span class="calibre30">]</span></span>
</p><a></a><p class="calibre12"> We can see that our input is the same as we provided to the console, but the console cleaned up the responses a bit. </p><a></a><p class="calibre12">① Redis streams the <span class="calibre9"><span class="calibre30">OK</span></span> status prefixed by a <span class="calibre9"><span class="calibre30">+</span></span> sign. </p><a></a><p class="calibre12">② Before it returned the string <span class="calibre9"><span class="italic"><span class="calibre38">hello</span></span></span>, it sent <span class="calibre9"><span class="calibre30">$5</span></span>, which means “the following string is five characters.” </p><a></a><p class="calibre12">③ The number <span class="calibre9"><span class="calibre30">2</span></span> after we add two set items to the test key is prefixed by <span class="calibre9"><span class="calibre30">:</span></span> to represent an integer (two values were added successfully). </p><a></a><p class="calibre12">④ Finally, when we requested two items, the first line returned begins with an asterisk and the number 2—meaning there are two complex values about to be returned. The next two lines are just like the <span class="calibre9"><span class="italic"><span class="calibre38">hello</span></span></span> string but contain the string <span class="calibre9"><span class="italic"><span class="calibre38">1</span></span></span>, followed by the string <span class="calibre9"><span class="italic"><span class="calibre38">99</span></span></span>. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Pipelining</span></span></p><a></a><p class="calibre37"> We can also stream our own strings one at a time by using the BSD netcat (<span class="calibre9"><span class="calibre30">nc</span></span>) command, which you may find is already installed on many Unix machines. With netcat, we must specifically end a line with CRLF (telnet did this for us implicitly). We also sleep for a second after the echo command has finished to give some time for the Redis server to return. Some <span class="calibre9"><span class="calibre30">nc</span></span> implementations have a <span class="calibre9"><span class="calibre30">-q</span></span> option, thus negating the need for a sleep, but not all do, so feel free to try it. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">(echo -en "ECHO hello\r\n"; sleep 1) | nc localhost 6379</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$5​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​hello​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> We can take advantage of this level of control by <span class="italic">pipelining</span> our commands, or streaming multiple commands in a single request. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">(echo -en "PING\r\nPING\r\nPING\r\n"; sleep 1) | nc localhost 6379</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​+PONG​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​+PONG​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​+PONG​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This can be far more efficient than pushing a single command at a time and should always be considered if it makes sense to do so—especially in transactions. Just be sure to end every command with <span class="calibre9"><span class="calibre30">\r\n</span></span>, which is a required delimiter for the server. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">publish-subscribe</span></span></span></p><a></a><p class="calibre29"> Yesterday we were able to implement a rudimentary blocking queue using the list datatype. We queued data that could be read by a blocking pop command. Using that queue, we made a very basic publish-subscribe model. Any number of messages could be pushed to this queue, and a single queue reader would pop messages as they were available. This is powerful but limited. Under many circumstances we want a slightly inverted behavior, where several subscribers want to read the announcements of a single publisher, as shown in Figure 37, <a href="#filepos1760570"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">A publisher sends a message to all subscribers</span></span><span class="calibre13"><span class="underline">​</span></span></a>. Redis provides some specialized publish-subscribe (or pub-sub) commands. </p><a id="filepos1760570"></a><blockquote class="calibre10"><img src="images/00026.jpg" class="calibre114"/></blockquote><hr class="calibre51"/><blockquote class="calibre52"><span class="bold">Figure 37. A publisher sends a message to all subscribers.</span></blockquote><a></a><p class="calibre12"> Let’s improve on the commenting mechanism we made yesterday using blocking lists, by allowing a user to post a comment to multiple subscribers (as opposed to just one). We start with some subscribers that connect to a key, known as a <span class="italic">channel</span> in pub-sub nomenclature. Let’s start two more clients and subscribe to the comments channel. Subscribing will cause the CLI to block. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; SUBSCRIBE comments​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​Reading messages... (press Ctrl-C to quit)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1) "subscribe"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​2) "comments"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​3) (integer) 1​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> With two subscribers, we can publish any string we want as a message to the <span class="calibre9"><span class="calibre30">comments</span></span> channel. The <span class="calibre9"><span class="calibre30">PUBLISH</span></span> command will return the integer 2, meaning two subscribers received it. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; PUBLISH comments "Check out this shortcoded site! 7wks"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​(integer) 2​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Both of the subscribers will receive a <span class="italic">multibulk reply</span> (a list) of three items: the string “message,” the channel name, and the published message value. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1) "message"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​2) "comments"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​3) "Check out this shortcoded site! 7wks"​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> When your clients want to no longer receive correspondence, they can execute the <span class="calibre9"><span class="calibre30">UNSUBSCRIBE comments</span></span> command to disconnect from the comments channel or simply <span class="calibre9"><span class="calibre30">UNSUBSCRIBE</span></span> alone to disconnect from all channels. However, note in <span class="calibre9"><span class="calibre30">redis-cli</span></span> that you will have to press <span class="calibre69"><span class="calibre30">Ctrl</span></span>+<span class="calibre69"><span class="calibre30">C</span></span> to break the connection. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Server Info</span></span></span></p><a></a><p class="calibre29"> Before getting into changing Redis’s system settings, it’s worth taking a quick look at the <span class="calibre9"><span class="calibre30">INFO</span></span> command, since changing settings values will alter some of these values as well. <span class="calibre9"><span class="calibre30">INFO</span></span> outputs a list of server data, including version, process ID, memory used, and uptime. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; INFO​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis_version:2.4.5​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis_git_sha1:00000000​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis_git_dirty:0​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​arch_bits:64​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​multiplexing_api:kqueue​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​process_id:54046​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​uptime_in_seconds:4​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​uptime_in_days:0​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​lru_clock:1807217​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​…​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You may want to revisit this command again in this chapter, because it provides a useful snapshot of this server’s global information and settings. It even provides information on durability, memory fragmentation, and replication server status. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Redis Configuration</span></span></span></p><a></a><p class="calibre29"> So far, we’ve only used Redis out of the box. Much of Redis’s power comes from its configurability, allowing you to tailor settings to your use case. The <span class="calibre9"><span class="calibre30">redis.conf</span></span> file that comes with the distribution—found in <span class="calibre9"><span class="calibre30">/etc/redis</span></span> on *nix systems—is fairly self-explanatory, so we’re going to cover only a portion of the file. We’ll go through a few of the common settings in order. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​daemonize no​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​port 6379​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​loglevel verbose​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​logfile stdout​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​database 16​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> By default <span class="calibre9"><span class="calibre30">daemonize</span></span> is set to <span class="calibre9"><span class="italic"><span class="calibre38">no</span></span></span>, which is why the server always starts up in the foreground. This is nice for testing but not very production friendly. Changing this value to <span class="calibre9"><span class="italic"><span class="calibre38">yes</span></span></span> will run the server in the background while setting the server’s process ID in a pid file. </p><a></a><p class="calibre12"> The next line is the default port number for this server, port 6379. This can be especially useful when running multiple Redis servers on a single machine. </p><a></a><p class="calibre12"><span class="calibre9"><span class="calibre30">loglevel</span></span> defaults to <span class="calibre9"><span class="calibre30">verbose</span></span>, but it’s good to set it to <span class="calibre9"><span class="calibre30">notice</span></span> or <span class="calibre9"><span class="calibre30">warning</span></span> in production. <span class="calibre9"><span class="calibre30">logfile</span></span> outputs to stdout (standard output, the console), but a filename is necessary if you run in daemonize mode. </p><a></a><p class="calibre12"><span class="calibre9"><span class="calibre30">database</span></span> sets the number of Redis databases we have available. We saw how to switch between databases yesterday. If you plan to only ever use a single database namespace, it’s not a bad idea to set this to 1. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Durability</span></span></p><a></a><p class="calibre37"> Redis has a few persistence options. First is no persistence at all, which will simply keep all values in main memory. If you’re running a basic caching server, this is a reasonable choice since durability always increases latency. </p><p class="calibre12" id="filepos1772654"> One of the things that sets Redis apart from other fast-access caches like memcached<a href="#filepos1946379"><span class="calibre13"><span class="underline">[54]</span></span></a> is its built-in support for storing values to disk. By default, key-value pairs are only occasionally saved. You can run the <span class="calibre9"><span class="calibre30">LASTSAVE</span></span> command to get a Unix timestamp of the last time a Redis disk write succeeded, or you can read the <span class="calibre9"><span class="calibre30">last_save_time</span></span> field from the server <span class="calibre9"><span class="calibre30">INFO</span></span> output. </p><a></a><p class="calibre12"> You can force durability by executing the <span class="calibre9"><span class="calibre30">SAVE</span></span> command (or <span class="calibre9"><span class="calibre30">BGSAVE</span></span>, to asynchronously save in the background). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; SAVE​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If you read the redis-server log, you will see lines similar to this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[46421] 10 Oct 19:11:50 * Background saving started by pid 52123​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[52123] 10 Oct 19:11:50 * DB saved on disk​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[46421] 10 Oct 19:11:50 * Background saving terminated with success​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Another durability method is to alter the snapshotting settings in the configuration file. </p><a></a><p class="calibre12"><span class="bold">Snapshotting</span>
</p><a></a><p class="calibre12"> We can alter the rate of storage to disk by adding, removing, or altering one of the save fields. By default there are three, prefixed by the <span class="calibre9"><span class="calibre30">save</span></span> keyword followed by a time in seconds and a minimum number of keys that must change before a write to disk occurs. </p><a></a><p class="calibre12"> For example, to trigger a save every 5 minutes (300 seconds) if any keys change at all, you would write the following: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​save 300 1​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The configuration has a good set of defaults. The set means if 10,000 keys change, save in 60 seconds; if 10 keys change, save in 300 seconds, and any key changes will be saved in at least 900 seconds (15 minutes). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​save 900 1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​save 300 10​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​save 60 10000​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You can add as many or few save lines as necessary to specify precise thresholds. </p><a></a><p class="calibre12"><span class="bold">Append-Only File</span>
</p><a></a><p class="calibre12"> Redis is <span class="italic">eventually durable</span> by default, in that it asynchronously writes values to disk in intervals defined by our save settings, or it is forced to write by client-initiated commands. This is acceptable for a second-level cache or session server but is insufficient for storing data you need to be durable, like financial data. If a Redis server crashes, our users might not appreciate having lost money. </p><a></a><p class="calibre12"> Redis provides an append-only file (<span class="calibre9"><span class="calibre30">appendonly.aof</span></span>) that keeps a record of all write commands. This is like the write-ahead logging we saw in Chapter 4, <a href="#filepos618173"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">HBase</span></span><span class="calibre13"><span class="underline">​</span></span></a>. If the server crashes before a value is saved, it executes the commands on startup, restoring its state; <span class="calibre9"><span class="calibre30">appendonly</span></span> must be enabled by setting it to <span class="calibre9"><span class="calibre30">yes</span></span> in the <span class="calibre9"><span class="calibre30">redis.conf</span></span> file. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​appendonly yes​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Then we must decide how often a command is appended to the file. Setting <span class="calibre9"><span class="calibre30">always</span></span> is the more durable, since every command is saved. It’s also slow, which often negates the reason people have for using Redis. By default <span class="calibre9"><span class="calibre30">everysec</span></span> is enabled, which saves up and writes commands only once a second. This is a decent trade-off, since it’s fast enough, and worst case you’ll lose only the last one second of data. Finally, <span class="calibre9"><span class="calibre30">no</span></span> is an option, which just lets the OS handle flushing. It can be fairly infrequent, and you’re often better off skipping the append-only file altogether rather than choosing it. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​# appendfsync always​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​appendfsync everysec​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​# appendfsync no​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Append-only has more detailed parameters, which may be worth reading about in the config file when you need to respond to specific production issues. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Security</span></span></p><a></a><p class="calibre37"> Although Redis is not natively built to be a fully secure server, you may run across the <span class="calibre9"><span class="calibre30">requirepass</span></span> setting and <span class="calibre9"><span class="calibre30">AUTH</span></span> command in the Redis documentation. These can be safely ignored, since they are merely a scheme for setting a plain-text password. Since a client can try nearly 100,000 passwords a second, it’s almost a moot point, beyond the fact that plain-text passwords are inherently unsafe anyway. If you want Redis security, you’re better off with a good firewall and SSH security. </p><a></a><p class="calibre12"> Interestingly, Redis provides command-level security through obscurity, by allowing you to hide or suppress commands. This will rename the <span class="calibre9"><span class="calibre30">FLUSHALL</span></span> command (remove all keys from the system) into some hard-to-guess value like c283d93ac9528f986023793b411e4ba2: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​rename-command FLUSHALL c283d93ac9528f986023793b411e4ba2​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If we attempt to execute <span class="calibre9"><span class="calibre30">FLUSHALL</span></span> against this server, we’ll be hit with an error. The secret command works instead. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; FLUSHALL​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​(error) ERR unknown command 'FLUSHALL'​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; c283d93ac9528f986023793b411e4ba2​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​OK​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Or better yet, we can disable the command entirely by setting it to a blank string. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​rename-command FLUSHALL ""​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> You can set any number of commands to a blank string, allowing you a modicum of customization over your command environment. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre28">Tweaking Parameters</span></span></p><a></a><p class="calibre37"> There are several more advanced settings for speeding up slow query logs, encoding details, making latency tweaks, and importing external config files. Keep in mind, though, that if you run across some documentation about Redis virtual memory, you’re best to avoid it if possible. It’s been deprecated in Redis 2.4 and may be removed in future versions. </p><a></a><p class="calibre12"> To aid in testing your server configuration, Redis provides an excellent benchmarking tool. It connects locally to port 6379 by default and issues 10,000 requests using 50 parallel clients. We can execute 100,000 requests with the <span class="calibre9"><span class="calibre30">-n</span></span> argument. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">redis-benchmark -n 100000</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​====== PING (inline) ======​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  100000 requests completed in 3.05 seconds​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  50 parallel clients​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  3 bytes payload​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  keep alive: 1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​5.03% &lt;= 1 milliseconds​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​98.44% &lt;= 2 milliseconds​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​99.92% &lt;= 3 milliseconds​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​100.00% &lt;= 3 milliseconds​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​32808.40 requests per second​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​…​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Other commands are tested as well, like <span class="calibre9"><span class="calibre30">SADD</span></span> and <span class="calibre9"><span class="calibre30">LRANGE</span></span>; the more complex ones generally taking more time. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Master-Slave Replication</span></span></span></p><a></a><p class="calibre29"> Just like other NoSQL databases we’ve seen (such as MongoDB and Neo4j), Redis supports master-slave replication. One server is the master by default if you don’t set it as a slave of anything. Data will be replicated to any number of slave servers. </p><a></a><p class="calibre12"> Making slave servers is easy. We first need a copy of our <span class="calibre9"><span class="calibre30">redis.conf</span></span> file. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">cp redis.conf redis-s1.conf</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The file will remain largely the same but with the following changes: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​port 6380​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​slaveof 127.0.0.1 6379​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If all went according to plan, you should see something similar to the following in the slave server’s log when you start it: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">redis-server redis-s1.conf</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[9003] 16 Oct 23:51:52 * Connecting to MASTER...​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[9003] 16 Oct 23:51:52 * MASTER &lt;-&gt; SLAVE sync started​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[9003] 16 Oct 23:51:52 * Non blocking connect for SYNC fired the event.​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[9003] 16 Oct 23:51:52 * MASTER &lt;-&gt; SLAVE sync: receiving 28 bytes from master​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[9003] 16 Oct 23:51:52 * MASTER &lt;-&gt; SLAVE sync: Loading DB in memory​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​[9003] 16 Oct 23:51:52 * MASTER &lt;-&gt; SLAVE sync: Finished with success​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> And you should see the string <span class="calibre9"><span class="calibre30">1 slaves</span></span> output in the master log. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; SADD meetings "StarTrek Pastry Chefs" "LARPers Intl."​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If we connect the command line to our slave, we should receive our meeting list. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6380&gt; SMEMBERS meetings​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​1) "StarTrek Pastry Chefs"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​2) "LARPers Intl."​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> In production, you’ll generally want to implement replication for availability or backup purposes and thus have Redis slaves on different machines. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Data Dump</span></span></span></p><a></a><p class="calibre29"> So far, we’ve talked a lot about how fast Redis is, but it’s hard to get a feel for it without playing with a bit more data. </p><p class="calibre12" id="filepos1794158"> Let’s insert a large dataset into our Redis server. You can keep the slave running if you like, but a laptop or desktop might run quicker if you have just a single master server. We’re going to grab a list of more than 2.5 million published book titles, keyed by their International Standard Book Number (ISBN) from Freebase.com.<a href="#filepos1946379"><span class="calibre13"><span class="underline">[55]</span></span></a>
</p><a></a><p class="calibre12"> You’ll first need the <span class="calibre9"><span class="calibre30">redis</span></span> Ruby gem. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">gem install redis</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> There are several ways to go about inserting a large dataset, and they get progressively faster but more complex. </p><a></a><p class="calibre12"> The simplest method is to simply iterate through a list of data and execute <span class="calibre9"><span class="calibre30">SET</span></span> for each value using the standard <span class="calibre9"><span class="calibre30">redis-rb</span></span> client. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/redis/isbn.rb"><span class="calibre41"><span class="calibre13"><span class="underline">redis/isbn.rb</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​LIMIT = 1.0 / 0  </span><span class="calibre9"><span class="italic"><span class="calibre46"># 1.0/0 is Infinity in Ruby</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre46"># %w{rubygems hiredis redis/connection/hiredis}.each{|r| require r}</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre38">%w{rubygems time redis}</span></span></span><span class="calibre9">.each{|r| require r}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$redis = Redis.new(:host =&gt; </span><span class="calibre9"><span class="italic"><span class="calibre38">"127.0.0.1"</span></span></span><span class="calibre9">, :port =&gt; 6379)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$redis.flushall​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​count, start = 0, Time.now​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​File.open(ARGV[0]).each </span><span class="calibre9"><span class="bold"><span class="calibre44">do</span></span></span><span class="calibre9"> |line|​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  count += 1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">next</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> count == 1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  isbn, _, _, title = line.split(</span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">\t</span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">next</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> isbn.empty? || title == </span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">\n</span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  $redis.set(isbn, title.strip)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="italic"><span class="calibre46"># set the LIMIT value if you do not wish to populate the entire dataset</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">break</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> count &gt;= LIMIT​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​puts </span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">#{count}</span><span class="calibre9"><span class="italic"><span class="calibre38"> items in </span></span></span><span class="calibre9">#{Time.now - start}</span><span class="calibre9"><span class="italic"><span class="calibre38"> seconds"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">ruby isbn.rb isbn.tsv</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​2456384 items in 266.690189 seconds​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If you want to speed up insertion and are not running JRuby, you can optionally install the <span class="calibre9"><span class="calibre30">hiredis</span></span> gem. It’s a C driver that is considerably faster than the native Ruby driver. Then uncomment the <span class="calibre9"><span class="calibre30">hiredis</span></span>  <span class="calibre9"><span class="calibre30">require</span></span> line in order to load the driver. You may not see a large improvement for this type of CPU-bound operation, but we highly recommend <span class="calibre9"><span class="calibre30">hiredis</span></span> for production Ruby use. </p><a></a><p class="calibre12"> You will see a big improvement with pipelining. Here we batch 1,000 lines at a time and pipeline their insertion. It reduced our insertion time by more than 300 percent. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/redis/isbn_pipelined.rb"><span class="calibre41"><span class="calibre13"><span class="underline">redis/isbn_pipelined.rb</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​BATCH_SIZE = 1000​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​LIMIT = 1.0 / 0  </span><span class="calibre9"><span class="italic"><span class="calibre46"># 1.0/0 is Infinity in Ruby</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre46"># %w{rubygems hiredis redis/connection/hiredis}.each{|r| require r}</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre38">%w{rubygems time redis}</span></span></span><span class="calibre9">.each{|r| require r}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$redis = Redis.new(:host =&gt; </span><span class="calibre9"><span class="italic"><span class="calibre38">"127.0.0.1"</span></span></span><span class="calibre9">, :port =&gt; 6379)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$redis.flushall​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre46"># set line data as a single batch update</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">def</span></span></span><span class="calibre9"> flush(batch)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  $redis.pipelined </span><span class="calibre9"><span class="bold"><span class="calibre44">do</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    batch.each </span><span class="calibre9"><span class="bold"><span class="calibre44">do</span></span></span><span class="calibre9"> |saved_line|​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      isbn, _, _, title = line.split(</span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">\t</span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="bold"><span class="calibre44">next</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> isbn.empty? || title == </span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">\n</span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      $redis.set(isbn, title.strip)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  batch.clear​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​batch = []​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​count, start = 0, Time.now​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​File.open(ARGV[0]).each </span><span class="calibre9"><span class="bold"><span class="calibre44">do</span></span></span><span class="calibre9"> |line|​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  count += 1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">next</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> count == 1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="italic"><span class="calibre46"># push lines into an array</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  batch &lt;&lt; line​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="italic"><span class="calibre46"># if the array grows to BATCH_SIZE, flush it</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> batch.size == BATCH_SIZE​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    flush(batch)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    puts </span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">#{count-1}</span><span class="calibre9"><span class="italic"><span class="calibre38"> items"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="italic"><span class="calibre46"># set the LIMIT value if you do not wish to populate the entire dataset</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">break</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> count &gt;= LIMIT​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre46"># flush any remaining values</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​flush(batch)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​puts </span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">#{count-1}</span><span class="calibre9"><span class="italic"><span class="calibre38"> items in </span></span></span><span class="calibre9">#{Time.now - start}</span><span class="calibre9"><span class="italic"><span class="calibre38"> seconds"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">ruby isbn_pipelined.rb isbn.tsv</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​2666642 items in 79.312975 seconds​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This reduces the number of Redis connections required, but building the pipelined dataset has some overhead of its own. You should experiment with different numbers of batched operations when pipelining in production. </p><a></a><p class="calibre12"> As a side note to Ruby users, if your application is nonblocking via Event Machine, the Ruby driver can use em-synchrony via <span class="calibre9"><span class="calibre30">EM::Protocols::Redis.connect</span></span>. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Redis Cluster</span></span></span></p><a></a><p class="calibre29"> Beyond simple replication, many Redis clients provide an interface for building a simple ad hoc distributed Redis cluster. The Ruby client redis-rb supports a consistent-hashing managed cluster. You may recall consistent hashing from the Riak chapter, where nodes can be added and dropped without having to expire most keys. This is the same idea, only managed via a client rather than by the servers themselves. </p><a></a><p class="calibre12"> First we need another server. Unlike the master-slave setup, both of our servers will take the master (default) configuration. We copied the <span class="calibre9"><span class="calibre30">redis.conf</span></span> file and changed the port to 6380. That’s all that’s required for the servers. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/redis/isbn_cluster.rb"><span class="calibre41"><span class="calibre13"><span class="underline">redis/isbn_cluster.rb</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​LIMIT = 10000​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre38">%w{rubygems time redis}</span></span></span><span class="calibre9">.each{|r| require r}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​require </span><span class="calibre9"><span class="italic"><span class="calibre38">'redis/distributed'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$redis = Redis::Distributed.new([​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="italic"><span class="calibre38">"redis://localhost:6379/"</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">"redis://localhost:6380/"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​])​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$redis.flushall​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​count, start = 0, Time.now​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​File.open(ARGV[0]).each </span><span class="calibre9"><span class="bold"><span class="calibre44">do</span></span></span><span class="calibre9"> |line|​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  count += 1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">next</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> count == 1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  isbn, _, _, title = line.split(</span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">\t</span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">next</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> isbn.empty? || title == </span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">\n</span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  $redis.set(isbn, title.strip)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="italic"><span class="calibre46"># set the LIMIT value if you do not wish to populate the entire dataset</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">break</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> count &gt;= LIMIT​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​puts </span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">#{count}</span><span class="calibre9"><span class="italic"><span class="calibre38"> items in </span></span></span><span class="calibre9">#{Time.now - start}</span><span class="calibre9"><span class="italic"><span class="calibre38"> seconds"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Bridging between two or more servers requires only some minor changes to our existing ISBN client. First we need to require the <span class="calibre9"><span class="calibre30">redis/distributed</span></span> file from the redis gem. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​require 'redis/distributed'​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Then replace the Redis client with Redis::Distributed and pass in an array of server URIs. Each URI requires the <span class="calibre9"><span class="calibre30">redis</span></span> scheme, server (localhost), and port. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$redis = Redis::Distributed.new([​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "redis://localhost:6379/",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "redis://localhost:6380/"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​])​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Running the client is the same as before. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ ruby isbn_cluster.rb isbn.tsv​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> But a lot more work is being done by the client, since it handles computing which keys are stored on which servers. You can validate that keys are stored on separate servers by attempting to retrieve the same ISBN key from each server through the CLI. Only one client will <span class="calibre9"><span class="calibre30">GET</span></span> a value. But as long as you retrieve keys set through the same Redis::Distributed configuration, the client will access the values from the correct servers. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Bloom Filters</span></span></span></p><a></a><p class="calibre29"> Owning a unique term is an excellent strategy for making something easily findable online. If you were to write a book named <span class="italic">The Jabbyredis</span>, you would be fairly certain any search engine would link to you. Let’s write a script that lets someone quickly check whether a word is unique against all words used in all titles in the ISBN catalog. We can use a Bloom filter to test whether a word is used. </p><a></a><p class="calibre12"> A Bloom filter is a probabilistic data structure that checks for the nonexistence of an item in a set, first covered in <a href="#filepos716429"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Compression and Bloom Filters</span></span><span class="calibre13"><span class="underline">​</span></span></a>. Although it can return a false positive, it cannot return a false negative. This is a useful when you need to quickly discover whether a value does not exist in a system. </p><a></a><p class="calibre12"> Bloom filters succeed at discovering nonexistence by converting a value to a very sparse sequence of bits and comparing that to a union of every value’s bits. In other words, when a new value is added, it is OR’d against the current Bloom filter bit sequence. When you want to check whether the value is already in the system, you perform an AND against the Bloom filter’s sequence. If the value has any true bits that aren’t also true in the Bloom filter’s corresponding buckets, then the value was never added. In other words, this value is definitely not in the Bloom filter. Following is a graphic representation of this concept. </p><p class="calibre12"><img src="images/00001.jpg" class="calibre115"/></p><a></a><p class="calibre22"> Let’s write a program that loops through a bunch of ISBN book data, extracts and simplifies each book’s title works, and splits them into individual words. Each new word encountered is checked against the Bloom filter. If the Bloom filter returns false, meaning the word does not exist in our Bloom filter, then go ahead and add it. Just to follow along, we can output any new word that’s added. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ gem install bloomfilter-rb​</span><span class="calibre9">​</span></p></td></tr></table><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/redis/isbn_bf.rb"><span class="calibre41"><span class="calibre13"><span class="underline">redis/isbn_bf.rb</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre46"># LIMIT = 1.0 / 0  # 1.0/0 is Infinity in Ruby</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​LIMIT= 10000​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre38">%w{rubygems time bloomfilter-rb}</span></span></span><span class="calibre9">.each{|r| require r}​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​bloomfilter = BloomFilter::Redis.new(:size =&gt; 1000000)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$redis = Redis.new(:host =&gt; </span><span class="calibre9"><span class="italic"><span class="calibre38">"127.0.0.1"</span></span></span><span class="calibre9">, :port =&gt; 6379)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$redis.flushall​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​count, start = 0, Time.now​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​File.open(ARGV[0]).each </span><span class="calibre9"><span class="bold"><span class="calibre44">do</span></span></span><span class="calibre9"> |line|​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  count += 1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">next</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> count == 1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  _, _, _, title = line.split(</span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">\t</span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">next</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> title == </span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">\n</span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  words = title.gsub(/[^\w\s]+/, </span><span class="calibre9"><span class="italic"><span class="calibre38">''</span></span></span><span class="calibre9">).downcase​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="italic"><span class="calibre46"># puts words</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  words = words.split(</span><span class="calibre9"><span class="italic"><span class="calibre38">' '</span></span></span><span class="calibre9">)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  words.each </span><span class="calibre9"><span class="bold"><span class="calibre44">do</span></span></span><span class="calibre9"> |word|​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre46"># skip any keyword already in the bloomfilter</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">next</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> bloomfilter.include?(word)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre46"># output the very unique word</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    puts word​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre46"># add the new word to the bloomfilter</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    bloomfilter.insert(word)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="italic"><span class="calibre46"># set the LIMIT value if you do not wish to populate the entire dataset</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">break</span></span></span><span class="calibre9"> </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9"> count &gt;= LIMIT​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​puts </span><span class="calibre9"><span class="italic"><span class="calibre38">"Contains Jabbyredis? </span></span></span><span class="calibre9">#{bloomfilter.include?(</span><span class="calibre9"><span class="italic"><span class="calibre38">'jabbyredis'</span></span></span><span class="calibre9">)}</span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​puts </span><span class="calibre9"><span class="italic"><span class="calibre38">"</span></span></span><span class="calibre9">#{count}</span><span class="calibre9"><span class="italic"><span class="calibre38"> lines in </span></span></span><span class="calibre9">#{Time.now - start}</span><span class="calibre9"><span class="italic"><span class="calibre38"> seconds"</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Ruby wunderkind Ilya Grigorik created this Redis-backed Bloom filter, but the concepts are transferable to any language. </p><a></a><p class="calibre12"> Running the client uses the same ISBN file but needs only the book titles. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ ruby isbn_bf.rb isbn.tsv​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> At the start of the output you should see plenty of common words, like <span class="italic">and</span> and <span class="italic">the</span>. Near the end of the set, the words become increasingly esoteric, like <span class="italic">unindustria</span>. </p><p class="calibre12" id="filepos1846270"> The upside with this approach is the ability to detect duplicate words. The downside is that a few false positives will seep through—the Bloom filter may flag a word we have never seen before. This is why in a real-world use case you would perform some secondary check, such as a slower database query to a system of record, which should happen only a small percentage of the time, presuming a large enough filter size, which is computable.<a href="#filepos1946379"><span class="calibre13"><span class="underline">[56]</span></span></a>
</p><p class="calibre12"><span class="bold"><span class="calibre28">SETBIT and GETBIT</span></span></p><a></a><p class="calibre37"> As we mentioned earlier, Bloom filters function by flipping certain bits in a sparse binary field. The Redis Bloom filter implementation we just used takes advantage of two relatively recent Redis commands that perform just such actions: <span class="calibre9"><span class="calibre30">SETBIT</span></span> and <span class="calibre9"><span class="calibre30">GETBIT</span></span>. </p><a></a><p class="calibre12"> Like all Redis commands, <span class="calibre9"><span class="calibre30">SETBIT</span></span> is fairly descriptive. The command sets a single bit (either 1 or 0) at a certain location in a bit sequence, starting from zero. It’s a common use case for high-performance multivariate flagging—it’s faster to flip a few bits than write a set of descriptive strings. </p><a></a><p class="calibre12"> If we want to keep track of the toppings on a hamburger, we can assign each type of topping to a bit position, such as ketchup = 0, mustard = 1, onion = 2, lettuce = 3. So, a hamburger with only mustard and onion could be represented as 0110 and set in the command line: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; SETBIT my_burger 1 1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​(integer) 0​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; SETBIT my_burger 2 1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​(integer) 0​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Later, a process can check whether my burger should have lettuce or mustard. If zero is returned, the answer is false—one if true. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; GETBIT my_burger 3​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​(integer) 0​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redis 127.0.0.1:6379&gt; GETBIT my_burger 1​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​(integer) 1​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The Bloom filter implementation takes advantage of this behavior by hashing a value as a multibit value. It calls <span class="calibre9"><span class="calibre30">SETBIT X 1</span></span> for each on position in an <span class="calibre9"><span class="calibre30">insert</span></span> (where X is the bit position) and verifies existence by calling <span class="calibre9"><span class="calibre30">GETBIT X</span></span> on <span class="calibre9"><span class="calibre30">include?</span></span>—returning false if any <span class="calibre9"><span class="calibre30">GETBIT</span></span> position returns 0. </p><a></a><p class="calibre12"> Bloom filters are excellent for reducing unnecessary traffic to a slower underlying system, be it a slower database, limited resource, or network request. If you have a slower database of IP addresses and you want to track all new users to your site, you can use a Bloom filter to first check whether the IP address exists in your system. If the Bloom filter returns false, you know the IP address has yet to be added and can respond accordingly. If the Bloom filter returns true, this IP address may or may not exist on the back end and requires a secondary lookup to be sure. This is why computing the correct size is important—a well-sized Bloom filter can reduce (but not eliminate) the error rate or the likelihood of a false positive. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Day 2 Wrap-Up</span></span></span></p><a></a><p class="calibre29"> Today we rounded out our Redis investigation by moving beyond simple operations into squeezing every last bit of speed out of a very fast system. Redis provides for fast and flexible data structure storage and simple manipulations as we saw in Day 1 but is equally adept at more complex behaviors by way of built-in publish-subscribe functions and bit operations. It’s also highly configurable, with many durability and replication settings that conform to whatever your needs may be. It also supports some nice third-party enhancements, like Bloom filters and clustering. </p><a></a><p class="calibre12"> This also concludes major operations for the Redis data structure store. Tomorrow we’re going to do something a bit different, by using Redis as the cornerstone of a polyglot persistence setup along with CouchDB and Neo4j. </p><p class="calibre12"><span class="bold"><span class="calibre28">Day 2 Homework</span></span></p><p class="calibre37"><span class="bold">Find</span>
</p><a></a><p class="calibre12">Find out what messaging patterns are, and discover how many Redis can implement.</p><p class="calibre12"><span class="bold">Do</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Run the ISBN populator script with all snapshotting and the append-only file turned off. Then try running with <span class="calibre9"><span class="calibre30">appendfsync</span></span> set to <span class="calibre9"><span class="calibre30">always</span></span>, marking the speed difference.</p></li><li value="2" class="calibre36"><p class="calibre22">Using your favorite programming language’s web framework, try to build a simple URL-shortening service backed by Redis with an input box for the URL and a simple redirect based on the URL. Back it up with a Redis master-slave replicated cluster across multiple nodes as your back end.</p></li></ol><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos1853801" class="calibre1"><p class="calibre24" id="filepos1853806"><span class="calibre25"><span class="bold"><span class="calibre26">8.4 Day 3: Playing with Other Databases</span></span></span></p><a></a><p class="calibre27"> Today we’re wrapping up our final database chapter by inviting some previous databases to play. Yet Redis will hold a starring role by making our interaction with other databases faster and easier. </p><a></a><p class="calibre12"> We’ve learned throughout this book that different databases have different strengths, so many modern system designs have moved toward a polyglot persistence model, where many databases each play a role in the system. You’ll learn how to build one of these projects using CouchDB as the system of record (the canonical data source), Neo4j to handle data relationships, and Redis to help with data population and caching. Consider this your final exam. </p><a></a><p class="calibre12"> Note that this project is not the authors’ endorsement of any specific set of databases, languages, or frameworks over another but rather a showcase of how multiple databases can work together, leveraging the capabilities of each in pursuit of a single goal. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">A Polyglot Persistent Service</span></span></span></p><a></a><p class="calibre29"> Our polyglot persistence service will act as a front end to a band information service. We want to store a list of musical band names, the artists who performed in those bands, and any number of roles each artist played in the band, from lead singer to backup keytar player. Each of three databases—Redis, CouchDB, and Neo4j—will handle a different aspect of our band management system. </p><blockquote class="calibre40"><span class="calibre41"><span class="bold">The Rise of Polyglot Persistence</span></span></blockquote><a></a><blockquote class="calibre42"><span class="calibre41"> Like the growing phenomenon of polyglot programming, polyglot persistence is now gaining ground. </span></blockquote><a></a><blockquote class="calibre47"><span class="calibre41"> If you are unfamiliar with the practice, polyglot programming is whereby a team uses more than one programming language in a single project. Contrast this with the convention of using one general-purpose language throughout a project. This is useful because of the different inherent strengths of languages. A framework like Scala may be better suited for server-side stateless transactions on the Web, but a language like Ruby may be friendlier for business logic. Used together, they create a synergy. A polyglot language system like this was famously used at Twitter. </span></blockquote><a></a><blockquote class="calibre47"><span class="calibre41">Some of the databases we’ve seen themselves support polyglot programming—Riak supports both JavaScript and Erlang when writing mapreduce, and a single request can execute both. </span></blockquote><a></a><blockquote class="calibre47"><span class="calibre41"> Similar to its language-centric cousin, polyglot persistence is where you can leverage the strengths of many kinds of databases in the same system, as opposed to the currently familiar practice of a single database, probably a relational style. A basic variant of this is already common: using a key-value store (like Redis) that acts as a cache for relatively slower relational database (like PostgreSQL) queries. Relational, as we’ve seen in previous chapters, is suboptimally suited for a growing host of problems, such as graph traversal. But even these new databases shine only as a few stars in the full galaxy of requirements. </span></blockquote><a id="filepos1857469"></a><blockquote class="calibre47"><span class="calibre41"> Why the sudden interest in polyglot? Martin Fowler noted</span><a href="#filepos1946379"><span class="calibre41"><span class="calibre13"><span class="underline">[57]</span></span></span></a><span class="calibre41"> that having a single central database where multiple applications could integrate was a common pattern in software design. This once popular database integration pattern has given way to a middleware layer pattern, where multiple applications instead communicate to a service layer over HTTP. This frees up the middleware service itself to rely on any number of databases or, in the case of polyglot persistence, any type. </span></blockquote><a></a><p class="calibre43"> Redis plays three important roles in our system: to assist in data populating CouchDB, as a cache for recent Neo4j changes, and as a quick lookup for partial value searches. Its speed and ability to store multiple data formats make it well suited for population, and its built-in expiry policies are perfect for handling cached data. </p><a></a><p class="calibre12"> CouchDB is our system of record (SOR), or authoritative data source. CouchDB’s document structure is an easy way to store band data with nested artist and role information, and we will take advantage of the Changes API in CouchDB to keep our third data source in sync. </p><a></a><p class="calibre12"> Neo4j is our relationship store. Although querying the CouchDB SOR directly is perfectly reasonable, a graph datastore allows us a simplicity and speed in walking node relationships that other databases have a difficult time matching. We’ll store relationships between bands, band members, and the roles the members play. </p><a></a><p class="calibre12"> Each database has a specific role to play in our system, but they don’t natively communicate. We use the Node.js JavaScript framework to populate the databases, communicate between them, and act as a simple front-end server. Since gluing multiple databases together requires a bit of code, this last day will have much more code than we have seen so far in this book. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Population</span></span></span></p><a></a><p class="calibre29"> The first item of business is to populate our datastores with the necessary data. We take a two-phased approach here, by first populating Redis and then populating our CouchDB SOR. </p><p class="calibre12" id="filepos1859914"> As in earlier sections, we download a dataset from Freebase.com. We’ll be using the <span class="calibre9"><span class="calibre30">group_membership</span></span> tab-separated set.<a href="#filepos1946379"><span class="calibre13"><span class="underline">[58]</span></span></a> This file contains a lot of information, but we are interested only in extracting the <span class="calibre9"><span class="calibre30">member</span></span> or artist name, the <span class="calibre9"><span class="calibre30">group</span></span> or band name, and their <span class="calibre9"><span class="calibre30">role</span></span>s in that band stored as a comma-separated list. For example, <span class="italic">John Cooper</span> played in the band <span class="italic">Skillet</span> as the <span class="italic">Lead vocalist</span>, <span class="italic">Acoustic guitar</span> player, and <span class="italic">Bassist</span>. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​/m/0654bxy  John Cooper Skillet Lead vocalist,Acoustic guitar,Bass  1996​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Ultimately we want to structure John Cooper and the other members of Skillet into a single CouchDB document like the following, stored at the URL <span class="calibre9"><span class="calibre30">http://localhost:5984/bands/Skillet</span></span>: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​{​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "_id": "Skillet",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "name": "Skillet"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  "artists": [​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "name": "John Cooper",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "role": [​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "Acoustic guitar",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "Lead vocalist",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "Bass"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      ]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    },​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    ...​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "name": "Korey Cooper",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      "role": [​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "backing vocals",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "Synthesizer",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "Guitar",​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        "Keyboard instrument"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      ]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  ]​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This file contains well over 100,000 band members and more than 30,000 bands. That’s not many, but it’s a good starting point to build your own system. Note that not every artist’s roles are documented. This is an incomplete dataset, but we can deal with that later. </p><p class="calibre12"><span class="bold"><span class="calibre28">Phase 1: Data Transformation</span></span></p><a></a><p class="calibre37"> You may wonder why we bother populating Redis and not just dive right into populating CouchDB. Acting as an intermediary, Redis adds structure to the flat TSV data so that subsequent insertion into another database is fast. Since our plan is to create a single record per band name, Redis allows us to make a single pass through our TSV file (which lists the same band for each band member—each band member is represented in a line). Adding single members directly to CouchDB for each line in the file can cause update thrashing, where two band member lines attempt to create/update the same band document at the same time, forcing the system to reinsert when one of them fails CouchDB’s version check. </p><a></a><p class="calibre12"> The catch with this strategy is that you’re limited to the constraints of Redis to hold an entire dataset in RAM—though this limit could be overcome by the simple consistent-hashing cluster we saw on Day 2. </p><a></a><p class="calibre12"> With our data file in hand, ensure you have Node.js installed as well as the Node Package Manager (npm). Once that’s all done, we need to install three NPM projects: redis, csv, and hiredis (the optional Redis C-driver we learned about yesterday that can greatly speed up Redis interactions). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ npm install hiredis redis csv​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Then, check that your Redis server is running on the default port 6379, or alter each script’s <span class="calibre9"><span class="calibre30">createClient</span></span> function to point to your Redis port. </p><a></a><p class="calibre12"> You can populate Redis by running the following Node.js script in the same directory as your TSV file, which we assume is named <span class="calibre9"><span class="calibre30">group_membership.tsv</span></span>. (All of the JavaScript files we’ll look at are fairly verbose, so we don’t show them in their entirety. All of the code can be downloaded from the Pragmatic Bookshelf website. Here we’ll just stick to the meat of each file.) Download and run the following file: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">node pre_populate.js</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This script basically iterates through each line of the TSV and extracts the artist name, the band name, and the roles they play in that band. Then it adds those values to Redis (skipping any blank values). </p><a></a><p class="calibre12"> The format of each Redis band key is <span class="calibre9"><span class="calibre30">"band:Band Name"</span></span>. The script will add this artist name to the set of artist names. So, the key <span class="calibre9"><span class="calibre30">"band:Beatles"</span></span> will contain the set of values <span class="calibre9"><span class="calibre30">["John Lennon", "Paul McCartney", "George Harrison", "Ringo Starr"]</span></span>. The artist keys will also contain the band name and similarly contain a set of roles. <span class="calibre9"><span class="calibre30">"artist:Beatles:Ringo Starr"</span></span> will contain the set <span class="calibre9"><span class="calibre30">["Drums"]</span></span>. </p><a></a><p class="calibre12"> The other code just keeps track of how many lines we’ve processed and outputs the results to the screen. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/redis/pre_populate.js"><span class="calibre41"><span class="calibre13"><span class="underline">redis/pre_populate.js</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​csv().​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​fromPath( tsvFileName, { delimiter: </span><span class="calibre9"><span class="italic"><span class="calibre38">'\t'</span></span></span><span class="calibre9">, quote: </span><span class="calibre9"><span class="italic"><span class="calibre38">''</span></span></span><span class="calibre9"> }).​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​on(</span><span class="calibre9"><span class="italic"><span class="calibre38">'data'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(data, index) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    artist = data[2],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    band = data[3],​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    roles = buildRoles(data[4]);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">if</span></span></span><span class="calibre9">( band === </span><span class="calibre9"><span class="italic"><span class="calibre38">''</span></span></span><span class="calibre9"> || artist === </span><span class="calibre9"><span class="italic"><span class="calibre38">''</span></span></span><span class="calibre9"> ) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    trackLineCount();​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">return</span></span></span><span class="calibre9"> true;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  }​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  redis_client.sadd(</span><span class="calibre9"><span class="italic"><span class="calibre38">'band:'</span></span></span><span class="calibre9"> + band, artist);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  roles.forEach(</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(role) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    redis_client.sadd(</span><span class="calibre9"><span class="italic"><span class="calibre38">'artist:'</span></span></span><span class="calibre9"> + band + </span><span class="calibre9"><span class="italic"><span class="calibre38">':'</span></span></span><span class="calibre9"> + artist, role);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  });​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  trackLineCount();​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​}).​</span><span class="calibre9">​</span></p></td></tr></table><a></a><blockquote class="calibre76"><img src="images/00007.jpg" class="calibre92"/><span class="calibre9">        </span></blockquote><blockquote class="calibre42"><span class="calibre9"><span class="bold"><span class="calibre31">Eric says:</span></span></span></blockquote><blockquote class="calibre85"><span class="bold"><span class="calibre4">Nonblocking Code</span></span></blockquote><a></a><blockquote class="calibre83"><span class="calibre9"> Before starting this book, we were only passingly familiar with writing event-driven nonblocking applications. </span><span class="calibre9"><span class="italic">Nonblocking</span></span><span class="calibre9"> means precisely that: rather than waiting for a long-running process to complete, the main code will continue executing. Whatever you need to do in response to a blocking event you put inside a function or code block to be executed later. This can be by spawning a separate thread or, in our case, implementing a reactor pattern event-driven approach. </span></blockquote><a></a><blockquote class="calibre86"><span class="calibre9"> In a blocking program, you can write code that queries a database, waits, and loops through the results. </span></blockquote><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​results = database.some_query()​</span><span class="calibre9">​</span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">for</span></span></span><span class="calibre9"> value </span><span class="calibre9"><span class="bold"><span class="calibre44">in</span></span></span><span class="calibre9"> results​</span><span class="calibre9">​</span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="italic"><span class="calibre46"># do something with each value</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre46"># this is not executed until after the results are looped...</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></blockquote></td></tr></table><a></a><blockquote class="calibre111"><span class="calibre9"> In a event-driven program, you would pass in the loop as a function/code block. While the databases is doing its thing, the rest of the program can continue running. Only after the database returns the result does the function/code block get executed. </span></blockquote><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​database.some_query </span><span class="calibre9"><span class="bold"><span class="calibre44">do</span></span></span><span class="calibre9"> |results|​</span><span class="calibre9">​</span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">for</span></span></span><span class="calibre9"> value </span><span class="calibre9"><span class="bold"><span class="calibre44">in</span></span></span><span class="calibre9"> results​</span><span class="calibre9">​</span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre46"># do something with each value</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">end</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span><span class="calibre9">
</span></td><td valign="top" class="calibre16"><blockquote class="calibre42"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="italic"><span class="calibre46"># this continues running while the database performs its query...</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></blockquote></td></tr></table><a></a><blockquote class="calibre111"><span class="calibre9"> It took us quite some time to realize the benefits here. The rest of the program can run rather than sitting idle while it waits on the database, sure, but is this common? Apparently so, because when we began coding in this style, we noticed an order-of-magnitude decrease in latency. </span></blockquote><a></a><blockquote class="calibre86"><span class="calibre9"> We try to keep the code as simple as we can, but interacting with databases in a nonblocking way is an inherently complex process. But as we learned, it’s generally a very good method when dealing with databases. Nearly every popular programming language has some sort of nonblocking library. Ruby has EventMachine, Python has Twisted, Java has the NIO library, C# has Interlace, and of course JavaScript has Node.js. </span></blockquote><a></a><p class="calibre23"> You can test that the code has been populating Redis by launching <span class="calibre9"><span class="calibre30">redis-cli</span></span> and executing <span class="calibre9"><span class="calibre30">RANDOMKEY</span></span>. We should expect a key prefixed by <span class="calibre9"><span class="calibre30">band:</span></span> or <span class="calibre9"><span class="calibre30">artist:</span></span>…any value but <span class="calibre9"><span class="calibre30">(nil)</span></span> is good. </p><a></a><p class="calibre12"> Now that Redis is populated, proceed immediately to the next section. Turning off Redis could lose data, unless you chose to set a higher durability than the default or initiated a <span class="calibre9"><span class="calibre30">SAVE</span></span> command. </p><p class="calibre12"><span class="bold"><span class="calibre28">Phase 2: SOR Insertion</span></span></p><a></a><p class="calibre37"> CouchDB will play the role of our system of record (SOR). If any data conflicts arise between Redis, CouchDB, or Neo4j, CouchDB wins. A good SOR should contain all of the data necessary to rebuild any other data source in its domain. </p><a></a><p class="calibre12"> Ensure CouchDB is running on the default port 5984, or change the <span class="calibre9"><span class="calibre30">require(’http’).createClient(5984, ’localhost’)</span></span> line in the following code to the port number you require. Redis should also still be running from the previous section. Download and run the following file: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">node populate_couch.js</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Since phase 1 was all about pulling data from a TSV and populating Redis, this phase is all about pulling data from Redis and populating CouchDB. We don’t use any special drivers for CouchDB, since it’s a simple REST interface and Node.js has a simple built-in HTTP library. </p><a></a><p class="calibre12"> In the following block of code, we perform a Redis <span class="calibre9"><span class="calibre30">KEYS bands:*</span></span> to get a list of all band names in our system. If we had a <span class="italic">really</span> big dataset, we could add more scoping (for example, <span class="calibre9"><span class="calibre30">bands:A*</span></span> to get only band names starting with <span class="italic">a</span>, and so on). Then for each of those bands we fetch the set of artists and extract the band name from the key, by removing the prefix <span class="italic">bands:</span> from the key string. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/redis/populate_couch.js"><span class="calibre41"><span class="calibre13"><span class="underline">redis/populate_couch.js</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redisClient.keys(</span><span class="calibre9"><span class="italic"><span class="calibre38">'band:*'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(error, bandKeys) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  totalBands = bandKeys.length;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    readBands = 0,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    bandsBatch = [];​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  bandKeys.forEach(</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(bandKey) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre46">// substring of 'band:'.length gives us the band name</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> bandName = bandKey.substring(5);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    redisClient.smembers(bandKey, </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(error, artists) {​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Next we get all of the roles for every artist in this band, which Redis returns as an array of arrays (each artists role is its own array). We can do this by batching up Redis <span class="calibre9"><span class="calibre30">SMEMBERS</span></span> commands into an array called <span class="calibre9"><span class="calibre30">roleBatch</span></span> and executing them in a single <span class="calibre9"><span class="calibre30">MULTI</span></span> batch. Effectively, that would be executing a single pipelined request like this: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​MULTI​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  SMEMBERS "artist:Beatles:John Lennon"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  SMEMBERS "artist:Beatles:Ringo Starr"​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​EXEC​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> From there, a batch of 50 CouchDB documents are made. We build a batch of 50, because we then send the entire set to CouchDB’s <span class="calibre9"><span class="calibre30">/_bulk_docs</span></span> command, allowing us very, very fast insertion. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/redis/populate_couch.js"><span class="calibre41"><span class="calibre13"><span class="underline">redis/populate_couch.js</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​redisClient.​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  multi(roleBatch).​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  exec(</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(err, roles)​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      i = 0,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      artistDocs = [];​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre46">// build the artists sub-documents</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    artists.forEach( </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(artistName) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      artistDocs.push({ name: artistName, role : roles[i++] });​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    });​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="italic"><span class="calibre46">// add this new band document to the batch to be executed later</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    bandsBatch.push({​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      _id: couchKeyify( bandName ),​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      name: bandName,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      artists: artistDocs​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    });​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> With the population of the bands database, we now have in a single location all of the data our system requires. We know the names of many bands, the artists who performed in them, and the roles they played in those bands. </p><a></a><p class="calibre12"> Now would be a good time to take a break and play around with our newly populated bands system of record in CouchDB at <span class="calibre9"><span class="calibre30">http://localhost:5984/_utils/</span></span>
<span class="calibre9"><span class="calibre30">database.html?bands</span></span>. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Relationship Store</span></span></span></p><a></a><p class="calibre29"> Next on the docket is our Neo4j service that we’ll use to track relationships between artists and the roles they play. We could certainly query CouchDB outright by creating views, but we are rather limited on complex queries based on relationships. If Wayne Coyne from the Flaming Lips loses his theremin before a show, he could ask Charlie Clouser from Nine Inch Nails, who also plays a theremin. Or we could discover artists who have many overlapping talents, even if they performed different roles in different bands—all with a simple node walk. </p><a></a><p class="calibre12"> With our initial data in place, now we need to keep Neo4j in sync with CouchDB should any data ever change on our system of record. So, we’ll kill two birds by crafting a service that populates Neo4j on any changes to CouchDB since the database was created. </p><a></a><p class="calibre12"> We also want to populate Redis with keys for our bands, artists, and role so we can quickly access this data later. Happily, this includes all data that we’ve already populated in CouchDB, thus saving us a separate initial Neo4j and Redis population step. </p><a></a><p class="calibre12"> Ensure that Neo4j is running on port 7474, or change the appropriate <span class="calibre9"><span class="calibre30">createClient</span></span> function to use your correct port. CouchDB and Redis should still be running. Download and run the following file. This file will continue running until you shut it down. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">node graph_sync.js</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> This server just uses the continuous polling example we saw in the CouchDB chapter to track all CouchDB changes. Whenever a change is detected, we do two things: populate Redis and populate Neo4j. This code populates Redis by cascading callback functions. First it populates the band as <span class="calibre9"><span class="calibre30">"band-name:Band Name"</span></span>. It follows this pattern for artist name and roles. </p><a></a><p class="calibre12"> This way, we can search with partial strings. For example, <span class="calibre9"><span class="calibre30">KEYS band-name:Bea*</span></span> could return this: Beach Boys, Beastie Boys, Beatles, and so on. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/redis/graph_sync.js"><span class="calibre41"><span class="calibre13"><span class="underline">redis/graph_sync.js</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9"> feedBandToRedis(band) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  redisClient.set(</span><span class="calibre9"><span class="italic"><span class="calibre38">'band-name:'</span></span></span><span class="calibre9"> + band.name, 1);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  band.artists.forEach(</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(artist) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    redisClient.set(</span><span class="calibre9"><span class="italic"><span class="calibre38">'artist-name:'</span></span></span><span class="calibre9"> + artist.name, 1);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    artist.role.forEach(</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(role){​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      redisClient.set(</span><span class="calibre9"><span class="italic"><span class="calibre38">'role-name:'</span></span></span><span class="calibre9"> + role, 1);​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The next block is how we populate Neo4j. We created a driver that you can download as part of this book’s code, named <span class="calibre9"><span class="calibre30">neo4j_caching_client.js</span></span>. It just uses Node.js’s HTTP library to connect to the Neo4j REST interface with a bit of rate-limiting built in so the client doesn’t open too many connections at once. Our driver also uses Redis to keep track of changes made to the Neo4j graph without having to initiate a separate query. This is our third separate use for Redis—the first being as a data transformation step for populating CouchDB, and the second we just saw earlier, to quickly search for band values. </p><a></a><p class="calibre12"> This code creates band nodes (if they need to be created), then artist nodes (if they need to be created), and then roles. Each step along the way creates a new relationship, so The Beatles node will relate to John, Paul, George, and Ringo nodes, who in turn each relate to the roles they play. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/redis/graph_sync.js"><span class="calibre41"><span class="calibre13"><span class="underline">redis/graph_sync.js</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9"> feedBandToNeo4j(band, progress) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    lookup = neo4jClient.lookupOrCreateNode,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    relate = neo4jClient.createRelationship;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  lookup(</span><span class="calibre9"><span class="italic"><span class="calibre38">'bands'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'name'</span></span></span><span class="calibre9">, band.name, </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(bandNode) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    progress.emit(</span><span class="calibre9"><span class="italic"><span class="calibre38">'progress'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'band'</span></span></span><span class="calibre9">);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    band.artists.forEach(</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(artist) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      lookup(</span><span class="calibre9"><span class="italic"><span class="calibre38">'artists'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'name'</span></span></span><span class="calibre9">, artist.name, </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(artistNode){​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        progress.emit(</span><span class="calibre9"><span class="italic"><span class="calibre38">'progress'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'artist'</span></span></span><span class="calibre9">);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        relate(bandNode.self, artistNode.self, </span><span class="calibre9"><span class="italic"><span class="calibre38">'member'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(){​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​          progress.emit(</span><span class="calibre9"><span class="italic"><span class="calibre38">'progress'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'member'</span></span></span><span class="calibre9">);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        });​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​        artist.role.forEach(</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(role){​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​          lookup(</span><span class="calibre9"><span class="italic"><span class="calibre38">'roles'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'role'</span></span></span><span class="calibre9">, role, </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(roleNode){​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​            progress.emit(</span><span class="calibre9"><span class="italic"><span class="calibre38">'progress'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'role'</span></span></span><span class="calibre9">);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​            relate(artistNode.self, roleNode.self, </span><span class="calibre9"><span class="italic"><span class="calibre38">'plays'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(){​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​              progress.emit(</span><span class="calibre9"><span class="italic"><span class="calibre38">'progress'</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">'plays'</span></span></span><span class="calibre9">);​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Let this service keep running in its own window. Every update to CouchDB that adds a new artist or role to an existing artist will trigger a new relationship in Neo4j and potentially new keys in Redis. As long as this service runs, they should be in sync. </p><a></a><p class="calibre12"> Open your CouchDB web console and open a band. Make any data change you want to the database: add a new band member (make yourself a member of the Beatles!), or add a new role to an artist. Keep an eye on the graph_sync output. Then fire up the Neo4j console and try finding any new connections in the graph. If you added a new band member, they should now have a relationship with the band node or new role if that was altered. The current implementation does not remove relationships—though it would not be a complete modification to add a Neo4j <span class="calibre9"><span class="calibre30">DELETE</span></span> operation to the script. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">The Service</span></span></span></p><a></a><p class="calibre29"> This is the part we’ve been building up to. We’re going to create a simple web application that allows users to search for a band. Any band in the system will list all of the band members as links, and any clicked band member link will list some information about the artist—namely, the roles they play. In addition, each role the artist plays will list every other artist in the system who also plays that role. </p><a></a><p class="calibre12"> For example, searching for Led Zeppelin would give you Jimmy Page, John Paul Jones, John Bonham, and Robert Plant. Clicking Jimmy Page will list that he plays guitar and also many other artists who play guitar, like The Edge from U2. </p><a></a><p class="calibre12"> To simplify our web app creation a bit, we’ll need two more node packages: bricks (a simple web framework) and mustache (a templating library). </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">npm install bricks mustache</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Like in the previous sections, ensure you have all of the databases running, and then start up the server. Download and run the following code: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​$ </span><span class="calibre9"><span class="bold"><span class="calibre44">node band.js</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> The server is set to run on port 8080, so if you point your browser to <span class="calibre9"><span class="calibre30">http://localhost:8080/</span></span>, you should see a simple search form. </p><a></a><p class="calibre12"> Let’s take a look at the code that will build a web page that lists band information. Each URL performs a separate function in our little HTTP server. The first is at <span class="calibre9"><span class="calibre30">http://localhost:8080/band</span></span> and accepts any band name as a parameter. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/redis/bands.js"><span class="calibre41"><span class="calibre13"><span class="underline">redis/bands.js</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​appServer.addRoute(</span><span class="calibre9"><span class="italic"><span class="calibre38">"^/band$"</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(req, res) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    bandName = req.param(</span><span class="calibre9"><span class="italic"><span class="calibre38">'name'</span></span></span><span class="calibre9">),​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    bandNodePath = </span><span class="calibre9"><span class="italic"><span class="calibre38">'/bands/'</span></span></span><span class="calibre9"> + couchUtil.couchKeyify( bandName ),​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    membersQuery = </span><span class="calibre9"><span class="italic"><span class="calibre38">'g.V[[name:"'</span></span></span><span class="calibre9">+bandName+</span><span class="calibre9"><span class="italic"><span class="calibre38">'"]]'</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​                 + </span><span class="calibre9"><span class="italic"><span class="calibre38">'.out("member").in("member").uniqueObject.name'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  getCouchDoc( bandNodePath, res, </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">( couchObj ) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    gremlin( membersQuery, </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(graphData) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> artists = couchObj &amp;&amp; couchObj[</span><span class="calibre9"><span class="italic"><span class="calibre38">'artists'</span></span></span><span class="calibre9">];​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> values = { band: bandName, artists: artists, bands: graphData };​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> body = </span><span class="calibre9"><span class="italic"><span class="calibre38">'&lt;h2&gt;{{band}} Band Members&lt;/h2&gt;'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      body += </span><span class="calibre9"><span class="italic"><span class="calibre38">'&lt;ul&gt;{{#artists}}'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      body += </span><span class="calibre9"><span class="italic"><span class="calibre38">'&lt;li&gt;&lt;a href="/artist?name={{name}}"&gt;{{name}}&lt;/a&gt;&lt;/li&gt;'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      body += </span><span class="calibre9"><span class="italic"><span class="calibre38">'{{/artists}}&lt;/ul&gt;'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      body += </span><span class="calibre9"><span class="italic"><span class="calibre38">'&lt;h3&gt;You may also like&lt;/h3&gt;'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      body += </span><span class="calibre9"><span class="italic"><span class="calibre38">'&lt;ul&gt;{{#bands}}'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      body += </span><span class="calibre9"><span class="italic"><span class="calibre38">'&lt;li&gt;&lt;a href="/band?name={{.}}"&gt;{{.}}&lt;/a&gt;&lt;/li&gt;'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      body += </span><span class="calibre9"><span class="italic"><span class="calibre38">'{{/bands}}&lt;/ul&gt;'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      writeTemplate( res, body, values );​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> If you enter in the band <span class="italic">Nirvana</span> in the search form, your URL request will be <span class="calibre9"><span class="calibre30">http://localhost:8080/band?name=Nirvana</span></span>. This function will render an HTML page (the overall template is in an external file named <span class="calibre9"><span class="calibre30">template.html</span></span>). This web page lists all artists in a band, which it pulls directly from CouchDB. It also lists some suggested bands, which it retrieves from a Gremlin query against the Neo4j graph. The Gremlin query is like this for Nirvana: </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​g.V.filter{it.name=="Nirvana"}.out("member").in("member").dedup.name​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Or in other words, from the Nirvana node, get all unique names whose members are connected to Nirvana members. For example, Dave Grohl played in Nirvana and the Foo Fighters, so Foo Fighters will be returned in this list. </p><a></a><p class="calibre12"> The next action is the <span class="calibre9"><span class="calibre30">http://localhost:8080/artist</span></span> URL. This page will output information about an artist. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/redis/bands.js"><span class="calibre41"><span class="calibre13"><span class="underline">redis/bands.js</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​appServer.addRoute(</span><span class="calibre9"><span class="italic"><span class="calibre38">"^/artist$"</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(req, res) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9">​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    artistName = req.param(</span><span class="calibre9"><span class="italic"><span class="calibre38">'name'</span></span></span><span class="calibre9">),​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    rolesQuery = </span><span class="calibre9"><span class="italic"><span class="calibre38">'g.V[[name:"'</span></span></span><span class="calibre9">+artistName+</span><span class="calibre9"><span class="italic"><span class="calibre38">'"]].out("plays").role.uniqueObject'</span></span></span><span class="calibre9">,​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    bandsQuery = </span><span class="calibre9"><span class="italic"><span class="calibre38">'g.V[[name:"'</span></span></span><span class="calibre9">+artistName+</span><span class="calibre9"><span class="italic"><span class="calibre38">'"]].in("member").name.uniqueObject'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  gremlin( rolesQuery, </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(roles) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    gremlin( bandsQuery, </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(bands) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> values = { artist: artistName, roles: roles, bands: bands };​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> body = </span><span class="calibre9"><span class="italic"><span class="calibre38">'&lt;h3&gt;{{artist}} Performs these Roles&lt;/h3&gt;'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      body += </span><span class="calibre9"><span class="italic"><span class="calibre38">'&lt;ul&gt;{{#roles}}'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      body += </span><span class="calibre9"><span class="italic"><span class="calibre38">'&lt;li&gt;{{.}}&lt;/li&gt;'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      body += </span><span class="calibre9"><span class="italic"><span class="calibre38">'{{/roles}}&lt;/ul&gt;'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      body += </span><span class="calibre9"><span class="italic"><span class="calibre38">'&lt;h3&gt;Play in Bands&lt;/h3&gt;'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      body += </span><span class="calibre9"><span class="italic"><span class="calibre38">'&lt;ul&gt;{{#bands}}'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      body += </span><span class="calibre9"><span class="italic"><span class="calibre38">'&lt;li&gt;&lt;a href="/band?name={{.}}"&gt;{{.}}&lt;/a&gt;&lt;/li&gt;'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      body += </span><span class="calibre9"><span class="italic"><span class="calibre38">'{{/bands}}&lt;/ul&gt;'</span></span></span><span class="calibre9">;​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      writeTemplate( res, body, values );​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Two Gremlin queries are executed here. This first outputs all roles a member plays, and the second is a list of bands that person played in. For example, Jeff Ward (<span class="calibre9"><span class="calibre30">http://localhost:8080/artist?name=Jeff%20Ward</span></span>) would be listed as playing the role Drummer and in the bands Nine Inch Nails and Ministry. </p><a></a><p class="calibre12"> A cool feature of the previous two pages is that we render links between these values. The artist list in the <span class="calibre9"><span class="calibre30">/bands</span></span> page links to the chosen <span class="calibre9"><span class="calibre30">/artist</span></span> page, and vice versa. But we could make searching a bit easier. </p><br class="calibre1"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td colspan="2" valign="top" class="calibre16"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/rwdata/code/redis/bands.js"><span class="calibre41"><span class="calibre13"><span class="underline">redis/bands.js</span></span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​appServer.addRoute(</span><span class="calibre9"><span class="italic"><span class="calibre38">"^/search$"</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(req, res) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> query = req.param(</span><span class="calibre9"><span class="italic"><span class="calibre38">'term'</span></span></span><span class="calibre9">);​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​  redisClient.keys(</span><span class="calibre9"><span class="italic"><span class="calibre38">"band-name:"</span></span></span><span class="calibre9">+query+</span><span class="calibre9"><span class="italic"><span class="calibre38">"*"</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(error, keys) {​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    </span><span class="calibre9"><span class="bold"><span class="calibre44">var</span></span></span><span class="calibre9"> bands = [];​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    keys.forEach(</span><span class="calibre9"><span class="bold"><span class="calibre44">function</span></span></span><span class="calibre9">(key){​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​      bands.push(key.replace(</span><span class="calibre9"><span class="italic"><span class="calibre38">"band-name:"</span></span></span><span class="calibre9">, </span><span class="calibre9"><span class="italic"><span class="calibre38">''</span></span></span><span class="calibre9">));​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    });​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    res.write( JSON.stringify(bands) );​</span><span class="calibre9">​</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre9"><span class="bold"> </span></span><span class="calibre9"><span class="bold">
</span></span>
</td><td valign="top" class="calibre16"><p class="calibre22"><span class="calibre9"> ​</span><span class="calibre9">​    res.end();​</span><span class="calibre9">​</span></p></td></tr></table><a></a><p class="calibre45"> Here we just pull all keys from Redis that match the first part of the string, such as <span class="calibre9"><span class="calibre30">"Bea*"</span></span> as described previously. It then outputs the data as JSON. The <span class="calibre9"><span class="calibre30">template.html</span></span> file links to the jQuery code necessary to make this function as an autocomplete feature on the rendered search box. </p><p class="calibre12"><span class="bold"><span class="calibre28">Expanding the Service</span></span></p><a></a><p class="calibre37"> This is a fairly little script for all of the bare-bones work we’re doing here. You may find many places you want to extend. Notice that the band suggestion is only first-order bands (bands the current band’s members have performed in); you can get interesting results by writing a query to walk second-order bands, like this: <span class="calibre9"><span class="calibre30">g.V.filter{it.name==’Nine Inch Nails’}.out(’member’).in(’member’).dedup.</span></span>
<span class="calibre9"><span class="calibre30">loop(3){ it.loops &lt;= 2 }.name</span></span>. </p><a></a><p class="calibre12"> You may also note that we do not have a form where someone can update band information. Adding this functionality could be fairly simple, since we already wrote CouchDB population code in the <span class="calibre9"><span class="calibre30">populate_couch.js</span></span> script, and populating CouchDB will automatically keep Neo4j and Redis eventually consistent as long as the <span class="calibre9"><span class="calibre30">graph_sync.js</span></span> service is running. </p><p class="calibre12" id="filepos1939506"> If you enjoy playing with this kind of polyglot persistence, you could take this even further. You could add a PostgreSQL data warehouse<a href="#filepos1946379"><span class="calibre13"><span class="underline">[59]</span></span></a> to transform this data into a star schema—allowing for different dimensions of analysis, such as most commonly played instrument or average numbers of total members in a band vs. total instruments. You could add a Riak server to store samples of bands’ music, an HBase server to build a messaging system where users can keep track of their historical likes/dislikes, or a MongoDB extension to add a geographic element to this service. </p><a></a><p class="calibre12"> Or, redesign this project entirely with a different language, web framework, or dataset. There are as many opportunities to extend this project as there are combinations of databases and technologies to create it—a Cartesian product of all open source. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Day 3 Wrap-Up</span></span></span></p><a></a><p class="calibre29"> Today was a big day—so big, in fact, we wouldn’t be surprised if it took several days to complete. But this is a little taste of the future of data management systems, as the world strolls away from the <span class="calibre9"><span class="italic"><span class="calibre38">one large relational database</span></span></span> model to a <span class="calibre9"><span class="italic"><span class="calibre38">several specialized databases</span></span></span> model. We also glued these databases together with some nonblocking code, which, though not a focus of this book, also seems to be where database interaction is headed in the development space. </p><a></a><p class="calibre12"> The importance of Redis in this model should not be missed. Redis certainly doesn’t provide any functionality these databases don’t supply individually, but it does supply speedy data structures. We were able to organize a flat file into a series of meaningful data structures, which is an integral part of both data population and transportation. And it did this in a fast and simple-to-use way. </p><a></a><p class="calibre12"> Even if you’re not sold on the whole polyglot persistence model, you should certainly consider Redis for any system. </p><p class="calibre12"><span class="bold"><span class="calibre28">Day 3 Homework</span></span></p><p class="calibre37"><span class="bold">Do</span>
</p><div class="calibre33"> </div><ol class="calibre60"><li value="1" class="calibre35"><p class="calibre22">Alter the importer steps to also track a band member’s start and end dates with the band. Track that data in the artist’s CouchDB subdocument. Display this information on the artist’s page.</p></li><li value="2" class="calibre36"><p class="calibre22">Add MongoDB into the mix by storing a few music samples into GridFS, whereby users can hear a song or two related to a band. If any songs exists for a band, add a link to the web app. Ensure the Riak data and CouchDB remain in sync.</p></li></ol><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos1942580" class="calibre1"><p class="calibre24" id="filepos1942585"><span class="calibre25"><span class="bold"><span class="calibre26">8.5 Wrap-Up</span></span></span></p><a></a><p class="calibre27"> The Redis key-value (or data structure) store is light and compact, with a variety of uses. It’s akin to one of those multitools composed of a knife, can opener, and other bits and bobs like a corkscrew—Redis is good to have around for solving a variety of odd tasks. Above all, Redis is fast, simple, and as durable as you choose. While rarely a stand-alone database, Redis is a perfect complement to any polyglot ecosystem as an ever-present helper for transforming data, caching requests, or managing messages by way of its blocking commands. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Redis’s Strengths</span></span></span></p><a></a><p class="calibre29"> The obvious strength of Redis is speed, like so many key-value stores of its ilk. But more than most key-value stores, Redis provides the ability to store complex values like lists, hashes, and sets, and retrieve them based through operations specific to those datatypes. Beyond even a data structure store, however, Redis’s durability options allow you to trade speed for data safety up to a fairly fine point. Built-in master-slave replication is another nice way of ensuring better durability without requiring the slowness of syncing an append-only file to disk on every operation. Additionally, replication is great for very high-read systems. </p><a></a><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Redis’s Weaknesses</span></span></span></p><a></a><p class="calibre29"> Redis is fast largely because it resides in memory. Some may consider this cheating, since of course a database that never hits the disk will be fast. A main memory database has an inherent durability problem; namely, if you shut down the database before a snapshot occurs, you can lose data. Even if you set the append-only file to disk sync on every operation, you run a risk with playing back expiry values, since time-based events can never be counted on to replay in exactly the same manner—though in fairness this case is more hypothetical than practical. </p><a></a><p class="calibre12"> Redis also does not support datasets larger than your available RAM (Redis is removing virtual memory support), so its size has a practical limitation. Although there is a Redis Cluster currently in development to grow beyond a single-machine’s RAM requirements, anyone wanting to cluster Redis must currently roll their own with a client that supports it (like the Ruby driver we used in Day 2). </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Parting Thoughts</span></span></span></p><a></a><p class="calibre29"> Redis is chock-full of commands—more than 120 of them. Most commands are straightforward enough to understand by their names alone, once you get used to the idea that seemingly random letters will be removed (for example, <span class="calibre9"><span class="calibre30">INCRBY</span></span>) or that mathematical precision can sometimes be more confusing than helpful (for example, <span class="calibre9"><span class="calibre30">ZCOUNT</span></span>, or sorted set count, vs. <span class="calibre9"><span class="calibre30">SCARD</span></span>, or set cardinality). </p><a></a><p class="calibre12"> Redis is already becoming an integral part of many systems. Several open source projects rely on Redis, from Resque, a Ruby-based asynchronous job queueing service, to session management in the Node.js project SocketStream. Regardless of the database you choose as your SOR, you should certainly add Redis to the mix. </p><p class="calibre23"><span class="calibre9"><span class="bold"><span class="calibre28">Footnotes</span></span></span></p><a id="filepos1946379"></a><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1673387"><span class="calibre9"><span class="calibre13"><span class="underline">[53]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://redis.io"><span class="calibre9"><span class="calibre13"><span class="underline">http://redis.io</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1772654"><span class="calibre9"><span class="calibre13"><span class="underline">[54]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://www.memcached.org/"><span class="calibre9"><span class="calibre13"><span class="underline">http://www.memcached.org/</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1794158"><span class="calibre9"><span class="calibre13"><span class="underline">[55]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://download.freebase.com/datadumps/latest/browse/book/isbn.tsv"><span class="calibre9"><span class="calibre13"><span class="underline">http://download.freebase.com/datadumps/latest/browse/book/isbn.tsv</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1846270"><span class="calibre9"><span class="calibre13"><span class="underline">[56]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://en.wikipedia.org/wiki/Bloom_filter"><span class="calibre9"><span class="calibre13"><span class="underline">http://en.wikipedia.org/wiki/Bloom_filter</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1857469"><span class="calibre9"><span class="calibre13"><span class="underline">[57]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://martinfowler.com/bliki/DatabaseThaw.html"><span class="calibre9"><span class="calibre13"><span class="underline">http://martinfowler.com/bliki/DatabaseThaw.html</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1859914"><span class="calibre9"><span class="calibre13"><span class="underline">[58]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://download.freebase.com/datadumps/latest/browse/music/group_membership.tsv"><span class="calibre9"><span class="calibre13"><span class="underline">http://download.freebase.com/datadumps/latest/browse/music/group_membership.tsv</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos1939506"><span class="calibre9"><span class="calibre13"><span class="underline">[59]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://en.wikipedia.org/wiki/Data_warehouse"><span class="calibre9"><span class="calibre13"><span class="underline">http://en.wikipedia.org/wiki/Data_warehouse</span></span></span></a><span class="calibre9">
</span></p></td></tr></table><p class="calibre17"><span class="calibre9"><span class="calibre18"><span class="calibre19">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos1949345" class="calibre1"><p class="calibre21" id="filepos1949350"><span class="calibre3"><span class="bold"><span class="calibre31"> Chapter 9</span></span></span></p><br class="calibre1"/><p class="calibre32"><span class="calibre3"><span class="bold"><span class="calibre4">Wrapping Up</span></span></span></p><a></a><p class="calibre12"> Now that we’ve made it through the databases, congratulations are in order! </p><a></a><p class="calibre12"> We hope you’ve gained an appreciation for these seven databases. If you use one in a project, we’ll be happy. And if you decide to use multiple databases, like we saw at the end of the Redis chapter, we’ll be ecstatic. We believe the future of data management lies in the polyglot persistence model (using more than one database in a project)—while the worldview of the general-purpose RDBMS fog drifts away. </p><a></a><p class="calibre12"> Let’s take this opportunity to see where our seven databases fit together in the greater database ecosystem. By this point, we have explored the details of each and mentioned a few commonalities and differences. We’ll see how they contribute to the vast and expanding landscape of data storage options. </p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos1950544" class="calibre1"><p class="calibre24" id="filepos1950549"><span class="calibre25"><span class="bold"><span class="calibre26">9.1 Genres Redux</span></span></span></p><a></a><p class="calibre27"> We’ve seen that how databases store their data can be largely divided into five genres: relational, key-value, columnar, document, and graph. Let’s take a moment and recap their differences and see what each style is good for and not so good for—when you’d want to use them and when to avoid them. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Relational</span></span></span></p><a></a><p class="calibre29"> This is the most common classic database pattern. Relational database management systems (RDBMSs) are set-theory-based systems implemented as two-dimensional tables with rows and columns. Relational databases strictly enforce type and are generally numeric, strings, dates, and uninterpreted blobs, but as we saw, PostgreSQL provided extensions such as array or cube. </p><p class="calibre12"><span class="bold"><span class="calibre28">Good For:</span></span></p><a></a><p class="calibre37"> Because of the structured nature of relational databases, they make sense when the layout of the data is known in advance but how you plan to use that data later may not be. Or, in other words, you pay the organizational complexity up front to achieve query flexibility later. Many business problems are aptly modeled this way, from orders to shipments and from inventory to shopping carts. You may not know in advance how you’ll want to query the data later—how many orders did we process in February?—but the data is quite regular in nature, so enforcing that regularity is helpful. </p><p class="calibre12"><span class="bold"><span class="calibre28">Not-So-Good For:</span></span></p><a></a><p class="calibre37"> When your data is highly variable or deeply hierarchical, relational databases aren’t the best fit. Because you must specify a schema up front, data problems that exhibit a high degree of record-to-record variation will be problematic. Consider developing a database to describe all the creatures in nature. Creating a full list of all features to account for (hasHair, numLegs, laysEggs, and so on) would be intractable. In such a case, you’d want a database that makes less restrictions in advance on what you can put into it. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Key-Value</span></span></span></p><a></a><p class="calibre29"> The key-value (KV) store was the simplest model we covered. KV maps simple keys to (possibly) more complex values like a huge hashtable. Because of their relative simplicity, this genre of database has the most flexibility of implementation. Hash lookups are fast, so in the case of Redis, speed was its primary concern. Hash lookups are also easily distributed, and so Riak took advantage of this fact for focusing on simple-to-manage clusters. Of course, its simplicity can be a downside for any data with complex modeling requirements. </p><p class="calibre12"><span class="bold"><span class="calibre28">Good For:</span></span></p><a></a><p class="calibre37"> With little or no need to maintain indexes, key-value stores are often designed to be horizontally scalable, extremely fast, or both. They’re particularly suited for problems where the data are not highly related. For example, in a web application, users’ session data meet this criteria; each user’s session activity will be different and largely unrelated to the activity of other users. </p><p class="calibre12"><span class="bold"><span class="calibre28">Not-So-Good For:</span></span></p><a></a><p class="calibre37"> Often lacking indexes and scanning capabilities, KV stores won’t help you if you need to be able to perform queries on your data, other than basic CRUD operations (Create, Read, Update, Delete). </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Columnar</span></span></span></p><a></a><p class="calibre29"> Columnar databases (aka <span class="italic">column-oriented</span>, aka <span class="italic">column family</span>) share many similarities with both KV and RDBMS stores. Like with a key-value database, values are queried by matching keys. Like relational, their values are groups of zero or more columns, though each row is capable of populating however many it wants. Unlike either, columnar databases store like data by columns, rather than keeping data together by rows. Columns are inexpensive to add, versioning is trivial, and there is no real storage cost for unpopulated values. We saw how HBase is a classic implementation of this genre. </p><p class="calibre12"><span class="bold"><span class="calibre28">Good For:</span></span></p><a></a><p class="calibre37"> Columnar databases have been traditionally developed with horizontal scalability as a primary design goal. As such, they’re particularly suited to “Big Data” problems, living on clusters of tens, hundreds, or thousands of nodes. They also tend to have built-in support for features such as compression and versioning. The canonical example of a good columnar data storage problem is indexing web pages. Pages on the Web are highly textual (benefits from compression), somewhat interrelated, and change over time (benefits from versioning). </p><p class="calibre12"><span class="bold"><span class="calibre28">Not-So-Good For:</span></span></p><a></a><p class="calibre37"> Different columnar databases have different features and therefore different drawbacks. But one thing they have in common is that it’s best to design your schema based on how you plan to query the data. This means you should have some idea in advance of how your data will be used, not just what it’ll consist of. If data usage patterns can’t be defined in advance—for example, fast ad hoc reporting—then a columnar database may not be the best fit. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Document</span></span></span></p><a></a><p class="calibre29"> Document databases allow for any number of fields per object and even allow objects to be nested to any depth as values of other fields. The common representation of these objects is as JavaScript Object Notation (JSON), adhered to by both MongoDB and CouchDB—though this is by no means a conceptual requirement. Since documents don’t relate to each other like relational databases, they are relatively easy to shard and replicate across several servers, making distributed implementations fairly common. MongoHQ tends to tackle availability by supporting the creation of datacenters that manage huge datasets for the Web. Meanwhile, CouchDB focuses on being simple and durable, where availability is achieved by master-master replication of fairly autonomous nodes. There is high overlap between these projects. </p><p class="calibre12"><span class="bold"><span class="calibre28">Good For:</span></span></p><a></a><p class="calibre37"> Document databases are suited to problems involving highly variable domains. When you don’t know in advance what exactly your data will look like, document databases are a good bet. Also, because of the nature of documents, they often map well to object-oriented programming models. This means less impedance mismatch when moving data between the database model and application model. </p><p class="calibre12"><span class="bold"><span class="calibre28">Not-So-Good For:</span></span></p><a></a><p class="calibre37"> If you’re used to performing elaborate join queries on highly normalized relational database schemas, you’ll find the capabilities of document databases lacking. A document should generally contain most or all of the relevant information required for normal use. So while in a relational database you’d naturally normalize your data to reduce or eliminate copies that can get out of sync, with document databases, denormalized data is the norm. </p><p class="calibre12"><span class="calibre5"><span class="bold"><span class="calibre28">Graph</span></span></span></p><a></a><p class="calibre29"> Graph databases are an emerging class of database that focuses more on the free interrelation of data than the actual values. Neo4j, as our open source example, is growing in popularity for many social network applications. Unlike other database styles that group collections of like objects into common buckets, graph databases are more free-form—queries consist of following edges shared by two nodes or, namely, <span class="italic">traversing</span> nodes. As more projects use them, graph databases are growing the straightforward social examples to occupy more nuanced use cases, such as recommendation engines, access control lists, and geographic data. </p><p class="calibre12"><span class="bold"><span class="calibre28">Good For:</span></span></p><a></a><p class="calibre37"> Graph databases seem to be tailor-made for networking applications. The prototypical example is a social network, where nodes represent users who have various kinds of relationships to each other. Modeling this kind of data using any of the other styles is often a tough fit, but a graph database would accept it with relish. They are also perfect matches for an object-oriented system. If you can model your data on a whiteboard, you can model it in a graph. </p><p class="calibre12"><span class="bold"><span class="calibre28">Not-So-Good For:</span></span></p><a></a><p class="calibre37"> Because of the high degree of interconnectedness between nodes, graph databases are generally not suitable for network partitioning. Spidering the graph quickly means you can’t afford network hops to other database nodes, so graph databases don’t scale out well. It’s likely that if you use a graph database, it’ll be one piece of a larger system, with the bulk of the data stored elsewhere and only the relationships maintained in the graph. </p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos1960346" class="calibre1"><p class="calibre24" id="filepos1960351"><span class="calibre25"><span class="bold"><span class="calibre26">9.2 Making a Choice</span></span></span></p><a></a><p class="calibre27"> As we said at the beginning, data is the new oil. We sit upon a vast ocean of data, yet until it’s refined into information, it’s unusable (and with a more crude comparison, there’s a lot of money in data these days). The ease of collecting and ultimately storing, mining, and refining the data out there starts with the database you choose. </p><a></a><p class="calibre12"> Deciding which database to choose is often more complex than merely considering which genre maps best to a given domain’s data. Though a social graph may seem to clearly function best with a graph database, if you’re Facebook, you simply have far too much data to choose one. You are more likely going to choose a “Big Data” implementation, such as HBase or Riak. This will force your hand into choosing a columnar or key-value store. In other cases, though you may believe a relational database is clearly the best option for bank transactions, it’s worth knowing that Neo4j also supports ACID transactions, expanding your options. </p><a></a><p class="calibre12"> These examples serve to point out that there are other avenues beyond genre to consider when choosing which database—or databases—best serve your problem scope. As a general rule, as the size of data increases, the capacity of certain database styles wane. Column-oriented datastore implementations are often built to scale across datacenters and support the largest “Big Data” sets, while graphs generally support the smallest. This is not always the case, however. Riak is a large-scale key-value store meant to shard data across hundreds or thousands of nodes, while Redis was built to run on one—with the possibility of a few master-slave replicas or client-managed shards. </p><a></a><p class="calibre12"> There are several more dimensions to consider when choosing a database, such as durability, availability, consistency, scalability, and security. You have to decide whether ad hoc queryability is important or if mapreduce will suffice. Do you prefer to use an HTTP/REST interface, or are you willing to require a driver for a custom binary protocol? Even smaller scope concerns, such as the existence of bulk data loaders, might be important for you to think about. </p><a></a><p class="calibre12"> To simplify the comparison between these databases, we created a table in Appendix 1, <a href="#filepos1964837"><span class="calibre13"><span class="underline">​</span></span><span class="italic"><span class="calibre13">Database Overview Tables</span></span><span class="calibre13"><span class="underline">​</span></span></a>. The table is not meant to be an exhaustive list of features. Instead, it’s meant to be a tool to quickly compare these databases we’ve already covered. Note the versions of each database. These features change in the blink of an eye, so we highly recommend double-checking these values for more recent versions. </p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos1963415" class="calibre1"><p class="calibre24" id="filepos1963420"><span class="calibre25"><span class="bold"><span class="calibre26">9.3 Where Do We Go from Here?</span></span></span></p><a></a><p class="calibre27"> Modern application scaling problems now fall largely in the realm of data management. We’ve reached a point in application evolution where programming language, framework, and operating system choice—even hardware and operations (thanks to virtual machine hosts and “the cloud”)—are becoming so cheap and easy as to become largely trivial problems driven as much by preference as necessity. If you want to scale your application in this age, you should think quite a bit about which database, or databases, you choose—it’s more than likely your true bottleneck. Helping you make this choice correctly was a leading purpose of this book. </p><a></a><p class="calibre12"> Although the book has come to a close, we trust your interest in polyglot persistence is wide open. The next steps from here are to pursue in detail the databases that piqued your interest or continue learning about other options like Cassandra, Drizzle, or OrientDB. </p><a></a><p class="calibre12"> It’s time to get your hands dirty. </p><p class="calibre17"><span class="calibre9"><span class="calibre18"><span class="calibre19">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos1964832" class="calibre1"><p class="calibre21" id="filepos1964837"><span class="calibre3"><span class="bold"><span class="calibre31"> Appendix 1</span></span></span></p><br class="calibre1"/><p class="calibre32"><span class="calibre3"><span class="bold"><span class="calibre4">Database Overview Tables</span></span></span></p><a></a><p class="calibre12"> This book contains a wealth of information about each of the seven databases we discuss: PostgreSQL, Riak, HBase, MongoDB, CouchDB, Neo4j, and Redis. In the pages that follow, you’ll find tables that tally up these databases along a number of dimensions to present an overview of what’s covered in more detail elsewhere in the book. Although the tables are not a replacement for a true understanding, they should provide you with an at-a-glance sense of what each database is capable of, where it falls short, and how it fits into the modern database landscape. </p><br class="calibre1"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">    </span></span>
</th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Genre  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Version  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Datatypes  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Data Relations  </span></blockquote></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">MongoDB  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Document  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">2.0  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Typed  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">None  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">CouchDB  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Document  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">1.1  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Typed  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">None  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">Riak  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Key-value  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">1.0  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Blob  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Ad hoc (Links)  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">Redis  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Key-value  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">2.4  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Semi-typed  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">None  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">PostgreSQL  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Relational  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">9.1  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Predefined   <br class="calibre1"/>and typed</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Predefined  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">Neo4j  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Graph  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">1.7  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Untyped  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Ad hoc (Edges)  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">HBase  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Columnar  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">0.90.3  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Predefined   <br class="calibre1"/>and typed</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">None  </blockquote></td></tr></table><br class="calibre1"/><br class="calibre1"/><br class="calibre1"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">    </span></span>
</th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Standard Object  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Written in   </span><br class="calibre1"/><span class="bold">Language</span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Interface Protocol  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">HTTP/REST  </span></blockquote></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">MongoDB  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">JSON  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">C++  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Custom over TCP  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Simple  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">CouchDB  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">JSON  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Erlang  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">HTTP  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Yes  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">Riak  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Text  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Erlang  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">HTTP,   <br class="calibre1"/>protobuf</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Yes  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">Redis  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">String  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">C/C++  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Simple text over TCP  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">PostgreSQL  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Table  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">C  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Custom over TCP  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">Neo4j  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Hash  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Java  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">HTTP  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Yes  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">HBase  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Columns  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Java  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Thrift, HTTP  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Yes  </blockquote></td></tr></table><a></a><p class="calibre23">​</p><br class="calibre1"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">    </span></span>
</th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Ad Hoc Query  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Mapreduce  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Scalable  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Durability  </span></blockquote></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">MongoDB  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Commands, mapreduce  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">JavaScript  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Datacenter  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Write-ahead journaling, Safe mode  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">CouchDB  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Temporary views  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">JavaScript  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Datacenter (via BigCouch)  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Crash-only  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">Riak  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Weak support, Lucene  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">JavaScript, Erlang  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Datacenter  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Durable write quorum  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">Redis  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Commands  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Cluster (via master-slave)  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Append-only log  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">PostgreSQL  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">SQL  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Cluster (via add-ons)  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">ACID  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">Neo4j  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Graph walking, Cypher, search  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No (in the   <br class="calibre1"/>distributed sense)</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Cluster (via HA)  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">ACID  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">HBase  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Weak  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Hadoop  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Datacenter  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Write-ahead logging  </blockquote></td></tr></table><br class="calibre1"/><br class="calibre1"/><br class="calibre1"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">    </span></span>
</th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Secondary   </span><br class="calibre1"/><span class="bold">Indexes</span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Versioning  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Bulk Load  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Very Large Files  </span></blockquote></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">MongoDB  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Yes  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">mongoimport  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">GridFS  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">CouchDB  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Yes  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Yes  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Bulk Doc API  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Attachments  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">Riak  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Yes  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Yes  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Lewak   <br class="calibre1"/>(deprecated)</blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">Redis  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">PostgreSQL  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Yes  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">COPY   <br class="calibre1"/>command</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">BLOBs  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">Neo4j  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Yes (via Lucene)  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">HBase  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Yes  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td></tr></table><a></a><p class="calibre23">​</p><br class="calibre1"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">    </span></span>
</th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Requires   </span><br class="calibre1"/><span class="bold">Compaction</span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Replication  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Sharding  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Concurrency  </span></blockquote></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">MongoDB  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Master-slave (via replica sets)  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Yes  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Write lock  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">CouchDB  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">File rewrite  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Master-master  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Yes (with   <br class="calibre1"/>filters in <br class="calibre1"/>BigCouch)</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Lock-free MVCC  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">Riak  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Peer-based, master-master  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Yes  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Vector-clocks  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">Redis  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Snapshot  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Master-slave  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Add-ons (e.g., client)  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">None  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">PostgreSQL  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Master-slave  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Add-ons (e.g., PL/Proxy)  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Table/row writer lock  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">Neo4j  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Master-slave (in Enterprise Edition)  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Write lock  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">HBase  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Master-slave  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Yes via HDFS  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Consistent per row  </blockquote></td></tr></table><br class="calibre1"/><br class="calibre1"/><br class="calibre1"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">    </span></span>
</th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Transactions  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Triggers  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Security  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Multitenancy  </span></blockquote></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">MongoDB  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Users  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Yes  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">CouchDB  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Update   <br class="calibre1"/>validation or Changes API</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Users  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Yes  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">Riak  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Pre/post-  <br class="calibre1"/>commits</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">None  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">Redis  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Multi operation queues  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Passwords  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">PostgreSQL  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">ACID  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Yes  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Users/groups  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Yes  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">Neo4j  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">ACID  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Transaction event handlers  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">None  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">HBase  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Yes (when enabled)  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Kerberos via Hadoop   <br class="calibre1"/>security</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">No  </blockquote></td></tr></table><a></a><p class="calibre23">​</p><br class="calibre1"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">    </span></span>
</th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Main Differentiator  </span></blockquote></th><th valign="top" class="calibre57"><span class="bold"><span class="calibre58">   </span></span><blockquote class="calibre59"><span class="bold">Weaknesses  </span></blockquote></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">MongoDB  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Easily query   <span class="italic">Big Data</span>
</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Embed-ability  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">CouchDB  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Durable and embeddable   <br class="calibre1"/>clusters</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Query-ability  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">Riak  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Highly available  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Query-ability  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">Redis  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Very, very fast  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Complex data  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">PostgreSQL  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Best of OSS RDBMS model  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Distributed availability  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">Neo4j  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Flexible graph  </blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">BLOBs or terabyte scale  </blockquote></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="bold">   </span><blockquote class="calibre59"><span class="bold">HBase  </span></blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Very large-scale, Hadoop   <br class="calibre1"/>infrastructure</blockquote></td><td valign="top" class="calibre16">   <blockquote class="calibre59">Flexible growth, query-ability  </blockquote></td></tr></table><p class="calibre116"><span class="calibre9"><span class="calibre18"><span class="calibre19">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos1996596" class="calibre1"><p class="calibre21" id="filepos1996601"><span class="calibre3"><span class="bold"><span class="calibre31"> Appendix 2</span></span></span></p><br class="calibre1"/><p class="calibre32"><span class="calibre3"><span class="bold"><span class="calibre4">The CAP Theorem</span></span></span></p><a></a><p class="calibre12"> Understanding the five database genres is an important selection criterion, but it’s not the only one. Another recurring theme in this book is the <span class="bold"><span class="calibre39">CAP</span></span> theorem, which lays bare an unsettling truth about how distributed database systems behave in the face of network instability. </p><a></a><p class="calibre12"><span class="bold"><span class="calibre39">CAP</span></span> proves that you can create a distributed database that is <span class="italic">consistent</span> (writes are atomic and all subsequent requests retrieve the new value), <span class="italic">available</span> (the database will always return a value as long as a single server is running), or <span class="italic">partition tolerant</span> (the system will still function even if server communication is temporarily lost—that is, a network partition), but you can have only two at once. </p><a></a><p class="calibre12"> In other words, you can create a distributed database system that is <span class="italic">consistent</span> and <span class="italic">partition tolerant</span>, a system that is <span class="italic">available</span> and <span class="italic">partition tolerant</span>, or a system that is <span class="italic">consistent</span> and <span class="italic">available</span> (but not <span class="italic">partition tolerant</span>—which basically means not distributed). But it is not possible to create a distributed database that is consistent and available and partition tolerant at the same time. </p><a></a><p class="calibre12"> The CAP theorem is pertinent when considering a distributed database, since you must decide what you are willing to give up. The database you choose will lose availability or consistency. Partition tolerance is strictly an architectural decision (will the database be distributed or not). It’s important to understand the CAP theorem to fully grok your options. The trade-offs made by the database implementations in this book are largely influenced by it. </p><blockquote class="calibre40"><span class="calibre41"><span class="bold">A CAP Adventure, Part I: CAP</span></span></blockquote><a></a><blockquote class="calibre42"><span class="calibre41"> Imagine the world as a giant distributed database system. All of the land in the world contains information about certain topics, and as long as you’re somewhere near people or technology, you can find an answer to your questions. </span></blockquote><a></a><blockquote class="calibre47"><span class="calibre41"> Now, for the sake of argument, imagine you are a passionate Beyoncé Knowles fan and the date is September 5, 2006. Suddenly, at your friend’s beach house party celebrating the release of Beyoncé’s second studio album, a freak tidal wave sweeps across the dock and drags you out to sea. You fashion a makeshift raft and wash up on a desert island days later. Without any means of communication, you are effectively </span><span class="calibre41"><span class="italic">partitioned</span></span><span class="calibre41"> from the rest of the system (the world). There you wait for five long years…. </span></blockquote><a></a><blockquote class="calibre47"><span class="calibre41"> One morning in 2011 you are awakened by shouts from the sea. A salty old schooner captain has discovered you! After five years alone, the captain leans over the bow and bellows: “How many studio albums does Beyoncé have?” </span></blockquote><a></a><blockquote class="calibre47"><span class="calibre41"> You now have a decision to make. You can answer the question with the most recent value you have (which is now five years old). If you answer his query, you are </span><span class="calibre41"><span class="italic">available</span></span><span class="calibre41">. Or, you can decline to answer the question, knowing since you are partitioned, your answer may not be </span><span class="calibre41"><span class="italic">consistent</span></span><span class="calibre41"> with the rest of the world. The captain won’t get his answer, but the state of the world remains consistent (if he sails back home, he can get the correct answer). As your role of queried node, you can either help keep the world’s data </span><span class="calibre41"><span class="italic">consistent</span></span><span class="calibre41"> or be </span><span class="calibre41"><span class="italic">available</span></span><span class="calibre41">, but </span><span class="calibre41"><span class="italic">not both</span></span><span class="calibre41">. </span></blockquote><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos2001009" class="calibre1"><p class="calibre24" id="filepos2001014"><span class="calibre25"><span class="bold"><span class="calibre26">A2.1 Eventual Consistency</span></span></span></p><a></a><p class="calibre27"> Distributed databases must be partition tolerant, so the choice between availability and consistency can be difficult. However, while CAP dictates that if you pick availability you cannot have true consistency, you can still provide <span class="italic">eventual consistency</span>. </p><a></a><p class="calibre12"> The idea behind eventual consistency is that each node is always available to serve requests. As a trade-off, data modifications are propagated in the background to other nodes. This means that at any time the system may be inconsistent, but the data is still largely accurate. </p><a></a><p class="calibre12"> The Internet’s Domain Name Service (<span class="bold"><span class="calibre39">DNS</span></span>) is a prime example of an eventually consistent system. You register a domain, and it may take a few days to propagate to all <span class="bold"><span class="calibre39">DNS</span></span> servers across the Internet. But at no time is any particular DNS server unavailable (assuming you can connect to it, that is). </p><blockquote class="calibre40"><span class="calibre41"><span class="bold">A CAP Adventure, Part II: Eventual Consistency</span></span></blockquote><a></a><blockquote class="calibre42"><span class="calibre41"> Let’s rewind two years, back to 2009. You’ve been on the island for three years at this point, and you spot a bottle in the sand—precious contact with the outside world. You uncork it and rejoice! You’ve just received an integral piece of knowledge… </span></blockquote><a></a><blockquote class="calibre47"><span class="calibre41"> The number of studio albums Beyoncé has is of utmost importance to the world’s aggregate knowledge. It’s so important, in fact, that every time she releases a new album, someone writes the current date and the number on a piece of paper. They place that paper in a bottle and throw it out to sea. If someone, like yourself, is partitioned from the rest of the world on a desert island, they can </span><span class="calibre41"><span class="italic">eventually</span></span><span class="calibre41"> have the correct answer. </span></blockquote><a></a><blockquote class="calibre47"><span class="calibre41"> Skip forward to the present. When the ship captain asks, “How many studio albums does Beyoncé have?” you remain </span><span class="calibre41"><span class="italic">available</span></span><span class="calibre41"> and answer “three.” You may be </span><span class="calibre41"><span class="italic">in</span></span><span class="calibre41">consistent with the rest of the world, but you are reasonably certain of your answer, having not yet received another bottle. </span></blockquote><a></a><blockquote class="calibre47"><span class="calibre41"> The story ends with the captain rescuing you, and you return home to find her new album and live happily ever after. As long as you remain on land, you needn’t be partition tolerant and can remain consistent and available until the end of your days. </span></blockquote><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos2004060" class="calibre1"><p class="calibre24" id="filepos2004065"><span class="calibre25"><span class="bold"><span class="calibre26">A2.2 CAP in the Wild</span></span></span></p><a></a><p class="calibre27"> Some partition-tolerant databases can be tuned to be more or less consistent or available on a per-request basis. Riak works like this, allowing clients to decide at request time what level of consistency they require. The other databases in this book largely occupy one corner or another of the CAP trade-off triangle. </p><a></a><p class="calibre12"> Redis, PostgreSQL, and Neo4J are consistent and available (CA); they don’t distribute data and so partitioning is not an issue (though arguably, CAP doesn’t make much sense in non-distributed systems). MongoDB and HBase are generally consistent and partition tolerant (CP). In the event of a network partition, they can become unable to respond to certain types of queries (for example, in a Mongo replica set you flag <span class="calibre9"><span class="calibre30">slaveok</span></span> to false for reads). In practice, hardware failure is handled gracefully—other still-networked nodes can cover for the downed server—but strictly speaking, in the CAP theorem sense, they are unavailable. Finally, CouchDB is available and partition tolerant (AP). Even though two or more CouchDB servers can replicate data between them, CouchDB doesn’t guarantee consistency between any two servers. </p><a></a><p class="calibre12"> It’s worth noting that most of these databases can be configured to change CAP type (Mongo can be CA, CouchDB can be CP), but here we’ve noted their default or common behaviors. </p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos2005732" class="calibre1"><p class="calibre24" id="filepos2005737"><span class="calibre25"><span class="bold"><span class="calibre26">A2.3 The Latency Trade-Off</span></span></span></p><p class="calibre27" id="filepos2005870"> There is more to distributed database system design than CAP, however. For example, low latency (speed) is a chief concern for many architects. If you read the Amazon Dynamo<a href="#filepos2006837"><span class="calibre13"><span class="underline">[60]</span></span></a> paper, you’ll notice a lot of talk about availability but also Amazon’s latency requirements. For a certain class of applications, even a small latency change can translate to a large costs. Yahoo’s PNUTS database famously gives up both availability on normal operation and consistency on partitions in order to squeeze a lower latency out of its design.<a href="#filepos2006837"><span class="calibre13"><span class="underline">[61]</span></span></a> It’s important to consider CAP when dealing with distributed databases, but it’s equally important to be aware that distributed database theory does not stop there. </p><p class="calibre23"><span class="calibre9"><span class="bold"><span class="calibre28">Footnotes</span></span></span></p><a id="filepos2006837"></a><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos2005870"><span class="calibre9"><span class="calibre13"><span class="underline">[60]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://allthingsdistributed.com/files/amazon-dynamo-sosp2007.pdf"><span class="calibre9"><span class="calibre13"><span class="underline">http://allthingsdistributed.com/files/amazon-dynamo-sosp2007.pdf</span></span></span></a><span class="calibre9">
</span></p></td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><a href="#filepos2005870"><span class="calibre9"><span class="calibre13"><span class="underline">[61]</span></span></span></a><span class="calibre9">  </span></td><td valign="top" class="calibre16"><p class="calibre22"><a href="http://dbmsmusings.blogspot.com/2010/04/problems-with-cap-and-yahoos-little.html"><span class="calibre9"><span class="calibre13"><span class="underline">http://dbmsmusings.blogspot.com/2010/04/problems-with-cap-and-yahoos-little.html</span></span></span></a><span class="calibre9">
</span></p></td></tr></table><p class="calibre17"><span class="calibre9"><span class="calibre18"><span class="calibre19">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos2007959" class="calibre1"><a id="filepos2007964"></a><br class="calibre1"/><p class="calibre21"><span class="calibre3"><span class="bold"><span class="calibre4">Bibliography</span></span></span></p><p class="calibre12"><span class="calibre41"><span class="bold">[TH01]</span></span>
</p><blockquote class="calibre117"><blockquote class="calibre42">David Thomas and Andrew Hunt. <span class="italic"><span class="bold"><span class="calibre118">Programming Ruby: The Pragmatic Programmer’s Guide</span></span></span>. Addison-Wesley, Reading, MA, 2001.</blockquote></blockquote><p class="calibre119"><span class="calibre41"><span class="bold">[Tat10]</span></span>
</p><blockquote class="calibre117"><blockquote class="calibre42">Bruce A. Tate. <span class="italic"><span class="bold"><span class="calibre118">Seven Languages in Seven Weeks: A Pragmatic Guide to Learning Programming Languages</span></span></span>. The Pragmatic Bookshelf, Raleigh, NC and Dallas, TX, 2010.</blockquote></blockquote><p class="calibre17"><span class="calibre9"><span class="calibre18"><span class="calibre19">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos2008935" class="calibre1"><p class="calibre24"><span class="calibre25"><span class="bold"><span class="calibre26">You May Be Interested In…</span></span></span></p><p class="calibre27"><span class="italic">Click a cover for more information</span>
</p><p class="calibre12"><a href="http://pragmaticprogrammer.com/titles/btlang"><span class="calibre13"><span class="underline">   </span></span></a><img src="images/00013.jpg" class="calibre120"/><a href="http://pragmaticprogrammer.com/titles/btlang"><span class="calibre13"><span class="underline">
</span></span></a>  <a href="http://pragmaticprogrammer.com/titles/bksqla"><span class="calibre13"><span class="underline">   </span></span></a><img src="images/00031.jpg" class="calibre120"/><a href="http://pragmaticprogrammer.com/titles/bksqla"><span class="calibre13"><span class="underline">
</span></span></a>  <a href="http://pragmaticprogrammer.com/titles/bhtmux"><span class="calibre13"><span class="underline">   </span></span></a><img src="images/00019.jpg" class="calibre120"/><a href="http://pragmaticprogrammer.com/titles/bhtmux"><span class="calibre13"><span class="underline">
</span></span></a>  <a href="http://pragmaticprogrammer.com/titles/dccar"><span class="calibre13"><span class="underline">   </span></span></a><img src="images/00037.jpg" class="calibre120"/><a href="http://pragmaticprogrammer.com/titles/dccar"><span class="calibre13"><span class="underline">
</span></span></a>  <a href="http://pragmaticprogrammer.com/titles/tbcoffee"><span class="calibre13"><span class="underline">   </span></span></a><img src="images/00024.jpg" class="calibre120"/><a href="http://pragmaticprogrammer.com/titles/tbcoffee"><span class="calibre13"><span class="underline">
</span></span></a>  <a href="http://pragmaticprogrammer.com/titles/pg_sass"><span class="calibre13"><span class="underline">   </span></span></a><img src="images/00006.jpg" class="calibre121"/><a href="http://pragmaticprogrammer.com/titles/pg_sass"><span class="calibre13"><span class="underline">
</span></span></a>  <a href="http://pragmaticprogrammer.com/titles/olag"><span class="calibre13"><span class="underline">   </span></span></a><img src="images/00011.jpg" class="calibre122"/><a href="http://pragmaticprogrammer.com/titles/olag"><span class="calibre13"><span class="underline">
</span></span></a>  <a href="http://pragmaticprogrammer.com/titles/jtrap"><span class="calibre13"><span class="underline">   </span></span></a><img src="images/00009.jpg" class="calibre120"/><a href="http://pragmaticprogrammer.com/titles/jtrap"><span class="calibre13"><span class="underline">
</span></span></a>  </p><hr class="calibre51"/><div class="calibre1"></div><div class="mbppagebreak"></div></div><div id="filepos2011322" class="calibre1"><p class="calibre123"><span class="calibre3"><span class="bold">Table of Contents</span></span></p><p class="calibre124"><a href="#filepos109"><span class="calibre13"><span class="underline">Seven Databases in Seven Weeks</span></span></a></p><p class="calibre125"><a href="#filepos2777"><span class="calibre13"><span class="underline">Table of Contents</span></span></a></p><p class="calibre125"><a href="#filepos19271"><span class="calibre13"><span class="underline">What Readers Are Saying About Seven Databases in Seven Weeks</span></span></a></p><p class="calibre125"><a href="#filepos22447"><span class="calibre13"><span class="underline">Foreword</span></span></a></p><p class="calibre125"><a href="#filepos26802"><span class="calibre13"><span class="underline">Acknowledgments</span></span></a></p><p class="calibre125"><a href="#filepos29870"><span class="calibre13"><span class="underline">Preface</span></span></a></p><blockquote class="calibre42"><a href="#filepos30646"><span class="calibre13"><span class="underline">Why Seven Databases</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos31696"><span class="calibre13"><span class="underline">What’s in This Book</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos33638"><span class="calibre13"><span class="underline">What This Book Is Not</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos36210"><span class="calibre13"><span class="underline">Code Examples and Conventions</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos37174"><span class="calibre13"><span class="underline">Online Resources</span></span></a></blockquote><p class="calibre125"><a href="#filepos39023"><span class="calibre13"><span class="underline">Chapter 1: Introduction</span></span></a></p><blockquote class="calibre42"><a href="#filepos40204"><span class="calibre13"><span class="underline">1.1 It Starts with a Question</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos44921"><span class="calibre13"><span class="underline">1.2 The Genres</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos57340"><span class="calibre13"><span class="underline">1.3 Onward and Upward</span></span></a></blockquote><p class="calibre125"><a href="#filepos58938"><span class="calibre13"><span class="underline">Chapter 2: PostgreSQL</span></span></a></p><blockquote class="calibre42"><a href="#filepos60523"><span class="calibre13"><span class="underline">2.1 That’s Post-greS-Q-L</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos64303"><span class="calibre13"><span class="underline">2.2 Day 1: Relations, CRUD, and Joins</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos137427"><span class="calibre13"><span class="underline">2.3 Day 2: Advanced Queries, Code, and Rules</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos248189"><span class="calibre13"><span class="underline">2.4 Day 3: Full-Text and Multidimensions</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos352192"><span class="calibre13"><span class="underline">2.5 Wrap-Up</span></span></a></blockquote><p class="calibre125"><a href="#filepos359256"><span class="calibre13"><span class="underline">Chapter 3: Riak</span></span></a></p><blockquote class="calibre42"><a href="#filepos361053"><span class="calibre13"><span class="underline">3.1 Riak Loves the Web</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos363242"><span class="calibre13"><span class="underline">3.2 Day 1: CRUD, Links, and MIMEs</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos436188"><span class="calibre13"><span class="underline">3.3 Day 2: Mapreduce and Server Clusters</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos533694"><span class="calibre13"><span class="underline">3.4 Day 3: Resolving Conflicts and Extending Riak</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos607083"><span class="calibre13"><span class="underline">3.5 Wrap-Up</span></span></a></blockquote><p class="calibre125"><a href="#filepos618168"><span class="calibre13"><span class="underline">Chapter 4: HBase</span></span></a></p><blockquote class="calibre42"><a href="#filepos620659"><span class="calibre13"><span class="underline">4.1 Introducing HBase</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos623040"><span class="calibre13"><span class="underline">4.2 Day 1: CRUD and Table Administration</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos676096"><span class="calibre13"><span class="underline">4.3 Day 2: Working with Big Data</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos801639"><span class="calibre13"><span class="underline">4.4 Day 3: Taking It to the Cloud</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos850166"><span class="calibre13"><span class="underline">4.5 Wrap-Up</span></span></a></blockquote><p class="calibre125"><a href="#filepos860648"><span class="calibre13"><span class="underline">Chapter 5: MongoDB</span></span></a></p><blockquote class="calibre42"><a href="#filepos862224"><span class="calibre13"><span class="underline">5.1 Hu(mongo)us</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos865181"><span class="calibre13"><span class="underline">5.2 Day 1: CRUD and Nesting</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos988577"><span class="calibre13"><span class="underline">5.3 Day 2: Indexing, Grouping, Mapreduce</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos1088290"><span class="calibre13"><span class="underline">5.4 Day 3: Replica Sets, Sharding, GeoSpatial, and GridFS</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos1139630"><span class="calibre13"><span class="underline">5.5 Wrap-Up</span></span></a></blockquote><p class="calibre125"><a href="#filepos1144182"><span class="calibre13"><span class="underline">Chapter 6: CouchDB</span></span></a></p><blockquote class="calibre42"><a href="#filepos1145777"><span class="calibre13"><span class="underline">6.1 Relaxing on the Couch</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos1148249"><span class="calibre13"><span class="underline">6.2 Day 1: CRUD, Futon, and cURL Redux</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos1195654"><span class="calibre13"><span class="underline">6.3 Day 2: Creating and Querying Views</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos1308826"><span class="calibre13"><span class="underline">6.4 Day 3: Advanced Views, Changes API, and Replicating Data</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos1424545"><span class="calibre13"><span class="underline">6.5 Wrap-Up</span></span></a></blockquote><p class="calibre125"><a href="#filepos1431208"><span class="calibre13"><span class="underline">Chapter 7: Neo4J</span></span></a></p><blockquote class="calibre42"><a href="#filepos1432790"><span class="calibre13"><span class="underline">7.1 Neo4J Is Whiteboard Friendly</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos1435517"><span class="calibre13"><span class="underline">7.2 Day 1: Graphs, Groovy, and CRUD</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos1539544"><span class="calibre13"><span class="underline">7.3 Day 2: REST, Indexes, and Algorithms</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos1626812"><span class="calibre13"><span class="underline">7.4 Day 3: Distributed High Availability</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos1661845"><span class="calibre13"><span class="underline">7.5 Wrap-Up</span></span></a></blockquote><p class="calibre125"><a href="#filepos1669053"><span class="calibre13"><span class="underline">Chapter 8: Redis</span></span></a></p><blockquote class="calibre42"><a href="#filepos1670371"><span class="calibre13"><span class="underline">8.1 Data Structure Server Store</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos1672748"><span class="calibre13"><span class="underline">8.2 Day 1: CRUD and Datatypes</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos1748754"><span class="calibre13"><span class="underline">8.3 Day 2: Advanced Usage, Distribution</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos1853801"><span class="calibre13"><span class="underline">8.4 Day 3: Playing with Other Databases</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos1942580"><span class="calibre13"><span class="underline">8.5 Wrap-Up</span></span></a></blockquote><p class="calibre125"><a href="#filepos1949345"><span class="calibre13"><span class="underline">Chapter 9: Wrapping Up</span></span></a></p><blockquote class="calibre42"><a href="#filepos1950544"><span class="calibre13"><span class="underline">9.1 Genres Redux</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos1960346"><span class="calibre13"><span class="underline">9.2 Making a Choice</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos1963415"><span class="calibre13"><span class="underline">9.3 Where Do We Go from Here?</span></span></a></blockquote><p class="calibre125"><a href="#filepos1964832"><span class="calibre13"><span class="underline">Appendix 1: Database Overview Tables</span></span></a></p><p class="calibre125"><a href="#filepos1996596"><span class="calibre13"><span class="underline">Appendix 2: The CAP Theorem</span></span></a></p><blockquote class="calibre42"><a href="#filepos2001009"><span class="calibre13"><span class="underline">A2.1 Eventual Consistency</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos2004060"><span class="calibre13"><span class="underline">A2.2 CAP in the Wild</span></span></a></blockquote><blockquote class="calibre42"><a href="#filepos2005732"><span class="calibre13"><span class="underline">A2.3 The Latency Trade-Off</span></span></a></blockquote><p class="calibre125"><a href="#filepos2007959"><span class="calibre13"><span class="underline">Bibliography</span></span></a></p><blockquote class="calibre42"><a href="#filepos2008935"><span class="calibre13"><span class="underline">You May Be Interested In…</span></span></a></blockquote><div class="calibre1"></div><div class="mbppagebreak"></div></div></div>

{% endraw %}

