---
layout: page
title: "Programming Clojure (for Roman Fäckl)"
prev: None
next: None
book_path: books/programming-clojure-for-roman-fackl-stuart-halloway_oeb/
---
{% include JB/setup %}
{% raw %}
<div>
<blockquote id="filepos109" class="calibre1"><span class="calibre2"><span class="bold"><span class="calibre3">Programming Clojure</span></span></span></blockquote><blockquote class="calibre1"><span class="calibre4"><span class="bold"><span class="calibre5">Second Edition</span></span></span></blockquote><blockquote class="calibre6"><span class="calibre4"><span class="bold"><span class="calibre5">by Stuart Halloway, Aaron Bedra</span></span></span></blockquote><blockquote class="calibre7"><span class="calibre8"><span class="calibre5">Version: P1.0 (April 2012)</span></span></blockquote><blockquote class="calibre9"><span class="calibre8"><span class="calibre10">Copyright © 2012 The Pragmatic Programmers, LLC. This book is licensed to the individual who purchased it. We don't copy-protect it because that would limit your ability to use it for your own purposes. Please don't break this trust—you can use this across all of your devices but please do not share this copy with other members of your team, with friends, or via file sharing services. Thanks. </span></span><br class="calibre11"/><span class="calibre8"><span class="calibre10">—Dave &amp; Andy.</span></span></blockquote><div class="mbppagebreak"></div><p class="calibre12"><span class="calibre2"><span class="bold">
</span></span></p><p class="calibre12"><span class="calibre8"> Many of the designations used by manufacturers and sellers to distinguish their products are claimed as trademarks. Where those designations appear in this book, and The Pragmatic Programmers, LLC was aware of a trademark claim, the designations have been printed in initial capital letters or in all capitals. The Pragmatic Starter Kit, The Pragmatic Programmer, Pragmatic Programming, Pragmatic Bookshelf and the linking </span><span class="calibre8"><span class="italic">g</span></span><span class="calibre8"> device are trademarks of The Pragmatic Programmers, LLC.</span>
</p><p class="calibre12"><span class="calibre8"> Every precaution was taken in the preparation of this book. However, the publisher assumes no responsibility for errors or omissions, or for damages that may result from the use of information (including program listings) contained herein.</span>
</p><p class="calibre12"><span class="calibre8"> Our Pragmatic courses, workshops, and other products can help you and your team create better software and have more fun. For more information, as well as the latest Pragmatic titles, please visit us at </span><a href="http://pragprog.com"><span class="calibre8">http://pragprog.com</span></a><span class="calibre8">.</span>
</p><div class="mbppagebreak"></div><p id="filepos2595" class="calibre12"><span class="calibre2"><span class="bold">​</span></span></p><p class="calibre13"><span class="italic"> In loving memory of my father and mentor, Craig Bedra, who taught me the value of learning by exploration and that there is no such thing as magic.—Aaron </span></p><div class="mbppagebreak"></div><p id="filepos2886" class="calibre12"><span class="calibre2"><span class="bold">Table of Contents</span></span></p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><a href="#filepos13531">Foreword for the Second Edition</a>
</li><li value="2" class="calibre16"><a href="#filepos15113">Foreword for the First Edition</a>
</li><li value="3" class="calibre16"><a href="#filepos17636">Acknowledgments</a>
</li><li value="4" class="calibre16"><a href="#filepos20640">Preface</a>
<ul class="calibre17"><li value="1" class="calibre16"><a href="#filepos22931">Who This Book Is For</a>
</li><li value="2" class="calibre16"><a href="#filepos24342">What Is in This Book</a>
</li><li value="3" class="calibre16"><a href="#filepos27472">How to Read This Book</a>
</li><li value="4" class="calibre16"><a href="#filepos32041">Notation Conventions</a>
</li><li value="5" class="calibre16"><a href="#filepos40345">Web Resources and Feedback</a>
</li><li value="6" class="calibre16"><a href="#filepos40949">Downloading Sample Code</a>
</li></ul></li><li value="5" class="calibre16"><a href="#filepos45104">Getting Started</a>
<ul class="calibre17"><li value="1" class="calibre16"><a href="#filepos47357">Why Clojure?</a>
</li><li value="2" class="calibre16"><a href="#filepos94711">Clojure Coding Quick Start</a>
</li><li value="3" class="calibre16"><a href="#filepos121815">Exploring Clojure Libraries</a>
</li><li value="4" class="calibre16"><a href="#filepos150081">Wrapping Up</a>
</li></ul></li><li value="6" class="calibre16"><a href="#filepos154108">Exploring Clojure</a>
<ul class="calibre17"><li value="1" class="calibre16"><a href="#filepos156033">Forms</a>
</li><li value="2" class="calibre16"><a href="#filepos208768">Reader Macros</a>
</li><li value="3" class="calibre16"><a href="#filepos215638">Functions</a>
</li><li value="4" class="calibre16"><a href="#filepos245180">Vars, Bindings, and Namespaces</a>
</li><li value="5" class="calibre16"><a href="#filepos281250">Calling Java</a>
</li><li value="6" class="calibre16"><a href="#filepos292238">Flow Control</a>
</li><li value="7" class="calibre16"><a href="#filepos311519">Where’s My for Loop?</a>
</li><li value="8" class="calibre16"><a href="#filepos334070">Metadata</a>
</li><li value="9" class="calibre16"><a href="#filepos344821">Wrapping Up</a>
</li></ul></li><li value="7" class="calibre16"><a href="#filepos350588">Unifying Data with Sequences</a>
<ul class="calibre17"><li value="1" class="calibre16"><a href="#filepos354001">Everything Is a Sequence</a>
</li><li value="2" class="calibre16"><a href="#filepos381095">Using the Sequence Library</a>
</li><li value="3" class="calibre16"><a href="#filepos428764">Lazy and Infinite Sequences</a>
</li><li value="4" class="calibre16"><a href="#filepos443494">Clojure Makes Java Seq-able</a>
</li><li value="5" class="calibre16"><a href="#filepos484006">Calling Structure-Specific Functions</a>
</li><li value="6" class="calibre16"><a href="#filepos537038">Wrapping Up</a>
</li></ul></li><li value="8" class="calibre16"><a href="#filepos539895">Functional Programming</a>
<ul class="calibre17"><li value="1" class="calibre16"><a href="#filepos542049">Functional Programming Concepts</a>
</li><li value="2" class="calibre16"><a href="#filepos555532">How to Be Lazy</a>
</li><li value="3" class="calibre16"><a href="#filepos599478">Lazier Than Lazy</a>
</li><li value="4" class="calibre16"><a href="#filepos635309">Recursion Revisited</a>
</li><li value="5" class="calibre16"><a href="#filepos694806">Wrapping Up</a>
</li></ul></li><li value="9" class="calibre16"><a href="#filepos699699">State</a>
<ul class="calibre17"><li value="1" class="calibre16"><a href="#filepos702197">Concurrency, Parallelism, and Locking</a>
</li><li value="2" class="calibre16"><a href="#filepos706924">Refs and Software Transactional Memory</a>
</li><li value="3" class="calibre16"><a href="#filepos741361">Use Atoms for Uncoordinated, Synchronous Updates</a>
</li><li value="4" class="calibre16"><a href="#filepos749782">Use Agents for Asynchronous Updates</a>
</li><li value="5" class="calibre16"><a href="#filepos773305">Managing Per-Thread State with Vars</a>
</li><li value="6" class="calibre16"><a href="#filepos798340">A Clojure Snake</a>
</li><li value="7" class="calibre16"><a href="#filepos863368">Wrapping Up</a>
</li></ul></li><li value="10" class="calibre16"><a href="#filepos867195">Protocols and Datatypes</a>
<ul class="calibre17"><li value="1" class="calibre16"><a href="#filepos869565">Programming to Abstractions</a>
</li><li value="2" class="calibre16"><a href="#filepos896919">Interfaces</a>
</li><li value="3" class="calibre16"><a href="#filepos901252">Protocols</a>
</li><li value="4" class="calibre16"><a href="#filepos937760">Datatypes</a>
</li><li value="5" class="calibre16"><a href="#filepos984443">Records</a>
</li><li value="6" class="calibre16"><a href="#filepos1020728">reify</a>
</li><li value="7" class="calibre16"><a href="#filepos1027275">Wrapping Up</a>
</li></ul></li><li value="11" class="calibre16"><a href="#filepos1030215">Macros</a>
<ul class="calibre17"><li value="1" class="calibre16"><a href="#filepos1031838">When to Use Macros</a>
</li><li value="2" class="calibre16"><a href="#filepos1033097">Writing a Control Flow Macro</a>
</li><li value="3" class="calibre16"><a href="#filepos1065738">Making Macros Simpler</a>
</li><li value="4" class="calibre16"><a href="#filepos1098591">Taxonomy of Macros</a>
</li><li value="5" class="calibre16"><a href="#filepos1147465">Wrapping Up</a>
</li></ul></li><li value="12" class="calibre16"><a href="#filepos1149215">Multimethods</a>
<ul class="calibre17"><li value="1" class="calibre16"><a href="#filepos1150910">Living Without Multimethods</a>
</li><li value="2" class="calibre16"><a href="#filepos1164941">Defining Multimethods</a>
</li><li value="3" class="calibre16"><a href="#filepos1183130">Moving Beyond Simple Dispatch</a>
</li><li value="4" class="calibre16"><a href="#filepos1194210">Creating Ad Hoc Taxonomies</a>
</li><li value="5" class="calibre16"><a href="#filepos1221606">When Should I Use Multimethods?</a>
</li><li value="6" class="calibre16"><a href="#filepos1241035">Wrapping Up</a>
</li></ul></li><li value="13" class="calibre16"><a href="#filepos1242160">Java Down and Dirty</a>
<ul class="calibre17"><li value="1" class="calibre16"><a href="#filepos1244409">Exception Handling</a>
</li><li value="2" class="calibre16"><a href="#filepos1265505">Wrestling with the Integers</a>
</li><li value="3" class="calibre16"><a href="#filepos1273018">Optimizing for Performance</a>
</li><li value="4" class="calibre16"><a href="#filepos1300752">Creating Java Classes in Clojure</a>
</li><li value="5" class="calibre16"><a href="#filepos1333384">A Real-World Example</a>
</li><li value="6" class="calibre16"><a href="#filepos1385428">Wrapping Up</a>
</li></ul></li><li value="14" class="calibre16"><a href="#filepos1386949">Building an Application</a>
<ul class="calibre17"><li value="1" class="calibre16"><a href="#filepos1389971">Scoring a Clojurebreaker Game</a>
</li><li value="2" class="calibre16"><a href="#filepos1411011">Testing the Scorer</a>
</li><li value="3" class="calibre16"><a href="#filepos1430311">test.generative</a>
</li><li value="4" class="calibre16"><a href="#filepos1474525">Creating an Interface</a>
</li><li value="5" class="calibre16"><a href="#filepos1511234">Deploying Your Code</a>
</li><li value="6" class="calibre16"><a href="#filepos1527483">Farewell</a>
</li></ul></li><li value="15" class="calibre16"><a href="#filepos1530798">Editor Support</a>
</li><li value="16" class="calibre16"><a href="#filepos1535852">Bibliography</a>
</li></ul><p class="calibre18"><span class="calibre8"><span class="calibre19"><span class="calibre20">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="mbppagebreak"></div><p id="filepos11096" class="calibre12"><span class="calibre2"><span class="bold"> What Readers Are Saying About Programming Clojure, Second Edition </span></span></p><p class="calibre12"> Clojure is one of the most interesting languages out there right now, and the best way of learning Clojure just got better. The second edition of <span class="italic">Programming Clojure</span> adds up-to-date information, plenty of practical examples, and a ton of useful tips on how to learn, work with, and succeed with Clojure. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23">→  </td><td valign="top" class="calibre23">Ola Bini </td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">  </td><td valign="top" class="calibre23">Creator of Ioke language, developer, ThoughtWorks </td></tr></table><p class="calibre24">Intimidated by Clojure? You won’t be after you read this book. Written in a clear and enjoyable style, it teaches the language one small piece at a time in a very accessible way. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23">→  </td><td valign="top" class="calibre23">Tim Berglund </td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">  </td><td valign="top" class="calibre23">Founder and Principal, August Technology Group </td></tr></table><p class="calibre24">The authors have charted the smoothest path yet to Clojure fluency with this well-organized and easy-to-read book. They have a knack for creating simple <br class="calibre11"/>and effective examples that demonstrate how the language’s unique features <br class="calibre11"/>fit together.</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23">→  </td><td valign="top" class="calibre23">Chris Houser </td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">  </td><td valign="top" class="calibre23">Primary Clojure contributor and library author </td></tr></table><p class="calibre24"> Clojure is a beautiful, elegant, and very powerful language on the JVM. It’s <br class="calibre11"/>like a cathedral: you could wander into it, but you’d prefer the company of a knowledgeable guide who can give you their perspectives, to help you grasp and appreciate the architecture and the art. In this book you can enjoy and benefit from the company of not one, but two seasoned developers who have the depth of knowledge and the perspective you need. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23">→  </td><td valign="top" class="calibre23">Dr. Venkat Subramaniam </td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">  </td><td valign="top" class="calibre23">Award-winning author and founder, Agile Developer, Inc. </td></tr></table><div class="mbppagebreak"></div><p id="filepos13531" class="calibre25"></p><br class="calibre11"/><p class="calibre26"><span class="calibre2"><span class="bold"><span class="calibre3">Foreword for the Second Edition</span></span></span></p><p class="calibre12"> A lot has changed since the first edition of the book. Yes, the language has had some enhancements, such as protocols and records. Most significant, though, is that Clojure has seen adoption across a wide variety of domains. People are building start-ups, analyzing large data sets, and doing communications, financial, web, and database work in Clojure. A large and supportive community has grown up around Clojure and, with it, a ton of libraries. These libraries are particularly exciting, not just in the facilities they provide. The best of them embrace the Clojure approach and mechanisms and, in doing so, reach new levels of simplicity and interoperability. </p><p class="calibre12"> In this second edition, Stuart and Aaron make sure to cover the language enhancements and include a taste of what it’s like to leverage some of the community libraries, while taking care to convey the concepts that make it all work. The book remains an exhilarating introduction to Clojure, and I hope it inspires you to join the community and, eventually, contribute to the library ecosystem. </p><p class="calibre12"> —Rich Hickey<br class="calibre11"/> Creator of Clojure<br class="calibre11"/></p><p class="calibre18"><span class="calibre8"><span class="calibre19"><span class="calibre20">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="mbppagebreak"></div><p id="filepos15113" class="calibre25"></p><br class="calibre11"/><p class="calibre26"><span class="calibre2"><span class="bold"><span class="calibre3">Foreword for the First Edition</span></span></span></p><p class="calibre12">We are drowning in complexity. Much of it is incidental—arising from the way we are solving problems, instead of the problems themselves. Object-oriented programming seems easy, but the programs it yields can often be complex webs of interconnected mutable objects. A single method call on a single object can cause a cascade of change throughout the object graph. Understanding what is going to happen when, how things got into the state they did, and how to get them back into that state in order to try to fix a bug are all very complex. Add concurrency to the mix, and it can quickly become unmanageable. We throw mock objects and test suites at our programs but too often fail to question our tools and programming models.</p><p class="calibre12">Functional programming offers an alternative. By emphasizing pure functions that take and return immutable values, it makes side effects the exception rather than the norm. This is only going to become more important as we face increasing concurrency in multicore architectures. Clojure is designed to make functional programming approachable and practical for commercial software developers. It recognizes the need for running on trusted infrastructure like the JVM and supporting existing customer investments in Java frameworks and libraries, as well as the immense practicality of doing so.</p><p class="calibre12">What is so thrilling about Stuart’s book is the extent to which he “gets” Clojure, because the language is targeted to professional developers just like himself. He clearly has enough experience of the pain points Clojure addresses, as well as an appreciation of its pragmatic approach. This book is an enthusiastic tour of the key features of Clojure, well grounded in practical applications, with gentle introductions to what might be new concepts. I hope it inspires you to write software in Clojure that you can look back at and say, “Not only does this do the job, but it does so in a robust and simple way, and writing it was fun too!”</p><p class="calibre12"> —Rich Hickey<br class="calibre11"/> Creator of Clojure<br class="calibre11"/></p><p class="calibre18"><span class="calibre8"><span class="calibre19"><span class="calibre20">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="mbppagebreak"></div><p id="filepos17636" class="calibre25"></p><br class="calibre11"/><p class="calibre26"><span class="calibre2"><span class="bold"><span class="calibre3">Acknowledgments</span></span></span></p><p class="calibre12"> Many people have contributed to what is good in this book. The problems and errors that remain are ours alone. </p><p class="calibre12"> Thanks to the awesome team at Relevance and Clojure/core for creating an atmosphere in which good ideas can grow and thrive. </p><p class="calibre12"> Thanks to the kind folks on the Clojure mailing list<a id="filepos18190"></a><a href="#filepos20113">[1]</a> for all their help and encouragement. </p><p class="calibre12"> Thanks to everyone at the Pragmatic Bookshelf. Thanks especially to our editor, Michael Swaine, for good advice delivered on a very aggressive schedule. Thanks to Dave Thomas and Andy Hunt for creating a fun platform for writing technical books and for betting on the passions of their authors. </p><p class="calibre12"> Thanks to all the people who posted suggestions on the book’s errata page.<a id="filepos18702"></a><a href="#filepos20443">[2]</a>
</p><p class="calibre12"> Thanks to our technical reviewers for all your comments and helpful suggestions, including Kevin Beam, Ola Bini, Sean Corfield, Fred Daoud, Steven Huwig, Tibor Simic, David Sletten, Venkat Subramaniam, and Stefan Turalski. </p><p class="calibre12"> A very special thanks to David Liebke who wrote the original content for Chapter 6, <a href="#filepos867195">​<span class="italic">Protocols and Datatypes</span>​</a>. He provided a fantastic guide through the new ideas and this book would not be the same without his contributions. </p><p class="calibre12">Thanks to Rich Hickey for creating the excellent Clojure language and fostering a community around it.</p><p class="calibre12">Thanks to my wife, Joey, and my daughters, Hattie, Harper, and Mabel Faire. You all make the sun rise.<span class="italic">—Stuart</span>
</p><p class="calibre12">Thanks to my wife, Erin, for endless love and encouragement.<span class="italic">—Aaron</span>
</p><p class="calibre27"><span class="calibre8"><span class="bold"><span class="calibre28">Footnotes</span></span></span></p><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos18190"><span class="calibre8">[1]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://groups.google.com/group/clojure"><span class="calibre8">http://groups.google.com/group/clojure</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos20113"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos18702"><span class="calibre8">[2]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://www.pragprog.com/titles/shcloj2/errata"><span class="calibre8">http://www.pragprog.com/titles/shcloj2/errata</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos20443"></a></table><p class="calibre18"><span class="calibre8"><span class="calibre19"><span class="calibre20">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="mbppagebreak"></div><p id="filepos20640" class="calibre25"></p><br class="calibre11"/><p class="calibre26"><span class="calibre2"><span class="bold"><span class="calibre3">Preface</span></span></span></p><p class="calibre12"> Clojure is a dynamic programming language for the Java Virtual Machine (JVM), with a compelling combination of features: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"><span class="italic">Clojure is elegant.</span> Clojure’s clean, careful design lets you write programs that get right to the essence of a problem, without a lot of clutter and ceremony. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"><span class="italic">Clojure is Lisp reloaded.</span> Clojure has the power inherent in Lisp but is not constrained by the history of Lisp. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"><span class="italic">Clojure is a functional language.</span> Data structures are immutable, and most functions are free from side effects. This makes it easier to write correct programs and to compose large programs from smaller ones. </p></li><a></a><li value="4" class="calibre30"><p class="calibre29"><span class="italic">Clojure simplifies concurrent programming.</span> Many languages build a concurrency model around locking, which is difficult to use correctly. Clojure provides several alternatives to locking: software transactional memory, agents, atoms, and dynamic variables. </p></li><a></a><li value="5" class="calibre30"><p class="calibre29"><span class="italic">Clojure embraces Java.</span> Calling from Clojure to Java is direct and fast, with no translation layer. </p></li><a></a><li value="6" class="calibre30"><p class="calibre29"><span class="italic">Unlike many popular dynamic languages, Clojure is fast.</span> Clojure is written to take advantage of the optimizations possible on modern JVMs. </p></li><a></a></ul><p class="calibre12"> Many other languages cover <span class="italic">some</span> of the features described in the previous list. Of all these languages, Clojure stands out. The individual features listed earlier are powerful and interesting. Their clean synergy in Clojure is <span class="italic">compelling</span>. We will cover all these features and more in Chapter 1, <a href="#filepos45104">​<span class="italic">Getting Started</span>​</a>. </p><div class="mbppagebreak"></div><p id="filepos22931" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">Who This Book Is For</span></span></span></p><p class="calibre34"> Clojure is a powerful, general-purpose programming language. As such, this book is for experienced programmers looking for power and elegance. This book will be useful for anyone with experience in a modern programming language such as C#, Java, Python, or Ruby. </p><p class="calibre12"> Clojure is built on top of the Java Virtual Machine, and it is <span class="italic">fast</span>. This book will be of particular interest to Java programmers who want the expressiveness of a dynamic language without compromising on performance. </p><p class="calibre12"> Clojure is helping to redefine what features belong in a general-purpose language. If you program in Lisp, use a functional language such as Haskell, or write explicitly concurrent programs, you will enjoy Clojure. Clojure combines ideas from Lisp, functional programming, and concurrent programming and makes them more approachable to programmers seeing these ideas for the first time. </p><p class="calibre12"> Clojure is part of a larger phenomenon. Languages such as Erlang, F#, Haskell, and Scala have garnered attention recently for their support of functional programming or their concurrency model. Enthusiasts of these languages will find much common ground with Clojure. </p><div class="mbppagebreak"></div><p id="filepos24342" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">What Is in This Book</span></span></span></p><p class="calibre34">Chapter 1, <a href="#filepos45104">​<span class="italic">Getting Started</span>​</a> demonstrates Clojure’s elegance as a general-purpose language, plus the functional style and concurrency model that make Clojure unique. It also walks you through installing Clojure and developing code interactively at the REPL. </p><p class="calibre12">Chapter 2, <a href="#filepos154108">​<span class="italic">Exploring Clojure</span>​</a> is a breadth-first overview of all of Clojure’s core constructs. After this chapter, you will be able to read most day-to-day Clojure code. </p><p class="calibre12"> The next two chapters cover functional programming. Chapter 3, <a href="#filepos350588">​<span class="italic">Unifying Data with Sequences</span>​</a> shows how all data can be unified under the powerful sequence metaphor. </p><p class="calibre12">Chapter 4, <a href="#filepos539895">​<span class="italic">Functional Programming</span>​</a> shows you how to write functional code in the same style used by the sequence library. </p><p class="calibre12">Chapter 5, <a href="#filepos699699">​<span class="italic">State</span>​</a> delves into Clojure’s concurrency model. Clojure provides four powerful models for dealing with concurrency, plus all of the goodness of Java’s concurrency libraries. </p><p class="calibre12">Chapter 6, <a href="#filepos867195">​<span class="italic">Protocols and Datatypes</span>​</a> walks through records, types, and protocols in Clojure. These concepts were introduced in Clojure 1.2.0 and enhanced in 1.3.0. </p><p class="calibre12">Chapter 7, <a href="#filepos1030215">​<span class="italic">Macros</span>​</a> shows off Lisp’s signature feature. Macros take advantage of the fact that Clojure code is data to provide metaprogramming abilities that are difficult or impossible in anything but a Lisp. </p><p class="calibre12">Chapter 8, <a href="#filepos1149215">​<span class="italic">Multimethods</span>​</a> covers one of Clojure’s answers to polymorphism. Polymorphism usually means “take the <span class="italic">class</span> of the <span class="italic">first</span> argument and dispatch a method based on that.” Clojure’s multimethods let you choose <span class="italic">any function</span> of <span class="italic">all</span> the arguments and dispatch based on that. </p><p class="calibre12">Chapter 9, <a href="#filepos1242160">​<span class="italic">Java Down and Dirty</span>​</a> shows you how to call Java from Clojure and call Clojure from Java. You will see how to take Clojure straight to the metal and get Java-level performance. </p><p class="calibre12"> Finally, Chapter 10, <a href="#filepos1386949">​<span class="italic">Building an Application</span>​</a> provides a view into a complete Clojure workflow. You will build an application from scratch, working through solving the various parts to a problem and thinking about simplicity and quality. You will use a set of helpful Clojure libraries to produce and deploy a web application. </p><p class="calibre12">Appendix 1, <a href="#filepos1530798">​<span class="italic">Editor Support</span>​</a> lists editor support options for Clojure, with links to setup instructions for each. </p><div class="mbppagebreak"></div><p id="filepos27472" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">How to Read This Book</span></span></span></p><p class="calibre34"> All readers should begin by reading the first two chapters in order. Pay particular attention to Section 1.1, <a href="#filepos47357">​<span class="italic">Why Clojure?</span>​</a>, which provides an overview of Clojure’s advantages. </p><p class="calibre12"> Experiment continuously. Clojure provides an interactive environment where you can get immediate feedback; see <a href="#filepos99495">​<span class="italic">Using the REPL</span>​</a> for more information. </p><p class="calibre12"> After you read the first two chapters, skip around as you like. But read Chapter 3, <a href="#filepos350588">​<span class="italic">Unifying Data with Sequences</span>​</a> before you read Chapter 5, <a href="#filepos699699">​<span class="italic">State</span>​</a>. These chapters lead you from Clojure’s immutable data structures to a powerful model for writing correct concurrency programs. </p><p class="calibre12"> As you make the move to longer code examples in the later chapters, make sure you use an editor that provides Clojure indentation for you. Appendix 1, <a href="#filepos1530798">​<span class="italic">Editor Support</span>​</a> will point you to common editor options. If you can, try to use an editor that supports parentheses balancing, such as Emacs’ paredit mode or the CounterClockWise plug-in for eclipse. This feature will be a huge help as you are learning to program in Clojure. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">For Functional Programmers</span></span></span></p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Clojure’s approach to FP strikes a balance between academic purity and the realities of execution on the current generation of JVMs. Read Chapter 4, <a href="#filepos539895">​<span class="italic">Functional Programming</span>​</a> carefully to understand how Clojure idioms differ from languages such as Haskell. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> The concurrency model of Clojure (Chapter 5, <a href="#filepos699699">​<span class="italic">State</span>​</a>) provides several explicit ways to deal with side effects and state and will make FP appealing to a broader audience. </p></li><a></a></ul><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">For Java/C# Programmers</span></span></span></p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Read Chapter 2, <a href="#filepos154108">​<span class="italic">Exploring Clojure</span>​</a> carefully. Clojure has very little syntax (compared to Java or C#), and we cover the ground rules fairly quickly. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Pay close attention to macros in Chapter 7, <a href="#filepos1030215">​<span class="italic">Macros</span>​</a>. These are the most alien part of Clojure when viewed from a Java or C# perspective. </p></li><a></a></ul><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">For Lisp Programmers</span></span></span></p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Some of Chapter 2, <a href="#filepos154108">​<span class="italic">Exploring Clojure</span>​</a> will be review, but read it anyway. Clojure preserves the key features of Lisp, but it breaks with Lisp tradition in several places, and they are covered here. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Pay close attention to the lazy sequences in Chapter 4, <a href="#filepos539895">​<span class="italic">Functional Programming</span>​</a>. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> Get an Emacs mode for Clojure that makes you happy before working through the code examples in later chapters. </p></li><a></a></ul><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">For Perl/Python/Ruby Programmers</span></span></span></p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Read Chapter 5, <a href="#filepos699699">​<span class="italic">State</span>​</a> carefully. Intraprocess concurrency is very important in Clojure. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Embrace macros (Chapter 7, <a href="#filepos1030215">​<span class="italic">Macros</span>​</a>). But do not expect to easily translate metaprogramming idioms from your language into macros. Remember always that macros execute at read time, not runtime. </p></li><a></a></ul><div class="mbppagebreak"></div><p id="filepos32041" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">Notation Conventions</span></span></span></p><p class="calibre34"> The following notation conventions are used throughout the book.</p><p class="calibre12">Literal code examples use the following font:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">+</span></span></span><span class="calibre8"> 2 2)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38">The result of executing a code example is preceded by <span class="calibre8"><span class="calibre39">-&gt;</span></span>.</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(+ 2 2)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 4​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Where console output cannot easily be distinguished from code and results, it is preceded by a pipe character (<span class="calibre8"><span class="calibre39">|</span></span>). </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(println "hello")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| hello​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> When introducing a Clojure form for the first time, we will show the grammar for the form like this: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(example-fn required-arg)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(example-fn optional-arg?)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(example-fn zero-or-more-arg*)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(example-fn one-or-more-arg+)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(example-fn &amp; collection-of-variable-args)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> The grammar is informal, using <span class="calibre8"><span class="calibre39">?</span></span>, <span class="calibre8"><span class="calibre39">*</span></span>, <span class="calibre8"><span class="calibre39">+</span></span>, and <span class="calibre8"><span class="calibre39">&amp;</span></span> to document different argument-passing styles, as shown previously. </p><p class="calibre12"> Clojure code is organized into <span class="italic">libs</span> (libraries). Where examples in the book depend on a library that is not part of the Clojure core, we document that dependency with a <span class="calibre8"><span class="calibre39">use</span></span> or <span class="calibre8"><span class="calibre39">require</span></span> form: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">use</span></span></span><span class="calibre8"> '[lib-name :only (var-names+)])​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">require</span></span></span><span class="calibre8"> '[lib-name :as </span><span class="calibre8"><span class="bold"><span class="calibre36">alias</span></span></span><span class="calibre8">])​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> This form of <span class="calibre8"><span class="calibre39">use</span></span> brings in only the names in <span class="calibre8"><span class="calibre39">var-names</span></span>, while <span class="calibre8"><span class="calibre39">require</span></span> creates an alias, making each function’s origin clear. For example, a commonly used function is <span class="calibre8"><span class="calibre39">file</span></span>, from the <span class="calibre8"><span class="calibre39">clojure.java.io</span></span> library: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(use '[clojure.java.io :only (file)])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(file "hello.txt")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #&lt;File hello.txt&gt;​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">or the <span class="calibre8"><span class="calibre39">require</span></span>-based counterpart:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(require '[clojure.java.io :as io])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(io/file "hello.txt")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #&lt;File hello.txt&gt;​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Clojure returns <span class="calibre8"><span class="calibre39">nil</span></span> from a successful call to <span class="calibre8"><span class="calibre39">use</span></span>. For brevity, this is omitted from the example listings. </p><p class="calibre12"> While reading the book, you will enter code in an interactive environment called the REPL. The REPL prompt looks like this: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">user</span></span> before the prompt tells the namespace you are currently working in. For most of the book’s examples, the current namespace is irrelevant. Where the namespace is irrelevant, we will use the following syntax for interaction with the REPL: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(+ 2 2)         ; input line without namespace prompt​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 4            ; return value​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">In those few instances where the current namespace is important, we will use this:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;</span><span class="calibre8"><span class="bold"><span class="calibre36"> (+ 2 2)  </span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="italic"><span class="calibre40">; input line with namespace prompt</span></span></span><span class="calibre8">-&gt; 4            ; return value​</span><span class="calibre8">
</span>
</td></tr></table><div class="mbppagebreak"></div><p id="filepos40345" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">Web Resources and Feedback</span></span></span></p><p class="calibre34"><span class="italic">Programming Clojure</span>’s official home on the Web is the <span class="italic">Programming Clojure</span> home page<a id="filepos40599"></a><a href="#filepos43603">[3]</a> at the Pragmatic Bookshelf website. From there you can order electronic or paper copies of the book and download sample code. You can also offer feedback by submitting errata entries<a id="filepos40818"></a><a href="#filepos43933">[4]</a> or posting in the forum<a id="filepos40878"></a><a href="#filepos44247">[5]</a> for the book. </p><div class="mbppagebreak"></div><p id="filepos40949" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">Downloading Sample Code</span></span></span></p><p class="calibre34"> The sample code for the book is available from one of two locations: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> The <span class="italic">Programming Clojure</span> home page<a href="#filepos44563">[6]</a> links to the official copy of the source code and is updated to match each release of the book. </p></li><a id="filepos41458"></a><li value="2" class="calibre30"><p class="calibre29"> The <span class="italic">Programming Clojure</span> git repository<a href="#filepos44907">[7]</a> is updated in real time. This is the latest, greatest code and may sometimes be <span class="italic">ahead</span> of the prose in the book. </p></li><a id="filepos41736"></a></ul><p class="calibre12"> Individual examples are in the <span class="calibre8"><span class="calibre39">examples</span></span> directory, unless otherwise noted. </p><p class="calibre12"> Throughout the book, listings begin with their filename, set apart from the actual code by a gray background. For example, the following listing comes from <span class="calibre8"><span class="calibre39">src/examples/preface.clj</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/preface.clj"><span class="calibre41"><span class="underline">src/examples/preface.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">println</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"hello"</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If you are reading the book in PDF form, you can click the little gray box preceding a code listing and download that listing directly. </p><p class="calibre12"> With the sample code in hand, you are ready to get started. We will begin by meeting the combination of features that make Clojure unique. </p><p class="calibre27"><span class="calibre8"><span class="bold"><span class="calibre28">Footnotes</span></span></span></p><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos40599"><span class="calibre8">[3]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://www.pragprog.com/titles/shcloj2/programming-clojure"><span class="calibre8">http://www.pragprog.com/titles/shcloj2/programming-clojure</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos43603"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos40818"><span class="calibre8">[4]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://www.pragprog.com/titles/shcloj2/errata"><span class="calibre8">http://www.pragprog.com/titles/shcloj2/errata</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos43933"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos40878"><span class="calibre8">[5]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://forums.pragprog.com/forums/207"><span class="calibre8">http://forums.pragprog.com/forums/207</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos44247"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos41458"><span class="calibre8">[6]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://www.pragprog.com/titles/shcloj2"><span class="calibre8">http://www.pragprog.com/titles/shcloj2</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos44563"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos41736"><span class="calibre8">[7]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://github.com/stuarthalloway/programming-clojure"><span class="calibre8">http://github.com/stuarthalloway/programming-clojure</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos44907"></a></table><p class="calibre18"><span class="calibre8"><span class="calibre19"><span class="calibre20">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="mbppagebreak"></div><p id="filepos45104" class="calibre25"><span class="calibre2"><span class="bold"><span class="calibre43"> Chapter 1</span></span></span></p><br class="calibre11"/><p class="calibre26"><span class="calibre2"><span class="bold"><span class="calibre3">Getting Started</span></span></span></p><p class="calibre12"> Many factors have contributed to Clojure’s quick rise. A quick web search will likely tell you that Clojure: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">is a functional language,</p></li><a></a><li value="2" class="calibre30"><p class="calibre29">is a Lisp for the JVM, and</p></li><a></a><li value="3" class="calibre30"><p class="calibre29">has special features for dealing with concurrency.</p></li><a></a></ul><p class="calibre12"> All of these things are important, but none of them is the key to thinking in Clojure. In our opinion, there are two key concepts that drive everything else in Clojure: simplicity and power. </p><p class="calibre12"> Simplicity has several meanings that are relevant in software, but the definition we mean is the original and best one: a thing is simple if it is not compound. Simple components allow systems to do what their designers intend, without also doing other things irrelevant to the task at hand. In our experience, irrelevant complexity quickly becomes dangerous complexity. </p><p class="calibre12"><span class="italic">Power</span> also has many meanings. The one we care about here is sufficiency to the tasks we want to undertake. To feel powerful as a programmer, you need to build on a substrate that is itself capable and widely deployed, e.g., the JVM. Then, your tools must give you full, unrestricted access to that power. Power is often a gatekeeping requirement for projects that must get the most out of their platform. </p><p class="calibre12"> As programmers, we have spent years tolerating baroquely complex tools that were the only way to get the power we needed or accepting reduced power for a sanity-enhancing simplification of the programming model. Some trade-offs are truly fundamental, but power vs. simplicity is not one of them. Clojure shows that power and simplicity can go hand in hand. </p><div class="mbppagebreak"></div><p id="filepos47357" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">1.1 Why Clojure?</span></span></span></p><p class="calibre34"> All of the distinctive features in Clojure are there to provide simplicity, power, or both. Here are a few examples: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Functional programming is simple, in that it isolates calculation from state and identity. Benefits: functional programs are easier to understand, write, test, optimize, and parallelize. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Clojure’s Java interop forms are powerful, giving you direct access to the semantics of the Java platform. Benefits: you can have performance and semantic equivalence to Java. Most importantly, you will never need to “drop down” to a lower-level language for a little extra power. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> Lisp is simple in two critical ways: it separates reading from evaluation, and the language syntax is made from a tiny number of orthogonal parts. Benefits: syntactic abstraction captures design patterns, and S-expressions are XML, JSON, and SQL as they should have been. </p></li><a></a><li value="4" class="calibre30"><p class="calibre29"> Lisp is also powerful, providing a compiler and macro system at runtime. Benefits: Lisp has late-bound decision making and easy DSLs. </p></li><a></a><li value="5" class="calibre30"><p class="calibre29"> Clojure’s time model is simple, separating values, identities, state, and time. Benefits: programs can perceive and remember information, without fear that somebody is about to scribble over the past. </p></li><a></a><li value="6" class="calibre30"><p class="calibre29"> Protocols are simple, separating polymorphism from derivation. Benefits: you get safe, ad hoc extensibility of type and abstractions, without a tangle of design patterns or fragile monkey patching. </p></li><a></a></ul><p class="calibre12"> This list of features acts as a road map for the rest of the book, so don’t worry if you don’t follow every little detail here. Each feature gets an entire chapter later. </p><p class="calibre12"> Let’s see some of these features in action by building a small application. Along the way, you will learn how to load and execute the larger examples we will use later in the book. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Clojure Is Elegant</span></span></span></p><p class="calibre44"> Clojure is high-signal, low-noise. As a result, Clojure programs are short programs. Short programs are cheaper to build, cheaper to deploy, and cheaper to maintain.<a id="filepos50177"></a><a href="#filepos151147">[8]</a> This is particularly true when the programs are concise rather than merely terse. As an example, consider the following Java code, from Apache Commons: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/data/snippets/isBlank.java"><span class="calibre41"><span class="underline">data/snippets/isBlank.java</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="bold"><span class="calibre36">public</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">class</span></span></span><span class="calibre8"> StringUtils {​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    </span><span class="calibre8"><span class="bold"><span class="calibre36">public</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">static</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">boolean</span></span></span><span class="calibre8"> isBlank(</span><span class="calibre8"><span class="bold"><span class="calibre36">String</span></span></span><span class="calibre8"> str) {​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        </span><span class="calibre8"><span class="bold"><span class="calibre36">int</span></span></span><span class="calibre8"> strLen;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        </span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (str == null || (strLen = str.length()) == 0) {​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            </span><span class="calibre8"><span class="bold"><span class="calibre36">return</span></span></span><span class="calibre8"> true;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        }​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        </span><span class="calibre8"><span class="bold"><span class="calibre36">for</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">int</span></span></span><span class="calibre8"> i = 0; i &lt; strLen; i++) {​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            </span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> ((</span><span class="calibre8"><span class="bold"><span class="calibre36">Character</span></span></span><span class="calibre8">.isWhitespace(str.charAt(i)) == false)) {​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                </span><span class="calibre8"><span class="bold"><span class="calibre36">return</span></span></span><span class="calibre8"> false;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            }​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        }​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        </span><span class="calibre8"><span class="bold"><span class="calibre36">return</span></span></span><span class="calibre8"> true;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    }​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">isBlank</span></span> method checks to see whether a string is <span class="italic">blank</span>: either empty or consisting of only whitespace. Here is a similar implementation in Clojure: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/introduction.clj"><span class="calibre41"><span class="underline">src/examples/introduction.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> blank? [</span><span class="calibre8"><span class="bold"><span class="calibre36">str</span></span></span><span class="calibre8">]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">every?</span></span></span><span class="calibre8"> #(Character/isWhitespace %) </span><span class="calibre8"><span class="bold"><span class="calibre36">str</span></span></span><span class="calibre8">))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The Clojure version is shorter. But even more important, it is <span class="italic">simpler</span>: it has no variables, no mutable state, and no branches. This is possible thanks to <span class="italic">higher-order functions</span>. A higher-order function is a function that takes functions as arguments and/or returns functions as results. The <span class="calibre8"><span class="calibre39">every?</span></span> function takes a function and a collection as its arguments and returns <span class="calibre8"><span class="calibre39">true</span></span> if that function returns true for every item in the collection. </p><p class="calibre12"> Because the Clojure version has no branches, it is easier to read and test. These benefits are magnified in larger programs. Also, while the code is concise, it is still readable. In fact, the Clojure program reads like a <span class="italic">definition</span> of blank: a string is blank if every character in it is whitespace. This is much better than the Commons method, which hides the definition of blank behind the implementation detail of loops and <span class="calibre8"><span class="calibre39">if</span></span> statements. </p><p class="calibre12"> As another example, consider defining a trivial <span class="calibre8"><span class="calibre39">Person</span></span> class in Java: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/data/snippets/Person.java"><span class="calibre41"><span class="underline">data/snippets/Person.java</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="bold"><span class="calibre36">public</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">class</span></span></span><span class="calibre8"> Person {​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    </span><span class="calibre8"><span class="bold"><span class="calibre36">private</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">String</span></span></span><span class="calibre8"> firstName;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    </span><span class="calibre8"><span class="bold"><span class="calibre36">private</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">String</span></span></span><span class="calibre8"> lastName;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    </span><span class="calibre8"><span class="bold"><span class="calibre36">public</span></span></span><span class="calibre8"> Person(</span><span class="calibre8"><span class="bold"><span class="calibre36">String</span></span></span><span class="calibre8"> firstName, </span><span class="calibre8"><span class="bold"><span class="calibre36">String</span></span></span><span class="calibre8"> lastName) {​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        this.firstName = firstName;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        this.lastName = lastName;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    }​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    </span><span class="calibre8"><span class="bold"><span class="calibre36">public</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">String</span></span></span><span class="calibre8"> getFirstName() {​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        </span><span class="calibre8"><span class="bold"><span class="calibre36">return</span></span></span><span class="calibre8"> firstName;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    }​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    </span><span class="calibre8"><span class="bold"><span class="calibre36">public</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">void</span></span></span><span class="calibre8"> setFirstName(</span><span class="calibre8"><span class="bold"><span class="calibre36">String</span></span></span><span class="calibre8"> firstName) {​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        this.firstName = firstName;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    }​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    </span><span class="calibre8"><span class="bold"><span class="calibre36">public</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">String</span></span></span><span class="calibre8"> getLastName() {​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        </span><span class="calibre8"><span class="bold"><span class="calibre36">return</span></span></span><span class="calibre8"> lastName;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    }​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    </span><span class="calibre8"><span class="bold"><span class="calibre36">public</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">void</span></span></span><span class="calibre8"> setLastName(</span><span class="calibre8"><span class="bold"><span class="calibre36">String</span></span></span><span class="calibre8"> lastName) {​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        this.lastName = lastName;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    }​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> In Clojure, you would define <span class="calibre8"><span class="calibre39">Person</span></span> with a single line: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defrecord</span></span></span><span class="calibre8"> Person [first-name last-name])​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">and work with the record like so:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def foo (-&gt;Person "Aaron" "Bedra"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/foo​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​foo​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #:user.Person{:first-name "Aaron", :last-name "Bedra"}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">defrecord</span></span> and related functions are covered in Section 6.3, <a href="#filepos901252">​<span class="italic">Protocols</span>​</a>. </p><p class="calibre12"> Other than being an order of magnitude shorter, the Clojure approach differs in that a Clojure <span class="calibre8"><span class="calibre39">Person</span></span> is <span class="italic">immutable</span>. Immutable data structures are naturally thread safe, and update capabilities can be layered when using Clojure’s references, agents, and atoms, which are covered in Chapter 5, <a href="#filepos699699">​<span class="italic">State</span>​</a>. Because records are immutable, Clojure also provides correct implementations of <span class="calibre8"><span class="calibre39">hashCode</span></span> and <span class="calibre8"><span class="calibre39">equals</span></span> automatically. </p><p class="calibre12"> Clojure has a lot of elegance baked in, but if you find something missing, you can add it yourself, thanks to the power of Lisp. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Clojure Is Lisp Reloaded</span></span></span></p><p class="calibre44"> Clojure is a Lisp. For decades, Lisp advocates have pointed out the advantages that Lisp has over, well, everything else. At the same time, Lisp’s world domination plan seems to be proceeding slowly. </p><p class="calibre12">Like any other Lisp, Clojure faces two challenges:</p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Clojure must succeed as a Lisp by persuading Lisp programmers that Clojure embraces the critical parts of Lisp. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> At the same time, Clojure needs to succeed <span class="italic">where past Lisps have failed</span> by winning support from the broader community of programmers. </p></li><a></a></ul><p class="calibre12"> Clojure meets these challenges by providing the metaprogramming capabilities of Lisp and at the same time embracing a set of syntax enhancements that make Clojure friendlier to non-Lisp programmers. </p><p class="calibre12"><span class="bold"><span class="calibre28">Why Lisp?</span></span></p><p class="calibre45"> Lisps have a tiny language core, almost no syntax, and a powerful macro facility. With these features, you can bend Lisp to meet your design, instead of the other way around. By contrast, consider the following snippet of Java code: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="bold"><span class="calibre36">public</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">class</span></span></span><span class="calibre8"> Person {​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="bold"><span class="calibre36">private</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">String</span></span></span><span class="calibre8"> firstName;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="bold"><span class="calibre36">public</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">String</span></span></span><span class="calibre8"> getFirstName() {​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="italic"><span class="calibre40">// continues</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> In this code, <span class="calibre8"><span class="calibre39">getFirstName</span></span> is a method. Methods are polymorphic and can bend to meet your needs. But the interpretation of <span class="italic">every other word</span> in the example is <span class="italic">fixed by the language</span>. Sometimes you really need to change what these words mean. So, for example, you might do the following: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Redefine <span class="calibre8"><span class="calibre39">private</span></span> to mean “private for production code but public for serialization and unit tests.” </p></li><a></a><li value="2" class="calibre30"><p class="calibre29">Redefine <span class="calibre8"><span class="calibre39">class</span></span> to automatically generate getters and setters for private fields, unless otherwise directed. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> Create a subclass of <span class="calibre8"><span class="calibre39">class</span></span> that provides callback hooks for life-cycle events. For example, a life cycle--aware class could fire an event whenever an instance of the class is created. </p></li><a></a></ul><p class="calibre12"> We have seen programs that needed all these features. Without them, programmers resort to repetitive, error-prone workarounds. Literally <span class="italic">millions</span> of lines of code have been written to work around missing features in programming languages. </p><p class="calibre12"> In most languages, you would have to petition the language implementer to add the kinds of features mentioned earlier. In Clojure, you can add your own language features with <span class="italic">macros</span> (Chapter 7, <a href="#filepos1030215">​<span class="italic">Macros</span>​</a>). Clojure itself is built out of macros such as <span class="calibre8"><span class="calibre39">defrecord</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defrecord</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">name</span></span></span><span class="calibre8"> [arg1 arg2 arg3])​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> If you need different semantics, write your own macro. If you want a variant of records with strong typing and configurable null-checking for all fields, you can create your own <span class="calibre8"><span class="calibre39">defrecord</span></span> macro, to be used like this: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defrecord</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">name</span></span></span><span class="calibre8"> [</span><span class="calibre8"><span class="bold"><span class="calibre36">Type</span></span></span><span class="calibre8"> :arg1 </span><span class="calibre8"><span class="bold"><span class="calibre36">Type</span></span></span><span class="calibre8"> :arg2 </span><span class="calibre8"><span class="bold"><span class="calibre36">Type</span></span></span><span class="calibre8"> :arg3]​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​  :allow-nulls false)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> This ability to reprogram the language from within the language is the unique advantage of Lisp. You will see facets of this idea described in various ways: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Lisp is homoiconic.<a href="#filepos151471">[9]</a> That is, Lisp code is just Lisp data. This makes it easy for programs to write other programs. </p></li><a id="filepos72889"></a><li value="2" class="calibre30"><p class="calibre29"> The whole language is there, all the time. Paul Graham’s essay “Revenge of the Nerds”<a href="#filepos151782">[10]</a> explains why this is so powerful. </p></li><a id="filepos73129"></a></ul><p class="calibre12"> Lisp syntax also eliminates rules for operator precedence and associativity. You will not find a table documenting operator precedence or associativity anywhere in this book. With fully parenthesized expressions, there is no possible ambiguity. </p><p class="calibre12"> The downside of Lisp’s simple, regular syntax, at least for beginners, is Lisp’s fixation on parentheses and on lists as the core datatype. Clojure offers an interesting combination of features that makes Lisp more approachable for non-Lispers. </p><p class="calibre12"><span class="bold"><span class="calibre28">Lisp, with Fewer Parentheses</span></span></p><p class="calibre45"> Clojure offers significant advantages for programmers coming to it from other Lisps: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Clojure generalizes Lisp’s physical list into an abstraction called a <span class="italic">sequence</span>. This preserves the power of lists, while extending that power to a variety of other data structures. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Clojure’s reliance on the JVM provides a standard library and a deployment platform with great reach. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> Clojure’s approach to symbol resolution and syntax quoting makes it easier to write many common macros. </p></li><a></a></ul><p class="calibre12"> Many Clojure programmers will be new to Lisp, and they have probably heard bad things about all those parentheses. Clojure keeps the parentheses (and the power of Lisp!) but improves on traditional Lisp syntax in several ways: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Clojure provides a convenient literal syntax for a wide variety of data structures besides just lists: regular expressions, maps, sets, vectors, and metadata. These features make Clojure code less “listy” than most Lisps. For example, function parameters are specified in a vector: <span class="calibre8"><span class="calibre39">[]</span></span> instead of a list: <span class="calibre8"><span class="calibre39">()</span></span>. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/introduction.clj"><span class="calibre41"><span class="underline">src/examples/introduction.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> hello-world [username]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">println</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">format</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"Hello, %s"</span></span></span><span class="calibre8"> username)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The vector makes the argument list jump out visually and makes Clojure function definitions easy to read. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> In Clojure, unlike most Lisps, commas are whitespace. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; make vectors look like arrays in other languages</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​[1, 2, 3, 4]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="bold"><span class="calibre36">-&gt;</span></span></span><span class="calibre8"> [1 2 3 4]​</span><span class="calibre8">
</span>
</td></tr></table></li><a></a><li value="3" class="calibre46"><p class="calibre29"> Idiomatic Clojure does not nest parentheses more than necessary. Consider the <span class="calibre8"><span class="calibre39">cond</span></span> macro, present in both Common Lisp and Clojure. <span class="calibre8"><span class="calibre39">cond</span></span> evaluates a set of test/result pairs, returning the first result for which a test form yields true. Each test/result pair is grouped with parentheses, like so: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; Common Lisp cond</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">cond</span></span></span><span class="calibre8"> ((</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> x 10) </span><span class="calibre8"><span class="italic"><span class="calibre42">"equal"</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​((</span><span class="calibre8"><span class="bold"><span class="calibre36">&gt;</span></span></span><span class="calibre8"> x 10) </span><span class="calibre8"><span class="italic"><span class="calibre42">"more"</span></span></span><span class="calibre8">))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Clojure avoids the extra parentheses:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; Clojure cond</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">cond</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> x 10) </span><span class="calibre8"><span class="italic"><span class="calibre42">"equal"</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">&gt;</span></span></span><span class="calibre8"> x 10) </span><span class="calibre8"><span class="italic"><span class="calibre42">"more"</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> This is an aesthetic decision, and both approaches have their supporters. The important thing is that Clojure takes the opportunity to be less Lispy when it can do so without compromising Lisp’s power. </p></li><a></a></ul><p class="calibre12"> Clojure is an excellent Lisp, both for Lisp experts and for Lisp beginners. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Clojure Is a Functional Language</span></span></span></p><p class="calibre44"> Clojure is a functional language but not a pure functional language like Haskell. Functional languages have the following properties: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Functions are <span class="italic">first-class objects</span>. That is, functions can be created at runtime, passed around, returned, and in general used like any other datatype. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Data is immutable.</p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> Functions are <span class="italic">pure</span>; that is, they have no side effects. </p></li><a></a></ul><p class="calibre12"> For many tasks, functional programs are easier to understand, less error-prone, and <span class="italic">much</span> easier to reuse. For example, the following short program searches a database of compositions for every composer who has written a composition named “Requiem”: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(for [c compositions :when (= "Requiem" (:name c))] (:composer c))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ("W. A. Mozart" "Giuseppe Verdi")​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The name <span class="calibre8"><span class="calibre39">for</span></span> does not introduce a loop but a <span class="italic">list comprehension</span>. Read the earlier code as “For each <span class="calibre8"><span class="calibre39">c</span></span> in <span class="calibre8"><span class="calibre39">compositions</span></span>, where the name of <span class="calibre8"><span class="calibre39">c</span></span> is <span class="calibre8"><span class="calibre39">"Requiem"</span></span>, yield the composer of <span class="calibre8"><span class="calibre39">c</span></span>.” List comprehension is covered more fully in <a href="#filepos413679">​<span class="italic">Transforming Sequences</span>​</a>. </p><p class="calibre12">This example has four desirable properties:</p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> It is <span class="italic">simple</span>; it has no loops, variables, or mutable state. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> It is <span class="italic">thread safe</span>; no locking is needed. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> It is <span class="italic">parallelizable</span>; you could farm out individual steps to multiple threads without changing the code for each step. </p></li><a></a><li value="4" class="calibre30"><p class="calibre29"> It is <span class="italic">generic</span>; <span class="calibre8"><span class="calibre39">compositions</span></span> could be a plain set or XML or a database result set. </p></li><a></a></ul><p class="calibre12"> Contrast functional programs with <span class="italic">imperative</span> programs, where explicit statements alter program state. Most object-oriented programs are written in an imperative style and have <span class="italic">none</span> of the advantages listed earlier; they are unnecessarily complex, not thread safe, not parallelizable, and difficult to generalize. (For a head-to-head comparison of functional and imperative styles, skip forward to Section 2.7, <a href="#filepos311519">​<span class="italic">Where’s My for Loop?</span>​</a>.) </p><p class="calibre12"> People have known about the advantages of functional languages for a while now. And yet, pure functional languages like Haskell have not taken over the world, because developers find that not everything fits easily into the pure functional view. </p><p class="calibre12"> There are four reasons that Clojure can attract more interest now than functional languages have in the past: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">Functional programming is more urgent today than ever before. Massively multicore hardware is right around the corner, and functional languages provide a clear approach for taking advantage of it. Functional programming is covered in Chapter 4, <a href="#filepos539895">​<span class="italic">Functional Programming</span>​</a>. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Purely functional languages can make it awkward to model state that really needs to change. Clojure provides a structured mechanism for working with changeable state via software transactional memory and refs (), agents (), atoms (), and dynamic binding (). </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> Many functional languages are statically typed. Clojure’s dynamic typing makes it more accessible for programmers learning functional programming. </p></li><a></a><li value="4" class="calibre30"><p class="calibre29"> Clojure’s Java invocation approach is <span class="italic">not</span> functional. When you call Java, you enter the familiar, mutable world. This offers a comfortable haven for beginners learning functional programming and a pragmatic alternative to functional style when you need it. Java invocation is covered in Chapter 9, <a href="#filepos1242160">​<span class="italic">Java Down and Dirty</span>​</a>. </p></li><a></a></ul><p class="calibre12"> Clojure’s approach to changing state enables concurrency without explicit locking and complements Clojure’s functional core. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Clojure Simplifies Concurrent Programming</span></span></span></p><p class="calibre44"> Clojure’s support for functional programming makes it easy to write thread-safe code. Since immutable data structures cannot <span class="italic">ever</span> change, there is no danger of data corruption based on another thread’s activity. </p><p class="calibre12"> However, Clojure’s support for concurrency goes beyond just functional programming. When you need references to mutable data, Clojure protects them via software transactional memory (STM). STM is a higher-level approach to thread safety than the locking mechanisms that Java provides. Rather than creating fragile, error-prone locking strategies, you can protect shared state with transactions. This is much more productive, because many programmers have a good understanding of transactions based on experience with databases. </p><p class="calibre12"> For example, the following code creates a working, thread-safe, in-memory database of accounts: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> accounts (</span><span class="calibre8"><span class="bold"><span class="calibre36">ref</span></span></span><span class="calibre8"> #{}))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defrecord</span></span></span><span class="calibre8"> Account [id balance])​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">ref</span></span> function creates a transactionally protected reference to the current state of the database. Updating is trivial. The following code adds a new account to the database: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">dosync</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">alter</span></span></span><span class="calibre8"> accounts </span><span class="calibre8"><span class="bold"><span class="calibre36">conj</span></span></span><span class="calibre8"> (-&gt;Account </span><span class="calibre8"><span class="italic"><span class="calibre42">"CLJ"</span></span></span><span class="calibre8"> 1000.00)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">dosync</span></span> causes the update to <span class="calibre8"><span class="calibre39">accounts</span></span> to execute inside a transaction. This guarantees thread safety, and it is easier to use than locking. With transactions, you never have to worry about which objects to lock or in what order. The transactional approach will also perform better under some common usage scenarios, because (for example) readers will never block. </p><p class="calibre12"> Although the example here is trivial, the technique is general, and it works on real-world problems. See Chapter 5, <a href="#filepos699699">​<span class="italic">State</span>​</a> for more on concurrency and STM in Clojure. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Clojure Embraces the Java Virtual Machine</span></span></span></p><p class="calibre44"> Clojure gives you clean, simple, direct access to Java. You can call any Java API directly: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(System/getProperties)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="bold"><span class="calibre36">-&gt;</span></span></span><span class="calibre8"> {java.runtime.name=Java(TM) SE Runtime Environment​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="bold"><span class="calibre36">..</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"> many more </span><span class="calibre8"><span class="bold"><span class="calibre36">..</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Clojure adds a lot of syntactic sugar for calling Java. We won’t get into the details here (see Section 2.5, <a href="#filepos281250">​<span class="italic">Calling Java</span>​</a>), but notice that in the following code the Clojure version has both fewer dots <span class="italic">and fewer parentheses</span> than the Java version: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">// Java</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre42">"hello"</span></span></span><span class="calibre8">.getClass().getProtectionDomain()​</span><span class="calibre8">
</span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​; Clojure​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(.. </span><span class="calibre8"><span class="italic"><span class="calibre42">"hello"</span></span></span><span class="calibre8"> getClass getProtectionDomain)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Clojure provides simple functions for implementing Java interfaces and subclassing Java classes. Also, Clojure functions all implement <span class="calibre8"><span class="calibre39">Callable</span></span> and <span class="calibre8"><span class="calibre39">Runnable</span></span>. This makes it trivial to pass the following anonymous function to the constructor for a Java <span class="calibre8"><span class="calibre39">Thread</span></span>. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">start (</span><span class="calibre8"><span class="bold"><span class="calibre36">new</span></span></span><span class="calibre8"> Thread (</span><span class="calibre8"><span class="bold"><span class="calibre36">fn</span></span></span><span class="calibre8"> [] (</span><span class="calibre8"><span class="bold"><span class="calibre36">println</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"Hello"</span></span></span><span class="calibre8"> (Thread/currentThread)))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="bold"><span class="calibre36">-&gt;</span></span></span><span class="calibre8"> Hello #&lt;Thread Thread[Thread-0,5,main]</span><span class="calibre8"><span class="bold"><span class="calibre36">&gt;</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The funny output here is Clojure’s way of printing a Java instance. <span class="calibre8"><span class="calibre39">Thread</span></span> is the class name of the instance, and <span class="calibre8"><span class="calibre39">Thread[Thread-0,5,main]</span></span> is the instance’s <span class="calibre8"><span class="calibre39">toString</span></span> representation. </p><p class="calibre12"> (Note that in the preceding example the new thread will run to completion, but its output may interleave in some strange way with the REPL prompt. This is not a problem with Clojure but simply the result of having more than one thread writing to an output stream.) </p><p class="calibre12"> Because the Java invocation syntax in Clojure is clean and simple, it is idiomatic to use Java directly, rather than to hide Java behind Lispy wrappers. </p><p class="calibre12"> Now that you have seen a few of the reasons to use Clojure, it is time to start writing some code. </p><div class="mbppagebreak"></div><p id="filepos94711" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">1.2 Clojure Coding Quick Start</span></span></span></p><p class="calibre34"> To run Clojure and the code in this book, you need two things:</p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"><span class="italic">A Java runtime.</span> Download<a href="#filepos152155">[11]</a> and install Java version 5 or greater. Java version 6 has significant performance improvements and better exception reporting, so prefer this if possible. </p></li><a id="filepos95270"></a><li value="2" class="calibre30"><p class="calibre29"><span class="italic">Leiningen.</span>
<a href="#filepos152474">[12]</a> Leiningen is a tool for managing dependencies and launching tasks against your code. It is also the most common tool for this job in the Clojure space. </p></li><a id="filepos95554"></a></ul><p class="calibre12"> You will use Leiningen to install Clojure and all of the dependencies for the sample code in this book. If you already have Leiningen installed, you should be familiar with the basics. If not, you should take a quick tour of Leiningen’s GitHub page,<a id="filepos95846"></a><a href="#filepos152793">[13]</a> where you will find install instructions as well as basic usage instructions. Don’t worry about learning everything now, though, because this book will guide you through the commands necessary to follow along at home. </p><p class="calibre12"> While you are working through the book, use the version of Clojure tied to the book’s sample code. After you read the book, you can follow the instructions in <a href="#filepos96914">​<span class="italic">Building Clojure Yourself</span>​</a> to build an up-to-the-minute version of Clojure. </p><p class="calibre12"> See <a href="#filepos40949">​<span class="italic">Downloading Sample Code</span>​</a> for instructions on downloading the sample code. Once you have downloaded the sample code, you will need to use Leiningen to fetch the dependencies. From the root of the example code folder, run this: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​lein deps​</span><span class="calibre8">
</span>
</td></tr></table><blockquote id="filepos96914" class="calibre47"><span class="calibre41"><span class="bold">Building Clojure Yourself</span></span></blockquote><blockquote class="calibre48"><span class="calibre41"> You may want to build Clojure from source to get access to newer features and bug fixes. Here’s how: </span></blockquote><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span><span class="calibre41">
</span></td><td valign="top" class="calibre23"><span class="calibre8">​git clone git://github.com/clojure/clojure.git​</span><span class="calibre8">
</span><span class="calibre41">
</span></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span><span class="calibre41">
</span></td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="bold"><span class="calibre36">cd</span></span></span><span class="calibre8"> clojure​</span><span class="calibre8">
</span><span class="calibre41">
</span></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span><span class="calibre41">
</span></td><td valign="top" class="calibre23"><span class="calibre8">​mvn package​</span><span class="calibre8">
</span><span class="calibre41">
</span></td></tr></table><blockquote class="calibre49"><span class="calibre41"> The sample code is regularly updated to match the current development head of Clojure. Check the </span><span class="calibre8"><span class="calibre39">README</span></span><span class="calibre41"> file in the sample code to see the revision numbers that the samples were most recently tested with. </span></blockquote><p class="calibre50"> The dependencies will be downloaded and placed in the proper location. You can test your install by navigating to the directory where you placed the sample code and running a Clojure <span class="italic">read-eval-print loop</span> (REPL). Leiningen contains a REPL launch script that loads Clojure along with the dependencies that we will need later in the book. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​lein repl​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> When you successfully launch the REPL, it should prompt you with <span class="calibre8"><span class="calibre39">user=&gt;</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​Clojure​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Now you are ready for “Hello World.”</p><p id="filepos99495" class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Using the REPL</span></span></span></p><p class="calibre44"> To see how to use the REPL, let’s create a few variants of “Hello World.” First, type <span class="calibre8"><span class="calibre39">(println "hello world")</span></span> at the REPL prompt: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt; (println "hello world")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt;</span><span class="calibre8"><span class="bold"><span class="calibre36"> hello world</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The second line, <span class="calibre8"><span class="calibre39">hello world</span></span>, is the console output you requested. </p><p class="calibre12"> Next, encapsulate your “Hello World” into a function that can address a person by name: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defn hello [name] (str "Hello, " name))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/hello​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Let’s break this down:</p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"><span class="calibre8"><span class="calibre39">defn</span></span> defines a function. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">hello</span></span> is the function name. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">hello</span></span> takes one argument, <span class="calibre8"><span class="calibre39">name</span></span>. </p></li><a></a><li value="4" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">str</span></span> is a function call that concatenates an arbitrary list of arguments into a string. </p></li><a></a><li value="5" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">defn</span></span>, <span class="calibre8"><span class="calibre39">hello</span></span>, <span class="calibre8"><span class="calibre39">name</span></span>, and <span class="calibre8"><span class="calibre39">str</span></span> are all <span class="italic">symbols</span>, which are names that refer to things. Legal symbols are defined in <a href="#filepos174518">​<span class="italic">Symbols</span>​</a>. </p></li><a></a></ul><p class="calibre12"> Look at the return value, <span class="calibre8"><span class="calibre39">#’user/hello</span></span>. The prefix <span class="calibre8"><span class="calibre39">#’</span></span> indicates that the function was stored in a Clojure <span class="italic">var</span>, and <span class="calibre8"><span class="calibre39">user</span></span> is the <span class="italic">namespace</span> of the function. (The <span class="calibre8"><span class="calibre39">user</span></span> namespace is the REPL default, like the default package in Java.) You do not need to worry about vars and namespaces yet; they are covered in Section 2.4, <a href="#filepos245180">​<span class="italic">Vars, Bindings, and Namespaces</span>​</a>. </p><p class="calibre12">Now you can call <span class="calibre8"><span class="calibre39">hello</span></span>, passing in your name:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;</span><span class="calibre8"><span class="bold"><span class="calibre36"> (hello "Stu")</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Hello, Stu"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If you get your REPL into a state that confuses you, the simplest fix is to kill the REPL with <span class="calibre8"><span class="calibre39">CTRL</span></span>+<span class="calibre8"><span class="calibre39">C</span></span> on Windows or <span class="calibre8"><span class="calibre39">CTRL</span></span>+<span class="calibre8"><span class="calibre39">D</span></span> on *nix and then start another one. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Special Variables</span></span></span></p><p class="calibre44"> The REPL includes several useful special variables. When you are working in the REPL, the results of evaluating the three most recent expressions are stored in the special variables <span class="calibre8"><span class="calibre39">*1</span></span>, <span class="calibre8"><span class="calibre39">*2</span></span>, and <span class="calibre8"><span class="calibre39">*3</span></span>, respectively. This makes it easy to work iteratively. Say hello to a few different names: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;</span><span class="calibre8"><span class="bold"><span class="calibre36"> (hello "Stu")</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Hello, Stu"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;</span><span class="calibre8"><span class="bold"><span class="calibre36"> (hello "Clojure")</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Hello, Clojure"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now, you can use the special variables to combine the results of your recent work: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(str *1 " and " *2)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Hello, Clojure and Hello, Stu"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If you make a mistake in the REPL, you will see a Java exception. The details are often omitted for brevity. For example, dividing by zero is a no-no: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;</span><span class="calibre8"><span class="bold"><span class="calibre36"> (/ 1 0)</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ArithmeticException Divide by zero  clojure.lang.Numbers.divide​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Here the problem is obvious, but sometimes the problem is more subtle and you want the detailed stack trace. The <span class="calibre8"><span class="calibre39">*e</span></span> special variable holds the last exception. Because Clojure exceptions are Java exceptions, you can ask for the stacktrace by calling <span class="calibre8"><span class="calibre39">pst</span></span> (print stacktrace).<a id="filepos107132"></a><a href="#filepos153095">[14]</a>
</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;</span><span class="calibre8"><span class="bold"><span class="calibre36"> (pst)</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ArithmeticException Divide by zero​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|   clojure.lang.Numbers.divide​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|   sun.reflect.NativeMethodAccessorImpl.invoke0​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|   sun.reflect.NativeMethodAccessorImpl.invoke​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|   sun.reflect.DelegatingMethodAccessorImpl.invoke​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|   java.lang.reflect.Method.invoke​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|   clojure.lang.Reflector.invokeMatchingMethod​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|   clojure.lang.Reflector.invokeStaticMethod​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|   user/eval1677​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|   clojure.lang.Compiler.eval​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|   clojure.lang.Compiler.eval​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|   clojure.core/eval​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Java interop is covered in Chapter 9, <a href="#filepos1242160">​<span class="italic">Java Down and Dirty</span>​</a>.</p><p class="calibre12"> If you have a block of code that is too large to conveniently type at the REPL, save the code into a file, and then load that file from the REPL. You can use an absolute path or a path relative to where you launched the REPL: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​; save some work in temp.clj, and then ...​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;</span><span class="calibre8"><span class="bold"><span class="calibre36"> (load-file "temp.clj")</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The REPL is a terrific environment for trying ideas and getting immediate feedback. For best results, keep a REPL open at all times while reading this book. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Adding Shared State</span></span></span></p><p class="calibre44"> The <span class="calibre8"><span class="calibre39">hello</span></span> function of the previous section is <span class="italic">pure</span>; that is, it has no side effects. Pure functions are easy to develop, test, and understand, and you should prefer them for many tasks. </p><p class="calibre12"> That said, most programs have some shared state and will use impure functions to manage that shared state. Let’s extend <span class="calibre8"><span class="calibre39">hello</span></span> to keep track of past visitors. First, you will need a data structure to track the visitors. A set will do the trick: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​#{}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #{}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">#{}</span></span> is a literal for an empty set. Next, you will need <span class="calibre8"><span class="calibre39">conj</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">conj</span></span></span><span class="calibre8"> coll item)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">conj</span></span> is short for conjoin, and it builds a new collection with an item added. <span class="calibre8"><span class="calibre39">conj</span></span> an element onto a set to see that a new set is created: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(conj #{} "Stu")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #{"Stu"}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now that you can build new sets, you need some way to keep track of the <span class="italic">current</span> set of visitors. Clojure provides several <span class="italic">reference types</span> (refs) for this purpose. The most basic reference type is the atom: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">atom</span></span></span><span class="calibre8"> initial-state)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> To name your atom, you can use <span class="calibre8"><span class="calibre39">def</span></span>:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">symbol</span></span></span><span class="calibre8"> initial-value?)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">def</span></span> is like <span class="calibre8"><span class="calibre39">defn</span></span> but more general. A <span class="calibre8"><span class="calibre39">def</span></span> can define functions <span class="italic">or</span> data. Use <span class="calibre8"><span class="calibre39">atom</span></span> to create an atom, and use <span class="calibre8"><span class="calibre39">def</span></span> to bind the atom to the name <span class="calibre8"><span class="calibre39">visitors</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def visitors (atom #{}))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/visitors​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> To update a reference, you must use a function such as <span class="calibre8"><span class="calibre39">swap!</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">swap!</span></span></span><span class="calibre8"> r update-fn &amp; args)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">swap!</span></span> applies an <span class="calibre8"><span class="calibre39">update-fn</span></span> to reference <span class="calibre8"><span class="calibre39">r</span></span>, with optional <span class="calibre8"><span class="calibre39">args</span></span> if necessary. Try to <span class="calibre8"><span class="calibre39">swap!</span></span> a visitor into <span class="calibre8"><span class="calibre39">visitors</span></span>, using <span class="calibre8"><span class="calibre39">conj</span></span> as the update function: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(swap! visitors conj "Stu")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #{"Stu"}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">atom</span></span> is one of several reference types in Clojure. Choosing the appropriate reference type requires care (discussed in Chapter 5, <a href="#filepos699699">​<span class="italic">State</span>​</a>). </p><p class="calibre12"> At any time, you can peek inside the ref with <span class="calibre8"><span class="calibre39">deref</span></span> or with the shorter <span class="calibre8"><span class="calibre39">@</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(deref visitors)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #{"Stu"}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​@visitors​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #{"Stu"}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now you are ready to build the new, more elaborate version of <span class="calibre8"><span class="calibre39">hello</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/introduction.clj"><span class="calibre41"><span class="underline">src/examples/introduction.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> hello​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="italic"><span class="calibre42">"Writes hello message to *out*. Calls you by username.</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre42">  Knows if you have been here before."</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  [username]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">swap!</span></span></span><span class="calibre8"> visitors </span><span class="calibre8"><span class="bold"><span class="calibre36">conj</span></span></span><span class="calibre8"> username)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">str</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"Hello, "</span></span></span><span class="calibre8"> username))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Next, check that visitors are correctly tracked in memory:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(hello "Rich")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Hello, Rich"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​@visitors​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #{"Aaron" "Stu" "Rich"}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> In all probability, your visitors list is different from the one shown here. That’s the problem with state! Your results will vary, depending on when things happened. You can reason about a function with direct local knowledge. Reasoning about state requires a full understanding of history. </p><p class="calibre12"> Avoid state where possible. But when you need it, make it sane and manageable by using refs such as atoms. Atoms (and all other Clojure reference types) are safe for multiple threads and processors. Better yet, this safety comes without any need for locks, which are notoriously tricky to use. </p><p class="calibre12"> At this point, you should feel comfortable entering small bits of code at the REPL. Larger units of code aren’t that different; you can load and run Clojure libraries from the REPL as well. Let’s explore that next. </p><div class="mbppagebreak"></div><p id="filepos121815" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">1.3 Exploring Clojure Libraries</span></span></span></p><p class="calibre34"> Clojure code is packaged in <span class="italic">libraries</span>. Each Clojure library belongs to a <span class="italic">namespace</span>, which is analogous to a Java package. You can load a Clojure library with <span class="calibre8"><span class="calibre39">require</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">require</span></span></span><span class="calibre8"> quoted-namespace-symbol)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> When you require a library named <span class="calibre8"><span class="calibre39">clojure.java.io</span></span>, Clojure looks for a file named <span class="calibre8"><span class="calibre39">clojure/java/io.clj</span></span> on the <span class="calibre8"><span class="calibre39">CLASSPATH</span></span>. Try it: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;</span><span class="calibre8"><span class="bold"><span class="calibre36"> (require 'clojure.java.io)</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The leading single quote (<span class="calibre8"><span class="calibre39">’</span></span>) is required, and it <span class="italic">quotes</span> the library name (quoting is covered in Section 2.2, <a href="#filepos208768">​<span class="italic">Reader Macros</span>​</a>). The <span class="calibre8"><span class="calibre39">nil</span></span> returned indicates success. While you are at it, test that you can load the sample code for this chapter, <span class="calibre8"><span class="calibre39">examples.introduction</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;</span><span class="calibre8"><span class="bold"><span class="calibre36"> (require 'examples.introduction)</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">examples.introduction</span></span> library includes an implementation of the Fibonacci numbers, which is the traditional “Hello World” program for functional languages. We will explore the Fibonacci numbers in more detail in Section 4.2, <a href="#filepos555532">​<span class="italic">How to Be Lazy</span>​</a>. For now, just make sure that you can execute the sample function <span class="calibre8"><span class="calibre39">fibs</span></span>. Enter the following line of code at the REPL to take the first ten Fibonacci numbers: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(take 10 examples.introduction/fibs)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (0 1 1 2 3 5 8 13 21 34)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If you see the first ten Fibonacci numbers as listed here, you have successfully installed the book samples. </p><p class="calibre12"> The book samples are all unit tested, with tests located in the <span class="calibre8"><span class="calibre39">examples/test</span></span> directory. The tests for the samples themselves are not explicitly covered in the book, but you may find them useful for reference. You can run the unit tests yourself with <span class="calibre8"><span class="calibre39">lein test</span></span>. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Require and Use</span></span></span></p><p class="calibre44"> When you <span class="calibre8"><span class="calibre39">require</span></span> a Clojure library, you must refer to items in the library with a namespace-qualified name. Instead of <span class="calibre8"><span class="calibre39">fibs</span></span>, you must say <span class="calibre8"><span class="calibre39">examples.introduction/fibs</span></span>. Make sure to launch a new REPL,<a id="filepos126308"></a><a href="#filepos153628">[15]</a> and then try it: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(require 'examples.introduction)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(take 10 examples.introduction/fibs)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (0 1 1 2 3 5 8 13 21 34)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Fully qualified names get old quickly. You can <span class="calibre8"><span class="calibre39">refer</span></span> a namespace, creating mappings for all its names in your current namespace: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">refer</span></span></span><span class="calibre8"> quoted-namespace-symbol)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Call <span class="calibre8"><span class="calibre39">refer</span></span> on <span class="calibre8"><span class="calibre39">examples.introduction</span></span>, and verify that you can then call <span class="calibre8"><span class="calibre39">fibs</span></span> directly: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(refer 'examples.introduction)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(take 10 fibs)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (0 1 1 2 3 5 8 13 21 34)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> For convenience, the <span class="calibre8"><span class="calibre39">use</span></span> function will <span class="calibre8"><span class="calibre39">require</span></span> and <span class="calibre8"><span class="calibre39">refer</span></span> a library in a single step: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">use</span></span></span><span class="calibre8"> quoted-namespace-symbol)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38">From a new REPL you should be able to do the following:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(use 'examples.introduction)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(take 10 fibs)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (0 1 1 2 3 5 8 13 21 34)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> As you are working through the book samples, you can call <span class="calibre8"><span class="calibre39">require</span></span> or <span class="calibre8"><span class="calibre39">use</span></span> with a <span class="calibre8"><span class="calibre39">:reload</span></span> flag to force a library to reload: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(use :reload 'examples.introduction)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">:reload</span></span> flag is useful if you are making changes and want to see results without restarting the REPL. </p><p id="filepos131443" class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Finding Documentation</span></span></span></p><p class="calibre44"> Often you can find the documentation you need right at the REPL. The most basic helper function<a id="filepos131675"></a><a href="#filepos153911">[16]</a> is <span class="calibre8"><span class="calibre39">doc</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">doc</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">name</span></span></span><span class="calibre8">)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Use <span class="calibre8"><span class="calibre39">doc</span></span> to print the documentation for <span class="calibre8"><span class="calibre39">str</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;</span><span class="calibre8"><span class="bold"><span class="calibre36"> (doc str)</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-------------------------​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​clojure.core/str​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​([] [x] [x &amp; ys])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​With no args, returns the empty string. With one arg x, returns​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​x.toString().  (str nil) returns the empty string. With more than​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​one arg, returns the concatenation of the str values of the args.​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The first line of <span class="calibre8"><span class="calibre39">doc</span></span>’s output contains the fully qualified name of the function. The next line contains the possible argument lists, generated directly from the code. (Some common argument names and their uses are explained in <a href="#filepos134356">​<span class="italic">Conventions for Parameter Names</span>​</a>.) Finally, the remaining lines contain the function’s <span class="italic">doc string</span>, if the function definition included one. </p><blockquote id="filepos134356" class="calibre47"><span class="calibre41"><span class="bold">Conventions for Parameter Names</span></span></blockquote><blockquote class="calibre48"><span class="calibre41"> The documentation strings for </span><span class="calibre8"><span class="calibre39">reduce</span></span><span class="calibre41"> and </span><span class="calibre8"><span class="calibre39">areduce</span></span><span class="calibre41"> show several terse parameter names. Here are some parameter names and how they are normally used: </span></blockquote><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><th valign="top" class="calibre51"><span class="calibre41"><span class="bold">   </span></span><blockquote class="calibre52"><span class="calibre41"><span class="bold">Parameter  </span></span></blockquote></th><th valign="top" class="calibre51"><span class="calibre41"><span class="bold">   </span></span><blockquote class="calibre52"><span class="calibre41"><span class="bold">Usage  </span></span></blockquote></th></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre41">   </span><blockquote class="calibre52"><span class="calibre41">a  </span></blockquote></td><td valign="top" class="calibre23"><span class="calibre41">   </span><blockquote class="calibre52"><span class="calibre41">A Java array  </span></blockquote></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre41">   </span><blockquote class="calibre52"><span class="calibre41">agt  </span></blockquote></td><td valign="top" class="calibre23"><span class="calibre41">   </span><blockquote class="calibre52"><span class="calibre41">An agent  </span></blockquote></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre41">   </span><blockquote class="calibre52"><span class="calibre41">coll  </span></blockquote></td><td valign="top" class="calibre23"><span class="calibre41">   </span><blockquote class="calibre52"><span class="calibre41">A collection  </span></blockquote></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre41">   </span><blockquote class="calibre52"><span class="calibre41">expr  </span></blockquote></td><td valign="top" class="calibre23"><span class="calibre41">   </span><blockquote class="calibre52"><span class="calibre41">An expression  </span></blockquote></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre41">   </span><blockquote class="calibre52"><span class="calibre41">f  </span></blockquote></td><td valign="top" class="calibre23"><span class="calibre41">   </span><blockquote class="calibre52"><span class="calibre41">A function  </span></blockquote></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre41">   </span><blockquote class="calibre52"><span class="calibre41">idx  </span></blockquote></td><td valign="top" class="calibre23"><span class="calibre41">   </span><blockquote class="calibre52"><span class="calibre41">Index  </span></blockquote></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre41">   </span><blockquote class="calibre52"><span class="calibre41">r  </span></blockquote></td><td valign="top" class="calibre23"><span class="calibre41">   </span><blockquote class="calibre52"><span class="calibre41">A ref  </span></blockquote></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre41">   </span><blockquote class="calibre52"><span class="calibre41">v  </span></blockquote></td><td valign="top" class="calibre23"><span class="calibre41">   </span><blockquote class="calibre52"><span class="calibre41">A vector  </span></blockquote></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre41">   </span><blockquote class="calibre52"><span class="calibre41">val  </span></blockquote></td><td valign="top" class="calibre23"><span class="calibre41">   </span><blockquote class="calibre52"><span class="calibre41">A value  </span></blockquote></td></tr></table><blockquote class="calibre53"><span class="calibre41"> These names may seem a little terse, but there is a good reason for them: the “good names” are often taken by Clojure functions! Naming a parameter that collides with a function name is legal but considered bad style: the parameter will shadow the function, which will be unavailable while the parameter is in scope. So, don’t call your refs </span><span class="calibre8"><span class="calibre39">ref</span></span><span class="calibre41">, your agents </span><span class="calibre8"><span class="calibre39">agent</span></span><span class="calibre41">, or your counts </span><span class="calibre8"><span class="calibre39">count</span></span><span class="calibre41">. Those names refer to functions. </span></blockquote><p class="calibre50"> You can add a doc string to your own functions by placing it immediately after the function name: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/introduction.clj"><span class="calibre41"><span class="underline">src/examples/introduction.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> hello​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="italic"><span class="calibre42">"Writes hello message to *out*. Calls you by username"</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  [username]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">println</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">str</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"Hello, "</span></span></span><span class="calibre8"> username)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Sometimes you will not know the exact name you want documentation for. The <span class="calibre8"><span class="calibre39">find-doc</span></span> function will search for anything whose <span class="calibre8"><span class="calibre39">doc</span></span> output matches a regular expression or string you pass in: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">find-doc</span></span></span><span class="calibre8"> s)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Use <span class="calibre8"><span class="calibre39">find-doc</span></span> to explore how Clojure does reduce: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt; (</span><span class="calibre8"><span class="bold"><span class="calibre36">find-doc</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"reduce"</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-------------------------​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​clojure/areduce​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​([a idx ret init expr])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​Macro​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="bold"><span class="calibre36">..</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"> details elided </span><span class="calibre8"><span class="bold"><span class="calibre36">..</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-------------------------​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​clojure/reduce​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​([f coll] [f </span><span class="calibre8"><span class="bold"><span class="calibre36">val</span></span></span><span class="calibre8"> coll])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="bold"><span class="calibre36">..</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"> details elided </span><span class="calibre8"><span class="bold"><span class="calibre36">..</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">reduce</span></span> reduces Clojure collections and is covered in <a href="#filepos413679">​<span class="italic">Transforming Sequences</span>​</a>. <span class="calibre8"><span class="calibre39">areduce</span></span> is for interoperation with Java arrays and is covered in <a href="#filepos1315515">​<span class="italic">Using Java Collections</span>​</a>. </p><p class="calibre12"> Much of Clojure is written in Clojure, and it is instructive to read the source code. You can view the <span class="calibre8"><span class="calibre39">source</span></span> of a Clojure function using the <span class="calibre8"><span class="calibre39">repl</span></span> library. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(clojure.repl/source a-symbol)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38">Try viewing the source of the simple <span class="calibre8"><span class="calibre39">identity</span></span> function:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(use 'clojure.repl)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(source identity)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (defn identity​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     "Returns its argument."​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     {:added "1.0"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      :static true}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     [x] x)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Of course, you can also use Java’s Reflection API. You can use methods such as <span class="calibre8"><span class="calibre39">class</span></span>, <span class="calibre8"><span class="calibre39">ancestors</span></span>, and <span class="calibre8"><span class="calibre39">instance?</span></span> to reflect against the underlying Java object model and tell, for example, that Clojure’s collections are also Java collections: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(ancestors (class [1 2 3]))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #{clojure.lang.ILookup clojure.lang.Sequential​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     java.lang.Object clojure.lang.Indexed​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     java.lang.Iterable clojure.lang.IObj​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     clojure.lang.IPersistentCollection​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     clojure.lang.IPersistentVector clojure.lang.AFn​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     java.lang.Comparable java.util.RandomAccess​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     clojure.lang.Associative​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     clojure.lang.APersistentVector clojure.lang.Counted​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     clojure.lang.Reversible clojure.lang.IPersistentStack​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     java.util.List clojure.lang.IEditableCollection​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     clojure.lang.IFn clojure.lang.Seqable​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     java.util.Collection java.util.concurrent.Callable​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     clojure.lang.IMeta java.io.Serializable java.lang.Runnable}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Clojure’s complete API is documented online at <a href="http://clojure.github.com/clojure">http://clojure.github.com/clojure</a>. The right sidebar links to all functions and macros by name, and the left sidebar links to a set of overview articles on various Clojure features. </p><div class="mbppagebreak"></div><p id="filepos150081" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">1.4 Wrapping Up</span></span></span></p><p class="calibre34"> You have just gotten the whirlwind tour of Clojure. You have seen Clojure’s expressive syntax, learned about Clojure’s approach to Lisp, and seen how easy it is to call Java code from Clojure. </p><p class="calibre12"> You have Clojure running in your own environment, and you have written short programs at the REPL to demonstrate functional programming and the reference model for dealing with state. Now it is time to explore the entire language. </p><p class="calibre27"><span class="calibre8"><span class="bold"><span class="calibre28">Footnotes</span></span></span></p><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos50177"><span class="calibre8">[8]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><span class="calibre8"><span class="italic">Software Estimation: Demystifying the Black Art</span></span><span class="calibre8"> [McC06] is a great read and makes the case that smaller is cheaper.</span></p></td></tr><a id="filepos151147"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos72889"><span class="calibre8">[9]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://en.wikipedia.org/wiki/Homoiconicity"><span class="calibre8">http://en.wikipedia.org/wiki/Homoiconicity</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos151471"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos73129"><span class="calibre8">[10]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://www.paulgraham.com/icad.html"><span class="calibre8">http://www.paulgraham.com/icad.html</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos151782"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos95270"><span class="calibre8">[11]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html"><span class="calibre8">http://www.oracle.com/technetwork/java/javase/downloads/index.html</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos152155"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos95554"><span class="calibre8">[12]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://github.com/technomancy/leiningen"><span class="calibre8">http://github.com/technomancy/leiningen</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos152474"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos95846"><span class="calibre8">[13]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://github.com/technomancy/leiningen"><span class="calibre8">http://github.com/technomancy/leiningen</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos152793"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos107132"><span class="calibre8">[14]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><span class="calibre8"><span class="calibre39">pst</span></span><span class="calibre8"> is available only in Clojure 1.3.0 and greater.</span></p></td></tr><a id="filepos153095"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos126308"><span class="calibre8">[15]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><span class="calibre8">Creating a new REPL will prevent name collisions between your previous work and the sample code functions of the same name. This is not a problem in real-world development, as you will see in </span><a href="#filepos266617"><span class="calibre8">​</span><span class="calibre8"><span class="italic">Namespaces</span></span><span class="calibre8">​</span></a><span class="calibre8">.</span></p></td></tr><a id="filepos153628"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos131675"><span class="calibre8">[16]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><span class="calibre8"><span class="calibre39">doc</span></span><span class="calibre8"> is actually a Clojure macro.</span></p></td></tr><a id="filepos153911"></a></table><p class="calibre18"><span class="calibre8"><span class="calibre19"><span class="calibre20">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="mbppagebreak"></div><p id="filepos154108" class="calibre25"><span class="calibre2"><span class="bold"><span class="calibre43"> Chapter 2</span></span></span></p><br class="calibre11"/><p class="calibre26"><span class="calibre2"><span class="bold"><span class="calibre3">Exploring Clojure</span></span></span></p><p class="calibre12"> Clojure offers great power through functional style, concurrency support, and clean Java interop. But before you can appreciate all these features, you have to start with the language basics. In this chapter, you will take a quick tour of the Clojure language, including the following: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">Forms</p></li><a></a><li value="2" class="calibre30"><p class="calibre29">Reader macros</p></li><a></a><li value="3" class="calibre30"><p class="calibre29">Functions</p></li><a></a><li value="4" class="calibre30"><p class="calibre29">Bindings and namespaces</p></li><a></a><li value="5" class="calibre30"><p class="calibre29">Flow control</p></li><a></a><li value="6" class="calibre30"><p class="calibre29">Metadata</p></li><a></a></ul><p class="calibre12"> If your background is primarily in imperative languages, this tour may seem to be missing key language constructs, such as variables and <span class="calibre8"><span class="calibre39">for</span></span> loops. Section 2.7, <a href="#filepos311519">​<span class="italic">Where’s My for Loop?</span>​</a> will show you how you can <span class="italic">live better</span> without <span class="calibre8"><span class="calibre39">for</span></span> loops and variables. </p><p class="calibre12"> Clojure is very expressive, and this chapter covers many concepts quite quickly. Don’t worry if you don’t understand every detail; we will revisit these topics in more detail in later chapters. If possible, bring up a REPL, and follow along with the examples as you read. </p><div class="mbppagebreak"></div><p id="filepos156033" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">2.1 Forms</span></span></span></p><p class="calibre34"> Clojure is <span class="italic">homoiconic</span>,<a id="filepos156201"></a><a href="#filepos346678">[17]</a> which is to say that Clojure code is composed of Clojure data. When you run a Clojure program, a part of Clojure called the <span class="italic">reader</span> reads the text of the program in chunks called <span class="italic">forms</span> and translates them into Clojure data structures. Clojure then compiles and executes the data structures. </p><p class="calibre12"> The Clojure forms covered in this book are summarized in Figure 1, <a href="#filepos156806">​<span class="italic">Clojure forms</span>​</a>. To see forms in action, let’s start with some simple forms supporting numeric types. </p><br class="calibre11"/><br class="calibre11"/><table valign="top" id="filepos156806" class="calibre54"><tr valign="top" class="calibre55"><th valign="top" class="calibre56"><span class="bold">   </span><blockquote class="calibre52"><span class="bold">Form  </span></blockquote></th><th valign="top" class="calibre56"><span class="bold">   </span><blockquote class="calibre52"><span class="bold">Example(s)  </span></blockquote></th><th valign="top" class="calibre56"><span class="bold">   </span><blockquote class="calibre52"><span class="bold">Primary Coverage  </span></blockquote></th></tr><tr valign="top" class="calibre55"><td valign="top" class="calibre57">   <blockquote class="calibre52">Boolean  </blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">   <span class="calibre8"><span class="calibre39">true</span></span>, <span class="calibre8"><span class="calibre39">false</span></span>
</blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">   <a href="#filepos188344">​<span class="italic">Booleans and nil</span>​</a>
</blockquote></td></tr><tr valign="top" class="calibre55"><td valign="top" class="calibre57">   <blockquote class="calibre52">Character  </blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">   <span class="calibre8"><span class="calibre39">\a</span></span>
</blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">   <a href="#filepos177378">​<span class="italic">Strings and Characters</span>​</a>
</blockquote></td></tr><tr valign="top" class="calibre55"><td valign="top" class="calibre57">   <blockquote class="calibre52">Keyword  </blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">   <span class="calibre8"><span class="calibre39">:tag</span></span>, <span class="calibre8"><span class="calibre39">:doc</span></span>
</blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">   <a href="#filepos195649">​<span class="italic">Maps, Keywords, and Records</span>​</a>
</blockquote></td></tr><tr valign="top" class="calibre55"><td valign="top" class="calibre57">   <blockquote class="calibre52">List  </blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">   <span class="calibre8"><span class="calibre39">(1 2 3)</span></span>, <span class="calibre8"><span class="calibre39">(println "foo")</span></span>
</blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">Chapter 3,   <a href="#filepos350588">​<span class="italic">Unifying Data with Sequences</span>​</a>
</blockquote></td></tr><tr valign="top" class="calibre55"><td valign="top" class="calibre57">   <blockquote class="calibre52">Map  </blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">   <span class="calibre8"><span class="calibre39">{:name "Bill", :age 42}</span></span>
</blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">   <a href="#filepos195649">​<span class="italic">Maps, Keywords, and Records</span>​</a>
</blockquote></td></tr><tr valign="top" class="calibre55"><td valign="top" class="calibre57">   <blockquote class="calibre52">Nil  </blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">   <span class="calibre8"><span class="calibre39">nil</span></span>
</blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">   <a href="#filepos188344">​<span class="italic">Booleans and nil</span>​</a>
</blockquote></td></tr><tr valign="top" class="calibre55"><td valign="top" class="calibre57">   <blockquote class="calibre52">Number  </blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">   <span class="calibre8"><span class="calibre39">1</span></span>, <span class="calibre8"><span class="calibre39">4.2</span></span>
</blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">   <a href="#filepos163118">​<span class="italic">Using Numeric Types </span>​</a>
</blockquote></td></tr><tr valign="top" class="calibre55"><td valign="top" class="calibre57">   <blockquote class="calibre52">Set  </blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">   <span class="calibre8"><span class="calibre39">#{:snap :crackle :pop}</span></span>
</blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">Chapter 3,   <a href="#filepos350588">​<span class="italic">Unifying Data with Sequences</span>​</a>
</blockquote></td></tr><tr valign="top" class="calibre55"><td valign="top" class="calibre57">   <blockquote class="calibre52">String  </blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">   <span class="calibre8"><span class="calibre39">"hello"</span></span>
</blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">   <a href="#filepos177378">​<span class="italic">Strings and Characters</span>​</a>
</blockquote></td></tr><tr valign="top" class="calibre55"><td valign="top" class="calibre57">   <blockquote class="calibre52">Symbol  </blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">   <span class="calibre8"><span class="calibre39">user/foo</span></span>, <span class="calibre8"><span class="calibre39">java.lang.String</span></span>
</blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">   <a href="#filepos174518">​<span class="italic">Symbols</span>​</a>
</blockquote></td></tr><tr valign="top" class="calibre55"><td valign="top" class="calibre57">   <blockquote class="calibre52">Vector  </blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">   <span class="calibre8"><span class="calibre39">[1 2 3]</span></span>
</blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">Chapter 3,   <a href="#filepos350588">​<span class="italic">Unifying Data with Sequences</span>​</a>
</blockquote></td></tr></table><hr class="calibre58"/><blockquote class="calibre1"><span class="bold">Figure 1. Clojure forms</span></blockquote><p id="filepos163118" class="calibre27"><span class="calibre4"><span class="bold"><span class="calibre28">Using Numeric Types </span></span></span></p><p class="calibre44"> Numeric literals are forms. Numbers simply evaluate to themselves. If you enter a number, the REPL will give it back to you: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​42​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 42​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> A vector of numbers is another kind of form. Create a vector of the numbers 1, 2, and 3: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​[1 2 3]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; [1 2 3]​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> A list is also a kind of form. A list is “just data,” but it is also used to call functions. Create a list whose first item names a Clojure function, like the symbol <span class="calibre8"><span class="calibre39">+</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(+ 1 2)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 3​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> As you can see, Clojure evaluates the list as a function call. The style of placing the function first is called <span class="italic">prefix notation</span>,<a id="filepos164991"></a><a href="#filepos346940">[18]</a> as opposed to the more familiar <span class="italic">infix notation</span> <span class="calibre8"><span class="calibre39">1 + 2 = 3</span></span>. Of course, prefix notation is perfectly familiar for functions whose names are words. For example, most programmers would correctly expect <span class="calibre8"><span class="calibre39">concat</span></span> to come first in this expression: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(concat [1 2] [3 4])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (1 2 3 4)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Clojure is simply being consistent in treating mathematical operators like all other functions and placing them first. </p><p class="calibre12"> A practical advantage of prefix notation is that you can easily extend it for arbitrary numbers of arguments: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(+ 1 2 3)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 6​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Even the degenerate case of no arguments works as you would expect, returning zero. This helps to eliminate fragile, special-case logic for boundary conditions: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(+)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 0​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Many mathematical and comparison operators have the names and semantics that you would expect from other programming languages. Addition, subtraction, multiplication, comparison, and equality all work as you would expect: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(- 10 5)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 5​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(* 3 10 10)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 300​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(&gt; 5 2)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(&gt;= 5 5)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(&lt; 5 2)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; false​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(= 5 2)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; false​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Division may surprise you:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(/ 22 7)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 22/7​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> As you can see, Clojure has a built-in <span class="calibre8"><span class="calibre39">Ratio</span></span> type:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(class (/ 22 7))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; clojure.lang.Ratio​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If what you actually want is decimal division, use a floating-point literal for the dividend: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(/ 22.0 7)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 3.142857142857143​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If you want to stick to integers, you can get the integer quotient and remainder with <span class="calibre8"><span class="calibre39">quot</span></span> and <span class="calibre8"><span class="calibre39">rem</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(quot 22 7)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 3​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(rem 22 7)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 1​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If you need to do arbitrary-precision floating-point math, append <span class="calibre8"><span class="calibre39">M</span></span> to a number to create a <span class="calibre8"><span class="calibre39">BigDecimal</span></span> literal: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(+ 1 (/ 0.00001 1000000000000000000))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 1.0​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(+ 1 (/ 0.00001M 1000000000000000000))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 1.00000000000000000000001M​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> For arbitrary precision integers, you can append <span class="calibre8"><span class="calibre39">N</span></span> to create a <span class="calibre8"><span class="calibre39">BigInt</span></span> literal: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(* 1000N 1000 1000 1000 1000 1000 1000)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 1000000000000000000000N​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Notice that only one <span class="calibre8"><span class="calibre39">BigInt</span></span> literal is needed and is contagious to the entire calculation. </p><p id="filepos174518" class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Symbols</span></span></span></p><p class="calibre44"> Forms such as <span class="calibre8"><span class="calibre39">+</span></span>, <span class="calibre8"><span class="calibre39">concat</span></span>, and <span class="calibre8"><span class="calibre39">java.lang.String</span></span> are called <span class="italic">symbols</span> and are used to name things. For example, <span class="calibre8"><span class="calibre39">+</span></span> names the function that adds things together. Symbols name all sorts of things in Clojure: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Functions like <span class="calibre8"><span class="calibre39">str</span></span> and <span class="calibre8"><span class="calibre39">concat</span></span>
</p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> “Operators” like <span class="calibre8"><span class="calibre39">+</span></span> and <span class="calibre8"><span class="calibre39">-</span></span>, which are, after all, just functions </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> Java classes like <span class="calibre8"><span class="calibre39">java.lang.String</span></span> and <span class="calibre8"><span class="calibre39">java.util.Random</span></span>
</p></li><a></a><li value="4" class="calibre30"><p class="calibre29"> Namespaces like <span class="calibre8"><span class="calibre39">clojure.core</span></span> and Java packages like <span class="calibre8"><span class="calibre39">java.lang</span></span>
</p></li><a></a><li value="5" class="calibre30"><p class="calibre29">Data structures and references</p></li><a></a></ul><p class="calibre12"> Symbols cannot start with a number but can consist of alphanumeric characters, plus <span class="calibre8"><span class="calibre39">+</span></span>, <span class="calibre8"><span class="calibre39">-</span></span>, <span class="calibre8"><span class="calibre39">*</span></span>, <span class="calibre8"><span class="calibre39">/</span></span>, <span class="calibre8"><span class="calibre39">!</span></span>, <span class="calibre8"><span class="calibre39">?</span></span>, <span class="calibre8"><span class="calibre39">.</span></span>, and <span class="calibre8"><span class="calibre39">_</span></span>. The list of legal symbol characters is a minimum set that Clojure promises to support. You should stick to these characters in your own code, but do not assume the list is exhaustive. Clojure can use other, undocumented characters in symbols that it employs internally and may add more legal symbol characters in the future. See Clojure’s online documentation<a id="filepos177023"></a><a href="#filepos347231">[19]</a> for updates to the list of legal symbol characters. </p><p class="calibre12"> Clojure treats <span class="calibre8"><span class="calibre39">/</span></span> and <span class="calibre8"><span class="calibre39">.</span></span> specially in order to support namespaces; see <a href="#filepos266617">​<span class="italic">Namespaces</span>​</a> for details. </p><p id="filepos177378" class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Strings and Characters</span></span></span></p><p class="calibre44"> Strings are another kind of reader form. Clojure strings are Java strings. They are delimited by double quotes, and they can span multiple lines: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​"This is a\nmultiline string"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "This is a\nmultiline string"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​"This is also​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​a multiline string"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "This is also\na multiline string"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> As you can see, the REPL always shows string literals with escaped newlines. If you actually print a multiline string, it will print on multiple lines: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(println "another\nmultiline\nstring")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| another​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| multiline​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| string​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Clojure does not wrap most of Java’s string functions. Instead, you can call them directly using Clojure’s Java interop forms: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(.toUpperCase "hello")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "HELLO"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The dot before <span class="calibre8"><span class="calibre39">toUpperCase</span></span> tells Clojure to treat it as the name of a Java method instead of a Clojure function. </p><p class="calibre12"> One string function that Clojure <span class="italic">does</span> wrap is <span class="calibre8"><span class="calibre39">toString</span></span>. You do not need to call <span class="calibre8"><span class="calibre39">toString</span></span> directly. Instead of calling <span class="calibre8"><span class="calibre39">toString</span></span>, use Clojure’s <span class="calibre8"><span class="calibre39">str</span></span> function: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">str</span></span></span><span class="calibre8"> &amp; args)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">str</span></span> differs from <span class="calibre8"><span class="calibre39">toString</span></span> in two ways. It smashes together multiple arguments, and it skips <span class="calibre8"><span class="calibre39">nil</span></span> without error: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(str 1 2 nil 3)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "123"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Clojure characters are Java characters. Their literal syntax is <span class="calibre8"><span class="calibre39">\{letter}</span></span>, where <span class="calibre8"><span class="calibre39">letter</span></span> can be a letter or the name of a character: <span class="calibre8"><span class="calibre39">backspace</span></span>, <span class="calibre8"><span class="calibre39">formfeed</span></span>, <span class="calibre8"><span class="calibre39">newline</span></span>, <span class="calibre8"><span class="calibre39">return</span></span>, <span class="calibre8"><span class="calibre39">space</span></span>, or <span class="calibre8"><span class="calibre39">tab</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(str \h \e \y \space \y \o \u)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "hey you"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> As is the case with strings, Clojure does not wrap Java’s character functions. Instead, you can use a Java interop form such as <span class="calibre8"><span class="calibre39">Character/toUpperCase</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(Character/toUpperCase \s)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; \S​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The Java interop forms are covered in Section 2.5, <a href="#filepos281250">​<span class="italic">Calling Java</span>​</a>. For more on Java’s <span class="calibre8"><span class="calibre39">Character</span></span> class, see the API documentation at <a href="http://tinyurl.com/java-character">http://tinyurl.com/java-character</a>. </p><p class="calibre12"> Strings are sequences of characters. When you call Clojure sequence functions on a string, you get a sequence of characters back. Imagine that you wanted to conceal a secret message by interleaving it with a second, innocuous message. You could use <span class="calibre8"><span class="calibre39">interleave</span></span> to combine the two messages: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(interleave "Attack at midnight" "The purple elephant chortled")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (\A \T \t \h \t \e \a \space \c \p \k \u \space \r​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​\a \p \t \l \space \e \m \space \i \e \d \l \n \e​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​\i \p \g \h \h \a \t \n)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> That works, but you probably want the resulting sequence as a string for transmission. It is tempting to use <span class="calibre8"><span class="calibre39">str</span></span> to pack the characters back into a string, but that doesn’t quite work: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(str (interleave "Attack at midnight" "The purple elephant chortled"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "clojure.lang.LazySeq@d4ea9f36"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The problem is that <span class="calibre8"><span class="calibre39">str</span></span> works with a variable number of arguments, and you are passing it a <span class="italic">single</span> argument that contains the argument list. The solution is <span class="calibre8"><span class="calibre39">apply</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">apply</span></span></span><span class="calibre8"> f args* argseq)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">apply</span></span> takes a function <span class="calibre8"><span class="calibre39">f</span></span>, some optional <span class="calibre8"><span class="calibre39">args</span></span>, and a sequence of args called <span class="calibre8"><span class="calibre39">argseq</span></span>. It then calls <span class="calibre8"><span class="calibre39">f</span></span>, unrolling <span class="calibre8"><span class="calibre39">args</span></span> and <span class="calibre8"><span class="calibre39">argseq</span></span> into an argument list. Use <span class="calibre8"><span class="calibre39">(apply str ...)</span></span> to build a string from a sequence of characters: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(apply str (interleave "Attack at midnight" "The purple elephant chortled"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "ATthtea cpku raptl em iedlneipghhatn"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">You can use <span class="calibre8"><span class="calibre39">(apply str ...)</span></span> again to reveal the message:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(apply str (take-nth 2 "ATthtea cpku raptl em iedlneipghhatn"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Attack at midnight"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The call to <span class="calibre8"><span class="calibre39">(take-nth 2 ...)</span></span> takes every second element of the sequence, extracting the obfuscated message. </p><p id="filepos188344" class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Booleans and nil</span></span></span></p><p class="calibre44"> Clojure’s rules for booleans are easy to understand: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"><span class="calibre8"><span class="calibre39">true</span></span> is <span class="calibre8"><span class="calibre39">true</span></span>, and <span class="calibre8"><span class="calibre39">false</span></span> is <span class="calibre8"><span class="calibre39">false</span></span>. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> In addition to <span class="calibre8"><span class="calibre39">false</span></span>, <span class="calibre8"><span class="calibre39">nil</span></span> also evaluates to <span class="calibre8"><span class="calibre39">false</span></span> when used in a boolean context. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> Other than <span class="calibre8"><span class="calibre39">false</span></span> and <span class="calibre8"><span class="calibre39">nil</span></span>, <span class="italic">everything else</span> evaluates to <span class="calibre8"><span class="calibre39">true</span></span> in a boolean context. </p></li><a></a></ul><p class="calibre12"> Lisp programmers be warned: the empty list is not false in Clojure:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​;            (if part)               (else part)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(if () "We are in Clojure!" "We are in Common Lisp!")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "We are in Clojure!"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> C programmers be warned: zero is not false in Clojure, either:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​;        (if part)     (else part)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(if 0 "Zero is true" "Zero is false")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Zero is true"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> A <span class="italic">predicate</span> is a function that returns either <span class="calibre8"><span class="calibre39">true</span></span> or <span class="calibre8"><span class="calibre39">false</span></span>. In Clojure, it is idiomatic to name predicates with a trailing question mark, for example <span class="calibre8"><span class="calibre39">true?</span></span>, <span class="calibre8"><span class="calibre39">false?</span></span>, <span class="calibre8"><span class="calibre39">nil?</span></span>, and <span class="calibre8"><span class="calibre39">zero?</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">true?</span></span></span><span class="calibre8"> expr)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">false?</span></span></span><span class="calibre8"> expr)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">nil?</span></span></span><span class="calibre8"> expr)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">zero?</span></span></span><span class="calibre8"> expr)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">true?</span></span> tests whether a value is actually <span class="calibre8"><span class="calibre39">true</span></span>, <span class="italic">not</span> whether the value evaluates to <span class="calibre8"><span class="calibre39">true</span></span> in a boolean context. The only thing that is <span class="calibre8"><span class="calibre39">true?</span></span> is <span class="calibre8"><span class="calibre39">true</span></span> itself: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(true? true)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(true? "foo")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; false​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">nil?</span></span> and <span class="calibre8"><span class="calibre39">false?</span></span> work the same way. Only <span class="calibre8"><span class="calibre39">nil</span></span> is <span class="calibre8"><span class="calibre39">nil?</span></span>, and only <span class="calibre8"><span class="calibre39">false</span></span> is <span class="calibre8"><span class="calibre39">false?</span></span>. </p><p class="calibre12"><span class="calibre8"><span class="calibre39">zero?</span></span> works with any numeric type, returning true if it is zero:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(zero? 0.0)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(zero? (/ 22 7))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; false​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> There are many more predicates in Clojure. To review them, enter <span class="calibre8"><span class="calibre39">(find-doc #"\?$")</span></span> at the REPL. </p><p id="filepos195649" class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Maps, Keywords, and Records</span></span></span></p><p class="calibre44"> A Clojure <span class="italic">map</span> is a collection of key/value pairs. Maps have a literal form surrounded by curly braces. You can use a map literal to create a lookup table for the inventors of programming languages: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def inventors {"Lisp" "McCarthy" "Clojure" "Hickey"})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/inventors​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The value <span class="calibre8"><span class="calibre39">"McCarthy"</span></span> is associated with the key <span class="calibre8"><span class="calibre39">"Lisp"</span></span>, and the value <span class="calibre8"><span class="calibre39">"Hickey"</span></span> is associated with the key <span class="calibre8"><span class="calibre39">"Clojure"</span></span>. </p><p class="calibre12"> If you find it easier to read, then you can use commas to delimit each key/value pair. Clojure doesn’t care. It treats commas as whitespace: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def inventors {"Lisp" "McCarthy", "Clojure" "Hickey"})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/inventors​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Maps are functions. If you pass a key to a map, it will return that key’s value, or it will return <span class="calibre8"><span class="calibre39">nil</span></span> if the key is not found: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(inventors "Lisp")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "McCarthy"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(inventors "Foo")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> You can also use the more verbose <span class="calibre8"><span class="calibre39">get</span></span> function:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">get</span></span></span><span class="calibre8"> the-map </span><span class="calibre8"><span class="bold"><span class="calibre36">key</span></span></span><span class="calibre8"> not-found-val?)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">get</span></span> allows you to specify a different return value for missing keys: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(get inventors "Lisp" "I dunno!")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "McCarthy"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(get inventors "Foo"  "I dunno!")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "I dunno!"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Because Clojure data structures are immutable and implement <span class="calibre8"><span class="calibre39">hashCode</span></span> correctly, <span class="italic">any Clojure data structure can be a key in a map</span>. That said, a very common key type is the Clojure keyword. </p><p class="calibre12"> A <span class="italic">keyword</span> is like a symbol, except that keywords begin with a colon (<span class="calibre8"><span class="calibre39">:</span></span>). Keywords resolve to themselves: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​:foo​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; :foo​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">This is different from symbols, which want to refer <span class="italic">to</span> something:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​foo​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; CompilerException java.lang.RuntimeException:​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   Unable to resolve symbol: foo in this context​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The fact that keywords resolve to themselves makes keywords useful as keys. You could redefine the <span class="calibre8"><span class="calibre39">inventors</span></span> map using keywords as keys: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def inventors {:Lisp "McCarthy" :Clojure "Hickey"})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/inventors​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Keywords are also functions. They take a map argument and look themselves up in the map. Having switched to keyword keys for the <span class="calibre8"><span class="calibre39">inventors</span></span>, you can look up an inventor by calling the map or by calling a key: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(inventors :Clojure)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Hickey"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(:Clojure inventors)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Hickey"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> This flexibility in ordering comes in handy when calling higher-order functions, such as the reference and agent APIs in Chapter 5, <a href="#filepos699699">​<span class="italic">State</span>​</a>. </p><p class="calibre12"> If several maps have keys in common, you can document (and enforce) this fact by creating a record with <span class="calibre8"><span class="calibre39">defrecord</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defrecord</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">name</span></span></span><span class="calibre8"> [arguments])​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> The argument names are converted to <span class="calibre8"><span class="calibre39">keys</span></span> that have the values passed in when creating the record. Use <span class="calibre8"><span class="calibre39">defrecord</span></span> to create a <span class="calibre8"><span class="calibre39">Book</span></span> record: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defrecord Book [title author])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; user.Book​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Then, you can instantiate a record with <span class="calibre8"><span class="calibre39">user.Book.</span></span>:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(-&gt;Book </span><span class="calibre8"><span class="italic"><span class="calibre42">"title"</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"author"</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Once you instantiate a <span class="calibre8"><span class="calibre39">Book</span></span>, it behaves almost like any other map:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def b (-&gt;Book "Anathem" "Neal Stephenson"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/b​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​b​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #:user.Book{:title "Anathem", :author "Neal Stephenson"}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(:title b)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Anathem"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Records also have alternative invocations. There is the original syntax that you may have already seen: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(Book. "Anathem" "Neal Stephenson")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #user.Book{:title "Anathem", :author "Neal Stephenson"}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> You can also instantiate a record using the literal syntax. This is done by typing in exactly what you have seen returned to you at the REPL. The only difference you will notice is that record literals have to be fully qualified: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​#user.Book{:title "Infinite Jest", :author "David Foster Wallace"}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #user.Book{:title "Infinite Jest", :author "David Foster Wallace"}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> So far, you have seen numeric literals, lists, vectors, symbols, strings, characters, booleans, records, and <span class="calibre8"><span class="calibre39">nil</span></span>. The remaining forms are covered later in the book, as they are needed. For your reference, see Figure 1, <a href="#filepos156806">​<span class="italic">Clojure forms</span>​</a>, which lists all the forms used in the book, a brief example of each, and a pointer to more complete coverage. </p><div class="mbppagebreak"></div><p id="filepos208768" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">2.2 Reader Macros</span></span></span></p><p class="calibre34"> Clojure forms are read by the <span class="italic">reader</span>, which converts text into Clojure data structures. In addition to the basic forms, the Clojure reader also recognizes a set of <span class="italic">reader macros</span>.<a id="filepos209107"></a><a href="#filepos347651">[20]</a> Reader macros are special reader behaviors triggered by prefix <span class="italic">macro characters</span>. </p><p class="calibre12"> The most familiar reader macro is the comment. The macro character that triggers a comment is the semicolon (<span class="calibre8"><span class="calibre39">;</span></span>), and the special reader behavior is “ignore everything else up to the end of this line.” </p><p class="calibre12"> Reader macros are abbreviations of longer list forms and are used to reduce clutter. You have already seen one of these. The quote character (<span class="calibre8"><span class="calibre39">’</span></span>) prevents evaluation: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​'(1 2)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (1 2)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">’(1 2)</span></span> is equivalent to the longer <span class="calibre8"><span class="calibre39">(quote (1 2))</span></span>:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(quote (1 2))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (1 2)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The other reader macros are covered later in the book. In the following table, you’ll find a quick syntax overview and references to where each reader macro is covered. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><th valign="top" class="calibre51"><span class="bold">   </span><p class="calibre59"><span class="bold">Reader Macro  </span></p></th><th valign="top" class="calibre51"><span class="bold">   </span><p class="calibre59"><span class="bold">Example(s)  </span></p></th><th valign="top" class="calibre51"><span class="bold">   </span><p class="calibre59"><span class="bold">Primary Coverage  </span></p></th></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">Anonymous function  </p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">#(.toUpperCase %)</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">Section 2.3,   <a href="#filepos215638">​<span class="italic">Functions</span>​</a>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">Comment  </p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">; single-line comment</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">Section 2.2,   <a href="#filepos208768">​<span class="italic">Reader Macros</span>​</a>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">Deref  </p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">@form =&gt; (deref form)</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">Chapter 5,   <a href="#filepos699699">​<span class="italic">State</span>​</a>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">Metadata  </p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">^metadata form</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">Section 2.8,   <a href="#filepos334070">​<span class="italic">Metadata</span>​</a>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">Quote  </p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">’form =&gt; (quote form)</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">Section 2.1,   <a href="#filepos156033">​<span class="italic">Forms</span>​</a>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">Regex pattern  </p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">#"foo" =&gt; a java.util.regex.Pattern</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">   <a href="#filepos451526">​<span class="italic">Seq-ing Regular Expressions</span>​</a>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">Syntax-quote  </p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">‘x</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">Section 7.3,   <a href="#filepos1065738">​<span class="italic">Making Macros Simpler</span>​</a>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">Unquote  </p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">~</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">Section 7.3,   <a href="#filepos1065738">​<span class="italic">Making Macros Simpler</span>​</a>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">Unquote-splicing  </p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">~@</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">Section 7.3,   <a href="#filepos1065738">​<span class="italic">Making Macros Simpler</span>​</a>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">Var-quote  </p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">#’x =&gt; (var x)</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">Chapter 5,   <a href="#filepos699699">​<span class="italic">State</span>​</a>
</p></td></tr></table><p class="calibre27"> Clojure does not allow programs to define new reader macros. The rationale for this has been explained (and debated) on the Clojure mailing list.<a id="filepos215335"></a><a href="#filepos347972">[21]</a> If you come from a Lisp background, this may be frustrating. We feel your pain. But this compromise in flexibility gives Clojure a more stable core. Custom reader macros could make Clojure programs less interoperable and more difficult to read. </p><div class="mbppagebreak"></div><p id="filepos215638" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">2.3 Functions</span></span></span></p><p class="calibre34"> In Clojure, a function call is simply a list whose first element resolves to a function. For example, this call to <span class="calibre8"><span class="calibre39">str</span></span> concatenates its arguments to create a string: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(str "hello" " " "world")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "hello world"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Function names are typically hyphenated, as in <span class="calibre8"><span class="calibre39">clear-agent-errors</span></span>. If a function is a predicate, then by convention its name should end with a question mark. As an example, the following predicates test the type of their argument, and all end with a question mark: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(string? "hello")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(keyword? :hello)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(symbol? 'hello)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> To define your own functions, use <span class="calibre8"><span class="calibre39">defn</span></span>:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">name</span></span></span><span class="calibre8"> doc-string? attr-map? [params*] body)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">attr-map</span></span> associates metadata with the function’s var. It’s covered separately in Section 2.8, <a href="#filepos334070">​<span class="italic">Metadata</span>​</a>. To demonstrate the other components of a function definition, create a <span class="calibre8"><span class="calibre39">greeting</span></span> function that takes a name and returns a greeting preceded by “Hello”: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/exploring.clj"><span class="calibre41"><span class="underline">src/examples/exploring.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> greeting​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="italic"><span class="calibre42">"Returns a greeting of the form 'Hello, username.'"</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  [username]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">str</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"Hello, "</span></span></span><span class="calibre8"> username))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">You can call <span class="calibre8"><span class="calibre39">greeting</span></span>:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(greeting "world")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Hello, world"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">You can also consult the documentation for <span class="calibre8"><span class="calibre39">greeting:</span></span>
</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;</span><span class="calibre8"><span class="bold"><span class="calibre36"> (doc greeting)</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-------------------------​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​exploring/greeting​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​([username])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  Returns a greeting of the form 'Hello, username.'​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> What does <span class="calibre8"><span class="calibre39">greeting</span></span> do if the caller omits <span class="calibre8"><span class="calibre39">username</span></span>? </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(greeting)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ArityException Wrong number of args (0) passed to: user$greeting​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   clojure.lang.AFn.throwArity (AFn.java:437)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Clojure functions enforce their <span class="italic">arity</span>, that is, their expected number of arguments. If you call a function with an incorrect number of arguments, Clojure will throw an <span class="calibre8"><span class="calibre39">ArityException</span></span>. If you want to make <span class="calibre8"><span class="calibre39">greeting</span></span> issue a generic greeting when the caller omits <span class="calibre8"><span class="calibre39">username</span></span>, you can use this alternate form of <span class="calibre8"><span class="calibre39">defn</span></span>, which takes multiple argument lists and method bodies: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">name</span></span></span><span class="calibre8"> doc-string? attr-map?​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​  ([params*] body)</span><span class="calibre8"><span class="bold"><span class="calibre36">+</span></span></span><span class="calibre8">)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Different arities of the same function can call one another, so you can easily create a zero-argument <span class="calibre8"><span class="calibre39">greeting</span></span> that delegates to the one-argument <span class="calibre8"><span class="calibre39">greeting</span></span>, passing in a default <span class="calibre8"><span class="calibre39">username</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/exploring.clj"><span class="calibre41"><span class="underline">src/examples/exploring.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> greeting​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="italic"><span class="calibre42">"Returns a greeting of the form 'Hello, username.'</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre42">   Default username is 'world'."</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  ([] (greeting </span><span class="calibre8"><span class="italic"><span class="calibre42">"world"</span></span></span><span class="calibre8">))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  ([username] (</span><span class="calibre8"><span class="bold"><span class="calibre36">str</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"Hello, "</span></span></span><span class="calibre8"> username)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">You can verify that the new greeting works as expected:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(greeting)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Hello, world"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> You can create a function with variable arity by including an ampersand in the parameter list. Clojure will bind the name after the ampersand to a sequence of all the remaining parameters. </p><p class="calibre12"> The following function allows two people to go on a date with a variable number of chaperones: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/exploring.clj"><span class="calibre41"><span class="underline">src/examples/exploring.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> date [person-1 person-2 &amp; chaperones]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">println</span></span></span><span class="calibre8"> person-1 </span><span class="calibre8"><span class="italic"><span class="calibre42">"and"</span></span></span><span class="calibre8"> person-2​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​           </span><span class="calibre8"><span class="italic"><span class="calibre42">"went out with"</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">count</span></span></span><span class="calibre8"> chaperones) </span><span class="calibre8"><span class="italic"><span class="calibre42">"chaperones."</span></span></span><span class="calibre8">))​</span><span class="calibre8">
</span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(date "Romeo" "Juliet" "Friar Lawrence" "Nurse")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| Romeo and Juliet went out with 2 chaperones.​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Variable arity is very useful in recursive definitions. See Chapter 4, <a href="#filepos539895">​<span class="italic">Functional Programming</span>​</a> for examples. </p><p class="calibre12"> Writing function implementations differing by arity is useful. But if you come from an object-oriented background, you’ll want <span class="italic">polymorphism</span>, that is, different implementations that are selected by <span class="italic">type</span>. Clojure can do this and a whole lot more. See Chapter 8, <a href="#filepos1149215">​<span class="italic">Multimethods</span>​</a> and Chapter 6, <a href="#filepos867195">​<span class="italic">Protocols and Datatypes</span>​</a> for details. </p><p class="calibre12"><span class="calibre8"><span class="calibre39">defn</span></span> is intended for defining functions at the top level. If you want to create a function from within another function, you should use an anonymous function form instead. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Anonymous Functions</span></span></span></p><p class="calibre44"> In addition to named functions with <span class="calibre8"><span class="calibre39">defn</span></span>, you can also create anonymous functions with <span class="calibre8"><span class="calibre39">fn</span></span>. There are at least three reasons to create an anonymous function: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> The function is so brief and self-explanatory that giving it a name makes the code harder to read, not easier. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> The function is being used only from inside another function and needs a local name, not a top-level binding. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> The function is created inside another function for the purpose of closing over some data. </p></li><a></a></ul><p class="calibre12"> Filter functions are often brief and self-explanatory. For example, imagine that you want to create an index for a sequence of words, and you do not care about words shorter than three characters. You can write an <span class="calibre8"><span class="calibre39">indexable-word?</span></span> function like this: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/exploring.clj"><span class="calibre41"><span class="underline">src/examples/exploring.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> indexable-word? [word]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">&gt;</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">count</span></span></span><span class="calibre8"> word) 2))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Then, you can use <span class="calibre8"><span class="calibre39">indexable-word?</span></span> to extract indexable words from a sentence: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">require</span></span></span><span class="calibre8"> '[clojure.string :as </span><span class="calibre8"><span class="bold"><span class="calibre36">str</span></span></span><span class="calibre8">])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">filter</span></span></span><span class="calibre8"> indexable-word? (str/split </span><span class="calibre8"><span class="italic"><span class="calibre42">"A fine day it is"</span></span></span><span class="calibre8"> #"\W+"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="bold"><span class="calibre36">-&gt;</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="italic"><span class="calibre42">"fine"</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"day"</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The call to <span class="calibre8"><span class="calibre39">split</span></span> breaks the sentence into words, and then <span class="calibre8"><span class="calibre39">filter</span></span> calls <span class="calibre8"><span class="calibre39">indexable-word?</span></span> once for each word, returning those for which <span class="calibre8"><span class="calibre39">indexable-word?</span></span> returns true. </p><p class="calibre12"> Anonymous functions let you do the same thing in a single line. The simplest anonymous <span class="calibre8"><span class="calibre39">fn</span></span> form is the following: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">fn</span></span></span><span class="calibre8"> [params*] body)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> With this form, you can plug the implementation of <span class="calibre8"><span class="calibre39">indexable-word?</span></span> directly into the call to <span class="calibre8"><span class="calibre39">filter</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(filter (fn [w] (&gt; (count w) 2)) (str/split "A fine day" #"\W+"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ("fine" "day")​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> There is an even shorter syntax for anonymous functions, using implicit parameter names. The parameters are named <span class="calibre8"><span class="calibre39">%1</span></span>, <span class="calibre8"><span class="calibre39">%2</span></span>, and so on. You can also use <span class="calibre8"><span class="calibre39">%</span></span> for the first parameter. This syntax looks like this: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​#(body)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> You can rewrite the call to <span class="calibre8"><span class="calibre39">filter</span></span> with the shorter anonymous form: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(filter #(&gt; (count %) 2) (str/split "A fine day it is" #"\W+"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ("fine" "day")​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> A second motivation for anonymous functions is wanting a named function but only inside the scope of another function. Continuing with the <span class="calibre8"><span class="calibre39">indexable-word?</span></span> example, you could write this: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/exploring.clj"><span class="calibre41"><span class="underline">src/examples/exploring.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> indexable-words [text]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [indexable-word? (</span><span class="calibre8"><span class="bold"><span class="calibre36">fn</span></span></span><span class="calibre8"> [w] (</span><span class="calibre8"><span class="bold"><span class="calibre36">&gt;</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">count</span></span></span><span class="calibre8"> w) 2))]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">filter</span></span></span><span class="calibre8"> indexable-word? (str/split text #"\W+"))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">let</span></span> binds the name <span class="calibre8"><span class="calibre39">indexable-word?</span></span> to the same anonymous function you wrote earlier, this time inside the lexical scope of <span class="calibre8"><span class="calibre39">indexable-words</span></span>. (<span class="calibre8"><span class="calibre39">let</span></span> is covered in more detail under Section 2.4, <a href="#filepos245180">​<span class="italic">Vars, Bindings, and Namespaces</span>​</a>.) You can verify that <span class="calibre8"><span class="calibre39">indexable-words</span></span> works as expected:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(indexable-words "a fine day it is")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ("fine" "day")​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The combination of <span class="calibre8"><span class="calibre39">let</span></span> and an anonymous function says the following to readers of your code: “The function <span class="calibre8"><span class="calibre39">indexable-word?</span></span> is interesting enough to have a name but is relevant only inside <span class="calibre8"><span class="calibre39">indexable-words</span></span>.” </p><p class="calibre12"> A third reason to use anonymous functions is when you create a function dynamically at runtime. Earlier, you implemented a simple greeting function. Extending this idea, you can create a <span class="calibre8"><span class="calibre39">make-greeter</span></span> function that creates greeting functions. <span class="calibre8"><span class="calibre39">make-greeter</span></span> will take a <span class="calibre8"><span class="calibre39">greeting-prefix</span></span> and return a new function that composes greetings from the <span class="calibre8"><span class="calibre39">greeting-prefix</span></span> and a name. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/exploring.clj"><span class="calibre41"><span class="underline">src/examples/exploring.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> make-greeter [greeting-prefix]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">fn</span></span></span><span class="calibre8"> [username] (</span><span class="calibre8"><span class="bold"><span class="calibre36">str</span></span></span><span class="calibre8"> greeting-prefix </span><span class="calibre8"><span class="italic"><span class="calibre42">", "</span></span></span><span class="calibre8"> username)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> It makes no sense to name the <span class="calibre8"><span class="calibre39">fn</span></span>, because it is creating a <span class="italic">different</span> function each time <span class="calibre8"><span class="calibre39">make-greeter</span></span> is called. However, you may want to name the results of specific calls to <span class="calibre8"><span class="calibre39">make-greeter</span></span>. You can use <span class="calibre8"><span class="calibre39">def</span></span> to name functions created by <span class="calibre8"><span class="calibre39">make-greeter</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def hello-greeting (make-greeter "Hello"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/hello-greeting​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def aloha-greeting (make-greeter "Aloha"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/aloha-greeting​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Now, you can call these functions, just like any other functions:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(hello-greeting "world")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Hello, world"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(aloha-greeting "world")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Aloha, world"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Moreover, there is no need to give each greeter a name. You can simply create a greeter and place it in the first (function) slot of a form: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​((make-greeter "Howdy") "pardner")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Howdy, pardner"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> As you can see, the different greeter functions remember the value of <span class="calibre8"><span class="calibre39">greeting-prefix</span></span> at the time they were created. More formally, the greeter functions are <span class="italic">closures</span> over the value of <span class="calibre8"><span class="calibre39">greeting-prefix</span></span>. </p><p class="calibre12"><span class="bold"><span class="calibre28">When to Use Anonymous Functions</span></span></p><p class="calibre45"> Anonymous functions have a terse syntax that is not always appropriate. You may actually prefer to be explicit and create named functions such as <span class="calibre8"><span class="calibre39">indexable-word?</span></span>. That’s perfectly fine and will certainly be the right choice if <span class="calibre8"><span class="calibre39">indexable-word?</span></span> needs to be called from more than one place. </p><p class="calibre12"> Anonymous functions are an option, not a requirement. Use the anonymous forms only when you find that they make your code more readable. They take a little getting used to, so don’t be surprised if you gradually use them more and more. </p><div class="mbppagebreak"></div><p id="filepos245180" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">2.4 Vars, Bindings, and Namespaces</span></span></span></p><p class="calibre34"> When you define an object with <span class="calibre8"><span class="calibre39">def</span></span> or <span class="calibre8"><span class="calibre39">defn</span></span>, that object is stored in a Clojure <span class="italic">var</span>. For example, the following <span class="calibre8"><span class="calibre39">def</span></span> creates a var named <span class="calibre8"><span class="calibre39">user/foo</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def foo 10)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/foo​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The symbol <span class="calibre8"><span class="calibre39">user/foo</span></span> refers to a var that is <span class="italic">bound</span> to the value <span class="calibre8"><span class="calibre39">10</span></span>. If you ask Clojure to evaluate the symbol <span class="calibre8"><span class="calibre39">foo</span></span>, it will return the value of the associated var: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​foo​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 10​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The initial value of a var is called its <span class="italic">root binding</span>. Sometimes it is useful to have thread-local bindings for a var; this is covered in Section 5.5, <a href="#filepos773305">​<span class="italic">Managing Per-Thread State with Vars</span>​</a>. </p><p class="calibre12"> You can refer to a var directly. The <span class="calibre8"><span class="calibre39">var</span></span> special form returns a var itself, not the var’s value: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">var</span></span></span><span class="calibre8"> a-symbol)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38">You can use <span class="calibre8"><span class="calibre39">var</span></span> to return the var bound to <span class="calibre8"><span class="calibre39">user/foo</span></span>:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(var foo)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/foo​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> You will almost never see the <span class="calibre8"><span class="calibre39">var</span></span> form directly in Clojure code. Instead, you will see the equivalent reader macro <span class="calibre8"><span class="calibre39">#’</span></span>, which also returns the var for a symbol: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​#'foo​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/foo​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Why would you want to refer to a var directly? Most of the time, you won’t, and you can often simply ignore the distinction between symbols and vars. </p><p class="calibre12"> But keep in the back of your mind that vars have many abilities other than just storing a value:</p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> The same var can be aliased into more than one namespace (<a href="#filepos266617">​<span class="italic">Namespaces</span>​</a>). This allows you to use convenient short names. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Vars can have metadata (Section 2.8, <a href="#filepos334070">​<span class="italic">Metadata</span>​</a>). Var metadata includes documentation (<a href="#filepos131443">​<span class="italic">Finding Documentation</span>​</a>), type hints for optimization, and unit tests. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> Vars can be dynamically rebound on a per-thread basis (Section 5.5, <a href="#filepos773305">​<span class="italic">Managing Per-Thread State with Vars</span>​</a>). </p></li><a></a></ul><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Bindings</span></span></span></p><p class="calibre44"> Vars are bound to names, but there are other kinds of bindings as well. For example, in a function call, argument values bind to parameter names. In the following call, <span class="calibre8"><span class="calibre39">10</span></span> binds to the name <span class="calibre8"><span class="calibre39">number</span></span> inside the <span class="calibre8"><span class="calibre39">triple</span></span> function: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defn triple [number] (* 3 number))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/triple​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(triple 10)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 30​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> A function’s parameter bindings have a <span class="italic">lexical</span> scope: they are visible only inside the text of the function body. Functions are not the only way to create a lexical binding. The special form <span class="calibre8"><span class="calibre39">let</span></span> does nothing other than create a set of lexical bindings: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [bindings*] exprs*)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">bindings</span></span> are then in effect for <span class="calibre8"><span class="calibre39">exprs</span></span>, and the value of the <span class="calibre8"><span class="calibre39">let</span></span> is the value of the last expression in <span class="calibre8"><span class="calibre39">exprs</span></span>. </p><p class="calibre12"> Imagine that you want coordinates for the four corners of a square, given the <span class="calibre8"><span class="calibre39">bottom</span></span>, <span class="calibre8"><span class="calibre39">left</span></span>, and <span class="calibre8"><span class="calibre39">size</span></span>. You can <span class="calibre8"><span class="calibre39">let</span></span> the <span class="calibre8"><span class="calibre39">top</span></span> and <span class="calibre8"><span class="calibre39">right</span></span> coordinates, based on the values given: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/exploring.clj"><span class="calibre41"><span class="underline">src/examples/exploring.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> square-corners [bottom left size]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [top (</span><span class="calibre8"><span class="bold"><span class="calibre36">+</span></span></span><span class="calibre8"> bottom size)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        right (</span><span class="calibre8"><span class="bold"><span class="calibre36">+</span></span></span><span class="calibre8"> left size)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    [[bottom left] [top left] [top right] [bottom right]]))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">let</span></span> binds <span class="calibre8"><span class="calibre39">top</span></span> and <span class="calibre8"><span class="calibre39">right</span></span>. This saves you the trouble of calculating <span class="calibre8"><span class="calibre39">top</span></span> and <span class="calibre8"><span class="calibre39">right</span></span> more than once. (Both are needed twice to generate the return value.) The <span class="calibre8"><span class="calibre39">let</span></span> then returns its last form, which in this example becomes the return value of <span class="calibre8"><span class="calibre39">square-corners</span></span>. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Destructuring</span></span></span></p><p class="calibre44"> In many programming languages, you bind a variable to an <span class="italic">entire</span> collection when you need to access only <span class="italic">part</span> of the collection. </p><p class="calibre12"> Imagine that you are working with a database of book authors. You track both first and last names, but some functions need to use only the first name: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/exploring.clj"><span class="calibre41"><span class="underline">src/examples/exploring.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> greet-author-1 [author]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">println</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"Hello,"</span></span></span><span class="calibre8"> (:first-name author)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">The <span class="calibre8"><span class="calibre39">greet-author-1</span></span> function works fine:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(greet-author-1 {:last-name "Vinge" :first-name "Vernor"})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| Hello, Vernor​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Having to bind <span class="calibre8"><span class="calibre39">author</span></span> is unsatisfying. You don’t need the <span class="calibre8"><span class="calibre39">author</span></span>; all you need is the <span class="calibre8"><span class="calibre39">first-name</span></span>. Clojure solves this with <span class="italic">destructuring</span>. Any place that you bind names, you can nest a vector or a map in the binding to reach into a collection and bind only the part you want. Here is a variant of <span class="calibre8"><span class="calibre39">greet-author</span></span> that binds only the first name: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/exploring.clj"><span class="calibre41"><span class="underline">src/examples/exploring.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> greet-author-2 [{fname :first-name}]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">println</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"Hello,"</span></span></span><span class="calibre8"> fname))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The binding form <span class="calibre8"><span class="calibre39">{fname :first-name}</span></span> tells Clojure to bind <span class="calibre8"><span class="calibre39">fname</span></span> to the <span class="calibre8"><span class="calibre39">:first-name</span></span> of the function argument. <span class="calibre8"><span class="calibre39">greet-author-2</span></span> behaves just like <span class="calibre8"><span class="calibre39">greet-author-1</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(greet-author-2 {:last-name "Vinge" :first-name "Vernor"})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| Hello, Vernor​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Just as you can use a map to destructure any associative collection, you can use a vector to destructure any sequential collection. For example, you could bind only the first two coordinates in a three-dimensional coordinate space: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(let [[x y] [1 2 3]]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  [x y])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; [1 2]​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The expression <span class="calibre8"><span class="calibre39">[x y]</span></span> destructures the vector <span class="calibre8"><span class="calibre39">[1 2 3]</span></span>, binding <span class="calibre8"><span class="calibre39">x</span></span> to <span class="calibre8"><span class="calibre39">1</span></span> and <span class="calibre8"><span class="calibre39">y</span></span> to <span class="calibre8"><span class="calibre39">2</span></span>. Since no symbol lines up with the final element <span class="calibre8"><span class="calibre39">3</span></span>, it is not bound to anything. </p><p class="calibre12"> Sometimes you want to skip elements at the start of a collection. Here’s how you could bind only the <span class="calibre8"><span class="calibre39">z</span></span> coordinate: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(let [[_ _ z] [1 2 3]]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  z)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 3​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The underscore (<span class="calibre8"><span class="calibre39">_</span></span>) is a legal symbol and is used idiomatically to indicate “I don’t care about this binding.” Binding proceeds from left to right, so the <span class="calibre8"><span class="calibre39">_</span></span> is actually bound twice: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​; *not* idiomatic!​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(let [[_ _ z] [1 2 3]]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​_)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 2​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> It is also possible to simultaneously bind both a collection and elements within the collection. Inside a destructuring expression, an <span class="calibre8"><span class="calibre39">:as</span></span> clause gives you a binding for the entire enclosing structure. For example, you could capture the <span class="calibre8"><span class="calibre39">x</span></span> and <span class="calibre8"><span class="calibre39">y</span></span> coordinates individually, plus the entire collection as <span class="calibre8"><span class="calibre39">coords</span></span>, in order to report the total number of dimensions: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(let [[x y :as coords] [1 2 3 4 5 6]]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (str "x: " x ", y: " y ", total dimensions " (count coords)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "x: 1, y: 2, total dimensions 6"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Try using destructuring to create an <span class="calibre8"><span class="calibre39">ellipsize</span></span> function. <span class="calibre8"><span class="calibre39">ellipsize</span></span> should take a string and return the first three words followed by <span class="calibre8"><span class="calibre39">...</span></span>. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/exploring.clj"><span class="calibre41"><span class="underline">src/examples/exploring.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">require</span></span></span><span class="calibre8"> '[clojure.string :as </span><span class="calibre8"><span class="bold"><span class="calibre36">str</span></span></span><span class="calibre8">])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> ellipsize [words]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [[w1 w2 w3] (str/split words #"\s+")]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (str/join </span><span class="calibre8"><span class="italic"><span class="calibre42">" "</span></span></span><span class="calibre8"> [w1 w2 w3 </span><span class="calibre8"><span class="italic"><span class="calibre42">"..."</span></span></span><span class="calibre8">])))​</span><span class="calibre8">
</span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(ellipsize "The quick brown fox jumps over the lazy dog.")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "The quick brown ..."​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">split</span></span> splits the string around whitespace, and then the destructuring form <span class="calibre8"><span class="calibre39">[w1 w2 w3]</span></span> grabs the first three words. The destructuring ignores any extra items, which is exactly what we want. Finally, <span class="calibre8"><span class="calibre39">join</span></span> reassembles the three words, adding the ellipsis at the end. </p><p class="calibre12"> Destructuring has several other features not shown here and is a mini-language in itself. The Snake game in Section 5.6, <a href="#filepos798340">​<span class="italic">A Clojure Snake</span>​</a> makes heavy use of destructuring. For a complete list of destructuring options, see the online documentation for <span class="calibre8"><span class="calibre39">let</span></span>.<a id="filepos266575"></a><a href="#filepos348277">[22]</a>
</p><p id="filepos266617" class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Namespaces</span></span></span></p><p class="calibre44"> Root bindings live in a namespace. You can see evidence of this when you start the Clojure REPL and create a binding: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;</span><span class="calibre8"><span class="bold"><span class="calibre36"> (def foo 10)</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/foo​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">user=&gt;</span></span> prompt tells you that you are currently working in the <span class="calibre8"><span class="calibre39">user</span></span> namespace.<a id="filepos267544"></a><a href="#filepos348654">[23]</a> You should treat <span class="calibre8"><span class="calibre39">user</span></span> as a scratch namespace for exploratory development. </p><p class="calibre12"> When Clojure resolves the name <span class="calibre8"><span class="calibre39">foo</span></span>, it namespace-qualifies <span class="calibre8"><span class="calibre39">foo</span></span> in the current namespace <span class="calibre8"><span class="calibre39">user</span></span>. You can verify this by calling <span class="calibre8"><span class="calibre39">resolve</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">resolve</span></span></span><span class="calibre8"> sym)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">resolve</span></span> returns the var or class that a symbol will resolve to in the current namespace. Use <span class="calibre8"><span class="calibre39">resolve</span></span> to explicitly resolve the symbol <span class="calibre8"><span class="calibre39">foo</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(resolve 'foo)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/foo​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> You can switch namespaces, creating a new one if needed, with <span class="calibre8"><span class="calibre39">in-ns</span></span>:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">in-ns</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">name</span></span></span><span class="calibre8">)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38">Try creating a <span class="calibre8"><span class="calibre39">myapp</span></span> namespace:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;</span><span class="calibre8"><span class="bold"><span class="calibre36"> (in-ns 'myapp)</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #&lt;Namespace myapp&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​myapp=&gt;​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now you are in the <span class="calibre8"><span class="calibre39">myapp</span></span> namespace, and anything you <span class="calibre8"><span class="calibre39">def</span></span> or <span class="calibre8"><span class="calibre39">defn</span></span> will belong to <span class="calibre8"><span class="calibre39">myapp</span></span>. </p><p class="calibre12"> When you create a new namespace with <span class="calibre8"><span class="calibre39">in-ns</span></span>, the <span class="calibre8"><span class="calibre39">java.lang</span></span> package is automatically available to you: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​myapp=&gt; String​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.lang.String​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> While you are learning Clojure, you should <span class="calibre8"><span class="calibre39">use</span></span> the <span class="calibre8"><span class="calibre39">clojure.core</span></span> namespace whenever you move to a new namespace, making Clojure’s core functions available in the new namespace as well: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​myapp=&gt; (clojure.core/use 'clojure.core)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> By default, class names outside <span class="calibre8"><span class="calibre39">java.lang</span></span> must be fully qualified. You cannot just say <span class="calibre8"><span class="calibre39">File</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​myapp=&gt; File/separator​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.lang.Exception: No such namespace: File​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Instead, you must specify the fully qualified <span class="calibre8"><span class="calibre39">java.io.File</span></span>. Note that your file separator character may be different from that shown here: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​myapp=&gt; java.io.File/separator​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "/"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If you do not want to use a fully qualified class name, you can map one or more class names from a Java package into the current namespace using <span class="calibre8"><span class="calibre39">import</span></span>. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(import '(package Class+))​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38">Once you import a class, you can use its short name:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(import '(java.io InputStream File))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.io.File​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(.exists (File. "/tmp"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">import</span></span> is only for Java classes. If you want to use a Clojure var from another namespace, you must use its fully qualified name or map the name into the current namespace. Take, for example, Clojure’s <span class="calibre8"><span class="calibre39">split</span></span> function that resides in <span class="calibre8"><span class="calibre39">clojure.string</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(require 'clojure.string)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(clojure.string/split "Something,separated,by,commas" #",")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ["Something" "separated" "by" "commas"]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(split "Something,separated,by,commas" #",")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; Unable to resolve symbol: split in this context​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> To alias <span class="calibre8"><span class="calibre39">split</span></span> in the current namespace, call <span class="calibre8"><span class="calibre39">require</span></span> on <span class="calibre8"><span class="calibre39">split</span></span>’s namespace and give it the alias <span class="calibre8"><span class="calibre39">str</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(require '[clojure.string :as str])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(str/split "Something,separated,by,commas" #",")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ["Something" "separated" "by" "commas"]​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The simple form of <span class="calibre8"><span class="calibre39">require</span></span> shown earlier causes the current namespace to reference <span class="italic">all</span> public vars in <span class="calibre8"><span class="calibre39">clojure.string</span></span> and provide access to them under the alias <span class="calibre8"><span class="calibre39">str</span></span>. This can be confusing, because it does not make explicit which names are being referred to. </p><p class="calibre12"> It is idiomatic to <span class="calibre8"><span class="calibre39">import</span></span> Java classes and <span class="calibre8"><span class="calibre39">require</span></span> namespaces at the top of a source file, using the <span class="calibre8"><span class="calibre39">ns</span></span> macro: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">ns</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">name</span></span></span><span class="calibre8"> &amp; references)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">ns</span></span> macro sets the current namespace (available as <span class="calibre8"><span class="calibre39">*ns*</span></span>) to <span class="calibre8"><span class="calibre39">name</span></span>, creating the namespace if necessary. The <span class="calibre8"><span class="calibre39">references</span></span> can include <span class="calibre8"><span class="calibre39">:import</span></span>, <span class="calibre8"><span class="calibre39">:require</span></span>, and <span class="calibre8"><span class="calibre39">:use</span></span>, which work like the similarly named functions to set up the namespace mappings in a single form at the top of a source file. For example, this call to <span class="calibre8"><span class="calibre39">ns</span></span> appears at the top of the sample code for this chapter: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/exploring.clj"><span class="calibre41"><span class="underline">src/examples/exploring.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">ns</span></span></span><span class="calibre8"> examples.exploring​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:require [clojure.string :as </span><span class="calibre8"><span class="bold"><span class="calibre36">str</span></span></span><span class="calibre8">])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:import (java.io File)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Clojure’s namespace functions can do quite a bit more than I have shown here.</p><p class="calibre12"> You can reflectively traverse namespaces and add or remove mappings at any time. To find out more, issue this command at the REPL. Since we have moved around a bit in the REPL, we will also ensure that we are in the user namespace so that our REPL utilities are available to us: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(in-ns 'user)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(find-doc "ns-")​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Alternately, browse the documentation at <a href="http://clojure.org/namespaces">http://clojure.org/namespaces</a>. </p><div class="mbppagebreak"></div><p id="filepos281250" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">2.5 Calling Java</span></span></span></p><p class="calibre34"> Clojure provides simple, direct syntax for calling Java code: creating objects, invoking methods, and accessing static methods and fields. In addition, Clojure provides syntactic sugar that makes calling Java from Clojure more concise than calling Java from Java! </p><p class="calibre12"> Not all types in Java are created equal: the primitives and arrays work differently. Where Java has special cases, Clojure gives you direct access to these as well. Finally, Clojure provides a set of convenience functions for common tasks that would be unwieldy in Java. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Accessing Constructors, Methods, and Fields </span></span></span></p><p class="calibre44"> The first step in many Java interop scenarios is creating a Java object. Clojure provides the <span class="calibre8"><span class="calibre39">new</span></span> special form for this purpose: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">new</span></span></span><span class="calibre8"> classname)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Try creating a new <span class="calibre8"><span class="calibre39">Random</span></span>:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(new java.util.Random)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; &lt;Random java.util.Random@667cbde6&gt;​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The REPL simply prints out the new <span class="calibre8"><span class="calibre39">Random</span></span> instance by calling its <span class="calibre8"><span class="calibre39">toString</span></span> method. To use a <span class="calibre8"><span class="calibre39">Random</span></span> instance, you will need to save it away somewhere. For now, simply use <span class="calibre8"><span class="calibre39">def</span></span> to save the <span class="calibre8"><span class="calibre39">Random</span></span> into a Clojure <span class="calibre8"><span class="calibre39">Var</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def rnd (new java.util.Random))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/rnd​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now you can call methods on <span class="calibre8"><span class="calibre39">rnd</span></span> using Clojure’s dot (<span class="calibre8"><span class="calibre39">.</span></span>) special form: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"> class-or-instance member-symbol &amp; args)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"> class-or-instance (member-symbol &amp; args))​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">.</span></span> can call methods. For example, the following code calls the no-argument version of <span class="calibre8"><span class="calibre39">nextInt</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(. rnd nextInt)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; -791474443​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">Random</span></span> also has a <span class="calibre8"><span class="calibre39">nextInt</span></span> that takes an argument. You can call that version by simply adding the argument to the list: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(. rnd nextInt 10)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 8​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> In the previous call, the <span class="calibre8"><span class="calibre39">.</span></span> form is used to access an instance method. But <span class="calibre8"><span class="calibre39">.</span></span> works with all kinds of class members: fields as well as methods, and statics as well as instances. Here you can see the <span class="calibre8"><span class="calibre39">.</span></span> used to get the value of <span class="calibre8"><span class="calibre39">pi</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(. Math PI)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 3.141592653589793​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Notice that <span class="calibre8"><span class="calibre39">Math</span></span> is not fully qualified. It doesn’t have to be, because Clojure imports <span class="calibre8"><span class="calibre39">java.lang</span></span> automatically. To avoid typing <span class="calibre8"><span class="calibre39">java.util.Random</span></span> everywhere, you could explicitly <span class="calibre8"><span class="calibre39">import</span></span> it: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">import</span></span></span><span class="calibre8"> [&amp; import-lists])​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; import-list =&gt; (package-symbol &amp; class-name-symbols)</span></span></span><span class="calibre8">​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">import</span></span> takes a variable number of lists, with the first part of each list being a package name and the rest being names to import from that package. The following <span class="calibre8"><span class="calibre39">import</span></span> allows unqualified access to <span class="calibre8"><span class="calibre39">Random</span></span>, <span class="calibre8"><span class="calibre39">Locale</span></span>, and <span class="calibre8"><span class="calibre39">MessageFormat</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(import '(java.util Random Locale)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        '(java.text MessageFormat))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.text.MessageFormat​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​Random​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.util.Random​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​Locale​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.util.Locale​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​MessageFormat​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.text.MessageFormat​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> At this point, you have almost everything you need to call Java from Clojure. You can do the following: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">Import class names</p></li><a></a><li value="2" class="calibre30"><p class="calibre29">Create instances</p></li><a></a><li value="3" class="calibre30"><p class="calibre29">Access fields</p></li><a></a><li value="4" class="calibre30"><p class="calibre29">Invoke methods</p></li><a></a></ul><p class="calibre12"> However, there isn’t anything particularly exciting about the syntax. It is just “Java with different parentheses.” </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Javadoc</span></span></span></p><p class="calibre44"> Although reaching into Java from Clojure is easy, remembering how all of the Java bits underneath work can be daunting. Clojure provides a <span class="calibre8"><span class="calibre39">javadoc</span></span> function that will make your life much easier. This provides a pleasant experience from REPL when exploring. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(javadoc java.net.URL)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt;​</span><span class="calibre8">
</span>
</td></tr></table><div class="mbppagebreak"></div><p id="filepos292238" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">2.6 Flow Control</span></span></span></p><p class="calibre34"> Clojure has very few flow control forms. In this section, you will meet <span class="calibre8"><span class="calibre39">if</span></span>, <span class="calibre8"><span class="calibre39">do</span></span>, and <span class="calibre8"><span class="calibre39">loop</span></span>/<span class="calibre8"><span class="calibre39">recur</span></span>. As it turns out, this is almost all you will ever need. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Branch with if</span></span></span></p><p class="calibre44"> Clojure’s <span class="calibre8"><span class="calibre39">if</span></span> evaluates its first argument. If the argument is logically true, it returns the result of evaluating its second argument: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/exploring.clj"><span class="calibre41"><span class="underline">src/examples/exploring.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> is-small? [number]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">&lt;</span></span></span><span class="calibre8"> number 100) </span><span class="calibre8"><span class="italic"><span class="calibre42">"yes"</span></span></span><span class="calibre8">))​</span><span class="calibre8">
</span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(is-small? 50)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "yes"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If the first argument to <span class="calibre8"><span class="calibre39">if</span></span> is logically false, it returns <span class="calibre8"><span class="calibre39">nil</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(is-small? 50000)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If you want to define a result for the “else” part of <span class="calibre8"><span class="calibre39">if</span></span>, add it as a third argument: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/exploring.clj"><span class="calibre41"><span class="underline">src/examples/exploring.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> is-small? [number]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">&lt;</span></span></span><span class="calibre8"> number 100) </span><span class="calibre8"><span class="italic"><span class="calibre42">"yes"</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"no"</span></span></span><span class="calibre8">))​</span><span class="calibre8">
</span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(is-small? 50000)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "no"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">when</span></span> and <span class="calibre8"><span class="calibre39">when-not</span></span> control flow macros are built on top of <span class="calibre8"><span class="calibre39">if</span></span> and are described in <a href="#filepos1058767">​<span class="italic">when and when-not</span>​</a>. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Introduce Side Effects with do</span></span></span></p><p class="calibre44"> Clojure’s <span class="calibre8"><span class="calibre39">if</span></span> allows only one form for each branch. What if you want to do more than one thing on a branch? For example, you might want to log that a certain branch was chosen. <span class="calibre8"><span class="calibre39">do</span></span> takes any number of forms, evaluates them all, and returns the last. </p><p class="calibre12"> You can use a <span class="calibre8"><span class="calibre39">do</span></span> to print a logging statement from within an <span class="calibre8"><span class="calibre39">if</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/exploring.clj"><span class="calibre41"><span class="underline">src/examples/exploring.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> is-small? [number]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">&lt;</span></span></span><span class="calibre8"> number 100)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    </span><span class="calibre8"><span class="italic"><span class="calibre42">"yes"</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">do</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">println</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"Saw a big number"</span></span></span><span class="calibre8"> number)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      </span><span class="calibre8"><span class="italic"><span class="calibre42">"no"</span></span></span><span class="calibre8">)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">which results in:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(is-small? 200)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| Saw a big number 200​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "no"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> This is an example of a <span class="italic">side effect</span>. The <span class="calibre8"><span class="calibre39">println</span></span> doesn’t contribute to the return value of <span class="calibre8"><span class="calibre39">is-small?</span></span> at all. Instead, it reaches out into the world outside the function and actually <span class="italic">does something</span>. </p><p class="calibre12"> Many programming languages mix pure functions and side effects in a completely ad hoc fashion. Not Clojure. In Clojure, side effects are explicit and unusual. <span class="calibre8"><span class="calibre39">do</span></span> is one way to say “side effects to follow.” Since <span class="calibre8"><span class="calibre39">do</span></span> ignores the return values of all its forms save the last, those forms must have side effects to be of any use at all. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Recur with loop/recur</span></span></span></p><p class="calibre44"> The Swiss Army knife of flow control in Clojure is <span class="calibre8"><span class="calibre39">loop</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">loop</span></span></span><span class="calibre8"> [bindings </span><span class="calibre8"><span class="bold"><span class="calibre36">*</span></span></span><span class="calibre8">] exprs*)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">loop</span></span> special form works like <span class="calibre8"><span class="calibre39">let</span></span>, establishing <span class="calibre8"><span class="calibre39">bindings</span></span> and then evaluating <span class="calibre8"><span class="calibre39">exprs</span></span>. The difference is that <span class="calibre8"><span class="calibre39">loop</span></span> sets a <span class="calibre8"><span class="calibre39">recursion point</span></span>, which can then be targeted by the <span class="calibre8"><span class="calibre39">recur</span></span> special form: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">recur</span></span></span><span class="calibre8"> exprs*)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">recur</span></span> binds new values for <span class="calibre8"><span class="calibre39">loop</span></span>’s bindings and returns control to the top of the loop. For example, the following <span class="calibre8"><span class="calibre39">loop</span></span>/<span class="calibre8"><span class="calibre39">recur</span></span> returns a countdown: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/exploring.clj"><span class="calibre41"><span class="underline">src/examples/exploring.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">loop</span></span></span><span class="calibre8"> [result [] x 5]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">zero?</span></span></span><span class="calibre8"> x)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    result​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">recur</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">conj</span></span></span><span class="calibre8"> result x) (</span><span class="calibre8"><span class="bold"><span class="calibre36">dec</span></span></span><span class="calibre8"> x))))​</span><span class="calibre8">
</span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; [5 4 3 2 1]​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The first time through, <span class="calibre8"><span class="calibre39">loop</span></span> binds <span class="calibre8"><span class="calibre39">result</span></span> to an empty vector and binds <span class="calibre8"><span class="calibre39">x</span></span> to 5. Since <span class="calibre8"><span class="calibre39">x</span></span> is not zero, <span class="calibre8"><span class="calibre39">recur</span></span> then rebinds the names <span class="calibre8"><span class="calibre39">x</span></span> and <span class="calibre8"><span class="calibre39">result</span></span>: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"><span class="calibre8"><span class="calibre39">result</span></span> binds to the previous <span class="calibre8"><span class="calibre39">result</span></span> <span class="calibre8"><span class="calibre39">conj</span></span>oined with the previous <span class="calibre8"><span class="calibre39">x</span></span>. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">x</span></span> binds to the <span class="calibre8"><span class="calibre39">dec</span></span>rement of the previous <span class="calibre8"><span class="calibre39">x</span></span>. </p></li><a></a></ul><p class="calibre12"> Control then returns to the top of the loop. Since <span class="calibre8"><span class="calibre39">x</span></span> is again not zero, the loop continues, accumulating the <span class="calibre8"><span class="calibre39">result</span></span> and decrementing <span class="calibre8"><span class="calibre39">x</span></span>. Eventually, <span class="calibre8"><span class="calibre39">x</span></span> reaches zero, and the <span class="calibre8"><span class="calibre39">if</span></span> terminates the recurrence, returning <span class="calibre8"><span class="calibre39">result</span></span>. </p><p class="calibre12"> Instead of using a <span class="calibre8"><span class="calibre39">loop</span></span>, you can <span class="calibre8"><span class="calibre39">recur</span></span> back to the top of a function. This makes it simple to write a function whose entire body acts as an implicit <span class="calibre8"><span class="calibre39">loop</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/exploring.clj"><span class="calibre41"><span class="underline">src/examples/exploring.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> countdown [result x]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">zero?</span></span></span><span class="calibre8"> x)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    result​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">recur</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">conj</span></span></span><span class="calibre8"> result x) (</span><span class="calibre8"><span class="bold"><span class="calibre36">dec</span></span></span><span class="calibre8"> x))))​</span><span class="calibre8">
</span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(countdown [] 5)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; [5 4 3 2 1]​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">recur</span></span> is a powerful building block. But you may not use it very often, because many common recursions are provided by Clojure’s sequence library. </p><p class="calibre12">For example, countdown could also be expressed as any of these:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(into [] (take 5 (iterate dec 5)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; [5 4 3 2 1]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(into [] (drop-last (reverse (range 6))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; [5 4 3 2 1]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(vec (reverse (rest (range 6))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; [5 4 3 2 1]​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Do not expect these forms to make sense yet—just be aware that there are often alternatives to using <span class="calibre8"><span class="calibre39">recur</span></span> directly. The sequence library functions used here are described in Section 3.2, <a href="#filepos381095">​<span class="italic">Using the Sequence Library</span>​</a>. Clojure <span class="italic">will not</span> perform automatic tail-call optimization (TCO). However, it will optimize calls to <span class="calibre8"><span class="calibre39">recur</span></span>. Chapter 4, <a href="#filepos539895">​<span class="italic">Functional Programming</span>​</a> defines TCO and explores recursion and TCO in detail. </p><p class="calibre12"> At this point, you have seen quite a few language features but still no variables. Some things really do vary, and Chapter 5, <a href="#filepos699699">​<span class="italic">State</span>​</a> will show you how Clojure deals with changeable <span class="italic">references</span>. But most variables in traditional languages are unnecessary and downright dangerous. Let’s see how Clojure gets rid of them. </p><div class="mbppagebreak"></div><p id="filepos311519" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">2.7 Where’s My for Loop?</span></span></span></p><p class="calibre34"> Clojure has no <span class="calibre8"><span class="calibre39">for</span></span> loop and no direct mutable variables.<a id="filepos311779"></a><a href="#filepos349168">[24]</a> So, how do you write all that code you are accustomed to writing with <span class="calibre8"><span class="calibre39">for</span></span> loops? </p><p class="calibre12"> Rather than create a hypothetical example, we decided to grab a piece of open source Java code (sort of) randomly, find a method with some <span class="calibre8"><span class="calibre39">for</span></span> loops and variables, and port it to Clojure. We opened the Apache Commons project, which is very widely used. We selected the <span class="calibre8"><span class="calibre39">StringUtils</span></span> class in Commons Lang, assuming that such a class would require little domain knowledge to understand. We then browsed for a method that had multiple <span class="calibre8"><span class="calibre39">for</span></span> loops and local variables and found <span class="calibre8"><span class="calibre39">indexOfAny</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/data/snippets/StringUtils.java"><span class="calibre41"><span class="underline">data/snippets/StringUtils.java</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">// From Apache Commons Lang, http://commons.apache.org/lang/</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="bold"><span class="calibre36">public</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">static</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">int</span></span></span><span class="calibre8"> indexOfAny(</span><span class="calibre8"><span class="bold"><span class="calibre36">String</span></span></span><span class="calibre8"> str, </span><span class="calibre8"><span class="bold"><span class="calibre36">char</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">[]</span></span></span><span class="calibre8"> searchChars) {​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    </span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (isEmpty(str) || ArrayUtils.isEmpty(searchChars)) {​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        </span><span class="calibre8"><span class="bold"><span class="calibre36">return</span></span></span><span class="calibre8"> -1;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    }​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    </span><span class="calibre8"><span class="bold"><span class="calibre36">for</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">int</span></span></span><span class="calibre8"> i = 0; i &lt; str.length(); i++) {​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        </span><span class="calibre8"><span class="bold"><span class="calibre36">char</span></span></span><span class="calibre8"> ch = str.charAt(i);​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        </span><span class="calibre8"><span class="bold"><span class="calibre36">for</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">int</span></span></span><span class="calibre8"> j = 0; j &lt; searchChars.length; j++) {​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            </span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (searchChars[j] == ch) {​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                </span><span class="calibre8"><span class="bold"><span class="calibre36">return</span></span></span><span class="calibre8"> i;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            }​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        }​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    }​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    </span><span class="calibre8"><span class="bold"><span class="calibre36">return</span></span></span><span class="calibre8"> -1;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">indexOfAny</span></span> walks <span class="calibre8"><span class="calibre39">str</span></span> and reports the index of the first char that matches any char in <span class="calibre8"><span class="calibre39">searchChars</span></span>, returning <span class="calibre8"><span class="calibre39">-1</span></span> if no match is found. </p><p class="calibre12"> Here are some example results from the documentation for <span class="calibre8"><span class="calibre39">indexOfAny</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​StringUtils.indexOfAny(null, *)                = -1​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​StringUtils.indexOfAny(</span><span class="calibre8"><span class="italic"><span class="calibre42">""</span></span></span><span class="calibre8">, *)                  = -1​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​StringUtils.indexOfAny(*, null)                = -1​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​StringUtils.indexOfAny(*, </span><span class="calibre8"><span class="bold"><span class="calibre36">[]</span></span></span><span class="calibre8">)                  = -1​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​StringUtils.indexOfAny(</span><span class="calibre8"><span class="italic"><span class="calibre42">"zzabyycdxx"</span></span></span><span class="calibre8">,[</span><span class="calibre8"><span class="italic"><span class="calibre42">'z'</span></span></span><span class="calibre8">,</span><span class="calibre8"><span class="italic"><span class="calibre42">'a'</span></span></span><span class="calibre8">]) =  0​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​StringUtils.indexOfAny(</span><span class="calibre8"><span class="italic"><span class="calibre42">"zzabyycdxx"</span></span></span><span class="calibre8">,[</span><span class="calibre8"><span class="italic"><span class="calibre42">'b'</span></span></span><span class="calibre8">,</span><span class="calibre8"><span class="italic"><span class="calibre42">'y'</span></span></span><span class="calibre8">]) =  3​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​StringUtils.indexOfAny(</span><span class="calibre8"><span class="italic"><span class="calibre42">"aba"</span></span></span><span class="calibre8">, [</span><span class="calibre8"><span class="italic"><span class="calibre42">'z'</span></span></span><span class="calibre8">])           = -1​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> There are two <span class="calibre8"><span class="calibre39">if</span></span>s, two <span class="calibre8"><span class="calibre39">for</span></span>s, three possible points of return, and three mutable local variables in <span class="calibre8"><span class="calibre39">indexOfAny</span></span>, and the method is fourteen lines long, as counted by David A. Wheeler’s SLOCCount.<a id="filepos320521"></a><a href="#filepos349477">[25]</a>
</p><p class="calibre12"> Now let’s build a Clojure <span class="calibre8"><span class="calibre39">index-of-any</span></span>, step by step. If we just wanted to find the matches, we could use a Clojure <span class="calibre8"><span class="calibre39">filter</span></span>. But we want to find the <span class="italic">index</span> of a match. So, we create <span class="calibre8"><span class="calibre39">indexed</span></span>, a function that takes a collection and returns an indexed collection: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/exploring.clj"><span class="calibre41"><span class="underline">src/examples/exploring.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> indexed [coll] (map-indexed </span><span class="calibre8"><span class="bold"><span class="calibre36">vector</span></span></span><span class="calibre8"> coll))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">indexed</span></span> returns a sequence of pairs of the form <span class="calibre8"><span class="calibre39">[idx elt]</span></span>. Try indexing a string: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(indexed "abcde")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ([0 \a] [1 \b] [2 \c] [3 \d] [4 \e])​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Next, we want to find the indices of all the characters in the string that match the search set.</p><p class="calibre12"> Create an <span class="calibre8"><span class="calibre39">index-filter</span></span> function that is similar to Clojure’s <span class="calibre8"><span class="calibre39">filter</span></span> but that returns the indices instead of the matches themselves: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/exploring.clj"><span class="calibre41"><span class="underline">src/examples/exploring.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> index-filter [pred coll]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">when</span></span></span><span class="calibre8"> pred​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">for</span></span></span><span class="calibre8"> [[idx elt] (indexed coll) :when (pred elt)] idx)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Clojure’s <span class="calibre8"><span class="calibre39">for</span></span> is <span class="italic">not</span> a loop but a sequence comprehension (see <a href="#filepos413679">​<span class="italic">Transforming Sequences</span>​</a>). The index/element pairs of <span class="calibre8"><span class="calibre39">(indexed coll)</span></span> are bound to the names <span class="calibre8"><span class="calibre39">idx</span></span> and <span class="calibre8"><span class="calibre39">elt</span></span> but only when <span class="calibre8"><span class="calibre39">(pred elt)</span></span> is true. Finally, the comprehension yields the value of <span class="calibre8"><span class="calibre39">idx</span></span> for each matching pair. </p><p class="calibre12"> Clojure sets are functions that test membership in the set. So, you can pass a set of characters and a string to <span class="calibre8"><span class="calibre39">index-filter</span></span> and get back the indices of all characters in the string that belong to the set. Try it with a few different strings and character sets: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(index-filter #{\a \b} "abcdbbb")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (0 1 4 5 6)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(index-filter #{\a \b} "xyz")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ()​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> At this point, we have accomplished <span class="italic">more</span> than the stated objective. <span class="calibre8"><span class="calibre39">index-filter</span></span> returns the indices of all the matches, and we need only the first index. So, <span class="calibre8"><span class="calibre39">index-of-any</span></span> simply takes the <span class="calibre8"><span class="calibre39">first</span></span> result from <span class="calibre8"><span class="calibre39">index-filter</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/exploring.clj"><span class="calibre41"><span class="underline">src/examples/exploring.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> index-of-any [pred coll]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">first</span></span></span><span class="calibre8"> (index-filter pred coll)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Test that <span class="calibre8"><span class="calibre39">index-of-any</span></span> works correctly with a few different inputs:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(index-of-any #{\z \a} "zzabyycdxx")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 0​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(index-of-any #{\b \y} "zzabyycdxx")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 3​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The Clojure version is simpler than the imperative version by every metric (see Table 1, <a href="#filepos328150">​<span class="italic">Relative complexity of imperative and functional indexOfAny</span>​</a>). What accounts for the difference? </p><blockquote id="filepos328150" class="calibre9"><span class="bold">Table 1. Relative complexity of imperative and functional </span><span class="calibre8"><span class="bold"><span class="calibre39">indexOfAny</span></span></span><span class="bold">
</span></blockquote><hr class="calibre58"/><br class="calibre11"/><table valign="top" class="calibre54"><tr valign="top" class="calibre55"><th valign="top" class="calibre56"><span class="bold">   </span><blockquote class="calibre52"><span class="bold">Metric  </span></blockquote></th><th valign="top" class="calibre56"><span class="bold">   </span><blockquote class="calibre52"><span class="bold">LOC  </span></blockquote></th><th valign="top" class="calibre56"><span class="bold">   </span><blockquote class="calibre52"><span class="bold">Branches  </span></blockquote></th><th valign="top" class="calibre56"><span class="bold">   </span><blockquote class="calibre52"><span class="bold">Exits/Method  </span></blockquote></th><th valign="top" class="calibre56"><span class="bold">   </span><blockquote class="calibre52"><span class="bold">Variables  </span></blockquote></th></tr><tr valign="top" class="calibre55"><td valign="top" class="calibre57">   <blockquote class="calibre52">Imperative version  </blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">14  </blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">4  </blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">3  </blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">3  </blockquote></td></tr><tr valign="top" class="calibre55"><td valign="top" class="calibre57">   <blockquote class="calibre52">Functional version  </blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">6  </blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">1  </blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">1  </blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">0  </blockquote></td></tr></table><div class="calibre60"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> The imperative <span class="calibre8"><span class="calibre39">indexOfAny</span></span> must deal with several special cases: null or empty strings, a null or empty set of search characters, and the absence of a match. These special cases add branches and exits to the method. With a functional approach, most of these kinds of special cases just work without any explicit code. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> The imperative <span class="calibre8"><span class="calibre39">indexOfAny</span></span> introduces local variables to traverse collections (both the string and the character set). By using higher-order functions such as <span class="calibre8"><span class="calibre39">map</span></span> and sequence comprehensions such as <span class="calibre8"><span class="calibre39">for</span></span>, the functional <span class="calibre8"><span class="calibre39">index-of-any</span></span> avoids all need for variables. </p></li><a></a></ul><p class="calibre12"> Unnecessary complexity tends to snowball. For example, the special case branches in the imperative <span class="calibre8"><span class="calibre39">indexOfAny</span></span> use the magic number <span class="calibre8"><span class="calibre39">-1</span></span> to indicate a nonmatch. Should the magic number be a symbolic constant? Whatever you think the right answer is, <span class="italic">the question itself disappears</span> in the functional version. While shorter and simpler, the functional <span class="calibre8"><span class="calibre39">index-of-any</span></span> is also <span class="italic">vastly more general</span>: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"><span class="calibre8"><span class="calibre39">indexOfAny</span></span> searches a string, while <span class="calibre8"><span class="calibre39">index-of-any</span></span> can search any sequence. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">indexOfAny</span></span> matches against a set of characters, while <span class="calibre8"><span class="calibre39">index-of-any</span></span> can match against any predicate. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">indexOfAny</span></span> returns the first match, while <span class="calibre8"><span class="calibre39">index-filter</span></span> returns all the matches and can be further composed with other filters. </p></li><a></a></ul><p class="calibre12"> As an example of how much more general the functional <span class="calibre8"><span class="calibre39">index-of-any</span></span> is, you could use code like we just wrote to find the third occurrence of “heads” in a series of coin flips: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(nth (index-filter #{:h} [:t :t :h :t :h :t :t :t :h :h])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​2)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 8​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> So, it turns out that writing <span class="calibre8"><span class="calibre39">index-of-any</span></span> in a functional style, without loops or variables, is simpler, less error prone, and more general than the imperative <span class="calibre8"><span class="calibre39">indexOfAny</span></span>.<a id="filepos333944"></a><a href="#filepos350076">[26]</a> On larger units of code, these advantages become even more telling. </p><div class="mbppagebreak"></div><p id="filepos334070" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">2.8 Metadata</span></span></span></p><p class="calibre34"> The Wikipedia entry on metadata<a id="filepos334243"></a><a href="#filepos350391">[27]</a> begins by saying that metadata is “data about data.” That is true but not usably specific. In Clojure, metadata is data that is <span class="italic">orthogonal to the logical value of an object</span>. For example, a person’s first and last names are plain old data. The fact that a person object can be serialized to XML has nothing to do with the person and is metadata. Likewise, the fact that a person object is dirty and needs to be flushed to the database is metadata. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Reader Metadata</span></span></span></p><p class="calibre44"> The Clojure language itself uses metadata in several places. For example, vars have a metadata map containing documentation, type information, and source information. Here is the metadata for the <span class="calibre8"><span class="calibre39">str</span></span> var: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(meta #'str)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:ns #&lt;Namespace clojure.core&gt;,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    :name str,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    :file "core.clj",​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    :line 313,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    :arglists ([] [x] [x &amp; ys]),​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    :tag java.lang.String,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    :doc "With no args, ... etc."}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Some common metadata keys and their uses are shown in Figure 2, <a href="#filepos336789">​<span class="italic">Common metadata keys</span>​</a>. </p><br class="calibre11"/><br class="calibre11"/><table valign="top" id="filepos336789" class="calibre54"><tr valign="top" class="calibre55"><th valign="top" class="calibre56"><span class="bold">   </span><blockquote class="calibre52"><span class="bold">Metadata Key  </span></blockquote></th><th valign="top" class="calibre56"><span class="bold">   </span><blockquote class="calibre52"><span class="bold">Used For  </span></blockquote></th></tr><tr valign="top" class="calibre55"><td valign="top" class="calibre57">   <blockquote class="calibre52">   <span class="calibre8"><span class="calibre39">:arglists</span></span>
</blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">Parameter info used by   <span class="calibre8"><span class="calibre39">doc</span></span>
</blockquote></td></tr><tr valign="top" class="calibre55"><td valign="top" class="calibre57">   <blockquote class="calibre52">   <span class="calibre8"><span class="calibre39">:doc</span></span>
</blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">Documentation used by   <span class="calibre8"><span class="calibre39">doc</span></span>
</blockquote></td></tr><tr valign="top" class="calibre55"><td valign="top" class="calibre57">   <blockquote class="calibre52">   <span class="calibre8"><span class="calibre39">:file</span></span>
</blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">Source file  </blockquote></td></tr><tr valign="top" class="calibre55"><td valign="top" class="calibre57">   <blockquote class="calibre52">   <span class="calibre8"><span class="calibre39">:line</span></span>
</blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">Source line number  </blockquote></td></tr><tr valign="top" class="calibre55"><td valign="top" class="calibre57">   <blockquote class="calibre52">   <span class="calibre8"><span class="calibre39">:macro</span></span>
</blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">True for macros  </blockquote></td></tr><tr valign="top" class="calibre55"><td valign="top" class="calibre57">   <blockquote class="calibre52">   <span class="calibre8"><span class="calibre39">:name</span></span>
</blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">Local name  </blockquote></td></tr><tr valign="top" class="calibre55"><td valign="top" class="calibre57">   <blockquote class="calibre52">   <span class="calibre8"><span class="calibre39">:ns</span></span>
</blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">Namespace  </blockquote></td></tr><tr valign="top" class="calibre55"><td valign="top" class="calibre57">   <blockquote class="calibre52">   <span class="calibre8"><span class="calibre39">:tag</span></span>
</blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">Expected argument or return type  </blockquote></td></tr></table><hr class="calibre58"/><blockquote class="calibre1"><span class="bold">Figure 2. Common metadata keys</span></blockquote><p class="calibre12"> Much of the metadata on a var is added automatically by the Clojure compiler. To add your own key/value pairs to a var, use the metadata reader macro: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​^metadata form​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> For example, you could create a simple <span class="calibre8"><span class="calibre39">shout</span></span> function that upcases a string and then document that <span class="calibre8"><span class="calibre39">shout</span></span> both expects and returns a string, using the <span class="calibre8"><span class="calibre39">:tag</span></span> key: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​; see also shorter form below​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defn ^{:tag String} shout [^{:tag String} s] (.toUpperCase s))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/shout​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> You can inspect <span class="calibre8"><span class="calibre39">shout</span></span>’s metadata to see that Clojure added the <span class="calibre8"><span class="calibre39">:tag</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(meta #'shout)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:arglists ([s]),​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    :ns #&lt;Namespace user&gt;,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    :name shout,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    :line 32,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    :file "NO_SOURCE_FILE",​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    :tag java.lang.String}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> You provided the <span class="calibre8"><span class="calibre39">:tag</span></span>, and Clojure provided the other keys. The <span class="calibre8"><span class="calibre39">:file</span></span> value <span class="calibre8"><span class="calibre39">NO_SOURCE_FILE</span></span> indicates that the code was entered at the REPL. </p><p class="calibre12"> Because <span class="calibre8"><span class="calibre39">:tag</span></span> metadata is so common, you can also use the short-form <span class="calibre8"><span class="calibre39">^Classname</span></span>, which expands to <span class="calibre8"><span class="calibre39">^{:tag Classname}</span></span>. Using the shorter form, you can rewrite <span class="calibre8"><span class="calibre39">shout</span></span> as follows: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defn ^String shout [^String s] (.toUpperCase s))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/shout​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If you find the metadata disruptive when you are reading the definition of a function, you can place the metadata last. Use a variant of <span class="calibre8"><span class="calibre39">defn</span></span> that wraps one or more body forms in parentheses, followed by a metadata map: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defn shout​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  ([s] (.toUpperCase s))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  {:tag String})​</span><span class="calibre8">
</span>
</td></tr></table><div class="mbppagebreak"></div><p id="filepos344821" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">2.9 Wrapping Up</span></span></span></p><p class="calibre34"> This has been a long chapter. But think about how much ground you have covered: you can instantiate basic literal types, define and call functions, manage namespaces, and read and write metadata. You can write purely functional code, and yet you can easily introduce side effects when you need to do so. You have also met Lisp concepts including reader macros, special forms, and destructuring. </p><p class="calibre12"> The material here would take hundreds of pages to cover in most other languages. Is the Clojure way really that much simpler? Yes, in part. Half the credit for this chapter belongs to Clojure. Clojure’s elegant design and abstraction choices make the language much easier to learn than most. </p><p class="calibre12"> That said, the language may not <span class="italic">seem</span> so easy to learn right now. That’s because we are taking advantage of Clojure’s power to move much faster than most programming language books. </p><p class="calibre12"> So, the other half of the credit for this chapter belongs to you, the reader. Clojure will give back what you put in, and then some. Take the time you need to feel comfortable with the chapter’s examples and with using the REPL. The rest of the book will give you the opportunity to do that. </p><p class="calibre27"><span class="calibre8"><span class="bold"><span class="calibre28">Footnotes</span></span></span></p><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos156201"><span class="calibre8">[17]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://en.wikipedia.org/wiki/Homoiconicity"><span class="calibre8">http://en.wikipedia.org/wiki/Homoiconicity</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos346678"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos164991"><span class="calibre8">[18]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><span class="calibre8">More specifically, it’s called Cambridge Polish notation.</span></p></td></tr><a id="filepos346940"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos177023"><span class="calibre8">[19]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://clojure.org/reader"><span class="calibre8">http://clojure.org/reader</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos347231"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos209107"><span class="calibre8">[20]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><span class="calibre8">Reader macros are totally different from macros, which are discussed in Chapter 7, </span><a href="#filepos1030215"><span class="calibre8">​</span><span class="calibre8"><span class="italic">Macros</span></span><span class="calibre8">​</span></a><span class="calibre8">.</span></p></td></tr><a id="filepos347651"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos215335"><span class="calibre8">[21]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://tinyurl.com/clojure-reader-macros"><span class="calibre8">http://tinyurl.com/clojure-reader-macros</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos347972"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos266575"><span class="calibre8">[22]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://clojure.org/special_forms"><span class="calibre8">http://clojure.org/special_forms</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos348277"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos267544"><span class="calibre8">[23]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><span class="calibre8">Most of the REPL session listings in the book omit the REPL prompt for brevity. In this section, the REPL prompt will be included whenever the current namespace is important.</span></p></td></tr><a id="filepos348654"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos311779"><span class="calibre8">[24]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><span class="calibre8">Clojure provides </span><span class="calibre8"><span class="italic">indirect</span></span><span class="calibre8"> mutable references, but these must be explicitly called out in your code. See Chapter 5, </span><a href="#filepos699699"><span class="calibre8">​</span><span class="calibre8"><span class="italic">State</span></span><span class="calibre8">​</span></a><span class="calibre8"> for details.</span></p></td></tr><a id="filepos349168"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos320521"><span class="calibre8">[25]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://www.dwheeler.com/sloccount/"><span class="calibre8">http://www.dwheeler.com/sloccount/</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos349477"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos333944"><span class="calibre8">[26]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><span class="calibre8">It is worth mentioning that you could write a functional </span><span class="calibre8"><span class="calibre39">indexOfAny</span></span><span class="calibre8"> in plain Java, although it would not be idiomatic. It may become more idiomatic when closures are added to the language. See </span><a href="http://functionaljava.org/"><span class="calibre8">http://functionaljava.org/</span></a><span class="calibre8"> for more information.</span></p></td></tr><a id="filepos350076"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos334243"><span class="calibre8">[27]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://en.wikipedia.org/wiki/Metadata"><span class="calibre8">http://en.wikipedia.org/wiki/Metadata</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos350391"></a></table><p class="calibre18"><span class="calibre8"><span class="calibre19"><span class="calibre20">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="mbppagebreak"></div><p id="filepos350588" class="calibre25"><span class="calibre2"><span class="bold"><span class="calibre43"> Chapter 3</span></span></span></p><br class="calibre11"/><p class="calibre26"><span class="calibre2"><span class="bold"><span class="calibre3">Unifying Data with Sequences</span></span></span></p><p class="calibre12"> Programs manipulate data. At the lowest level, programs work with structures such as strings, lists, vectors, maps, sets, and trees. At a higher level, these same data structure abstractions crop up again and again. For example: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">XML data is a tree.</p></li><a></a><li value="2" class="calibre30"><p class="calibre29">Database result sets can be viewed as lists or vectors.</p></li><a></a><li value="3" class="calibre30"><p class="calibre29">Directory hierarchies are trees.</p></li><a></a><li value="4" class="calibre30"><p class="calibre29">Files are often viewed as one big string or as a vector of lines.</p></li><a></a></ul><p class="calibre12"> In Clojure, all these data structures can be accessed through a single abstraction: the sequence (or <span class="italic">seq</span>). </p><p class="calibre12"> A seq (pronounced “seek”) is a <span class="italic">logical</span> list. It’s logical because Clojure does not tie sequences to <span class="italic">implementation details</span> of a list such as a Lisp cons cell (see <a href="#filepos362755">​<span class="italic">The Origin of Cons</span>​</a> for the history of cons). Instead, the seq is an abstraction that can be used everywhere. </p><p class="calibre12"> Collections that can be viewed as seqs are called <span class="italic">seq-able</span> (pronounced “SEEK-a-bull”). In this chapter, you will meet a variety of seq-able collections: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">All Clojure collections</p></li><a></a><li value="2" class="calibre30"><p class="calibre29">All Java collections</p></li><a></a><li value="3" class="calibre30"><p class="calibre29">Java arrays and strings</p></li><a></a><li value="4" class="calibre30"><p class="calibre29">Regular expression matches</p></li><a></a><li value="5" class="calibre30"><p class="calibre29">Directory structures</p></li><a></a><li value="6" class="calibre30"><p class="calibre29">I/O streams</p></li><a></a><li value="7" class="calibre30"><p class="calibre29">XML trees</p></li><a></a></ul><p class="calibre12"> You will also meet the sequence library, a set of functions that can work with any seq-able. Because so many things are sequences, the sequence library is much more powerful and general than the collection APIs in most languages. The sequence library includes functions to create, filter, and transform data. These functions act as the Collections API for Clojure, and they also replace many of the loops you would write in an imperative language. </p><p class="calibre12"> In this chapter, you will become a power user of Clojure sequences. You will see how to use a common set of very expressive functions with an incredibly wide range of datatypes. Then, in the next chapter (Chapter 4, <a href="#filepos539895">​<span class="italic">Functional Programming</span>​</a>), you will learn the functional style in which the sequence library is written. </p><div class="mbppagebreak"></div><p id="filepos354001" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">3.1 Everything Is a Sequence</span></span></span></p><p class="calibre34"> Every aggregate data structure in Clojure can be viewed as a sequence. A sequence has three core capabilities: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> You can get the <span class="calibre8"><span class="calibre39">first</span></span> item in a sequence: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">first</span></span></span><span class="calibre8"> aseq)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">first</span></span> returns <span class="calibre8"><span class="calibre39">nil</span></span> if its argument is empty or <span class="calibre8"><span class="calibre39">nil</span></span>. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> You can get everything after the first item, in other words, the <span class="calibre8"><span class="calibre39">rest</span></span> of a sequence: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">rest</span></span></span><span class="calibre8"> aseq)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">rest</span></span> returns an empty seq (not <span class="calibre8"><span class="calibre39">nil</span></span>) if there are no more items. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> You can construct a new sequence by adding an item to the front of an existing sequence. This is called <span class="calibre8"><span class="calibre39">cons</span></span>ing: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">cons</span></span></span><span class="calibre8"> elem aseq)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table></li><a></a></ul><p class="calibre12"> Under the hood, these three capabilities are declared in the Java interface <span class="calibre8"><span class="calibre39">clojure.lang.ISeq</span></span>. (Keep this in mind when reading about Clojure, because the name <span class="calibre8"><span class="calibre39">ISeq</span></span> is often used interchangeably with seq.) </p><p class="calibre12"> The <span class="calibre8"><span class="calibre39">seq</span></span> function will return a seq on any seq-able collection: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">seq</span></span></span><span class="calibre8"> coll)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">seq</span></span> will return <span class="calibre8"><span class="calibre39">nil</span></span> if its <span class="calibre8"><span class="calibre39">coll</span></span> is empty or <span class="calibre8"><span class="calibre39">nil</span></span>. The <span class="calibre8"><span class="calibre39">next</span></span> function will return the <span class="calibre8"><span class="calibre39">seq</span></span> of items after the first: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">next</span></span></span><span class="calibre8"> aseq)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">(next aseq)</span></span> is equivalent to <span class="calibre8"><span class="calibre39">(seq (rest aseq))</span></span>. Table 2, <a href="#filepos358243">​<span class="italic">Clarifying rest/next behavior</span>​</a> clarifies the rest/next behavior. </p><blockquote id="filepos358243" class="calibre9"><span class="bold">Table 2. Clarifying rest/next behavior</span></blockquote><hr class="calibre58"/><br class="calibre11"/><table valign="top" class="calibre54"><tr valign="top" class="calibre55"><th valign="top" class="calibre56"><span class="bold">   </span><blockquote class="calibre52"><span class="bold">Form  </span></blockquote></th><th valign="top" class="calibre56"><span class="bold">   </span><blockquote class="calibre52"><span class="bold">Result  </span></blockquote></th></tr><tr valign="top" class="calibre55"><td valign="top" class="calibre57">   <blockquote class="calibre52">   <span class="calibre8"><span class="calibre39">(rest ())</span></span>
</blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">   <span class="calibre8"><span class="calibre39">()</span></span>
</blockquote></td></tr><tr valign="top" class="calibre55"><td valign="top" class="calibre57">   <blockquote class="calibre52">   <span class="calibre8"><span class="calibre39">(next ())</span></span>
</blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">   <span class="calibre8"><span class="calibre39">nil</span></span>
</blockquote></td></tr><tr valign="top" class="calibre55"><td valign="top" class="calibre57">   <blockquote class="calibre52">   <span class="calibre8"><span class="calibre39">(seq (rest ()))</span></span>
</blockquote></td><td valign="top" class="calibre57">   <blockquote class="calibre52">   <span class="calibre8"><span class="calibre39">nil</span></span>
</blockquote></td></tr></table><p class="calibre27"> If you have a Lisp background, you expect to find that the seq functions work for lists: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(first '(1 2 3))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 1​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(rest '(1 2 3))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (2 3)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(cons 0 '(1 2 3))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (0 1 2 3)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> In Clojure, the same functions will work for other data structures as well. You can treat vectors as seqs: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(first [1 2 3])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 1​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(rest [1 2 3])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (2 3)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(cons 0 [1 2 3])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (0 1 2 3)​</span><span class="calibre8">
</span>
</td></tr></table><blockquote id="filepos362755" class="calibre47"><span class="calibre41"><span class="bold">The Origin of Cons</span></span></blockquote><blockquote class="calibre48"><span class="calibre41"> Clojure’s sequence is an abstraction based on Lisp’s concrete lists. In the original implementation of Lisp, the three fundamental list operations were named </span><span class="calibre8"><span class="calibre39">car</span></span><span class="calibre41">, </span><span class="calibre8"><span class="calibre39">cdr</span></span><span class="calibre41">, and </span><span class="calibre8"><span class="calibre39">cons</span></span><span class="calibre41">. </span><span class="calibre8"><span class="calibre39">car</span></span><span class="calibre41"> and </span><span class="calibre8"><span class="calibre39">cdr</span></span><span class="calibre41"> are acronyms that refer to implementation details of Lisp on the original IBM 704 platform. Many Lisps, including Clojure, replace these esoteric names with the more meaningful names </span><span class="calibre8"><span class="calibre39">first</span></span><span class="calibre41"> and </span><span class="calibre8"><span class="calibre39">rest</span></span><span class="calibre41">. </span></blockquote><blockquote class="calibre61"><span class="calibre41"> The third function, </span><span class="calibre8"><span class="calibre39">cons</span></span><span class="calibre41">, is short for construct. Lisp programmers use </span><span class="calibre8"><span class="calibre39">cons</span></span><span class="calibre41"> as a noun, verb, and adjective. You use cons to create a data structure called a </span><span class="calibre41"><span class="italic">cons cell</span></span><span class="calibre41">, or just a </span><span class="calibre41"><span class="italic">cons</span></span><span class="calibre41"> for short. </span></blockquote><blockquote class="calibre61"><span class="calibre41"> Most Lisps, including Clojure, retain the original </span><span class="calibre8"><span class="calibre39">cons</span></span><span class="calibre41"> name, since “construct” is a pretty good mnemonic for what </span><span class="calibre8"><span class="calibre39">cons</span></span><span class="calibre41"> does. It also helps remind you that sequences are immutable. For convenience, you might say that </span><span class="calibre8"><span class="calibre39">cons</span></span><span class="calibre41"> adds an element to a sequence, but it is more accurate to say that </span><span class="calibre8"><span class="calibre39">cons</span></span><span class="calibre41"> </span><span class="calibre41"><span class="italic">constructs</span></span><span class="calibre41"> a new sequence, which is like the original sequence but with one element added. </span></blockquote><p class="calibre50"> When you apply <span class="calibre8"><span class="calibre39">rest</span></span> or <span class="calibre8"><span class="calibre39">cons</span></span> to a vector, the result is a seq, not a vector. In the REPL, seqs print just like lists, as you can see in the earlier output. You can check the actual returned type by taking its <span class="calibre8"><span class="calibre39">class</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(class (rest [1 2 3]))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; clojure.lang.PersistentVector$ChunkedSeq​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">$ChunkedSeq</span></span> at the end of the class name is Java’s way of mangling nested class names. Seqs that you produce from a specific collection type are often implemented as a <span class="calibre8"><span class="calibre39">ChunkedSeq</span></span> class nested inside the original collection class (<span class="calibre8"><span class="calibre39">PersistentVector</span></span> in this example). </p><p class="calibre12"> The generality of seqs is very powerful, but sometimes you want to produce a specific implementation type. This is covered in Section 3.5, <a href="#filepos484006">​<span class="italic">Calling Structure-Specific Functions</span>​</a>. </p><p class="calibre12"> You can treat maps as seqs, if you think of a key/value pair as an item in the sequence: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(first {:fname "Aaron" :lname "Bedra"})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; [:lname "Bedra"]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(rest {:fname "Aaron" :lname "Bedra"})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ([:fname "Aaron"])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(cons [:mname "James"] {:fname "Aaron" :lname "Bedra"})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ([:mname "James"] [:lname "Bedra"] [:fname "Aaron"])​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> You can also treat sets as seqs:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(first #{:the :quick :brown :fox})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; :brown​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(rest #{:the :quick :brown :fox})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (:quick :fox :the)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(cons :jumped #{:the :quick :brown :fox})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (:jumped :brown :quick :fox :the)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Maps and sets have a stable traversal order, but that order depends on implementation details, and you should not rely on it. Elements of a set will not necessarily come back in the order that you put them in: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​#{:the :quick :brown :fox}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #{:brown :quick :fox :the}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">If you want a reliable order, you can use this:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">sorted-set</span></span></span><span class="calibre8"> &amp; elements)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">sorted-set</span></span> will sort the values by their natural sort order: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(sorted-set :the :quick :brown :fox)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #{:brown :fox :quick :the}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Likewise, key/value pairs in maps won’t necessarily come back in the order you put them in: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​{:a 1 :b 2 :c 3}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:a 1, :c 3, :b 2}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> You can create a sorted map with <span class="calibre8"><span class="calibre39">sorted-map</span></span>:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">sorted-map</span></span></span><span class="calibre8"> &amp; elements)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">sorted-map</span></span>s won’t come back in the order you put them in either, but they <span class="italic">will</span> come back sorted by key: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(sorted-map :c 3 :b 2 :a 1)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:a 1, :b 2, :c 3}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> In addition to the core capabilities of seq, two other capabilities are worth meeting immediately: <span class="calibre8"><span class="calibre39">conj</span></span> and <span class="calibre8"><span class="calibre39">into</span></span>. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">conj</span></span></span><span class="calibre8"> coll element &amp; elements)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">into</span></span></span><span class="calibre8"> to-coll from-coll)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">conj</span></span> adds one or more elements to a collection, and <span class="calibre8"><span class="calibre39">into</span></span> adds all the items in one collection to another. Both <span class="calibre8"><span class="calibre39">conj</span></span> and <span class="calibre8"><span class="calibre39">into</span></span> add items at an efficient insertion spot for the underlying data structure. For lists, <span class="calibre8"><span class="calibre39">conj</span></span> and <span class="calibre8"><span class="calibre39">into</span></span> add to the front: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(conj '(1 2 3) :a)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (:a 1 2 3)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(into '(1 2 3) '(:a :b :c))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (:c :b :a 1 2 3)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> For vectors, <span class="calibre8"><span class="calibre39">conj</span></span> and <span class="calibre8"><span class="calibre39">into</span></span> add elements to the back:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(conj [1 2 3] :a)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; [1 2 3 :a]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(into [1 2 3] [:a :b :c])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; [1 2 3 :a :b :c]​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Because <span class="calibre8"><span class="calibre39">conj</span></span> (and related functions) do the efficient thing for the underlying data structure, you can often write code that is both efficient and completely decoupled from a specific underlying implementation. </p><blockquote class="calibre53"><img src="images/00002.jpg" class="calibre62"/><span class="calibre8">        </span></blockquote><blockquote class="calibre48"><span class="calibre8"><span class="bold"><span class="calibre43">Joe asks:</span></span></span></blockquote><blockquote class="calibre63"><span class="bold"><span class="calibre3">Why Do Functions on Vectors Return Lists?</span></span></blockquote><blockquote class="calibre64"><span class="calibre8"> When you try examples at the REPL, the results of </span><span class="calibre8"><span class="calibre39">rest</span></span><span class="calibre8"> and </span><span class="calibre8"><span class="calibre39">cons</span></span><span class="calibre8"> appear to be lists, even when the inputs are vectors, maps, or sets. Does this mean that Clojure is converting everything to a list internally? No! The sequence functions always return a seq, regardless of their inputs. You can verify this by checking the Java type of the returned objects: </span></blockquote><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span><span class="calibre8">
</span></td><td valign="top" class="calibre23"><span class="calibre8">​(class '(1 2 3))​</span><span class="calibre8">  </span></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span><span class="calibre8">
</span></td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; clojure.lang.PersistentList​</span><span class="calibre8">  </span></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span><span class="calibre8">
</span></td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">  </span></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span><span class="calibre8">
</span></td><td valign="top" class="calibre23"><span class="calibre8">​(class (rest [1 2 3]))​</span><span class="calibre8">  </span></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span><span class="calibre8">
</span></td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; clojure.lang.PersistentVector$ChunkedSeq​</span><span class="calibre8">  </span></td></tr></table><blockquote class="calibre65"><span class="calibre8"> As you can see, the result of </span><span class="calibre8"><span class="calibre39">(rest [1 2 3])</span></span><span class="calibre8"> is some kind of </span><span class="calibre8"><span class="calibre39">Seq</span></span><span class="calibre8">, not a </span><span class="calibre8"><span class="calibre39">List</span></span><span class="calibre8">. So, why does the result appear to be a list? </span></blockquote><blockquote class="calibre66"><span class="calibre8"> The answer lies in the REPL. When you ask the REPL to display a sequence, all it knows is that it has a sequence. It does not know what kind of collection the sequence was built from. So, the REPL prints all sequences the same way: it walks the entire sequence, printing it as a list. </span></blockquote><p class="calibre27"> The Clojure sequence library is particularly suited for large (or even infinite) sequences. Most Clojure sequences are <span class="italic">lazy</span>: they generate elements only when they are actually needed. Thus, Clojure’s sequence functions can process sequences too large to fit in memory. </p><p class="calibre12"> Clojure sequences are <span class="italic">immutable</span>: they never change. This makes it easier to reason about programs and means that Clojure sequences are safe for concurrent access. It does, however, create a small problem for human language. English-language descriptions flow much more smoothly when describing mutable things. Consider the following two descriptions for a hypothetical sequence function <span class="calibre8"><span class="calibre39">triple</span></span>: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"><span class="calibre8"><span class="calibre39">triple</span></span> triples each element of a sequence. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">triple</span></span> takes a sequence and returns a new sequence with each element of the original sequence tripled. </p></li><a></a></ul><p class="calibre12"> The latter version is specific and accurate. The former is much easier to read, but it might lead to the mistaken impression that a sequence is actually changing. Don’t be fooled: <span class="italic">sequences never change</span>. If you see the phrase “foo changes x,” mentally substitute “foo returns a changed copy of x.” </p><div class="mbppagebreak"></div><p id="filepos381095" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">3.2 Using the Sequence Library</span></span></span></p><p class="calibre34"> The Clojure sequence library provides a rich set of functionality that can work with any sequence. If you come from an object-oriented background where nouns rule, the sequence library is truly “Revenge of the Verbs.”<a id="filepos381476"></a><a href="#filepos538326">[28]</a> The functions provide a rich backbone of functionality that can take advantage of any data structure that obeys the basic <span class="calibre8"><span class="calibre39">first</span></span>/<span class="calibre8"><span class="calibre39">rest</span></span>/<span class="calibre8"><span class="calibre39">cons</span></span> contract. </p><p class="calibre12">The following functions are grouped into four broad categories:</p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">Functions that create sequences</p></li><a></a><li value="2" class="calibre30"><p class="calibre29">Functions that filter sequences</p></li><a></a><li value="3" class="calibre30"><p class="calibre29">Sequence predicates</p></li><a></a><li value="4" class="calibre30"><p class="calibre29">Functions that transform sequences</p></li><a></a></ul><p class="calibre12"> These divisions are somewhat arbitrary. Since sequences are immutable, <span class="italic">most</span> of the sequence functions create new sequences. Some of the sequence functions both filter and transform. Nevertheless, these divisions provide a rough road map through a large library. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Creating Sequences</span></span></span></p><p class="calibre44"> In addition to the sequence literals, Clojure provides a number of functions that create sequences. <span class="calibre8"><span class="calibre39">range</span></span> produces a sequence from a <span class="calibre8"><span class="calibre39">start</span></span> to an <span class="calibre8"><span class="calibre39">end</span></span>, incrementing by <span class="calibre8"><span class="calibre39">step</span></span> each time. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">range</span></span></span><span class="calibre8"> start? end step?)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Ranges include their <span class="calibre8"><span class="calibre39">start</span></span> but not their <span class="calibre8"><span class="calibre39">end</span></span>. If you do not specify them, <span class="calibre8"><span class="calibre39">start</span></span> defaults to zero, and <span class="calibre8"><span class="calibre39">step</span></span> defaults to 1. Try creating some ranges at the REPL: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(range 10)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (0 1 2 3 4 5 6 7 8 9)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(range 10 20)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (10 11 12 13 14 15 16 17 18 19)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(range 1 25 2)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (1 3 5 7 9 11 13 15 17 19 21 23)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">repeat</span></span> function repeats an element <span class="calibre8"><span class="calibre39">x</span></span> <span class="calibre8"><span class="calibre39">n</span></span> times: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">repeat</span></span></span><span class="calibre8"> n x)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38">Try to <span class="calibre8"><span class="calibre39">repeat</span></span> some items from the REPL:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(repeat 5 1)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (1 1 1 1 1)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(repeat 10 "x")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ("x" "x" "x" "x" "x" "x" "x" "x" "x" "x")​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Both <span class="calibre8"><span class="calibre39">range</span></span> and <span class="calibre8"><span class="calibre39">repeat</span></span> represent ideas that can be extended infinitely. You can think of <span class="calibre8"><span class="calibre39">iterate</span></span> as the infinite extension of <span class="calibre8"><span class="calibre39">range</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">iterate</span></span></span><span class="calibre8"> f x)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">iterate</span></span> begins with a value <span class="calibre8"><span class="calibre39">x</span></span> and continues forever, applying a function <span class="calibre8"><span class="calibre39">f</span></span> to each value to calculate the next. </p><p class="calibre12"> If you begin with <span class="calibre8"><span class="calibre39">1</span></span> and <span class="calibre8"><span class="calibre39">iterate</span></span> with <span class="calibre8"><span class="calibre39">inc</span></span>, you can generate the whole numbers: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(take 10 (iterate inc 1))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (1 2 3 4 5 6 7 8 9 10)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Since the sequence is infinite, you need another new function to help you view the sequence from the REPL. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">take</span></span></span><span class="calibre8"> n </span><span class="calibre8"><span class="bold"><span class="calibre36">sequence</span></span></span><span class="calibre8">)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">take</span></span> returns a lazy sequence of the first <span class="calibre8"><span class="calibre39">n</span></span> items from a collection and provides one way to create a finite view onto an infinite collection. </p><p class="calibre12"> The whole numbers are a pretty useful sequence to have around, so let’s <span class="calibre8"><span class="calibre39">defn</span></span> them for future use: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defn whole-numbers [] (iterate inc 1))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/whole-numbers​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> When called with a single argument, <span class="calibre8"><span class="calibre39">repeat</span></span> returns a lazy, infinite sequence: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(repeat x)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Try <span class="calibre8"><span class="calibre39">repeat</span></span>ing some elements at the REPL. Don’t forget to wrap the result in a <span class="calibre8"><span class="calibre39">take</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(take 20 (repeat 1))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">cycle</span></span> function takes a collection and cycles it infinitely: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">cycle</span></span></span><span class="calibre8"> coll)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38">Try cycling some collections at the REPL:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(take 10 (cycle (range 3)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (0 1 2 0 1 2 0 1 2 0)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">interleave</span></span> function takes multiple collections and produces a new collection that interleaves values from each collection until one of the collections is exhausted. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">interleave</span></span></span><span class="calibre8"> &amp; colls)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> When one of the collections is exhausted, the <span class="calibre8"><span class="calibre39">interleave</span></span> stops. So, you can mix finite and infinite collections: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(interleave (whole-numbers) ["A" "B" "C" "D" "E"])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (1 "A" 2 "B" 3 "C" 4 "D" 5 "E")​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Closely related to <span class="calibre8"><span class="calibre39">interleave</span></span> is <span class="calibre8"><span class="calibre39">interpose</span></span>, which returns a sequence with each of the elements of the input collection segregated by a separator: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">interpose</span></span></span><span class="calibre8"> separator coll)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> You can use <span class="calibre8"><span class="calibre39">interpose</span></span> to build delimited strings:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(interpose "," ["apples" "bananas" "grapes"])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ("apples" "," "bananas" "," "grapes")​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">interpose</span></span> works nicely with <span class="calibre8"><span class="calibre39">(apply str ...)</span></span> to produce output strings: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(apply str (interpose \, ["apples" "bananas" "grapes"]))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "apples,bananas,grapes"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">(apply str ...)</span></span> idiom is common enough that Clojure wraps it as <span class="calibre8"><span class="calibre39">clojure.string/join</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(join separator </span><span class="calibre8"><span class="bold"><span class="calibre36">sequence</span></span></span><span class="calibre8">)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Use <span class="calibre8"><span class="calibre39">clojure.string/join</span></span> to comma-delimit a list of words:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(use '[clojure.string :only (join)])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(join \, ["apples" "bananas" "grapes"])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "apples,bananas,grapes"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> For each collection type in Clojure, there is a function that takes an arbitrary number of arguments and creates a collection of that type: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">list</span></span></span><span class="calibre8"> &amp; elements)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">vector</span></span></span><span class="calibre8"> &amp; elements)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">hash-set</span></span></span><span class="calibre8"> &amp; elements)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">hash-map</span></span></span><span class="calibre8"> key-1 val-1 </span><span class="calibre8"><span class="bold"><span class="calibre36">..</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">hash-set</span></span> has a cousin <span class="calibre8"><span class="calibre39">set</span></span> that works a little differently: <span class="calibre8"><span class="calibre39">set</span></span> expects a collection as its first argument: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(set [1 2 3])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #{1 2 3}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">hash-set</span></span> takes a variable list of arguments:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(hash-set 1 2 3)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #{1 2 3}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">vector</span></span> also has a cousin, <span class="calibre8"><span class="calibre39">vec</span></span>, that takes a single collection argument instead of a variable argument list: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(vec (range 3))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; [0 1 2]​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Now that you have the basics of creating sequences, you can use other Clojure functions to filter and transform them. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Filtering Sequences</span></span></span></p><p class="calibre44"> Clojure provides a number of functions that filter a sequence, returning a subsequence of the original sequence. The most basic of these is <span class="calibre8"><span class="calibre39">filter</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">filter</span></span></span><span class="calibre8"> pred coll)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">filter</span></span> takes a predicate and a collection and returns a sequence of objects for which the filter returns true (when interpreted in a boolean context). You can filter the <span class="calibre8"><span class="calibre39">whole-numbers</span></span> from the previous section to get the odd numbers or the even numbers: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(take 10 (filter even? (whole-numbers)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (2 4 6 8 10 12 14 16 18 20)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(take 10 (filter odd? (whole-numbers)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (1 3 5 7 9 11 13 15 17 19)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> You can take from a sequence while a predicate remains true with <span class="calibre8"><span class="calibre39">take-while</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">take-while</span></span></span><span class="calibre8"> pred coll)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> For example, to take all the characters in a string up to the first vowel, use this: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(take-while (complement #{\a\e\i\o\u}) "the-quick-brown-fox")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (\t \h)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">There are a couple of interesting things happening here:</p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Sets also act as functions. So, you can read <span class="calibre8"><span class="calibre39">#{\a\e\i\o\u}</span></span> either as “the set of vowels” or as “the function that tests to see whether its argument is vowel.” </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">complement</span></span> reverses the behavior of another function. The previous complemented function tests to see whether its argument is <span class="italic">not</span> a vowel. </p></li><a></a></ul><p class="calibre12"> The opposite of <span class="calibre8"><span class="calibre39">take-while</span></span> is <span class="calibre8"><span class="calibre39">drop-while</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">drop-while</span></span></span><span class="calibre8"> pred coll)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">drop-while</span></span> drops elements from the beginning of a sequence while a predicate is true and then returns the rest. You could <span class="calibre8"><span class="calibre39">drop-while</span></span> to drop all leading nonvowels from a string: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(drop-while (complement #{\a\e\i\o\u}) "the-quick-brown-fox")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (\e \- \q \u \i \c \k \- \b \r \o \w \n \- \f \o \x)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">split-at</span></span> and <span class="calibre8"><span class="calibre39">split-with</span></span> will split a collection into two collections: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">split-at</span></span></span><span class="calibre8"> index coll)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">split-with</span></span></span><span class="calibre8"> pred coll)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">split-at</span></span> takes an index, and <span class="calibre8"><span class="calibre39">split-with</span></span> takes a predicate: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(split-at 5 (range 10))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt;[(0 1 2 3 4) (5 6 7 8 9)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(split-with #(&lt;= % 10) (range 0 20 2))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt;[(0 2 4 6 8 10) (12 14 16 18)]​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> All the <span class="calibre8"><span class="calibre39">take-</span></span>, <span class="calibre8"><span class="calibre39">split-</span></span>, and <span class="calibre8"><span class="calibre39">drop-</span></span> functions return lazy sequences, of course. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Sequence Predicates</span></span></span></p><p class="calibre44"> Filter functions take a predicate and return a sequence. Closely related are the sequence predicates. A sequence predicate asks how some other predicate applies to every item in a sequence. For example, the <span class="calibre8"><span class="calibre39">every?</span></span> predicate asks whether some other predicate is true for every element of a sequence. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">every?</span></span></span><span class="calibre8"> pred coll)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(every? odd? [1 3 5])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(every? odd? [1 3 5 8])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; false​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> A lower bar is set by <span class="calibre8"><span class="calibre39">some</span></span>:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">some</span></span></span><span class="calibre8"> pred coll)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">some</span></span> returns the first nonfalse value for its predicate or returns <span class="calibre8"><span class="calibre39">nil</span></span> if no element matched: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(some even? [1 2 3])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(some even? [1 3 5])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Notice that <span class="calibre8"><span class="calibre39">some</span></span> does not end with a question mark. <span class="calibre8"><span class="calibre39">some</span></span> is not a predicate, although it is often used like one. <span class="calibre8"><span class="calibre39">some</span></span> returns the <span class="italic">actual value</span> of the first match instead of <span class="calibre8"><span class="calibre39">true</span></span>. The distinction is invisible when you pair <span class="calibre8"><span class="calibre39">some</span></span> with <span class="calibre8"><span class="calibre39">even?</span></span>, since <span class="calibre8"><span class="calibre39">even?</span></span> is itself a predicate. To see a non-<span class="calibre8"><span class="calibre39">true</span></span> match, try using <span class="calibre8"><span class="calibre39">some</span></span> with <span class="calibre8"><span class="calibre39">identity</span></span> to find the first non-<span class="calibre8"><span class="calibre39">nil</span></span> value in a sequence: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(some identity [nil false 1 nil 2])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 1​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">The behavior of the other predicates is obvious from their names: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">not-every?</span></span></span><span class="calibre8"> pred coll)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">not-any?</span></span></span><span class="calibre8"> pred coll)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38">Not every whole number is even:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(not-every? even? (whole-numbers))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">But it would be a lie to claim that not any whole number is even:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(not-any? even? (whole-numbers))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; false​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Note that we picked questions to which we already knew the answer. In general, you have to be careful when applying predicates to infinite collections. They might run forever. </p><p id="filepos413679" class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Transforming Sequences</span></span></span></p><p class="calibre44"> Transformation functions transform the values in the sequence. The simplest transformation is <span class="calibre8"><span class="calibre39">map</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">map</span></span></span><span class="calibre8"> f coll)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">map</span></span> takes a source collection <span class="calibre8"><span class="calibre39">coll</span></span> and a function <span class="calibre8"><span class="calibre39">f</span></span>, and it returns a new sequence by invoking <span class="calibre8"><span class="calibre39">f</span></span> on each element in the <span class="calibre8"><span class="calibre39">coll</span></span>. You could use <span class="calibre8"><span class="calibre39">map</span></span> to wrap every element in a collection with an HTML tag. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(map #(format "&lt;p&gt;%s&lt;/p&gt;" %) ["the" "quick" "brown" "fox"])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ("&lt;p&gt;the&lt;/p&gt;" "&lt;p&gt;quick&lt;/p&gt;" "&lt;p&gt;brown&lt;/p&gt;" "&lt;p&gt;fox&lt;/p&gt;")​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">map</span></span> can also take more than one collection argument. <span class="calibre8"><span class="calibre39">f</span></span> must then be a function of multiple arguments. <span class="calibre8"><span class="calibre39">map</span></span> will call <span class="calibre8"><span class="calibre39">f</span></span> with one argument from each collection, stopping whenever the smallest collection is exhausted: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(map #(format "&lt;%s&gt;%s&lt;/%s&gt;" %1 %2 %1)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​["h1" "h2" "h3" "h1"] ["the" "quick" "brown" "fox"])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ("&lt;h1&gt;the&lt;/h1&gt;" "&lt;h2&gt;quick&lt;/h2&gt;" "&lt;h3&gt;brown&lt;/h3&gt;"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​"&lt;h1&gt;fox&lt;/h1&gt;")​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Another common transformation is <span class="calibre8"><span class="calibre39">reduce</span></span>:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">reduce</span></span></span><span class="calibre8"> f coll)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">f</span></span> is a function of two arguments. <span class="calibre8"><span class="calibre39">reduce</span></span> applies <span class="calibre8"><span class="calibre39">f</span></span> on the first two elements in <span class="calibre8"><span class="calibre39">coll</span></span> and then applies <span class="calibre8"><span class="calibre39">f</span></span> to the result and the third element, and so on. <span class="calibre8"><span class="calibre39">reduce</span></span> is useful for functions that “total up” a sequence in some way. You can use <span class="calibre8"><span class="calibre39">reduce</span></span> to add items: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(reduce + (range 1 11))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 55​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">or to multiply them:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(reduce * (range 1 11))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 3628800​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> You can sort a collection with <span class="calibre8"><span class="calibre39">sort</span></span> or <span class="calibre8"><span class="calibre39">sort-by</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">sort</span></span></span><span class="calibre8"> comp? coll)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">sort-by</span></span></span><span class="calibre8"> a-fn comp? coll)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">sort</span></span> sorts a collection by the natural order of its elements, where <span class="calibre8"><span class="calibre39">sort-by</span></span> sorts a sequence by the result of calling <span class="calibre8"><span class="calibre39">a-fn</span></span> on each element: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(sort [42 1 7 11])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (1 7 11 42)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(sort-by #(.toString %) [42 1 7 11])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (1 11 42 7)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If you do not want to sort by natural order, you can specify an optional comparison function <span class="calibre8"><span class="calibre39">comp</span></span> for either <span class="calibre8"><span class="calibre39">sort</span></span> or <span class="calibre8"><span class="calibre39">sort-by</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(sort &gt; [42 1 7 11])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (42 11 7 1)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(sort-by :grade &gt; [{:grade 83} {:grade 90} {:grade 77}])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ({:grade 90} {:grade 83} {:grade 77})​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The granddaddy of all filters and transformations is the <span class="italic">list comprehension</span>. A list comprehension creates a list based on an existing list, using set notation. In other words, a comprehension states the properties that the result list must satisfy. In general, a list comprehension will consist of the following: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">Input list(s)</p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Placeholder variables<a href="#filepos538697">[29]</a> for elements in the input lists </p></li><a id="filepos422537"></a><li value="3" class="calibre30"><p class="calibre29">Predicates on the elements</p></li><a></a><li value="4" class="calibre30"><p class="calibre29"> An output form that produces output from the elements of the input lists that satisfy the predicates </p></li><a></a></ul><p class="calibre12"> Of course, Clojure generalizes the notion of list comprehension to <span class="italic">sequence</span> comprehension. Clojure comprehensions use the <span class="calibre8"><span class="calibre39">for</span></span> macro.<a id="filepos423059"></a><a href="#filepos539133">[30]</a>
</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">for</span></span></span><span class="calibre8"> [binding-form coll-expr filter-expr? </span><span class="calibre8"><span class="bold"><span class="calibre36">..</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">] expr)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">for</span></span> takes a vector of <span class="calibre8"><span class="calibre39">binding-form</span></span>/<span class="calibre8"><span class="calibre39">coll-expr</span></span>s, plus an optional <span class="calibre8"><span class="calibre39">filter-expr</span></span>, and then yields a sequence of <span class="calibre8"><span class="calibre39">expr</span></span>s. </p><p class="calibre12"> List comprehension is more general than functions such as <span class="calibre8"><span class="calibre39">map</span></span> and <span class="calibre8"><span class="calibre39">filter</span></span> and can in fact emulate most of the filtering and transformation functions described earlier. </p><p class="calibre12"> You can rewrite the previous <span class="calibre8"><span class="calibre39">map</span></span> example as a list comprehension: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(for [word ["the" "quick" "brown" "fox"]]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (format "&lt;p&gt;%s&lt;/p&gt;" word))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ("&lt;p&gt;the&lt;/p&gt;" "&lt;p&gt;quick&lt;/p&gt;" "&lt;p&gt;brown&lt;/p&gt;" "&lt;p&gt;fox&lt;/p&gt;")​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> This reads almost like English: “For [each] word in [a sequence of words] format [according to format instructions].” </p><p class="calibre12"> Comprehensions can emulate <span class="calibre8"><span class="calibre39">filter</span></span> using a <span class="calibre8"><span class="calibre39">:when</span></span> clause. You can pass <span class="calibre8"><span class="calibre39">even?</span></span> to <span class="calibre8"><span class="calibre39">:when</span></span> to filter the even numbers: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(take 10 (for [n (whole-numbers) :when (even? n)] n))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (2 4 6 8 10 12 14 16 18 20)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> A <span class="calibre8"><span class="calibre39">:while</span></span> clause continues the evaluation only while its expression holds true: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(for [n (whole-numbers) :while (even? n)] n)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ()​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The real power of <span class="calibre8"><span class="calibre39">for</span></span> comes when you work with more than one binding expression. For example, you can express all possible positions on a chessboard in algebraic notation by binding both <span class="calibre8"><span class="calibre39">rank</span></span> and <span class="calibre8"><span class="calibre39">file</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(for [file "ABCDEFGH" rank (range 1 9)] (format "%c%d" file rank))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ("A1" "A2" ... elided ... "H7 ""H8")​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Clojure iterates over the rightmost binding expression in a sequence comprehension first and then works its way left. Because <span class="calibre8"><span class="calibre39">rank</span></span> is listed to the right of <span class="calibre8"><span class="calibre39">file</span></span> in the binding form, <span class="calibre8"><span class="calibre39">rank</span></span> iterates faster. If you want files to iterate faster, you can reverse the binding order and list <span class="calibre8"><span class="calibre39">rank</span></span> first: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(for [rank (range 1 9) file "ABCDEFGH"] (format "%c%d" file rank))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ("A1" "B1" ... elided ... "G8" "H8")​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> In many languages, transformations, filters, and comprehensions do their work immediately. Do not assume this in Clojure. Most sequence functions do not traverse elements until you actually try to use them. </p><div class="mbppagebreak"></div><p id="filepos428764" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">3.3 Lazy and Infinite Sequences</span></span></span></p><p class="calibre34"> Most Clojure sequences are <span class="italic">lazy</span>; in other words, elements are not calculated until they are needed. Using lazy sequences has many benefits: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">You can postpone expensive computations that may not in fact be needed.</p></li><a></a><li value="2" class="calibre30"><p class="calibre29">You can work with huge data sets that do not fit into memory.</p></li><a></a><li value="3" class="calibre30"><p class="calibre29">You can delay I/O until it is absolutely needed.</p></li><a></a></ul><p class="calibre12">Consider the code and following expression:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/primes.clj"><span class="calibre41"><span class="underline">src/examples/primes.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">ns</span></span></span><span class="calibre8"> examples.primes)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">;; Taken from clojure.contrib.lazy-seqs</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; primes cannot be written efficiently as a function, because</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; it needs to look back on the whole sequence. contrast with</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; fibs and powers-of-2 which only need a fixed buffer of 1 or 2</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; previous values.</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> primes​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">concat</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   [2 3 5 7]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   (</span><span class="calibre8"><span class="bold"><span class="calibre36">lazy-seq</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [primes-from​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          (</span><span class="calibre8"><span class="bold"><span class="calibre36">fn</span></span></span><span class="calibre8"> primes-from [n [f &amp; r]]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">some</span></span></span><span class="calibre8"> #(</span><span class="calibre8"><span class="bold"><span class="calibre36">zero?</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">rem</span></span></span><span class="calibre8"> n %))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                      (</span><span class="calibre8"><span class="bold"><span class="calibre36">take-while</span></span></span><span class="calibre8"> #(</span><span class="calibre8"><span class="bold"><span class="calibre36">&lt;</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">*</span></span></span><span class="calibre8"> % %) n) primes))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​              (</span><span class="calibre8"><span class="bold"><span class="calibre36">recur</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">+</span></span></span><span class="calibre8"> n f) r)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​              (</span><span class="calibre8"><span class="bold"><span class="calibre36">lazy-seq</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">cons</span></span></span><span class="calibre8"> n (primes-from (</span><span class="calibre8"><span class="bold"><span class="calibre36">+</span></span></span><span class="calibre8"> n f) r)))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          wheel (</span><span class="calibre8"><span class="bold"><span class="calibre36">cycle</span></span></span><span class="calibre8"> [2 4 2 4 6 2 6 4 2 4 6 6 2 6  4  2​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                        6 4 6 8 4 2 4 2 4 8 6 4 6 2  4  6​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                        2 6 6 4 2 4 6 2 6 4 2 4 2 10 2 10])]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (primes-from 11 wheel)))))​</span><span class="calibre8">
</span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(use 'examples.primes)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def ordinals-and-primes (map vector (iterate inc 1) primes))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/ordinals-and-primes​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">ordinals-and-primes</span></span> includes pairs like <span class="calibre8"><span class="calibre39">[5, 11]</span></span> (eleven is the fifth prime number). Both ordinals and primes are infinite, but <span class="calibre8"><span class="calibre39">ordinals-and-primes</span></span> fits into memory just fine, because it is lazy. Just <span class="calibre8"><span class="calibre39">take</span></span> what you need from it: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(take 5 (drop 1000 ordinals-and-primes))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ([1001 7927] [1002 7933] [1003 7937] [1004 7949] [1005 7951])​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> When should you prefer lazy sequences? Most of the time. Most sequence functions return lazy sequences, so you pay only for what you use. More important, lazy sequences do not require any special effort on your part. In the previous example, <span class="calibre8"><span class="calibre39">iterate</span></span>, <span class="calibre8"><span class="calibre39">primes</span></span>, and <span class="calibre8"><span class="calibre39">map</span></span> return lazy sequences, so <span class="calibre8"><span class="calibre39">ordinals-and-primes</span></span> gets laziness “for free.” </p><p class="calibre12"> Lazy sequences are critical to functional programming in Clojure. Section 4.2, <a href="#filepos555532">​<span class="italic">How to Be Lazy</span>​</a> explores creating and using lazy sequences in much greater detail. </p><p id="filepos438471" class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Forcing Sequences</span></span></span></p><p class="calibre44"> When you are viewing a large sequence from the REPL, you may want to use <span class="calibre8"><span class="calibre39">take</span></span> to prevent the REPL from evaluating the entire sequence. In other contexts, you may have the opposite problem. You have created a lazy sequence, and you want to force the sequence to evaluate fully. The problem usually arises when the code generating the sequence has side effects. Consider the following sequence, which embeds side effects via <span class="calibre8"><span class="calibre39">println</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def x (for [i (range 1 3)] (do (println i) i)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/x​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Newcomers to Clojure are surprised that the previous code prints nothing. Since the definition of <span class="calibre8"><span class="calibre39">x</span></span> does not actually use the elements, Clojure does not evaluate the comprehension to get them. You can force evaluation with <span class="calibre8"><span class="calibre39">doall</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">doall</span></span></span><span class="calibre8"> coll)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">doall</span></span> forces Clojure to walk the elements of a sequence and returns the elements as a result: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(doall x)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| 1​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| 2​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (1 2)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> You can also use <span class="calibre8"><span class="calibre39">dorun</span></span>:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">dorun</span></span></span><span class="calibre8"> coll)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">dorun</span></span> walks the elements of a sequence without keeping past elements in memory. As a result, <span class="calibre8"><span class="calibre39">dorun</span></span> can walk collections too large to fit in memory. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def x (for [i (range 1 3)] (do (println i) i)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/x​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(dorun x)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| 1​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| 2​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">nil</span></span> return value is a telltale reminder that <span class="calibre8"><span class="calibre39">dorun</span></span> does not hold a reference to the entire sequence. The <span class="calibre8"><span class="calibre39">dorun</span></span> and <span class="calibre8"><span class="calibre39">doall</span></span> functions help you deal with side effects, while most of the rest of Clojure discourages side effects. You should use these functions rarely. </p><div class="mbppagebreak"></div><p id="filepos443494" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">3.4 Clojure Makes Java Seq-able</span></span></span></p><p class="calibre34"> The seq abstraction of <span class="calibre8"><span class="calibre39">first</span></span>/<span class="calibre8"><span class="calibre39">rest</span></span> applies to anything that there can be more than one of. In the Java world, that includes the following: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">The Collections API</p></li><a></a><li value="2" class="calibre30"><p class="calibre29">Regular expressions</p></li><a></a><li value="3" class="calibre30"><p class="calibre29">File system traversal</p></li><a></a><li value="4" class="calibre30"><p class="calibre29">XML processing</p></li><a></a><li value="5" class="calibre30"><p class="calibre29">Relational database results</p></li><a></a></ul><p class="calibre12"> Clojure wraps these Java APIs, making the sequence library available for almost everything you do. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Seq-ing Java Collections</span></span></span></p><p class="calibre44"> If you try to apply the sequence functions to Java collections, you will find that they behave as sequences. Collections that can act as sequences are called <span class="italic">seq-able</span>. For example, arrays are seq-able: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​; String.getBytes returns a byte array​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(first (.getBytes "hello"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 104​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(rest (.getBytes "hello"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (101 108 108 111)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(cons (int \h) (.getBytes "ello"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (104 101 108 108 111)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">Hashtable</span></span>s and <span class="calibre8"><span class="calibre39">Map</span></span>s are also seq-able: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​; System.getProperties returns a Hashtable​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(first (System/getProperties))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #&lt;Entry java.runtime.name=Java(TM) SE Runtime Environment&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(rest (System/getProperties))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (#&lt;Entry sun.boot.library.path=/System/Library/... etc. ...​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Remember that the sequence wrappers are immutable, even when the underlying Java collection is mutable. So, you cannot update the system properties by <span class="calibre8"><span class="calibre39">cons</span></span>ing a new item onto <span class="calibre8"><span class="calibre39">(System/getProperties)</span></span>. <span class="calibre8"><span class="calibre39">cons</span></span> will return a new sequence; the existing properties are unchanged. </p><p class="calibre12"> Since strings are sequences of characters, they also are seq-able:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(first "Hello")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; \H​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(rest "Hello")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (\e \l \l \o)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(cons \H "ello")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (\H \e \l \l \o)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Clojure will automatically wrap collections in sequences, but it will not automatically rewrap them back to their original type. With most collection types this behavior is intuitive, but with strings you will often want to convert the result to a string. Consider reversing a string. Clojure provides <span class="calibre8"><span class="calibre39">reverse</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​; probably not what you want​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(reverse "hello")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (\o \l \l \e \h)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> To convert a sequence back to a string, use <span class="calibre8"><span class="calibre39">(apply str seq)</span></span>:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(apply str (reverse "hello"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "olleh"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The Java collections are seq-able, but for most scenarios they do not offer advantages over Clojure’s built-in collections. Prefer the Java collections only in interop scenarios where you are working with legacy Java APIs. </p><p id="filepos451526" class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Seq-ing Regular Expressions</span></span></span></p><p class="calibre44"> Clojure’s regular expressions use the <span class="calibre8"><span class="calibre39">java.util.regex</span></span> library under the hood. At the lowest level, this exposes the mutable nature of Java’s <span class="calibre8"><span class="calibre39">Matcher</span></span>. You can use <span class="calibre8"><span class="calibre39">re-matcher</span></span> to create a <span class="calibre8"><span class="calibre39">Matcher</span></span> for a regular expression and a string and then <span class="calibre8"><span class="calibre39">loop</span></span> on <span class="calibre8"><span class="calibre39">re-find</span></span> to iterate over the matches. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">re-matcher</span></span></span><span class="calibre8"> regexp string)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/sequences.clj"><span class="calibre41"><span class="underline">src/examples/sequences.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; don't do this!</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [m (</span><span class="calibre8"><span class="bold"><span class="calibre36">re-matcher</span></span></span><span class="calibre8"> #"\w+" </span><span class="calibre8"><span class="italic"><span class="calibre42">"the quick brown fox"</span></span></span><span class="calibre8">)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">loop</span></span></span><span class="calibre8"> [match (</span><span class="calibre8"><span class="bold"><span class="calibre36">re-find</span></span></span><span class="calibre8"> m)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">when</span></span></span><span class="calibre8"> match​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">println</span></span></span><span class="calibre8"> match)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">recur</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">re-find</span></span></span><span class="calibre8"> m)))))​</span><span class="calibre8">
</span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| the​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| quick​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| brown​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| fox​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Much better is to use the higher-level <span class="calibre8"><span class="calibre39">re-seq</span></span>.</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">re-seq</span></span></span><span class="calibre8"> regexp string)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">re-seq</span></span> exposes an immutable seq over the matches. This gives you the power of all of Clojure’s sequence functions. Try these expressions at the REPL: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(re-seq #"\w+" "the quick brown fox")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ("the" "quick" "brown" "fox")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(sort (re-seq #"\w+" "the quick brown fox"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ("brown" "fox" "quick" "the")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(drop 2 (re-seq #"\w+" "the quick brown fox"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ("brown" "fox")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(map #(.toUpperCase %) (re-seq #"\w+" "the quick brown fox"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ("THE" "QUICK" "BROWN" "FOX")​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">re-seq</span></span> is a great example of how good abstractions reduce code bloat. Regular expression matches are not a special kind of thing, requiring special methods to deal with them. They are sequences, just like everything else. Thanks to the large number of sequence functions, you get more functionality <span class="italic">for free</span> than you would likely end up with after a misguided foray into writing regexp-specific functions. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Seq-ing the File System</span></span></span></p><p class="calibre44"> You can seq over the file system. For starters, you can call <span class="calibre8"><span class="calibre39">java.io.File</span></span> directly: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(import '(java.io File))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(.listFiles (File. "."))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; [Ljava.io.File;@1f70f15e​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">[Ljava.io.File...</span></span> is Java’s <span class="calibre8"><span class="calibre39">toString</span></span> representation for an array of <span class="calibre8"><span class="calibre39">File</span></span>s. Sequence functions would call <span class="calibre8"><span class="calibre39">seq</span></span> on this automatically, but the REPL doesn’t. </p><p class="calibre12">So, <span class="calibre8"><span class="calibre39">seq</span></span> it yourself:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(seq (.listFiles (File. ".")) )​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (#&lt;./concurrency&gt; #&lt;./sequences&gt; ...)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If the default print format for files does not suit you, you could <span class="calibre8"><span class="calibre39">map</span></span> them to a string form with <span class="calibre8"><span class="calibre39">getName</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​; overkill​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(map #(.getName %) (seq (.listFiles (File. "."))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ("concurrency" "sequences" ...)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Once you decide to use a function like <span class="calibre8"><span class="calibre39">map</span></span>, calling <span class="calibre8"><span class="calibre39">seq</span></span> is redundant. Sequence library functions call <span class="calibre8"><span class="calibre39">seq</span></span> for you, so you don’t have to. The previous code simplifies to this: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(map #(.getName %) (.listFiles (File. ".")))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ("concurrency" "sequences" ...)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Often, you want to recursively traverse the entire directory tree. Clojure provides a depth-first walk via <span class="calibre8"><span class="calibre39">file-seq</span></span>. If you <span class="calibre8"><span class="calibre39">file-seq</span></span> from the sample code directory for this book, you will see a lot of files: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(count (file-seq (File. ".")))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 104 ; the final number will be larger!​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> What if you want to see only the files that have been changed recently? Write a predicate <span class="calibre8"><span class="calibre39">recently-modified?</span></span> that checks to see whether <span class="calibre8"><span class="calibre39">File</span></span> was touched in the last half hour: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/sequences.clj"><span class="calibre41"><span class="underline">src/examples/sequences.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> minutes-to-millis [mins] (</span><span class="calibre8"><span class="bold"><span class="calibre36">*</span></span></span><span class="calibre8"> mins 1000 60))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> recently-modified? [file]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">&gt;</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">lastModified file)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     (</span><span class="calibre8"><span class="bold"><span class="calibre36">-</span></span></span><span class="calibre8"> (System/currentTimeMillis) (minutes-to-millis 30))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Give it a try: <a id="filepos465188"></a><a href="#filepos539381">[31]</a>
</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(filter recently-modified? (file-seq (File. ".")))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (./sequences ./sequences/sequences.clj)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Seq-ing a Stream</span></span></span></p><p class="calibre44"> You can <span class="calibre8"><span class="calibre39">seq</span></span> over the lines of any Java <span class="calibre8"><span class="calibre39">Reader</span></span> using <span class="calibre8"><span class="calibre39">line-seq</span></span>. To get a <span class="calibre8"><span class="calibre39">Reader</span></span>, you can use Clojure’s <span class="calibre8"><span class="calibre39">clojure.java.io</span></span> library. The <span class="calibre8"><span class="calibre39">clojure.java.io</span></span> library provides a <span class="calibre8"><span class="calibre39">reader</span></span> function that returns a reader on a stream, file, URL, or URI. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(use '[clojure.java.io :only (reader)])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​; leaves reader open...​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(take 2 (line-seq (reader "src/examples/utils.clj")))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ("(ns examples.utils" "  (:import [java.io BufferedReader InputStreamReader]))")​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Since readers can represent nonmemory resources that need to be closed, you should wrap reader creation in a <span class="calibre8"><span class="calibre39">with-open</span></span>. Create an expression that uses the sequence function <span class="calibre8"><span class="calibre39">count</span></span> to count the number of lines in a file and uses <span class="calibre8"><span class="calibre39">with-open</span></span> to correctly close the reader: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(with-open [rdr (reader "src/examples/utils.clj")]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (count (line-seq rdr)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 64​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">To make the example more useful, add a filter to count only nonblank lines:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(with-open [rdr (reader "src/examples/utils.clj")]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (count (filter #(re-find #"\S" %) (line-seq rdr))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 55​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Using seqs both on the file system and on the contents of individual files, you can quickly create interesting utilities. Create a program that defines these three predicates: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"><span class="calibre8"><span class="calibre39">non-blank?</span></span> detects nonblank lines.</p></li><a></a><li value="2" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">non-svn?</span></span> detects files that are not Subversion metadata.</p></li><a></a><li value="3" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">clojure-source?</span></span> detects Clojure source code files.</p></li><a></a></ul><p class="calibre12"> Then, create a <span class="calibre8"><span class="calibre39">clojure-loc</span></span> function that counts the lines of Clojure code in a directory tree, using a combination of sequence functions along the way: <span class="calibre8"><span class="calibre39">reduce</span></span>, <span class="calibre8"><span class="calibre39">for</span></span>, <span class="calibre8"><span class="calibre39">count</span></span>, and <span class="calibre8"><span class="calibre39">filter</span></span>. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/sequences.clj"><span class="calibre41"><span class="underline">src/examples/sequences.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">use</span></span></span><span class="calibre8"> '[clojure.java.io :only (reader)])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> non-blank? [line] (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">re-find</span></span></span><span class="calibre8"> #"\S" line) true false))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> non-svn? [file] (</span><span class="calibre8"><span class="bold"><span class="calibre36">not</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">contains (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">toString file) </span><span class="calibre8"><span class="italic"><span class="calibre42">".svn"</span></span></span><span class="calibre8">)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> clojure-source? [file] (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">endsWith (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">toString file) </span><span class="calibre8"><span class="italic"><span class="calibre42">".clj"</span></span></span><span class="calibre8">))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> clojure-loc [base-file]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">reduce</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   </span><span class="calibre8"><span class="bold"><span class="calibre36">+</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   (</span><span class="calibre8"><span class="bold"><span class="calibre36">for</span></span></span><span class="calibre8"> [file (</span><span class="calibre8"><span class="bold"><span class="calibre36">file-seq</span></span></span><span class="calibre8"> base-file)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​         :when (</span><span class="calibre8"><span class="bold"><span class="calibre36">and</span></span></span><span class="calibre8"> (clojure-source? file) (non-svn? file))]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     (</span><span class="calibre8"><span class="bold"><span class="calibre36">with-open</span></span></span><span class="calibre8"> [rdr (reader file)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​       (</span><span class="calibre8"><span class="bold"><span class="calibre36">count</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">filter</span></span></span><span class="calibre8"> non-blank? (</span><span class="calibre8"><span class="bold"><span class="calibre36">line-seq</span></span></span><span class="calibre8"> rdr)))))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now let’s use <span class="calibre8"><span class="calibre39">clojure-loc</span></span> to find out how much Clojure code is in Clojure itself: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(clojure-loc (java.io.File. "/home/abedra/src/opensource/clojure/clojure"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 38716​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">clojure-loc</span></span> function is very task-specific, but because it is built out of sequence functions and simple predicates, you can easily tweak it to very different tasks. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Seq-ing XML</span></span></span></p><p class="calibre44"> Clojure can <span class="calibre8"><span class="calibre39">seq</span></span> over XML data. The examples that follow use this XML: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/data/sequences/compositions.xml"><span class="calibre41"><span class="underline">data/sequences/compositions.xml</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="bold"><span class="calibre36">&lt;compositions&gt;</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="bold"><span class="calibre36">&lt;composition</span></span></span><span class="calibre8"> composer=</span><span class="calibre8"><span class="italic"><span class="calibre42">"J. S. Bach"</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">&gt;</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    </span><span class="calibre8"><span class="bold"><span class="calibre36">&lt;name&gt;</span></span></span><span class="calibre8">The Art of the Fugue</span><span class="calibre8"><span class="bold"><span class="calibre36">&lt;/name&gt;</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="bold"><span class="calibre36">&lt;/composition&gt;</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="bold"><span class="calibre36">&lt;composition</span></span></span><span class="calibre8"> composer=</span><span class="calibre8"><span class="italic"><span class="calibre42">"F. Chopin"</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">&gt;</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    </span><span class="calibre8"><span class="bold"><span class="calibre36">&lt;name&gt;</span></span></span><span class="calibre8">Fantaisie-Impromptu Op. 66</span><span class="calibre8"><span class="bold"><span class="calibre36">&lt;/name&gt;</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="bold"><span class="calibre36">&lt;/composition&gt;</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="bold"><span class="calibre36">&lt;composition</span></span></span><span class="calibre8"> composer=</span><span class="calibre8"><span class="italic"><span class="calibre42">"W. A. Mozart"</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">&gt;</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    </span><span class="calibre8"><span class="bold"><span class="calibre36">&lt;name&gt;</span></span></span><span class="calibre8">Requiem</span><span class="calibre8"><span class="bold"><span class="calibre36">&lt;/name&gt;</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="bold"><span class="calibre36">&lt;/composition&gt;</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="bold"><span class="calibre36">&lt;/compositions&gt;</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The function <span class="calibre8"><span class="calibre39">clojure.xml/parse</span></span> parses an XML file/stream/URI, returning the tree of data as a Clojure map, with nested vectors for descendants: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(use '[clojure.xml :only (parse)])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(parse (java.io.File. "data/sequences/compositions.xml"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:tag :compositions,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​:attrs nil,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​:content [{:tag :composition, ... etc. ...​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> You can manipulate this map directly, or you can use the <span class="calibre8"><span class="calibre39">xml-seq</span></span> function to view the tree as a seq: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">xml-seq</span></span></span><span class="calibre8"> root)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> The following example uses a list comprehension over an <span class="calibre8"><span class="calibre39">xml-seq</span></span> to extract just the composers: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/sequences.clj"><span class="calibre41"><span class="underline">src/examples/sequences.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">for</span></span></span><span class="calibre8"> [x (</span><span class="calibre8"><span class="bold"><span class="calibre36">xml-seq</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​         (parse (java.io.File. </span><span class="calibre8"><span class="italic"><span class="calibre42">"data/sequences/compositions.xml"</span></span></span><span class="calibre8">)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      :when (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> :composition (:tag x))]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:composer (:attrs x)))​</span><span class="calibre8">
</span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ("J. S. Bach" "F. Chopin" "W. A. Mozart")​</span><span class="calibre8">
</span>
</td></tr></table><div class="mbppagebreak"></div><p id="filepos484006" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">3.5 Calling Structure-Specific Functions</span></span></span></p><p class="calibre34"> Clojure’s sequence functions allow you to write very general code. Sometimes you will want to be more specific and take advantage of the characteristics of a specific data structure. Clojure includes functions that specifically target lists, vectors, maps, structs, and sets. </p><p class="calibre12"> We will take a quick tour of some of these structure-specific functions next. For a complete list of structure-specific functions in Clojure, see the Data Structures section of the Clojure website.<a id="filepos484684"></a><a href="#filepos539698">[32]</a>
</p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Functions on Lists</span></span></span></p><p class="calibre44"> Clojure supports the traditional names <span class="calibre8"><span class="calibre39">peek</span></span> and <span class="calibre8"><span class="calibre39">pop</span></span> for retrieving the first element of a list and the remainder, respectively: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">peek</span></span></span><span class="calibre8"> coll)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">pop</span></span></span><span class="calibre8"> coll)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Give a simple list a <span class="calibre8"><span class="calibre39">peek</span></span> and <span class="calibre8"><span class="calibre39">pop</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(peek '(1 2 3))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 1​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(pop '(1 2 3))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (2 3)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">peek</span></span> is the same as <span class="calibre8"><span class="calibre39">first</span></span>, but <span class="calibre8"><span class="calibre39">pop</span></span> is <span class="italic">not</span> the same as <span class="calibre8"><span class="calibre39">rest</span></span>. <span class="calibre8"><span class="calibre39">pop</span></span> will throw an exception if the sequence is empty: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(rest ())​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ()​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(pop ())​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.lang.IllegalStateException: Can't pop empty list​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Functions on Vectors</span></span></span></p><p class="calibre44"> Vectors also support <span class="calibre8"><span class="calibre39">peek</span></span> and <span class="calibre8"><span class="calibre39">pop</span></span>, but they deal with the element at the end of the vector: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(peek [1 2 3])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 3​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(pop [1 2 3])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; [1 2]​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">get</span></span> returns the value at an index or returns <span class="calibre8"><span class="calibre39">nil</span></span> if the index is outside the vector: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(get [:a :b :c] 1)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; :b​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(get [:a :b :c] 5)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Vectors are themselves functions. They take an index argument and return a value, or they throw an exception if the index is out of bounds: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​([:a :b :c] 1)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; :b​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​([:a :b :c] 5)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.lang.ArrayIndexOutOfBoundsException: 5​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">assoc</span></span> associates a new value with a particular index: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(assoc [0 1 2 3 4] 2 :two)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; [0 1 :two 3 4]​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">subvec</span></span> returns a subvector of a vector: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">subvec</span></span></span><span class="calibre8"> avec start end?)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> If <span class="calibre8"><span class="calibre39">end</span></span> is not specified, it defaults to the end of the vector: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(subvec [1 2 3 4 5] 3)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; [4 5]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(subvec [1 2 3 4 5] 1 3)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; [2 3]​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Of course, you could simulate <span class="calibre8"><span class="calibre39">subvec</span></span> with a combination of <span class="calibre8"><span class="calibre39">drop</span></span> and <span class="calibre8"><span class="calibre39">take</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(take 2 (drop 1 [1 2 3 4 5]))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (2 3)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The difference is that <span class="calibre8"><span class="calibre39">take</span></span> and <span class="calibre8"><span class="calibre39">drop</span></span> are general and can work with any sequence. On the other hand, <span class="calibre8"><span class="calibre39">subvec</span></span> is <span class="italic">much</span> faster for vectors. Whenever a structure-specific function like <span class="calibre8"><span class="calibre39">subvec</span></span> duplicates functionality already available in the sequence library, it is probably there for performance. The documentation string for functions like <span class="calibre8"><span class="calibre39">subvec</span></span> includes performance characteristics. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Functions on Maps</span></span></span></p><p class="calibre44"> Clojure provides several functions for reading the keys and values in a map. <span class="calibre8"><span class="calibre39">keys</span></span> returns a sequence of the keys, and <span class="calibre8"><span class="calibre39">vals</span></span> returns a sequence of the values: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">keys</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">map</span></span></span><span class="calibre8">)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">vals</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">map</span></span></span><span class="calibre8">)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Try taking <span class="calibre8"><span class="calibre39">keys</span></span> and <span class="calibre8"><span class="calibre39">values</span></span> from a simple map: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(keys {:sundance "spaniel", :darwin "beagle"})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (:sundance :darwin)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(vals {:sundance "spaniel", :darwin "beagle"})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ("spaniel" "beagle")​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">get</span></span> returns the value for a key or returns <span class="calibre8"><span class="calibre39">nil</span></span>. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">get</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">map</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">key</span></span></span><span class="calibre8"> value-if-not-found?)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Use your REPL to test that <span class="calibre8"><span class="calibre39">get</span></span> behaves as expected for keys both present and missing: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(get {:sundance "spaniel", :darwin "beagle"} :darwin)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "beagle"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(get {:sundance "spaniel", :darwin "beagle"} :snoopy)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> There is an approach even simpler than <span class="calibre8"><span class="calibre39">get</span></span>. Maps are functions of their keys. So, you can leave out the <span class="calibre8"><span class="calibre39">get</span></span> entirely, putting the map in function position at the beginning of a form: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​({:sundance "spaniel", :darwin "beagle"} :darwin)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "beagle"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​({:sundance "spaniel", :darwin "beagle"} :snoopy)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Keywords are also functions. They take a collection as an argument and look themselves up in the collection. Since <span class="calibre8"><span class="calibre39">:darwin</span></span> and <span class="calibre8"><span class="calibre39">:sundance</span></span> are keywords, the earlier forms can be written with their elements in reverse order. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(:darwin {:sundance "spaniel", :darwin "beagle"} )​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "beagle"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(:snoopy {:sundance "spaniel", :darwin "beagle"} )​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If you look up a key in a map and get <span class="calibre8"><span class="calibre39">nil</span></span> back, you cannot tell whether the key was missing from the map or present with a value of <span class="calibre8"><span class="calibre39">nil</span></span>. The <span class="calibre8"><span class="calibre39">contains?</span></span> function solves this problem by testing for the mere presence of a key. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">contains?</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">map</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">key</span></span></span><span class="calibre8">)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38">Create a map where <span class="calibre8"><span class="calibre39">nil</span></span> is a legal value:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def score {:stu nil :joey 100})​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">:stu</span></span> is present, but if you see the <span class="calibre8"><span class="calibre39">nil</span></span> value, you might not think so: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(:stu score)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If you use <span class="calibre8"><span class="calibre39">contains?</span></span>, you can verify that <span class="calibre8"><span class="calibre39">:stu</span></span> is in the game, although presumably not doing very well: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(contains? score :stu)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Another approach is to call <span class="calibre8"><span class="calibre39">get</span></span>, passing in an optional third argument that will be returned if the key is not found: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(get score :stu :score-not-found)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(get score :aaron :score-not-found)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; :score-not-found​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The default return value of <span class="calibre8"><span class="calibre39">:score-not-found</span></span> makes it possible to distinguish that <span class="calibre8"><span class="calibre39">:aaron</span></span> is not in the map, while <span class="calibre8"><span class="calibre39">:stu</span></span> is present with a value of <span class="calibre8"><span class="calibre39">nil</span></span>. </p><p class="calibre12"> If <span class="calibre8"><span class="calibre39">nil</span></span> is a legal value in map, use <span class="calibre8"><span class="calibre39">contains?</span></span> or the three-argument form of <span class="calibre8"><span class="calibre39">get</span></span> to test the presence of a key. </p><p class="calibre12"> Clojure also provides several functions for building new maps:</p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"><span class="calibre8"><span class="calibre39">assoc</span></span> returns a map with a key/value pair added. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">dissoc</span></span> returns a map with a key removed. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">select-keys</span></span> returns a map, keeping only the keys passed in. </p></li><a></a><li value="4" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">merge</span></span> combines maps. If multiple maps contain a key, the rightmost map wins. </p></li><a></a></ul><p class="calibre12"> To test these functions, create some song data:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/sequences.clj"><span class="calibre41"><span class="underline">src/examples/sequences.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> song {:name </span><span class="calibre8"><span class="italic"><span class="calibre42">"Agnus Dei"</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​           :artist </span><span class="calibre8"><span class="italic"><span class="calibre42">"Krzysztof Penderecki"</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​           :album </span><span class="calibre8"><span class="italic"><span class="calibre42">"Polish Requiem"</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​           :genre </span><span class="calibre8"><span class="italic"><span class="calibre42">"Classical"</span></span></span><span class="calibre8">})​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Next, create various modified versions of the song collection:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(assoc song :kind "MPEG Audio File")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:name "Agnus Dei", :album "Polish Requiem",​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​:kind "MPEG Audio File", :genre "Classical",​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​:artist "Krzysztof Penderecki"}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(dissoc song :genre)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:name "Agnus Dei", :album "Polish Requiem",​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​:artist "Krzysztof Penderecki"}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(select-keys song [:name :artist])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:name "Agnus Dei", :artist "Krzysztof Penderecki"}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(merge song {:size 8118166, :time 507245})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:name "Agnus Dei", :album "Polish Requiem",​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​:genre "Classical", :size 8118166,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​:artist "Krzysztof Penderecki", :time 507245}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Remember that <span class="calibre8"><span class="calibre39">song</span></span> itself never changes. Each of the functions shown previously returns a new collection. </p><p class="calibre12"> The most interesting map construction function is <span class="calibre8"><span class="calibre39">merge-with</span></span>. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">merge-with</span></span></span><span class="calibre8"> merge-fn &amp; maps)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">merge-with</span></span> is like <span class="calibre8"><span class="calibre39">merge</span></span>, except that when two or more maps have the same key, you can specify your own function for combining the values under the key. Use <span class="calibre8"><span class="calibre39">merge-with</span></span> and <span class="calibre8"><span class="calibre39">concat</span></span> to build a sequence of values under each key: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(merge-with​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  concat​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  {:rubble ["Barney"], :flintstone ["Fred"]}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  {:rubble ["Betty"], :flintstone ["Wilma"]}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  {:rubble ["Bam-Bam"], :flintstone ["Pebbles"]})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  -&gt; {:rubble ("Barney" "Betty" "Bam-Bam"),​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      :flintstone ("Fred" "Wilma" "Pebbles")}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Starting with three distinct collections of family members keyed by last name, the previous code combines them into one collection keyed by last name. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Functions on Sets</span></span></span></p><p class="calibre44"> In addition to the set functions in the <span class="calibre8"><span class="calibre39">clojure</span></span> namespace, Clojure provides a group of functions in the <span class="calibre8"><span class="calibre39">clojure.set</span></span> namespace. To use these functions with unqualified names, call <span class="calibre8"><span class="calibre39">(use ’clojure.set)</span></span> from the REPL. For the following examples, you will also need the following vars: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/sequences.clj"><span class="calibre41"><span class="underline">src/examples/sequences.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> languages #{</span><span class="calibre8"><span class="italic"><span class="calibre42">"java"</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"c"</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"d"</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"clojure"</span></span></span><span class="calibre8">})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> beverages #{</span><span class="calibre8"><span class="italic"><span class="calibre42">"java"</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"chai"</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"pop"</span></span></span><span class="calibre8">})​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The first group of <span class="calibre8"><span class="calibre39">clojure.set</span></span> functions performs operations from set theory: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"><span class="calibre8"><span class="calibre39">union</span></span> returns the set of all elements present in either input set. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">intersection</span></span> returns the set of all elements present in <span class="italic">both</span> input sets. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">difference</span></span> returns the set of all elements present in the first input set, minus those in the second. </p></li><a></a><li value="4" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">select</span></span> returns the set of all elements matching a predicate. </p></li><a></a></ul><p class="calibre12">Write an expression that finds the union of all languages and beverages:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(union languages beverages)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #{"java" "c" "d" "clojure" "chai" "pop"}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Next, try the languages that are not also beverages:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(difference languages beverages)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #{"c" "d" "clojure"}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If you enjoy terrible puns, you will like the fact that some things are both languages <span class="italic">and</span> beverages: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(intersection languages beverages)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #{"java"}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> A surprising number of languages cannot afford a name larger than a single character: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(select #(= 1 (.length %)) languages)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #{"c" "d"}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Set union and difference are part of set theory, but they are also part of <span class="italic">relational algebra</span>, which is the basis for query languages such as SQL. The relational algebra consists of six primitive operators: set union and set difference (described earlier), plus rename, selection, projection, and cross product. </p><p class="calibre12"> You can understand the relational primitives by following the analogy with relational databases (see the following table). </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><th valign="top" class="calibre51"><span class="bold">   </span><p class="calibre59"><span class="bold">Relational Algebra  </span></p></th><th valign="top" class="calibre51"><span class="bold">   </span><p class="calibre59"><span class="bold">Database  </span></p></th><th valign="top" class="calibre51"><span class="bold">   </span><p class="calibre59"><span class="bold">Clojure Type System  </span></p></th></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">Relation  </p></td><td valign="top" class="calibre23">   <p class="calibre59">Table  </p></td><td valign="top" class="calibre23">   <p class="calibre59">Anything   <span class="calibre8"><span class="calibre39">set</span></span>-like</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">Tuple  </p></td><td valign="top" class="calibre23">   <p class="calibre59">Row  </p></td><td valign="top" class="calibre23">   <p class="calibre59">Anything   <span class="calibre8"><span class="calibre39">map</span></span>-like</p></td></tr></table><p class="calibre27"> The following examples work against an in-memory database of musical compositions. Load the database before continuing: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/sequences.clj"><span class="calibre41"><span class="underline">src/examples/sequences.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> compositions​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  #{{:name </span><span class="calibre8"><span class="italic"><span class="calibre42">"The Art of the Fugue"</span></span></span><span class="calibre8"> :composer </span><span class="calibre8"><span class="italic"><span class="calibre42">"J. S. Bach"</span></span></span><span class="calibre8">}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    {:name </span><span class="calibre8"><span class="italic"><span class="calibre42">"Musical Offering"</span></span></span><span class="calibre8"> :composer </span><span class="calibre8"><span class="italic"><span class="calibre42">"J. S. Bach"</span></span></span><span class="calibre8">}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    {:name </span><span class="calibre8"><span class="italic"><span class="calibre42">"Requiem"</span></span></span><span class="calibre8"> :composer </span><span class="calibre8"><span class="italic"><span class="calibre42">"Giuseppe Verdi"</span></span></span><span class="calibre8">}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    {:name </span><span class="calibre8"><span class="italic"><span class="calibre42">"Requiem"</span></span></span><span class="calibre8"> :composer </span><span class="calibre8"><span class="italic"><span class="calibre42">"W. A. Mozart"</span></span></span><span class="calibre8">}})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> composers​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  #{{:composer </span><span class="calibre8"><span class="italic"><span class="calibre42">"J. S. Bach"</span></span></span><span class="calibre8"> :country </span><span class="calibre8"><span class="italic"><span class="calibre42">"Germany"</span></span></span><span class="calibre8">}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    {:composer </span><span class="calibre8"><span class="italic"><span class="calibre42">"W. A. Mozart"</span></span></span><span class="calibre8"> :country </span><span class="calibre8"><span class="italic"><span class="calibre42">"Austria"</span></span></span><span class="calibre8">}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    {:composer </span><span class="calibre8"><span class="italic"><span class="calibre42">"Giuseppe Verdi"</span></span></span><span class="calibre8"> :country </span><span class="calibre8"><span class="italic"><span class="calibre42">"Italy"</span></span></span><span class="calibre8">}})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> nations​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  #{{:nation </span><span class="calibre8"><span class="italic"><span class="calibre42">"Germany"</span></span></span><span class="calibre8"> :language </span><span class="calibre8"><span class="italic"><span class="calibre42">"German"</span></span></span><span class="calibre8">}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    {:nation </span><span class="calibre8"><span class="italic"><span class="calibre42">"Austria"</span></span></span><span class="calibre8"> :language </span><span class="calibre8"><span class="italic"><span class="calibre42">"German"</span></span></span><span class="calibre8">}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    {:nation </span><span class="calibre8"><span class="italic"><span class="calibre42">"Italy"</span></span></span><span class="calibre8"> :language </span><span class="calibre8"><span class="italic"><span class="calibre42">"Italian"</span></span></span><span class="calibre8">}})​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">rename</span></span> function renames keys (<span class="italic">database columns</span>), based on a map from original names to new names. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(rename relation rename-map)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Rename the compositions to use a <span class="calibre8"><span class="calibre39">title</span></span> key instead of <span class="calibre8"><span class="calibre39">name</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(rename compositions {:name :title})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #{{:title "Requiem", :composer "Giuseppe Verdi"}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​{:title "Musical Offering", :composer "J.S. Bach"}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​{:title "Requiem", :composer "W. A. Mozart"}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​{:title "The Art of the Fugue", :composer "J.S. Bach"}}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">select</span></span> function returns maps for which a predicate is true and is analogous to the <span class="calibre8"><span class="calibre39">WHERE</span></span> portion of a <span class="calibre8"><span class="calibre39">SQL SELECT</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(select pred relation)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Write a <span class="calibre8"><span class="calibre39">select</span></span> expression that finds all the compositions whose title is <span class="calibre8"><span class="calibre39">"Requiem"</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(select #(= (:name %) "Requiem") compositions)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #{{:name "Requiem", :composer "W. A. Mozart"}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​{:name "Requiem", :composer "Giuseppe Verdi"}}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">project</span></span> function returns only the parts of maps that match a set of keys. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(project relation </span><span class="calibre8"><span class="bold"><span class="calibre36">keys</span></span></span><span class="calibre8">)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">project</span></span> is similar to a SQL SELECT that specifies a subset of columns. Write a projection that returns only the name of the compositions: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(project compositions [:name])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #{{:name "Musical Offering"}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​{:name "Requiem"}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​{:name "The Art of the Fugue"}}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The final relational primitive, which is a cross product, is the foundation for the various kinds of joins in relational databases. The cross product returns every possible combination of rows in the different tables. You can do this easily enough in Clojure with a list comprehension: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(for [m compositions c composers] (concat m c))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ... 4 x 3 = 12 rows ...​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Although the cross product is theoretically interesting, you will typically want some subset of the full cross product. For example, you might want to <span class="calibre8"><span class="calibre39">join</span></span> sets based on shared keys: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(join relation-1 relation-2 keymap?)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> You can <span class="calibre8"><span class="calibre39">join</span></span> the composition names and composers on the shared key <span class="calibre8"><span class="calibre39">:composer</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(join compositions composers)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #{{:name "Requiem", :country "Austria",​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​:composer "W. A. Mozart"}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​{:name "Musical Offering", :country "Germany",​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​:composer "J. S. Bach"}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​{:name "Requiem", :country "Italy",​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​:composer "Giuseppe Verdi"}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​{:name "The Art of the Fugue", :country "Germany",​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​:composer "J. S. Bach"}}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If the key names in the two relations do not match, you can pass a <span class="calibre8"><span class="calibre39">keymap</span></span> that maps the key names in <span class="calibre8"><span class="calibre39">relation-1</span></span> to their corresponding keys in <span class="calibre8"><span class="calibre39">relation-2</span></span>. For example, you can join <span class="calibre8"><span class="calibre39">composers</span></span>, which uses <span class="calibre8"><span class="calibre39">:country</span></span>, to <span class="calibre8"><span class="calibre39">nations</span></span>, which uses <span class="calibre8"><span class="calibre39">:nation</span></span>. For example: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(join composers nations {:country :nation})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #{{:language "German", :nation "Austria",​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​:composer "W. A. Mozart", :country "Austria"}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​{:language "German", :nation "Germany",​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​:composer "J. S. Bach", :country "Germany"}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​{:language "Italian", :nation "Italy",​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​:composer "Giuseppe Verdi", :country "Italy"}}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> You can combine the relational primitives. Perhaps you want to know the set of all countries that are home to the composer of a requiem. You can use <span class="calibre8"><span class="calibre39">select</span></span> to find all the requiems, <span class="calibre8"><span class="calibre39">join</span></span> them with their composers, and <span class="calibre8"><span class="calibre39">project</span></span> to narrow the results to just the country names: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(project​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(join​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(select #(= (:name %) "Requiem") compositions)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​composers)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​[:country])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #{{:country "Italy"} {:country "Austria"}}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The analogy between Clojure’s relational algebra and a relational database is instructive. Remember, though, that Clojure’s relational algebra is a general-purpose tool. You can use it on any kind of set-relational data. And while you’re using it, you have the entire power of Clojure and Java at your disposal. </p><div class="mbppagebreak"></div><p id="filepos537038" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">3.6 Wrapping Up</span></span></span></p><p class="calibre34"> Clojure unifies all kinds of collections under a single abstraction, the sequence. After more than a decade dominated by object-oriented programming, Clojure’s sequence library is the “Revenge of the Verbs.” </p><p class="calibre12"> Clojure’s sequences are implemented using functional programming techniques: immutable data, recursive definition, and lazy realization. In the next chapter, you will see how to use these techniques directly, further expanding the power of Clojure. </p><p class="calibre27"><span class="calibre8"><span class="bold"><span class="calibre28">Footnotes</span></span></span></p><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos381476"><span class="calibre8">[28]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><span class="calibre8">Steve Yegge’s “Execution in the Kingdom of Nouns” (</span><a href="http://tinyurl.com/the-kingdom-of-nouns"><span class="calibre8">http://tinyurl.com/the-kingdom-of-nouns</span></a><span class="calibre8">) argues that object-oriented programming has pushed nouns into an unrealistically dominant position and that it is time for a change.</span></p></td></tr><a id="filepos538326"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos422537"><span class="calibre8">[29]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><span class="calibre8">“Variables” in the mathematical sense, not the imperative programming sense. You can’t vary them. I humbly apologize for this overloading of the English language.</span></p></td></tr><a id="filepos538697"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos423059"><span class="calibre8">[30]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><span class="calibre8">The list comprehension </span><span class="calibre8"><span class="calibre39">for</span></span><span class="calibre8"> has nothing to do with the </span><span class="calibre8"><span class="calibre39">for</span></span><span class="calibre8"> loop found in imperative languages.</span></p></td></tr><a id="filepos539133"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos465188"><span class="calibre8">[31]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><span class="calibre8">Your results will vary from those shown here.</span></p></td></tr><a id="filepos539381"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos484684"><span class="calibre8">[32]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://clojure.org/data_structures       "><span class="calibre8">http://clojure.org/data_structures </span></a><span class="calibre8">
</span></p></td></tr><a id="filepos539698"></a></table><p class="calibre18"><span class="calibre8"><span class="calibre19"><span class="calibre20">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="mbppagebreak"></div><p id="filepos539895" class="calibre25"><span class="calibre2"><span class="bold"><span class="calibre43"> Chapter 4</span></span></span></p><br class="calibre11"/><p class="calibre26"><span class="calibre2"><span class="bold"><span class="calibre3">Functional Programming</span></span></span></p><p class="calibre12"> Functional programming (FP) is a big topic, not to be learned in twenty-one days<a id="filepos540247"></a><a href="#filepos696623">[33]</a> or in a single chapter of a book. Nevertheless, you can reach a first level of effectiveness using lazy and recursive techniques in Clojure fairly quickly, and that is what we’ll accomplish this chapter. </p><p class="calibre12">Here’s how we’ll do that:</p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> In Section 4.1, <a href="#filepos542049">​<span class="italic">Functional Programming Concepts</span>​</a>, you’ll get a quick overview of FP terms and concepts. This section also introduces the “Six Rules of Clojure FP” that we will refer to throughout the chapter. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> In Section 4.2, <a href="#filepos555532">​<span class="italic">How to Be Lazy</span>​</a>, you’ll experience the power of lazy sequences. You will create several implementations of the Fibonacci numbers, starting with a terrible approach and improving it to an elegant, lazy solution. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> As cool as lazy sequences are, you rarely need to work with them directly. In Section 4.3, <a href="#filepos599478">​<span class="italic">Lazier Than Lazy</span>​</a>, you’ll see how to rethink problems so that they can be solved directly using the sequence library described in Chapter 3, <a href="#filepos350588">​<span class="italic">Unifying Data with Sequences</span>​</a>. </p></li><a></a><li value="4" class="calibre30"><p class="calibre29"> And in Section 4.4, <a href="#filepos635309">​<span class="italic">Recursion Revisited</span>​</a>, we’ll explore some advanced issues. Some programmers will never need the techniques discussed here. If you are new to FP, it is OK to skip this section. </p></li><a></a></ul><div class="mbppagebreak"></div><p id="filepos542049" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">4.1 Functional Programming Concepts</span></span></span></p><p class="calibre34"> Functional programming leads to code that is easier to write, read, test, and reuse. Here’s how it works. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Pure Functions</span></span></span></p><p class="calibre44"> Programs are built out of <span class="italic">pure functions</span>. A pure function has no <span class="italic">side effects</span>; that is, it does not depend on anything but its arguments, and its only influence on the outside world is through its return value. </p><p class="calibre12"> Mathematical functions are pure functions. Two plus two is four, no matter where and when you ask. Also, asking doesn’t <span class="italic">do</span> anything other than return the answer. </p><p class="calibre12"> Program output is decidedly <span class="italic">impure</span>. For example, when you <span class="calibre8"><span class="calibre39">println</span></span>, you change the outside world by pushing data onto an output stream. Also, the results of <span class="calibre8"><span class="calibre39">println</span></span> depend on state outside the function: the standard output stream might be redirected, closed, or broken. </p><p class="calibre12"> If you start writing pure functions, you will quickly realize that pure functions and <span class="italic">immutable</span> data go hand in hand. Consider the following <span class="calibre8"><span class="calibre39">mystery</span></span> function: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> mystery [input]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> input data-1 data-2))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If <span class="calibre8"><span class="calibre39">mystery</span></span> is a pure function, then regardless of what it does, <span class="calibre8"><span class="calibre39">data-1</span></span> and <span class="calibre8"><span class="calibre39">data-2</span></span> have to be immutable! Otherwise, changes to the data would cause the function to return different values for the same <span class="calibre8"><span class="calibre39">input</span></span>. </p><p class="calibre12"> A single piece of mutable data can ruin the game, rendering an entire call chain of functions impure. So, once you make a commitment to writing pure functions, you end up using immutable data in large sections of your application. </p><p id="filepos544810" class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Persistent Data Structures</span></span></span></p><p class="calibre44"> Immutable data is critical to Clojure’s approach to both FP and state. On the FP side, pure functions cannot have side effects, such as updating the state of a mutable object. On the state side, Clojure’s reference types require immutable data structures to implement their concurrency guarantees. </p><p class="calibre12"> The fly in the ointment is performance. When all data is immutable, “update” translates into “create a copy of the original data, plus my changes.” This will use up memory quickly! Imagine that you have an address book that takes up 5MB of memory. Then, you make five small updates. With a mutable address book, you are still consuming about 5MB of memory. But if you have to copy the whole address book for each update, then an immutable version would balloon to 25MB! </p><p class="calibre12"> Clojure’s data structures do not take this naive “copy everything” approach. Instead, all Clojure data structures are <span class="italic">persistent</span>. In this context, persistent means that the data structures preserve old copies of themselves by efficiently <span class="italic">sharing structure</span> between older and newer versions. </p><p class="calibre12"> Structural sharing is easiest to visualize with a list. Consider list <span class="calibre8"><span class="calibre39">a</span></span> with two elements: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def a '(1 2))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/a​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Then, from <span class="calibre8"><span class="calibre39">a</span></span> you can create a <span class="calibre8"><span class="calibre39">b</span></span> with an additional element added: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def b (cons 0 a))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/b​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">b</span></span> is able to reuse all of <span class="calibre8"><span class="calibre39">a</span></span>’s structure, rather than having its own private copy: </p><p class="calibre12"><img src="images/00008.jpg" class="calibre67"/></p><p class="calibre29"> All of Clojure’s data structures share structure where possible. For structures other than simple lists, the mechanics are more complex, of course. If you are interested in the details, check out the following articles: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> “Ideal Hash Trees”<a href="#filepos696960">[34]</a> by Phil Bagwell </p></li><a id="filepos547979"></a><li value="2" class="calibre30"><p class="calibre29"> “Understanding Clojure’s PersistentVector Implementation”<a href="#filepos697289">[35]</a> by Karl Krukow </p></li><a id="filepos548172"></a></ul><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Laziness and Recursion</span></span></span></p><p class="calibre44"> Functional programs make heavy use of <span class="italic">recursion</span> and <span class="italic">laziness</span>. A recursion occurs when a function calls itself, either directly or indirectly. With laziness, an expression’s evaluation is postponed until it is actually needed. Evaluating a lazy expression is called <span class="italic">realizing</span> the expression. </p><p class="calibre12"> In Clojure, functions and expressions are not lazy. However, sequences <span class="italic">are</span> generally lazy. Because so much Clojure programming is sequence manipulation, you get many of the benefits of a fully lazy language. In particular, you can build complex expressions using lazy sequences and then pay only for the elements you actually need. </p><p class="calibre12"> Lazy techniques imply pure functions. You never have to worry about when to call a pure function, since it always returns the same thing. Impure functions, on the other hand, do not play well with lazy techniques. As a programmer, you must explicitly control when an impure function is called, because if you call it at some other time, it may behave differently! </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Referential Transparency</span></span></span></p><p class="calibre44"> Laziness depends on the ability to replace a function call with its result at any time. Functions that have this ability are called <span class="italic">referentially transparent</span>, because calls to such functions can be replaced without affecting the behavior of the program. In addition to laziness, referentially transparent functions can also benefit from the following: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"><span class="italic">Memoization</span>, automatic caching of results </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Automatic <span class="italic">parallelization</span>, moving function evaluation to another processor or machine </p></li><a></a></ul><p class="calibre12"> Pure functions are referentially transparent <span class="italic">by definition</span>. Most other functions are <span class="italic">not</span> referentially transparent, and those that are must be proven safe by code review. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Benefits of FP</span></span></span></p><p class="calibre44"> Well, that is a lot of terminology, and we promised it would make your code easier to write, read, test, and compose. Here’s how. </p><p class="calibre12"> You’ll find functional code easier to <span class="italic">write</span> because the relevant information is right in front of you, in a function’s argument list. You do not have to worry about global scope, session scope, application scope, or thread scope. Functional code is easier to <span class="italic">read</span> for exactly the same reason. </p><p class="calibre12"> Code that is easier to read and write is going to be easier to test, but functional code brings an additional benefit for testing. As projects get large, it often takes a lot of effort to set up the right environment to execute a test. This is much less of a problem with functional code, because there <span class="italic">is no relevant environment</span> beyond the function’s arguments. </p><p class="calibre12"> Functional code improves <span class="italic">reuse</span>. To reuse code, you must be able to do the following: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">Find and understand a piece of useful code.</p></li><a></a><li value="2" class="calibre30"><p class="calibre29">Compose the reusable code with other code.</p></li><a></a></ul><p class="calibre12"> The readability of functional code helps you find and understand the functions you need, but the benefit for <span class="italic">composing</span> code is even more compelling. </p><p class="calibre12"> Composability is a hard problem. For years programmers have used <span class="italic">encapsulation</span> to try to create composable code. Encapsulation creates a firewall, providing access to data only through a public API. </p><p class="calibre12"> Encapsulation helps, but it is nowhere near enough. Even with encapsulated objects, there are far too many surprising interactions when you try to compose entire systems. The problem is those darn side effects. <span class="italic">Impure functions</span> violate encapsulation, because they let the outside world reach in (invisibly!) and change the behavior of your code. Pure functions, on the other hand, are truly encapsulated and composable. Put them anywhere you want in a system, and they will always behave in the same way. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">The Six Rules</span></span></span></p><p class="calibre44"> Although the benefits of FP are compelling, FP is a wholesale change from the imperative programming style that dominates much of the programming world today. Plus, Clojure takes a unique approach to FP that strikes a balance between academic purity and the reality of running well on the JVM. That means there is a lot to learn all at once. But fear not. If you are new to FP, the following “Six Rules of Clojure FP” will help you on your initial steps toward FP mastery, Clojure-style: </p><div class="calibre14"> </div><ol class="calibre68"><li value="1" class="calibre16"><p class="calibre29"> Avoid direct recursion. The JVM cannot optimize recursive calls, and Clojure programs that recurse will blow their stack. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Use <span class="calibre8"><span class="calibre39">recur</span></span> when you are producing scalar values or small, fixed sequences. Clojure <span class="italic">will</span> optimize calls that use an explicit <span class="calibre8"><span class="calibre39">recur</span></span>. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> When producing large or variable-sized sequences, always be lazy. (Do <span class="italic">not</span> recur.) Then, your callers can consume just the part of the sequence they actually need. </p></li><a></a><li value="4" class="calibre30"><p class="calibre29"> Be careful not to realize more of a lazy sequence than you need. </p></li><a></a><li value="5" class="calibre30"><p class="calibre29"> Know the sequence library. You can often write code without using <span class="calibre8"><span class="calibre39">recur</span></span> or the lazy APIs at all. </p></li><a></a><li value="6" class="calibre30"><p class="calibre29"> Subdivide. Divide even simple-seeming problems into smaller pieces, and you will often find solutions in the sequence library that lead to more general, reusable code. </p></li><a></a></ol><p class="calibre12"> Rules 5 and 6 are particularly important. If you are new to FP, you can translate these two rules to this: “Ignore this chapter and just use the techniques in Chapter 3, <a href="#filepos350588">​<span class="italic">Unifying Data with Sequences</span>​</a> until you hit a wall.” </p><p class="calibre12"> Like most rules, the six rules are guidelines, not absolutes. As you become comfortable with FP, you will find reasons to break them. </p><p class="calibre12">Now, let’s get started writing functional code.</p><div class="mbppagebreak"></div><p id="filepos555532" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">4.2 How to Be Lazy</span></span></span></p><p class="calibre34"> Functional programs make great use of <span class="italic">recursive definitions</span>. A recursive definition consists of two parts: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> A <span class="italic">basis</span>, which explicitly enumerates some members of the sequence </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> An <span class="italic">induction</span>, which provides rules for combining members of the sequence to produce additional members </p></li><a></a></ul><p class="calibre12"> Our challenge in this section is converting a recursive definition into working code. You might do this in several ways: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> A simple recursion, using a function that calls itself in some way to implement the induction step. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> A tail recursion, using a function only calling itself at the tail end of its execution. Tail recursion enables an important optimization. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> A lazy sequence that eliminates actual recursion and calculates a value later, when it is needed. </p></li><a></a></ul><p class="calibre12"> Choosing the right approach is important. Implementing a recursive definition poorly can lead to code that performs terribly, consumes all available stack and fails, consumes all available heap and fails, or does all of these. In Clojure, being lazy is often the right approach. </p><p class="calibre12"> We will explore all of these approaches by applying them to the Fibonacci numbers. Named for the Italian mathematician Leonardo (Fibonacci) of Pisa (c.1170--c.1250), the Fibonacci numbers were actually known to Indian mathematicians as far back as 200 BC. The Fibonacci numbers have many interesting properties, and they crop up again and again in algorithms, data structures, and even biology.<a id="filepos557717"></a><a href="#filepos697620">[36]</a> The Fibonaccis have a very simple recursive definition: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Basis: F<sub class="calibre69"><small class="calibre70"><span class="calibre71">0</span></small></sub>, the zeroth Fibonacci number, is zero. F<sub class="calibre69"><small class="calibre70"><span class="calibre71">1</span></small></sub>, the first Fibonacci number, is one. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Induction: For <span class="italic">n &gt; 1</span>, F<sub class="calibre69"><small class="calibre70"><span class="calibre71">n</span></small></sub> equals F<sub class="calibre69"><small class="calibre70"><span class="calibre71">n-1</span></small></sub>+F<sub class="calibre69"><small class="calibre70"><span class="calibre71">n-2</span></small></sub>. </p></li><a></a></ul><p class="calibre12">Using this definition, the first ten Fibonacci numbers are as follows:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(0 1 1 2 3 5 8 13 21 34)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Let’s begin by implementing the Fibonaccis using a simple recursion. The following Clojure function will return the <span class="italic">nth</span> Fibonacci number: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/functional.clj"><span class="calibre41"><span class="underline">src/examples/functional.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">Line 1</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; bad idea</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">2</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> stack-consuming-fibo [n]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">3</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">cond</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">4</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> n 0) 0 ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">5</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> n 1) 1 ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">6</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   :else (</span><span class="calibre8"><span class="bold"><span class="calibre36">+</span></span></span><span class="calibre8"> (stack-consuming-fibo (</span><span class="calibre8"><span class="bold"><span class="calibre36">-</span></span></span><span class="calibre8"> n 1))    ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">7</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            (stack-consuming-fibo (</span><span class="calibre8"><span class="bold"><span class="calibre36">-</span></span></span><span class="calibre8"> n 2)))))     ​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Lines 4 and 5 define the basis, and line 6 defines the induction. The implementation is recursive because <span class="calibre8"><span class="calibre39">stack-consuming-fibo</span></span> calls itself on lines 6 and 7. </p><p class="calibre12"> Test that <span class="calibre8"><span class="calibre39">stack-consuming-fibo</span></span> works correctly for small values of <span class="calibre8"><span class="calibre39">n</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(stack-consuming-fibo 9)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 34​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Good so far, but there is a problem calculating larger Fibonacci numbers such as F<sub class="calibre69"><small class="calibre70"><span class="calibre71">1000000</span></small></sub>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(stack-consuming-fibo 1000000)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; StackOverflowError clojure.lang.Numbers.minus (Numbers.java:1837)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Because of the recursion, each call to <span class="calibre8"><span class="calibre39">stack-consuming-fibo</span></span> for <span class="italic">n &gt; 1</span> begets two more calls to <span class="calibre8"><span class="calibre39">stack-consuming-fibo</span></span>. At the JVM level, these calls are translated into method calls, each of which allocates a data structure called a <span class="italic">stack frame</span>.<a id="filepos563217"></a><a href="#filepos698022">[37]</a>
</p><p class="calibre12"> The <span class="calibre8"><span class="calibre39">stack-consuming-fibo</span></span> creates a depth of stack frames proportional to <span class="calibre8"><span class="calibre39">n</span></span>, which quickly exhausts the JVM stack and causes the <span class="calibre8"><span class="calibre39">StackOverflowError</span></span> shown earlier. (It also creates a total number of stack frames that is exponential in <span class="calibre8"><span class="calibre39">n</span></span>, so its performance is terrible even when the stack does not overflow.) </p><p class="calibre12"> Clojure function calls are designated as <span class="italic">stack-consuming</span> because they allocate stack frames that use up stack space. In Clojure, you should almost always avoid stack-consuming recursion as shown in <span class="calibre8"><span class="calibre39">stack-</span></span>
<span class="calibre8"><span class="calibre39">consuming-fibo</span></span>. </p><p id="filepos564148" class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Tail Recursion</span></span></span></p><p class="calibre44"> Functional programs can solve the stack-usage problem with <span class="italic">tail recursion</span>. A tail-recursive function is still defined recursively, but the recursion must come at the tail, that is, at an expression that is a return value of the function. Languages can then perform <span class="italic">tail-call optimization</span> (TCO), converting tail recursions into iterations that do not consume the stack. </p><p class="calibre12"> The <span class="calibre8"><span class="calibre39">stack-consuming-fibo</span></span> definition of Fibonacci is not tail-recursive, because it calls add (<span class="calibre8"><span class="calibre39">+</span></span>) <span class="italic">after</span> both calls to <span class="calibre8"><span class="calibre39">stack-consuming-fibo</span></span>. To make <span class="calibre8"><span class="calibre39">fibo</span></span> tail-recursive, you must create a function whose arguments carry enough information to move the induction forward, without any extra “after” work (like an addition) that would push the recursion out of the tail position. For <span class="calibre8"><span class="calibre39">fibo</span></span>, such a function needs to know two Fibonacci numbers, plus an ordinal <span class="calibre8"><span class="calibre39">n</span></span> that can count down to zero as new Fibonaccis are calculated. You can write <span class="calibre8"><span class="calibre39">tail-fibo</span></span> thusly: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/functional.clj"><span class="calibre41"><span class="underline">src/examples/functional.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">Line 1</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> tail-fibo [n]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">2</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">letfn</span></span></span><span class="calibre8"> [(fib ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">3</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​           [current </span><span class="calibre8"><span class="bold"><span class="calibre36">next</span></span></span><span class="calibre8"> n] ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">4</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​           (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">zero?</span></span></span><span class="calibre8"> n)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">5</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​             current       ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">6</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​             (fib </span><span class="calibre8"><span class="bold"><span class="calibre36">next</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">+</span></span></span><span class="calibre8"> current </span><span class="calibre8"><span class="bold"><span class="calibre36">next</span></span></span><span class="calibre8">) (</span><span class="calibre8"><span class="bold"><span class="calibre36">dec</span></span></span><span class="calibre8"> n))))] ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">7</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (fib 0N 1N n))) ​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Line 2 introduces the <span class="calibre8"><span class="calibre39">letfn</span></span> macro: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">letfn</span></span></span><span class="calibre8"> fnspecs &amp; body) </span><span class="calibre8"><span class="italic"><span class="calibre40">; fnspecs ==&gt; [(fname [params*] exprs)+]</span></span></span><span class="calibre8">​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">letfn</span></span> is like <span class="calibre8"><span class="calibre39">let</span></span> but is dedicated to letting local functions. Each function declared in a <span class="calibre8"><span class="calibre39">letfn</span></span> can call itself or any other function in the same <span class="calibre8"><span class="calibre39">letfn</span></span> block. Line 3 declares that <span class="calibre8"><span class="calibre39">fib</span></span> has three arguments: the <span class="calibre8"><span class="calibre39">current</span></span> Fibonacci, the <span class="calibre8"><span class="calibre39">next</span></span> Fibonacci, and the number <span class="calibre8"><span class="calibre39">n</span></span> of steps remaining. </p><p class="calibre12"> Line 5 returns <span class="calibre8"><span class="calibre39">current</span></span> when there are no steps remaining, and line 6 continues the calculation, decrementing the remaining steps by one. Finally, line 7 kicks off the recursion with the basis values <span class="calibre8"><span class="calibre39">0</span></span> and <span class="calibre8"><span class="calibre39">1</span></span>, plus the ordinal <span class="calibre8"><span class="calibre39">n</span></span> of the Fibonacci we are looking for. </p><p class="calibre12"><span class="calibre8"><span class="calibre39">tail-fibo</span></span> works for small values of <span class="calibre8"><span class="calibre39">n</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(tail-fibo 9)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 34N​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> But even though it is tail-recursive, it still fails for large <span class="calibre8"><span class="calibre39">n</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(tail-fibo 1000000)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; StackOverflowError java.lang.Integer.numberOfLeadingZeros (Integer.java:1054)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The problem here is the JVM. While functional languages such as Haskell can perform TCO, the JVM was not designed for functional languages. No language that runs directly on the JVM can perform automatic TCO.<a id="filepos571376"></a><a href="#filepos698593">[38]</a>
</p><p class="calibre12"> The absence of TCO is unfortunate but not a showstopper for functional programs. Clojure provides several pragmatic workarounds: explicit self-recursion with <span class="calibre8"><span class="calibre39">recur</span></span>, lazy sequences, and explicit mutual recursion with <span class="calibre8"><span class="calibre39">trampoline</span></span>.</p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Self-recursion with recur</span></span></span></p><p class="calibre44"> One special case of recursion that <span class="italic">can</span> be optimized away on the JVM is a self-recursion. Fortunately, the <span class="calibre8"><span class="calibre39">tail-fibo</span></span> is an example: it calls itself directly, not through some series of intermediate functions. </p><p class="calibre12"> In Clojure, you can convert a function that tail-calls itself into an explicit self-recursion with <span class="calibre8"><span class="calibre39">recur</span></span>. Using this approach, convert <span class="calibre8"><span class="calibre39">tail-fibo</span></span> into <span class="calibre8"><span class="calibre39">recur-fibo</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/functional.clj"><span class="calibre41"><span class="underline">src/examples/functional.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">Line 1</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; better but not great</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">2</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> recur-fibo [n]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">3</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">letfn</span></span></span><span class="calibre8"> [(fib​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">4</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            [current </span><span class="calibre8"><span class="bold"><span class="calibre36">next</span></span></span><span class="calibre8"> n]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">5</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">zero?</span></span></span><span class="calibre8"> n)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">6</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​              current​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">7</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​              (</span><span class="calibre8"><span class="bold"><span class="calibre36">recur</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">next</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">+</span></span></span><span class="calibre8"> current </span><span class="calibre8"><span class="bold"><span class="calibre36">next</span></span></span><span class="calibre8">) (</span><span class="calibre8"><span class="bold"><span class="calibre36">dec</span></span></span><span class="calibre8"> n))))] ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">8</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (fib 0N 1N n)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The critical difference between <span class="calibre8"><span class="calibre39">tail-fibo</span></span> and <span class="calibre8"><span class="calibre39">recur-fibo</span></span> is on line 7, where <span class="calibre8"><span class="calibre39">recur</span></span> replaces the call to <span class="calibre8"><span class="calibre39">fib</span></span>. </p><p class="calibre12"> The <span class="calibre8"><span class="calibre39">recur-fibo</span></span> will not consume stack as it calculates Fibonacci numbers and can calculate F<sub class="calibre69"><small class="calibre70"><span class="calibre71">n</span></small></sub> for large <span class="calibre8"><span class="calibre39">n</span></span> if you have the patience: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(recur-fibo 9)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 34N​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(recur-fibo 1000000)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 195 ... 208,982 other digits ... 875N​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The complete value of F<sub class="calibre69"><small class="calibre70"><span class="calibre71">1000000</span></small></sub> is included in the sample code at <span class="calibre8"><span class="calibre39">output/f-1000000</span></span>. </p><p class="calibre12"> The <span class="calibre8"><span class="calibre39">recur-fibo</span></span> calculates one Fibonacci number. But what if you want several? Calling <span class="calibre8"><span class="calibre39">recur-fibo</span></span> multiple times would be wasteful, since none of the work from any call to <span class="calibre8"><span class="calibre39">recur-fibo</span></span> is ever cached for the next call. But how many values should be cached? Which ones? These choices should be made by the <span class="italic">caller</span> of the function, not the implementer. </p><p class="calibre12"> Ideally you would define sequences with an API that makes <span class="italic">no reference</span> to the specific range that a particular client cares about and then let clients pull the range they want with <span class="calibre8"><span class="calibre39">take</span></span> and <span class="calibre8"><span class="calibre39">drop</span></span>. This is exactly what lazy sequences provide. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Lazy Sequences</span></span></span></p><p class="calibre44"> Lazy sequences are constructed using the macro <span class="calibre8"><span class="calibre39">lazy-seq</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">lazy-seq</span></span></span><span class="calibre8"> &amp; body)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> A <span class="calibre8"><span class="calibre39">lazy-seq</span></span> will invoke its body only when needed, that is, when <span class="calibre8"><span class="calibre39">seq</span></span> is called directly or indirectly. <span class="calibre8"><span class="calibre39">lazy-seq</span></span> will then cache the result for subsequent calls. You can use <span class="calibre8"><span class="calibre39">lazy-seq</span></span> to define a lazy Fibonacci series as follows: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/functional.clj"><span class="calibre41"><span class="underline">src/examples/functional.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">Line 1</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> lazy-seq-fibo​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">2</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  ([]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">3</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     (</span><span class="calibre8"><span class="bold"><span class="calibre36">concat</span></span></span><span class="calibre8"> [0 1] (lazy-seq-fibo 0N 1N))) ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">4</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  ([a b]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">5</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [n (</span><span class="calibre8"><span class="bold"><span class="calibre36">+</span></span></span><span class="calibre8"> a b)]                    ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">6</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​       (</span><span class="calibre8"><span class="bold"><span class="calibre36">lazy-seq</span></span></span><span class="calibre8">                         ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">7</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        (</span><span class="calibre8"><span class="bold"><span class="calibre36">cons</span></span></span><span class="calibre8"> n (lazy-seq-fibo b n)))))) ​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> On line 3, the zero-argument body returns the concatenation of the basis values <span class="calibre8"><span class="calibre39">[0 1]</span></span> and then calls the two-argument body to calculate the rest of the values. On line 5, the two-argument body calculates the next value <span class="calibre8"><span class="calibre39">n</span></span> in the series, and on line 7 it <span class="calibre8"><span class="calibre39">cons</span></span>es <span class="calibre8"><span class="calibre39">n</span></span> onto the rest of the values. </p><p class="calibre12"> The key is line 6, which makes its body lazy. Without this, the recursive call to <span class="calibre8"><span class="calibre39">lazy-seq-fibo</span></span> on line 7 would happen immediately, and <span class="calibre8"><span class="calibre39">lazy-seq-fibo</span></span> would recurse until it blew the stack. This illustrates the general pattern: wrap the recursive part of a function body with <span class="calibre8"><span class="calibre39">lazy-seq</span></span> to replace recursion with laziness. </p><p class="calibre12"><span class="calibre8"><span class="calibre39">lazy-seq-fibo</span></span> works for small values:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(take 10 (lazy-seq-fibo))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (0 1 1N 2N 3N 5N 8N 13N 21N 34N)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">lazy-seq-fibo</span></span> also works for large values. Use <span class="calibre8"><span class="calibre39">(rem ... 1000)</span></span> to print only the last three digits of the one millionth Fibonacci number: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(rem (nth (lazy-seq-fibo) 1000000) 1000)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 875N​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">lazy-seq-fibo</span></span> approach follows rule 3, using laziness to implement an infinite sequence. But as is often the case, you do not need to explicitly call <span class="calibre8"><span class="calibre39">lazy-seq</span></span> yourself. By rule 5, you can reuse existing sequence library functions that return lazy sequences. Consider this use of <span class="calibre8"><span class="calibre39">iterate</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(take 5 (iterate (fn [[a b]] [b (+ a b)]) [0 1]))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ([0 1] [1 1] [1 2] [2 3] [3 5])​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">iterate</span></span> begins with the first pair of Fibonacci numbers: <span class="calibre8"><span class="calibre39">[0 1]</span></span>. By working pairwise, it then calculates the Fibonaccis by carrying along just enough information (two values) to calculate the next value. </p><p class="calibre12"> The Fibonaccis are simply the first value of each pair. They can be extracted by calling <span class="calibre8"><span class="calibre39">map first</span></span> over the entire sequence, leading to the following definition of <span class="calibre8"><span class="calibre39">fibo</span></span> suggested by Christophe Grand: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/functional.clj"><span class="calibre41"><span class="underline">src/examples/functional.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> fibo []​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​ (</span><span class="calibre8"><span class="bold"><span class="calibre36">map</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">first</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">iterate</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">fn</span></span></span><span class="calibre8"> [[a b]] [b (</span><span class="calibre8"><span class="bold"><span class="calibre36">+</span></span></span><span class="calibre8"> a b)]) [0N 1N])))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">fibo</span></span> returns a lazy sequence because it builds on <span class="calibre8"><span class="calibre39">map</span></span> and <span class="calibre8"><span class="calibre39">iterate</span></span>, which also return lazy sequences. <span class="calibre8"><span class="calibre39">fibo</span></span> is also <span class="italic">simple</span>. <span class="calibre8"><span class="calibre39">fibo</span></span> is the shortest implementation we have seen so far. But if you are accustomed to writing imperative, looping code, correctly <span class="italic">choosing</span> <span class="calibre8"><span class="calibre39">fibo</span></span> over other approaches may not seem simple at all! Learning to think recursively, lazily, and within the JVM’s limitations on recursion—all at the same time—can be intimidating. Let the rules help you. The Fibonacci numbers are infinite: rule 3 correctly predicts that the right approach in Clojure will be a lazy sequence, and rule 5 lets the existing sequence functions do most of the work. </p><p class="calibre12"> Lazy definitions consume <span class="italic">some</span> stack and heap. But they do not consume resources proportional to the size of an entire (possibly infinite!) sequence. Instead, <span class="italic">you choose</span> how many resources to consume when you traverse the sequence. If you want the one millionth Fibonacci number, you can get it from <span class="calibre8"><span class="calibre39">fibo</span></span>, without having to consume stack or heap space for all the previous values. </p><p class="calibre12"> There is no such thing as a free lunch. But with lazy sequences, you can have an infinite menu and pay only for the menu items you are eating at a given moment. When writing Clojure programs, you should prefer lazy sequences over loop/recur for any sequence that varies in size and for any large sequence. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Coming to Realization</span></span></span></p><p class="calibre44"> Lazy sequences consume significant resources only as they are <span class="italic">realized</span>, that is, as a portion of the sequence is actually instantiated in memory. Clojure works hard to be lazy and avoid realizing sequences until it is absolutely necessary. For example, <span class="calibre8"><span class="calibre39">take</span></span> returns a lazy sequence and does no realization at all. You can see this by creating a var to hold, say, the first billion Fibonacci numbers: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def lots-o-fibs (take 1000000000 (fibo)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/lots-o-fibs​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The creation of <span class="calibre8"><span class="calibre39">lots-o-fibs</span></span> returns almost immediately, because it does <span class="italic">almost nothing</span>. If you ever call a function that needs to <span class="italic">actually use</span> some values in <span class="calibre8"><span class="calibre39">lots-o-fibs</span></span>, Clojure will calculate them. Even then, it will do only what is necessary. For example, the following will return the 100th Fibonacci number from <span class="calibre8"><span class="calibre39">lots-o-fibs</span></span>, without calculating the millions of other numbers that <span class="calibre8"><span class="calibre39">lots-o-fibs</span></span> promises to provide: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(nth lots-o-fibs 100)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 354224848179261915075N​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Most sequence functions return lazy sequences. If you are not sure whether a function returns a lazy sequence, the function’s documentation string typically will tell you the answer: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(doc take)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-------------------------​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​clojure.core/take​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​([n coll])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​Returns a lazy seq of the first n items in coll, or all items if​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​there are fewer than n.​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The REPL, however, is <span class="italic">not lazy</span>. The printer used by the REPL will, by default, print the entirety of a collection. That is why we stuffed the first billion Fibonaccis into <span class="calibre8"><span class="calibre39">lots-o-fibs</span></span>, instead of evaluating them at the REPL. Don’t enter the following at the REPL: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​; don't do this​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(take 1000000000 (fibo))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If you enter the previous expression, the printer will attempt to print a billion Fibonacci numbers, realizing the entire collection as it goes. You will probably get bored and exit the REPL before Clojure runs out of memory. </p><p class="calibre12"> As a convenience for working with lazy sequences, you can configure how many items the printer will print by setting the value of <span class="calibre8"><span class="calibre39">*print-length*</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(set! *print-length* 10)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 10​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> For collections with more than ten items, the printer will now print only the first ten followed by an ellipsis. So, you can safely print a billion fibos: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(take 1000000000 (fibo))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (0N 1N 1N 2N 3N 5N 8N 13N 21N 34N ...)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Or even all the fibos:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(fibo)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (0N 1N 1N 2N 3N 5N 8N 13N 21N 34N ...)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Lazy sequences are wonderful. They do only what is needed, and for the most part you don’t have to worry about them. If you ever want to force a sequence to be fully realized, you can use either <span class="calibre8"><span class="calibre39">doall</span></span> or <span class="calibre8"><span class="calibre39">dorun</span></span>, discussed in <a href="#filepos438471">​<span class="italic">Forcing Sequences</span>​</a>. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Losing Your Head</span></span></span></p><p class="calibre44"> There is one last thing to consider when working with lazy sequences. Lazy sequences let you define a large (possibly infinite) sequence and then work with a small part of that sequence in memory at a given moment. This clever ploy will fail if you (or some API) unintentionally hold a reference to the part of the sequence you no longer care about. </p><p class="calibre12"> The most common way this can happen is if you accidentally hold the head (first item) of a sequence. In the examples in the previous sections, each variant of the Fibonacci numbers was defined as a function returning a sequence, not the sequence itself. </p><p class="calibre12">You could define the sequence directly as a top-level var:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/functional.clj"><span class="calibre41"><span class="underline">src/examples/functional.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; holds the head (avoid!)</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> head-fibo (</span><span class="calibre8"><span class="bold"><span class="calibre36">lazy-cat</span></span></span><span class="calibre8"> [0N 1N] (</span><span class="calibre8"><span class="bold"><span class="calibre36">map</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">+</span></span></span><span class="calibre8"> head-fibo (</span><span class="calibre8"><span class="bold"><span class="calibre36">rest</span></span></span><span class="calibre8"> head-fibo))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> This definition uses <span class="calibre8"><span class="calibre39">lazy-cat</span></span>, which is like <span class="calibre8"><span class="calibre39">concat</span></span> except that the arguments are evaluated only when needed. This is a very pretty definition in that it defines the recursion by mapping a sum over (each element of the Fibonaccis) and (each element of the <span class="italic">rest</span> of the Fibonaccis). </p><p class="calibre12"><span class="calibre8"><span class="calibre39">head-fibo</span></span> works great for small Fibonacci numbers:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(take 10 head-fibo)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (0N 1N 1N 2N 3N 5N 8N 13N 21N 34N)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">but not so well for huge ones:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(nth head-fibo 1000000)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.lang.OutOfMemoryError: GC overhead limit exceeded​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The problem is that the top-level var <span class="calibre8"><span class="calibre39">head-fibo</span></span> <span class="italic">holds the head</span> of the collection. This prevents the garbage collector from reclaiming elements of the sequence after you have moved past those elements. So, any part of the Fibonacci sequence that you actually use gets cached for the life of the value referenced by <span class="calibre8"><span class="calibre39">head-fibo</span></span>, which is likely to be the life of the program. </p><p class="calibre12"> Unless you want to cache a sequence as you traverse it, you must be careful not to keep a reference to the head of the sequence. As the <span class="calibre8"><span class="calibre39">head-fibo</span></span> example demonstrates, you should normally expose lazy sequences as a function that <span class="italic">returns</span> the sequence, not as a var that <span class="italic">contains</span> the sequence. If a caller of your function wants an explicit cache, the caller can always create its own var. With lazy sequences, losing your head is often a good idea. </p><div class="mbppagebreak"></div><p id="filepos599478" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">4.3 Lazier Than Lazy</span></span></span></p><p class="calibre34"> Clojure’s lazy sequences are a great form of laziness at the language level. As a programmer, you can be <span class="italic">even lazier</span> by finding solutions that do not require explicit sequence manipulation at all. You can often combine existing sequence functions to solve a problem, without having to get your hands dirty at the level of <span class="calibre8"><span class="calibre39">recur</span></span> or lazy sequences. </p><p class="calibre12"> As an example of this, you will implement several solutions to the following problem.<a id="filepos600150"></a><a href="#filepos698893">[39]</a> You are given a sequence of coin toss results, where heads is <span class="calibre8"><span class="calibre39">:h</span></span> and tails is <span class="calibre8"><span class="calibre39">:t</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​[:h :t :t :h :h :h]​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> How many times in the sequence does heads come up twice in a row? In the previous example, the answer is two. Toss 3 and toss 4 are both heads, and toss 4 and toss 5 are both heads. </p><p class="calibre12"> The sequence of coin tosses might be very large, but it will be finite. Since you are looking for a scalar answer (a count), by rule 2 it is acceptable to use <span class="calibre8"><span class="calibre39">recur</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/functional.clj"><span class="calibre41"><span class="underline">src/examples/functional.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">Line 1</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> count-heads-pairs [coll]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">2</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">loop</span></span></span><span class="calibre8"> [cnt 0 coll coll] ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">3</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">empty?</span></span></span><span class="calibre8"> coll) ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">4</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      cnt​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">5</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">recur</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> :h (</span><span class="calibre8"><span class="bold"><span class="calibre36">first</span></span></span><span class="calibre8"> coll) (</span><span class="calibre8"><span class="bold"><span class="calibre36">second</span></span></span><span class="calibre8"> coll)) ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">6</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​               (</span><span class="calibre8"><span class="bold"><span class="calibre36">inc</span></span></span><span class="calibre8"> cnt)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">7</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​               cnt)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">8</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​             (</span><span class="calibre8"><span class="bold"><span class="calibre36">rest</span></span></span><span class="calibre8"> coll)))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Since the purpose of the function is to count something, the <span class="calibre8"><span class="calibre39">loop</span></span> introduces a <span class="calibre8"><span class="calibre39">cnt</span></span> binding, initially zero on line 2. The <span class="calibre8"><span class="calibre39">loop</span></span> also introduces its own binding for the <span class="calibre8"><span class="calibre39">coll</span></span> so that we can shrink the <span class="calibre8"><span class="calibre39">coll</span></span> each time through the <span class="calibre8"><span class="calibre39">recur</span></span>. Line 3 provides the basis for the recurrence. If a sequence of coin tosses is empty, it certainly has zero runs of two heads in a row. </p><p class="calibre12"> Line 5 is the meat of the function, incrementing the <span class="calibre8"><span class="calibre39">cnt</span></span> by one if the <span class="calibre8"><span class="calibre39">first</span></span> and <span class="calibre8"><span class="calibre39">second</span></span> items of <span class="calibre8"><span class="calibre39">coll</span></span> are both heads (<span class="calibre8"><span class="calibre39">:h</span></span>). </p><p class="calibre12"> Try a few inputs to see that <span class="calibre8"><span class="calibre39">count-heads-pairs</span></span> works as advertised: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(count-heads-pairs [:h :h :h :t :h])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 2​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(count-heads-pairs [:h :t :h :t :h])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 0​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Although <span class="calibre8"><span class="calibre39">count-heads-pairs</span></span> works, it fails as code prose. The key notion of “two in a rowness” is completely obscured by the boilerplate for <span class="calibre8"><span class="calibre39">loop</span></span>/<span class="calibre8"><span class="calibre39">recur</span></span>. To fix this, you will need to use rules 5 and 6, subdividing the problem to take advantage of Clojure’s sequence library. </p><p class="calibre12"> The first problem you will encounter is that almost all the sequence functions do something to each element in a sequence in turn. This doesn’t help us at all, since we want to look at each element in the context of its immediate neighbors. So, let’s transform the sequence. When you see this: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​[:h :t :t :h :h :h]​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> you should mentally translate that into a sequence of every adjacent pair: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​[[:h :t] [:t :t] [:t :h] [:h :h] [:h :h]]​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Write a function named <span class="calibre8"><span class="calibre39">by-pairs</span></span> that performs this transformation. Because the output of <span class="calibre8"><span class="calibre39">by-pairs</span></span> varies based on the size of its input, by rule 3 you should build this sequence lazily: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/functional.clj"><span class="calibre41"><span class="underline">src/examples/functional.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">Line 1</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; overly complex, better approaches follow...</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">2</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> by-pairs [coll]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">3</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [take-pair (</span><span class="calibre8"><span class="bold"><span class="calibre36">fn</span></span></span><span class="calibre8"> [c]                           ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">4</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                    (</span><span class="calibre8"><span class="bold"><span class="calibre36">when</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">next</span></span></span><span class="calibre8"> c) (</span><span class="calibre8"><span class="bold"><span class="calibre36">take</span></span></span><span class="calibre8"> 2 c)))]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">5</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">lazy-seq</span></span></span><span class="calibre8">                                       ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">6</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     (</span><span class="calibre8"><span class="bold"><span class="calibre36">when-let</span></span></span><span class="calibre8"> [pair (</span><span class="calibre8"><span class="bold"><span class="calibre36">seq</span></span></span><span class="calibre8"> (take-pair coll))]        ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">7</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​         (</span><span class="calibre8"><span class="bold"><span class="calibre36">cons</span></span></span><span class="calibre8"> pair (by-pairs (</span><span class="calibre8"><span class="bold"><span class="calibre36">rest</span></span></span><span class="calibre8"> coll)))))))     ​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Line 3 defines a function that takes the first pair of elements from the collection. Line 5 ensures that the recursion is evaluated lazily. </p><p class="calibre12"> Line 6 is a conditional: if the next pair does not actually contain two elements, we must be (almost) at the end of the list, and we implicitly terminate. If we do get two elements, then on line 7 we continue building the sequence by <span class="calibre8"><span class="calibre39">cons</span></span>ing our pair onto the pairs to be had from the <span class="calibre8"><span class="calibre39">rest</span></span> of the collection. </p><p class="calibre12">Check that <span class="calibre8"><span class="calibre39">by-pairs</span></span> works:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(by-pairs [:h :t  :t :h :h :h])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ((:h :t) (:t :t) (:t :h) (:h :h) (:h :h))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now that you can think of the coin tosses as a sequence <span class="italic">of pairs</span> of results, it is easy to describe <span class="calibre8"><span class="calibre39">count-heads-pairs</span></span> in English: </p><p class="calibre12">“Count the pairs of results that are all heads.”</p><p class="calibre12"> This English description translates directly into existing sequence library functions: “Count” is <span class="calibre8"><span class="calibre39">count</span></span>, of course, and “that are all heads” suggests a <span class="calibre8"><span class="calibre39">filter</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/functional.clj"><span class="calibre41"><span class="underline">src/examples/functional.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> count-heads-pairs [coll]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">count</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">filter</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">fn</span></span></span><span class="calibre8"> [pair] (</span><span class="calibre8"><span class="bold"><span class="calibre36">every?</span></span></span><span class="calibre8"> #(</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> :h %) pair))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                 (by-pairs coll))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> This is much more expressive than the <span class="calibre8"><span class="calibre39">recur</span></span>-based implementation, and it makes clear that we are counting all the adjacent pairs of heads. But we can make things even simpler. Clojure already has a more general version of <span class="calibre8"><span class="calibre39">by-pairs</span></span> named <span class="calibre8"><span class="calibre39">partition</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">partition</span></span></span><span class="calibre8"> size step? coll)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">partition</span></span> breaks a collection into chunks of size <span class="calibre8"><span class="calibre39">size</span></span>. So, you could break a heads/tails vector into a sequence of pairs: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(partition 2 [:h :t  :t :h :h :h])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ((:h :t) (:t :h) (:h :h))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> That isn’t quite the same as <span class="calibre8"><span class="calibre39">by-pairs</span></span>, which yields overlapping pairs. But <span class="calibre8"><span class="calibre39">partition</span></span> can do overlaps too. The optional <span class="calibre8"><span class="calibre39">step</span></span> argument determines how far <span class="calibre8"><span class="calibre39">partition</span></span> moves down the collection before starting its next chunk. If not specified, <span class="calibre8"><span class="calibre39">step</span></span> is the same as <span class="calibre8"><span class="calibre39">size</span></span>. To make <span class="calibre8"><span class="calibre39">partition</span></span> work like <span class="calibre8"><span class="calibre39">by-pairs</span></span>, set <span class="calibre8"><span class="calibre39">size</span></span> to <span class="calibre8"><span class="calibre39">2</span></span> and set <span class="calibre8"><span class="calibre39">step</span></span> to <span class="calibre8"><span class="calibre39">1</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(partition 2 1 [:h :t  :t :h :h :h])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ((:h :t) (:t :t) (:t :h) (:h :h) (:h :h))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(by-pairs [:h :t  :t :h :h :h])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ((:h :t) (:t :t) (:t :h) (:h :h) (:h :h))​</span><span class="calibre8">
</span>
</td></tr></table><blockquote class="calibre47"><span class="calibre41"><span class="bold">Faces of def</span></span></blockquote><blockquote class="calibre48"><span class="calibre41"> Throughout the book you will use various </span><span class="calibre8"><span class="calibre39">def</span></span><span class="calibre41"> forms to create vars, such as </span><span class="calibre8"><span class="calibre39">defn</span></span><span class="calibre41">, </span><span class="calibre8"><span class="calibre39">defmacro</span></span><span class="calibre41">, and </span><span class="calibre8"><span class="calibre39">defmulti</span></span><span class="calibre41">. These forms are all eventually wrappers around the </span><span class="calibre8"><span class="calibre39">def</span></span><span class="calibre41"> special form. </span></blockquote><blockquote class="calibre61"><span class="calibre8"><span class="calibre39">defonce</span></span><span class="calibre41"> ensures that a var exists and sets the root binding for the var </span><span class="calibre41"><span class="italic">only if it is not already set</span></span><span class="calibre41">: </span></blockquote><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span><span class="calibre41">
</span></td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defonce</span></span></span><span class="calibre8"> a-symbol initial-value?)​</span><span class="calibre8"><span class="calibre37">
</span></span><span class="calibre41">
</span></td></tr></table><blockquote class="calibre49"><span class="calibre8"><span class="calibre39">defn-</span></span><span class="calibre41"> works just like </span><span class="calibre8"><span class="calibre39">defn</span></span><span class="calibre41"> but yields a </span><span class="calibre41"><span class="italic">private</span></span><span class="calibre41"> function that is accessible only in the namespace where it was defined. </span></blockquote><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span><span class="calibre41">
</span></td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn-</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">name</span></span></span><span class="calibre8"> &amp; args-as-for-defn)​</span><span class="calibre8"><span class="calibre37">
</span></span><span class="calibre41">
</span></td></tr></table><blockquote class="calibre49"><span class="calibre41"> Many other </span><span class="calibre8"><span class="calibre39">def</span></span><span class="calibre41"> forms also have dash-suffixed variants that are private. </span></blockquote><p class="calibre50"> Another possible area of improvement is the <span class="calibre8"><span class="calibre39">count</span></span>/<span class="calibre8"><span class="calibre39">filter</span></span> idiom used to count the pairs that are both heads. This combination comes up often enough that it is worth encapsulating in a <span class="calibre8"><span class="calibre39">count-if</span></span> function: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/functional.clj"><span class="calibre41"><span class="underline">src/examples/functional.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> ^{:doc </span><span class="calibre8"><span class="italic"><span class="calibre42">"Count items matching a filter"</span></span></span><span class="calibre8">}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  count-if (</span><span class="calibre8"><span class="bold"><span class="calibre36">comp</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">count</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">filter</span></span></span><span class="calibre8">))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">comp</span></span> is used to <span class="italic">compose</span> two or more functions: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">comp</span></span></span><span class="calibre8"> f &amp; fs)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> The composed function is a new function that applies the rightmost function to its arguments, the next-rightmost function to that result, and so on. So, <span class="calibre8"><span class="calibre39">count-if</span></span> will first <span class="calibre8"><span class="calibre39">filter</span></span> and then <span class="calibre8"><span class="calibre39">count</span></span> the results of the <span class="calibre8"><span class="calibre39">filter</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(count-if odd? [1 2 3 4 5])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 3​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Finally, you can use <span class="calibre8"><span class="calibre39">count-if</span></span> and <span class="calibre8"><span class="calibre39">partition</span></span> to create a <span class="calibre8"><span class="calibre39">count-runs</span></span> function that is more general than <span class="calibre8"><span class="calibre39">count-heads-pairs</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/functional.clj"><span class="calibre41"><span class="underline">src/examples/functional.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> count-runs​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​ </span><span class="calibre8"><span class="italic"><span class="calibre42">"Count runs of length n where pred is true in coll."</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​ [n pred coll]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​ (count-if #(</span><span class="calibre8"><span class="bold"><span class="calibre36">every?</span></span></span><span class="calibre8"> pred %) (</span><span class="calibre8"><span class="bold"><span class="calibre36">partition</span></span></span><span class="calibre8"> n 1 coll)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">count-runs</span></span> is a winning combination: both simpler and more general than the previous versions of <span class="calibre8"><span class="calibre39">count-heads-pairs</span></span>. You can use it to count pairs of heads: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(count-runs 2 #(= % :h) [:h :t :t :h :h :h])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 2​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">But you can just as easily use it to count pairs of tails:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(count-runs 2 #(= % :t) [:h :t :t :h :h :h])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 1​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Or, instead of pairs, how about runs of three heads in a row?</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(count-runs 3 #(= % :h) [:h :t :t :h :h :h])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 1​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If you still want to have a function named <span class="calibre8"><span class="calibre39">count-heads-pairs</span></span>, you can implement it in terms of <span class="calibre8"><span class="calibre39">count-runs</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/functional.clj"><span class="calibre41"><span class="underline">src/examples/functional.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> ^{:doc </span><span class="calibre8"><span class="italic"><span class="calibre42">"Count runs of length two that are both heads"</span></span></span><span class="calibre8">}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  count-heads-pairs (</span><span class="calibre8"><span class="bold"><span class="calibre36">partial</span></span></span><span class="calibre8"> count-runs 2 #(</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> % :h)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> This version of <span class="calibre8"><span class="calibre39">count-heads-pairs</span></span> builds a new function using <span class="calibre8"><span class="calibre39">partial</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">partial</span></span></span><span class="calibre8"> f &amp; partial-args)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">partial</span></span> performs a <span class="italic">partial application</span> of a function. You specify a function <span class="calibre8"><span class="calibre39">f</span></span> and part of the argument list when you perform the <span class="calibre8"><span class="calibre39">partial</span></span>. You specify the remainder of the argument list later, when you call the function created by <span class="calibre8"><span class="calibre39">partial</span></span>. So, the following: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">partial</span></span></span><span class="calibre8"> count-runs 1 #(</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> % :h))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">is a more expressive way of saying this:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(fn [coll] (count-runs 1 #(= % :h) coll))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Partial application is similar but not identical to <span class="italic">currying</span>. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Currying and Partial Application</span></span></span></p><p class="calibre44"> When you <span class="italic">curry</span> a function, you get a new function that takes one argument and returns the original function with that one argument fixed. (Curry is named for Haskell Curry, an American logician best known for his work in combinatory logic.) If Clojure had a curry, it might be implemented like this: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; almost a curry</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> faux-curry [&amp; args] (</span><span class="calibre8"><span class="bold"><span class="calibre36">apply</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">partial</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">partial</span></span></span><span class="calibre8"> args))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> One use of curry is partial application. Here is partial application in Clojure: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def add-3 (partial + 3))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(add-3 7)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 10​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> And here is partial application using our <span class="calibre8"><span class="calibre39">faux-curry</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def add-3 ((faux-curry +) 3))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(add-3 7)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 10​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If all you want is partial application, currying is just an intermediate step. Our <span class="calibre8"><span class="calibre39">faux-curry</span></span> is not a real curry. A real curry would return a result, not a function of no arguments, once all the arguments were fixed. You can see the difference here, using the function <span class="calibre8"><span class="calibre39">true?</span></span>, which takes only one argument: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​; faux curry​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​((faux-curry true?) (= 1 1))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #&lt;... mangled function name ...&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​; if the curry were real​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​((curry true?) (= 1 1))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Since Clojure functions can have variable-length argument lists, Clojure cannot know when all the arguments are fixed. But you, the programmer, do know when you are done adding arguments. Once you have curried as many arguments as you want, just invoke the function. That amounts to adding an extra set of parentheses around the earlier expression: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(((faux-curry true?) (= 1 1)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The absence of curry from <span class="calibre8"><span class="calibre39">Clojure</span></span> is not a major problem, since <span class="calibre8"><span class="calibre39">partial</span></span> is available and that is what people generally want out of curry anyway. In fact, many programmers use the terms <span class="italic">currying</span> and <span class="italic">partial application</span> interchangeably. </p><p class="calibre12"> You have seen a lot of new forms in this section. Do not let all the details obscure the key idea: by combining existing functions from the sequence library, you were able to create a solution that was both simpler and more general than the direct approach. And, you did not have to worry about laziness or recursion at all. Instead, you worked at a higher level of abstraction and let Clojure deal with laziness and recursion for you. </p><div class="mbppagebreak"></div><p id="filepos635309" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">4.4 Recursion Revisited</span></span></span></p><p class="calibre34"> Clojure works very hard to balance the power of functional programming with the reality of the Java Virtual Machine. One example of this is the well-motivated choice of explicit TCO through <span class="calibre8"><span class="calibre39">loop</span></span>/<span class="calibre8"><span class="calibre39">recur</span></span>. </p><p class="calibre12"> But blending the best of two worlds always runs the risk of unpleasant compromises, and it certainly makes sense to ask the question “Does Clojure contain hidden design compromises that, while not obvious on day one, will bite me later?” </p><p class="calibre12"> This question is <span class="italic">never</span> fully answerable for any language, but let’s consider it by exploring some more complex recursions. First we will look at <span class="italic">mutual recursion</span>. </p><p class="calibre12"> A mutual recursion occurs when the recursion bounces between two or more functions. Instead of A calls A calls A, you have A calls B calls A again. As a simple example, you could define <span class="calibre8"><span class="calibre39">my-odd?</span></span> and <span class="calibre8"><span class="calibre39">my-even?</span></span> using mutual recursion: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/functional.clj"><span class="calibre41"><span class="underline">src/examples/functional.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">declare</span></span></span><span class="calibre8"> my-odd? my-even?)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> my-odd? [n]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> n 0)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    false​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (my-even? (</span><span class="calibre8"><span class="bold"><span class="calibre36">dec</span></span></span><span class="calibre8"> n))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> my-even? [n]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> n 0)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    true​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (my-odd? (</span><span class="calibre8"><span class="bold"><span class="calibre36">dec</span></span></span><span class="calibre8"> n))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Because <span class="calibre8"><span class="calibre39">my-odd?</span></span> and <span class="calibre8"><span class="calibre39">my-even?</span></span> each call the other, you need to create both vars before actually defining the functions. You could do this with <span class="calibre8"><span class="calibre39">def</span></span>, but the <span class="calibre8"><span class="calibre39">declare</span></span> macro lets you create both vars (with no initial binding) in a single line of code. </p><p class="calibre12"> Verify that <span class="calibre8"><span class="calibre39">my-odd?</span></span> and <span class="calibre8"><span class="calibre39">my-even?</span></span> work for small values: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(map my-even? (range 10))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (true false true false true false true false true false)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(map my-odd? (range 10))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (false true false true false true false true false true)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">my-odd?</span></span> and <span class="calibre8"><span class="calibre39">my-even?</span></span> consume stack frames proportional to the size of their argument, so they will fail with large numbers. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(my-even? (* 1000 1000 1000))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; StackOverflowError clojure.lang.Numbers$LongOps.equiv (Numbers.java:490)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> This is very similar to the problem that motivated the introduction of <span class="calibre8"><span class="calibre39">recur</span></span>. But you cannot use <span class="calibre8"><span class="calibre39">recur</span></span> to fix it, because <span class="calibre8"><span class="calibre39">recur</span></span> works with self-recursion, not mutual recursion. Of course, odd/even can be implemented more efficiently <span class="italic">without</span> recursion anyway. Clojure’s implementation uses <span class="calibre8"><span class="calibre39">bit-and</span></span> (bitwise and) to implement <span class="calibre8"><span class="calibre39">odd?</span></span> and <span class="calibre8"><span class="calibre39">even?</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​; from core.clj​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defn even? [n] (zero? (bit-and n 1)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defn odd? [n] (not (even? n)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> We picked odd/even for its simplicity. Other recursive problems are not so simple and do not have an elegant nonrecursive solution. We will examine four approaches that you can use to solve such problems: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">Converting to self-recursion</p></li><a></a><li value="2" class="calibre30"><p class="calibre29">Trampolining a mutual recursion</p></li><a></a><li value="3" class="calibre30"><p class="calibre29">Replacing recursion with laziness</p></li><a></a><li value="4" class="calibre30"><p class="calibre29">Shortcutting recursion with memoization</p></li><a></a></ul><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Converting to Self-recursion</span></span></span></p><p class="calibre44"> Mutual recursion is often a nice way to model separate but related concepts. For example, oddness and evenness are separate concepts but clearly related to one another. </p><p class="calibre12"> You can convert a mutual recursion to a self-recursion by coming up with a single abstraction that deals with multiple concepts simultaneously. For example, you can think of oddness and evenness in terms of a single concept: <span class="italic">parity</span>. Define a <span class="calibre8"><span class="calibre39">parity</span></span> function that uses <span class="calibre8"><span class="calibre39">recur</span></span> and returns <span class="calibre8"><span class="calibre39">0</span></span> for even numbers and <span class="calibre8"><span class="calibre39">1</span></span> for odd numbers: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/functional.clj"><span class="calibre41"><span class="underline">src/examples/functional.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> parity [n]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">loop</span></span></span><span class="calibre8"> [n n par 0]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> n 0)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      par​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">recur</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">dec</span></span></span><span class="calibre8"> n) (</span><span class="calibre8"><span class="bold"><span class="calibre36">-</span></span></span><span class="calibre8"> 1 par)))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Test that parity works for small values:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(map parity (range 10))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (0 1 0 1 0 1 0 1 0 1)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> At this point, you can trivially implement <span class="calibre8"><span class="calibre39">my-odd?</span></span> and <span class="calibre8"><span class="calibre39">my-even?</span></span> in terms of parity: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/functional.clj"><span class="calibre41"><span class="underline">src/examples/functional.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> my-even? [n] (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> 0 (parity n)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> my-odd? [n] (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> 1 (parity n)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Parity is a straightforward concept. Unfortunately, many mutual recursions will not simplify down into an elegant self-recursion. If you try to convert a mutual recursion into a self-recursion and you find the resulting code to be full of conditional expressions that obfuscate the definition, then do not use this approach. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Trampolining Mutual Recursion</span></span></span></p><p class="calibre44"> A <span class="italic">trampoline</span> is a technique for optimizing mutual recursion. A trampoline is like an after-the-fact <span class="calibre8"><span class="calibre39">recur</span></span>, imposed by the <span class="italic">caller</span> of a function instead of the <span class="italic">implementer</span>. Since the caller can call more than one function inside a trampoline, trampolines can optimize mutual recursion. </p><p class="calibre12"> Clojure’s <span class="calibre8"><span class="calibre39">trampoline</span></span> function invokes one of your mutually recursive functions: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">trampoline</span></span></span><span class="calibre8"> f &amp; partial-args)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> If the return value is not a function, then a trampoline works just like calling the function directly. Try trampolining a few simple Clojure functions: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(trampoline list)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ()​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(trampoline + 1 2)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 3​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If the return value <span class="italic">is</span> a function, then <span class="calibre8"><span class="calibre39">trampoline</span></span> assumes you want to call it recursively and calls it for you. <span class="calibre8"><span class="calibre39">trampoline</span></span> manages its own <span class="calibre8"><span class="calibre39">recur</span></span>, so it will keep calling your function until it stops returning functions. </p><p class="calibre12"> Back in <a href="#filepos564148">​<span class="italic">Tail Recursion</span>​</a>, you implemented a <span class="calibre8"><span class="calibre39">tail-fibo</span></span> function. You saw how the function consumed stack space and replaced the tail recursion with a <span class="calibre8"><span class="calibre39">recur</span></span>. Now you have another option. You can take the code of <span class="calibre8"><span class="calibre39">tail-fibo</span></span> and prepare it for trampolining by wrapping the recursive return case inside a function. </p><p class="calibre12"> This requires adding only a single character, the <span class="calibre8"><span class="calibre39">#</span></span>, to introduce an anonymous function: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/trampoline.clj"><span class="calibre41"><span class="underline">src/examples/trampoline.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">Line 1</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; Example only. Don't write code like this.</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> trampoline-fibo [n]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [fib (</span><span class="calibre8"><span class="bold"><span class="calibre36">fn</span></span></span><span class="calibre8"> fib [f-2 f-1 current]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​              (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [f (</span><span class="calibre8"><span class="bold"><span class="calibre36">+</span></span></span><span class="calibre8"> f-2 f-1)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">5</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> n current)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                  f​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                  #(fib f-1 f (</span><span class="calibre8"><span class="bold"><span class="calibre36">inc</span></span></span><span class="calibre8"> current)))))] ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">cond</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> n 0) 0​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">10</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> n 1) 1​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   :else (fib 0N 1 2))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The only difference between this and the original version of <span class="calibre8"><span class="calibre39">tail-fibo</span></span> is the initial <span class="calibre8"><span class="calibre39">#</span></span> on line 7. Try bouncing <span class="calibre8"><span class="calibre39">trampoline-fibo</span></span> on a <span class="calibre8"><span class="calibre39">trampoline</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(trampoline trampoline-fibo 9)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 34N​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Since <span class="calibre8"><span class="calibre39">trampoline</span></span> does a <span class="calibre8"><span class="calibre39">recur</span></span> for you, it can handle large inputs just fine, without throwing a <span class="calibre8"><span class="calibre39">StackOverflowError</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(rem (trampoline trampoline-fibo 1000000) 1000)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 875N​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> We have ported <span class="calibre8"><span class="calibre39">tail-fibo</span></span> to use <span class="calibre8"><span class="calibre39">trampoline</span></span> in order to compare and contrast <span class="calibre8"><span class="calibre39">trampoline</span></span> and <span class="calibre8"><span class="calibre39">recur</span></span>. For self-recursions like <span class="calibre8"><span class="calibre39">trampoline-fibo</span></span>, <span class="calibre8"><span class="calibre39">trampoline</span></span> offers no advantage, and you should prefer <span class="calibre8"><span class="calibre39">recur</span></span>. But with mutual recursion, <span class="calibre8"><span class="calibre39">trampoline</span></span> comes into its own. </p><p class="calibre12"> Consider the mutually recursive definition of <span class="calibre8"><span class="calibre39">my-odd?</span></span> and <span class="calibre8"><span class="calibre39">my-even?</span></span>, which we presented at the beginning of Section 4.4, <a href="#filepos635309">​<span class="italic">Recursion Revisited</span>​</a>. You can convert these broken, stack-consuming implementations to use <span class="calibre8"><span class="calibre39">trampoline</span></span> using the same approach you used to convert <span class="calibre8"><span class="calibre39">tail-fibo</span></span>: simply prepend a <span class="calibre8"><span class="calibre39">#</span></span> to any recursive tail calls: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/trampoline.clj"><span class="calibre41"><span class="underline">src/examples/trampoline.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">Line 1</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">declare</span></span></span><span class="calibre8"> my-odd? my-even?)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> my-odd? [n]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> n 0)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">5</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    false​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    #(my-even? (</span><span class="calibre8"><span class="bold"><span class="calibre36">dec</span></span></span><span class="calibre8"> n)))) ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> my-even? [n]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> n 0)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">10</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    true​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    #(my-odd? (</span><span class="calibre8"><span class="bold"><span class="calibre36">dec</span></span></span><span class="calibre8"> n)))) ​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The only difference from the original implementation is the <span class="calibre8"><span class="calibre39">#</span></span> wrappers on lines 6 and 11. With this change in place, you can <span class="calibre8"><span class="calibre39">trampoline</span></span> large values of <span class="calibre8"><span class="calibre39">n</span></span> without blowing the stack: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(trampoline my-even? 1000000)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> A trampoline is a special-purpose solution to a specific problem. It requires doctoring your original functions to return a different type to indicate recursion. If one of the other techniques presented here provides a more elegant implementation for a particular recursion, that is great. If not, you will be happy to have <span class="calibre8"><span class="calibre39">trampoline</span></span> in your box of tools. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Replacing Recursion with Laziness</span></span></span></p><p class="calibre44"> Of all the techniques for eliminating or optimizing recursion discussed in this chapter, laziness is the one you will probably use most often. </p><p class="calibre12"> For our example, we will implement the <span class="calibre8"><span class="calibre39">replace</span></span> function developed by Eugene Wallingford to demonstrate mutual recursion. (See <a href="http://www.cs.uni.edu/~wallingf/patterns/recursion.html">http://www.cs.uni.edu/~wallingf/patterns/recursion.html</a>.) </p><p class="calibre12"><span class="calibre8"><span class="calibre39">replace</span></span> works with an <span class="italic">s-list</span> data structure, which is a list that can contain both symbols and lists of symbols. <span class="calibre8"><span class="calibre39">replace</span></span> takes an <span class="calibre8"><span class="calibre39">s-list</span></span>, an <span class="calibre8"><span class="calibre39">oldsym</span></span>, and a <span class="calibre8"><span class="calibre39">newsym</span></span> and replaces all occurrences of <span class="calibre8"><span class="calibre39">oldsym</span></span> with <span class="calibre8"><span class="calibre39">newsym</span></span>. For example, this call to <span class="calibre8"><span class="calibre39">replace</span></span> replaces all occurrences of <span class="calibre8"><span class="calibre39">b</span></span> with <span class="calibre8"><span class="calibre39">a</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(replace '((a b) (((b g r) (f r)) c (d e)) b) 'b 'a)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ((a a) (((a g r) (f r)) c (d e)) a)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The following is a fairly literal translation of the Scheme implementation from Wallingford’s paper. We have converted from Scheme functions to Clojure functions, changed the name to <span class="calibre8"><span class="calibre39">replace-symbol</span></span> to avoid collision with Clojure’s <span class="calibre8"><span class="calibre39">replace</span></span>, and shortened names to better fit the printed page, but we otherwise have preserved the structure of the original: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/wallingford.clj"><span class="calibre41"><span class="underline">src/examples/wallingford.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; overly-literal port, do not use</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">declare</span></span></span><span class="calibre8"> replace-symbol replace-symbol-expression)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> replace-symbol [coll oldsym newsym]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">empty?</span></span></span><span class="calibre8"> coll)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    ()​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">cons</span></span></span><span class="calibre8"> (replace-symbol-expression​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​           (</span><span class="calibre8"><span class="bold"><span class="calibre36">first</span></span></span><span class="calibre8"> coll) oldsym newsym)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          (replace-symbol​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​           (</span><span class="calibre8"><span class="bold"><span class="calibre36">rest</span></span></span><span class="calibre8"> coll) oldsym newsym))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> replace-symbol-expression [symbol-expr oldsym newsym]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">symbol?</span></span></span><span class="calibre8"> symbol-expr)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> symbol-expr oldsym)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      newsym​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      symbol-expr)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (replace-symbol symbol-expr oldsym newsym)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The two functions <span class="calibre8"><span class="calibre39">replace-symbol</span></span> and <span class="calibre8"><span class="calibre39">replace-symbol-expression</span></span> are mutually recursive, so a deeply nested structure could blow the stack. To demonstrate the problem, create a <span class="calibre8"><span class="calibre39">deeply-nested</span></span> function that builds deeply nested lists containing a single <span class="calibre8"><span class="calibre39">bottom</span></span> element: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/replace_symbol.clj"><span class="calibre41"><span class="underline">src/examples/replace_symbol.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> deeply-nested [n]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">loop</span></span></span><span class="calibre8"> [n n​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​         result '(bottom)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> n 0)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      result​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">recur</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">dec</span></span></span><span class="calibre8"> n) (</span><span class="calibre8"><span class="bold"><span class="calibre36">list</span></span></span><span class="calibre8"> result)))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Try <span class="calibre8"><span class="calibre39">deeply-nested</span></span> for a few small values of <span class="calibre8"><span class="calibre39">n</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(deeply-nested 5)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ((((((bottom))))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(deeply-nested 25)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (((((((((((((((((((((((((bottom)))))))))))))))))))))))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Clojure provides a <span class="calibre8"><span class="calibre39">*print-level*</span></span> that controls how deeply the Clojure printer will go into a nested data structure. Set the <span class="calibre8"><span class="calibre39">*print-level*</span></span> to a modest value so that the printer doesn’t go crazy trying to print a deeply nested structure. You will see that when nesting deeper, the printer simply prints a <span class="calibre8"><span class="calibre39">#</span></span> and stops: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(set! *print-level* 25)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 25​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(deeply-nested 5)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ((((((bottom))))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(deeply-nested 25)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (((((((((((((((((((((((((#)))))))))))))))))))))))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now, try to use <span class="calibre8"><span class="calibre39">replace-symbol</span></span> to change <span class="calibre8"><span class="calibre39">bottom</span></span> to <span class="calibre8"><span class="calibre39">deepest</span></span> for different levels of nesting. You will see that large levels blow the stack. Depending on your JVM implementation, you may need a larger value than the <span class="calibre8"><span class="calibre39">10000</span></span> shown here: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(replace-symbol (deeply-nested 5) 'bottom 'deepest)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ((((((deepest))))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(replace-symbol (deeply-nested 10000) 'bottom 'deepest)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.lang.StackOverflowError​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> All of the recursive calls to <span class="calibre8"><span class="calibre39">replace-symbol</span></span> are inside a <span class="calibre8"><span class="calibre39">cons</span></span>. To break the recursion, all you have to do is wrap the recursion with <span class="calibre8"><span class="calibre39">lazy-seq</span></span>. <span class="italic">It’s really that simple.</span> You can break a sequence-generating recursion by wrapping it with a <span class="calibre8"><span class="calibre39">lazy-seq</span></span>. Here’s the improved version. Since the transition to laziness was so simple, we could not resist the temptation to make the function more Clojurish in another way as well: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/replace_symbol.clj"><span class="calibre41"><span class="underline">src/examples/replace_symbol.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">Line 1</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn-</span></span></span><span class="calibre8"> coll-or-scalar [x &amp; _] (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">coll?</span></span></span><span class="calibre8"> x) :collection :scalar))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">2</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmulti</span></span></span><span class="calibre8"> replace-symbol coll-or-scalar) ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">3</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> replace-symbol :collection [coll oldsym newsym]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">4</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">lazy-seq</span></span></span><span class="calibre8"> ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">5</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   (</span><span class="calibre8"><span class="bold"><span class="calibre36">when</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">seq</span></span></span><span class="calibre8"> coll)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">6</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">cons</span></span></span><span class="calibre8"> (replace-symbol (</span><span class="calibre8"><span class="bold"><span class="calibre36">first</span></span></span><span class="calibre8"> coll) oldsym newsym)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">7</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          (replace-symbol (</span><span class="calibre8"><span class="bold"><span class="calibre36">rest</span></span></span><span class="calibre8"> coll) oldsym newsym)))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">8</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> replace-symbol :scalar [obj oldsym newsym]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">9</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> obj oldsym) newsym obj))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> On line 4, the <span class="calibre8"><span class="calibre39">lazy-seq</span></span> breaks the recursion, preventing stack overflow on deeply nested structures. The other improvement is on line 2. Rather than have two different functions to deal with symbols and lists, there is a single multimethod <span class="calibre8"><span class="calibre39">replace-symbol</span></span> with one method for lists and another for symbols. (Multimethods are covered in detail in Chapter 8, <a href="#filepos1149215">​<span class="italic">Multimethods</span>​</a>.) This gets rid of an <span class="calibre8"><span class="calibre39">if</span></span> form and improves readability. </p><p class="calibre12"> Make sure the improved <span class="calibre8"><span class="calibre39">replace-symbol</span></span> can handle deep nesting: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(replace-symbol (deeply-nested 10000) 'bottom 'deepest)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (((((((((((((((((((((((((#)))))))))))))))))))))))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Laziness is a powerful ally. You can often write recursive and even mutually recursive functions and then break the recursion with laziness. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Shortcutting Recursion with Memoization</span></span></span></p><p class="calibre44"> To demonstrate a more complex mutual recursion, we will look at the Hofstadter Female and Male sequences. The first Hofstadter sequences were described in <span class="italic">Gödel, Escher, Bach: An Eternal Golden Braid</span> [Hof99]. The Female and Male sequences are defined as follows:<a id="filepos682368"></a><a href="#filepos699230">[40]</a>
</p><p class="calibre12"><span class="italic">F(0) = 1; M(0) = 0</span>
</p><p class="calibre12"><span class="italic">F(n) = n - M(F(n-1)), n &gt; 0</span>
</p><p class="calibre12"><span class="italic">M(n) = n - F(M(n-1)), n &gt; 0</span>
</p><p class="calibre12">This suggests a straightforward definition in Clojure:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/male_female.clj"><span class="calibre41"><span class="underline">src/examples/male_female.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; do not use these directly</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">declare</span></span></span><span class="calibre8"> m f)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> m [n]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">zero?</span></span></span><span class="calibre8"> n)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    0​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">-</span></span></span><span class="calibre8"> n (f (m (</span><span class="calibre8"><span class="bold"><span class="calibre36">dec</span></span></span><span class="calibre8"> n))))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> f [n]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">zero?</span></span></span><span class="calibre8"> n)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    1​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">-</span></span></span><span class="calibre8"> n (m (f (</span><span class="calibre8"><span class="bold"><span class="calibre36">dec</span></span></span><span class="calibre8"> n))))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The Clojure definition is easy to read and closely parallels the mathematical definition. However, it performs <span class="italic">terribly</span> for large values of <span class="calibre8"><span class="calibre39">n</span></span>. Each value in the sequence requires calculating two other values from scratch, which in turn requires calculating two other values from scratch. On one of our MacBook Pro computers,<a id="filepos686173"></a><a href="#filepos699502">[41]</a> it takes more than half a minute to calculate <span class="calibre8"><span class="calibre39">(m 250)</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(time (m 250))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​"Elapsed time: 38443.902083 msecs"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 155​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Is it possible to preserve the clean, mutually recursive definition <span class="italic">and</span> have decent performance? Yes, with a little help from <span class="italic">memoization</span>. Memoization trades space for time by caching the results of past calculations. When you call a memoized function, it first checks your input against a map of previous inputs and their outputs. If it finds the input in the map, it can return the output immediately, without having to perform the calculation again. </p><p class="calibre12"> Rebind <span class="calibre8"><span class="calibre39">m</span></span> and <span class="calibre8"><span class="calibre39">f</span></span> to memoized versions of themselves, using Clojure’s <span class="calibre8"><span class="calibre39">memoize</span></span> function: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/memoized_male_female.clj"><span class="calibre41"><span class="underline">src/examples/memoized_male_female.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> m (</span><span class="calibre8"><span class="bold"><span class="calibre36">memoize</span></span></span><span class="calibre8"> m))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> f (</span><span class="calibre8"><span class="bold"><span class="calibre36">memoize</span></span></span><span class="calibre8"> f))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now Clojure needs to calculate <span class="italic">F</span> and <span class="italic">M</span> only once for each <span class="italic">n</span>. The speedup is enormous. Calculating <span class="calibre8"><span class="calibre39">(m 250)</span></span> is thousands of times faster: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(time (m 250))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​"Elapsed time: 5.190739 msecs"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 155​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">And, of course, once the memoization cache is built, “calculation” of a cached value is almost instantaneous:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(time (m 250))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​"Elapsed time: 0.065877 msecs"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 155​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Memoization alone is not enough, however. Memoization shortcuts the recursion only if the memoization cache is already populated. If you start with an empty cache and ask for <span class="calibre8"><span class="calibre39">m</span></span> or <span class="calibre8"><span class="calibre39">f</span></span> of a large number, you will blow the stack before the cache can be built: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(m 10000)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.lang.StackOverflowError​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The final trick is to guarantee that the cache is built from the ground up by exposing <span class="italic">sequences</span>, instead of <span class="italic">functions</span>. Create <span class="calibre8"><span class="calibre39">m-seq</span></span> and <span class="calibre8"><span class="calibre39">f-seq</span></span> by mapping <span class="calibre8"><span class="calibre39">m</span></span> and <span class="calibre8"><span class="calibre39">f</span></span> over the whole numbers: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/male_female_seq.clj"><span class="calibre41"><span class="underline">src/examples/male_female_seq.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> m-seq (</span><span class="calibre8"><span class="bold"><span class="calibre36">map</span></span></span><span class="calibre8"> m (</span><span class="calibre8"><span class="bold"><span class="calibre36">iterate</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">inc</span></span></span><span class="calibre8"> 0)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> f-seq (</span><span class="calibre8"><span class="bold"><span class="calibre36">map</span></span></span><span class="calibre8"> f (</span><span class="calibre8"><span class="bold"><span class="calibre36">iterate</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">inc</span></span></span><span class="calibre8"> 0)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now callers can get <span class="italic">M(n)</span> or <span class="italic">F(n)</span> by taking the <span class="calibre8"><span class="calibre39">nth</span></span> value from a sequence: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(nth m-seq 250)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 155​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">The approach is quite fast, even for larger values of <span class="calibre8"><span class="calibre39">n</span></span>:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(time (nth m-seq 10000))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​"Elapsed time: 0.735 msecs"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 6180​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">The approach we have used here is as follows:</p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">Define a mutually recursive function in a natural way.</p></li><a></a><li value="2" class="calibre30"><p class="calibre29">Use memoization in order to shortcut recursion for values that have already been calculated.</p></li><a></a><li value="3" class="calibre30"><p class="calibre29">Expose a sequence so that dependent values are cached before they are needed.</p></li><a></a></ul><p class="calibre12"> This approach <span class="italic">is</span> heap-consuming, in that it does cache all previously seen values. If this is a problem, you can in some situations eliminate it by selecting a more complex caching policy. </p><div class="mbppagebreak"></div><p id="filepos694806" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">4.5 Wrapping Up</span></span></span></p><p class="calibre34"> In this chapter you’ve seen how Clojure’s support for FP strikes a well-motivated balance between academic purity and effectiveness on the Java Virtual Machine. Clojure provides a wide variety of techniques including self-recursion with <span class="calibre8"><span class="calibre39">recur</span></span>, mutual recursion with <span class="calibre8"><span class="calibre39">trampoline</span></span>, lazy sequences, and memoization. </p><p class="calibre12"> Better still, for a wide variety of everyday programming tasks, you can use the sequence library, without ever having to define your own explicit recursions of lazy sequences. Functions like <span class="calibre8"><span class="calibre39">partition</span></span> create clean, expressive solutions that are much easier to write. </p><p class="calibre12"> If Clojure were an exclusively FP language, we would turn our attention next to the challenges of living in a world without mutable state and perhaps begin discussing the state monad. But Clojure leads us in a different direction with its most innovative feature: explicit APIs for managing mutable state. Clojure reference model provides four different semantics to model state and is what we’ll tackle in Chapter 5, <a href="#filepos699699">​<span class="italic">State</span>​</a>. </p><p class="calibre27"><span class="calibre8"><span class="bold"><span class="calibre28">Footnotes</span></span></span></p><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos540247"><span class="calibre8">[33]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://norvig.com/21-days.html"><span class="calibre8">http://norvig.com/21-days.html</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos696623"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos547979"><span class="calibre8">[34]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://lampwww.epfl.ch/papers/idealhashtrees.pdf"><span class="calibre8">http://lampwww.epfl.ch/papers/idealhashtrees.pdf</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos696960"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos548172"><span class="calibre8">[35]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://tinyurl.com/clojure-persistent-vector"><span class="calibre8">http://tinyurl.com/clojure-persistent-vector</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos697289"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos557717"><span class="calibre8">[36]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://en.wikipedia.org/wiki/Fibonacci_number"><span class="calibre8">http://en.wikipedia.org/wiki/Fibonacci_number</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos697620"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos563217"><span class="calibre8">[37]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><span class="calibre8"> For more on how the JVM manages its stack, see “Runtime Data Areas” at </span><a href="http://tinyurl.com/jvm-spec-toc"><span class="calibre8">http://tinyurl.com/jvm-spec-toc</span></a><span class="calibre8">. </span></p></td></tr><a id="filepos698022"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos571376"><span class="calibre8">[38]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><span class="calibre8"> On today’s JVMs, languages can provide automatic TCO for </span><span class="calibre8"><span class="italic">some</span></span><span class="calibre8"> kinds of recursion but not for </span><span class="calibre8"><span class="italic">all</span></span><span class="calibre8">. Since there is no general solution, Clojure forces you to be explicit. When and if general TCO becomes widely supported on the JVM, Clojure will support it as well. </span></p></td></tr><a id="filepos698593"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos600150"><span class="calibre8">[39]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><span class="calibre8">Hat tip to Jeff Brown, who posed this problem over breakfast at a No Fluff, Just Stuff symposium.</span></p></td></tr><a id="filepos698893"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos682368"><span class="calibre8">[40]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://en.wikipedia.org/wiki/Hofstadter_sequence"><span class="calibre8">http://en.wikipedia.org/wiki/Hofstadter_sequence</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos699230"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos686173"><span class="calibre8">[41]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><span class="calibre8">3.06 GHz Intel Core 2 Duo, 4 GB 667 MHz DDR2 SDRAM, Ubuntu 10.10, SSD</span></p></td></tr><a id="filepos699502"></a></table><p class="calibre18"><span class="calibre8"><span class="calibre19"><span class="calibre20">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="mbppagebreak"></div><p id="filepos699699" class="calibre25"><span class="calibre2"><span class="bold"><span class="calibre43"> Chapter 5</span></span></span></p><br class="calibre11"/><p class="calibre26"><span class="calibre2"><span class="bold"><span class="calibre3">State</span></span></span></p><p class="calibre12"> A <span class="italic">state</span> is the value of an identity at a point in time. </p><p class="calibre12"> Quite a lot is packed into the previous sentence. Let’s unpack the word <span class="italic">value</span> first. A value is an immutable, persistent data structure. When you can program entirely with values, life is easy, as we saw in Chapter 4, <a href="#filepos539895">​<span class="italic">Functional Programming</span>​</a>. </p><p class="calibre12"> The flow of time makes things substantially more difficult. Are the New York Yankees the same now as they were last year? In 1927? The roster of the Yankees is an <span class="italic">identity</span> whose value changes over time. </p><p class="calibre12"> Updating an identity does not destroy old values. In fact, updating an identity has no impact on existing values whatsoever. The Yankees could trade every player, or disband in a fit of boredom, without in any way altering our ability to think about any past Yankees we happen to care about. </p><p class="calibre12"> Clojure’s reference model clearly separates identities from values. Almost everything in Clojure is a value. For identities, Clojure provides four reference types: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Refs manage <span class="italic">coordinated, synchronous</span> changes to shared state. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Atoms manage <span class="italic">uncoordinated, synchronous</span> changes to shared state. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> Agents manage <span class="italic">asynchronous</span> changes to shared state. </p></li><a></a><li value="4" class="calibre30"><p class="calibre29"> Vars manage <span class="italic">thread-local</span> state.</p></li><a></a></ul><p class="calibre12"> Each of these APIs is discussed in this chapter. At the end of the chapter, we will develop a sample application. The Snake game demonstrates how to divide an application model into immutable and mutable components. </p><p class="calibre12"> Before we start, we will review the intersection of state with concurrency and parallelism, as well as comment on the difficulty with traditional lock-based approaches. </p><div class="mbppagebreak"></div><p id="filepos702197" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">5.1 Concurrency, Parallelism, and Locking</span></span></span></p><p class="calibre34"> A concurrent program models more than one thing happening simultaneously. A parallel program takes an operation that could be sequential and chooses to break it into separate pieces that can execute concurrently to speed overall execution. </p><p class="calibre12">There are many reasons to write concurrent or parallel programs:</p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> For decades, performance improvements have come from packing more power into cores. Now, and for the near future, performance improvements will come from using more cores. Our hardware is itself more concurrent than ever, and systems must be concurrent to take advantage of this power. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Expensive computations may need to execute in parallel on multiple cores (or multiple boxes) in order to complete in a timely manner. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> Tasks that are blocked waiting for a resource should stand down and let other tasks use available processors. </p></li><a></a><li value="4" class="calibre30"><p class="calibre29"> User interfaces need to remain responsive while performing long-running tasks. </p></li><a></a><li value="5" class="calibre30"><p class="calibre29"> Operations that are logically independent are easier to implement if the platform can recognize and take advantage of their independence. </p></li><a></a></ul><p class="calibre12"> Concurrency makes it glaringly obvious that more than one observer (e.g., thread) may be looking at your data. This is a big problem for languages that complect<a id="filepos704109"></a><a href="#filepos864551">[42]</a> value and identity. Such languages treat a piece of data as a bank ledger with only one line. Each new operation erases history, potentially corrupting the work of every other thread on the system. </p><p class="calibre12"> While concurrency makes the challenges more obvious, it is a mistake to assume that multiple observers come into play only with concurrency. If your program ever has two variables that refer to the same data, those variables are different observers. If your program allows mutability at all, then you must think carefully about state. </p><p class="calibre12"> Mutable languages tend to tackle the challenge by locking and defensive copying. Continuing the ledger analogy: the bank hires guards (locks) to supervise the activities of anybody using a ledger, and nobody is allowed to modify a ledger while anybody else is using it. </p><p class="calibre12"> When the performance becomes really bad, the bank may even ask ledger readers to make their own private copies of the ledger so they can get out of the way and let transactions continue. These copies must still be supervised by the guards! </p><p class="calibre12"> As irritating as this model sounds, it gets worse at the level of implementation detail. Choosing what and where to lock is a difficult task. If you get it wrong, all sorts of bad things can happen. <span class="italic">Race conditions</span> between threads can corrupt data. <span class="italic">Deadlocks</span> can stop an entire program from functioning at all. <span class="italic">Java Concurrency in Practice</span> [Goe06] covers these and other problems, plus their solutions, in detail. It is a terrific book, but it is difficult to read it and not ask yourself, “Is there another way?” </p><p class="calibre12"> Clojure’s model for state and identity solves these problems. The bulk of program code is functional. The small parts of the codebase that truly benefit from mutability are distinct and must explicitly select one of four reference models. Using these models, you can split your models into two layers: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> A <span class="italic">functional model</span> that has no mutable state. Most of your code will normally be in this layer, which is easier to read, easier to test, and easier to parallelize. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"><span class="italic">Reference models</span> for the parts of the application that you find more convenient to deal with using mutable state (despite its disadvantages). </p></li><a></a></ul><p class="calibre12"> Let’s get started working with state in Clojure, using the most notorious of Clojure’s reference models: software transactional memory. </p><div class="mbppagebreak"></div><p id="filepos706924" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">5.2 Refs and Software Transactional Memory</span></span></span></p><p class="calibre34"> Most objects in Clojure are immutable. When you really want mutable data, you must be explicit about it, such as by creating a mutable <span class="italic">reference</span> (ref) to an immutable object. You create a ref with this: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">ref</span></span></span><span class="calibre8"> initial-state)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> For example, you could create a reference to the current song in your music playlist: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def current-track (ref "Mars, the Bringer of War"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/current-track​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The ref wraps and protects access to its internal state. To read the contents of the reference, you can call <span class="calibre8"><span class="calibre39">deref</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">deref</span></span></span><span class="calibre8"> reference)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">deref</span></span> function can be shortened to the <span class="calibre8"><span class="calibre39">@</span></span> reader macro. Try using both <span class="calibre8"><span class="calibre39">deref</span></span> and <span class="calibre8"><span class="calibre39">@</span></span> to dereference <span class="calibre8"><span class="calibre39">current-track</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(deref current-track)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Mars, the Bringer of War"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​@current-track​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Mars, the Bringer of War"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Notice how in this example the Clojure model fits the real world. A track is an immutable entity. It doesn’t change into another track when you are finished listening to it. But the <span class="italic">current</span> track is a reference to an entity, and it does change. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">ref-set</span></span></span></p><p class="calibre44"> You can change where a reference points with <span class="calibre8"><span class="calibre39">ref-set</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">ref-set</span></span></span><span class="calibre8"> reference new-value)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38">Call <span class="calibre8"><span class="calibre39">ref-set</span></span> to listen to a different track:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(ref-set current-track "Venus, the Bringer of Peace")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.lang.IllegalStateException: No transaction running​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Oops. Because refs are mutable, you must protect their updates. In many languages, you would use a <span class="italic">lock</span> for this purpose. In Clojure, you can use a <span class="italic">transaction</span>. Transactions are wrapped in a <span class="calibre8"><span class="calibre39">dosync</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">dosync</span></span></span><span class="calibre8"> &amp; exprs)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Wrap your <span class="calibre8"><span class="calibre39">ref-set</span></span> with a <span class="calibre8"><span class="calibre39">dosync</span></span>, and all is well. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(dosync (ref-set current-track "Venus, the Bringer of Peace"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Venus, the Bringer of Peace"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">The <span class="calibre8"><span class="calibre39">current-track</span></span> reference now refers to a different track.</p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Transactional Properties</span></span></span></p><p class="calibre44"> Like database transactions, STM transactions guarantee some important properties: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Updates are <span class="italic">atomic</span>. If you update more than one ref in a transaction, the cumulative effect of all the updates will appear as a single instantaneous event to anyone not inside your transaction. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Updates are <span class="italic">consistent</span>. Refs can specify validation functions. If any of these functions fail, the entire transaction will fail. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> Updates are <span class="italic">isolated</span>. Running transactions cannot see partially completed results from other transactions. </p></li><a></a></ul><p class="calibre12"> Databases provide the additional guarantee that updates are <span class="italic">durable</span>. Because Clojure’s transactions are in-memory transactions, Clojure does not guarantee that updates are durable. If you want a durable transaction in Clojure, you should use a database. </p><p class="calibre12"> Together, the four transactional properties are called ACID. Databases provide ACID; Clojure’s STM provides ACI. </p><p class="calibre12"> If you change more than one ref in a single transaction, those changes are all coordinated to “happen at the same time” from the perspective of any code outside the transaction. So, you can make sure that updates to <span class="calibre8"><span class="calibre39">current-track</span></span> and <span class="calibre8"><span class="calibre39">current-composer</span></span> are <span class="italic">coordinated</span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def current-track (ref "Venus, the Bringer of Peace"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/current-track​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def current-composer (ref "Holst"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/current-composer​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(dosync​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (ref-set current-track "Credo")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (ref-set current-composer "Byrd"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Byrd"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Because the updates are in a transaction, no other thread will ever see an updated track with an out-of-date composer, or vice versa. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">alter</span></span></span></p><p class="calibre44"> The <span class="calibre8"><span class="calibre39">current-track</span></span> example is deceptively easy, because updates to the ref are totally independent of any previous state. Let’s build a more complex example, where transactions need to update existing information. A simple chat application fits the bill. First, create a message record that has a sender and some text: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/chat.clj"><span class="calibre41"><span class="underline">src/examples/chat.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defrecord</span></span></span><span class="calibre8"> Message [sender text])​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now, you can create messages by instantiating the record: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(user.Message. "Aaron" "Hello")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #:user.Message{:sender "Aaron", :text "Hello"}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Users of the chat application want to see the most recent message first, so a list is a good data structure. Create a <span class="calibre8"><span class="calibre39">messages</span></span> reference that points to an initially empty list: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> messages (</span><span class="calibre8"><span class="bold"><span class="calibre36">ref</span></span></span><span class="calibre8"> ()))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now you need a function to add a new message to the front of <span class="calibre8"><span class="calibre39">messages</span></span>. You could simply <span class="calibre8"><span class="calibre39">deref</span></span> to get the list of messages, <span class="calibre8"><span class="calibre39">cons</span></span> the new message, and then <span class="calibre8"><span class="calibre39">ref-set</span></span> the updated list back into <span class="calibre8"><span class="calibre39">messages</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; bad idea</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> naive-add-message [msg]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">dosync</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">ref-set</span></span></span><span class="calibre8"> messages (</span><span class="calibre8"><span class="bold"><span class="calibre36">cons</span></span></span><span class="calibre8"> msg @messages))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> But there is a better option. Why not perform the read and update in a single step? Clojure’s <span class="calibre8"><span class="calibre39">alter</span></span> will apply an update function to a referenced object within a transaction: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">alter</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">ref</span></span></span><span class="calibre8"> update-fn &amp; args.</span><span class="calibre8"><span class="bold"><span class="calibre36">..</span></span></span><span class="calibre8">)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">alter</span></span> returns the new value of the ref within the transaction. When a transaction successfully completes, the ref will take on its last in-transaction value. Using <span class="calibre8"><span class="calibre39">alter</span></span> instead of <span class="calibre8"><span class="calibre39">ref-set</span></span> makes the code more readable: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> add-message [msg]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">dosync</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">alter</span></span></span><span class="calibre8"> messages </span><span class="calibre8"><span class="bold"><span class="calibre36">conj</span></span></span><span class="calibre8"> msg)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Notice that the update function is <span class="calibre8"><span class="calibre39">conj</span></span> (short for “conjoin”), not <span class="calibre8"><span class="calibre39">cons</span></span>. This is because <span class="calibre8"><span class="calibre39">conj</span></span> takes arguments in an order suitable for use with <span class="calibre8"><span class="calibre39">alter</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">cons</span></span></span><span class="calibre8"> item </span><span class="calibre8"><span class="bold"><span class="calibre36">sequence</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">conj</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">sequence</span></span></span><span class="calibre8"> item)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">alter</span></span> function calls its <span class="calibre8"><span class="calibre39">update-fn</span></span> with the current reference value as its first argument, as <span class="calibre8"><span class="calibre39">conj</span></span> expects. If you plan to write your own update functions, they should follow the same structure as <span class="calibre8"><span class="calibre39">conj</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(your-func thing-that-gets-updated &amp; optional-other-args)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38">Try adding a few messages to see that the code works as expected:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(add-message (user.Message. "user 1" "hello"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (#:user.Message{:sender "user 1", :text "hello"})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(add-message (user.Message. "user 2" "howdy"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (#:user.Message{:sender "user 2", :text "howdy"}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    #:user.Message{:sender "user 1", :text "hello"})​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">alter</span></span> is the workhorse of Clojure’s STM and is the primary means of updating refs. But if you know a little about how the STM works, you may be able to optimize your transactions in certain scenarios. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">How STM Works: MVCC</span></span></span></p><p class="calibre44"> Clojure’s STM uses a technique called Multiversion Concurrency Control (MVCC), which is also used in several major databases. Here’s how MVCC works in Clojure. </p><p class="calibre12"> Transaction A begins by taking a <span class="italic">point</span>, which is simply a number that acts as a unique timestamp in the STM world. Transaction A has access to its own <span class="italic">effectively private</span> copy of any reference it needs, associated with the point. Clojure’s persistent data structures (<a href="#filepos544810">​<span class="italic">Persistent Data Structures</span>​</a>) make it cheap to provide these effectively private copies. </p><p class="calibre12"> During Transaction A, operations on a ref work against (and return) the transaction’s private copy of the ref’s data, called the <span class="italic">in-transaction value</span>. </p><p class="calibre12"> If at any point the STM detects that another transaction has already set/altered a ref that Transaction A wants to set/alter, Transaction A will be forced to retry. If you throw an exception out of the <span class="calibre8"><span class="calibre39">dosync</span></span> block, then Transaction A will abort <span class="italic">without</span> a retry. </p><p class="calibre12"> If and when Transaction A commits, its heretofore private writes will become visible to the world, associated with a single point in the transaction timeline. </p><p class="calibre12"> Sometimes the approach implied by <span class="calibre8"><span class="calibre39">alter</span></span> is too cautious. What if you <span class="italic">don’t care</span> that another transaction <span class="calibre8"><span class="calibre39">alter</span></span>ed a reference out from under you in the middle of your transaction? If in such a situation you would be willing to commit your changes anyway, you can beat <span class="calibre8"><span class="calibre39">alter</span></span>’s performance with <span class="calibre8"><span class="calibre39">commute</span></span>. </p><p id="filepos727662" class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">commute</span></span></span></p><p class="calibre44"><span class="calibre8"><span class="calibre39">commute</span></span> is a specialized variant of <span class="calibre8"><span class="calibre39">alter</span></span> allowing for more concurrency: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">commute</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">ref</span></span></span><span class="calibre8"> update-fn &amp; args.</span><span class="calibre8"><span class="bold"><span class="calibre36">..</span></span></span><span class="calibre8">)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Of course, there is a trade-off. Commutes are so named because they must be <span class="italic">commutative</span>. That is, updates must be able to occur in any order. This gives the STM system freedom to reorder commutes. </p><p class="calibre12"> To use <span class="calibre8"><span class="calibre39">commute</span></span>, simply replace <span class="calibre8"><span class="calibre39">alter</span></span> with <span class="calibre8"><span class="calibre39">commute</span></span> in your implementation of <span class="calibre8"><span class="calibre39">add-message</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> add-message-commute [msg]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">dosync</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">commute</span></span></span><span class="calibre8"> messages </span><span class="calibre8"><span class="bold"><span class="calibre36">conj</span></span></span><span class="calibre8"> msg)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">commute</span></span> returns the new value of the ref. However, the last in-transaction value you see from a <span class="calibre8"><span class="calibre39">commute</span></span> will <span class="italic">not</span> always match the end-of-transaction value of a ref, because of reordering. If another transaction sneaks in and alters a ref that you are trying to <span class="calibre8"><span class="calibre39">commute</span></span>, the STM will not restart your transaction. Instead, it will simply run your <span class="calibre8"><span class="calibre39">commute</span></span> function again, out of order. Your transaction will <span class="italic">never even see</span> the ref value that your <span class="calibre8"><span class="calibre39">commute</span></span> function finally ran against. </p><p class="calibre12"> Since Clojure’s STM can reorder commutes behind your back, you can use them only when you do not care about ordering. Literally speaking, this is not true for a chat application. The list of messages most certainly has an order, so if two message adds get reversed, the resulting list will not correctly show the order in which the messages arrived. </p><p class="calibre12"> Practically speaking, chat message updates are <span class="italic">commutative enough</span>. STM-based reordering of messages will likely happen on time scales of microseconds or less. For users of a chat application, there are already reorderings on much larger time scales due to network and human latency. (Think about times that you have “spoken out of turn” in an online chat because another speaker’s message had not reached you yet.) Since these larger reorderings are unfixable, it is reasonable for a chat application to ignore the smaller reorderings that might bubble up from Clojure’s STM. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Prefer alter</span></span></span></p><p class="calibre44"> Many updates are not commutative. For example, consider a counter that returns an increasing sequence of numbers. You might use such a counter to build unique IDs in a system. The counter can be a simple reference to a number: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/concurrency.clj"><span class="calibre41"><span class="underline">src/examples/concurrency.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> counter (</span><span class="calibre8"><span class="bold"><span class="calibre36">ref</span></span></span><span class="calibre8"> 0))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> You should not use <span class="calibre8"><span class="calibre39">commute</span></span> to update the counter. <span class="calibre8"><span class="calibre39">commute</span></span> returns the in-transaction value of the counter at the time of the <span class="calibre8"><span class="calibre39">commute</span></span>, but reorderings could cause the actual end-of-transaction value to be different. This could lead to more than one caller getting the same counter value. Instead, use <span class="calibre8"><span class="calibre39">alter</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> next-counter [] (</span><span class="calibre8"><span class="bold"><span class="calibre36">dosync</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">alter</span></span></span><span class="calibre8"> counter </span><span class="calibre8"><span class="bold"><span class="calibre36">inc</span></span></span><span class="calibre8">)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Try calling <span class="calibre8"><span class="calibre39">next-counter</span></span> a few times to verify that the counter works as expected: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(next-counter)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 1​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(next-counter)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 2​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> In general, you should prefer <span class="calibre8"><span class="calibre39">alter</span></span> over <span class="calibre8"><span class="calibre39">commute</span></span>. Its semantics are easy to understand and error-proof. <span class="calibre8"><span class="calibre39">commute</span></span>, on the other hand, requires that you think carefully about transactional semantics. If you use <span class="calibre8"><span class="calibre39">alter</span></span> when <span class="calibre8"><span class="calibre39">commute</span></span> would suffice, the worst thing that might happen is performance degradation. But if you use <span class="calibre8"><span class="calibre39">commute</span></span> when <span class="calibre8"><span class="calibre39">alter</span></span> is required, you will introduce a subtle bug that is difficult to detect with automated tests. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Adding Validation to Refs</span></span></span></p><p class="calibre44"> Database transactions maintain consistency through various integrity checks. You can do something similar with Clojure’s transactional memory, by specifying a validation function when you create a ref: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">ref</span></span></span><span class="calibre8"> initial-state options*)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; options include:</span></span></span><span class="calibre8">​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">;  :validator validate-fn</span></span></span><span class="calibre8">​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">;  :meta metadata-map</span></span></span><span class="calibre8">​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> The options to <span class="calibre8"><span class="calibre39">ref</span></span> include an optional validation function that can throw an exception to prevent a transaction from completing. Note that <span class="calibre8"><span class="calibre39">options</span></span> is <span class="italic">not</span> a map; it is simply a sequence of key/value pairs spliced into the function call. </p><p class="calibre12"> Continuing the chat example, add a validation function to the <span class="calibre8"><span class="calibre39">messages</span></span> reference that guarantees that all messages have non-<span class="calibre8"><span class="calibre39">nil</span></span> values for <span class="calibre8"><span class="calibre39">:sender</span></span> and <span class="calibre8"><span class="calibre39">:text</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/chat.clj"><span class="calibre41"><span class="underline">src/examples/chat.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> validate-message-list​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">partial</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">every?</span></span></span><span class="calibre8"> #(</span><span class="calibre8"><span class="bold"><span class="calibre36">and</span></span></span><span class="calibre8"> (:sender %) (:text %))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> messages (</span><span class="calibre8"><span class="bold"><span class="calibre36">ref</span></span></span><span class="calibre8"> () :validator validate-message-list))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> This validation acts like a key constraint on a table in a database transaction. If the constraint fails, the entire transaction rolls back. Try adding an ill-formed message such as a simple string: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(add-message "not a valid message")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.lang.IllegalStateException: Invalid reference state​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​@messages​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ()​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Messages that match the constraint are no problem:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(add-message (user.Message. "Aaron" "Real Message"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (#:user.Message{:sender "Aaron", :text "Real Message"})​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Refs are great for coordinated access to shared state, but not all tasks require such coordination. For updating a single piece of isolated data, prefer an atom. </p><div class="mbppagebreak"></div><p id="filepos741361" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">5.3 Use Atoms for Uncoordinated, Synchronous Updates</span></span></span></p><p class="calibre34"> Atoms are a lighter-weight mechanism than refs. Where multiple ref updates can be coordinated in a transaction, atoms allow updates of a single value, uncoordinated with anything else. </p><p class="calibre12"> You create atoms with <span class="calibre8"><span class="calibre39">atom</span></span>, which has a signature very similar to <span class="calibre8"><span class="calibre39">ref</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">atom</span></span></span><span class="calibre8"> initial-state options?)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; options include:</span></span></span><span class="calibre8">​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">;   :validator validate-fn</span></span></span><span class="calibre8">​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">;   :meta metadata-map</span></span></span><span class="calibre8">​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Returning to our music player example, you could store the <span class="calibre8"><span class="calibre39">current-track</span></span> in an atom instead of a ref: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def current-track (atom "Venus, the Bringer of Peace"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/current-track​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">You can dereference an atom to get its value, just as you would a ref:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(deref current-track)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Venus, the Bringer of Peace"​</span><span class="calibre8">
</span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​@current-track​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Venus, the Bringer of Peace"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Atoms do not participate in transactions and thus do not require a <span class="calibre8"><span class="calibre39">dosync</span></span>. To set the value of an atom, simply call <span class="calibre8"><span class="calibre39">reset!</span></span>
</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">reset!</span></span></span><span class="calibre8"> an-atom newval)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> For example, you can set <span class="calibre8"><span class="calibre39">current-track</span></span> to <span class="calibre8"><span class="calibre39">"Credo"</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(reset! current-track "Credo")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Credo"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> What if you want to coordinate an update of both <span class="calibre8"><span class="calibre39">current-track</span></span> and <span class="calibre8"><span class="calibre39">current-composer</span></span> with an atom? The short answer is “You can’t.” That is the difference between refs and atoms. If you need coordinated access, use a ref. </p><p class="calibre12"> The longer answer is “You can...if you are willing to change the way you model the problem.” What if you store the track title and composer in a map and then store the whole map in a single atom? </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def current-track (atom {:title "Credo" :composer "Byrd"}))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/current-track​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now you can update both values in a single <span class="calibre8"><span class="calibre39">reset!</span></span>
</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(reset! current-track {:title "Spem in Alium" :composer "Tallis"})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:title "Spem in Alium", :composer "Tallis"}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Maybe you like to listen to several tracks in a row by the same composer. If so, you want to change the track title but keep the same composer. <span class="calibre8"><span class="calibre39">swap!</span></span> will do the trick: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">swap!</span></span></span><span class="calibre8"> an-atom f &amp; args)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">swap!</span></span> updates <span class="calibre8"><span class="calibre39">an-atom</span></span> by calling function <span class="calibre8"><span class="calibre39">f</span></span> on the current value of <span class="calibre8"><span class="calibre39">an-atom</span></span>, plus any additional <span class="calibre8"><span class="calibre39">args</span></span>. </p><p class="calibre12"> To change just the track title, use <span class="calibre8"><span class="calibre39">swap!</span></span> with <span class="calibre8"><span class="calibre39">assoc</span></span> to update only the <span class="calibre8"><span class="calibre39">:title</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(swap! current-track assoc :title "Sancte Deus")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:title "Sancte Deus", :composer "Tallis"}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">swap!</span></span> returns the new value. Calls to <span class="calibre8"><span class="calibre39">swap!</span></span> might be retried, if other threads are attempting to modify the same atom. So, the function you pass to <span class="calibre8"><span class="calibre39">swap!</span></span> should have no side effects. </p><p class="calibre12"> Both refs and atoms perform synchronous updates. When the update function returns, the value is already changed. If you do not need this level of control and can tolerate updates happening asynchronously at some later time, prefer an agent. </p><div class="mbppagebreak"></div><p id="filepos749782" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">5.4 Use Agents for Asynchronous Updates</span></span></span></p><p class="calibre34"> Some applications have tasks that can proceed independently with minimal coordination between tasks. Clojure <span class="italic">agents</span> support this style of task. </p><p class="calibre12"> Agents have much in common with refs. Like refs, you create an agent by wrapping some piece of initial state: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">agent</span></span></span><span class="calibre8"> initial-state)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Create a <span class="calibre8"><span class="calibre39">counter</span></span> agent that wraps an initial count of zero: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def counter (agent 0))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/counter​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Once you have an agent, you can <span class="calibre8"><span class="calibre39">send</span></span> the agent a function to update its state. <span class="calibre8"><span class="calibre39">send</span></span> queues an <span class="calibre8"><span class="calibre39">update-fn</span></span> to run later, on a thread in a thread pool: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">send</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">agent</span></span></span><span class="calibre8"> update-fn &amp; args)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Sending to an agent is very much like commuting a ref. Tell the <span class="calibre8"><span class="calibre39">counter</span></span> to <span class="calibre8"><span class="calibre39">inc</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(send counter inc)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #&lt;clojure.lang.Agent@23451c74: 0&gt;​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Notice that the call to <span class="calibre8"><span class="calibre39">send</span></span> does not return the new value of the agent, returning instead the agent itself. That is because <span class="calibre8"><span class="calibre39">send</span></span> <span class="italic">does not know</span> the new value. After <span class="calibre8"><span class="calibre39">send</span></span> queues the <span class="calibre8"><span class="calibre39">inc</span></span> to run later, it returns immediately. </p><p class="calibre12"> Although <span class="calibre8"><span class="calibre39">send</span></span> does not know the new value of an agent, the REPL <span class="italic">might</span> know. Depending on whether the agent thread or the REPL thread runs first, you might see a <span class="calibre8"><span class="calibre39">1</span></span> or a <span class="calibre8"><span class="calibre39">0</span></span> after the colon in the previous output. </p><p class="calibre12"> You can check the current value of an agent with <span class="calibre8"><span class="calibre39">deref</span></span>/<span class="calibre8"><span class="calibre39">@</span></span>, just as you would a ref. By the time you get around to checking the <span class="calibre8"><span class="calibre39">counter</span></span>, the <span class="calibre8"><span class="calibre39">inc</span></span> will almost certainly have completed on the thread pool, raising the value to 1: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​@counter​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 1​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If the race condition between the REPL and the agent thread bothers you, there is a solution. If you want to be sure that the agent has completed the actions <span class="italic">you sent</span> to it, you can call <span class="calibre8"><span class="calibre39">await</span></span> or <span class="calibre8"><span class="calibre39">await-for</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">await</span></span></span><span class="calibre8"> &amp; agents)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">await-for</span></span></span><span class="calibre8"> timeout-millis &amp; agents)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> These functions will cause the current thread to block until all actions sent from the current thread or agent have completed. <span class="calibre8"><span class="calibre39">await-for</span></span> will return <span class="calibre8"><span class="calibre39">nil</span></span> if the timeout expires and will return a non-<span class="calibre8"><span class="calibre39">nil</span></span> value otherwise. <span class="calibre8"><span class="calibre39">await</span></span> has no timeout, so be careful: <span class="calibre8"><span class="calibre39">await</span></span> is willing to wait forever. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Validating Agents and Handling Errors</span></span></span></p><p class="calibre44"> Agents have other points in common with refs. They also can take a validation function: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">agent</span></span></span><span class="calibre8"> initial-state options*)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; options include:</span></span></span><span class="calibre8">​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">;   :validator validate-fn</span></span></span><span class="calibre8">​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">;   :meta metadata-map</span></span></span><span class="calibre8">​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Re-create the <span class="calibre8"><span class="calibre39">counter</span></span> with a validator that ensures it is a number: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def counter (agent 0 :validator number?))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/counter​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Try to set the agent to a value that is not a number by passing an update function that ignores the current value and simply returns a string: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(send counter (fn [_] "boo"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #&lt;clojure.lang.Agent@4de8ce62: 0&gt;​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Everything looks fine (so far) because <span class="calibre8"><span class="calibre39">send</span></span> still returns immediately. After the agent tries to update itself on a pooled thread, it will enter an exceptional state. You will discover the error when you try to dereference the agent: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​@counter​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.lang.Exception: Agent has errors​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> To discover the specific error (or errors), call <span class="calibre8"><span class="calibre39">agent-errors</span></span>, which will return a sequence of errors thrown during agent actions: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(agent-errors counter)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​-&gt; (#&lt;IllegalStateException ...&gt;)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Once an agent has errors, all subsequent attempts to query the agent will return an error. You make the agent usable again by calling <span class="calibre8"><span class="calibre39">clear-agent-errors</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">clear-agent-errors</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">agent</span></span></span><span class="calibre8">)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> which returns the agent to its pre-error state. Clear the <span class="calibre8"><span class="calibre39">counter</span></span>’s errors, and verify that its state is the same as before the error occurred: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(clear-agent-errors counter)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​@counter​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 0​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now that you know the basics of agents, let’s use them in conjunction with refs and transactions. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Including Agents in Transactions</span></span></span></p><p class="calibre44"> Transactions should not have side effects, because Clojure may retry a transaction an arbitrary number of times. However, sometimes you <span class="italic">want</span> a side effect when a transaction succeeds. Agents provide a solution. If you send an action to an agent from within a transaction, that action will be sent exactly once, if and only if the transaction succeeds. </p><p class="calibre12"> As an example of where this would be useful, consider an agent that writes to a file when a transaction succeeds. You could combine such an agent with the chat example from <a href="#filepos727662">​<span class="italic">commute</span>​</a>, to automatically back up chat messages. First, create a <span class="calibre8"><span class="calibre39">backup-agent</span></span> that stores the <span class="calibre8"><span class="calibre39">filename</span></span> to write to: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/concurrency.clj"><span class="calibre41"><span class="underline">src/examples/concurrency.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> backup-agent (</span><span class="calibre8"><span class="bold"><span class="calibre36">agent</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"output/messages-backup.clj"</span></span></span><span class="calibre8">))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Then, create a modified version of <span class="calibre8"><span class="calibre39">add-message</span></span>. The new function <span class="calibre8"><span class="calibre39">add-message-with-backup</span></span> should do two additional things: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Grab the return value of <span class="calibre8"><span class="calibre39">commute</span></span>, which is the current database of messages, in a <span class="calibre8"><span class="calibre39">let</span></span> binding. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> While still inside a transaction, <span class="calibre8"><span class="calibre39">send</span></span> an action to the backup agent that writes the message database to <span class="calibre8"><span class="calibre39">filename</span></span>. For simplicity, have the action function return <span class="calibre8"><span class="calibre39">filename</span></span> so that the agent will use the same filename for the next backup. </p></li><a></a></ul><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> add-message-with-backup [msg]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">dosync</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [snapshot (</span><span class="calibre8"><span class="bold"><span class="calibre36">commute</span></span></span><span class="calibre8"> messages </span><span class="calibre8"><span class="bold"><span class="calibre36">conj</span></span></span><span class="calibre8"> msg)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     (</span><span class="calibre8"><span class="bold"><span class="calibre36">send-off</span></span></span><span class="calibre8"> backup-agent (</span><span class="calibre8"><span class="bold"><span class="calibre36">fn</span></span></span><span class="calibre8"> [filename]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                              (spit filename snapshot)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                              filename))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     snapshot)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The new function has one other critical difference: it calls <span class="calibre8"><span class="calibre39">send-off</span></span> instead of <span class="calibre8"><span class="calibre39">send</span></span> to communicate with the agent. <span class="calibre8"><span class="calibre39">send-off</span></span> is a variant of <span class="calibre8"><span class="calibre39">send</span></span> for actions that expect to block, as a file write might do. <span class="calibre8"><span class="calibre39">send-off</span></span> actions get their own expandable thread pool. Never <span class="calibre8"><span class="calibre39">send</span></span> a blocking function, or you may unnecessarily prevent other agents from making progress. </p><p class="calibre12"> Try adding some messages using <span class="calibre8"><span class="calibre39">add-message-with-backup</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(add-message-with-backup (user.Message. "John" "Message One"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (#:user.Message{:sender "John", :text "Message One"})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(add-message-with-backup (user.Message. "Jane" "Message Two"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (#:user.Message{:sender "Jane", :text "Message Two"}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    #:user.Message{:sender "John", :text "Message One"})​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> You can check both the in-memory <span class="calibre8"><span class="calibre39">messages</span></span> as well as the backup file <span class="calibre8"><span class="calibre39">messages-backup</span></span> to verify that they contain the same structure. </p><p class="calibre12"> You could enhance the backup strategy in this example in various ways. You could provide the option to back up less often than on every update or back up only information that has changed since the last backup. </p><p class="calibre12"> Since Clojure’s STM provides the ACI properties of ACID and since writing to a file provides the D (“durability”), it is tempting to think that STM plus a backup agent equals a database. This is <span class="italic">not</span> the case. A Clojure transaction promises only to <span class="calibre8"><span class="calibre39">send</span></span>/<span class="calibre8"><span class="calibre39">sendoff</span></span> an action to the agent; it does not actually <span class="italic">perform</span> the action under the ACI umbrella. So, for example, a transaction could complete, and then someone could unplug the power cord before the agent writes to the database. The moral is simple. If your problem calls for a real database, use a real database. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">The Unified Update Model</span></span></span></p><p class="calibre44"> As you have seen, refs, atoms, and agents all provide functions for updating their state by applying a function to their previous state. This unified model for handling shared state is one of the central concepts of Clojure. The unified model and various ancillary functions are summarized in the following tabler. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><th valign="top" class="calibre51"><span class="bold">  Update Mechanism  </span>
</th><th valign="top" class="calibre51"><span class="bold">  Ref Function  </span>
</th><th valign="top" class="calibre51"><span class="bold">  Atom Function  </span>
</th><th valign="top" class="calibre51"><span class="bold">  Agent Function  </span>
</th></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">  Function application   </td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">alter</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">swap!</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">send-off</span></span>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">  Function (commutative)   </td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">commute</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">N/A  </p></td><td valign="top" class="calibre23">   <p class="calibre59">N/A  </p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">  Function (nonblocking)   </td><td valign="top" class="calibre23">   <p class="calibre59">N/A  </p></td><td valign="top" class="calibre23">   <p class="calibre59">N/A  </p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">send</span></span>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">  Simple setter   </td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">ref-set</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">reset!</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">N/A  </p></td></tr></table><p class="calibre27"> The unified update model is by far the most important way to update refs, atoms, and agents. The ancillary functions, on the other hand, are optimizations and options that stem from the semantics peculiar to each API: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> The opportunity for the <span class="calibre8"><span class="calibre39">commute</span></span> optimization arises when coordinating updates. Since only refs provide coordinated updates, <span class="calibre8"><span class="calibre39">commute</span></span> makes sense only for refs. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Updates to refs and atoms take place on the thread they are called on, so they provide no scheduling options. Agents update later, on a thread pool, making blocking/nonblocking a relevant scheduling option. </p></li><a></a></ul><p class="calibre12"> Clojure’s final reference type, the var, is a different beast entirely. They do not participate in the unified update model and are instead used to manage thread-local, private state. </p><div class="mbppagebreak"></div><p id="filepos773305" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">5.5 Managing Per-Thread State with Vars</span></span></span></p><p class="calibre34"> When you call <span class="calibre8"><span class="calibre39">def</span></span> or <span class="calibre8"><span class="calibre39">defn</span></span>, you create a <span class="italic">dynamic var</span>, often called just a <span class="italic">var</span>. In all the examples so far in the book, you pass an initial value to <span class="calibre8"><span class="calibre39">def</span></span>, which becomes the <span class="italic">root binding</span> for the var. For example, the following code creates a root binding for <span class="calibre8"><span class="calibre39">foo</span></span> of <span class="calibre8"><span class="calibre39">10</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def ^:dynamic foo 10)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/foo​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The binding of <span class="calibre8"><span class="calibre39">foo</span></span> is shared by all threads. You can check the value of <span class="calibre8"><span class="calibre39">foo</span></span> on your own thread: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​foo​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 10​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> You can also verify the value of <span class="calibre8"><span class="calibre39">foo</span></span> from another thread. Create a new thread, passing it a function that prints <span class="calibre8"><span class="calibre39">foo</span></span>. Don’t forget to <span class="calibre8"><span class="calibre39">start</span></span> the thread: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;</span><span class="calibre8"><span class="bold"><span class="calibre36"> (.start (Thread. (fn [] (println foo))))</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| 10​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> In the previous example, the call to <span class="calibre8"><span class="calibre39">start</span></span> returns <span class="calibre8"><span class="calibre39">nil</span></span>, and then the value of <span class="calibre8"><span class="calibre39">foo</span></span> is printed from a new thread. </p><p class="calibre12"> Most vars are content to keep their root bindings forever. However, you can create a <span class="italic">thread-local</span> binding for a var with the <span class="calibre8"><span class="calibre39">binding</span></span> macro: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">binding</span></span></span><span class="calibre8"> [bindings] &amp; body)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Bindings have <span class="italic">dynamic scope</span>. In other words, a binding is visible anywhere a thread’s execution takes it, until the thread exits the scope where the binding began. A binding is not visible to any other threads. </p><p class="calibre12"> Structurally, a <span class="calibre8"><span class="calibre39">binding</span></span> looks a lot like a <span class="calibre8"><span class="calibre39">let</span></span>. Create a thread-local binding for <span class="calibre8"><span class="calibre39">foo</span></span> and check its value: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(binding [foo 42] foo)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 42​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> To see the difference between <span class="calibre8"><span class="calibre39">binding</span></span> and <span class="calibre8"><span class="calibre39">let</span></span>, create a simple function that prints the value of <span class="calibre8"><span class="calibre39">foo</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defn print-foo [] (println foo))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/print-foo​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now, try calling <span class="calibre8"><span class="calibre39">print-foo</span></span> from both a <span class="calibre8"><span class="calibre39">let</span></span> and a <span class="calibre8"><span class="calibre39">binding</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(let [foo "let foo"] (print-foo))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| 10​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(binding [foo "bound foo"] (print-foo))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| bound foo​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> As you can see, the <span class="calibre8"><span class="calibre39">let</span></span> has no effect outside its own form, so the first <span class="calibre8"><span class="calibre39">print-foo</span></span> prints the root binding <span class="calibre8"><span class="calibre39">10</span></span>. The <span class="calibre8"><span class="calibre39">binding</span></span>, on the other hand, stays in effect down any chain of calls that begins in the binding form, so the second <span class="calibre8"><span class="calibre39">print-foo</span></span> prints <span class="calibre8"><span class="calibre39">bound foo</span></span>. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Acting at a Distance</span></span></span></p><p class="calibre44"> Vars intended for dynamic binding are sometimes called <span class="italic">special</span> variables. It is good style to name them with leading and trailing asterisks. For example, Clojure uses dynamic binding for thread-wide options such as the standard I/O streams <span class="calibre8"><span class="calibre39">*in*</span></span>, <span class="calibre8"><span class="calibre39">*out*</span></span>, and <span class="calibre8"><span class="calibre39">*err*</span></span>. Dynamic bindings enable <span class="italic">action at a distance</span>. When you change a dynamic binding, you can change the behavior of distant functions without changing any function arguments. </p><p class="calibre12"> One kind of action at a distance is temporarily augmenting the behavior of a function. In some languages this would be classified as aspect-oriented programming; in Clojure it is simply a side effect of dynamic binding. As an example, imagine that you have a function that performs an expensive calculation. To simulate this, write a function named <span class="calibre8"><span class="calibre39">slow-double</span></span> that sleeps for a tenth of a second and then doubles its input. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> ^:dynamic slow-double [n]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (Thread/sleep 100)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">*</span></span></span><span class="calibre8"> n 2))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Next, write a function named <span class="calibre8"><span class="calibre39">calls-slow-double</span></span> that calls <span class="calibre8"><span class="calibre39">slow-double</span></span> for each item in <span class="calibre8"><span class="calibre39">[1 2 1 2 1 2]</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> calls-slow-double []​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">map</span></span></span><span class="calibre8"> slow-double [1 2 1 2 1 2]))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Time a call to <span class="calibre8"><span class="calibre39">calls-slow-double</span></span>. With six internal calls to <span class="calibre8"><span class="calibre39">slow-double</span></span>, it should take a little over six tenths of a second. Note that you will have to run through the result with <span class="calibre8"><span class="calibre39">dorun</span></span>; otherwise, Clojure’s <span class="calibre8"><span class="calibre39">map</span></span> will outsmart you by immediately returning a lazy sequence. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(time (dorun (calls-slow-double)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| "Elapsed time: 601.418 msecs"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Reading the code, you can tell that <span class="calibre8"><span class="calibre39">calls-slow-double</span></span> is slow because it does the same work over and over again. One times two is two, no matter how many times you ask. </p><p class="calibre12"> Calculations such as <span class="calibre8"><span class="calibre39">slow-double</span></span> are good candidates for <span class="italic">memoization</span>. When you memoize a function, it keeps a cache mapping past inputs to past outputs. If subsequent calls hit the cache, they will return almost immediately. Thus, you are trading space (the cache) for time (calculating the function again for the same inputs). </p><p class="calibre12"> Clojure provides <span class="calibre8"><span class="calibre39">memoize</span></span>, which takes a function and returns a memoization of that function: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">memoize</span></span></span><span class="calibre8"> function)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">slow-double</span></span> is a great candidate for memoization, but it isn’t memoized yet, and clients like <span class="calibre8"><span class="calibre39">calls-slow-double</span></span> already use the slow, unmemoized version. With dynamic binding, this is no problem. Simply create a binding to a memoized version of <span class="calibre8"><span class="calibre39">slow-double</span></span>, and call <span class="calibre8"><span class="calibre39">calls-slow-double</span></span> from within the binding. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> demo-memoize []​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">time</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   (</span><span class="calibre8"><span class="bold"><span class="calibre36">dorun</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">binding</span></span></span><span class="calibre8"> [slow-double (</span><span class="calibre8"><span class="bold"><span class="calibre36">memoize</span></span></span><span class="calibre8"> slow-double)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (calls-slow-double)))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> With the memoized version of <span class="calibre8"><span class="calibre39">slow-double</span></span>, <span class="calibre8"><span class="calibre39">calls-slow-double</span></span> runs three times faster, completing in about two-tenths of a second: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(demo-memoize)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​"Elapsed time: 203.115 msecs"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> This example demonstrates the power and the danger of action at a distance. By dynamically rebinding a function such as <span class="calibre8"><span class="calibre39">slow-double</span></span>, you change the behavior of <span class="italic">other</span> functions such as <span class="calibre8"><span class="calibre39">calls-slow-double</span></span> without their knowledge or consent. With lexical binding forms such as <span class="calibre8"><span class="calibre39">let</span></span>, it is easy to see the entire range of your changes. Dynamic binding is not so simple. It can change the behavior of other forms in other files, far from the point in your source where the binding occurs. </p><p class="calibre12"> Used occasionally, dynamic binding has great power. But it should not become your primary mechanism for extension or reuse. Functions that use dynamic bindings are not pure functions and can quickly lose the benefits of Clojure’s functional style. </p><p id="filepos788693" class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Working with Java Callback APIs</span></span></span></p><p class="calibre44"> Several Java APIs depend on callback event handlers. GUI frameworks such as Swing use event handlers to respond to user input. XML parsers such as SAX depend on the user implementing a callback handler interface. </p><p class="calibre12"> These callback handlers are written with mutable objects in mind. Also, they tend to be single-threaded. In Clojure, the best way to meet such APIs halfway is to use dynamic bindings. This will involve mutable references that feel almost like variables, but because they are used in a single-threaded setting, they will not present any concurrency problems. </p><p class="calibre12"> Clojure provides the <span class="calibre8"><span class="calibre39">set!</span></span> special form for setting a thread-local dynamic binding: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(set! var-symbol new-value)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">set!</span></span> should be used rarely. In fact, the only place in the entire Clojure core that uses <span class="calibre8"><span class="calibre39">set!</span></span> is the Clojure implementation of a SAX <span class="calibre8"><span class="calibre39">ContentHandler</span></span>. </p><p class="calibre12"> A <span class="calibre8"><span class="calibre39">ContentHandler</span></span> receives callbacks as a parser encounters various bits of an XML stream. In nontrivial scenarios, the <span class="calibre8"><span class="calibre39">ContentHandler</span></span> needs to keep track of <span class="italic">where it is</span> in the XML stream: the current stack of open elements, current character data, and so on. </p><p class="calibre12"> In Clojure-speak, you can think of a <span class="calibre8"><span class="calibre39">ContentHandler</span></span>’s current position as a mutable pointer to a specific spot in an immutable XML stream. It is unnecessary to use references in a <span class="calibre8"><span class="calibre39">ContentHandler</span></span>, since everything will happen on a single thread. Instead, Clojure’s <span class="calibre8"><span class="calibre39">ContentHandler</span></span> uses dynamic variables and <span class="calibre8"><span class="calibre39">set!</span></span>. Here is the relevant detail: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; redacted from Clojure's xml.clj to focus on dynamic variable usage</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(startElement​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​ [uri local-name q-name </span><span class="calibre8"><span class="bold"><span class="calibre36">#^Attributes</span></span></span><span class="calibre8"> atts]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​ </span><span class="calibre8"><span class="italic"><span class="calibre40">; details omitted</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​ (set! *stack* (</span><span class="calibre8"><span class="bold"><span class="calibre36">conj</span></span></span><span class="calibre8"> *stack* *current*))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​ (set! *current* e)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​ (set! *state* :element))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​nil)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(endElement​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​ [uri local-name q-name]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​ </span><span class="calibre8"><span class="italic"><span class="calibre40">; details omitted</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​ (set! *current* (push-content (</span><span class="calibre8"><span class="bold"><span class="calibre36">peek</span></span></span><span class="calibre8"> *stack*) *current*))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​ (set! *stack* (</span><span class="calibre8"><span class="bold"><span class="calibre36">pop</span></span></span><span class="calibre8"> *stack*))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​ (set! *state* :between)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​nil)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> A SAX parser calls <span class="calibre8"><span class="calibre39">startElement</span></span> when it encounters an XML start tag. The callback handler updates three thread-local variables. The <span class="calibre8"><span class="calibre39">*stack*</span></span> is a stack of all the elements the current element is nested inside. The <span class="calibre8"><span class="calibre39">*current*</span></span> is the current element, and the <span class="calibre8"><span class="calibre39">*state*</span></span> keeps track of what kind of content is inside. (This is important primarily when inside character data, which is not shown here.) </p><p class="calibre12"><span class="calibre8"><span class="calibre39">endElement</span></span> reverses the work of <span class="calibre8"><span class="calibre39">startElement</span></span> by popping the <span class="calibre8"><span class="calibre39">*stack*</span></span> and placing the top of the <span class="calibre8"><span class="calibre39">*stack*</span></span> in <span class="calibre8"><span class="calibre39">*current*</span></span>. </p><p class="calibre12"> It is worth noting that this style of coding is the industry norm: objects are mutable, and programs are single-threadedly oblivious to the possibility of concurrency. Clojure permits this style as an explicit special case, and you should use it for interop purposes only. </p><p class="calibre12"> The <span class="calibre8"><span class="calibre39">ContentHandler</span></span>’s use of <span class="calibre8"><span class="calibre39">set!</span></span> does not leak mutable data out into the rest of Clojure. Clojure uses the <span class="calibre8"><span class="calibre39">ContentHandler</span></span> implementation to build an immutable Clojure structure. </p><p class="calibre12"> You have now seen four different models for dealing with state. And since Clojure is built atop Java, you can also use Java’s lock-based model. The models, and their use, are summarized in the following table. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><th valign="top" class="calibre51"><span class="bold">   </span><p class="calibre59"><span class="bold">Model  </span></p></th><th valign="top" class="calibre51"><span class="bold">   </span><p class="calibre59"><span class="bold">Usage  </span></p></th><th valign="top" class="calibre51"><span class="bold">   </span><p class="calibre59"><span class="bold">Functions  </span></p></th></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">Refs and STM  </p></td><td valign="top" class="calibre23">   <p class="calibre59">Coordinated, synchronous updates  </p></td><td valign="top" class="calibre23">   <p class="calibre59">Pure  </p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">Atoms  </p></td><td valign="top" class="calibre23">   <p class="calibre59">Uncoordinated, synchronous updates  </p></td><td valign="top" class="calibre23">   <p class="calibre59">Pure  </p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">Agents  </p></td><td valign="top" class="calibre23">   <p class="calibre59">Uncoordinated, asynchronous updates  </p></td><td valign="top" class="calibre23">   <p class="calibre59">Any  </p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">Vars  </p></td><td valign="top" class="calibre23">   <p class="calibre59">Thread-local dynamic scopes  </p></td><td valign="top" class="calibre23">   <p class="calibre59">Any  </p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">Java locks  </p></td><td valign="top" class="calibre23">   <p class="calibre59">Coordinated, synchronous updates  </p></td><td valign="top" class="calibre23">   <p class="calibre59">Any  </p></td></tr></table><p class="calibre27">Let’s put these models to work in designing a small but complete application. </p><div class="mbppagebreak"></div><p id="filepos798340" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">5.6 A Clojure Snake</span></span></span></p><p class="calibre34"> The Snake game features a player-controlled snake that moves around a game grid hunting for an apple. When your snake eats an apple, it grows longer by a segment, and a new apple appears. If your snake reaches a certain length, you win. But if your snake crosses over its own body, you lose. </p><p class="calibre12"> Before you start building your own snake, take a minute to try the completed version. From the book’s REPL, enter the following: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(use 'examples.snake)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(game)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; [#&lt;Ref clojure.lang.Ref@65694ee6&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​#&lt;Ref clojure.lang.Ref@261ae209&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​#&lt;Timer javax.swing.Timer@7f0df737&gt;]​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Select the Snake window, and use the arrow keys to control your snake.</p><p class="calibre12"> Our design for the snake is going to take advantage of Clojure’s functional nature and its support for explicit mutable state by dividing the game into three layers: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> The <span class="italic">functional model</span> will use pure functions to model as much of the game as possible. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> The <span class="italic">mutable model</span> will handle the mutable state of the game. The mutable model will use one or more of the reference models discussed in this chapter. Mutable state is much harder to test, so we will keep this part small. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> The <span class="italic">GUI</span> will use Swing to draw the game and to accept input from the user. </p></li><a></a></ul><p class="calibre12">These layers will make the Snake easy to build, test, and maintain.</p><p class="calibre12"> As you work through this example, add your code to the file <span class="calibre8"><span class="calibre39">reader/</span></span>
<span class="calibre8"><span class="calibre39">snake.clj</span></span> in the sample code. When you open the file, you will see that it already imports/uses the Swing classes and Clojure libraries you will need: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/reader/snake.clj"><span class="calibre41"><span class="underline">src/reader/snake.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">ns</span></span></span><span class="calibre8"> reader.snake​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:import (java.awt Color Dimension)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​           (javax.swing JPanel JFrame Timer JOptionPane)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​           (java.awt.event ActionListener KeyListener))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:use examples.import-static))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(import-static java.awt.event.KeyEvent VK_LEFT VK_RIGHT VK_UP VK_DOWN)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Now you are ready to build the functional model.</p><blockquote class="calibre47"><span class="calibre41"><span class="bold">Other Snake Implementations</span></span></blockquote><blockquote class="calibre48"><span class="calibre41"> There’s more than one way to skin a snake. You may enjoy comparing the snake presented here with these other snakes: </span></blockquote><div class="calibre72"> </div><ul class="calibre15"><li value="1" class="calibre16"><blockquote class="calibre48"><span class="calibre41"> David Van Horn’s Snake,</span><a href="#filepos864940"><span class="calibre41">[43]</span></a><span class="calibre41"> written in Typed Scheme, has no mutable state. </span></blockquote></li><a id="filepos803779"></a><li value="2" class="calibre73"><blockquote class="calibre48"><span class="calibre41"> Jeremy Read wrote a Java Snake</span><a href="#filepos865259"><span class="calibre41">[44]</span></a><span class="calibre41"> designed to be “just about as small as you can make it in Java and still be readable.” </span></blockquote></li><a id="filepos804100"></a><li value="3" class="calibre73"><blockquote class="calibre48"><span class="calibre41"> Abhishek Reddy wrote a tiny (35-line) Snake</span><a href="#filepos865588"><span class="calibre41">[45]</span></a><span class="calibre41"> in Clojure. The design goal was to be abnormally terse. </span></blockquote></li><a id="filepos804399"></a><li value="4" class="calibre73"><blockquote class="calibre48"><span class="calibre41"> Dale Vaillancourt’s Worm Game.</span><a href="#filepos865979"><span class="calibre41">[46]</span></a><span class="calibre41">
</span></blockquote></li><a id="filepos804631"></a><li value="5" class="calibre73"><blockquote class="calibre48"><span class="calibre41"> Mark Volkmann wrote a Clojure Snake</span><a href="#filepos866332"><span class="calibre41">[47]</span></a><span class="calibre41"> designed for readability. </span></blockquote></li><a id="filepos804892"></a></ul><blockquote class="calibre61"><span class="calibre41"> Each of the snake implementations has its own distinctive style. What would </span><span class="calibre41"><span class="italic">your</span></span><span class="calibre41"> style look like? </span></blockquote><p class="calibre74"><span class="calibre4"><span class="bold"><span class="calibre28">The Functional Model</span></span></span></p><p class="calibre44">First, create a set of constants to describe time, space, and motion:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> width 75)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> height 50)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> point-size 10)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> turn-millis 75)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> win-length 5)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> dirs { VK_LEFT  [-1  0]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            VK_RIGHT [ 1  0]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            VK_UP    [ 0 -1]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            VK_DOWN  [ 0  1]})​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">width</span></span> and <span class="calibre8"><span class="calibre39">height</span></span> set the size of the game board, and <span class="calibre8"><span class="calibre39">point-size</span></span> is used to convert a game point into screen pixels. <span class="calibre8"><span class="calibre39">turn-millis</span></span> is the heartbeat of the game, controlling how many milliseconds pass before each update of the game board. <span class="calibre8"><span class="calibre39">win-length</span></span> is how many segments your snake needs before you win the game. (Five is a boringly small number suitable for testing.) The <span class="calibre8"><span class="calibre39">dirs</span></span> maps symbolic constants for the four directions to their vector equivalents. Since Swing already defines the <span class="calibre8"><span class="calibre39">VK_</span></span> constants for different directions, we will reuse them here rather than defining our own. </p><p class="calibre12"> Next, create some basic math functions for the game:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> add-points [&amp; pts]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">vec</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">apply</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">map</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">+</span></span></span><span class="calibre8"> pts)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> point-to-screen-rect [pt]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">map</span></span></span><span class="calibre8"> #(</span><span class="calibre8"><span class="bold"><span class="calibre36">*</span></span></span><span class="calibre8"> point-size %)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​       [(pt 0) (pt 1) 1 1]))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">add-points</span></span> function adds points together. You can use <span class="calibre8"><span class="calibre39">add-points</span></span> to calculate the new position of a moving game object. For example, you can move an object at <span class="calibre8"><span class="calibre39">[10, 10]</span></span> left by one: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(add-points [10 10] [-1 0])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; [9 10]​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">point-to-screen-rect</span></span> simply converts a point in game space to a rectangle on the screen: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(point-to-screen-rect [5 10])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (50 100 10 10)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Next, let’s write a function to create a new apple:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> create-apple []​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  {:location [(</span><span class="calibre8"><span class="bold"><span class="calibre36">rand-int</span></span></span><span class="calibre8"> width) (</span><span class="calibre8"><span class="bold"><span class="calibre36">rand-int</span></span></span><span class="calibre8"> height)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   :color (Color. 210 50 90)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   :type :apple})​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Apples occupy a single point, the <span class="calibre8"><span class="calibre39">:location</span></span>, which is guaranteed to be on the game board. Snakes are a little bit more complicated: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> create-snake []​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  {:body (</span><span class="calibre8"><span class="bold"><span class="calibre36">list</span></span></span><span class="calibre8"> [1 1])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   :dir [1 0]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   :type :snake​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   :color (Color. 15 160 70)})​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Because a snake can occupy multiple points on the board, it has a <span class="calibre8"><span class="calibre39">:body</span></span>, which is a list of points. Also, snakes are always in motion in some direction expressed by <span class="calibre8"><span class="calibre39">:dir</span></span>. </p><p class="calibre12"> Next, create a function to <span class="calibre8"><span class="calibre39">move</span></span> a snake. This should be a pure function, returning a new snake. Also, it should take a <span class="calibre8"><span class="calibre39">grow</span></span> option, allowing the snake to grow after eating an apple. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> move [{:keys [body dir] :as snake} &amp; grow]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">assoc</span></span></span><span class="calibre8"> snake :body (</span><span class="calibre8"><span class="bold"><span class="calibre36">cons</span></span></span><span class="calibre8"> (add-points (</span><span class="calibre8"><span class="bold"><span class="calibre36">first</span></span></span><span class="calibre8"> body) dir)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                           (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> grow body (</span><span class="calibre8"><span class="bold"><span class="calibre36">butlast</span></span></span><span class="calibre8"> body)))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">move</span></span> uses a fairly complex binding expression. The <span class="calibre8"><span class="calibre39">{:keys [body dir]}</span></span> part makes the snake’s <span class="calibre8"><span class="calibre39">body</span></span> and <span class="calibre8"><span class="calibre39">dir</span></span> available as their own bindings, and the <span class="calibre8"><span class="calibre39">:as snake</span></span> part binds <span class="calibre8"><span class="calibre39">snake</span></span> to the entire snake. The function then proceeds as follows: </p><div class="calibre14"> </div><ol class="calibre68"><li value="1" class="calibre16"><p class="calibre29"><span class="calibre8"><span class="calibre39">add-points</span></span> creates a new point, which is the head of the original snake offset by the snake’s direction of motion. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">cons</span></span> adds the new point to the front of the snake. If the snake is growing, the entire original snake is kept. Otherwise, it keeps all the original snake except the last segment (<span class="calibre8"><span class="calibre39">butlast</span></span>). </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">assoc</span></span> returns a new snake, which is a copy of the old snake but with an updated <span class="calibre8"><span class="calibre39">:body</span></span>. </p></li><a></a></ol><p class="calibre12">Test <span class="calibre8"><span class="calibre39">move</span></span> by moving and growing a snake:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(move (create-snake))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:body ([2 1]), ; etc.​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(move (create-snake) :grow)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:body ([2 1] [1 1]), ; etc.​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Write a <span class="calibre8"><span class="calibre39">win?</span></span> function to test whether a snake has won the game: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> win? [{body :body}]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">&gt;</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">count</span></span></span><span class="calibre8"> body) win-length))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Test <span class="calibre8"><span class="calibre39">win?</span></span> against different body sizes. Note that <span class="calibre8"><span class="calibre39">win?</span></span> binds only the <span class="calibre8"><span class="calibre39">:body</span></span>, so you don’t need a “real” snake, just anything with a body: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(win? {:body [[1 1]]})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; false​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(win? {:body [[1 1] [1 2] [1 3] [1 4] [1 5]]})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> A snake loses if its head ever comes back into contact with the rest of its body. Write a <span class="calibre8"><span class="calibre39">head-overlaps-body?</span></span> function to test for this, and use it to define <span class="calibre8"><span class="calibre39">lose?</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> head-overlaps-body? [{[head &amp; body] :body}]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">contains?</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">set</span></span></span><span class="calibre8"> body) head))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> lose? head-overlaps-body?)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Test <span class="calibre8"><span class="calibre39">lose?</span></span> against overlapping and nonoverlapping snake bodies: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(lose? {:body [[1 1] [1 2] [1 3]]})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; false​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(lose? {:body [[1 1] [1 2] [1 1]]})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> A snake eats an apple if its head occupies the apple’s location. Define an <span class="calibre8"><span class="calibre39">eats?</span></span> function to test this: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> eats? [{[snake-head] :body} {apple :location}]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> snake-head apple))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Notice how clean the body of the <span class="calibre8"><span class="calibre39">eats?</span></span> function is. All the work is done in the bindings: <span class="calibre8"><span class="calibre39">{[snake-head] :body}</span></span> binds <span class="calibre8"><span class="calibre39">snake-head</span></span> to the first element of the snake’s <span class="calibre8"><span class="calibre39">:body</span></span>, and <span class="calibre8"><span class="calibre39">{apple :location}</span></span> binds <span class="calibre8"><span class="calibre39">apple</span></span> to the apple’s <span class="calibre8"><span class="calibre39">:location</span></span>. Test <span class="calibre8"><span class="calibre39">eats?</span></span> from the REPL: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(eats? {:body [[1 1] [1 2]]} {:location [2 2]})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; false​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(eats? {:body [[2 2] [1 2]]} {:location [2 2]})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Finally, you need some way to <span class="calibre8"><span class="calibre39">turn</span></span> the snake, updating its <span class="calibre8"><span class="calibre39">:dir</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> turn [snake newdir]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">assoc</span></span></span><span class="calibre8"> snake :dir newdir))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">turn</span></span> returns a new snake, with an updated direction: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(turn (create-snake) [0 -1])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:body ([1 1]), :dir [0 -1], ; etc.​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> All of the code you have written so far is part of the functional model of the Snake game. It is easy to understand in part because it has no local variables and no mutable state. As you will see in the next section, the amount of <span class="italic">mutable</span> state in the game is quite small. (It is even possible to implement the Snake with <span class="italic">no</span> mutable state, but that is not the purpose of this demo.) </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Building a Mutable Model with STM</span></span></span></p><p class="calibre44"> The mutable state of the Snake game can change in only three ways: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">A game can be reset to its initial state.</p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Every turn, the snake updates its position. If it eats an apple, a new apple is placed. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29">A snake can turn.</p></li><a></a></ul><p class="calibre12"> We will implement each of these changes as functions that modify Clojure refs inside a transaction. That way, changes to the position of the snake and the apple will be synchronous and coordinated. </p><p class="calibre12"><span class="calibre8"><span class="calibre39">reset-game</span></span> is trivial:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> reset-game [snake apple]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">dosync</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">ref-set</span></span></span><span class="calibre8"> apple (create-apple))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          (</span><span class="calibre8"><span class="bold"><span class="calibre36">ref-set</span></span></span><span class="calibre8"> snake (create-snake)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  nil)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> You can test <span class="calibre8"><span class="calibre39">reset-game</span></span> by passing in some refs and then checking that they dereference to a snake and an apple: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def test-snake (ref nil))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def test-apple (ref nil))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(reset-game test-snake test-apple)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​@test-snake​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:body ([1 1]), :dir [1 0], ; etc.​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​@test-apple​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:location [52 8], ; etc.​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">update-direction</span></span> is even simpler; it’s just a trivial wrapper around the functional <span class="calibre8"><span class="calibre39">turn</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> update-direction [snake newdir]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">when</span></span></span><span class="calibre8"> newdir (</span><span class="calibre8"><span class="bold"><span class="calibre36">dosync</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">alter</span></span></span><span class="calibre8"> snake turn newdir))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Try turning your <span class="calibre8"><span class="calibre39">test-snake</span></span> to move in the “up” direction: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(update-direction test-snake [0 -1])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:body ([1 1]), :dir [0 -1], ; etc.​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The most complicated mutating function is <span class="calibre8"><span class="calibre39">update-positions</span></span>. If the snake eats the apple, a new apple is created, and the snake grows. Otherwise, the snake simply moves: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> update-positions [snake apple]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">dosync</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (eats? @snake @apple)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     (</span><span class="calibre8"><span class="bold"><span class="calibre36">do</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">ref-set</span></span></span><span class="calibre8"> apple (create-apple))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​         (</span><span class="calibre8"><span class="bold"><span class="calibre36">alter</span></span></span><span class="calibre8"> snake move :grow))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     (</span><span class="calibre8"><span class="bold"><span class="calibre36">alter</span></span></span><span class="calibre8"> snake move)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  nil)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">To test <span class="calibre8"><span class="calibre39">update-positions</span></span>, reset the game:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(reset-game test-snake test-apple)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Then, move the apple into harm’s way, under the snake:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(dosync (alter test-apple assoc :location [1 1]))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:location [1 1], ; etc.​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now, after you <span class="calibre8"><span class="calibre39">update-positions</span></span>, you should have a bigger, two-segment snake: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(update-positions test-snake test-apple)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(:body @test-snake)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ([2 1] [1 1])​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> And that is all the mutable state of the Snake world: three functions, about a dozen lines of code. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">The Snake GUI</span></span></span></p><p class="calibre44"> The Snake GUI consists of functions that paint screen objects, respond to user input, and set up the various Swing components. Since snakes and apples are drawn from simple points, the painting functions are simple. The <span class="calibre8"><span class="calibre39">fill-point</span></span> function fills in a single point: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> fill-point [g pt color]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [[x y width height] (point-to-screen-rect pt)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">setColor g color)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">fillRect g x y width height)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">The <span class="calibre8"><span class="calibre39">paint</span></span> multimethod knows how to paint snakes and apples:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">Line 1</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmulti</span></span></span><span class="calibre8"> paint (</span><span class="calibre8"><span class="bold"><span class="calibre36">fn</span></span></span><span class="calibre8"> [g object &amp; _] (:type object)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">2</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">3</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> paint :apple [g {:keys [location color]}] ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">4</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (fill-point g location color))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">5</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">6</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> paint :snake [g {:keys [body color]}] ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">7</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">doseq</span></span></span><span class="calibre8"> [point body]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">8</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (fill-point g point color)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">paint</span></span> takes two required arguments: <span class="calibre8"><span class="calibre39">g</span></span> is a <span class="calibre8"><span class="calibre39">java.awt.Graphics</span></span> instance, and <span class="calibre8"><span class="calibre39">object</span></span> is the object to be painted. The <span class="calibre8"><span class="calibre39">defmulti</span></span> includes an optional <span class="calibre8"><span class="calibre39">rest</span></span> argument so that future implementations of <span class="calibre8"><span class="calibre39">paint</span></span> have the option of taking more arguments. (See Section 8.2, <a href="#filepos1164941">​<span class="italic">Defining Multimethods</span>​</a> for an in-depth description of <span class="calibre8"><span class="calibre39">defmulti</span></span>.) On line 3, the <span class="calibre8"><span class="calibre39">:apple</span></span> method of <span class="calibre8"><span class="calibre39">paint</span></span> binds the <span class="calibre8"><span class="calibre39">location</span></span> and <span class="calibre8"><span class="calibre39">color</span></span> of the apple and uses them to paint a single point on the screen. On line 6, the <span class="calibre8"><span class="calibre39">:snake</span></span> method binds the snake’s <span class="calibre8"><span class="calibre39">body</span></span> and <span class="calibre8"><span class="calibre39">color</span></span> and then uses <span class="calibre8"><span class="calibre39">doseq</span></span> to paint each <span class="calibre8"><span class="calibre39">point</span></span> in the <span class="calibre8"><span class="calibre39">body</span></span>. </p><p class="calibre12"> The meat of the UI is the <span class="calibre8"><span class="calibre39">game-panel</span></span> function, which creates a Swing <span class="calibre8"><span class="calibre39">JPanel</span></span> with handlers for painting the game, updating on each timer tick, and responding to user input: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">Line 1</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> game-panel [frame snake apple]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">proxy</span></span></span><span class="calibre8"> [JPanel ActionListener KeyListener] []​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (paintComponent [g] ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">proxy-super</span></span></span><span class="calibre8"> paintComponent g)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">5</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (paint g @snake)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (paint g @apple))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (actionPerformed [e] ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (update-positions snake apple)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">when</span></span></span><span class="calibre8"> (lose? @snake)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">10</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        (reset-game snake apple)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        (JOptionPane/showMessageDialog frame </span><span class="calibre8"><span class="italic"><span class="calibre42">"You lose!"</span></span></span><span class="calibre8">))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">when</span></span></span><span class="calibre8"> (win? @snake)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        (reset-game snake apple)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        (JOptionPane/showMessageDialog frame </span><span class="calibre8"><span class="italic"><span class="calibre42">"You win!"</span></span></span><span class="calibre8">))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">15</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">repaint this))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (keyPressed [e] ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (update-direction snake (dirs (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getKeyCode e))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (getPreferredSize []​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (Dimension. (</span><span class="calibre8"><span class="bold"><span class="calibre36">*</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">inc</span></span></span><span class="calibre8"> width) point-size)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">20</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                  (</span><span class="calibre8"><span class="bold"><span class="calibre36">*</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">inc</span></span></span><span class="calibre8"> height) point-size)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (keyReleased [e])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (keyTyped [e])))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">game-panel</span></span> is long but simple. It uses <span class="calibre8"><span class="calibre39">proxy</span></span> to create a panel with a set of Swing callback methods. </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Swing calls <span class="calibre8"><span class="calibre39">paintComponent</span></span> (line 3) to draw the panel. <span class="calibre8"><span class="calibre39">paintComponent</span></span> calls <span class="calibre8"><span class="calibre39">proxy-super</span></span> to invoke the normal <span class="calibre8"><span class="calibre39">JPanel</span></span> behavior, and then it paints the snake and the apple. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Swing will call <span class="calibre8"><span class="calibre39">actionPerformed</span></span> (line 7) on every timer tick. <span class="calibre8"><span class="calibre39">actionPerformed</span></span> updates the positions of the snake and the apple. If the game is over, it displays a dialog and resets the game. Finally, it triggers a repaint with <span class="calibre8"><span class="calibre39">(.repaint this)</span></span>. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> Swing calls <span class="calibre8"><span class="calibre39">keyPressed</span></span> (line 16) in response to keyboard input. <span class="calibre8"><span class="calibre39">keyPressed</span></span> calls <span class="calibre8"><span class="calibre39">update-direction</span></span> to change the snake’s direction. (If the keyboard input is not an arrow key, the <span class="calibre8"><span class="calibre39">dirs</span></span> function returns <span class="calibre8"><span class="calibre39">nil</span></span> and <span class="calibre8"><span class="calibre39">update-direction</span></span> does nothing.) </p></li><a></a><li value="4" class="calibre30"><p class="calibre29">The game panel ignores <span class="calibre8"><span class="calibre39">keyReleased</span></span> and <span class="calibre8"><span class="calibre39">keyTyped</span></span>.</p></li><a></a></ul><p class="calibre12"> The <span class="calibre8"><span class="calibre39">game</span></span> function creates a new game:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">Line 1</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> game []​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [snake (</span><span class="calibre8"><span class="bold"><span class="calibre36">ref</span></span></span><span class="calibre8"> (create-snake)) ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        apple (</span><span class="calibre8"><span class="bold"><span class="calibre36">ref</span></span></span><span class="calibre8"> (create-apple))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        frame (JFrame. </span><span class="calibre8"><span class="italic"><span class="calibre42">"Snake"</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">5</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        panel (game-panel frame snake apple)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        timer (Timer. turn-millis panel)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">doto</span></span></span><span class="calibre8"> panel ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">setFocusable true)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">addKeyListener panel))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">10</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">doto</span></span></span><span class="calibre8"> frame ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">add panel)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">pack)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">setVisible true))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">-</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">start timer) ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">15</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    [snake, apple, timer])) ​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> On line 2, <span class="calibre8"><span class="calibre39">game</span></span> creates all the necessary game objects: the mutable model objects <span class="calibre8"><span class="calibre39">snake</span></span> and <span class="calibre8"><span class="calibre39">apple</span></span> and the UI components <span class="calibre8"><span class="calibre39">frame</span></span>, <span class="calibre8"><span class="calibre39">panel</span></span>, and <span class="calibre8"><span class="calibre39">timer</span></span>. Lines 7 and 10 perform boilerplate initialization of the <span class="calibre8"><span class="calibre39">panel</span></span> and <span class="calibre8"><span class="calibre39">frame</span></span>. Line 14 starts the game by kicking off the timer. </p><p class="calibre12"> Line 15 returns a vector with the snake, apple, and time. This is for convenience when testing at the REPL: you can use these objects to move the snake and apple or to start and stop the game. </p><p class="calibre12"> Go ahead and play the game again; you have earned it. To start the game, use the snake library at the REPL, and run <span class="calibre8"><span class="calibre39">game</span></span>. If you have entered the code yourself, you can use the library name you picked (<span class="calibre8"><span class="calibre39">examples.reader</span></span> in the instructions); otherwise, you can use the completed sample at <span class="calibre8"><span class="calibre39">examples.snake</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(use 'examples.snake)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(game)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; [#&lt;Ref clojure.lang.Ref@6ea27cbe&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​#&lt;Ref clojure.lang.Ref@6dabd6b0&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​#&lt;Timer javax.swing.Timer@32f60451&gt;]​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The game window may appear behind your REPL window. If this happens, use your local operating-system fu to locate the game window. </p><p class="calibre12"> There are many possible improvements to the Snake game. If the snake reaches the edge of the screen, perhaps it should turn to avoid disappearing from view. Or (tough love) maybe you just lose the game! Make the Snake game your own by improving it to suit your personal style. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Snakes Without Refs</span></span></span></p><p class="calibre44"> We chose to implement the Snake game’s mutable model using refs so that we could coordinate the updates to the snake and the apple. Other approaches are also valid. For example, you could combine the snake and apple state into a single <span class="calibre8"><span class="calibre39">game</span></span> object. With only one object, coordination is no longer required, and you can use an atom instead. </p><p class="calibre12"> The file <span class="calibre8"><span class="calibre39">examples/atom-snake.clj</span></span> demonstrates this approach. Functions like <span class="calibre8"><span class="calibre39">update-positions</span></span> become part of the functional model and return a new game object with updated state: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/atom_snake.clj"><span class="calibre41"><span class="underline">src/examples/atom_snake.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> update-positions [{snake :snake, apple :apple, :as game}]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (eats? snake apple)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">merge</span></span></span><span class="calibre8"> game {:apple (create-apple) :snake (move snake :grow)})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">merge</span></span></span><span class="calibre8"> game {:snake (move snake)})))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Notice how destructuring makes it easy to get at the internals of the <span class="calibre8"><span class="calibre39">game</span></span>: both <span class="calibre8"><span class="calibre39">snake</span></span> and <span class="calibre8"><span class="calibre39">apple</span></span> are bound by the argument list. </p><p class="calibre12"> The actual mutable updates are now all atom <span class="calibre8"><span class="calibre39">swap!</span></span>s. We found these to be simple enough to leave them in the UI function <span class="calibre8"><span class="calibre39">game-panel</span></span>, as this excerpt shows: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(actionPerformed [e]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">swap!</span></span></span><span class="calibre8"> game update-positions)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">when</span></span></span><span class="calibre8"> (lose? (@game :snake))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">swap!</span></span></span><span class="calibre8"> game reset-game)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (JOptionPane/showMessageDialog frame </span><span class="calibre8"><span class="italic"><span class="calibre42">"You lose!"</span></span></span><span class="calibre8">))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> There are other possibilities as well. Chris Houser’s fork of the book’s sample code<a id="filepos863116"></a><a href="#filepos866663">[48]</a> demonstrates using an agent that <span class="calibre8"><span class="calibre39">Thread/sleep</span></span>s instead of a Swing timer, as well as using a new agent per game turn to update the game’s state. </p><div class="mbppagebreak"></div><p id="filepos863368" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">5.7 Wrapping Up</span></span></span></p><p class="calibre34"> Clojure’s reference model is the most innovative part of the language. The combination of software transactional memory, agents, atoms, and dynamic binding that you have seen in this chapter gives Clojure powerful abstractions for all sorts of stateful systems. It also makes Clojure one of the few languages suited to the coming generation of multicore computer hardware. </p><p class="calibre12"> Next, we will look at one of Clojure’s newer features. Some call it a solution to the “expression problem.”<a id="filepos864034"></a><a href="#filepos866998">[49]</a> We call it a protocol. </p><p class="calibre27"><span class="calibre8"><span class="bold"><span class="calibre28">Footnotes</span></span></span></p><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos704109"><span class="calibre8">[42]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://www.infoq.com/presentations/Simple-Made-Easy"><span class="calibre8">http://www.infoq.com/presentations/Simple-Made-Easy</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos864551"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos803779"><span class="calibre8">[43]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://planet.plt-scheme.org/package-source/dvanhorn/snake.plt/1/0/main.ss"><span class="calibre8">http://planet.plt-scheme.org/package-source/dvanhorn/snake.plt/1/0/main.ss</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos864940"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos804100"><span class="calibre8">[44]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://www.plt1.com/1069/smaller-snake/"><span class="calibre8">http://www.plt1.com/1069/smaller-snake/</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos865259"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos804399"><span class="calibre8">[45]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://www.plt1.com/1070/even-smaller-snake/"><span class="calibre8">http://www.plt1.com/1070/even-smaller-snake/</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos865588"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos804631"><span class="calibre8">[46]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://www.ccs.neu.edu/home/cce/acl2/worm.html"><span class="calibre8">http://www.ccs.neu.edu/home/cce/acl2/worm.html</span></a><span class="calibre8"> includes some verifications using the theorem prover ACL2.</span></p></td></tr><a id="filepos865979"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos804892"><span class="calibre8">[47]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://www.ociweb.com/mark/programming/ClojureSnake.html"><span class="calibre8">http://www.ociweb.com/mark/programming/ClojureSnake.html</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos866332"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos863116"><span class="calibre8">[48]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://github.com/Chouser/programming-clojure"><span class="calibre8">http://github.com/Chouser/programming-clojure</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos866663"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos864034"><span class="calibre8">[49]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://en.wikipedia.org/wiki/Expression_problem"><span class="calibre8">http://en.wikipedia.org/wiki/Expression_problem</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos866998"></a></table><p class="calibre18"><span class="calibre8"><span class="calibre19"><span class="calibre20">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="mbppagebreak"></div><p id="filepos867195" class="calibre25"><span class="calibre2"><span class="bold"><span class="calibre43"> Chapter 6</span></span></span></p><br class="calibre11"/><p class="calibre26"><span class="calibre2"><span class="bold"><span class="calibre3">Protocols and Datatypes</span></span></span></p><p class="calibre12"> Abstractions lay at the foundation of reusable code. The Clojure language itself has abstractions for sequences, collections, and callability. Traditionally, these abstractions were described with Java interfaces and implemented using Java classes. In the beginning, Clojure provided <span class="calibre8"><span class="calibre39">proxy</span></span> and <span class="calibre8"><span class="calibre39">genclass</span></span>, removing the need to drop all the way to Java to achieve this, but that has changed with the introduction of protocols. </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Protocols provide an alternative to Java interfaces for high-performance polymorphic method dispatch. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Datatypes provide an alternative to Java classes for creating implementations of abstractions defined with either protocols or interfaces. </p></li><a></a></ul><p class="calibre12"> Protocols and datatypes provide a high-performance, flexible mechanism for abstraction and concretion that removes the need to write Java interfaces and classes when programming in Clojure. With protocols and datatypes, you can create new abstractions and new types that implement those abstractions and even extend new abstractions to existing types. </p><p class="calibre12"> In this chapter, we will explore Clojure’s approach to abstraction using protocols and datatypes. First, we will implement our own version of Clojure’s built-in <span class="calibre8"><span class="calibre39">spit</span></span> and <span class="calibre8"><span class="calibre39">slurp</span></span> functions. Then, we will take a short detour to build a <span class="calibre8"><span class="calibre39">CryptoVault</span></span>, where you will learn about extending some of Java’s standard library. Finally, we will put everything together using records and protocols to define musical notes and sequences. After working through these exercises, you will certainly see the power of Clojure’s composable abstractions. </p><div class="mbppagebreak"></div><p id="filepos869565" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">6.1 Programming to Abstractions</span></span></span></p><p class="calibre34"> Clojure’s <span class="calibre8"><span class="calibre39">spit</span></span> and <span class="calibre8"><span class="calibre39">slurp</span></span> I/O functions are built on two abstractions, reading and writing. This means you can use them with a variety of source and destination types, including files, URLs, and sockets, and they can be extended to support new types by anybody, whether they are existing types or newly defined. </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> The <span class="calibre8"><span class="calibre39">slurp</span></span> function takes an input source, reads the contents, and returns it as a string. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> The <span class="calibre8"><span class="calibre39">spit</span></span> function takes an output destination and a value, converts the value to a string, and writes it to the output destination. </p></li><a></a></ul><p class="calibre12"> We will start by writing basic versions of the two functions that can read from and write to files only. We will then refactor the basic versions several times as we explore different approaches to supporting additional datatypes. Working through this will give you a good feel for the usefulness of programming to abstractions in general and the flexibility and power of Clojure’s protocols and datatypes in particular. </p><p class="calibre12"> After writing our versions of <span class="calibre8"><span class="calibre39">spit</span></span> and <span class="calibre8"><span class="calibre39">slurp</span></span>, called <span class="calibre8"><span class="calibre39">expectorate</span></span> and <span class="calibre8"><span class="calibre39">gulp</span></span>, respectively, that work with several existing datatypes, we will create a new <span class="calibre8"><span class="calibre39">datatype</span></span>, <span class="calibre8"><span class="calibre39">CryptoVault</span></span>, that can be used with our versions of the functions as well as the originals.</p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">gulp and expectorate</span></span></span></p><p class="calibre44"> The <span class="calibre8"><span class="calibre39">gulp</span></span> function is a simplified version of Clojure’s <span class="calibre8"><span class="calibre39">slurp</span></span> function, and <span class="calibre8"><span class="calibre39">expectorate</span></span>, despite its highfalutin name, is a dumbed-down version of Clojure’s <span class="calibre8"><span class="calibre39">spit</span></span> function. Let’s write a basic version of <span class="calibre8"><span class="calibre39">gulp</span></span> that can read from a <span class="calibre8"><span class="calibre39">java.io.File</span></span> only. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/gulp.clj"><span class="calibre41"><span class="underline">src/examples/gulp.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">ns</span></span></span><span class="calibre8"> examples.gulp​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:import (java.io FileInputStream InputStreamReader BufferedReader)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> gulp [src]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [sb (StringBuilder.)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">with-open</span></span></span><span class="calibre8"> [reader (</span><span class="calibre8"><span class="bold"><span class="calibre36">-&gt;</span></span></span><span class="calibre8"> src​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                           FileInputStream.​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                           InputStreamReader.​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                           BufferedReader.)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">loop</span></span></span><span class="calibre8"> [c (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">read</span></span></span><span class="calibre8"> reader)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">neg?</span></span></span><span class="calibre8"> c)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          (</span><span class="calibre8"><span class="bold"><span class="calibre36">str</span></span></span><span class="calibre8"> sb)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          (</span><span class="calibre8"><span class="bold"><span class="calibre36">do</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">append sb (</span><span class="calibre8"><span class="bold"><span class="calibre36">char</span></span></span><span class="calibre8"> c))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            (</span><span class="calibre8"><span class="bold"><span class="calibre36">recur</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">read</span></span></span><span class="calibre8"> reader))))))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">gulp</span></span> function creates a <span class="calibre8"><span class="calibre39">BufferedReader</span></span> from a given <span class="calibre8"><span class="calibre39">File</span></span> object and then <span class="calibre8"><span class="calibre39">loop</span></span>s/<span class="calibre8"><span class="calibre39">recurs</span></span> over it, reading a character at a time and appending each to a <span class="calibre8"><span class="calibre39">StringBuilder</span></span> until it reaches the end of the input where it returns a string. The basic <span class="calibre8"><span class="calibre39">expectorate</span></span> function is even smaller:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/expectorate.clj"><span class="calibre41"><span class="underline">src/examples/expectorate.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">ns</span></span></span><span class="calibre8"> examples.expectorate​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:import (java.io FileOutputStream OutputStreamWriter BufferedWriter)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> expectorate [dst content]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">with-open</span></span></span><span class="calibre8"> [writer (</span><span class="calibre8"><span class="bold"><span class="calibre36">-&gt;</span></span></span><span class="calibre8"> dst​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                         FileOutputStream.​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                         OutputStreamWriter.​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                         BufferedWriter.)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write writer (</span><span class="calibre8"><span class="bold"><span class="calibre36">str</span></span></span><span class="calibre8"> content))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> It creates a <span class="calibre8"><span class="calibre39">BufferedWriter</span></span> file, converts the value of the content parameter to a string, and writes it out to the <span class="calibre8"><span class="calibre39">BufferedWriter</span></span>. </p><p class="calibre12"> But what if we want to support additional types like <span class="calibre8"><span class="calibre39">Socket</span></span>s, URLs, and basic input and output streams? We need to update <span class="calibre8"><span class="calibre39">gulp</span></span> and <span class="calibre8"><span class="calibre39">expectorate</span></span> to be able to make <span class="calibre8"><span class="calibre39">BufferedReaders</span></span> and <span class="calibre8"><span class="calibre39">BufferedWriters</span></span> from datatypes other than files. So, let’s create two new functions, <span class="calibre8"><span class="calibre39">make-reader</span></span> and <span class="calibre8"><span class="calibre39">make-writer</span></span>, that will be responsible for this behavior. </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> The <span class="calibre8"><span class="calibre39">make-reader</span></span> function makes a <span class="calibre8"><span class="calibre39">BufferedReader</span></span> from an input source. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> The <span class="calibre8"><span class="calibre39">make-writer</span></span> makes a <span class="calibre8"><span class="calibre39">BufferedWriter</span></span> from an output destination. </p></li><a></a></ul><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> make-reader [src]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">-&gt;</span></span></span><span class="calibre8"> src FileInputStream. InputStreamReader. BufferedReader.))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> make-writer [dst]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">-&gt;</span></span></span><span class="calibre8"> dst FileOutputStream. OutputStreamWriter. BufferedWriter.))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Like our basic <span class="calibre8"><span class="calibre39">gulp</span></span> and <span class="calibre8"><span class="calibre39">expectorate</span></span> functions, <span class="calibre8"><span class="calibre39">make-reader</span></span> and <span class="calibre8"><span class="calibre39">make-writer</span></span> work only on files, but that will change shortly. Now let’s refactor <span class="calibre8"><span class="calibre39">gulp</span></span> and <span class="calibre8"><span class="calibre39">expectorate</span></span> to use the new functions: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/protocols.clj"><span class="calibre41"><span class="underline">src/examples/protocols.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> gulp [src]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [sb (StringBuilder.)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">with-open</span></span></span><span class="calibre8"> [reader (make-reader src)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">loop</span></span></span><span class="calibre8"> [c (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">read</span></span></span><span class="calibre8"> reader)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">neg?</span></span></span><span class="calibre8"> c)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          (</span><span class="calibre8"><span class="bold"><span class="calibre36">str</span></span></span><span class="calibre8"> sb)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          (</span><span class="calibre8"><span class="bold"><span class="calibre36">do</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">append sb (</span><span class="calibre8"><span class="bold"><span class="calibre36">char</span></span></span><span class="calibre8"> c))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            (</span><span class="calibre8"><span class="bold"><span class="calibre36">recur</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">read</span></span></span><span class="calibre8"> reader))))))))​</span><span class="calibre8">
</span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> expectorate [dst content]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">with-open</span></span></span><span class="calibre8"> [writer (make-writer dst)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write writer (</span><span class="calibre8"><span class="bold"><span class="calibre36">str</span></span></span><span class="calibre8"> content))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> We can now add support for additional source and destination types to <span class="calibre8"><span class="calibre39">gulp</span></span> and <span class="calibre8"><span class="calibre39">expectorate</span></span> just by updating <span class="calibre8"><span class="calibre39">make-reader</span></span> and <span class="calibre8"><span class="calibre39">make-writer</span></span>. One approach to supporting additional types is to use a <span class="calibre8"><span class="calibre39">cond</span></span>, or <span class="calibre8"><span class="calibre39">condp</span></span>, statement to process different types appropriately. For example, the following version of <span class="calibre8"><span class="calibre39">make-reader</span></span> replaces the call to the <span class="calibre8"><span class="calibre39">FileInputStream</span></span> constructor with a <span class="calibre8"><span class="calibre39">condp</span></span> statement that creates an <span class="calibre8"><span class="calibre39">InputStream</span></span> from the given input, whether it is a <span class="calibre8"><span class="calibre39">File</span></span>, <span class="calibre8"><span class="calibre39">Socket</span></span>, or <span class="calibre8"><span class="calibre39">URL</span></span> or already is an <span class="calibre8"><span class="calibre39">InputStream</span></span>. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> make-reader [src]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">-&gt;</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">condp</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">type</span></span></span><span class="calibre8"> src)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          java.io.InputStream src​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          java.lang.String (FileInputStream. src)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          java.io.File (FileInputStream. src)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          java.net.Socket (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getInputStream src)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          java.net.URL (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"file"</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getProtocol src))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                         (</span><span class="calibre8"><span class="bold"><span class="calibre36">-&gt;</span></span></span><span class="calibre8"> src </span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getPath FileInputStream.)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                         (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">openStream src)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      InputStreamReader.​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      BufferedReader.))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Here’s a version of <span class="calibre8"><span class="calibre39">make-writer</span></span> using the same strategy:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> make-writer [dst]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">-&gt;</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">condp</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">type</span></span></span><span class="calibre8"> dst)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          java.io.OutputStream dst​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          java.io.File (FileOutputStream. dst)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          java.lang.String (FileOutputStream. dst)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          java.net.Socket (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getOutputStream dst)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          java.net.URL (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"file"</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getProtocol dst))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                         (</span><span class="calibre8"><span class="bold"><span class="calibre36">-&gt;</span></span></span><span class="calibre8"> dst </span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getPath FileOutputStream.)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                         (</span><span class="calibre8"><span class="bold"><span class="calibre36">throw</span></span></span><span class="calibre8"> (IllegalArgumentException.​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                                 </span><span class="calibre8"><span class="italic"><span class="calibre42">"Can't write to non-file URL"</span></span></span><span class="calibre8">))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      OutputStreamWriter.​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      BufferedWriter.))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The problem with this approach is that it is closed: nobody else can come along and add support for new source and destination types without rewriting <span class="calibre8"><span class="calibre39">make-reader</span></span> and <span class="calibre8"><span class="calibre39">make-writer</span></span>. What we need is an open solution, one where support for new types can be added after the fact and by different parties. What we need is two abstractions, one for reading and one for writing. </p><div class="mbppagebreak"></div><p id="filepos896919" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">6.2 Interfaces</span></span></span></p><p class="calibre34"> In Java, the usual mechanism for supporting this form of abstraction is the interface. The interface mechanism provides a means for dispatching calls to an abstract function, specified in an interface definition, to a specific implementation based on the datatype of the first parameter passed in the call. In Java, the first parameter is implicit; it is the object that implements the interface. </p><p class="calibre12">The following are the strengths of interfaces:</p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Datatypes can implement multiple interfaces. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Interfaces provide only specification, not implementation, which allows implementation of multiple interfaces without the problems associated with multiple class inheritance. </p></li><a></a></ul><p class="calibre12"> The weakness of interfaces is that existing datatypes cannot be extended to implement new interfaces without rewriting them. </p><p class="calibre12"> We can create Java interfaces in Clojure with the <span class="calibre8"><span class="calibre39">definterface</span></span> macro. This takes a name and one or more method signatures: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(definterface </span><span class="calibre8"><span class="bold"><span class="calibre36">name</span></span></span><span class="calibre8"> &amp; sigs)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Let’s create our abstraction for things-that-can-read-from-and-be-written-to as an interface, which we’ll call <span class="calibre8"><span class="calibre39">IOFactory</span></span>. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(definterface IOFactory​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (^java.io.BufferReader make-reader [this])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (^java.io.BufferedWriter make-writer [this]))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> This will create an interface called <span class="calibre8"><span class="calibre39">IOFactory</span></span> that includes two abstract functions, <span class="calibre8"><span class="calibre39">make-reader</span></span> and <span class="calibre8"><span class="calibre39">make-writer</span></span>. Any class that implements this interface must include <span class="calibre8"><span class="calibre39">make-reader</span></span> and <span class="calibre8"><span class="calibre39">make-writer</span></span> functions that take a single parameter and an instance of the datatype itself and that return a <span class="calibre8"><span class="calibre39">BufferedReader</span></span> and <span class="calibre8"><span class="calibre39">BufferedWriter</span></span>, respectively. </p><p class="calibre12"> Unfortunately, the interfaces that a class supports are determined at design time by the author; once a Java class is defined, it cannot be updated to support new interfaces without rewriting it. Therefore, we can’t extend the <span class="calibre8"><span class="calibre39">File</span></span>, <span class="calibre8"><span class="calibre39">Socket</span></span>, and <span class="calibre8"><span class="calibre39">URL</span></span> classes to implement the <span class="calibre8"><span class="calibre39">IOFactory</span></span> interface. </p><p class="calibre12"> Like the versions of <span class="calibre8"><span class="calibre39">make-reader</span></span> and <span class="calibre8"><span class="calibre39">make-writer</span></span> we based on <span class="calibre8"><span class="calibre39">condp</span></span>, our interface is closed to extension by parties other than the author. This is part of what is called the <span class="italic">expression problem</span>.<a id="filepos901114"></a><a href="#filepos1028427">[50]</a> Fortunately, Clojure has a solution to it.<a id="filepos901194"></a><a href="#filepos1028818">[51]</a>
</p><div class="mbppagebreak"></div><p id="filepos901252" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">6.3 Protocols</span></span></span></p><p class="calibre34"> One piece of Clojure’s solution to the expression problem is the protocol. Protocols provide a flexible mechanism for abstraction that leverages the best parts of interfaces by providing only specification, not implementation, and by letting datatypes implement multiple protocols. Additionally, protocols address the key weaknesses of interfaces by allowing nonintrusive extension of existing types to support new protocols. </p><p class="calibre12">The following are the strengths of protocols:</p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Datatypes can implement multiple protocols. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Protocols provide only specification, not implementation, which allows implementation of multiple interfaces without the problems associated with multiple-class inheritance. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> Existing datatypes can be extended to implement new interfaces with no modification to the datatypes. </p></li><a></a><li value="4" class="calibre30"><p class="calibre29"> Protocol method names are namespaced, so there is no risk of name collision when multiple parties choose to extend the same extant type. </p></li><a></a></ul><p class="calibre12"> The <span class="calibre8"><span class="calibre39">defprotocol</span></span> macro works just like <span class="calibre8"><span class="calibre39">definterface</span></span>, but now we are able to extend existing datatypes to implement our new abstraction. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defprotocol</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">name</span></span></span><span class="calibre8"> &amp; opts+sigs)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Let’s redefine <span class="calibre8"><span class="calibre39">IOFactory</span></span> as a protocol, instead of an interface. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defprotocol</span></span></span><span class="calibre8"> IOFactory​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="italic"><span class="calibre42">"A protocol for things that can be read from and written to."</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (make-reader [this] </span><span class="calibre8"><span class="italic"><span class="calibre42">"Creates a BufferedReader."</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (make-writer [this] </span><span class="calibre8"><span class="italic"><span class="calibre42">"Creates a BufferedWriter."</span></span></span><span class="calibre8">))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Notice we can include a document string for the protocol as a whole, as well as for each of its methods. Now let’s extend <span class="calibre8"><span class="calibre39">java.io.InputStream</span></span> and <span class="calibre8"><span class="calibre39">java.io.OutputStream</span></span> to implement our <span class="calibre8"><span class="calibre39">IOFactory</span></span> protocol. </p><p class="calibre12"> We use the <span class="calibre8"><span class="calibre39">extend</span></span> function to associate an existing type to a protocol and to provide the required function implementations, usually referred to as <span class="italic">methods</span> in this context. The parameters to extend are the name of the type to extend, the name of the protocol to implement, and a map of method implementations, where the keys are keywordized versions of the method names. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">extend</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">type</span></span></span><span class="calibre8"> &amp; proto+mmaps)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">make-reader</span></span> implementation for an <span class="calibre8"><span class="calibre39">InputStream</span></span> just wraps the value passed to it in a <span class="calibre8"><span class="calibre39">BufferedReader</span></span>. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/protocols.clj"><span class="calibre41"><span class="underline">src/examples/protocols.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">extend</span></span></span><span class="calibre8"> InputStream​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  IOFactory​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  {:make-reader (</span><span class="calibre8"><span class="bold"><span class="calibre36">fn</span></span></span><span class="calibre8"> [src]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                  (</span><span class="calibre8"><span class="bold"><span class="calibre36">-&gt;</span></span></span><span class="calibre8"> src InputStreamReader. BufferedReader.))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   :make-writer (</span><span class="calibre8"><span class="bold"><span class="calibre36">fn</span></span></span><span class="calibre8"> [dst]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                  (</span><span class="calibre8"><span class="bold"><span class="calibre36">throw</span></span></span><span class="calibre8"> (IllegalArgumentException.​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                          </span><span class="calibre8"><span class="italic"><span class="calibre42">"Can't open as an InputStream."</span></span></span><span class="calibre8">)))})​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Similarly, the implementation of <span class="calibre8"><span class="calibre39">make-writer</span></span> for an <span class="calibre8"><span class="calibre39">OutputStream</span></span> wraps its given input in a <span class="calibre8"><span class="calibre39">BufferedWriter</span></span>. And since you can’t write to an <span class="calibre8"><span class="calibre39">InputStream</span></span> or read from an <span class="calibre8"><span class="calibre39">OutputStream</span></span>, the respective implementations of <span class="calibre8"><span class="calibre39">make-writer</span></span> and <span class="calibre8"><span class="calibre39">make-reader</span></span> throw <span class="calibre8"><span class="calibre39">IllegalArgumentExceptions</span></span>. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">extend</span></span></span><span class="calibre8"> OutputStream​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  IOFactory​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  {:make-reader (</span><span class="calibre8"><span class="bold"><span class="calibre36">fn</span></span></span><span class="calibre8"> [src]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                  (</span><span class="calibre8"><span class="bold"><span class="calibre36">throw</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                   (IllegalArgumentException.​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                    </span><span class="calibre8"><span class="italic"><span class="calibre42">"Can't open as an OutputStream."</span></span></span><span class="calibre8">)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   :make-writer (</span><span class="calibre8"><span class="bold"><span class="calibre36">fn</span></span></span><span class="calibre8"> [dst]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                  (</span><span class="calibre8"><span class="bold"><span class="calibre36">-&gt;</span></span></span><span class="calibre8"> dst OutputStreamWriter. BufferedWriter.))})​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> We can extend the <span class="calibre8"><span class="calibre39">java.io.File</span></span> type to implement our <span class="calibre8"><span class="calibre39">IOFactory</span></span> protocol with the <span class="calibre8"><span class="calibre39">extend-type</span></span> macro, which provides a slightly cleaner syntax than <span class="calibre8"><span class="calibre39">extend</span></span>. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">extend-type</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">type</span></span></span><span class="calibre8"> &amp; specs)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> It takes the name of the type to extend and one or more specs, which includes a protocol name and its respective method implementations. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">extend-type</span></span></span><span class="calibre8"> File​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  IOFactory​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (make-reader [src]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (make-reader (FileInputStream. src)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (make-writer [dst]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (make-writer (FileOutputStream. dst))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Notice that we create an <span class="calibre8"><span class="calibre39">InputStream</span></span>, specifically, a <span class="calibre8"><span class="calibre39">FileInputStream</span></span>, from our file and then make a recursive call to <span class="calibre8"><span class="calibre39">make-reader</span></span>, which will be dispatched to the implementation defined earlier for <span class="calibre8"><span class="calibre39">InputStreams</span></span>. We use the same recursive pattern for the <span class="calibre8"><span class="calibre39">make-writer</span></span> method, as well as for the methods of the following remaining types. </p><p class="calibre12"> We can extend the remaining types all at once with the <span class="calibre8"><span class="calibre39">extend-protocol</span></span> macro: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">extend-protocol</span></span></span><span class="calibre8"> protocol &amp; specs)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> This takes the name of the protocol followed by one or more type names with their respective method implementations. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">extend-protocol</span></span></span><span class="calibre8"> IOFactory​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  Socket​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (make-reader [src]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (make-reader (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getInputStream src)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (make-writer [dst]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (make-writer (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getOutputStream dst)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  URL​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (make-reader [src]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (make-reader​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"file"</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getProtocol src))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​       (</span><span class="calibre8"><span class="bold"><span class="calibre36">-&gt;</span></span></span><span class="calibre8"> src </span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getPath FileInputStream.)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​       (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">openStream src))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (make-writer [dst]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (make-writer​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"file"</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getProtocol dst))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​       (</span><span class="calibre8"><span class="bold"><span class="calibre36">-&gt;</span></span></span><span class="calibre8"> dst </span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getPath FileInputStream.)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​       (</span><span class="calibre8"><span class="bold"><span class="calibre36">throw</span></span></span><span class="calibre8"> (IllegalArgumentException.​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​               </span><span class="calibre8"><span class="italic"><span class="calibre42">"Can't write to non-file URL"</span></span></span><span class="calibre8">))))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now let’s put it all together. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">ns</span></span></span><span class="calibre8"> examples.io​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:import (java.io File FileInputStream FileOutputStream​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                    InputStream InputStreamReader​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                    OutputStream OutputStreamWriter​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                    BufferedReader BufferedWriter)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​           (java.net Socket URL)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defprotocol</span></span></span><span class="calibre8"> IOFactory​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="italic"><span class="calibre42">"A protocol for things that can be read from and written to."</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (make-reader [this] </span><span class="calibre8"><span class="italic"><span class="calibre42">"Creates a BufferedReader."</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (make-writer [this] </span><span class="calibre8"><span class="italic"><span class="calibre42">"Creates a BufferedWriter."</span></span></span><span class="calibre8">))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> gulp [src]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [sb (StringBuilder.)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">with-open</span></span></span><span class="calibre8"> [reader (make-reader src)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">loop</span></span></span><span class="calibre8"> [c (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">read</span></span></span><span class="calibre8"> reader)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">neg?</span></span></span><span class="calibre8"> c)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          (</span><span class="calibre8"><span class="bold"><span class="calibre36">str</span></span></span><span class="calibre8"> sb)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          (</span><span class="calibre8"><span class="bold"><span class="calibre36">do</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">append sb (</span><span class="calibre8"><span class="bold"><span class="calibre36">char</span></span></span><span class="calibre8"> c))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            (</span><span class="calibre8"><span class="bold"><span class="calibre36">recur</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">read</span></span></span><span class="calibre8"> reader))))))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> expectorate [dst content]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">with-open</span></span></span><span class="calibre8"> [writer (make-writer dst)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write writer (</span><span class="calibre8"><span class="bold"><span class="calibre36">str</span></span></span><span class="calibre8"> content))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">extend-protocol</span></span></span><span class="calibre8"> IOFactory​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  InputStream​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (make-reader [src]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">-&gt;</span></span></span><span class="calibre8"> src InputStreamReader. BufferedReader.))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (make-writer [dst]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">throw</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     (IllegalArgumentException.​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      </span><span class="calibre8"><span class="italic"><span class="calibre42">"Can't open as an InputStream."</span></span></span><span class="calibre8">)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  OutputStream​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (make-reader [src]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">throw</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     (IllegalArgumentException.​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      </span><span class="calibre8"><span class="italic"><span class="calibre42">"Can't open as an OutputStream."</span></span></span><span class="calibre8">)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (make-writer [dst]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">-&gt;</span></span></span><span class="calibre8"> dst OutputStreamWriter. BufferedWriter.))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  File​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (make-reader [src]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (make-reader (FileInputStream. src)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (make-writer [dst]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (make-writer (FileOutputStream. dst)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  Socket​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (make-reader [src]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (make-reader (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getInputStream src)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (make-writer [dst]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (make-writer (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getOutputStream dst)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  URL​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (make-reader [src]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (make-reader​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"file"</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getProtocol src))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​       (</span><span class="calibre8"><span class="bold"><span class="calibre36">-&gt;</span></span></span><span class="calibre8"> src </span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getPath FileInputStream.)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​       (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">openStream src))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (make-writer [dst]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (make-writer​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"file"</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getProtocol dst))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​       (</span><span class="calibre8"><span class="bold"><span class="calibre36">-&gt;</span></span></span><span class="calibre8"> dst </span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getPath FileInputStream.)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​       (</span><span class="calibre8"><span class="bold"><span class="calibre36">throw</span></span></span><span class="calibre8"> (IllegalArgumentException.​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​               </span><span class="calibre8"><span class="italic"><span class="calibre42">"Can't write to non-file URL"</span></span></span><span class="calibre8">))))))​</span><span class="calibre8">
</span>
</td></tr></table><div class="mbppagebreak"></div><p id="filepos937760" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">6.4 Datatypes</span></span></span></p><p class="calibre34"> We have shown how to extend existing types to implement new abstractions with protocols, but what if we want to create a new type in Clojure? That is where datatypes come in. </p><p class="calibre12">A datatype provides the following:</p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> A unique class, either named or anonymous </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Structure, either explicitly as fields or implicitly as a closure </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> Fields that can have type hints and can be primitive </p></li><a></a><li value="4" class="calibre30"><p class="calibre29"> Optional implementations of abstract methods specified in protocols or interfaces </p></li><a></a><li value="5" class="calibre30"><p class="calibre29"> Immutability on by default </p></li><a></a><li value="6" class="calibre30"><p class="calibre29"> Unification with maps (via records) </p></li><a></a></ul><p class="calibre12"> We will use the <span class="calibre8"><span class="calibre39">deftype</span></span> macro to define a new datatype, called <span class="calibre8"><span class="calibre39">CryptoVault</span></span>, that will implement two protocols, including <span class="calibre8"><span class="calibre39">IOFactory</span></span>. </p><p class="calibre12"> Now that <span class="calibre8"><span class="calibre39">gulp</span></span> and <span class="calibre8"><span class="calibre39">expectorate</span></span> support several existing Java classes, let’s create a new supported type, <span class="calibre8"><span class="calibre39">CryptoVault</span></span>. You’ll create an instance of a <span class="calibre8"><span class="calibre39">CryptoVault</span></span> by passing in an argument that implements the <span class="calibre8"><span class="calibre39">clojure.java.io.IOFactory</span></span> protocol (not the one we’ve defined here), a path to a cryptographic key store, and a password. The contents expectorated into the <span class="calibre8"><span class="calibre39">CryptoVault</span></span> will be encrypted and written to the <span class="calibre8"><span class="calibre39">IOFactory</span></span> object and then decrypted when gulped back in. </p><p class="calibre12">We’ll use <span class="calibre8"><span class="calibre39">deftype</span></span> to create the new type.</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">deftype</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">name</span></span></span><span class="calibre8"> [&amp; fields] &amp; opts+specs)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> It takes the name of the type and a vector of fields contained by the type. The naming convention for datatypes is the same as used by Java classes, i.e., PascalCase or CamelCase. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;</span><span class="calibre8"><span class="bold"><span class="calibre36"> (deftype CryptoVault [filename keystore password])</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user.CryptoVault​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Once the type has been defined, we can create an instance of our <span class="calibre8"><span class="calibre39">CryptoVault</span></span> like so: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;</span><span class="calibre8"><span class="bold"><span class="calibre36"> (def vault (-&gt;CryptoVault "vault-file" "keystore" "toomanysecrets"))</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​#'user/vault​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> And its fields can be accessed using the same prefix-dot syntax used to access fields in Java objects. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;</span><span class="calibre8"><span class="bold"><span class="calibre36"> (.filename vault)</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​"vault-file"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;</span><span class="calibre8"><span class="bold"><span class="calibre36"> (.keystore vault)</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​"keystore"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;</span><span class="calibre8"><span class="bold"><span class="calibre36"> (.password vault)</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​"toomanysecrets"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now that we have defined the basic <span class="calibre8"><span class="calibre39">CryptoVault</span></span> type, let’s add behavior with some methods. Datatypes can implement only those methods that have been specified in either a protocol or an interface, so let’s first create a <span class="calibre8"><span class="calibre39">Vault</span></span> protocol. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defprotocol</span></span></span><span class="calibre8"> Vault​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (init-vault [vault])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (vault-output-stream [vault])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (vault-input-stream [vault]))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The protocol includes three functions—<span class="calibre8"><span class="calibre39">init-vault</span></span>, <span class="calibre8"><span class="calibre39">vault-output-stream</span></span>, and <span class="calibre8"><span class="calibre39">vault-input-stream</span></span>—that every <span class="calibre8"><span class="calibre39">Vault</span></span> must implement. </p><p class="calibre12"> We can define our new type’s methods inline with <span class="calibre8"><span class="calibre39">deftype</span></span>; we just pass the type name and vector of fields as before, followed by a protocol name and one or more method bodies: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/cryptovault.clj"><span class="calibre41"><span class="underline">src/examples/cryptovault.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">ns</span></span></span><span class="calibre8"> examples.cryptovault​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:use [examples.io :only [IOFactory make-reader make-writer]])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:require [clojure.java.io :as io])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:import (java.security KeyStore KeyStore$SecretKeyEntry​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                          KeyStore$PasswordProtection)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​           (javax.crypto KeyGenerator Cipher CipherOutputStream​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                         CipherInputStream)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​           (java.io FileOutputStream)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">deftype</span></span></span><span class="calibre8"> CryptoVault [filename keystore password]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  Vault​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (init-vault [vault]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    </span><span class="calibre8"><span class="bold"><span class="calibre36">..</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"> define method body here </span><span class="calibre8"><span class="bold"><span class="calibre36">..</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (vault-output-stream [vault]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    </span><span class="calibre8"><span class="bold"><span class="calibre36">..</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"> define method body here </span><span class="calibre8"><span class="bold"><span class="calibre36">..</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (vault-input-stream [vault]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    </span><span class="calibre8"><span class="bold"><span class="calibre36">..</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"> define method body here </span><span class="calibre8"><span class="bold"><span class="calibre36">..</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  IOFactory​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (make-reader [vault]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (make-reader (vault-input-stream vault)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (make-writer [vault]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (make-writer (vault-output-stream vault))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Notice that the methods for more than one protocol can be defined inline; we have defined the methods for the <span class="calibre8"><span class="calibre39">Vault</span></span> and <span class="calibre8"><span class="calibre39">IOFactory</span></span> protocols together, although the bodies of the <span class="calibre8"><span class="calibre39">Vault</span></span> methods have been elided and will be described next. </p><p class="calibre12"> The <span class="calibre8"><span class="calibre39">init-vault</span></span> method will generate an Advanced Encryption Standard (AES) key, place it in a <span class="calibre8"><span class="calibre39">java.security.KeyStore</span></span>, write the keystore data to the file specified by the keystore field in the <span class="calibre8"><span class="calibre39">CryptoVault</span></span>, and then password-protect it. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(init-vault [vault]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [password (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">toCharArray (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">password vault))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        </span><span class="calibre8"><span class="bold"><span class="calibre36">key</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">generateKey (KeyGenerator/getInstance </span><span class="calibre8"><span class="italic"><span class="calibre42">"AES"</span></span></span><span class="calibre8">))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        keystore (</span><span class="calibre8"><span class="bold"><span class="calibre36">doto</span></span></span><span class="calibre8"> (KeyStore/getInstance </span><span class="calibre8"><span class="italic"><span class="calibre42">"JCEKS"</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                   (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">load</span></span></span><span class="calibre8"> nil password)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                   (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">setEntry </span><span class="calibre8"><span class="italic"><span class="calibre42">"vault-key"</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                              (KeyStore$SecretKeyEntry. </span><span class="calibre8"><span class="bold"><span class="calibre36">key</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                              (KeyStore$PasswordProtection. password)))]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">with-open</span></span></span><span class="calibre8"> [fos (FileOutputStream. (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">keystore vault))]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">store keystore fos password))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Both the <span class="calibre8"><span class="calibre39">vault-output-stream</span></span> and <span class="calibre8"><span class="calibre39">vault-input-stream</span></span> methods will use a function, <span class="calibre8"><span class="calibre39">vault-key</span></span>, to load the keystore associated with the <span class="calibre8"><span class="calibre39">CryptoVault</span></span> and extract the AES key used to encrypt and decrypt the contents of the vault. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> vault-key [vault]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [password (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">toCharArray (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">password vault))]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">with-open</span></span></span><span class="calibre8"> [fis (FileInputStream. (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">keystore vault))]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">-&gt;</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">doto</span></span></span><span class="calibre8"> (KeyStore/getInstance </span><span class="calibre8"><span class="italic"><span class="calibre42">"JCEKS"</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">load</span></span></span><span class="calibre8"> fis password))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getKey </span><span class="calibre8"><span class="italic"><span class="calibre42">"vault-key"</span></span></span><span class="calibre8"> password)))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">vault-output-stream</span></span> method uses the <span class="calibre8"><span class="calibre39">vault-key</span></span> method to initialize an AES cipher object, creates an <span class="calibre8"><span class="calibre39">OutputStream</span></span> from the <span class="calibre8"><span class="calibre39">Vault</span></span>’s filename, and then uses the cipher and <span class="calibre8"><span class="calibre39">OutputStream</span></span> to create an instance of a <span class="calibre8"><span class="calibre39">CipherOutputStream</span></span>. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(vault-output-stream [vault]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [cipher (</span><span class="calibre8"><span class="bold"><span class="calibre36">doto</span></span></span><span class="calibre8"> (Cipher/getInstance </span><span class="calibre8"><span class="italic"><span class="calibre42">"AES"</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                 (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">init Cipher/ENCRYPT_MODE (vault-key vault)))]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (CipherOutputStream. (io/output-stream (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">filename vault)) cipher)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">vault-input-stream</span></span> method works just like <span class="calibre8"><span class="calibre39">vault-output-stream</span></span>, except it returns a <span class="calibre8"><span class="calibre39">CipherInputStream</span></span>. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(vault-input-stream [vault]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [cipher (</span><span class="calibre8"><span class="bold"><span class="calibre36">doto</span></span></span><span class="calibre8"> (Cipher/getInstance </span><span class="calibre8"><span class="italic"><span class="calibre42">"AES"</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                 (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">init Cipher/DECRYPT_MODE (vault-key vault)))]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (CipherInputStream. (io/input-stream (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">filename vault)) cipher)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> To create an instance of a <span class="calibre8"><span class="calibre39">CryptoVault</span></span>, just pass the location where data should be stored, the keystore filename, and the password protecting the keystore. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;</span><span class="calibre8"><span class="bold"><span class="calibre36"> (def vault (-&gt;CryptoVault "vault-file" "keystore" "toomanysecrets"))</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​#'user/vault​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If the keystore hasn’t been initialized yet, call the <span class="calibre8"><span class="calibre39">init-vault</span></span> method: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;</span><span class="calibre8"><span class="bold"><span class="calibre36"> (init-vault vault)</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Then use the <span class="calibre8"><span class="calibre39">CryptoVault</span></span> like any other source/destination used by <span class="calibre8"><span class="calibre39">gulp</span></span> and <span class="calibre8"><span class="calibre39">expectorate</span></span>. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;</span><span class="calibre8"><span class="bold"><span class="calibre36"> (expectorate vault "This is a test of the CryptoVault")</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​nil​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;</span><span class="calibre8"><span class="bold"><span class="calibre36"> (gulp vault)</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​"This is a test of the CryptoVault"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> We can use the <span class="calibre8"><span class="calibre39">CryptoVault</span></span> with the built-in <span class="calibre8"><span class="calibre39">spit</span></span> and <span class="calibre8"><span class="calibre39">slurp</span></span> functions by extending it to support the <span class="calibre8"><span class="calibre39">clojure.java.io/IOFactory</span></span> protocol. This version of the <span class="calibre8"><span class="calibre39">IOFactory</span></span> has four methods, instead of two like ours, and there are default method implementations defined in a map called <span class="calibre8"><span class="calibre39">default-streams-impl</span></span>. We’ll override just two of its methods, <span class="calibre8"><span class="calibre39">make-input-stream</span></span> and <span class="calibre8"><span class="calibre39">make-output-stream</span></span>, by <span class="calibre8"><span class="calibre39">assoc</span></span>’ing our new implementations into this map and passing it to the <span class="calibre8"><span class="calibre39">extend</span></span> function. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">extend</span></span></span><span class="calibre8"> CryptoVault​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  clojure.java.io/IOFactory​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">assoc</span></span></span><span class="calibre8"> clojure.java.io/default-streams-impl​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    :make-input-stream (</span><span class="calibre8"><span class="bold"><span class="calibre36">fn</span></span></span><span class="calibre8"> [x opts] (vault-input-stream x))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    :make-output-stream (</span><span class="calibre8"><span class="bold"><span class="calibre36">fn</span></span></span><span class="calibre8"> [x opts] (vault-output-stream x))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> That’s it; now we can read and write to a <span class="calibre8"><span class="calibre39">CryptoVault</span></span> using <span class="calibre8"><span class="calibre39">slurp</span></span> and <span class="calibre8"><span class="calibre39">spit</span></span>. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;</span><span class="calibre8"><span class="bold"><span class="calibre36"> (spit vault "This is a test of the CryptoVault using</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​spit and slurp")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​nil​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​user=&gt;</span><span class="calibre8"><span class="bold"><span class="calibre36"> (slurp vault)</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​"This is a test of the CryptoVault using spit and slurp"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Let’s put all the pieces together in a <span class="calibre8"><span class="calibre39">.clj</span></span> file. Make a <span class="calibre8"><span class="calibre39">src/examples/datatypes</span></span> subdirectory within your project directory, and create a file called <span class="calibre8"><span class="calibre39">vault.clj</span></span>. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/cryptovault_complete.clj"><span class="calibre41"><span class="underline">src/examples/cryptovault_complete.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">ns</span></span></span><span class="calibre8"> examples.cryptovault-complete​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:require [clojure.java.io :as io]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            [examples.protocols.io :as proto])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:import (java.security KeyStore KeyStore$SecretKeyEntry​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                          KeyStore$PasswordProtection)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​           (javax.crypto Cipher KeyGenerator CipherOutputStream​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                         CipherInputStream)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​           (java.io FileInputStream FileOutputStream)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defprotocol</span></span></span><span class="calibre8"> Vault​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (init-vault [vault])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (vault-output-stream [vault])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (vault-input-stream [vault]))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> vault-key [vault]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [password (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">toCharArray (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">password vault))]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">with-open</span></span></span><span class="calibre8"> [fis (FileInputStream. (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">keystore vault))]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">-&gt;</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">doto</span></span></span><span class="calibre8"> (KeyStore/getInstance </span><span class="calibre8"><span class="italic"><span class="calibre42">"JCEKS"</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">load</span></span></span><span class="calibre8"> fis password))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getKey </span><span class="calibre8"><span class="italic"><span class="calibre42">"vault-key"</span></span></span><span class="calibre8"> password)))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">deftype</span></span></span><span class="calibre8"> CryptoVault [filename keystore password]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  Vault​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (init-vault [vault]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [password (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">toCharArray (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">password vault))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          </span><span class="calibre8"><span class="bold"><span class="calibre36">key</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">generateKey (KeyGenerator/getInstance </span><span class="calibre8"><span class="italic"><span class="calibre42">"AES"</span></span></span><span class="calibre8">))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          keystore (</span><span class="calibre8"><span class="bold"><span class="calibre36">doto</span></span></span><span class="calibre8"> (KeyStore/getInstance </span><span class="calibre8"><span class="italic"><span class="calibre42">"JCEKS"</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                     (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">load</span></span></span><span class="calibre8"> nil password)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                     (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">setEntry </span><span class="calibre8"><span class="italic"><span class="calibre42">"vault-key"</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                                (KeyStore$SecretKeyEntry. </span><span class="calibre8"><span class="bold"><span class="calibre36">key</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                                (KeyStore$PasswordProtection. password)))]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">with-open</span></span></span><span class="calibre8"> [fos (FileOutputStream. (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">keystore vault))]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">store keystore fos password))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (vault-output-stream [vault]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [cipher (</span><span class="calibre8"><span class="bold"><span class="calibre36">doto</span></span></span><span class="calibre8"> (Cipher/getInstance </span><span class="calibre8"><span class="italic"><span class="calibre42">"AES"</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                   (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">init Cipher/ENCRYPT_MODE (vault-key vault)))]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (CipherOutputStream. (io/output-stream (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">filename vault)) cipher)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (vault-input-stream [vault]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [cipher (</span><span class="calibre8"><span class="bold"><span class="calibre36">doto</span></span></span><span class="calibre8"> (Cipher/getInstance </span><span class="calibre8"><span class="italic"><span class="calibre42">"AES"</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                   (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">init Cipher/DECRYPT_MODE (vault-key vault)))]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (CipherInputStream. (io/input-stream (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">filename vault)) cipher)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  proto/IOFactory​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (make-reader [vault]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (proto/make-reader (vault-input-stream vault)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (make-writer [vault]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (proto/make-writer (vault-output-stream vault))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">extend</span></span></span><span class="calibre8"> CryptoVault​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  clojure.java.io/IOFactory​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">assoc</span></span></span><span class="calibre8"> io/default-streams-impl​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    :make-input-stream (</span><span class="calibre8"><span class="bold"><span class="calibre36">fn</span></span></span><span class="calibre8"> [x opts] (vault-input-stream x))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    :make-output-stream (</span><span class="calibre8"><span class="bold"><span class="calibre36">fn</span></span></span><span class="calibre8"> [x opts] (vault-output-stream x))))​</span><span class="calibre8">
</span>
</td></tr></table><div class="mbppagebreak"></div><p id="filepos984443" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">6.5 Records</span></span></span></p><p class="calibre34"> Classes in object-oriented programs tend to fall into two distinct categories: those that represent programming artifacts, such as <span class="calibre8"><span class="calibre39">String</span></span>, <span class="calibre8"><span class="calibre39">Socket</span></span>, <span class="calibre8"><span class="calibre39">InputStream</span></span>, and <span class="calibre8"><span class="calibre39">OutputStream</span></span>, and those that represent application domain information, such as <span class="calibre8"><span class="calibre39">Employee</span></span> and <span class="calibre8"><span class="calibre39">PurchaseOrder</span></span>. </p><p class="calibre12"> Unfortunately, using classes to model application domain information hides it behind a class-specific micro-language of setters and getters. You can no longer take a generic approach to information processing, and you end up with a proliferation of unnecessary specificity and reduced reusability. See Clojure’s documentation on datatypes<a id="filepos985516"></a><a href="#filepos1029115">[52]</a> for more information. </p><p class="calibre12"> For this reason, Clojure has always encouraged the use of maps for modeling such information, and that holds true even with datatypes, which is where records come in. A record is a datatype, like those created with <span class="calibre8"><span class="calibre39">deftype</span></span>, that also implements <span class="calibre8"><span class="calibre39">PersistentMap</span></span> and therefore can be used like any other map (mostly); and since records are also proper classes, they support type-based polymorphism through protocols. With records, we have the best of both worlds: maps that can implement protocols. </p><p class="calibre12"> What could be more natural than using records to play music? So, let’s create a record that represents a musical note, with fields for pitch, octave, and duration; then we’ll use the JDK’s built-in MIDI synthesizer to play sequences of these notes. </p><p class="calibre12"> Since records are maps, we will be able to change the properties of individual notes using the assoc and update-in functions, and we can create or transform entire sequences of notes using <span class="calibre8"><span class="calibre39">map</span></span> and <span class="calibre8"><span class="calibre39">reduce</span></span>. This gives us access to the entirety of Clojure’s collection API. </p><p class="calibre12"> We will create a <span class="calibre8"><span class="calibre39">Note</span></span> record with the <span class="calibre8"><span class="calibre39">defrecord</span></span> macro, which behaves just like <span class="calibre8"><span class="calibre39">deftype</span></span>. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defrecord</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">name</span></span></span><span class="calibre8"> [&amp; fields] &amp; opts+specs)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38">A <span class="calibre8"><span class="calibre39">Note</span></span> record has three fields: pitch, octave, and duration.</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defrecord Note [pitch octave duration])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; user.Note​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The pitch will be represented by a keyword like <span class="calibre8"><span class="calibre39">:C</span></span>, <span class="calibre8"><span class="calibre39">:C#</span></span>, and <span class="calibre8"><span class="calibre39">:Db</span></span>, which represent the notes C, C♯ (C sharp), and D♭ (D flat), respectively. Each pitch can be played at different octaves; for instance, middle C is in the fourth octave. Duration indicates the note length; a whole note is represented by 1, a half note by 1/2, a quarter note by 1/4, and a 16th note by 1/16. For example, we can represent a D♯ half note in the fourth octave with this <span class="calibre8"><span class="calibre39">Note</span></span> record: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(-&gt;Note :D# 4 1/2)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #user.Note{:pitch :D#, :octave 4, :duration 1/2}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> We can treat records like any other datatype, accessing their fields with the dot syntax. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(.pitch (-&gt;Note :D# 4 1/2))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; :D#​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">But records are also map-like:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(map? (-&gt;Note :D# 4 1/2))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> so we can also access their fields using keywords:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(:pitch (-&gt;Note :D# 4 1/2))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; :D#​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> We can create modified records with <span class="calibre8"><span class="calibre39">assoc</span></span> and <span class="calibre8"><span class="calibre39">update-in</span></span>. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(assoc (-&gt;Note :D# 4 1/2) :pitch :Db :duration 1/4)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #user.Note{:pitch :Db, :octave 4, :duration 1/4}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(update-in (-&gt;Note :D# 4 1/2) [:octave] inc)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #user.Note{:pitch :D#, :octave 5, :duration 1/2}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Records are open, so we can associate extra fields into a record:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(assoc (-&gt;Note :D# 4 1/2) :velocity 100)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #user.Note{:pitch :D#, :octave 4, :duration 1/2, :velocity 100}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> We will use the optional <span class="calibre8"><span class="calibre39">:velocity</span></span> field to represent the force with which a note is played. </p><p class="calibre12"> When used on a record, both <span class="calibre8"><span class="calibre39">assoc</span></span> and <span class="calibre8"><span class="calibre39">update-in</span></span> return a new record, but the <span class="calibre8"><span class="calibre39">dissoc</span></span> function works a bit differently; it will return a new record if the field being dissociated is optional, like <span class="calibre8"><span class="calibre39">velocity</span></span> in the previous example, but it will return a plain map if the field is mandated by the <span class="calibre8"><span class="calibre39">defrecord</span></span> specification, like pitch, octave, or duration. </p><p class="calibre12"> In other words, if you remove a required field from a record of a given type, it is no longer a record of that type, and it simply becomes a map. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(dissoc (-&gt;Note :D# 4 1/2) :octave)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:pitch :D#, :duration 1/2}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Notice that <span class="calibre8"><span class="calibre39">dissoc</span></span> returns a map in this case, not a record. One difference between records and maps is that, unlike maps, records are not functions of keywords. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​((-&gt;Note. :D# 4 1/2) :pitch)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; user.Note cannot be cast to clojure.lang.IFn​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">ClassCastException</span></span> is thrown because records do not implement the <span class="calibre8"><span class="calibre39">IFn</span></span> interface like maps do. This is by design and drives a stylistic difference that makes code more readable. </p><p class="calibre12"> When accessing a collection, you should place the collection first. When accessing a map that is acting (conceptually) as a data record, you should place the keyword first, even if the record is implemented as a plain map. Now that we have our basic <span class="calibre8"><span class="calibre39">Note</span></span> record, let’s add some methods so we can play them with the JDK’s built-in MIDI synthesizer. We’ll start by creating a <span class="calibre8"><span class="calibre39">MidiNote</span></span> protocol with three methods: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/protocols.clj"><span class="calibre41"><span class="underline">src/examples/protocols.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defprotocol</span></span></span><span class="calibre8"> MidiNote​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (to-msec [this tempo])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (key-number [this])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (play [this tempo midi-channel]))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> To play our note with the MIDI synthesizer, we need to translate its pitch and octave into a MIDI key number and its duration into milliseconds. Here we have defined <span class="calibre8"><span class="calibre39">to-msec</span></span>, <span class="calibre8"><span class="calibre39">key-number</span></span>, and <span class="calibre8"><span class="calibre39">play</span></span>, which we will use to create our <span class="calibre8"><span class="calibre39">MidiNote</span></span>. </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"><span class="calibre8"><span class="calibre39">to-msec</span></span> returns the duration of the note in milliseconds. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">key-number</span></span> returns the MIDI key number corresponding to this note. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">play</span></span> plays this note at the given tempo on the given channel. </p></li><a></a></ul><p class="calibre12"> Now let’s extend our <span class="calibre8"><span class="calibre39">Note</span></span> record to implement the <span class="calibre8"><span class="calibre39">MidiNote</span></span> protocol. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">import</span></span></span><span class="calibre8"> 'javax.sound.midi.MidiSystem)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">extend-type</span></span></span><span class="calibre8"> Note​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  MidiNote​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (to-msec [this tempo]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [duration-to-bpm {1 240, 1/2 120, 1/4 60, 1/8 30, 1/16 15}]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">*</span></span></span><span class="calibre8"> 1000 (</span><span class="calibre8"><span class="bold"><span class="calibre36">/</span></span></span><span class="calibre8"> (duration-to-bpm (:duration this))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                 tempo))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">to-msec</span></span> function translates the note’s duration from whole note, half note, quarter note, and so on, into milliseconds based on the given tempo, which is represented in beats per minute (bpm). </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(key-number [this]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [scale {:C 0,  :C# 1, :Db 1,  :D 2,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​               :D# 3, :Eb 3, :E 4,   :F 5,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​               :F# 6, :Gb 6, :G 7,   :G# 8,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​               :Ab 8, :A 9,  :A# 10, :Bb 10,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​               :B 11}]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">+</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">*</span></span></span><span class="calibre8"> 12 (</span><span class="calibre8"><span class="bold"><span class="calibre36">inc</span></span></span><span class="calibre8"> (:octave this)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​       (scale (:pitch this)))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">key-number</span></span> function maps the keywords used to represent pitch into a number ranging from 0 to 11 [1] and then uses this number along with the given octave to find the corresponding MIDI <span class="calibre8"><span class="calibre39">key-number</span></span>.<a id="filepos1002188"></a><a href="#filepos1029372">[53]</a>
</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(play [this tempo midi-channel]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [velocity (</span><span class="calibre8"><span class="bold"><span class="calibre36">or</span></span></span><span class="calibre8"> (:velocity this) 64)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">noteOn midi-channel (key-number this) velocity)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (Thread/sleep (to-msec this tempo)))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Finally, the <span class="calibre8"><span class="calibre39">play</span></span> method takes a note, a tempo, and a MIDI channel; sends a <span class="calibre8"><span class="calibre39">noteOn</span></span> message to the channel; and then sleeps for the note’s duration. The note continues to play even while the current thread is asleep, stopping only when the next note is sent to the channel. </p><p class="calibre12"> Now we need a function that sets up the MIDI synthesizer and plays a sequence of notes: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> perform [notes &amp; {:keys [tempo] :or {tempo 120}}]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">with-open</span></span></span><span class="calibre8"> [synth (</span><span class="calibre8"><span class="bold"><span class="calibre36">doto</span></span></span><span class="calibre8"> (MidiSystem/getSynthesizer) </span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">open)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [channel (</span><span class="calibre8"><span class="bold"><span class="calibre36">aget</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getChannels synth) 0)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">doseq</span></span></span><span class="calibre8"> [note notes]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        (play note tempo channel)))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">perform</span></span> function takes a sequence of notes and an optional tempo value, opens a MIDI synthesizer, gets a channel from it, and then calls each note’s <span class="calibre8"><span class="calibre39">play</span></span> method. </p><p class="calibre12"> Now that all the pieces are in place, let’s make music using a sequence of <span class="calibre8"><span class="calibre39">Note</span></span> records: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def close-encounters [(-&gt;Note :D 3 1/2)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                       (-&gt;Note :E 3 1/2)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                       (-&gt;Note :C 3 1/2)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                       (-&gt;Note :C 2 1/2)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                       (-&gt;Note :G 2 1/2)])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/close-encounters​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> In this case, our “music” consists of the five notes used to greet the alien ships in the movie <span class="italic">Close Encounters of the Third Kind</span>. To play it, just pass the sequence to the <span class="calibre8"><span class="calibre39">perform</span></span> function: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(perform close-encounters)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> We can also generate sequences of notes dynamically with the <span class="calibre8"><span class="calibre39">for</span></span> macro. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def jaws (for [duration [1/2 1/2 1/4 1/4 1/8 1/8 1/8 1/8]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                pitch [:E :F]]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​             (Note. pitch 2 duration)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/jaws​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(perform jaws)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The result is the shark theme from <span class="italic">Jaws</span>—a sequence of alternating E and F notes progressively speeding up as they move from half notes to quarter notes to eighth notes. </p><p class="calibre12"> Since notes are records and records are map-like, we can manipulate them with any Clojure function that works on maps. For instance, we can map the <span class="calibre8"><span class="calibre39">update-in</span></span> function across the <span class="italic">Close Encounters</span> sequence to raise, or lower, its octave. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(perform (map #(update-in % [:octave] inc) close-encounters))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(perform (map #(update-in % [:octave] dec) close-encounters))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Or we can create a sequence of notes that have progressively larger values of the optional <span class="calibre8"><span class="calibre39">:velocity</span></span> field: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(perform (for [velocity [64 80 90 100 110 120]]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​           (assoc (Note. :D 3 1/2) :velocity velocity)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> This results in a sequence of increasingly more forceful D notes. Manipulating sequences is a particular strength of Clojure, so there are endless possibilities for programmatically creating and manipulating sequences of <span class="calibre8"><span class="calibre39">Note</span></span> records. </p><p class="calibre12"> Let’s put the <span class="calibre8"><span class="calibre39">MidiNote</span></span> protocol, the <span class="calibre8"><span class="calibre39">Note</span></span> record, and the <span class="calibre8"><span class="calibre39">perform</span></span> function together in a Clojure source file called <span class="calibre8"><span class="calibre39">src/examples/midi.clj</span></span> so we can use them in the future. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/midi.clj"><span class="calibre41"><span class="underline">src/examples/midi.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">ns</span></span></span><span class="calibre8"> examples.datatypes.midi​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:import [javax.sound.midi MidiSystem]))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defprotocol</span></span></span><span class="calibre8"> MidiNote​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (to-msec [this tempo])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (key-number [this])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (play [this tempo midi-channel]))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> perform [notes &amp; {:keys [tempo] :or {tempo 88}}]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">with-open</span></span></span><span class="calibre8"> [synth (</span><span class="calibre8"><span class="bold"><span class="calibre36">doto</span></span></span><span class="calibre8"> (MidiSystem/getSynthesizer)</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">open)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [channel (</span><span class="calibre8"><span class="bold"><span class="calibre36">aget</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getChannels synth) 0)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">doseq</span></span></span><span class="calibre8"> [note notes]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        (play note tempo channel)))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defrecord</span></span></span><span class="calibre8"> Note [pitch octave duration]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  MidiNote​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (to-msec [this tempo]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [duration-to-bpm {1 240, 1/2 120, 1/4 60, 1/8 30, 1/16 15}]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">*</span></span></span><span class="calibre8"> 1000 (</span><span class="calibre8"><span class="bold"><span class="calibre36">/</span></span></span><span class="calibre8"> (duration-to-bpm (:duration this))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                 tempo))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (key-number [this]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [scale {:C 0,  :C# 1, :Db 1,  :D 2,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                 :D# 3, :Eb 3, :E 4,   :F 5,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                 :F# 6, :Gb 6, :G 7,   :G# 8,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                 :Ab 8, :A 9,  :A# 10, :Bb 10,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                 :B 11}]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">+</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">*</span></span></span><span class="calibre8"> 12 (</span><span class="calibre8"><span class="bold"><span class="calibre36">inc</span></span></span><span class="calibre8"> (:octave this)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​         (scale (:pitch this)))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (play [this tempo midi-channel]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [velocity (</span><span class="calibre8"><span class="bold"><span class="calibre36">or</span></span></span><span class="calibre8"> (:velocity this) 64)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">noteOn midi-channel (key-number this) velocity)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (Thread/sleep (to-msec this tempo)))))​</span><span class="calibre8">
</span>
</td></tr></table><div class="mbppagebreak"></div><p id="filepos1020728" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">6.6 reify</span></span></span></p><p class="calibre34"> The <span class="calibre8"><span class="calibre39">reify</span></span> macro lets you create an anonymous instance of a datatype that implements either a protocol or an interface. Note that you get access by closure, not by declaration. This is because there are no declared members. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">reify</span></span></span><span class="calibre8"> &amp; opts+specs)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">reify</span></span>, like <span class="calibre8"><span class="calibre39">deftype</span></span> and <span class="calibre8"><span class="calibre39">defrecord</span></span>, takes the name of one or more protocols, or interfaces, and a series of method bodies. Unlike <span class="calibre8"><span class="calibre39">deftype</span></span> and <span class="calibre8"><span class="calibre39">defrecord</span></span>, it doesn’t take a name or a vector of fields; datatype instances produced with <span class="calibre8"><span class="calibre39">reify</span></span> don’t have explicit fields, relying instead on closures. </p><p class="calibre12"> Let’s compose some John Cage--style<a id="filepos1022173"></a><a href="#filepos1029689">[54]</a> aleatoric music<a id="filepos1022226"></a><a href="#filepos1030018">[55]</a> or, better yet, create an aleatoric music generator. We’ll use <span class="calibre8"><span class="calibre39">reify</span></span> to create an instance of a <span class="calibre8"><span class="calibre39">MidiNote</span></span> that will play a different random note each time its <span class="calibre8"><span class="calibre39">play</span></span> method is called. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/generator.clj"><span class="calibre41"><span class="underline">src/examples/generator.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">import</span></span></span><span class="calibre8"> '[examples.datatypes.midi MidiNote])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [min-duration 250​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      min-velocity 64​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      rand-note (</span><span class="calibre8"><span class="bold"><span class="calibre36">reify</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  MidiNote​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (to-msec [this tempo] (</span><span class="calibre8"><span class="bold"><span class="calibre36">+</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">rand-int</span></span></span><span class="calibre8"> 1000) min-duration))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (key-number [this] (</span><span class="calibre8"><span class="bold"><span class="calibre36">rand-int</span></span></span><span class="calibre8"> 100))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (play [this tempo midi-channel]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [velocity (</span><span class="calibre8"><span class="bold"><span class="calibre36">+</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">rand-int</span></span></span><span class="calibre8"> 100) min-velocity)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">noteOn midi-channel (key-number this) velocity)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (Thread/sleep (to-msec this tempo)))))]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (perform (</span><span class="calibre8"><span class="bold"><span class="calibre36">repeat</span></span></span><span class="calibre8"> 15 rand-note)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The first thing we need to do is import (not use or require) our <span class="calibre8"><span class="calibre39">MidiNote</span></span> protocol from the <span class="calibre8"><span class="calibre39">examples.midi</span></span> namespace. Next we bind two values, <span class="calibre8"><span class="calibre39">min-duration</span></span> and <span class="calibre8"><span class="calibre39">min-velocity</span></span>, that we will use in the <span class="calibre8"><span class="calibre39">MidiNote</span></span> method implementations. Then we use reify to create an instance of an anonymous type, which implements the <span class="calibre8"><span class="calibre39">MidiNote</span></span> protocol, that will select a random note, duration, and velocity each time its <span class="calibre8"><span class="calibre39">play</span></span> method is called. Finally, we use the <span class="calibre8"><span class="calibre39">repeat</span></span> function to create a sequence of fifteen notes, consisting of a single instance of <span class="calibre8"><span class="calibre39">rand-note</span></span>, and perform it. <span class="italic">Voila</span>, you now have a virtual John Cage! </p><div class="mbppagebreak"></div><p id="filepos1027275" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">6.7 Wrapping Up</span></span></span></p><p class="calibre34"> We covered a lot of ground in this chapter, from the general use of abstraction in programming to some (but not all) of the specific abstraction mechanisms Clojure provides. We explored creating concrete abstractions using protocols in Clojure and had some fun in the process! </p><p class="calibre12"> But there’s still more. Clojure’s macro implementation is easy to learn and use correctly for common tasks and yet powerful enough for the harder macro-related tasks. In the next chapter, you will see how Clojure is bringing macros to mainstream programming. </p><p class="calibre27"><span class="calibre8"><span class="bold"><span class="calibre28">Footnotes</span></span></span></p><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos901114"><span class="calibre8">[50]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://lambda-the-ultimate.org/node/2232"><span class="calibre8">http://lambda-the-ultimate.org/node/2232</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos1028427"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos901194"><span class="calibre8">[51]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://www.ibm.com/developerworks/java/library/j-clojure-protocols/?ca=drs-"><span class="calibre8">http://www.ibm.com/developerworks/java/library/j-clojure-protocols/?ca=drs-</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos1028818"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos985516"><span class="calibre8">[52]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://clojure.org/datatypes"><span class="calibre8">http://clojure.org/datatypes</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos1029115"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos1002188"><span class="calibre8">[53]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><span class="calibre8">Notice more than one pitch maps to 1, 3, 6, 8, and 10.</span></p></td></tr><a id="filepos1029372"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos1022173"><span class="calibre8">[54]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://en.wikipedia.org/wiki/John_Cage"><span class="calibre8">http://en.wikipedia.org/wiki/John_Cage</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos1029689"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos1022226"><span class="calibre8">[55]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://en.wikipedia.org/wiki/Aleatoric_music"><span class="calibre8">http://en.wikipedia.org/wiki/Aleatoric_music</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos1030018"></a></table><p class="calibre18"><span class="calibre8"><span class="calibre19"><span class="calibre20">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="mbppagebreak"></div><p id="filepos1030215" class="calibre25"><span class="calibre2"><span class="bold"><span class="calibre43"> Chapter 7</span></span></span></p><br class="calibre11"/><p class="calibre26"><span class="calibre2"><span class="bold"><span class="calibre3">Macros</span></span></span></p><p class="calibre12"> Macros give Clojure great power. With most programming techniques, you build features <span class="italic">within</span> the language. When you write macros, it is more accurate to say that you are “adding features to” the language. This is a powerful and dangerous ability, so you should follow the rules in Section 7.1, <a href="#filepos1031838">​<span class="italic">When to Use Macros</span>​</a>, at least until you have enough experience to decide for yourself when to bend the rules. Section 7.2, <a href="#filepos1033097">​<span class="italic">Writing a Control Flow Macro</span>​</a> jump-starts that experience, walking you through adding a new feature to Clojure. </p><p class="calibre12"> While powerful, macros are not always simple. Clojure works to make macros as simple as is feasible by including conveniences to solve many common problems that occur when writing macros. Section 7.3, <a href="#filepos1065738">​<span class="italic">Making Macros Simpler</span>​</a> explains these problems and shows how Clojure mitigates them. </p><p class="calibre12"> Macros are so different from other programming idioms that you may struggle to know when to use them. There is no better guide than the shared experience of the community, so Section 7.4, <a href="#filepos1098591">​<span class="italic">Taxonomy of Macros</span>​</a> introduces a taxonomy of Clojure macros, based on the macros in Clojure and contrib libraries. </p><div class="mbppagebreak"></div><p id="filepos1031838" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">7.1 When to Use Macros</span></span></span></p><p class="calibre34"> Macro Club has two rules, plus one exception.</p><p class="calibre12"> The first rule of Macro Club is Don’t Write Macros. Macros are complex, and they require you to think carefully about the interplay of macro expansion time and compile time. If you can write it as a function, think twice before using a macro. </p><p class="calibre12"> The second rule of Macro Club is Write Macros If That Is the Only Way to Encapsulate a Pattern. All programming languages provide some way to encapsulate patterns, but without macros these mechanisms are incomplete. In most languages, you sense that incompleteness whenever you say, “My life would be easier if only my language had feature X.” In Clojure, you just implement feature X using a macro. </p><p class="calibre12"> The exception to the rule is that <span class="italic">you can write any macro that makes life easier for your callers when compared with an equivalent function</span>. But to understand this exception, you need some practice writing macros and comparing them to functions. So, let’s get started with an example. </p><div class="mbppagebreak"></div><p id="filepos1033097" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">7.2 Writing a Control Flow Macro</span></span></span></p><p class="calibre34"> Clojure provides the <span class="calibre8"><span class="calibre39">if</span></span> special form as part of the language: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(if (= 1 1) (println "yep, math still works today"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| yep, math still works today​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Some languages have an <span class="calibre8"><span class="calibre39">unless</span></span>, which is (almost) the opposite of <span class="calibre8"><span class="calibre39">if</span></span>. <span class="calibre8"><span class="calibre39">unless</span></span> performs a test and then executes its body only if the test is logically <span class="calibre8"><span class="calibre39">false</span></span>. </p><p class="calibre12"> Clojure doesn’t have <span class="calibre8"><span class="calibre39">unless</span></span>, but it does have an equivalent macro called <span class="calibre8"><span class="calibre39">when-not</span></span>. For the sake of having a simple example to start with, let’s pretend that <span class="calibre8"><span class="calibre39">when-not</span></span> doesn’t exist and create an implementation of <span class="calibre8"><span class="calibre39">unless</span></span>. To follow the rules of Macro Club, begin by trying to write <span class="calibre8"><span class="calibre39">unless</span></span> as a function: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/macros.clj"><span class="calibre41"><span class="underline">src/examples/macros.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​; This is doomed to fail...​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defn unless [expr form]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (if expr nil form))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Check that <span class="calibre8"><span class="calibre39">unless</span></span> correctly evaluates its form when its test <span class="calibre8"><span class="calibre39">expr</span></span> is <span class="calibre8"><span class="calibre39">false</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(unless false (println "this should print"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| this should print​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Things appear fine so far. But let’s be diligent and test the <span class="calibre8"><span class="calibre39">true</span></span> case too: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(unless true (println "this should not print"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| this should not print​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Clearly something has gone wrong. The problem is that Clojure evaluates all the arguments before passing them to a function, so the <span class="calibre8"><span class="calibre39">println</span></span> is called before <span class="calibre8"><span class="calibre39">unless</span></span> <span class="italic">ever sees it</span>. In fact, both calls to <span class="calibre8"><span class="calibre39">unless</span></span> earlier call <span class="calibre8"><span class="calibre39">println</span></span> too soon, before entering the <span class="calibre8"><span class="calibre39">unless</span></span> function. To see this, add a <span class="calibre8"><span class="calibre39">println</span></span> inside <span class="calibre8"><span class="calibre39">unless</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defn unless [expr form]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (println "About to test...")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (if expr nil form))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now you can clearly see that function arguments are always evaluated before passing them to <span class="calibre8"><span class="calibre39">unless</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(unless false (println "this should print"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| this should print​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| About to test...​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(unless true (println "this should not print"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| this should not print​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| About to test...​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Macros solve this problem, because they do not evaluate their arguments immediately. Instead, you get to choose when (and if!) the arguments to a macro are evaluated. </p><p class="calibre12"> When Clojure encounters a macro, it processes it in two steps. First, it expands (executes) the macro and substitutes the result back into the program. This is called <span class="italic">macro expansion time</span>. Then, it continues with the normal <span class="italic">compile time</span>. </p><p class="calibre12"> To write <span class="calibre8"><span class="calibre39">unless</span></span>, you need to write Clojure code to perform the following translation at macro expansion time: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(unless expr form) </span><span class="calibre8"><span class="bold"><span class="calibre36">-&gt;</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> expr nil form)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Then, you need to tell Clojure that your code is a macro by using <span class="calibre8"><span class="calibre39">defmacro</span></span>, which looks almost like <span class="calibre8"><span class="calibre39">defn</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmacro</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">name</span></span></span><span class="calibre8"> doc-string? attr-map? [params*] body)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Because Clojure code is just Clojure data, you already have all the tools you need to write <span class="calibre8"><span class="calibre39">unless</span></span>. Write the <span class="calibre8"><span class="calibre39">unless</span></span> macro using <span class="calibre8"><span class="calibre39">list</span></span> to build the <span class="calibre8"><span class="calibre39">if</span></span> expression: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defmacro unless [expr form]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (list 'if expr nil form))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The body of <span class="calibre8"><span class="calibre39">unless</span></span> executes at macro expansion time, producing an <span class="calibre8"><span class="calibre39">if</span></span> form for compilation. If you enter this expression at the REPL: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(unless false (println "this should print"))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> then Clojure will (invisibly to you) expand the <span class="calibre8"><span class="calibre39">unless</span></span> form into the following: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(if false nil (println "this should print"))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Then, Clojure compiles and executes the expanded <span class="calibre8"><span class="calibre39">if</span></span> form. Verify that <span class="calibre8"><span class="calibre39">unless</span></span> works correctly for both <span class="calibre8"><span class="calibre39">true</span></span> and <span class="calibre8"><span class="calibre39">false</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(unless false (println "this should print"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| this should print​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(unless true (println "this should not print"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Congratulations, you have written your first macro. <span class="calibre8"><span class="calibre39">unless</span></span> may seem pretty simple, but consider this: what you have just done is <span class="italic">impossible</span> in most languages. In languages without macros, special forms get in the way. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Special Forms, Design Patterns, and Macros</span></span></span></p><p class="calibre44"> Clojure has no special syntax for code. Code is composed of data structures. This is true for normal functions but also for special forms and macros. </p><p class="calibre12"> Consider a language with more syntactic variety, such as Java.<a id="filepos1045231"></a><a href="#filepos1148362">[56]</a> In Java, the most flexible mechanism for writing code is the instance method. Imagine that you are writing a Java program. If you discover a recurring pattern in some instance methods, you have the entire Java language at your disposal to encapsulate that recurring pattern. </p><p class="calibre12"> Good so far. But Java also has lots of “special forms” (although they are not normally called by that name). Unlike Clojure special forms, which are just Clojure data, each Java special form has its own syntax. For example, <span class="calibre8"><span class="calibre39">if</span></span> is a special form in Java. If you discover a recurring pattern of usage involving <span class="calibre8"><span class="calibre39">if</span></span>, there is <span class="italic">no way to encapsulate</span> that pattern. You cannot create an <span class="calibre8"><span class="calibre39">unless</span></span>, so you are stuck simulating <span class="calibre8"><span class="calibre39">unless</span></span> with an idiomatic usage of <span class="calibre8"><span class="calibre39">if</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (!something) ...​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> This may seem like a relatively minor problem. Java programmers can certainly learn to mentally make the translation from <span class="calibre8"><span class="calibre39">if (!foo)</span></span> to <span class="calibre8"><span class="calibre39">unless (foo)</span></span>. But the problem is not just with <span class="calibre8"><span class="calibre39">if</span></span>: <span class="italic">every distinct syntactic form</span> in the language inhibits your ability to encapsulate recurring patterns involving that form. </p><p class="calibre12"> As another example, Java <span class="calibre8"><span class="calibre39">new</span></span> is a special form. Polymorphism is not available for <span class="calibre8"><span class="calibre39">new</span></span>, so you must simulate polymorphism, for example with an idiomatic usage of a class method: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​Widget w = WidgetFactory.makeWidget(...)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> This idiom is a little bulkier. It introduces a whole new class, <span class="calibre8"><span class="calibre39">WidgetFactory</span></span>. This class is meaningless in the problem domain and exists only to work around the constructor special form. Unlike the <span class="calibre8"><span class="calibre39">unless</span></span> idiom, the “polymorphic instantiation” idiom is complicated enough that there is more than one way to implement a solution. Thus, the idiom should more properly be called a <span class="italic">design pattern</span>. </p><p class="calibre12"> Wikipedia defines a design pattern<a id="filepos1048213"></a><a href="#filepos1148727">[57]</a> to be a “general reusable solution to a commonly occurring problem in software design.” It goes on to state that a “design pattern is not a finished design that can be transformed <span class="italic">directly</span> (emphasis added) into code.” </p><p class="calibre12"> That is where macros fit in. Macros provide a layer of <span class="italic">in</span>direction so that you can <span class="italic">automate the common parts of any recurring pattern</span>. Macros and code-as-data work together, enabling you to reprogram your language on the fly to encapsulate patterns. </p><p class="calibre12"> Of course, this argument does not go entirely in one direction. Many people would argue that having a bunch of special syntactic forms makes a programming language easier to learn or read. We do not agree, but even if we did, we would be willing to trade syntactic variety for a powerful macro system. Once you get used to code as data, the ability to automate design patterns is a huge payoff. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Expanding Macros</span></span></span></p><p class="calibre44"> When you created the <span class="calibre8"><span class="calibre39">unless</span></span> macro, you quoted the symbol <span class="calibre8"><span class="calibre39">if</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defmacro unless [expr form]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (list 'if expr nil form))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> But you did not quote any other symbols. To understand why, you need to think carefully about what happens at macro expansion time: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> By quoting <span class="calibre8"><span class="calibre39">’if</span></span>, you prevent Clojure from directly evaluating <span class="calibre8"><span class="calibre39">if</span></span> at macro expansion time. Instead, evaluation strips off the quote, leaving <span class="calibre8"><span class="calibre39">if</span></span> to be compiled. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> You do not want to quote <span class="calibre8"><span class="calibre39">expr</span></span> and <span class="calibre8"><span class="calibre39">form</span></span>, because they are macro arguments. Clojure will substitute them without evaluation at macro expansion time. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> You do not need to quote <span class="calibre8"><span class="calibre39">nil</span></span>, since <span class="calibre8"><span class="calibre39">nil</span></span> evaluates to itself. </p></li><a></a></ul><p class="calibre12"> Thinking about what needs to be quoted can get complicated quickly. Fortunately, you do not have to do this work in your head. Clojure includes diagnostic functions so that you can test macro expansions at the REPL. </p><p class="calibre12"> The function <span class="calibre8"><span class="calibre39">macroexpand-1</span></span> will show you what happens at macro expansion time: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">macroexpand-1</span></span></span><span class="calibre8"> form)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Use <span class="calibre8"><span class="calibre39">macroexpand-1</span></span> to prove that <span class="calibre8"><span class="calibre39">unless</span></span> expands to a sensible <span class="calibre8"><span class="calibre39">if</span></span> expression: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(macroexpand-1 '(unless false (println "this should print")))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (if false nil (println "this should print"))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Macros are complicated beasts, and we cannot overstate the importance of testing them with <span class="calibre8"><span class="calibre39">macroexpand-1</span></span>. Let’s go back and try some incorrect versions of <span class="calibre8"><span class="calibre39">unless</span></span>. Here is one that incorrectly quotes the <span class="calibre8"><span class="calibre39">expr</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defmacro bad-unless [expr form]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (list 'if 'expr nil form))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> When you expand <span class="calibre8"><span class="calibre39">bad-unless</span></span>, you will see that it generates the symbol <span class="calibre8"><span class="calibre39">expr</span></span>, instead of the actual test expression: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(macroexpand-1 '(bad-unless false (println "this should print")))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (if expr nil (println "this should print"))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If you try to actually use the <span class="calibre8"><span class="calibre39">bad-unless</span></span> macro, Clojure will complain that it cannot resolve the symbol <span class="calibre8"><span class="calibre39">expr</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(bad-unless false (println "this should print"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.lang.Exception: Unable to resolve symbol: expr in this context​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Sometimes macros expand into other macros. When this happens, Clojure will continue to expand all macros, until only normal code remains. For example, the <span class="calibre8"><span class="calibre39">..</span></span> macro expands recursively, producing a dot operator call, wrapped in another <span class="calibre8"><span class="calibre39">..</span></span> to handle any arguments that remain. You can see this with the following macro expansion: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(macroexpand-1 '(.. arm getHand getFinger))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (clojure.core/.. (. arm getHand) getFinger)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If you want to see <span class="calibre8"><span class="calibre39">..</span></span> expanded all the way, use <span class="calibre8"><span class="calibre39">macroexpand</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">macroexpand</span></span></span><span class="calibre8"> form)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> If you <span class="calibre8"><span class="calibre39">macroexpand</span></span> a call to <span class="calibre8"><span class="calibre39">..</span></span>, it will recursively expand until only dot operators remain: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(macroexpand '(.. arm getHand getFinger))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (. (. arm getHand) getFinger)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> (It is not a problem that <span class="calibre8"><span class="calibre39">arm</span></span>, <span class="calibre8"><span class="calibre39">getHand</span></span>, and <span class="calibre8"><span class="calibre39">getFinger</span></span> do not exist. You are only expanding them, not attempting to compile and execute them.) </p><p class="calibre12"> Another recursive macro is <span class="calibre8"><span class="calibre39">and</span></span>. If you call <span class="calibre8"><span class="calibre39">and</span></span> with more than two arguments, it will expand to include another call to <span class="calibre8"><span class="calibre39">and</span></span>, with one less argument: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(macroexpand '(and 1 2 3))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (let* [and__3585__auto__ 1]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     (if and__3585__auto__ (clojure.core/and 2 3)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     and__3585__auto__))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> This time, <span class="calibre8"><span class="calibre39">macroexpand</span></span> does <span class="italic">not</span> expand all the way. <span class="calibre8"><span class="calibre39">macroexpand</span></span> works only against the top level of the form you give it. Since the expansion of <span class="calibre8"><span class="calibre39">and</span></span> creates a new <span class="calibre8"><span class="calibre39">and</span></span> nested inside the form, <span class="calibre8"><span class="calibre39">macroexpand</span></span> does not expand it. </p><p id="filepos1058767" class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">when and when-not</span></span></span></p><p class="calibre44"> Your <span class="calibre8"><span class="calibre39">unless</span></span> macro could be improved slightly to execute multiple forms, avoiding this error: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(unless false (println "this") (println "and also this"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.lang.IllegalArgumentException: \​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​Wrong number of args passed to: macros$unless​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Think about how you would write the improved <span class="calibre8"><span class="calibre39">unless</span></span>. You would need to capture a variable argument list and stick a <span class="calibre8"><span class="calibre39">do</span></span> in front of it so that every form executes. Clojure provides exactly this behavior in its <span class="calibre8"><span class="calibre39">when</span></span> and <span class="calibre8"><span class="calibre39">when-not</span></span> macros: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">when</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">test</span></span></span><span class="calibre8"> &amp; body)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">when-not</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">test</span></span></span><span class="calibre8"> &amp; body)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">when-not</span></span> is the improved <span class="calibre8"><span class="calibre39">unless</span></span> you are looking for: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(when-not false (println "this") (println "and also this"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| this​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| and also this​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Given your practice writing <span class="calibre8"><span class="calibre39">unless</span></span>, you should now have no trouble reading the source for <span class="calibre8"><span class="calibre39">when-not</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; from Clojure core</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmacro</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">when-not</span></span></span><span class="calibre8"> [</span><span class="calibre8"><span class="bold"><span class="calibre36">test</span></span></span><span class="calibre8"> &amp; body]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">list</span></span></span><span class="calibre8"> '</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">test</span></span></span><span class="calibre8"> nil (</span><span class="calibre8"><span class="bold"><span class="calibre36">cons</span></span></span><span class="calibre8"> '</span><span class="calibre8"><span class="bold"><span class="calibre36">do</span></span></span><span class="calibre8"> body)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> And, of course, you can use <span class="calibre8"><span class="calibre39">macroexpand-1</span></span> to see how <span class="calibre8"><span class="calibre39">when-not</span></span> works: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(macroexpand-1 '(when-not false (print "1") (print "2")))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (if false nil (do (print "1") (print "2")))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">when</span></span> is the opposite of <span class="calibre8"><span class="calibre39">when-not</span></span> and executes its forms only when its <span class="calibre8"><span class="calibre39">test</span></span> is <span class="calibre8"><span class="calibre39">true</span></span>. Note that <span class="calibre8"><span class="calibre39">when</span></span> differs from <span class="calibre8"><span class="calibre39">if</span></span> in two ways: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"><span class="calibre8"><span class="calibre39">if</span></span> allows an <span class="calibre8"><span class="calibre39">else</span></span> clause, and <span class="calibre8"><span class="calibre39">when</span></span> does not. This reflects English usage, because nobody says “when … else.” </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Since <span class="calibre8"><span class="calibre39">when</span></span> does not have to use its second argument as an <span class="calibre8"><span class="calibre39">else</span></span> clause, it is free to take a variable argument list and execute all the arguments inside a <span class="calibre8"><span class="calibre39">do</span></span>. </p></li><a></a></ul><p class="calibre12"> You don’t really need an <span class="calibre8"><span class="calibre39">unless</span></span> macro. Just use Clojure’s <span class="calibre8"><span class="calibre39">when-not</span></span>. Always check to see whether somebody else has written the macro you need. </p><div class="mbppagebreak"></div><p id="filepos1065738" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">7.3 Making Macros Simpler</span></span></span></p><p class="calibre34"> The <span class="calibre8"><span class="calibre39">unless</span></span> macro is a great simple example, but most macros are more complex. In this section, we will build a set of increasingly complex macros, introducing Clojure features as we go. For your reference, the features introduced in this section are summarized in the following table. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><th valign="top" class="calibre51"><span class="bold">   </span><p class="calibre59"><span class="bold">Form  </span></p></th><th valign="top" class="calibre51"><span class="bold">   </span><p class="calibre59"><span class="bold">Description  </span></p></th></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">foo#</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">Auto-gensym: Inside a syntax-quoted section, create a unique name prefixed with   <span class="calibre8"><span class="calibre39">foo</span></span>.</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">(gensym prefix?)</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">Create a unique name, with optional prefix.  </p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">(macroexpand form)</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">Expand form with   <span class="calibre8"><span class="calibre39">macroexpand-1</span></span> repeatedly until the returned form is no longer a macro.</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">(macroexpand-1 form)</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">Show how Clojure will expand form.  </p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">(list-frag? ~@form list-frag?)</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">Splicing unquote: Use inside a syntax quote to splice an unquoted list into a template.  </p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">‘form</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">Syntax quote: Quote form, but allow internal unquoting so that   <span class="calibre8"><span class="calibre39">form</span></span> acts a template. Symbols inside <span class="calibre8"><span class="calibre39">form</span></span> are resolved to help prevent inadvertent symbol capture.</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">~form</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">Unquote: Use inside a syntax quote to substitute an unquoted value.  </p></td></tr></table><p class="calibre27"> First let’s build a replica of Clojure’s <span class="calibre8"><span class="calibre39">..</span></span> macro. We’ll call it <span class="calibre8"><span class="calibre39">chain</span></span>, since it chains a series of method calls. Here are some sample expansions of <span class="calibre8"><span class="calibre39">chain</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><th valign="top" class="calibre51"><span class="bold">   </span><p class="calibre59"><span class="bold">Macro Call  </span></p></th><th valign="top" class="calibre51"><span class="bold">   </span><p class="calibre59"><span class="bold">Expansion  </span></p></th></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">(chain arm getHand)</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">(. arm getHand)</span></span>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">(chain arm getHand getFinger)</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">(. (. arm getHand) getFinger)</span></span>
</p></td></tr></table><p class="calibre27"> Begin by implementing the simple case where the chain calls only one method. The macro needs only to make a simple list: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/macros/chain_1.clj"><span class="calibre41"><span class="underline">src/examples/macros/chain_1.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; chain reimplements Clojure's .. macro</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmacro</span></span></span><span class="calibre8"> chain [x form]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">list</span></span></span><span class="calibre8"> '</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"> x form))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">chain</span></span> needs to support any number of arguments, so the rest of the implementation should define a recursion. The list manipulation becomes more complex, since you need to build two lists and <span class="calibre8"><span class="calibre39">concat</span></span> them together: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/macros/chain_2.clj"><span class="calibre41"><span class="underline">src/examples/macros/chain_2.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmacro</span></span></span><span class="calibre8"> chain​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  ([x form] (</span><span class="calibre8"><span class="bold"><span class="calibre36">list</span></span></span><span class="calibre8"> '</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"> x form))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  ([x form &amp; more] (</span><span class="calibre8"><span class="bold"><span class="calibre36">concat</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">list</span></span></span><span class="calibre8"> 'chain (</span><span class="calibre8"><span class="bold"><span class="calibre36">list</span></span></span><span class="calibre8"> '</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"> x form)) more)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Test <span class="calibre8"><span class="calibre39">chain</span></span> using <span class="calibre8"><span class="calibre39">macroexpand</span></span> to make sure it generates the correct expansions: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(macroexpand '(chain arm getHand))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (. arm getHand)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(macroexpand '(chain arm getHand getFinger))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (. (. arm getHand) getFinger)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">chain</span></span> macro works fine as written, but it is difficult to read the expression that handles more than one argument: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">concat</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">list</span></span></span><span class="calibre8"> 'chain (</span><span class="calibre8"><span class="bold"><span class="calibre36">list</span></span></span><span class="calibre8"> '</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"> x form)) more)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The definition of <span class="calibre8"><span class="calibre39">chain</span></span> oscillates between macro code and the body to be generated. The intermingling of the two makes the entire thing hard to read. And this is just a baby of a form, only one line in length. As macro forms grow more complex, assembly functions such as <span class="calibre8"><span class="calibre39">list</span></span> and <span class="calibre8"><span class="calibre39">concat</span></span> quickly obscure the meaning of the macro. </p><p class="calibre12"> One solution to this kind of problem is a templating language. If macros were created from templates, you could take a “fill-in-the-blanks” approach to creating them. The definition of <span class="calibre8"><span class="calibre39">chain</span></span> might look like this: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; hypothetical templating language</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmacro</span></span></span><span class="calibre8"> chain​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  ([x form] (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"> ${x} ${form}))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  ([x form &amp; more] (chain (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"> ${x} ${form}) ${more})))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> In this hypothetical templating language, the <span class="calibre8"><span class="calibre39">${}</span></span> lets you substitute arguments into the macro expansion. </p><p class="calibre12"> Notice how much easier the definition is to read and how it clearly shows what the expansion will look like. </p><p id="filepos1077582" class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Syntax Quote, Unquote, and Splicing Unquote</span></span></span></p><p class="calibre44"> Clojure macros support templating without introducing a separate language. The <span class="italic">syntax quote</span> character, which is a backquote (<span class="calibre8"><span class="calibre39">‘</span></span>), works almost like normal quoting. But inside a syntax-quoted list, the <span class="italic">unquote character</span> (<span class="calibre8"><span class="calibre39">~</span></span>, a tilde) turns quoting off again. The overall effect is templates that look like this: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/macros/chain_3.clj"><span class="calibre41"><span class="underline">src/examples/macros/chain_3.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmacro</span></span></span><span class="calibre8"> chain [x form]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  `(</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"> ~x ~form))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Test that this new version of <span class="calibre8"><span class="calibre39">chain</span></span> can correctly generate a single method call: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(macroexpand '(chain arm getHand))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (. arm getHand)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Unfortunately, the syntax quote/unquote approach will not quite work for the multiple-argument variant of <span class="calibre8"><span class="calibre39">chain</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/macros/chain_4.clj"><span class="calibre41"><span class="underline">src/examples/macros/chain_4.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; Does not quite work</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmacro</span></span></span><span class="calibre8"> chain​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  ([x form] `(</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"> ~x ~form))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  ([x form &amp; more] `(chain (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"> ~x ~form) ~more)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> When you expand this <span class="calibre8"><span class="calibre39">chain</span></span>, the parentheses aren’t quite right: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(macroexpand '(chain arm getHand getFinger))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (. (. arm getHand) (getFinger))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The last argument to <span class="calibre8"><span class="calibre39">chain</span></span> is a list of <span class="calibre8"><span class="calibre39">more</span></span> arguments. When you drop <span class="calibre8"><span class="calibre39">more</span></span> into the macro “template,” it has parentheses because it is a list. But you don’t want these parentheses; you want <span class="calibre8"><span class="calibre39">more</span></span> to be <span class="italic">spliced</span> into the list. This comes up often enough that there is a reader macro for it: <span class="italic">splicing unquote</span> (<span class="calibre8"><span class="calibre39">~@</span></span>). Rewrite <span class="calibre8"><span class="calibre39">chain</span></span> using splicing unquote to splice in <span class="calibre8"><span class="calibre39">more</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/macros/chain_5.clj"><span class="calibre41"><span class="underline">src/examples/macros/chain_5.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmacro</span></span></span><span class="calibre8"> chain​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  ([x form] `(</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"> ~x ~form))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  ([x form &amp; more] `(chain (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"> ~x ~form) ~@more)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Now, the expansion should be spot on:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(macroexpand '(chain arm getHand getFinger))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (. (. arm getHand) getFinger)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Many macros follow the pattern of <span class="calibre8"><span class="calibre39">chain</span></span>, aka Clojure <span class="calibre8"><span class="calibre39">..</span></span>: </p><div class="calibre14"> </div><ol class="calibre68"><li value="1" class="calibre16"><p class="calibre29"> Begin the macro body with a syntax quote (<span class="calibre8"><span class="calibre39">‘</span></span>) to treat the entire thing as a template. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Insert individual arguments with an unquote (<span class="calibre8"><span class="calibre39">~</span></span>). </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> Splice in <span class="calibre8"><span class="calibre39">more</span></span> arguments with splicing unquote (<span class="calibre8"><span class="calibre39">~@</span></span>). </p></li><a></a></ol><p class="calibre12"> The macros we have built so far have been simple enough to avoid creating any bindings with <span class="calibre8"><span class="calibre39">let</span></span> or <span class="calibre8"><span class="calibre39">binding</span></span>. Let’s create such a macro next. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Creating Names in a Macro</span></span></span></p><p class="calibre44"> Clojure has a <span class="calibre8"><span class="calibre39">time</span></span> macro that times an expression, writing the elapsed time to the console: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(time (str "a" "b"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| "Elapsed time: 0.06 msecs"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "ab"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Let’s build a variant of <span class="calibre8"><span class="calibre39">time</span></span> called <span class="calibre8"><span class="calibre39">bench</span></span>, designed to collect data across many runs. Instead of writing to the console, <span class="calibre8"><span class="calibre39">bench</span></span> will return a map that includes both the return value of the original expression and the elapsed time. </p><p class="calibre12"> The best way to begin writing a macro is to write its desired expansion by hand. <span class="calibre8"><span class="calibre39">bench</span></span> should expand like this: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​; (bench (str "a" "b"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​; should expand to​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(let [start (System/nanoTime)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      result (str "a" "b")]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  {:result result :elapsed (- (System/nanoTime) start)})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:elapsed 61000, :result "ab"}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">let</span></span> binds <span class="calibre8"><span class="calibre39">start</span></span> to the start time and then executes the expression to be benched, binding it to <span class="calibre8"><span class="calibre39">result</span></span>. Finally, the form returns a map including the <span class="calibre8"><span class="calibre39">result</span></span> and the elapsed time since <span class="calibre8"><span class="calibre39">start</span></span>. </p><p class="calibre12"> With the expansion in hand, you can now work backward and write the macro to generate the expansion. Using the technique from the previous section, try writing <span class="calibre8"><span class="calibre39">bench</span></span> using syntax quoting and unquoting: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/macros/bench_1.clj"><span class="calibre41"><span class="underline">src/examples/macros/bench_1.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; This won't work</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmacro</span></span></span><span class="calibre8"> bench [expr]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  `(</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [start (System/nanoTime)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​         result ~expr]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     {:result result :elapsed (</span><span class="calibre8"><span class="bold"><span class="calibre36">-</span></span></span><span class="calibre8"> (System/nanoTime) start)}))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If you try to call this version of <span class="calibre8"><span class="calibre39">bench</span></span>, Clojure will complain: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(bench (str "a" "b"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.lang.Exception: Can't let qualified name: examples.macros/start​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Clojure is accusing you of trying to <span class="calibre8"><span class="calibre39">let</span></span> a qualified name, which is illegal. Calling <span class="calibre8"><span class="calibre39">macroexpand-1</span></span> confirms the problem: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(macroexpand-1 '(bench (str "a" "b")))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (clojure.core/let [examples.macros/start (System/nanoTime)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     examples.macros/result (str "a" "b")]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   {:elapsed (clojure.core/- (System/nanoTime) examples.macros/start)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    :result examples.macros/result})​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> When a syntax-quoted form encounters a symbol, it resolves the symbol to a fully qualified name. At the moment, this seems like an irritant, because you <span class="italic">want</span> to create local names, specifically <span class="calibre8"><span class="calibre39">start</span></span> and <span class="calibre8"><span class="calibre39">result</span></span>. But Clojure’s approach protects you from a nasty macro bug called <span class="italic">symbol capture</span>. </p><p class="calibre12"> What would happen if macro expansion <span class="italic">did</span> allow the unqualified symbols <span class="calibre8"><span class="calibre39">start</span></span> and <span class="calibre8"><span class="calibre39">result</span></span> and then <span class="calibre8"><span class="calibre39">bench</span></span> was later used in a scope where those names were already bound to something else? The macro would <span class="italic">capture</span> the names and bind them to different values, with bizarre results. If <span class="calibre8"><span class="calibre39">bench</span></span> captured its symbols, it would appear to work fine most of the time. Adding one and two would give you three: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(let [a 1 b 2]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (bench (+ a b)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt;  {:result 3, :elapsed 39000}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> …until the unlucky day that you picked a local name like <span class="calibre8"><span class="calibre39">start</span></span>, which collided with a name inside <span class="calibre8"><span class="calibre39">bench</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(let [start 1 end 2]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (bench (+ start end)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt;  {:result 1228277342451783002, :elapsed 39000}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">bench</span></span> captures the symbol <span class="calibre8"><span class="calibre39">start</span></span> and binds it to <span class="calibre8"><span class="calibre39">(System/nanoTime)</span></span>. All of a sudden, one plus two seems to equal <span class="calibre8"><span class="calibre39">1228277342451783002</span></span>. </p><p class="calibre12"> Clojure’s insistence on resolving names in macros helps protect you from symbol capture, but you still don’t have a working <span class="calibre8"><span class="calibre39">bench</span></span>. You need some way to introduce local names, ideally <span class="italic">unique</span> ones that cannot collide with any names used by the caller. </p><p class="calibre12"> Clojure provides a reader form for creating unique local names. Inside a syntax-quoted form, you can append an octothorpe (<span class="calibre8"><span class="calibre39">#</span></span>) to an unqualified name, and Clojure will create an autogenerated symbol, or <span class="italic">auto-gensym</span>: a symbol based on the name plus an underscore and a unique ID. Try it at the REPL: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​`foo#​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​foo__1004​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> With automatically generated symbols at your disposal, it is easy to implement <span class="calibre8"><span class="calibre39">bench</span></span> correctly: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmacro</span></span></span><span class="calibre8"> bench [expr]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  `(</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [start# (System/nanoTime)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​         result# ~expr]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     {:result result# :elapsed (</span><span class="calibre8"><span class="bold"><span class="calibre36">-</span></span></span><span class="calibre8"> (System/nanoTime) start#)}))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Test it at the REPL:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(bench (str "a" "b"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:elapsed 63000, :result "ab"}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Clojure makes it easy to generate unique names, but if you are determined, you can still force symbol capture. The sample code for the book includes an <span class="calibre8"><span class="calibre39">evil-bench</span></span> that shows a combination of syntax quoting, quoting, and unquoting that leads to symbol capture. Don’t use symbol capture unless you have a thorough understanding of macros. </p><div class="mbppagebreak"></div><p id="filepos1098591" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">7.4 Taxonomy of Macros</span></span></span></p><p class="calibre34"> Now that you have written several macros, we can restate the rules of Macro Club with more supporting detail. </p><p class="calibre12"> The first rule of Macro Club is Don’t Write Macros. Macros are complex. If none of the macros in Clojure seems complex to you, my company is hiring.<a id="filepos1099036"></a><a href="#filepos1149018">[58]</a>
</p><p class="calibre12"> The second rule of Macro Club is Write Macros If That Is the Only Way to Encapsulate a Pattern. As you have seen, the patterns that resist encapsulation tend to arise around special forms, which are irregularities in a language. So, the second rule can also be called the Special Form Rule. </p><p class="calibre12"> Special forms have special powers that you, the programmer, do not have: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Special forms provide the most basic flow control structures, such as <span class="calibre8"><span class="calibre39">if</span></span> and <span class="calibre8"><span class="calibre39">recur</span></span>. All flow control macros must eventually call a special form. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Special forms provide direct access to Java. Whenever you call Java from Clojure, you are going through at least one special form, such as the dot or <span class="calibre8"><span class="calibre39">new</span></span>. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> Names are created and bound through special forms, whether defining a var with <span class="calibre8"><span class="calibre39">def</span></span>, creating a lexical binding with <span class="calibre8"><span class="calibre39">let</span></span>, or creating a dynamic binding with <span class="calibre8"><span class="calibre39">binding</span></span>. </p></li><a></a></ul><p class="calibre12"> As powerful as they are, special forms are not functions. They cannot do some things that functions can do. You cannot <span class="calibre8"><span class="calibre39">apply</span></span> a special form, store a special form in a var, or use a special form as a filter with the sequence library. In short, special forms are not first-class citizens of the language. </p><p class="calibre12"> The specialness of special forms could be a major problem and lead to repetitive, unmaintainable patterns in your code. But macros neatly solve the problem, because you can use macros to generate special forms. In a practical sense, <span class="italic">all language features are first-class features at macro expansion time.</span>
</p><p class="calibre12"> Macros that generate special forms are often the most difficult to write but also the most rewarding. As if by magic, such macros seem to <span class="italic">add new features to the language</span>. </p><p class="calibre12"> The exception to the Macro Club rules is caller convenience: <span class="italic">you can write any macro that makes life easier for your callers when compared with an equivalent function</span>. Because macros do not evaluate their arguments, callers can pass raw code to a macro, instead of wrapping the code in an anonymous function. Or, callers can pass unescaped names, instead of quoted symbols or strings. </p><p class="calibre12"> We have reviewed the macros in Clojure and contrib libraries, and almost all of them follow the rules of Macro Club. Also, they fit into one or more of the categories shown in the following table, which shows the taxonomy of Clojure macros. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><th valign="top" class="calibre51"><span class="bold">   </span><p class="calibre59"><span class="bold">Justification  </span></p></th><th valign="top" class="calibre51"><span class="bold">   </span><p class="calibre59"><span class="bold">Category  </span></p></th><th valign="top" class="calibre51"><span class="bold">   </span><p class="calibre59"><span class="bold">Examples  </span></p></th></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">Special form  </p></td><td valign="top" class="calibre23">   <p class="calibre59">Conditional evaluation  </p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">when</span></span>, <span class="calibre8"><span class="calibre39">when-not</span></span>, <span class="calibre8"><span class="calibre39">and</span></span>, <span class="calibre8"><span class="calibre39">or</span></span>, <span class="calibre8"><span class="calibre39">comment</span></span>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">Special form  </p></td><td valign="top" class="calibre23">   <p class="calibre59">Defining vars  </p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">defn</span></span>, <span class="calibre8"><span class="calibre39">defmacro</span></span>, <span class="calibre8"><span class="calibre39">defmulti</span></span>, <span class="calibre8"><span class="calibre39">defstruct</span></span>, <span class="calibre8"><span class="calibre39">declare</span></span>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">Special form  </p></td><td valign="top" class="calibre23">   <p class="calibre59">Java interop  </p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">..</span></span>, <span class="calibre8"><span class="calibre39">doto</span></span>, <span class="calibre8"><span class="calibre39">import-static</span></span>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">Caller convenience  </p></td><td valign="top" class="calibre23">   <p class="calibre59">Postponing evaluation  </p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">lazy-cat</span></span>, <span class="calibre8"><span class="calibre39">lazy-seq</span></span>, <span class="calibre8"><span class="calibre39">delay</span></span>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">Caller convenience  </p></td><td valign="top" class="calibre23">   <p class="calibre59">Wrapping evaluation  </p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">with-open</span></span>, <span class="calibre8"><span class="calibre39">dosync</span></span>, <span class="calibre8"><span class="calibre39">with-out-str</span></span>, <span class="calibre8"><span class="calibre39">time</span></span>, <span class="calibre8"><span class="calibre39">assert</span></span>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">Caller convenience  </p></td><td valign="top" class="calibre23">   <p class="calibre59">Avoiding a lambda  </p></td><td valign="top" class="calibre23">   <p class="calibre59">(  <span class="italic">Same as for “Wrapping evaluation”)</span>
</p></td></tr></table><p class="calibre27">Let’s examine each of the categories in turn. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Conditional Evaluation</span></span></span></p><p class="calibre44"> Because macros do not immediately evaluate their arguments, they can be used to create custom control structures. You have already seen this with the <span class="calibre8"><span class="calibre39">unless</span></span> example in Section 7.2, <a href="#filepos1033097">​<span class="italic">Writing a Control Flow Macro</span>​</a>. </p><p class="calibre12"> Macros that do conditional evaluation tend to be fairly simple to read and write. They follow a common form: evaluate some argument (the condition); then, based on that evaluation, pick which other arguments to evaluate, if any. A good example is Clojure’s <span class="calibre8"><span class="calibre39">and</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">Line 1</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmacro</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">and</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">2</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  ([] true)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">3</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  ([x] x)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">4</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  ([x &amp; </span><span class="calibre8"><span class="bold"><span class="calibre36">rest</span></span></span><span class="calibre8">]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">5</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     `(</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [and# ~x]   ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">6</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> and# (</span><span class="calibre8"><span class="bold"><span class="calibre36">and</span></span></span><span class="calibre8"> ~@</span><span class="calibre8"><span class="bold"><span class="calibre36">rest</span></span></span><span class="calibre8">) and#)))) ​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">and</span></span> is defined recursively. The zero- and one-argument bodies set up the base cases: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">For no arguments, return <span class="calibre8"><span class="calibre39">true</span></span>.</p></li><a></a><li value="2" class="calibre30"><p class="calibre29">For one argument, return that argument.</p></li><a></a></ul><p class="calibre12"> For two or more arguments, <span class="calibre8"><span class="calibre39">and</span></span> uses the first argument as its condition, evaluating it on line 5. Then, if the condition is true, <span class="calibre8"><span class="calibre39">and</span></span> proceeds to evaluate the remaining arguments by recursively <span class="calibre8"><span class="calibre39">and</span></span>ing the <span class="calibre8"><span class="calibre39">rest</span></span> (line 6). </p><p class="calibre12"><span class="calibre8"><span class="calibre39">and</span></span> must be a macro in order to short-circuit evaluation after the first nontrue value is encountered. Unsurprisingly, <span class="calibre8"><span class="calibre39">and</span></span> has a close cousin macro, <span class="calibre8"><span class="calibre39">or</span></span>. Their signatures are the same: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">and</span></span></span><span class="calibre8"> &amp; exprs)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">or</span></span></span><span class="calibre8"> &amp; exprs)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> The difference is that <span class="calibre8"><span class="calibre39">and</span></span> stops on the first logical <span class="calibre8"><span class="calibre39">false</span></span>, while <span class="calibre8"><span class="calibre39">or</span></span> stops on the first logical <span class="calibre8"><span class="calibre39">true</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(and 1 0 nil false)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(or 1 0 nil false)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 1​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The all-time short-circuit evaluation champion is the <span class="calibre8"><span class="calibre39">comment</span></span> macro: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">comment</span></span></span><span class="calibre8"> &amp; exprs)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">comment</span></span> never evaluates <span class="italic">any</span> of its arguments and is sometimes used at the end of a source code file to demonstrate the usage of an API. </p><p class="calibre12"> For example, the Clojure <span class="calibre8"><span class="calibre39">inspector</span></span> library ends with the following <span class="calibre8"><span class="calibre39">comment</span></span>, demonstrating the use of the <span class="calibre8"><span class="calibre39">inspector</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">comment</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">load-file</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"src/inspector.clj"</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">refer</span></span></span><span class="calibre8"> 'inspector)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(inspect-tree {:a 1 :b 2 :c [1 2 3 {:d 4 :e 5 :f [6 7 8]}]})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(inspect-table [[1 2 3][4 5 6][7 8 9][10 11 12]])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Notice the lack of indentation. This would be nonstandard in most Clojure code but is useful in <span class="calibre8"><span class="calibre39">comment</span></span>, whose purpose is to draw attention to its body. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Creating Vars</span></span></span></p><p class="calibre44"> Clojure vars are created by the <span class="calibre8"><span class="calibre39">def</span></span> special form. Anything else that creates a var must eventually call <span class="calibre8"><span class="calibre39">def</span></span>. So, for example, <span class="calibre8"><span class="calibre39">defn</span></span>, <span class="calibre8"><span class="calibre39">defmacro</span></span>, and <span class="calibre8"><span class="calibre39">defmulti</span></span> are all themselves macros. </p><p class="calibre12"> To demonstrate writing macros that create vars, we will look at two macros that are also part of Clojure: <span class="calibre8"><span class="calibre39">defstruct</span></span> and <span class="calibre8"><span class="calibre39">declare</span></span>. </p><p class="calibre12"> Clojure provides a low-level function for creating structs called <span class="calibre8"><span class="calibre39">create-struct</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">create-struct</span></span></span><span class="calibre8"> &amp; key-symbols)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Use <span class="calibre8"><span class="calibre39">create-struct</span></span> to create a <span class="calibre8"><span class="calibre39">person</span></span> struct: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def person (create-struct :first-name :last-name))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/person​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">create-struct</span></span> works, but it is visually noisy. Given that you often want to immediately <span class="calibre8"><span class="calibre39">def</span></span> a new struct, you will typically call <span class="calibre8"><span class="calibre39">defstruct</span></span>, which combines <span class="calibre8"><span class="calibre39">def</span></span> and <span class="calibre8"><span class="calibre39">create-struct</span></span> in a single operation: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defstruct</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">name</span></span></span><span class="calibre8"> &amp; key-symbols)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">defstruct</span></span> is a simple macro, and it is already part of Clojure: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmacro</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">defstruct</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  [</span><span class="calibre8"><span class="bold"><span class="calibre36">name</span></span></span><span class="calibre8"> &amp; </span><span class="calibre8"><span class="bold"><span class="calibre36">keys</span></span></span><span class="calibre8">]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  `(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> ~</span><span class="calibre8"><span class="bold"><span class="calibre36">name</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">create-struct</span></span></span><span class="calibre8"> ~@</span><span class="calibre8"><span class="bold"><span class="calibre36">keys</span></span></span><span class="calibre8">)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> This macro looks so simple that you may be tempted to try to write it as a function. You won’t be able to, because <span class="calibre8"><span class="calibre39">def</span></span> is a special form. You must generate <span class="calibre8"><span class="calibre39">def</span></span> at macro time; you cannot make “dynamic” calls to def at runtime. </p><p class="calibre12"><span class="calibre8"><span class="calibre39">defstruct</span></span> makes a single line easier to read, but some macros can also condense many lines down into a single form. Consider the problem of forward declarations. You are writing a program that needs forward references to vars <span class="calibre8"><span class="calibre39">a</span></span>, <span class="calibre8"><span class="calibre39">b</span></span>, <span class="calibre8"><span class="calibre39">c</span></span>, and <span class="calibre8"><span class="calibre39">d</span></span>. You can call <span class="calibre8"><span class="calibre39">def</span></span> with no arguments to define the var names without an initial binding: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def a)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def b)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def c)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def d)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> But this is tedious and wastes a lot of vertical space. The <span class="calibre8"><span class="calibre39">declare</span></span> macro takes a variable list of names and <span class="calibre8"><span class="calibre39">def</span></span>s each name for you: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">declare</span></span></span><span class="calibre8"> &amp; names)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Now you can declare all the names in a single compact form: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(declare a b c d)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/d​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The implementation of <span class="calibre8"><span class="calibre39">declare</span></span> is built into Clojure: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmacro</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">declare</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  [&amp; names] `(</span><span class="calibre8"><span class="bold"><span class="calibre36">do</span></span></span><span class="calibre8"> ~@(</span><span class="calibre8"><span class="bold"><span class="calibre36">map</span></span></span><span class="calibre8"> #(</span><span class="calibre8"><span class="bold"><span class="calibre36">list</span></span></span><span class="calibre8"> '</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> %) names)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Let’s analyze <span class="calibre8"><span class="calibre39">declare</span></span> from the inside out. The anonymous function <span class="calibre8"><span class="calibre39">#(list ’def %)</span></span> is responsible for generating a single <span class="calibre8"><span class="calibre39">def</span></span>. Test this form alone at the REPL: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(#(list 'def %) 'a)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (def a)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">map</span></span> invokes the inner function once for each symbol passed in. Again, you can test this form at the REPL: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(map #(list 'def %) '[a b c d])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ((def a) (def b) (def c) (def d))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Finally, the leading <span class="calibre8"><span class="calibre39">do</span></span> makes the entire expansion into a single legal Clojure form: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​`(do ~@(map #(list 'def %) '[a b c d]))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (do (def a) (def b) (def c) (def d))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Substituting <span class="calibre8"><span class="calibre39">’[a b c d]</span></span> in the previous form is the manual equivalent of testing the entire macro with <span class="calibre8"><span class="calibre39">macroexpand-1</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(macroexpand-1 '(declare a b c d))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (do (def a) (def b) (def c) (def d))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Many of the most interesting parts of Clojure are macros that expand into special forms involving <span class="calibre8"><span class="calibre39">def</span></span>. We have explored a few here, but you can read the source of any of them. Most of them live at <span class="calibre8"><span class="calibre39">src/clj/clojure/</span></span>
<span class="calibre8"><span class="calibre39">core.clj</span></span> in the Clojure source distribution. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Java Interop</span></span></span></p><p class="calibre44"> Clojure programs call into Java via the <span class="calibre8"><span class="calibre39">.</span></span> (dot), <span class="calibre8"><span class="calibre39">new</span></span>, and <span class="calibre8"><span class="calibre39">set!</span></span> special forms. However, idiomatic Clojure code often uses macros such as <span class="calibre8"><span class="calibre39">..</span></span> (threaded member access) and <span class="calibre8"><span class="calibre39">doto</span></span> to simplify forms that call Java. </p><p class="calibre12"> You (or anyone else) can extend how Clojure calls Java by writing a macro. Consider the following scenario. You are writing code that uses several of the constants in <span class="calibre8"><span class="calibre39">java.lang.Math</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​Math/PI​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 3.141592653589793​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(Math/pow 10 3)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 1000.0​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> In a longer segment of code, the <span class="calibre8"><span class="calibre39">Math/</span></span> prefix would quickly become distracting, so it would be nice if you could say simply <span class="calibre8"><span class="calibre39">PI</span></span> and <span class="calibre8"><span class="calibre39">pow</span></span>. Clojure doesn’t provide any direct way to do this, but you could define a bunch of vars by hand: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def PI Math/PI)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/PI​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defn pow [b e] (Math/pow b e))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/pow​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Stuart Sierra automated the boilerplate with the <span class="calibre8"><span class="calibre39">import-static</span></span> macro: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(examples.import-static/import-static </span><span class="calibre8"><span class="bold"><span class="calibre36">class</span></span></span><span class="calibre8"> &amp; members)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">import-static</span></span> imports static <span class="calibre8"><span class="calibre39">members</span></span> of a Java <span class="calibre8"><span class="calibre39">class</span></span> as names in the local name-space. Use <span class="calibre8"><span class="calibre39">import-static</span></span> to import the members you want from <span class="calibre8"><span class="calibre39">Math</span></span>. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(use '[examples.import-static :only (import-static)])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(import-static java.lang.Math PI pow)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​PI​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 3.141592653589793​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(pow 10 3)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 1000.0​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Postponing Evaluation</span></span></span></p><p class="calibre44"> Most sequences in Clojure are lazy. When you are building a lazy sequence, you often want to combine several forms whose evaluation is postponed until the sequence is forced. Since evaluation is not immediate, a macro is required. </p><p class="calibre12"> You have already seen such a macro in Section 3.3, <a href="#filepos428764">​<span class="italic">Lazy and Infinite Sequences</span>​</a>: <span class="calibre8"><span class="calibre39">lazy-seq</span></span>. Another example is <span class="calibre8"><span class="calibre39">delay</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">delay</span></span></span><span class="calibre8"> &amp; exprs)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> When you create a <span class="calibre8"><span class="calibre39">delay</span></span>, it holds on to its <span class="calibre8"><span class="calibre39">exprs</span></span> and does nothing with them until it is forced to. Try creating a <span class="calibre8"><span class="calibre39">delay</span></span> that simulates a long calculation by sleeping: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def slow-calc (delay (Thread/sleep 5000) "done!"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/slow-calc​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> To actually execute the <span class="calibre8"><span class="calibre39">delay</span></span>, you must <span class="calibre8"><span class="calibre39">force</span></span> it: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">force</span></span></span><span class="calibre8"> x)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38">Try forcing your <span class="calibre8"><span class="calibre39">slow-calc</span></span> a few times:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(force slow-calc)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "done!"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(force slow-calc)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "done!"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The first time you <span class="calibre8"><span class="calibre39">force</span></span> a delay, it executes its expressions and caches the result. Subsequent <span class="calibre8"><span class="calibre39">force</span></span>s simply return the cached value. </p><p class="calibre12"> The macros that implement lazy and delayed evaluation all call Java code in <span class="calibre8"><span class="calibre39">clojure.jar</span></span>. In your own code, you should not call such Java APIs directly. Treat the lazy/delayed evaluation macros as the public API, and treat the Java classes as implementation detail that is subject to change. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Wrapping Evaluation</span></span></span></p><p class="calibre44"> Many macros wrap the evaluation of a set of forms, adding some special semantics before and/or after the forms are evaluated. You have already seen several examples of this kind of macro: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"><span class="calibre8"><span class="calibre39">time</span></span> starts a timer, evaluates forms, and then reports how long they took to execute. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">let</span></span> and <span class="calibre8"><span class="calibre39">binding</span></span> establish bindings, evaluate some forms, and then tear down the bindings. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">with-open</span></span> takes an open file (or other resource), executes some forms, and then makes sure the resource is closed in a <span class="calibre8"><span class="calibre39">finally</span></span> block. </p></li><a></a><li value="4" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">dosync</span></span> executes forms within a transaction. </p></li><a></a></ul><p class="calibre12"> Another example of a wrapper macro is <span class="calibre8"><span class="calibre39">with-out-str</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">with-out-str</span></span></span><span class="calibre8"> &amp; exprs)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">with-out-str</span></span> temporarily binds <span class="calibre8"><span class="calibre39">*out*</span></span> to a new <span class="calibre8"><span class="calibre39">StringWriter</span></span>, evaluates its <span class="calibre8"><span class="calibre39">exprs</span></span>, and then returns the string written to <span class="calibre8"><span class="calibre39">*out*</span></span>. <span class="calibre8"><span class="calibre39">with-out-str</span></span> makes it easy to use <span class="calibre8"><span class="calibre39">print</span></span> and <span class="calibre8"><span class="calibre39">println</span></span> to build strings on the fly: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(with-out-str (print "hello, ") (print "world"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "hello, world"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The implementation of <span class="calibre8"><span class="calibre39">with-out-str</span></span> has a simple structure that can act as a template for writing similar macros: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">Line 1</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmacro</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">with-out-str</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">2</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  [&amp; body]  ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">3</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  `(</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [s# (</span><span class="calibre8"><span class="bold"><span class="calibre36">new</span></span></span><span class="calibre8"> java.io.StringWriter)] ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">4</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     (</span><span class="calibre8"><span class="bold"><span class="calibre36">binding</span></span></span><span class="calibre8"> [*out* s#] ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">5</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​       ~@body            ​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold">6</span></span><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​       (</span><span class="calibre8"><span class="bold"><span class="calibre36">str</span></span></span><span class="calibre8"> s#))))       ​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Wrapper macros usually take a variable number of arguments (line 2), which are the forms to be evaluated. They then proceed in three steps: </p><div class="calibre14"> </div><ol class="calibre68"><li value="1" class="calibre16"><p class="calibre29"><span class="italic">Setup</span>: Create some special context for evaluation, introducing bindings with <span class="calibre8"><span class="calibre39">let</span></span> (line 3) and <span class="calibre8"><span class="calibre39">bindings</span></span> (line 4) as necessary. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"><span class="italic">Evaluation</span>: Evaluate the forms (line 5). Since there are typically a variable number of forms, insert them via a splicing unquote: <span class="calibre8"><span class="calibre39">~@</span></span>. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"><span class="italic">Teardown</span>: Reset the execution context to normal and return a value as appropriate (line 6) </p></li><a></a></ol><p class="calibre12"> When writing a wrapper macro, always ask yourself whether you need a <span class="calibre8"><span class="calibre39">finally</span></span> block to implement the teardown step correctly. For <span class="calibre8"><span class="calibre39">with-out-str</span></span>, the answer is no, because both <span class="calibre8"><span class="calibre39">let</span></span> and <span class="calibre8"><span class="calibre39">binding</span></span> take care of their own cleanup. If, however, you are setting some global or thread-local state via a Java API, you will need a <span class="calibre8"><span class="calibre39">finally</span></span> block to reset this state. </p><p class="calibre12"> This talk of mutable state leads to another observation. Any code whose behavior changes when executed inside a wrapper macro is obviously <span class="italic">not</span> a pure function. <span class="calibre8"><span class="calibre39">print</span></span> and <span class="calibre8"><span class="calibre39">println</span></span> behave differently based on the value of <span class="calibre8"><span class="calibre39">*out*</span></span> and so are not pure functions. Macros that set a <span class="calibre8"><span class="calibre39">binding</span></span>, such as <span class="calibre8"><span class="calibre39">with-out-str</span></span>, do so to alter the behavior of an impure function somewhere. </p><p class="calibre12"> Not all wrappers change the behavior of the functions they wrap. You’ve already seen <span class="calibre8"><span class="calibre39">time</span></span>, which times a function’s execution. Another example is <span class="calibre8"><span class="calibre39">assert</span></span>:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">assert</span></span></span><span class="calibre8"> expr)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">assert</span></span> tests an expression and raises an exception if it is not logically true: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(assert (= 1 1))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(assert (= 1 2))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.lang.Exception: Assert failed: (= 1 2)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Macros like <span class="calibre8"><span class="calibre39">assert</span></span> and <span class="calibre8"><span class="calibre39">time</span></span> violate the first rule of Macro Club in order to avoid unnecessary lambdas. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Avoiding Lambdas</span></span></span></p><p class="calibre44"> For historical reasons, anonymous functions are often called <span class="italic">lambdas</span>. Sometimes a macro can be replaced by a function call, with the arguments wrapped in a lambda. For example, the <span class="calibre8"><span class="calibre39">bench</span></span> macro from <a href="#filepos1077582">​<span class="italic">Syntax Quote, Unquote, and Splicing Unquote</span>​</a> does not need to be a macro. You can write it as a function: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> bench-fn [f]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [start (System/nanoTime)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        result (f)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     {:result result :elapsed (</span><span class="calibre8"><span class="bold"><span class="calibre36">-</span></span></span><span class="calibre8"> (System/nanoTime) start)}))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> However, if you want to call <span class="calibre8"><span class="calibre39">bench-fn</span></span>, you must pass it a function that wraps the form you want to execute. The following code shows the difference: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​; macro​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(bench (+ 1 2))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:elapsed 44000, :result 3}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​; function​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(bench-fn (fn [] (+ 1 2)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:elapsed 53000, :result 3}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> For things like <span class="calibre8"><span class="calibre39">bench</span></span>, macros and anonymous functions are near substitutes. Both prevent immediate execution of a form. However, the anonymous function approach requires more work on the part of the <span class="calibre8"><span class="calibre39">caller</span></span>, so it is OK to break the first rule and write a macro instead of a function. </p><p class="calibre12"> Another reason to prefer a macro for <span class="calibre8"><span class="calibre39">bench</span></span> is that <span class="calibre8"><span class="calibre39">bench-fn</span></span> is not a perfect substitute; it adds the overhead of an anonymous function call at runtime. Since <span class="calibre8"><span class="calibre39">bench</span></span>’s purpose is to time things, you should avoid this overhead. </p><div class="mbppagebreak"></div><p id="filepos1147465" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">7.5 Wrapping Up</span></span></span></p><p class="calibre34"> Clojure macros let you automate patterns in your code. Because they transform source code at macro expansion time, you can use macros to abstract away <span class="italic">any</span> kind of pattern in your code. You are not limited to working within Clojure. With macros, you can <span class="italic">extend</span> Clojure into your problem domain. </p><p class="calibre27"><span class="calibre8"><span class="bold"><span class="calibre28">Footnotes</span></span></span></p><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos1045231"><span class="calibre8">[56]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><span class="calibre8">We are not trying to beat up on Java in particular; it is just easier to talk about a specific language, and Java is well known.</span></p></td></tr><a id="filepos1148362"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos1048213"><span class="calibre8">[57]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://en.wikipedia.org/wiki/Design_pattern_(computer_science)"><span class="calibre8">http://en.wikipedia.org/wiki/Design_pattern_(computer_science)</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos1148727"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos1099036"><span class="calibre8">[58]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://thinkrelevance.com"><span class="calibre8">http://thinkrelevance.com</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos1149018"></a></table><p class="calibre18"><span class="calibre8"><span class="calibre19"><span class="calibre20">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="mbppagebreak"></div><p id="filepos1149215" class="calibre25"><span class="calibre2"><span class="bold"><span class="calibre43"> Chapter 8</span></span></span></p><br class="calibre11"/><p class="calibre26"><span class="calibre2"><span class="bold"><span class="calibre3">Multimethods</span></span></span></p><p class="calibre12"> Clojure multimethods provide a flexible way to associate a function with a set of inputs. This is similar to Java polymorphism but more general. When you call a Java method, Java selects a specific implementation to execute by examining the <span class="italic">type</span> of a <span class="italic">single object</span>. When you call a Clojure multimethod, Clojure selects a specific implementation to execute by examining the result of <span class="italic">any function you choose</span>, applied to <span class="italic">all</span> the function’s arguments. </p><p class="calibre12"> In this chapter, you will develop a thirst for multimethods by first living without them. Then you will build an increasingly complex series of multimethod implementations, first using multimethods to simulate polymorphism and then using multimethods to implement various ad hoc taxonomies. </p><p class="calibre12"> Multimethods in Clojure are used much less often than polymorphism in object-oriented languages. But where they are used, they are often the key feature in the code. Section 8.5, <a href="#filepos1221606">​<span class="italic">When Should I Use Multimethods?</span>​</a> explores how multimethods are used in several open source Clojure projects and offers guidelines for when to use them in your own programs. </p><p class="calibre12"> If you are reading the book in chapter order, then once you have completed this chapter, you will have seen all the key features of the Clojure language. </p><div class="mbppagebreak"></div><p id="filepos1150910" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">8.1 Living Without Multimethods</span></span></span></p><p class="calibre34"> The best way to appreciate multimethods is to spend a few minutes living without them, so let’s do that. Clojure can already print anything with <span class="calibre8"><span class="calibre39">print</span></span>/<span class="calibre8"><span class="calibre39">println</span></span>. But pretend for a moment that these functions do not exist and that you need to build a generic print mechanism. To get started, create a <span class="calibre8"><span class="calibre39">my-print</span></span> function that can print a string to the standard output stream <span class="calibre8"><span class="calibre39">*out*</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/life_without_multi.clj"><span class="calibre41"><span class="underline">src/examples/life_without_multi.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> my-print [ob]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write *out* ob))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Next, create a <span class="calibre8"><span class="calibre39">my-println</span></span> that simply calls <span class="calibre8"><span class="calibre39">my-print</span></span> and then adds a line feed: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/life_without_multi.clj"><span class="calibre41"><span class="underline">src/examples/life_without_multi.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> my-println [ob]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (my-print ob)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write *out* </span><span class="calibre8"><span class="italic"><span class="calibre42">"\n"</span></span></span><span class="calibre8">))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The line feed makes <span class="calibre8"><span class="calibre39">my-println</span></span>’s output easier to read when testing at the REPL. For the remainder of this section, you will make changes to <span class="calibre8"><span class="calibre39">my-print</span></span> and test them by calling <span class="calibre8"><span class="calibre39">my-println</span></span>. Test that <span class="calibre8"><span class="calibre39">my-println</span></span> works with strings: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(my-println "hello")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| hello​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> That is nice, but <span class="calibre8"><span class="calibre39">my-println</span></span> does not work quite so well with nonstrings such as <span class="calibre8"><span class="calibre39">nil</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(my-println nil)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.lang.NullPointerException​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> That’s not a big deal, though. Just use <span class="calibre8"><span class="calibre39">cond</span></span> to add special-case handling for <span class="calibre8"><span class="calibre39">nil</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/life_without_multi.clj"><span class="calibre41"><span class="underline">src/examples/life_without_multi.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> my-print [ob]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">cond</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   (</span><span class="calibre8"><span class="bold"><span class="calibre36">nil?</span></span></span><span class="calibre8"> ob) (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write *out* </span><span class="calibre8"><span class="italic"><span class="calibre42">"nil"</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   (</span><span class="calibre8"><span class="bold"><span class="calibre36">string?</span></span></span><span class="calibre8"> ob) (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write *out* ob)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> With the conditional in place, you can print <span class="calibre8"><span class="calibre39">nil</span></span> with no trouble: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(my-println nil)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| nil​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Of course, there are still all kinds of types that <span class="calibre8"><span class="calibre39">my-println</span></span> cannot deal with. If you try to print a vector, neither of the <span class="calibre8"><span class="calibre39">cond</span></span> clauses will match, and the program will print nothing at all: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(my-println [1 2 3])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> By now you know the drill. Just add another <span class="calibre8"><span class="calibre39">cond</span></span> clause for the vector case. The implementation here is a little more complex, so you might want to separate the actual printing into a helper function, such as <span class="calibre8"><span class="calibre39">my-print-vector</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/life_without_multi.clj"><span class="calibre41"><span class="underline">src/examples/life_without_multi.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">require</span></span></span><span class="calibre8"> '[clojure.string :as </span><span class="calibre8"><span class="bold"><span class="calibre36">str</span></span></span><span class="calibre8">])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> my-print-vector [ob]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write *out*</span><span class="calibre8"><span class="italic"><span class="calibre42">"["</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write *out* (str/join </span><span class="calibre8"><span class="italic"><span class="calibre42">" "</span></span></span><span class="calibre8"> ob))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write *out* </span><span class="calibre8"><span class="italic"><span class="calibre42">"]"</span></span></span><span class="calibre8">))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> my-print [ob]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">cond</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   (</span><span class="calibre8"><span class="bold"><span class="calibre36">vector?</span></span></span><span class="calibre8"> ob) (my-print-vector ob)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   (</span><span class="calibre8"><span class="bold"><span class="calibre36">nil?</span></span></span><span class="calibre8"> ob) (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write *out* </span><span class="calibre8"><span class="italic"><span class="calibre42">"nil"</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   (</span><span class="calibre8"><span class="bold"><span class="calibre36">string?</span></span></span><span class="calibre8"> ob) (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write *out* ob)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Make sure that you can now print a vector:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(my-println [1 2 3])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| [1 2 3]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">my-println</span></span> now supports three types: strings, vectors, and <span class="calibre8"><span class="calibre39">nil</span></span>. And you have a road map for new types: just add new clauses to the <span class="calibre8"><span class="calibre39">cond</span></span> in <span class="calibre8"><span class="calibre39">my-println</span></span>. But it is a crummy road map, because it conflates two things: the decision process for selecting an implementation and the specific implementation detail. </p><p class="calibre12"> You can improve the situation somewhat by pulling out helper functions like <span class="calibre8"><span class="calibre39">my-print-vector</span></span>. However, then you have to make two separate changes every time you want to a add new feature to <span class="calibre8"><span class="calibre39">my-println</span></span>: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Create a new type-specific helper function. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Modify the existing <span class="calibre8"><span class="calibre39">my-println</span></span> to add a new <span class="calibre8"><span class="calibre39">cond</span></span> invoking the feature-specific helper. </p></li><a></a></ul><p class="calibre12"> What you really want is a way to add new features to the system by adding new code in a single place, without having to modify any existing code. Clojure offers this by way of protocols, covered in Section 6.3, <a href="#filepos901252">​<span class="italic">Protocols</span>​</a>, and multimethods. </p><div class="mbppagebreak"></div><p id="filepos1164941" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">8.2 Defining Multimethods</span></span></span></p><p class="calibre34"> To define a multimethod, use <span class="calibre8"><span class="calibre39">defmulti</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmulti</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">name</span></span></span><span class="calibre8"> dispatch-fn)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">name</span></span> is the name of the new multimethod, and Clojure will invoke <span class="calibre8"><span class="calibre39">dispatch-fn</span></span> against the method arguments to select one particular method (implementation) of the multimethod. </p><p class="calibre12"> Consider <span class="calibre8"><span class="calibre39">my-print</span></span> from the previous section. It takes a single argument, the thing to be printed, and you want to select a specific implementation based on the type of that argument. So, <span class="calibre8"><span class="calibre39">dispatch-fn</span></span> needs to be a function of one argument that returns the type of that argument. Clojure has a built-in function matching this description, namely, <span class="calibre8"><span class="calibre39">class</span></span>. Use <span class="calibre8"><span class="calibre39">class</span></span> to create a multimethod called <span class="calibre8"><span class="calibre39">my-print</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/multimethods.clj"><span class="calibre41"><span class="underline">src/examples/multimethods.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmulti</span></span></span><span class="calibre8"> my-print </span><span class="calibre8"><span class="bold"><span class="calibre36">class</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> At this point, you have provided a description of how the multimethod will select a specific method but no actual specific methods. Unsurprisingly, attempts to call <span class="calibre8"><span class="calibre39">my-print</span></span> will fail: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(my-println "foo")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.lang.IllegalArgumentException: \​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​No method for dispatch value​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> To add a specific method implementation to <span class="calibre8"><span class="calibre39">my-println</span></span>, use <span class="calibre8"><span class="calibre39">defmethod:</span></span>
</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">name</span></span></span><span class="calibre8"> dispatch-val &amp; fn-tail)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">name</span></span> is the name of the multimethod to which an implementation belongs. Clojure matches the result of <span class="calibre8"><span class="calibre39">defmulti</span></span>’s dispatch function with <span class="calibre8"><span class="calibre39">dispatch-val</span></span> to select a method, and <span class="calibre8"><span class="calibre39">fn-tail</span></span> contains arguments and body forms just like a normal function. </p><p class="calibre12"> Create a <span class="calibre8"><span class="calibre39">my-print</span></span> implementation that matches on strings: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/multimethods.clj"><span class="calibre41"><span class="underline">src/examples/multimethods.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> my-print String [s]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write *out* s))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now, call <span class="calibre8"><span class="calibre39">my-println</span></span> with a string argument: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(my-println "stu")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| stu​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Next, create a <span class="calibre8"><span class="calibre39">my-print</span></span> that matches on <span class="calibre8"><span class="calibre39">nil</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/multimethods.clj"><span class="calibre41"><span class="underline">src/examples/multimethods.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> my-print nil [s]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write *out* </span><span class="calibre8"><span class="italic"><span class="calibre42">"nil"</span></span></span><span class="calibre8">))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Notice that you have solved the problem raised in the previous section. Instead of being joined in a big <span class="calibre8"><span class="calibre39">cond</span></span>, each implementation of <span class="calibre8"><span class="calibre39">my-println</span></span> is separate. Methods of a multimethod can live anywhere in your source, and you can add new ones any time, without having to touch the original code. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Dispatch Is Inheritance-Aware</span></span></span></p><p class="calibre44"> Multimethod dispatch knows about Java inheritance. To see this, create a <span class="calibre8"><span class="calibre39">my-print</span></span> that handles <span class="calibre8"><span class="calibre39">Number</span></span> by printing a number’s <span class="calibre8"><span class="calibre39">toString</span></span> representation: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/multimethods.clj"><span class="calibre41"><span class="underline">src/examples/multimethods.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> my-print Number [n]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write *out* (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">toString n)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Test the <span class="calibre8"><span class="calibre39">Number</span></span> implementation with an integer: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(my-println 42)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| 42​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">42</span></span> is an <span class="calibre8"><span class="calibre39">Integer</span></span>, not a <span class="calibre8"><span class="calibre39">Number</span></span>. Multimethod dispatch is smart enough to know that an integer is a number and match anyway. Internally, dispatch uses the <span class="calibre8"><span class="calibre39">isa?</span></span> function: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">isa?</span></span></span><span class="calibre8"> child parent)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">isa?</span></span> knows about Java inheritance, so it knows that an <span class="calibre8"><span class="calibre39">Integer</span></span> is a <span class="calibre8"><span class="calibre39">Number</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(isa? Integer Number)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">isa?</span></span> is not limited to inheritance. Its behavior can be extended dynamically at runtime, as you will see later in Section 8.4, <a href="#filepos1194210">​<span class="italic">Creating Ad Hoc Taxonomies</span>​</a>. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Multimethod Defaults</span></span></span></p><p class="calibre44"> It would be nice if <span class="calibre8"><span class="calibre39">my-print</span></span> could have a fallback representation that you could use for any type you have not specifically defined. You can use <span class="calibre8"><span class="calibre39">:default</span></span> as a dispatch value to handle any methods that do not match anything more specific. Using <span class="calibre8"><span class="calibre39">:default</span></span>, create a <span class="calibre8"><span class="calibre39">my-println</span></span> that prints the Java <span class="calibre8"><span class="calibre39">toString</span></span> value of objects, wrapped in <span class="calibre8"><span class="calibre39">#&lt;&gt;</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/multimethods.clj"><span class="calibre41"><span class="underline">src/examples/multimethods.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> my-print :default [s]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write *out* </span><span class="calibre8"><span class="italic"><span class="calibre42">"#&lt;"</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write *out* (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">toString s))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write *out* </span><span class="calibre8"><span class="italic"><span class="calibre42">"&gt;"</span></span></span><span class="calibre8">))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now test that <span class="calibre8"><span class="calibre39">my-println</span></span> prints random things, using the default method: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(my-println (java.sql.Date. 0))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #&lt;1969-12-31&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(my-println (java.util.Random.))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #&lt;java.util.Random@1c398896&gt;​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> In the unlikely event that <span class="calibre8"><span class="calibre39">:default</span></span> already has some specific meaning in your domain, you can create a multimethod using this alternate signature: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmulti</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">name</span></span></span><span class="calibre8"> dispatch-fn :default default-value)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">default-value</span></span> lets you specify your own default. Maybe you would like to call it <span class="calibre8"><span class="calibre39">:everything-else</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/multimethods/default.clj"><span class="calibre41"><span class="underline">src/examples/multimethods/default.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmulti</span></span></span><span class="calibre8"> my-print </span><span class="calibre8"><span class="bold"><span class="calibre36">class</span></span></span><span class="calibre8"> :default :everything-else)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> my-print String [s]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write *out* s))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> my-print :everything-else [_]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write *out* </span><span class="calibre8"><span class="italic"><span class="calibre42">"Not implemented yet..."</span></span></span><span class="calibre8">))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Any dispatch value that does not otherwise match will now match against <span class="calibre8"><span class="calibre39">:everything-else</span></span>. </p><p class="calibre12"> Dispatching a multimethod on the type of the first argument, as you have done with <span class="calibre8"><span class="calibre39">my-print</span></span>, is by far the most common kind of dispatch. In many object-oriented languages, in fact, it is the <span class="italic">only</span> kind of dynamic dispatch, and it goes by the name <span class="italic">polymorphism</span>. </p><p class="calibre12"> Clojure’s dispatch is much more general. Let’s add a few complexities to <span class="calibre8"><span class="calibre39">my-print</span></span> and move beyond what is possible with plain ol’ polymorphism. </p><div class="mbppagebreak"></div><p id="filepos1183130" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">8.3 Moving Beyond Simple Dispatch</span></span></span></p><p class="calibre34"> Clojure’s <span class="calibre8"><span class="calibre39">print</span></span> function prints various “sequencey” things as lists. If you wanted <span class="calibre8"><span class="calibre39">my-print</span></span> to do something similar, you could add a method that dispatched on a collection interface high in the Java inheritance hierarchy, such as <span class="calibre8"><span class="calibre39">Collection</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/multimethods.clj"><span class="calibre41"><span class="underline">src/examples/multimethods.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">require</span></span></span><span class="calibre8"> '[clojure.string :as </span><span class="calibre8"><span class="bold"><span class="calibre36">str</span></span></span><span class="calibre8">])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> my-print java.util.Collection [c]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write *out* </span><span class="calibre8"><span class="italic"><span class="calibre42">"("</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write *out* (str/join </span><span class="calibre8"><span class="italic"><span class="calibre42">" "</span></span></span><span class="calibre8"> c))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write *out* </span><span class="calibre8"><span class="italic"><span class="calibre42">")"</span></span></span><span class="calibre8">))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now, try various sequences to see that they get a nice print representation: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(my-println (take 6 (cycle [1 2 3])))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| (1 2 3 1 2 3)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(my-println [1 2 3])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| (1 2 3)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Perfectionist that you are, you cannot stand that vectors print with rounded braces, unlike their literal square-brace syntax. So, add yet another <span class="calibre8"><span class="calibre39">my-print</span></span> method, this time to handle vectors. Vectors all implement an <span class="calibre8"><span class="calibre39">IPersistentVector</span></span>, so this should work: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/multimethods.clj"><span class="calibre41"><span class="underline">src/examples/multimethods.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> my-print clojure.lang.IPersistentVector [c]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write *out* </span><span class="calibre8"><span class="italic"><span class="calibre42">"["</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write *out* (str/join </span><span class="calibre8"><span class="italic"><span class="calibre42">" "</span></span></span><span class="calibre8"> c))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write *out* </span><span class="calibre8"><span class="italic"><span class="calibre42">"]"</span></span></span><span class="calibre8">))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> But it doesn’t work. Instead, printing vectors now throws an exception: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(my-println [1 2 3])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.lang.IllegalArgumentException: Multiple methods match​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​dispatch value: class clojure.lang.LazilyPersistentVector -&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​interface clojure.lang.IPersistentVector and​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​interface java.util.Collection,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​and neither is preferred​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The problem is that two dispatch values now match for vectors: <span class="calibre8"><span class="calibre39">Collection</span></span> and <span class="calibre8"><span class="calibre39">IPersistentVector</span></span>. Many languages constrain method dispatch to make sure these conflicts never happen, such as by forbidding multiple inheritance. Clojure takes a different approach. You can create conflicts, and you can resolve them with <span class="calibre8"><span class="calibre39">prefer-method</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">prefer-method</span></span></span><span class="calibre8"> multi-name loved-dispatch dissed-dispatch)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> When you call <span class="calibre8"><span class="calibre39">prefer-method</span></span> for a multimethod, you tell it to prefer the <span class="calibre8"><span class="calibre39">loved-dispatch</span></span> value over the <span class="calibre8"><span class="calibre39">dissed-dispatch</span></span> value whenever there is a conflict. Since you want the vector version of <span class="calibre8"><span class="calibre39">my-print</span></span> to trump the collection version, tell the multimethod what you want: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/multimethods.clj"><span class="calibre41"><span class="underline">src/examples/multimethods.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">prefer-method</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​ my-print clojure.lang.IPersistentVector java.util.Collection)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now, you should be able to route both vectors and other sequences to the correct method implementation: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(my-println (take 6 (cycle [1 2 3])))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| (1 2 3 1 2 3)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(my-println [1 2 3])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| [1 2 3]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Many languages create complex rules, or arbitrary limitations, in order to resolve ambiguities in their systems for dispatching functions. Clojure allows a much simpler approach: just don’t worry about it! If there is an ambiguity, use <span class="calibre8"><span class="calibre39">prefer-method</span></span> to resolve it. </p><div class="mbppagebreak"></div><p id="filepos1194210" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">8.4 Creating Ad Hoc Taxonomies</span></span></span></p><p class="calibre34"> Multimethods let you create ad hoc taxonomies, which can be helpful when you discover type relationships that are not explicitly declared as such. </p><p class="calibre12"> For example, consider a financial application that deals with checking and savings accounts. Define a Clojure struct for an account, using a <span class="calibre8"><span class="calibre39">tag</span></span> to distinguish the two. Place the code in the namespace <span class="calibre8"><span class="calibre39">examples.multimethods.account</span></span>. To do this, you will need to create a file named <span class="calibre8"><span class="calibre39">examples/multimethods/account.clj</span></span> on your classpath<a id="filepos1195026"></a><a href="#filepos1241963">[59]</a> and then enter the following code: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/multimethods/account.clj"><span class="calibre41"><span class="underline">src/examples/multimethods/account.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">ns</span></span></span><span class="calibre8"> examples.multimethods.account)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defstruct</span></span></span><span class="calibre8"> account :id :tag :balance)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now, you are going to create two different checking accounts, tagged as <span class="calibre8"><span class="calibre39">::Checking</span></span> and <span class="calibre8"><span class="calibre39">::Savings</span></span>. The capital names are a Clojure convention to show the keywords are acting as types. The doubled <span class="calibre8"><span class="calibre39">::</span></span> causes the keywords to resolve in the current namespace. To see the namespace resolution happen, compare entering <span class="calibre8"><span class="calibre39">:Checking</span></span> and <span class="calibre8"><span class="calibre39">::Checking</span></span> at the REPL: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​:Checking​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; :Checking​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​::Checking​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; :user/Checking​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Placing keywords in a namespace helps prevent name collisions with other people’s code. When you want to use <span class="calibre8"><span class="calibre39">::Savings</span></span> or <span class="calibre8"><span class="calibre39">::Checking</span></span> from another namespace, you will need to fully qualify them: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(struct account 1 ::examples.multimethods.account/Savings 100M)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:id 1, :tag :examples.multimethods.account/Savings, :balance 100M}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Full names get tedious quickly, so you can use <span class="calibre8"><span class="calibre39">alias</span></span> to specify a shorter alias for a long namespace name: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">alias</span></span></span><span class="calibre8"> short-name-symbol namespace-symbol)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Use <span class="calibre8"><span class="calibre39">alias</span></span> to create the short name <span class="calibre8"><span class="calibre39">acc</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(alias 'acc 'examples.multimethods.account)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now that the <span class="calibre8"><span class="calibre39">acc</span></span> alias is available, create two top-level test objects, a savings account and a checking account: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def test-savings (struct account 1 ::acc/Savings 100M))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/test-savings​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def test-checking (struct account 2 ::acc/Checking 250M))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/test-checking​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Note that the trailing <span class="calibre8"><span class="calibre39">M</span></span> creates a <span class="calibre8"><span class="calibre39">BigDecimal</span></span> literal and does not mean you have millions of dollars. </p><p class="calibre12"> The interest rate for checking accounts is 0 and for savings accounts is 5 percent. Create a multimethod <span class="calibre8"><span class="calibre39">interest-rate</span></span> that dispatches based on <span class="calibre8"><span class="calibre39">:tag</span></span>, like so: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/multimethods/account.clj"><span class="calibre41"><span class="underline">src/examples/multimethods/account.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmulti</span></span></span><span class="calibre8"> interest-rate :tag)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> interest-rate ::acc/Checking [_] 0M)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> interest-rate ::acc/Savings [_] 0.05M)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Check your <span class="calibre8"><span class="calibre39">test-savings</span></span> and <span class="calibre8"><span class="calibre39">test-checking</span></span> to make sure that <span class="calibre8"><span class="calibre39">interest-rate</span></span> works as expected. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(interest-rate test-savings)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 0.05M​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(interest-rate test-checking)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 0M​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Accounts have an annual service charge, with rules as follows: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">Normal checking accounts pay a $25 service charge.</p></li><a></a><li value="2" class="calibre30"><p class="calibre29">Normal savings accounts pay a $10 service charge.</p></li><a></a><li value="3" class="calibre30"><p class="calibre29">Premium accounts have no fee.</p></li><a></a><li value="4" class="calibre30"><p class="calibre29">Checking accounts with a balance of $5,000 or more are premium.</p></li><a></a><li value="5" class="calibre30"><p class="calibre29">Savings accounts with a balance of $1,000 or more are premium.</p></li><a></a></ul><p class="calibre12"> In a realistic example, the rules would be more complex. Premium status would be driven by average balance over time, and there would probably be other ways to qualify. But the previous rules are complex enough to demonstrate the point. </p><p class="calibre12"> You could implement <span class="calibre8"><span class="calibre39">service-charge</span></span> with a bunch of conditional logic, but <span class="calibre8"><span class="calibre39">premium</span></span> feels like a type, even though there is no explicit <span class="calibre8"><span class="calibre39">premium</span></span> tag on an account. Create an <span class="calibre8"><span class="calibre39">account-level</span></span> multimethod that returns <span class="calibre8"><span class="calibre39">::Premium</span></span> or <span class="calibre8"><span class="calibre39">::Basic</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/multimethods/account.clj"><span class="calibre41"><span class="underline">src/examples/multimethods/account.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmulti</span></span></span><span class="calibre8"> account-level :tag)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> account-level ::acc/Checking [acct]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">&gt;</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> (:balance acct) 5000) ::acc/Premium ::acc/Basic))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> account-level ::acc/Savings [acct]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">&gt;</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> (:balance acct) 1000) ::acc/Premium ::acc/Basic))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Test <span class="calibre8"><span class="calibre39">account-level</span></span> to make sure that checking and savings accounts require different balance levels to reach <span class="calibre8"><span class="calibre39">::Premium</span></span> status: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(account-level (struct account 1 ::acc/Savings 2000M))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; :examples.multimethods.account/Premium​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(account-level (struct account 1 ::acc/Checking 2000M))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; :examples.multimethods.account/Basic​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now you might be tempted to implement <span class="calibre8"><span class="calibre39">service-charge</span></span> using <span class="calibre8"><span class="calibre39">account-level</span></span> as a dispatch function: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/multimethods/service_charge_1.clj"><span class="calibre41"><span class="underline">src/examples/multimethods/service_charge_1.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; bad approach</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmulti</span></span></span><span class="calibre8"> service-charge account-level)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> service-charge ::Basic [acct]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> (:tag acct) ::Checking) 25 10))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> service-charge ::Premium [_] 0)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The conditional logic in <span class="calibre8"><span class="calibre39">service-charge</span></span> for <span class="calibre8"><span class="calibre39">::Basic</span></span> is exactly the kind of type-driven conditional that multimethods should help us avoid. The problem here is that you are already dispatching by <span class="calibre8"><span class="calibre39">account-level</span></span>, and now you need to be dispatching by <span class="calibre8"><span class="calibre39">:tag</span></span> as well. No problem—you can dispatch on <span class="italic">both</span>. Write a <span class="calibre8"><span class="calibre39">service-charge</span></span> whose dispatch function calls both <span class="calibre8"><span class="calibre39">account-level</span></span> and <span class="calibre8"><span class="calibre39">:tag</span></span>, returning the results in a vector: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/multimethods/service_charge_2.clj"><span class="calibre41"><span class="underline">src/examples/multimethods/service_charge_2.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmulti</span></span></span><span class="calibre8"> service-charge (</span><span class="calibre8"><span class="bold"><span class="calibre36">fn</span></span></span><span class="calibre8"> [acct] [(account-level acct) (:tag acct)]))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> service-charge [::acc/Basic ::acc/Checking]   [_] 25)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> service-charge [::acc/Basic ::acc/Savings]    [_] 10)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> service-charge [::acc/Premium ::acc/Checking] [_] 0)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> service-charge [::acc/Premium ::acc/Savings]  [_] 0)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> This version of <span class="calibre8"><span class="calibre39">service-charge</span></span> dispatches against two different taxonomies: the <span class="calibre8"><span class="calibre39">:tag</span></span> intrinsic to an account and the externally defined <span class="calibre8"><span class="calibre39">account-level</span></span>. Try a few accounts to verify that <span class="calibre8"><span class="calibre39">service-charge</span></span> works as expected: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(service-charge {:tag ::acc/Checking :balance 1000})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 25​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(service-charge {:tag ::acc/Savings :balance 1000})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 0​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Notice that the previous tests did not even bother to create a “real” account for testing. Structs like <span class="calibre8"><span class="calibre39">account</span></span> are simply maps that are optimized for storing particular fields, but nothing is stopping you from using a plain old map if you find it more convenient. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Adding Inheritance to Ad Hoc Types</span></span></span></p><p class="calibre44"> There is one further improvement you can make to <span class="calibre8"><span class="calibre39">service-charge</span></span>. Since all premium accounts have the same service charge, it feels redundant to have to define two separate <span class="calibre8"><span class="calibre39">service-charge</span></span> methods for <span class="calibre8"><span class="calibre39">::Savings</span></span> and <span class="calibre8"><span class="calibre39">::Checking</span></span> accounts. It would be nice to have a parent type <span class="calibre8"><span class="calibre39">::Account</span></span> so you could define a multimethod that matches <span class="calibre8"><span class="calibre39">::Premium</span></span> for any kind of <span class="calibre8"><span class="calibre39">::Account</span></span>. Clojure lets you define arbitrary parent-child relationships with <span class="calibre8"><span class="calibre39">derive</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">derive</span></span></span><span class="calibre8"> child parent)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Using <span class="calibre8"><span class="calibre39">derive</span></span>, you can specify that both <span class="calibre8"><span class="calibre39">::Savings</span></span> and <span class="calibre8"><span class="calibre39">::Checking</span></span> are kinds of <span class="calibre8"><span class="calibre39">::Account</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/multimethods/service_charge_3.clj"><span class="calibre41"><span class="underline">src/examples/multimethods/service_charge_3.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">derive</span></span></span><span class="calibre8"> ::acc/Savings ::acc/Account)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">derive</span></span></span><span class="calibre8"> ::acc/Checking ::acc/Account)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> When you start to use <span class="calibre8"><span class="calibre39">derive</span></span>, <span class="calibre8"><span class="calibre39">isa?</span></span> comes into its own. In addition to understanding Java inheritance, <span class="calibre8"><span class="calibre39">isa?</span></span> knows all about <span class="calibre8"><span class="calibre39">derive</span></span>d relationships: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(isa? ::acc/Savings ::acc/Account)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now that Clojure knows that <span class="calibre8"><span class="calibre39">Savings</span></span> and <span class="calibre8"><span class="calibre39">Checking</span></span> are <span class="calibre8"><span class="calibre39">Account</span></span>s, you can define a <span class="calibre8"><span class="calibre39">service-charge</span></span> using a single method to handle <span class="calibre8"><span class="calibre39">::Premium</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/multimethods/service_charge_3.clj"><span class="calibre41"><span class="underline">src/examples/multimethods/service_charge_3.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmulti</span></span></span><span class="calibre8"> service-charge (</span><span class="calibre8"><span class="bold"><span class="calibre36">fn</span></span></span><span class="calibre8"> [acct] [(account-level acct) (:tag acct)]))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> service-charge [::acc/Basic ::acc/Checking]   [_] 25)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> service-charge [::acc/Basic ::acc/Savings]    [_] 10)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> service-charge [::acc/Premium ::acc/Account] [_] 0)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> At first glance, you may think that <span class="calibre8"><span class="calibre39">derive</span></span> and <span class="calibre8"><span class="calibre39">isa?</span></span> simply duplicate functionality that is already available to Clojure via Java inheritance. This is not the case. Java inheritance relationships are forever fixed at the moment you define a class. <span class="calibre8"><span class="calibre39">derive</span></span>d relationships can be created when you need them and can be <span class="italic">applied to existing objects without their knowledge or consent.</span> So, when you discover a useful relationship between existing objects, you can <span class="calibre8"><span class="calibre39">derive</span></span> that relationship without touching the original objects’ source code and without creating tiresome “wrapper” classes. </p><p class="calibre12"> If the number of different ways you might define a multimethod has your head spinning, don’t worry. In practice, most Clojure code uses multimethods sparingly. Let’s take a look at some open source Clojure code to get a better idea of how multimethods are used. </p><div class="mbppagebreak"></div><p id="filepos1221606" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">8.5 When Should I Use Multimethods?</span></span></span></p><p class="calibre34"> Multimethods are extremely flexible, and with that flexibility comes choices. How should you choose when to use multimethods, as opposed to some other technique? We approached this question from two directions, asking the following: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">Where do Clojure projects use multimethods?</p></li><a></a><li value="2" class="calibre30"><p class="calibre29">Where do Clojure projects <span class="italic">eschew</span> multimethods?</p></li><a></a></ul><p class="calibre12"> The most striking thing is that multimethods are <span class="italic">rare</span>—about one per 1,000 lines of code. So, don’t worry that you are missing something important if you build a Clojure application with few, or no, multimethods. A Clojure program that defines no multimethods is not nearly as odd as an object-oriented program with no polymorphism. </p><p class="calibre12"> Many multimethods dispatch on class. Dispatch-by-class is the easiest kind of dispatch to understand and implement. We already covered it in detail with the <span class="calibre8"><span class="calibre39">my-print</span></span> example, so I will say no more about it here. </p><p class="calibre12"> Clojure multimethods that dispatch on something other than class are fairly rare. We can look directly in Clojure for some examples. The <span class="calibre8"><span class="calibre39">clojure.inspector</span></span> and <span class="calibre8"><span class="calibre39">clojure.test</span></span> libraries use unusual dispatch functions. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">The Inspector</span></span></span></p><p class="calibre44"> Clojure’s <span class="calibre8"><span class="calibre39">inspector</span></span> library uses Swing to create simple views of data. You can use it to get a tree view of your system properties: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(use '[clojure.inspector :only (inspect inspect-tree)])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(inspect-tree (System/getProperties))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #&lt;JFrame ...&gt;​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">inspect-tree</span></span> returns (and displays) a <span class="calibre8"><span class="calibre39">JFrame</span></span> with a tree view of anything that is treeish. So, you could also pass a nested map to <span class="calibre8"><span class="calibre39">inspect-tree</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(inspect-tree {:clojure {:creator "Rich" :runs-on-jvm true}})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #&lt;JFrame ...&gt;​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Treeish things are made up of nodes that can answer two questions: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">Who are my children?</p></li><a></a><li value="2" class="calibre30"><p class="calibre29">Am I a leaf node?</p></li><a></a></ul><p class="calibre12"> The treeish concepts of “tree,” “node,” and “leaf” all sound like candidates for classes or interfaces in an object-oriented design. But the inspector does not work this way. Instead, it adds a “treeish” type system in an ad hoc way to existing types, using a dispatch function named <span class="calibre8"><span class="calibre39">collection-tag</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; from Clojure's clojure/inspector.clj</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> collection-tag [x]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">cond</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">instance?</span></span></span><span class="calibre8"> java.util.Map$Entry x) :entry​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">instance?</span></span></span><span class="calibre8"> clojure.lang.IPersistentMap x) :map​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">instance?</span></span></span><span class="calibre8"> java.util.Map x) :map​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">instance?</span></span></span><span class="calibre8"> clojure.lang.Sequential x) :seq​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    :else :atom))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">collection-tag</span></span> returns one of the keywords <span class="calibre8"><span class="calibre39">:entry</span></span>, <span class="calibre8"><span class="calibre39">:map</span></span>, <span class="calibre8"><span class="calibre39">:seq</span></span>, or <span class="calibre8"><span class="calibre39">:atom</span></span>. These act as the type system for the treeish world. The <span class="calibre8"><span class="calibre39">collection-tag</span></span> function is then used to dispatch three different multimethods that select specific implementations based on the treeish type system. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmulti</span></span></span><span class="calibre8"> is-leaf collection-tag)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmulti</span></span></span><span class="calibre8"> get-child​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">fn</span></span></span><span class="calibre8"> [parent index] (collection-tag parent)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmulti</span></span></span><span class="calibre8"> get-child-count collection-tag)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; method implementations elided for brevity</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The treeish type system is added around the existing Java type system. Existing objects do not have to <span class="italic">do</span> anything to become treeish; the <span class="calibre8"><span class="calibre39">inspector</span></span> library does it for them. Treeish demonstrates a powerful style of reuse. You can discover new type relationships in existing code and take advantage of these relationships simply, without having to modify the original code. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">clojure.test</span></span></span></p><p class="calibre44"> The <span class="calibre8"><span class="calibre39">clojure.test</span></span> library in Clojure lets you write several different kinds of assertions using the <span class="calibre8"><span class="calibre39">is</span></span> macro. You can assert that arbitrary functions are true. For example, <span class="calibre8"><span class="calibre39">10</span></span> is not a string: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(use :reload '[clojure.test :only (is)])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(is (string? 10))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​FAIL in clojure.lang.PersistentList$EmptyList@1 (NO_SOURCE_FILE:2)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​expected: (string? 10)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​actual: (not (string? 10))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; false​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Although you can use an arbitrary function, <span class="calibre8"><span class="calibre39">is</span></span> knows about a few specific functions and provides more detailed error messages. For example, you can check that a string is not an <span class="calibre8"><span class="calibre39">instance?</span></span> of <span class="calibre8"><span class="calibre39">Collection</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(is (instance? java.util.Collection "foo"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​FAIL in clojure.lang.PersistentList$EmptyList@1 (NO_SOURCE_FILE:3)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​expected: (instance? java.util.Collection "foo")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​actual: java.lang.String​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; false​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">is</span></span> also knows about <span class="calibre8"><span class="calibre39">=</span></span>. Verify that <span class="calibre8"><span class="calibre39">power</span></span> does not equal <span class="calibre8"><span class="calibre39">wisdom</span></span>. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(is (= "power" "wisdom"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​FAIL in clojure.lang.PersistentList$EmptyList@1 (NO_SOURCE_FILE:4)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​expected: (= "power" "wisdom")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​actual: (not (= "power" "wisdom"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; false​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Internally, <span class="calibre8"><span class="calibre39">is</span></span> uses a multimethod named <span class="calibre8"><span class="calibre39">assert-expr</span></span>, which dispatches not on the type but on the actual <span class="italic">identity</span> of its first argument: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defmulti assert-expr (fn [form message] (first form)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Since the first argument is a symbol representing what function to check, this amounts to yet another ad hoc type system. This time, there are three types: <span class="calibre8"><span class="calibre39">=</span></span>, <span class="calibre8"><span class="calibre39">instance?</span></span>, and everything else. </p><p class="calibre12"> The various <span class="calibre8"><span class="calibre39">assert-expr</span></span> methods add specific error messages associated with different functions you might call from <span class="calibre8"><span class="calibre39">is</span></span>. Because multimethods are open ended, you can add your own <span class="calibre8"><span class="calibre39">assert-expr</span></span> methods with improved error messages for other functions you frequently pass to <span class="calibre8"><span class="calibre39">is</span></span>. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Counterexamples</span></span></span></p><p class="calibre44"> As you saw in Section 8.4, <a href="#filepos1194210">​<span class="italic">Creating Ad Hoc Taxonomies</span>​</a>, you can often use multimethods to hoist branches that are based on type out of the main flow of your functions. To find counterexamples where multimethods should not be used, we looked through Clojure’s core to find type branches that had <span class="italic">not</span> been hoisted to multimethods. </p><p class="calibre12"> A simple example is Clojure’s <span class="calibre8"><span class="calibre39">class</span></span>, which is a null-safe wrapper for the underlying Java <span class="calibre8"><span class="calibre39">getClass</span></span>. Minus comments and metadata, <span class="calibre8"><span class="calibre39">class</span></span> is as follows: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defn class [x]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(if (nil? x) x (. x (getClass))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> You could write your own version of <span class="calibre8"><span class="calibre39">class</span></span> as a multimethod by dispatching on <span class="calibre8"><span class="calibre39">identity</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/multimethods.clj"><span class="calibre41"><span class="underline">src/examples/multimethods.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmulti</span></span></span><span class="calibre8"> my-class </span><span class="calibre8"><span class="bold"><span class="calibre36">identity</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> my-class nil [_] nil)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defmethod</span></span></span><span class="calibre8"> my-class :default [x] (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getClass x))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Any <span class="calibre8"><span class="calibre39">nil</span></span>-check could be rewritten this way. But I find the original <span class="calibre8"><span class="calibre39">class</span></span> function easier to read than the multimethod version. This is a nice “exception that proves the rule.” Even though <span class="calibre8"><span class="calibre39">class</span></span> branches on type, the branching version is easier to read. </p><p class="calibre12"> Use the following general rules when deciding whether to create a function or a multimethod: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> If a function branches based on a type, or multiple types, consider a multimethod. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Types are whatever you discover them to be. They do not have to be explicit Java classes or data tags. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> You should be able to interpret the dispatch value of a <span class="calibre8"><span class="calibre39">defmethod</span></span> without having to refer to the <span class="calibre8"><span class="calibre39">defmulti</span></span>. </p></li><a></a><li value="4" class="calibre30"><p class="calibre29"> Do not use multimethods merely to handle optional arguments or recursion. </p></li><a></a></ul><p class="calibre12"> When in doubt, try writing the function in both styles, and pick the one that seems more readable. </p><div class="mbppagebreak"></div><p id="filepos1241035" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">8.6 Wrapping Up</span></span></span></p><p class="calibre34"> Multimethods support arbitrary dispatch. Usually multimethods work based on type relationships. Sometimes these types are formal, as in Java classes. Other times they are informal and ad hoc and emerge from the properties of objects in the system. </p><p class="calibre27"><span class="calibre8"><span class="bold"><span class="calibre28">Footnotes</span></span></span></p><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos1195026"><span class="calibre8">[59]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><span class="calibre8">Note that the example code for the book includes a completed version of this example, already on the classpath. To work through the example yourself, simply move or rename the completed example to get it out of the way.</span></p></td></tr><a id="filepos1241963"></a></table><p class="calibre18"><span class="calibre8"><span class="calibre19"><span class="calibre20">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="mbppagebreak"></div><p id="filepos1242160" class="calibre25"><span class="calibre2"><span class="bold"><span class="calibre43"> Chapter 9</span></span></span></p><br class="calibre11"/><p class="calibre26"><span class="calibre2"><span class="bold"><span class="calibre3">Java Down and Dirty</span></span></span></p><p class="calibre12"> Clojure’s Java support is both powerful and lean. It’s powerful, in that it brings the expressiveness of Lisp syntax, plus some syntactic sugar tailored to Java. It’s lean, in that it can get right to the metal. Clojure code compiles to bytecode and does not have to go through any special translation layer on the way to Java. </p><p class="calibre12"> Clojure embraces Java and its libraries. Idiomatic Clojure code calls Java libraries directly and does not try to wrap everything under the sun to look like Lisp. This surprises many new Clojure developers but is very pragmatic. Where Java isn’t broken, Clojure doesn’t fix it. </p><p class="calibre12"> In this chapter, you will see how Clojure access to Java is convenient, elegant, and fast: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Calling Java is simple and direct. Clojure provides syntax extensions for accessing anything you could reach from Java code: classes, instances, constructors, methods, and fields. Although you will typically call Java code directly, you can also wrap Java APIs and use them in a more functional style. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Clojure is <span class="italic">fast</span>, unlike many other dynamic languages on the JVM. You can use custom support for primitives and arrays, plus type hints, to cause Clojure’s compiler to generate the same code that a Java compiler would generate. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> Clojure’s exception handling is easy to use. Better yet, explicit exception handling is rarely necessary. Clojure’s exception primitives are the same as Java’s. However, Clojure does not require you to deal with checked exceptions and makes it easy to clean up resources using the <span class="calibre8"><span class="calibre39">with-open</span></span> idiom. </p></li><a></a></ul><div class="mbppagebreak"></div><p id="filepos1244409" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">9.1 Exception Handling</span></span></span></p><p class="calibre34">In Java code, exception handling crops up for three reasons:</p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Wrapping checked exceptions (see <a href="#filepos1245332">​<span class="italic">Checked Exceptions</span>​</a> if you are unfamiliar with checked exceptions) </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Using a <span class="calibre8"><span class="calibre39">finally</span></span> block to clean up nonmemory resources such as file and network handles </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> Responding to the problem: ignoring the exception, retrying the operation, converting the exception to a nonexceptional result, and so on </p></li><a></a></ul><blockquote id="filepos1245332" class="calibre47"><span class="calibre41"><span class="bold">Checked Exceptions</span></span></blockquote><blockquote class="calibre48"><span class="calibre41"> Java’s checked exceptions must be explicitly caught or rethrown from every method where they can occur. This seemed like a good idea at first: checked exceptions could use the type system to rigorously document error handling, with compiler enforcement. Most Java programmers now consider checked exceptions a failed experiment, because their costs in code bloat and maintainability outweigh their advantages. For more on the history of checked exceptions, see Rod Waldhoff’s article</span><a id="filepos1245991"></a><a href="#filepos1386379"><span class="calibre41">[60]</span></a><span class="calibre41"> and the accompanying links. </span></blockquote><p class="calibre50"> In Clojure, things are similar but simpler. The <span class="calibre8"><span class="calibre39">try</span></span> and <span class="calibre8"><span class="calibre39">throw</span></span> special forms give you all the capabilities of Java’s <span class="calibre8"><span class="calibre39">try</span></span>, <span class="calibre8"><span class="calibre39">catch</span></span>, <span class="calibre8"><span class="calibre39">finally</span></span>, and <span class="calibre8"><span class="calibre39">throw</span></span>. But you should not have to use them very often, for the following reasons: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">You do not have to deal with checked exceptions in Clojure.</p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> You can use macros such as <span class="calibre8"><span class="calibre39">with-open</span></span> to encapsulate resource cleanup.</p></li><a></a></ul><p class="calibre12">Let’s see what this looks like in practice.</p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Keeping Exception Handling Simple</span></span></span></p><p class="calibre44"> Java programs often wrap checked exceptions at abstraction boundaries. A good example is Apache Ant, which tends to wrap low-level exceptions (such as I/O exceptions) with an Ant-level build exception: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">// Ant-like code (simplified for clarity)</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="bold"><span class="calibre36">try</span></span></span><span class="calibre8"> {​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  newManifest = </span><span class="calibre8"><span class="bold"><span class="calibre36">new</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">Manifest</span></span></span><span class="calibre8">(r);​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​} </span><span class="calibre8"><span class="bold"><span class="calibre36">catch</span></span></span><span class="calibre8"> (IOException e) {​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="bold"><span class="calibre36">throw</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">new</span></span></span><span class="calibre8"> BuildException(...);​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> In Clojure, you are not forced to deal with checked exceptions. You do not have to catch them or declare that you throw them. So, the previous code would translate to the following: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(Manifest. r)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The absence of exception wrappers makes idiomatic Clojure code easier to read, write, and maintain than idiomatic Java. That said, nothing prevents you from explicitly catching, wrapping, and rethrowing exceptions in Clojure. It simply is not required. You <span class="italic">should</span> catch exceptions when you plan to respond to them in a meaningful way. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Cleaning Up Resources</span></span></span></p><p class="calibre44"> Garbage collection will clean up resources in memory. If you use resources that live outside of garbage-collected memory, such as file handles, you need to make sure that you clean them up, even in the event of an exception. In Java, this is normally handled in a <span class="calibre8"><span class="calibre39">finally</span></span> block. </p><p class="calibre12"> If the resource you need to free follows the convention of having a <span class="calibre8"><span class="calibre39">close</span></span> method, you can use Clojure’s <span class="calibre8"><span class="calibre39">with-open</span></span> macro: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">with-open</span></span></span><span class="calibre8"> [</span><span class="calibre8"><span class="bold"><span class="calibre36">name</span></span></span><span class="calibre8"> init-form] &amp; body)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Internally, <span class="calibre8"><span class="calibre39">with-open</span></span> creates a <span class="calibre8"><span class="calibre39">try</span></span> block, sets <span class="calibre8"><span class="calibre39">name</span></span> to the result of <span class="calibre8"><span class="calibre39">init-form</span></span>, and then runs the forms in <span class="calibre8"><span class="calibre39">body</span></span>. Most important, <span class="calibre8"><span class="calibre39">with-open</span></span> always closes the object bound to <span class="calibre8"><span class="calibre39">name</span></span> in a <span class="calibre8"><span class="calibre39">finally</span></span> block. </p><p class="calibre12"> A good example of <span class="calibre8"><span class="calibre39">with-open</span></span> is the <span class="calibre8"><span class="calibre39">spit</span></span> function in <span class="calibre8"><span class="calibre39">clojure.string</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(clojure.core/spit file content)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">spit</span></span> simply writes a string to file. Try it:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(spit "hello.out" "hello, world")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> You should now find a file at <span class="calibre8"><span class="calibre39">hello.out</span></span> with the contents <span class="calibre8"><span class="calibre39">hello, world</span></span>. </p><p class="calibre12">The implementation of <span class="calibre8"><span class="calibre39">spit</span></span> is simple:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; from clojure.core</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> spit​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="italic"><span class="calibre42">"Opposite of slurp.  Opens f with writer, writes content, then</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre42">  closes f. Options passed to clojure.java.io/writer."</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  {:added </span><span class="calibre8"><span class="italic"><span class="calibre42">"1.2"</span></span></span><span class="calibre8">}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  [f content &amp; options]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">with-open</span></span></span><span class="calibre8"> [^java.io.Writer w (</span><span class="calibre8"><span class="bold"><span class="calibre36">apply</span></span></span><span class="calibre8"> jio/writer f options)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">write w (</span><span class="calibre8"><span class="bold"><span class="calibre36">str</span></span></span><span class="calibre8"> content))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">spit</span></span> creates a <span class="calibre8"><span class="calibre39">PrintWriter</span></span> on <span class="calibre8"><span class="calibre39">f</span></span>, which can be just about anything that is writable: a file, a URL, a URI, or any of Java’s various writers or output streams. It then prints <span class="calibre8"><span class="calibre39">content</span></span> to the <span class="calibre8"><span class="calibre39">writer</span></span>. Finally, <span class="calibre8"><span class="calibre39">with-open</span></span> guarantees that the <span class="calibre8"><span class="calibre39">writer</span></span> is closed at the end of <span class="calibre8"><span class="calibre39">spit</span></span>. </p><p class="calibre12"> If you need to do something other than <span class="calibre8"><span class="calibre39">close</span></span> in a <span class="calibre8"><span class="calibre39">finally</span></span> block, the Clojure <span class="calibre8"><span class="calibre39">try</span></span> form looks like this: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">try</span></span></span><span class="calibre8"> expr* catch-clause* finally-clause?)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; catch-clause -&gt; (catch classname name expr*)</span></span></span><span class="calibre8">​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; finally-clause -&gt; (finally expr*)</span></span></span><span class="calibre8">​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38">It can be used thusly:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(try​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (throw (Exception. "something failed"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(finally​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (println "we get to clean up")))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| we get to clean up​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.lang.Exception: something failed​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The previous fragment also demonstrates Clojure’s <span class="calibre8"><span class="calibre39">throw</span></span> form, which simply throws whatever exception is passed to it. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Responding to an Exception</span></span></span></p><p class="calibre44"> The most interesting case is when an exception handler attempts to respond to the problem in a <span class="calibre8"><span class="calibre39">catch</span></span> block. As a simple example, consider writing a function to test whether a particular class is available at runtime: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/interop.clj"><span class="calibre41"><span class="underline">src/examples/interop.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre40">; not caller-friendly</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> class-available? [class-name]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (Class/forName class-name))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> This approach is not very caller-friendly. The caller simply wants a yes/no answer but instead gets an exception: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(class-available? "borg.util.Assimilate")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.lang.ClassNotFoundException: borg.util.Assimilate​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> A friendlier approach uses a <span class="calibre8"><span class="calibre39">catch</span></span> block to return <span class="calibre8"><span class="calibre39">false</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/src/examples/interop.clj"><span class="calibre41"><span class="underline">src/examples/interop.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> class-available? [class-name]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">try</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   (Class/forName class-name) true​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   (</span><span class="calibre8"><span class="bold"><span class="calibre36">catch</span></span></span><span class="calibre8"> ClassNotFoundException _ false)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">The caller experience is much better now:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(class-available? "borg.util.Assimilate")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; false​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(class-available? "java.lang.String")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Clojure gives you everything you need to throw and catch exceptions and to cleanly release resources. At the same time, Clojure keeps exceptions in their place. They are important but not so important that your mainline code is dominated by the exceptional. </p><p class="calibre12"> Clojure is designed to let you get things done and have fun while doing it. However, an important part of getting things done is being able to use your platform to its full potential. Throughout the rest of the book, we have looked at doing things the idiomatic Clojure way. In this chapter, we will do it Java style. </p><p class="calibre12"> To provide the full power of the Java platform, Clojure does several things: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Type hinting and inference, where needed, give the performance that people (incorrectly) associate with statically typed languages. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Ahead-of-time (AOT) compilation lets Clojure programs participate in the binary-artifact-centric Java ecosystem as an equal player. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> While <span class="calibre8"><span class="calibre39">reify</span></span>, <span class="calibre8"><span class="calibre39">defrecord</span></span>, and <span class="calibre8"><span class="calibre39">deftype</span></span> are preferable as flexible implementation tools, Clojure also provides interop forms that give you access to the ugly parts of Java interop. </p></li><a></a><li value="4" class="calibre30"><p class="calibre29"> Clojure (and Clojure Contrib) have a rapidly expanding set of “batteries included” libraries for common tasks. (But, you can always call the raw Java libraries if these libraries do not include something you need.) </p></li><a></a><li value="5" class="calibre30"><p class="calibre29"> If the techniques in this chapter seem ugly or unnecessary for the problem you are solving, that’s great! Run with it. But if you need to squeeze out that last bit of performance or play well with an ancient, ugly library, this chapter is for you. </p></li><a></a></ul><div class="mbppagebreak"></div><p id="filepos1265505" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">9.2 Wrestling with the Integers</span></span></span></p><p class="calibre34"> Clojure provides three different sets of operations for integer types: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">The unchecked operators</p></li><a></a><li value="2" class="calibre30"><p class="calibre29">The default operators</p></li><a></a><li value="3" class="calibre30"><p class="calibre29">The promoting operators</p></li><a></a></ul><p class="calibre12">The following table gives a sampling of these operator types. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><th valign="top" class="calibre51"><span class="bold">   </span><p class="calibre59"><span class="bold">Unchecked  </span></p></th><th valign="top" class="calibre51"><span class="bold">   </span><p class="calibre59"><span class="bold">Default  </span></p></th><th valign="top" class="calibre51"><span class="bold">   </span><p class="calibre59"><span class="bold">Promoting  </span></p></th></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">unchecked-add</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">+</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">+’</span></span>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">unchecked-subtract</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">-</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">-’</span></span>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">unchecked-multiply</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">*</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">*’</span></span>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">unchecked-inc</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">inc</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">inc’</span></span>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">unchecked-dec</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">dec</span></span>
</p></td><td valign="top" class="calibre23">   <p class="calibre59">   <span class="calibre8"><span class="calibre39">dec’</span></span>
</p></td></tr></table><p class="calibre27"> The unchecked operators correspond exactly with primitive math in Java. They are fast but terrifically dangerous in that they can overflow silently and give incorrect answers. In Clojure, the unchecked operators should be used only in the rare situation that overflow is the desired behavior or when performance is paramount and you are certain overflow is impossible or irrelevant. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(unchecked-add 9223372036854775807 1)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; -9223372036854775808​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The default operators use Java primitives where possible for performance but always make overflow checks and throw an exception. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(+ 9223372036854775807 1)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ArithmeticException integer overflow​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The promoting operators will automatically promote from primitives to big numbers on overflow. This makes it possible to handle an arbitrary range but at significant performance cost. Because primitives and big numbers share no common base type, math with the promoting operators precludes the use of primitives as return types. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(+' 9223372036854775807 1)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 9223372036854775808N​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Clojure relies on Java’s <span class="calibre8"><span class="calibre39">BigDecimal</span></span> class for arbitrary-precision decimal numbers. See the online documentation<a id="filepos1270995"></a><a href="#filepos1386752">[61]</a> for details. <span class="calibre8"><span class="calibre39">BigDecimal</span></span>s provide arbitrary precision but at a price: <span class="calibre8"><span class="calibre39">BigDecimal</span></span> math is significantly slower than Java’s floating-point primitives. </p><p class="calibre12"> Clojure has its own <span class="calibre8"><span class="calibre39">BigInt</span></span> class to handle <span class="calibre8"><span class="calibre39">BigInteger</span></span> conversions. Clojure’s <span class="calibre8"><span class="calibre39">BigInt</span></span> has some performance improvements over using Java’s <span class="calibre8"><span class="calibre39">BigInteger</span></span> directly. It also wraps some of the rough edges of <span class="calibre8"><span class="calibre39">BigInteger</span></span>. In particular, it properly implements <span class="calibre8"><span class="calibre39">hashCode</span></span>. This makes equality take precedence over representation, which you will see in almost every abstraction in the language. </p><p class="calibre12"> Under the hood, Clojure uses Java’s <span class="calibre8"><span class="calibre39">BigInteger</span></span>. The performance difference comes in how <span class="calibre8"><span class="calibre39">BigInt</span></span> treats its values. A <span class="calibre8"><span class="calibre39">BigInt</span></span> consists of a <span class="calibre8"><span class="calibre39">Long</span></span> part and a <span class="calibre8"><span class="calibre39">BigInteger</span></span> part. When the value passed into a <span class="calibre8"><span class="calibre39">BigInt</span></span> is small enough to be treated as a <span class="calibre8"><span class="calibre39">Long</span></span>, it is. When numerical operations are performed on <span class="calibre8"><span class="calibre39">BigInt</span></span>s, if their result is small enough to be treated as a <span class="calibre8"><span class="calibre39">Long</span></span>, it is. This gives the user the ability to add the overflow hint (N) without paying the <span class="calibre8"><span class="calibre39">BigInteger</span></span> cost until it is absolutely necessary. </p><div class="mbppagebreak"></div><p id="filepos1273018" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">9.3 Optimizing for Performance</span></span></span></p><p class="calibre34"> In Clojure, it is idiomatic to call Java using the techniques described in Section 2.5, <a href="#filepos281250">​<span class="italic">Calling Java</span>​</a>. The resulting code will be fast enough for 90 percent of scenarios. When you need to, though, you can make localized changes to boost performance. These changes will not change how outside callers invoke your code, so you are free to make your code work and then make it fast. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Using Primitives for Performance</span></span></span></p><p class="calibre44"> In the preceding sections, function parameters carry no type information. Clojure simply does the right thing. Depending on your perspective, this is either a strength or a weakness. It’s a strength, because your code is clean and simple and can take advantage of duck typing. But it’s also a weakness, because a reader of the code cannot be certain of datatypes and because doing the right thing carries some performance overhead. </p><p class="calibre12">Consider a function that calculates the sum of the numbers from 1 to n:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​; performance demo only, don't write code like this​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defn sum-to [n] (loop [i 1 sum 0]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (if (&lt;= i n) (recur (inc i) (+ i sum)) sum)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">You can verify that this function works with a small input value:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(sum-to 10)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​=&gt;  55​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Let’s see how <span class="calibre8"><span class="calibre39">sum-to</span></span> performs. To time an operation, you can use the time function. When benchmarking, you’ll tend to want to take several measurements so that you can eliminate start-up overhead plus any outliers; therefore, you can call time from inside a <span class="calibre8"><span class="calibre39">dotimes</span></span> macro: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">dotimes</span></span></span><span class="calibre8"> bindings &amp; body)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">dotimes</span></span> will execute its body repeatedly, with the name bound to integers from zero to n-1. Using <span class="calibre8"><span class="calibre39">dotimes</span></span>, you can collect five timings of <span class="calibre8"><span class="calibre39">sum-to</span></span> as follows: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(dotimes [_ 5] (time (sum-to 10000)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|  "Elapsed time: 0.149 msecs"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|  "Elapsed time: 0.126 msecs"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|  "Elapsed time: 0.194 msecs"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|  "Elapsed time: 0.279 msecs"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Elapsed time: 0.212 msecs"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> To speed things up, you can hint the argument and return type as long. Clojure’s type inference will flow this hint to all the internal operations and function calls inside the function. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> ^</span><span class="calibre8"><span class="bold"><span class="calibre36">long</span></span></span><span class="calibre8"> integer-sum-to [^</span><span class="calibre8"><span class="bold"><span class="calibre36">long</span></span></span><span class="calibre8"> n]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">loop</span></span></span><span class="calibre8"> [i 1 sum 0]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">&lt;</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> i n)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">recur</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">inc</span></span></span><span class="calibre8"> i) (</span><span class="calibre8"><span class="bold"><span class="calibre36">+</span></span></span><span class="calibre8"> i sum))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      sum)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">integer-sum-to</span></span> is indeed faster:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(dotimes [_ 5] (time (integer-sum-to 10000)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|  "Elapsed time: 0.044 msecs"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|  "Elapsed time: 0.023 msecs"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|  "Elapsed time: 0.025 msecs"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|  "Elapsed time: 0.023 msecs"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Elapsed time: 0.02 msecs"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Clojure’s primitive math is still correct, in that it will check for overflow and throw an exception. Is that as fast as things can get? Java programmers have access to super-fast busted math: arithmetic operations that have the maximum possible performance but can silently overflow and corrupt data. </p><p class="calibre12"> Clojure provides access to Java’s arithmetic semantics through the unchecked family of functions. Maybe you can get an even faster function by using the unchecked version of <span class="calibre8"><span class="calibre39">+</span></span>, <span class="calibre8"><span class="calibre39">unchecked-add</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> ^</span><span class="calibre8"><span class="bold"><span class="calibre36">long</span></span></span><span class="calibre8"> unchecked-sum-to [^</span><span class="calibre8"><span class="bold"><span class="calibre36">long</span></span></span><span class="calibre8"> n]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">loop</span></span></span><span class="calibre8"> [i 1 sum 0]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">&lt;</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> i n)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">recur</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">inc</span></span></span><span class="calibre8"> i) (</span><span class="calibre8"><span class="bold"><span class="calibre36">unchecked-add</span></span></span><span class="calibre8"> i sum))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      sum)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">unchecked-sum-to</span></span> is not significantly faster:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(dotimes [_ 5] (time (unchecked-sum-to 10000)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|  "Elapsed time: 0.039 msecs"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|  "Elapsed time: 0.018 msecs"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|  "Elapsed time: 0.014 msecs"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|  "Elapsed time: 0.015 msecs"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Elapsed time: 0.015 msecs"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Orders of magnitude are important! Primitive hinting can make certain operations significantly faster. However, switching to Java’s unchecked semantics is generally a losing proposition. You get a trivial performance gain on average, with the possibility of data corruption tomorrow. </p><p class="calibre12">So, why does Clojure provide these operations at all? Two reasons:</p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Sometimes you actually want Java semantics. The primary use case for the unchecked operations is when you need to interoperate with other libraries that expect this behavior. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Without trying them, nobody would know (or believe) that they weren’t faster. </p></li><a></a></ul><p class="calibre12"> Prefer accuracy first and then optimize for speed only where necessary. <span class="calibre8"><span class="calibre39">integer-sum-to</span></span> will throw an exception on overflow. This is bad, but the problem is easily detected: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(integer-sum-to 10000000000)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.lang.ArithmeticException: integer overflow​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">unchecked-sum-to</span></span> will fail silently on overflow. In a program setting, it can quietly but catastrophically corrupt data: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(unchecked-sum-to 10000000000)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; -5340232216128654848 ; WRONG!!​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Given the competing concerns of correctness and performance, you should normally prefer simple, undecorated code such as the original <span class="calibre8"><span class="calibre39">sum-to</span></span>. If profiling identifies a bottleneck, you can force Clojure to use a primitive type in just the places that need it. </p><p class="calibre12"> The <span class="calibre8"><span class="calibre39">sum-to</span></span> example is deliberately simple in order to demonstrate the various options for integer math in Clojure. In a real Clojure program, it would be more expressive to implement <span class="calibre8"><span class="calibre39">sum-to</span></span> using <span class="calibre8"><span class="calibre39">reduce</span></span>. Summing a sequence is the same as summing the first two items, adding that result to the next item, and so on. That is exactly the loop that <span class="calibre8"><span class="calibre39">(reduce + ...)</span></span> provides. With <span class="calibre8"><span class="calibre39">reduce</span></span>, you can rewrite <span class="calibre8"><span class="calibre39">sum-to</span></span> as a one-liner: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> better-sum-to [n]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">reduce</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">+</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">range</span></span></span><span class="calibre8"> 1 (</span><span class="calibre8"><span class="bold"><span class="calibre36">inc</span></span></span><span class="calibre8"> n))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The example also demonstrates an even more general point: pick the right algorithm to begin with. The sum of numbers from 1 to n can be calculated directly as follows: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> best-sum-to [n]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">/</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">*</span></span></span><span class="calibre8"> n (</span><span class="calibre8"><span class="bold"><span class="calibre36">inc</span></span></span><span class="calibre8"> n)) 2))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Even without performance hints, this is faster than implementations based on repeated addition: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(dotimes [_ 5] (time (best-sum-to 10000)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|  "Elapsed time: 0.029 msecs"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|  "Elapsed time: 0.0040 msecs"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|  "Elapsed time: 0.0040 msecs"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|  "Elapsed time: 0.0040 msecs"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Elapsed time: 0.0030 msecs"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Performance is a tricky subject. Don’t write ugly code in search of speed. Start by choosing appropriate algorithms and getting your code to work correctly. If you have performance issues, profile to identify the problems. Then, introduce only as much complexity as you need to solve those problems. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Adding Type Hints</span></span></span></p><p class="calibre44"> Clojure supports adding type hints to function parameters, let bindings, variable names, and expressions. These type hints serve three purposes: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">Optimizing critical performance paths</p></li><a></a><li value="2" class="calibre30"><p class="calibre29">Documenting the required type</p></li><a></a><li value="3" class="calibre30"><p class="calibre29">Enforcing the required type at runtime</p></li><a></a></ul><p class="calibre12"> For example, consider the following function, which returns information about a Java class: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defn describe-class [c]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  {:name (.getName c)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   :final (java.lang.reflect.Modifier/isFinal (.getModifiers c))})​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> You can ask Clojure how much type information it can infer, by setting the special variable <span class="calibre8"><span class="calibre39">*warn-on-reflection*</span></span> to <span class="calibre8"><span class="calibre39">true</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(set! *warn-on-reflection* true)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The exclamation point on the end of <span class="calibre8"><span class="calibre39">set!</span></span> is an idiomatic indication that <span class="calibre8"><span class="calibre39">set!</span></span> changes mutable state. <span class="calibre8"><span class="calibre39">set!</span></span> is described in detail in <a href="#filepos788693">​<span class="italic">Working with Java Callback APIs</span>​</a>. With <span class="calibre8"><span class="calibre39">*warn-on-reflection*</span></span> set to <span class="calibre8"><span class="calibre39">true</span></span>, compiling <span class="calibre8"><span class="calibre39">describe-class</span></span> will produce the following warnings: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​Reflection warning, line: 87​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​- reference to field getName can't be resolved.​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​Reflection warning, line: 88​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​- reference to field getModifiers can't be resolved.​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> These warnings indicate that Clojure has no way of knowing the type of <span class="calibre8"><span class="calibre39">c</span></span>. You can provide a type hint to fix this, using the metadata syntax <span class="calibre8"><span class="calibre39">∧Class</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> describe-class [^</span><span class="calibre8"><span class="bold"><span class="calibre36">Class</span></span></span><span class="calibre8"> c]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  {:name (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getName c)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   :final (java.lang.reflect.Modifier/isFinal (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getModifiers c))})​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> With the type hint in place, the reflection warnings will disappear. The compiled Clojure code will be exactly the same as compiled Java code. Further, attempts to call <span class="calibre8"><span class="calibre39">describe-class</span></span> with something other than a <span class="calibre8"><span class="calibre39">Class</span></span> will fail with a <span class="calibre8"><span class="calibre39">ClassCastException</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(describe-class StringBuffer)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  {:name "java.lang.StringBuffer", :final true}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(describe-class "foo")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.lang.ClassCastException: \​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   java.lang.String cannot be cast to java.lang.Class​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If your <span class="calibre8"><span class="calibre39">ClassCastException</span></span> provides a less helpful error message, it is because you are using a version of Java prior to Java 6. Improved error reporting is one of many good reasons to run your Clojure code on Java 6 or newer. </p><p class="calibre12"> When you provide a type hint, Clojure will insert an appropriate class cast in order to avoid making slow, reflective calls to Java methods. But if your function does not actually call any Java methods on a hinted object, then Clojure will not insert a cast. Consider this <span class="calibre8"><span class="calibre39">wants-a-string</span></span> function: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defn wants-a-string [^String s] (println s))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/wants-a-string​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> You might expect that <span class="calibre8"><span class="calibre39">wants-a-string</span></span> would complain about nonstring arguments. In fact, it will be perfectly happy: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(wants-a-string "foo")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; foo​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(wants-a-string 0)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 0​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Clojure can tell that <span class="calibre8"><span class="calibre39">wants-a-string</span></span> never actually uses its argument as a string (<span class="calibre8"><span class="calibre39">println</span></span> will happily try to print any kind of argument). Since no string methods need to be called, Clojure does not attempt to cast <span class="calibre8"><span class="calibre39">s</span></span> to a string. </p><p class="calibre12"> When you need speed, type hints will let Clojure code compile down to the same code Java will produce. But you won’t need type hints that often. Make your code right first, and then worry about making it fast. </p><div class="mbppagebreak"></div><p id="filepos1300752" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">9.4 Creating Java Classes in Clojure</span></span></span></p><p class="calibre34"> Clojure’s objects all implement reasonable Java interfaces:</p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">Clojure’s data structures implement interfaces from the Java Collections API.</p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Clojure’s functions implement <span class="calibre8"><span class="calibre39">Runnable</span></span> and <span class="calibre8"><span class="calibre39">Callable</span></span>.</p></li><a></a></ul><p class="calibre12"> In addition to these generic interfaces, you will occasionally need domain-specific interfaces. Often this comes in the form of callback handlers for event-driven APIs such as Swing or some XML parsers. Clojure can easily generate one-off proxies or classes on disk when needed, using a fraction of the lines of code necessary in Java. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Creating Java Proxies</span></span></span></p><p class="calibre44"> To interoperate with Java, you will often need to implement Java interfaces. A good example is parsing XML with a Simple API for XML (SAX) parser. To get ready for this example, go ahead and import the following classes. We’ll need them all before we are done: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">import</span></span></span><span class="calibre8"> '(org.xml.sax InputSource)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        '(org.xml.sax.helpers DefaultHandler)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        '(java.io StringReader)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        '(javax.xml.parsers SAXParserFactory))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> To use a SAX parser, you need to implement a callback mechanism. The easiest way is often to extend the <span class="calibre8"><span class="calibre39">DefaultHandler</span></span> class. In Clojure, you can extend a class with the <span class="calibre8"><span class="calibre39">proxy</span></span> function: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">proxy</span></span></span><span class="calibre8"> class-and-interfaces super-cons-args &amp; fns)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> As a simple example, use <span class="calibre8"><span class="calibre39">proxy</span></span> to create a <span class="calibre8"><span class="calibre39">DefaultHandler</span></span> that prints the details of all calls to <span class="calibre8"><span class="calibre39">startElement</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> print-element-handler​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">proxy</span></span></span><span class="calibre8"> [DefaultHandler] []​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (startElement [uri local qname atts]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">println</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">format</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"Saw element: %s"</span></span></span><span class="calibre8"> qname)))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">proxy</span></span> generates an instance of a proxy class. The first argument to <span class="calibre8"><span class="calibre39">proxy</span></span> is <span class="calibre8"><span class="calibre39">[DefaultHandler]</span></span>, a vector of the superclass and superinterfaces. The second argument, <span class="calibre8"><span class="calibre39">[]</span></span>, is a vector of arguments to the base class constructor. In this case, no arguments are needed. </p><p class="calibre12"> After the proxy setup comes the implementation code for zero or more proxy methods. The proxy shown earlier has one method. Its name is <span class="calibre8"><span class="calibre39">startElement</span></span>, and it takes four arguments and prints the name of the <span class="calibre8"><span class="calibre39">qname</span></span> argument. </p><p class="calibre12"> Now all you need is a parser to pass the handler to. This requires plowing through a pile of Java factory methods and constructors. For a simple exploration at the REPL, you can create a function that parses XML in a string: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> demo-sax-parse [source handler]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">..</span></span></span><span class="calibre8"> SAXParserFactory newInstance newSAXParser​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (parse (InputSource. (StringReader. source)) handler)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Now the parse is easy:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(demo-sax-parse "&lt;foo&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  &lt;bar&gt;Body of bar&lt;/bar&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  &lt;/foo&gt;" print-element-handler)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  | Saw element: foo​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  | Saw element: bar​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The previous example demonstrates the mechanics of creating a Clojure proxy to deal with Java’s XML interfaces. You can take a similar approach to implementing your own custom Java interfaces. But if all you are doing is XML processing, the <span class="calibre8"><span class="calibre39">clojure.data.xml</span></span> library already has terrific XML support and can work with any SAX-compatible Java parser. </p><p class="calibre12"> The proxy mechanism is completely general and can be used to generate any kind of Java object you want, on the fly. Sometimes the objects are so simple you can fit the entire object in a single line. The following code creates a new thread and then creates a new dynamic subclass of <span class="calibre8"><span class="calibre39">Runnable</span></span> to run on the new thread: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">start (Thread.​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">proxy</span></span></span><span class="calibre8"> [Runnable] [] (run [] (</span><span class="calibre8"><span class="bold"><span class="calibre36">println</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"I ran!"</span></span></span><span class="calibre8">)))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> In Java, you must provide an implementation of every method on every interface you implement. In Clojure, you can leave them out: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">proxy</span></span></span><span class="calibre8"> [Callable] []) </span><span class="calibre8"><span class="italic"><span class="calibre40">; proxy with no methods (??)</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If you omit a method implementation, Clojure provides a default implementation that throws an <span class="calibre8"><span class="calibre39">UnsupportedOperationException</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(.call (proxy [Callable] []))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; java.lang.UnsupportedOperationException: call​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The default implementation does not make much sense for interfaces with only one method, such as <span class="calibre8"><span class="calibre39">Runnable</span></span> and <span class="calibre8"><span class="calibre39">Callable</span></span>, but it can be handy when you are implementing larger interfaces and don’t care about some of the methods. </p><p class="calibre12"> So far in this section, you have seen how to use <span class="calibre8"><span class="calibre39">proxy</span></span> to create implementations of Java interfaces. This is very powerful when you need it, but often Clojure is already there on your behalf. For example, functions automatically implement <span class="calibre8"><span class="calibre39">Runnable</span></span> and <span class="calibre8"><span class="calibre39">Callable</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​; normal usage: call an anonymous function​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(#(println "foo"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​foo​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​; call through Runnable's run​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(.run #(println "foo"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​foo​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​; call through Callable's call​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(.call #(println "foo"))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​foo​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">This makes it very easy to pass Clojure functions to other threads:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">dotimes</span></span></span><span class="calibre8"> [i 5]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">start​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (Thread.​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">fn</span></span></span><span class="calibre8"> []​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        (Thread/sleep (</span><span class="calibre8"><span class="bold"><span class="calibre36">rand</span></span></span><span class="calibre8"> 500))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        (</span><span class="calibre8"><span class="bold"><span class="calibre36">println</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">format</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"Finished %d on %s"</span></span></span><span class="calibre8"> i (Thread/currentThread)))))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> For one-off tasks such as XML and thread callbacks, Clojure’s proxies are quick and easy to use. If you need a longer-lived class, you can generate new named classes from Clojure as well. </p><p id="filepos1315515" class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Using Java Collections</span></span></span></p><p class="calibre44"> Clojure’s collections supplant the Java collections for most purposes. Clojure’s collections are concurrency-safe, have good performance characteristics, and implement the appropriate Java collection interfaces. So, you should generally prefer Clojure’s own collections when you are working in Clojure and even pass them back into Java when convenient. </p><p class="calibre12"> If you do choose to use the Java collections, nothing in Clojure will stop you. From Clojure’s perspective, the Java collections are classes like any other, and all the various Java interop forms will work. But the Java collections are designed for lock-based concurrency. They will not provide the concurrency guarantees that Clojure collections do and will not work well with Clojure’s software transactional memory. </p><p class="calibre12"> One place where you will need to deal with Java collections is the special case of Java arrays. In Java, arrays have their own syntax and their own bytecode instructions. Java arrays do not implement any Java interface. Clojure collections cannot masquerade as arrays. (Java collections can’t either!) The Java platform makes arrays a special case in every way, so Clojure does too. </p><p class="calibre12"> Clojure provides <span class="calibre8"><span class="calibre39">make-array</span></span> to create Java arrays:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">make-array</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">class</span></span></span><span class="calibre8"> length)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">make-array</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">class</span></span></span><span class="calibre8"> dim &amp; more-dims)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">make-array</span></span> takes a class and a variable number of array dimensions. For a one-dimensional array of strings, you might say this: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(make-array String 5)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #&lt;String[] [Ljava.lang.String;@45a270b2&gt;​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The odd output is courtesy of Java’s implementation of <span class="calibre8"><span class="calibre39">toString()</span></span> for arrays: <span class="calibre8"><span class="calibre39">[Ljava.lang.String;</span></span> is the JVM specification’s encoding for “one-dimensional array of strings.” That’s not very useful at the REPL, so you can use Clojure’s seq to wrap any Java array as a Clojure sequence so that the REPL can print the individual array entries: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(seq (make-array String 5))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (nil nil nil nil nil)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Clojure also includes a family of functions with names such as <span class="calibre8"><span class="calibre39">int-array</span></span> for creating arrays of Java primitives. You can issue the following command at the REPL to review the documentation for these and other array functions: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre35"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">find-doc</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"-array"</span></span></span><span class="calibre8">)​</span><span class="calibre8"><span class="calibre37">
</span></span>
</td></tr></table><p class="calibre38"> Clojure provides a set of low-level operations on Java arrays, including <span class="calibre8"><span class="calibre39">aset</span></span>, <span class="calibre8"><span class="calibre39">aget</span></span>, and <span class="calibre8"><span class="calibre39">alength</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">aset</span></span></span><span class="calibre8"> java-array index value)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">aset</span></span></span><span class="calibre8"> java-array index-dim1 index-dim2 </span><span class="calibre8"><span class="bold"><span class="calibre36">..</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"> value)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">aget</span></span></span><span class="calibre8"> java-array index)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">aget</span></span></span><span class="calibre8"> java-array index-dim1 index-dim2 </span><span class="calibre8"><span class="bold"><span class="calibre36">..</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">alength</span></span></span><span class="calibre8"> java-array)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Use <span class="calibre8"><span class="calibre39">make-array</span></span> to create an array, and then experiment with using <span class="calibre8"><span class="calibre39">aset</span></span>, <span class="calibre8"><span class="calibre39">aget</span></span>, and <span class="calibre8"><span class="calibre39">alength</span></span> to work with the array: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defn painstakingly-create-array []​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (let [arr (make-array String 5)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (aset arr 0 "Painstaking")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (aset arr 1 "to")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (aset arr2 "fill")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (aset arr 3" in")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (aset arr 4 "arrays")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    arr))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(aget (paintakingly-create-array) 0)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Painstaking"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(alength (painstakingly-create-array))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 5​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Most of the time, you will find it simpler to use higher-level functions such as <span class="calibre8"><span class="calibre39">to-array</span></span>, which creates an array directly from any collection: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">to-array</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">sequence</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">to-array</span></span> always creates an <span class="calibre8"><span class="calibre39">Object</span></span> array:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(to-array ["Easier" "array" "creation"])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #&lt;Object[] [Ljava.lang.Object;@1639f9e3&gt;​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">to-array</span></span> is also useful for calling Java methods that take a variable argument list, such as <span class="calibre8"><span class="calibre39">String/format</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​; example. prefer clojure.core/format (String/format "Training Week: %s Mileage: %d"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(String/format "Training Week: %s Mileage: %d"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​               (to-array [2 26]))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; "Training Week: 2 Mileage: 26"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">to-array</span></span>’s cousin <span class="calibre8"><span class="calibre39">into-array</span></span> can create an array with a more specific type than <span class="calibre8"><span class="calibre39">Object</span></span>. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(into-array type? seq)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> You can pass an explicit type as an optional first argument to <span class="calibre8"><span class="calibre39">into-array</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(into-array String ["Easier", "array", "creation"])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #&lt;String[] [Ljava.lang.String;@391ecf28&gt;​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If you omit the type argument, <span class="calibre8"><span class="calibre39">into-array</span></span> will guess the type based on the first item in the sequence: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(into-array ["Easier" "array" "creation"])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #&lt;String[] [Ljava.lang.String;@76bfd849&gt;​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> As you can see, the array contains <span class="calibre8"><span class="calibre39">String</span></span>s, not <span class="calibre8"><span class="calibre39">Object</span></span>s. If you want to transform every element of a Java array without converting to a Clojure sequence, you can use <span class="calibre8"><span class="calibre39">amap</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">amap</span></span></span><span class="calibre8"> a idx ret expr)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">amap</span></span> will create a clone of the array <span class="calibre8"><span class="calibre39">a</span></span>, binding that clone to the name you specify in <span class="calibre8"><span class="calibre39">ret</span></span>. It will then execute <span class="calibre8"><span class="calibre39">expr</span></span> once for each element in <span class="calibre8"><span class="calibre39">a</span></span>, with <span class="calibre8"><span class="calibre39">idx</span></span> bound to the index of the element. Finally, <span class="calibre8"><span class="calibre39">amap</span></span> returns the cloned array. You could use <span class="calibre8"><span class="calibre39">amap</span></span> to uppercase every string in an array of strings: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def strings (into-array ["some" "strings" "here"]))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; #'user/strings​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(seq (amap strings idx _ (.toUpperCase (aget strings idx))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ("SOME" "STRINGS" "HERE")​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">ret</span></span> parameter is set to <span class="calibre8"><span class="calibre39">_</span></span> to indicate that it is not needed in the map expression, and the wrapping seq is simply for convenience in printing the result at the REPL. Similar to <span class="calibre8"><span class="calibre39">amap</span></span> is <span class="calibre8"><span class="calibre39">areduce</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">areduce</span></span></span><span class="calibre8"> a idx ret init expr)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Where <span class="calibre8"><span class="calibre39">amap</span></span> produces a new array, <span class="calibre8"><span class="calibre39">areduce</span></span> produces anything you want. The <span class="calibre8"><span class="calibre39">ret</span></span> is initially set to <span class="calibre8"><span class="calibre39">init</span></span> and later set to the return value of each subsequent invocation of <span class="calibre8"><span class="calibre39">expr</span></span>. <span class="calibre8"><span class="calibre39">areduce</span></span> is normally used to write functions that “tally up” a collection in some way. For example, the following call finds the length of the longest string in the <span class="calibre8"><span class="calibre39">strings</span></span> array: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(areduce strings idx ret 0 (max ret (.length (aget strings idx))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 7​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"><span class="calibre8"><span class="calibre39">amap</span></span> and <span class="calibre8"><span class="calibre39">areduce</span></span> are special-purpose macros for interoperating with Java arrays. </p><div class="mbppagebreak"></div><p id="filepos1333384" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">9.5 A Real-World Example</span></span></span></p><p class="calibre34"> While it’s great to talk about the different interop cases and learn how to eke out some additional performance using Java’s primitive forms, you still need to have some practical, hands-on knowledge. In this example, we will be building an application to test the availability of websites. The goal here is to check to see whether the website returns an <span class="calibre8"><span class="calibre39">HTTP 200 OK</span></span> response. If anything other than our expected response is received, it should be marked as unavailable. </p><p class="calibre12"> Again, we will use the Leiningen build tool. Refer to Section 1.2, <a href="#filepos94711">​<span class="italic">Clojure Coding Quick Start</span>​</a> if you don’t have Leiningen installed already. Let’s start by creating a new project: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​lein new pinger​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Open your <span class="calibre8"><span class="calibre39">project.clj</span></span> file and modify the contents to match what we are going to be working on. Be sure to update Clojure to the latest version: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defproject pinger </span><span class="calibre8"><span class="italic"><span class="calibre42">"0.0.1-SNAPSHOT"</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  :description </span><span class="calibre8"><span class="italic"><span class="calibre42">"A website availability tester"</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  :dependencies [[org.clojure/clojure 1.3</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">0]])​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Grab the dependencies by running <span class="calibre8"><span class="calibre39">lein deps</span></span>:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​lein deps​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> First we need to write the code that connects to a URL and captures the response code. We can accomplish this by using Java’s <span class="calibre8"><span class="calibre39">URL</span></span> class. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">ns</span></span></span><span class="calibre8"> pinger.core​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:import (java.net URL HttpURLConnection)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> response-code [address]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [conn ^HttpURLConnection (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">openConnection (URL. address))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        code (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getResponseCode conn)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">when</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">&lt;</span></span></span><span class="calibre8"> code 400)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">-&gt;</span></span></span><span class="calibre8"> conn </span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">getInputStream </span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">close))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    code))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Give it a try in the REPL:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(response-code "http://google.com")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 200​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now let’s create a function that uses <span class="calibre8"><span class="calibre39">response-code</span></span> and decides whether the specified URL is available. We will define <span class="calibre8"><span class="calibre39">available</span></span> in our context as returning an <span class="calibre8"><span class="calibre39">HTTP 200</span></span> response code. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defn available? [address]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (= 200 (response-code address)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(available? "http://google.com")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(available? "http://google.com/badurl")​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; false​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Next we need a way to start our program and have it check a list of URLs that we care about every so often and report their availability. Let’s create a <span class="calibre8"><span class="calibre39">-main</span></span> function. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> -main []​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [addresses '(</span><span class="calibre8"><span class="italic"><span class="calibre42">"http://google.com"</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                    </span><span class="calibre8"><span class="italic"><span class="calibre42">"http://amazon.com"</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                    </span><span class="calibre8"><span class="italic"><span class="calibre42">"http://google.com/badurl"</span></span></span><span class="calibre8">)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">while</span></span></span><span class="calibre8"> true​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">doseq</span></span></span><span class="calibre8"> [address addresses]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        (</span><span class="calibre8"><span class="bold"><span class="calibre36">println</span></span></span><span class="calibre8"> (available? address)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (Thread/sleep (</span><span class="calibre8"><span class="bold"><span class="calibre36">*</span></span></span><span class="calibre8"> 1000 60)))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> In this example, we create a list of addresses (two good and one bad) and use a simple <span class="calibre8"><span class="calibre39">while</span></span> loop that never exits to obtain a never-ending program execution. It will continue to check these URLs once a minute until the program is terminated. Since we are exporting a <span class="calibre8"><span class="calibre39">-main</span></span> function, don’t forget to add <span class="calibre8"><span class="calibre39">:gen-class</span></span> to your namespace declaration. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">ns</span></span></span><span class="calibre8"> pinger.core​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:import (java.net URL))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:gen-class))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now that we have the fundamentals in place, we need to tell Leningen where our main function is located. Open <span class="calibre8"><span class="calibre39">project.clj</span></span> and add the <span class="calibre8"><span class="calibre39">:main</span></span> declaration: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defproject pinger </span><span class="calibre8"><span class="italic"><span class="calibre42">"0.0.1-SNAPSHOT"</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  :description </span><span class="calibre8"><span class="italic"><span class="calibre42">"A website availability tester"</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  :dependencies [[org.clojure/clojure </span><span class="calibre8"><span class="italic"><span class="calibre42">"1.3.0"</span></span></span><span class="calibre8">]]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  :main pinger.core)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> It’s time to compile our program into a JAR file and run it. To do this, run the following: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​lein uberjar​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​java -jar pinger-0.0.1-SNAPSHOT-standalone.jar​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​true​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​false​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​true​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> You should see your program start and continue to run until you press <span class="calibre8"><span class="calibre39">Ctrl-C</span></span> to stop it. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Adding Real Continuous Loop Behavior</span></span></span></p><p class="calibre44"> A <span class="calibre8"><span class="calibre39">while</span></span> loop that is always true will continue to run until terminated, but it’s not really the cleanest way to obtain the result because it doesn’t allow for a clean shutdown. We can use a scheduled thread pool that will start and execute the desired command in a similar fashion as the <span class="calibre8"><span class="calibre39">while</span></span> loop but with a much greater level of control. Create a file in the <span class="calibre8"><span class="calibre39">src</span></span> directory called <span class="calibre8"><span class="calibre39">scheduler.clj</span></span> and enter the following code: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">ns</span></span></span><span class="calibre8"> pinger.scheduler​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:import (java.util.concurrent ThreadPoolExecutor​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            ScheduledThreadPoolExecutor TimeUnit)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> scheduled-executor​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="italic"><span class="calibre42">"Create a scheduled executor."</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  ^ScheduledThreadPoolExecutor [threads]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (ScheduledThreadPoolExecutor. threads))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> periodically​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="italic"><span class="calibre42">"Schedules function f to run on executor e every 'delay'</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre42">   milliseconds after a delay of 'initial-delay' Returns</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre42">   a ScheduledFuture."</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  ^ScheduledFuture [e f &amp; {:keys [initial-delay </span><span class="calibre8"><span class="bold"><span class="calibre36">delay</span></span></span><span class="calibre8">]}]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">scheduleWithFixedDelay​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   e f​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   initial-delay </span><span class="calibre8"><span class="bold"><span class="calibre36">delay</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   TimeUnit/MILLISECONDS))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> shutdown-executor​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="italic"><span class="calibre42">"Shutdown an executor."</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  [^ThreadPoolExecutor e]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">shutdown e))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> This namespace provides functions to create and shut down a Java <span class="calibre8"><span class="calibre39">ScheduledExecutor</span></span>. It also defines a function called <span class="calibre8"><span class="calibre39">periodically</span></span> that will accept an executor, a function, an <span class="calibre8"><span class="calibre39">initial-delay</span></span>, and a <span class="calibre8"><span class="calibre39">repeated delay</span></span>. It will execute the function for the first time after the initial delay and then continue to execute the function with the delay specified thereafter. This will continue to run until the thread pool is shut down. </p><p class="calibre12"> Let’s update <span class="calibre8"><span class="calibre39">pinger.core</span></span> to take advantage of the scheduling code as well as make the <span class="calibre8"><span class="calibre39">-main</span></span> function responsible only for calling a function that starts the loop. Replace the old <span class="calibre8"><span class="calibre39">-main</span></span> with the following functions: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> check []​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [addresses '(</span><span class="calibre8"><span class="italic"><span class="calibre42">"http://google.com"</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                    </span><span class="calibre8"><span class="italic"><span class="calibre42">"http://google.com/404"</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                    </span><span class="calibre8"><span class="italic"><span class="calibre42">"http://amazon.com"</span></span></span><span class="calibre8">)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">doseq</span></span></span><span class="calibre8"> [address addresses]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">println</span></span></span><span class="calibre8"> (available? address)))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> immediately 0)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">def</span></span></span><span class="calibre8"> every-minute (</span><span class="calibre8"><span class="bold"><span class="calibre36">*</span></span></span><span class="calibre8"> 60 1000))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> start [e]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="italic"><span class="calibre42">"REPL helper. Start pinger on executor e."</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (scheduler/periodically e check​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                          :initial-delay immediately​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                          :delay every-minute))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> stop [e]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="italic"><span class="calibre42">"REPL helper. Stop executor e."</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (scheduler/shutdown-executor e))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> -main []​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (start (scheduler/scheduled-executor 1)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Make sure to update your namespace declaration to include the scheduler code: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">ns</span></span></span><span class="calibre8"> pinger.core​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:import (java.net URL))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:require [pinger.scheduler :as scheduler])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:gen-class))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Not everything in the previous sample is necessary, but it makes for more readable code. Adding the start and stop functions makes it easy to work interactively from the REPL, which will be a huge advantage should you choose to extend this example. Give everything one last check by running <span class="calibre8"><span class="calibre39">lein uberjar</span></span> and executing the JAR file. The program should function exactly as it did before. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Logging</span></span></span></p><p class="calibre44"> So far, we have produced a program capable of periodically checking the availability of a list of websites. However, it lacks the ability to keep track of what it has done and to notify us when a site is unavailable. We can solve both of these issues with logging. There are a lot of logging options for Java applications, but for this example we will use <span class="calibre8"><span class="calibre39">log4j</span></span>. It gives us a real logger to use, and it gives us an email notification. This is great because we will have the ability to send email alerts when a website isn’t available. To do this, we will need to pull the <span class="calibre8"><span class="calibre39">log4j</span></span> and <span class="calibre8"><span class="calibre39">mail</span></span> libraries into our application. To make it easier to take advantage of <span class="calibre8"><span class="calibre39">log4j</span></span>, we will also pull in <span class="calibre8"><span class="calibre39">clojure.tools.logging</span></span>. Open your <span class="calibre8"><span class="calibre39">project.clj</span></span> file and add <span class="calibre8"><span class="calibre39">clojure.tools.logging</span></span>, <span class="calibre8"><span class="calibre39">log4j</span></span>, and <span class="calibre8"><span class="calibre39">mail</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defproject pinger </span><span class="calibre8"><span class="italic"><span class="calibre42">"0.0.1-SNAPSHOT"</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  :description </span><span class="calibre8"><span class="italic"><span class="calibre42">"A website availability tester</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre42">  :dependencies [[org.clojure/clojure "</span></span></span><span class="calibre8">1.3</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">0</span><span class="calibre8"><span class="italic"><span class="calibre42">"]</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre42">                 [org.clojure/tools.logging "</span></span></span><span class="calibre8">0.2</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">3</span><span class="calibre8"><span class="italic"><span class="calibre42">"]</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre42">                 [log4j "</span></span></span><span class="calibre8">1.2</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">16</span><span class="calibre8"><span class="italic"><span class="calibre42">"]</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre42">                 [javax.mail/mail "</span></span></span><span class="calibre8">1.4</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">1</span><span class="calibre8"><span class="italic"><span class="calibre42">"]]</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre42">  :main pinger.core)</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Also pull the dependencies in with Leiningen:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​lein deps​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The great part about the Clojure logging library is that it will use any standard Java logging library that is on the classpath, so there is no additional wiring required between <span class="calibre8"><span class="calibre39">log4j</span></span> and your application. Create a folder in the root of your project called <span class="calibre8"><span class="calibre39">resources</span></span>. Leiningen automatically adds the contents of this folder to the classpath, and you will need that for your <span class="calibre8"><span class="calibre39">log4j</span></span> properties file. Create a file under the <span class="calibre8"><span class="calibre39">resources</span></span> directory named <span class="calibre8"><span class="calibre39">log4j.properties</span></span> and add the following contents: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​log4j.rootLogger=info, R, email​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​log4j.appender.R=org.apache.log4j.RollingFileAppender​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​log4j.appender.R.File=logs/pinger.log​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​log4j.appender.R.MaxFileSize=1000KB​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​log4j.appender.R.MaxBackupIndex=1​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​log4j.appender.R.layout=org.apache.log4j.PatternLayout​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​log4j.appender.R.layout.ConversionPattern=%d{ISO8601} %-5p [%c] - %m%n​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​log4j.appender.email=org.apache.log4j.net.SMTPAppender​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​log4j.appender.email.SMTPHost=localhost​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​log4j.appender.email.From=system@yourapp.com​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​log4j.appender.email.To=recipient@yourapp.com​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​log4j.appender.email.Subject=[Pinger Notification] - Website Down​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​log4j.appender.email.threshold=error​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​log4j.appender.email.layout=org.apache.log4j.PatternLayout​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​log4j.appender.email.layout.conversionPattern=%d{ISO8601} %-5p [%c] - %m%n​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> This sets up standard logging to <span class="calibre8"><span class="calibre39">pinger.log</span></span> and will send an email notification for anything logged to the <span class="calibre8"><span class="calibre39">error</span></span> log level, which in our case is when a website doesn’t respond with an <span class="calibre8"><span class="calibre39">HTTP 200</span></span> response or when an exception is thrown while checking the site. Make sure to change the email information to something that works in your environment. </p><p class="calibre12"> Let’s update the code and add logging. The goal here is to replace any <span class="calibre8"><span class="calibre39">println</span></span> statements with log messages. Open <span class="calibre8"><span class="calibre39">core.clj</span></span>, add the <span class="calibre8"><span class="calibre39">info</span></span> and <span class="calibre8"><span class="calibre39">error</span></span> functions from <span class="calibre8"><span class="calibre39">clojure.tools.logging</span></span> into your namespace declaration, and create a function to record the results. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">ns</span></span></span><span class="calibre8"> pinger.core​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:import (java.net URL))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:require [pinger.scheduler :as scheduler]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            [clojure.tools.logging :as logger])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:gen-class))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="bold"><span class="calibre36">..</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> record-availability [address]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (available? address)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (logger/info (</span><span class="calibre8"><span class="bold"><span class="calibre36">str</span></span></span><span class="calibre8"> address </span><span class="calibre8"><span class="italic"><span class="calibre42">" is responding normally"</span></span></span><span class="calibre8">))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (logger/error (</span><span class="calibre8"><span class="bold"><span class="calibre36">str</span></span></span><span class="calibre8"> address </span><span class="calibre8"><span class="italic"><span class="calibre42">" is not available"</span></span></span><span class="calibre8">))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38">Also update <span class="calibre8"><span class="calibre39">check</span></span> to reflect the changes:</p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> check []​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [addresses '(</span><span class="calibre8"><span class="italic"><span class="calibre42">"http://google.com"</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                    </span><span class="calibre8"><span class="italic"><span class="calibre42">"http://google.com/404"</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                    </span><span class="calibre8"><span class="italic"><span class="calibre42">"http://amazon.com"</span></span></span><span class="calibre8">)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">doseq</span></span></span><span class="calibre8"> [address addresses]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (record-availability address))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Rebuild to try your program again. You should notice a newly created <span class="calibre8"><span class="calibre39">logs</span></span> directory that you can check for program execution. You should also notice an email come in with an error message. If you get a “connection refused” error on port 25, you will need to set up a mail transport agent on your machine to enable mail sending. You now have a way to notify people of a website failure! </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Configuration</span></span></span></p><p class="calibre44"> We have hard-coded our list of websites to monitor, and that simply won’t work! We need a way to give a list of sites to monitor from some external source. We could use a properties file, database, or web service to accomplish this. For ease of explanation, we will go with a properties file. Create a file named <span class="calibre8"><span class="calibre39">pinger.properties</span></span> in the root directory of the application and add the following to it: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​urls=http://google.com,http://amazon.com,http://google.com/badurl​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> We need a way to load this file and create a collection of sites to feed into the <span class="calibre8"><span class="calibre39">check</span></span> function. Create a file named <span class="calibre8"><span class="calibre39">config.clj</span></span> in the <span class="calibre8"><span class="calibre39">src</span></span> directory: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">ns</span></span></span><span class="calibre8"> pinger.config​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:use [clojure.java.io :only (reader resource)])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:require [clojure.string :as </span><span class="calibre8"><span class="bold"><span class="calibre36">str</span></span></span><span class="calibre8">])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:import (java.util Properties)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> load-properties [src]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">with-open</span></span></span><span class="calibre8"> [rdr (reader src)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">doto</span></span></span><span class="calibre8"> (Properties.)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">load</span></span></span><span class="calibre8"> rdr))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> config​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  []​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (load-properties (resource </span><span class="calibre8"><span class="italic"><span class="calibre42">"pinger.properties"</span></span></span><span class="calibre8">)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> As long as <span class="calibre8"><span class="calibre39">pinger.properties</span></span> is on the classpath, the <span class="calibre8"><span class="calibre39">config</span></span> function will read <span class="calibre8"><span class="calibre39">pinger.properties</span></span> into a Java properties object. All we have left to do is get the <span class="calibre8"><span class="calibre39">urls</span></span> attribute and put it into a list. Add the following function into the config namespace: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> urls [conf]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (str/split (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">get</span></span></span><span class="calibre8"> conf </span><span class="calibre8"><span class="italic"><span class="calibre42">"urls"</span></span></span><span class="calibre8">) #","))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Finally, update the <span class="calibre8"><span class="calibre39">check</span></span> function in <span class="calibre8"><span class="calibre39">core.clj</span></span> to use the new configuration function. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">ns</span></span></span><span class="calibre8"> pinger.core​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:import (java.net URL))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:require [pinger.scheduler :as scheduler]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            [clojure.tools.logging :as logger]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            [pinger.config :as config])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:gen-class))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="bold"><span class="calibre36">..</span></span></span><span class="calibre8"><br class="calibre11"/></span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> check []​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">doseq</span></span></span><span class="calibre8"> [address (config/urls (config/config))]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (record-availability address)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Rebuild your application with Leiningen and try it. Remember to put the root directory on the classpath so that the application can find <span class="calibre8"><span class="calibre39">pinger.properties</span></span>. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​java -cp .:pinger-0.0.1-standalone.jar pinger.core​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> We now have what we need to succeed. In this example, we covered the following: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Using Java’s <span class="calibre8"><span class="calibre39">URL</span></span> to check a website to see whether it was available </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Using Java’s <span class="calibre8"><span class="calibre39">ScheduledTheadPoolExecutor</span></span> to create a periodically running task </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> Using <span class="calibre8"><span class="calibre39">log4j</span></span> with <span class="calibre8"><span class="calibre39">clojure.tools.logging</span></span> to send error notifications </p></li><a></a><li value="4" class="calibre30"><p class="calibre29"> Using Java’s property system for configuration </p></li><a></a><li value="5" class="calibre30"><p class="calibre29"> Using Leiningen to create stand-alone executable JAR files </p></li><a></a></ul><p class="calibre12"> We could do quite a few things to expand this example. We could redefine what it means for a website to be available by adding requirements for certain HTML elements to be present or for the response to return in a certain time to cover an SLA. Try adding to this example and see what you can come up with. </p><div class="mbppagebreak"></div><p id="filepos1385428" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">9.6 Wrapping Up</span></span></span></p><p class="calibre34"> We just covered a good chunk of how Clojure and Java get along. We even mixed the two up in some interesting ways. Since we have started to experiment with things outside of the Clojure language, it is probably a good time to start talking about different libraries you can use to build real-world Clojure applications. We will do just that in the next chapter. </p><p class="calibre27"><span class="calibre8"><span class="bold"><span class="calibre28">Footnotes</span></span></span></p><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos1245991"><span class="calibre8">[60]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://tinyurl.com/checked-exceptions-mistake"><span class="calibre8">http://tinyurl.com/checked-exceptions-mistake</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos1386379"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos1270995"><span class="calibre8">[61]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://docs.oracle.com/javase/6/docs/api/java/math/BigDecimal.html"><span class="calibre8">http://docs.oracle.com/javase/6/docs/api/java/math/BigDecimal.html</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos1386752"></a></table><p class="calibre18"><span class="calibre8"><span class="calibre19"><span class="calibre20">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="mbppagebreak"></div><p id="filepos1386949" class="calibre25"><span class="calibre2"><span class="bold"><span class="calibre43"> Chapter 10</span></span></span></p><br class="calibre11"/><p class="calibre26"><span class="calibre2"><span class="bold"><span class="calibre3">Building an Application</span></span></span></p><p class="calibre12"> Now that you have learned the basics of the Clojure language, it is time for you to begin using Clojure in your own projects. But when you run out the door to start work on your killer Clojure app, you quickly discover that language knowledge is only part of what you need to work effectively in an ecosystem. You have questions like these: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">What tools do I use to organize projects and dependencies?</p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> What is a good workflow for writing code?</p></li><a></a><li value="3" class="calibre30"><p class="calibre29">How do I make sure that my code is correct?</p></li><a></a><li value="4" class="calibre30"><p class="calibre29">How do I keep code flexible and maintainable?</p></li><a></a><li value="5" class="calibre30"><p class="calibre29">What libraries do I need?</p></li><a></a><li value="6" class="calibre30"><p class="calibre29">How do I put Clojure on the Web?</p></li><a></a></ul><p class="calibre12"> There will never be a single, one-size-fits-all answer to these questions. Clojure runs on the JVM, a huge ecosystem where hundreds of approaches have flourished. But you have to start somewhere. In this chapter, we will give you temporary answers to these questions. These answers have worked well for us, and you can use them for a short while. As your own preferences and sensibilities evolve, you can adapt or abandon the approaches in this chapter in favor of approaches that work best for you. </p><p class="calibre12"> As our sample application, we will implement a web version of the Clojurebreaker game. In Clojurebreaker, a code-maker (the program) creates a secret code of N-ordered colored pegs. A code-breaker (the human player) then submits a guess. The code-maker scores the guess as follows: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> One black peg for each peg of the right color in the right position </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> One white peg for each peg of the right color but not in the right position </p></li><a></a></ul><p class="calibre12"> The game ends with a correct guess or after reaching some predetermined limit on the number of guesses. </p><p class="calibre12"> While we will show you all the code as we go, this chapter is not really about code. It is about a style of attacking problems and about the details of delivering solutions within the Clojure ecosystem. Let’s get started. </p><div class="mbppagebreak"></div><p id="filepos1389971" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">10.1 Scoring a Clojurebreaker Game</span></span></span></p><p class="calibre34"> As a Clojure programmer, one question you will often ask is, “Where do I need state to solve this problem?” Or, better yet, “How much of this problem can I solve <span class="italic">without</span> using any state?” </p><p class="calibre12"> With Clojurebreaker (and with many other games), the game logic itself is a pure function. It takes a secret and a guess and returns a score. Identifying this fact early gives us two related advantages: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">The score function will be trivial to write and test in isolation.</p></li><a></a><li value="2" class="calibre30"><p class="calibre29">We can comfortably proceed to implement <span class="calibre8"><span class="calibre39">score</span></span> without even thinking about how the rest of the system will work.</p></li><a></a></ul><p class="calibre12"> Scoring itself divides into two parts: tallying the exact matches and tallying the matches that are out of order. Each of these parts can be its own function. Let’s start with the exact matches. To make things concrete, we will pick a representation for the pegs that facilitates trying things at the REPL: the four colors <span class="calibre8"><span class="calibre39">:r</span></span> (red), <span class="calibre8"><span class="calibre39">:g</span></span> (green), <span class="calibre8"><span class="calibre39">:b</span></span> (blue), and <span class="calibre8"><span class="calibre39">:y</span></span> (yellow). The function will return the count of exact matches, which we can turn into black pegs in a separate step later. Here is the shell of the function we think we need: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/clojurebreaker/snippets.clj"><span class="calibre41"><span class="underline">clojurebreaker/snippets.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> exact-matches​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="italic"><span class="calibre42">"Given two collections, return the number of positions where</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre42">   the collections contain equal items."</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  [c1 c2])​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Hold the phone—that doc string doesn’t say anything about games or colors or keywords. What is going on here? While some callers (e.g., the game) will eventually care about the representation of the game state, <span class="calibre8"><span class="calibre39">exact-matches</span></span> doesn’t need to care. So, let’s keep it generic. A key component of responsible Clojure design is to think in data, rather than pouring object concrete at every opportunity. </p><p class="calibre12"> When described as a generic function of data, <span class="calibre8"><span class="calibre39">exact-matches</span></span> sounds like a function that might already exist. After searching through the relevant namespaces (<span class="calibre8"><span class="calibre39">clojure.core</span></span> and <span class="calibre8"><span class="calibre39">clojure.data</span></span>), we discover that the closest thing to <span class="calibre8"><span class="calibre39">exact-matches</span></span> is <span class="calibre8"><span class="calibre39">clojure.data</span></span>’s <span class="calibre8"><span class="calibre39">diff</span></span>. <span class="calibre8"><span class="calibre39">diff</span></span> recursively compares two data structures, returning a three-tuple of things-in-a, things-in-b, and things-in-both. The things-in-both is nothing other than the exact matches we are looking for. Try it at the REPL: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(require '[clojure.data :as data])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(data/diff [:r :g :g :b] [:r :y :y :b])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; [[nil :g :g] [nil :y :y] [:r nil nil :b]]​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The non-<span class="calibre8"><span class="calibre39">nil</span></span> entries in <span class="calibre8"><span class="calibre39">[:r nil nil :b]</span></span> are the exact matches when comparing r/g/g/b and r/y/y/b. With <span class="calibre8"><span class="calibre39">diff</span></span> in hand, the implementation of <span class="calibre8"><span class="calibre39">exact-matches</span></span> is trivial: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/clojurebreaker/src/clojurebreaker/game.clj"><span class="calibre41"><span class="underline">clojurebreaker/src/clojurebreaker/game.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> exact-matches​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="italic"><span class="calibre42">"Given two collections, return the number of positions where</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre42">   the collections contain equal items."</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  [c1 c2]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [[_ _ matches] (data/diff c1 c2)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">count</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">remove</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">nil?</span></span></span><span class="calibre8"> matches))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Again, we test at the REPL against an example input: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(exact-matches [:r :g :g :b] [:r :y :y :b])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​2​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now let’s turn our attention to the unordered matches. To calculate these, we need to know how many of each colored peg are in the secret and in the guess. This sounds like a job for the <span class="calibre8"><span class="calibre39">frequencies</span></span> function: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def example-secret [:r :g :g :b])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(frequencies example-secret)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:r 1, :g 2, :b 1}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def example-guess [:y :y :y :g])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(frequencies example-guess)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:y 3, :g 1}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> To turn those two frequencies into the <span class="calibre8"><span class="calibre39">unordered-matches</span></span>, we need to do two additional things: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">Consider only the keys that are present in both the secret and the guess</p></li><a></a><li value="2" class="calibre30"><p class="calibre29">Count only the overlap (i.e., the minimum of the vals under each key)</p></li><a></a></ul><p class="calibre12"> Again, we hope these operations already exist, and happily they do. You can keep the keys you need with <span class="calibre8"><span class="calibre39">select-keys</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(select-keys (frequencies example-secret) example-guess)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:g 2}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(select-keys (frequencies example-guess) example-secret)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:g 1}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> And you can count the overlap between two frequency maps using <span class="calibre8"><span class="calibre39">merge-with</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(merge-with min {:g 1} {:g 2})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:g 1}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Combining <span class="calibre8"><span class="calibre39">frequencies</span></span> and <span class="calibre8"><span class="calibre39">select-keys</span></span> and <span class="calibre8"><span class="calibre39">merge-with</span></span> gives the following definition for <span class="calibre8"><span class="calibre39">unordered-matches</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/clojurebreaker/src/clojurebreaker/game.clj"><span class="calibre41"><span class="underline">clojurebreaker/src/clojurebreaker/game.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> unordered-matches​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="italic"><span class="calibre42">"Given two collections, return a map where each key is an item</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre42">   in both collections, and each value is the number of times the</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre42">   value occurs in the collection with fewest occurrences."</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  [c1 c2]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [f1 (</span><span class="calibre8"><span class="bold"><span class="calibre36">select-keys</span></span></span><span class="calibre8"> (frequencies c1) c2)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        f2 (</span><span class="calibre8"><span class="bold"><span class="calibre36">select-keys</span></span></span><span class="calibre8"> (frequencies c2) c1)]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">merge-with</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">min</span></span></span><span class="calibre8"> f1 f2)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> which, of course, we should verify at the REPL: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(unordered-matches [:r :g :g :b] [:y :y :y :g])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:g 1}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> That’s nice, with one subtlety. <span class="calibre8"><span class="calibre39">unordered-matches</span></span> counts matches <span class="italic">regardless</span> of order, while the game will want to know only the matches that are <span class="italic">not</span> in the right order. Even though the game doesn’t seem to need <span class="calibre8"><span class="calibre39">unordered-matches</span></span>, writing it was a win because of the following: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"><span class="calibre8"><span class="calibre39">unordered-matches</span></span> does exactly one thing. To write a <span class="calibre8"><span class="calibre39">not-ordered</span></span> match, we would have to reimplement <span class="calibre8"><span class="calibre39">exact-matches</span></span> inside <span class="calibre8"><span class="calibre39">unordered-matches</span></span>.</p></li><a></a><li value="2" class="calibre30"><p class="calibre29">The two simple functions we just wrote are exactly the functions we need to compose together to get the not-ordered semantics. Just subtract the results of <span class="calibre8"><span class="calibre39">exact-matches</span></span> from the results of <span class="calibre8"><span class="calibre39">unordered-matches</span></span>.</p></li><a></a></ul><p class="calibre12"> With the two primitives in place, the <span class="calibre8"><span class="calibre39">score</span></span> operation simply compounds them: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/clojurebreaker/src/clojurebreaker/game.clj"><span class="calibre41"><span class="underline">clojurebreaker/src/clojurebreaker/game.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> score​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  [c1 c2]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [exact (exact-matches c1 c2)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        unordered (</span><span class="calibre8"><span class="bold"><span class="calibre36">apply</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="bold"><span class="calibre36">+</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">vals</span></span></span><span class="calibre8"> (unordered-matches c1 c2)))]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    {:exact exact :unordered (</span><span class="calibre8"><span class="bold"><span class="calibre36">-</span></span></span><span class="calibre8"> unordered exact)}))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> And the REPL rejoices: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(score [:r :g :g :b] [:r :y :y :g])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {:exact 1, :unordered 1}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> At this point, we have demonstrated a partial answer to the question, “What is a good workflow for writing code?” In summary: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Break apart the problem to identify pure functions. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Learn the standard library so you can find functions already written. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29">Pour no concrete (use data as data).</p></li><a></a><li value="4" class="calibre30"><p class="calibre29">Test inside out from the REPL.</p></li><a></a></ul><p class="calibre12"> In our experience, programmers trying this workflow for the first time make two typical mistakes: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">Coding too much</p></li><a></a><li value="2" class="calibre30"><p class="calibre29">Complicating the tests</p></li><a></a></ul><p class="calibre12"> You have written too much code whenever you don’t understand the behavior of a form, but you haven’t yet tested and understood all of its subforms. Many developers have an intuition of “write X lines of code and then test,” where X is the smallest number of lines that can do something substantial. In Clojure, X is significantly smaller than one, which is why we emphasize building functions inside out at the REPL. </p><p class="calibre12"> “Complicating the tests” is more subtle, and we will take it up in the next section. </p><div class="mbppagebreak"></div><p id="filepos1411011" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">10.2 Testing the Scorer</span></span></span></p><p class="calibre34"> In the previous section, we developed the <span class="calibre8"><span class="calibre39">score</span></span> function iteratively at the REPL and saw it work correctly with a few example inputs. It doesn’t take much commitment to quality to want to do more validation than that! Let’s begin by teasing apart some of the things that people mean when they say “testing.” Testing includes the following: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">Thinking through whether the code is correct</p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Stepping through the code in a development environment where you can see everything that is happening </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> Crafting inputs to cover the various code paths</p></li><a></a><li value="4" class="calibre30"><p class="calibre29"> Crafting outputs to match the crafted inputs</p></li><a></a><li value="5" class="calibre30"><p class="calibre29">Running the code with various inputs</p></li><a></a><li value="6" class="calibre30"><p class="calibre29"> Validating the results for correctness</p></li><a></a><li value="7" class="calibre30"><p class="calibre29">Automating the validation of results</p></li><a></a><li value="8" class="calibre30"><p class="calibre29"> Organizing tests so that they can be automatically run for regression purposes in the future </p></li><a></a></ul><p class="calibre12"> This is hardly an exhaustive list, but it suffices to make the point of this section. In short, testing is often complex, but it can be simple. </p><p class="calibre12"> Traditional unit-testing approaches complect many of the testing tasks listed earlier. For example, input, output, execution, and validation tend to be woven together inside individual test methods. On the other hand, the minimal REPL testing we did before simply isn’t enough. Can we get the benefit of some of the previous ideas of testing, without the complexity of unit testing? Let’s try. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Crafting Inputs</span></span></span></p><p class="calibre44"> We have already seen the <span class="calibre8"><span class="calibre39">score</span></span> function work for a few handcrafted inputs. How many inputs do we need to convince ourselves the function is correct? In a perfect world, we would just test all the inputs, but that is almost always computationally infeasible. But we are lucky in that the problem of scoring the game is essentially the same for variants with a different number of colors or a different number of pegs. Given that, we actually can generate <span class="italic">all</span> possible inputs for a small version of the game. </p><p class="calibre12"> The branch of math that deals with the different ways of forming patterns is called <span class="italic">enumerative combinatorics</span>. It turns out that the Clojure library <span class="calibre8"><span class="calibre39">math.combinatorics</span></span> has the functions we need to generate all possible inputs. Add the following form under the <span class="calibre8"><span class="calibre39">:dependencies</span></span> key in your <span class="calibre8"><span class="calibre39">project.clj</span></span> file, if it is not already present: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​[org.clojure/math.combinatorics "0.0.1"]​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">selections</span></span> function takes two arguments (a collection and a size), and it returns every structure of that size made up of elements from that collection. Try it for a tiny version of Clojurebreaker with only three colors and two columns: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(require '[clojure.math.combinatorics :as comb])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(comb/selections [:r :g :b] 2)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ((:r :r) (:r :g) (:r :b)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (:g :r) (:g :g) (:g :b)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (:b :r) (:b :g) (:b :b))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> So, <span class="calibre8"><span class="calibre39">selections</span></span> can give us a possible secret or a possible guess. What about generating inputs to the <span class="calibre8"><span class="calibre39">score</span></span> function? Well, that is just selecting two selections from the selections: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(-&gt; (comb/selections [:r :g :b] 2)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (comb/selections 2))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​ -&gt; (81 pairs of game positions omitted for brevity)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Let’s put that into a named function: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/clojurebreaker/src/clojurebreaker/game.clj"><span class="calibre41"><span class="underline">clojurebreaker/src/clojurebreaker/game.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> generate-turn-inputs​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="italic"><span class="calibre42">"Generate all possible turn inputs for a clojurebreaker game</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre42">   with colors and n columns"</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  [colors n]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">-&gt;</span></span></span><span class="calibre8"> (comb/selections colors n)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (comb/selections 2)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> All right, inputs generated. We are going to skip thinking about outputs (for reasons that will become obvious in a moment) and turn our attention to running the scorer with our generated inputs. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Running a Test</span></span></span></p><p class="calibre44"> We are going to write a function that takes a sequence of inputs and reports a sequence of inputs and the result of calling <span class="calibre8"><span class="calibre39">score</span></span>. We don’t want to commit (yet) to how the results of this test run will be validated. Maybe a human will read it. Maybe a validator program will process the results. Either way, a good representation of each result might be a map with the keys <span class="calibre8"><span class="calibre39">secret</span></span>, <span class="calibre8"><span class="calibre39">guess</span></span>, and <span class="calibre8"><span class="calibre39">score</span></span>. </p><p class="calibre12"> All this function needs to do is call <span class="calibre8"><span class="calibre39">score</span></span> and build the collection of responses: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/clojurebreaker/src/clojurebreaker/game.clj"><span class="calibre41"><span class="underline">clojurebreaker/src/clojurebreaker/game.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> score-inputs​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="italic"><span class="calibre42">"Given a sequence of turn inputs, return a lazy sequence of</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre42">   maps with :secret, :guess, and :score."</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  [inputs]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">map</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   (</span><span class="calibre8"><span class="bold"><span class="calibre36">fn</span></span></span><span class="calibre8"> [[secret guess]]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     {:secret (</span><span class="calibre8"><span class="bold"><span class="calibre36">seq</span></span></span><span class="calibre8"> secret)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      :guess (</span><span class="calibre8"><span class="bold"><span class="calibre36">seq</span></span></span><span class="calibre8"> guess)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      :score (score secret guess)})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   inputs))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Try it at the REPL: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(-&gt;&gt; (generate-turn-inputs [:r :g :b] 2)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     (score-inputs))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ({:secret (:r :r), :guess (:r :r),​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     :score {:exact 2, :unordered 0}}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    {:secret (:r :r), :guess (:r :g),​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     :score {:exact 1, :unordered 0}}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   ;; remainder omitted for brevity​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If a human is going to be reading the test report, you might decide to format a text table instead, using <span class="calibre8"><span class="calibre39">score</span></span> <span class="calibre8"><span class="calibre39">print-table</span></span>. While we are at it, let’s generate a bigger game (four colors by four columns) and print the table to a file: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (use 'clojure.pprint)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (require '[clojure.java.io :as io])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (with-open [w (io/writer "scoring-table")]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (binding [*out* w]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (print-table (-&gt;&gt; (generate-turn-inputs [:r :g :b :y] 4)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                        (score-inputs)))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If you look at the <span class="calibre8"><span class="calibre39">scoring-table</span></span> file, you should see 65,536 different secret/guess combinations and their scores. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Validating Outputs</span></span></span></p><p class="calibre44"> At this point, it is obvious why we skipped crafting the outputs. The program has done that for us. We just have to decide how much effort to spend validating them. Here are some approaches we might take: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Have a human code-breaker expert read the entire output table for a small variant of the game. This has the advantage of being exhaustive but might miss logic errors that show up only in a larger game. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Pick a selection of results at random from a larger game and have a human expert verify that. </p></li><a></a></ul><p class="calibre12"> Because the validation step is separated from generating inputs and running the program, we can design and write the various steps independently, possibly at separate times. </p><p class="calibre12"> Moreover, the validator knows nothing about how the inputs were generated. With unit tests, the inputs and outputs come from the same programmer’s brain at about the same time. If that programmer is systematically mistaken about something, the tests simply encode mistakes as truth. This is not possible when the outputs to validate are chosen exhaustively or randomly. </p><p class="calibre12"> We will return to programmatic validation later, but first let’s turn to regression testing. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Regression Testing</span></span></span></p><p class="calibre44"> How would you like to have a regression suite that is more thorough than the validation effort you have made? No problem. </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Write a program whose results should not change. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Run the program once, saving the results to a (well-named!) file. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> Run the program again every time the program changes, comparing with the saved file. If anything is different, the program is broken. </p></li><a></a></ul><p class="calibre12"> The nice thing about this regression approach is that it works even if you never did <span class="italic">any</span> validation of results. Of course, you should still do validation, because it will help you narrow down where a problem happened. (With no validation, the regression error might just be telling you that the old code was broken and the new code fixed it.) </p><p class="calibre12"> How hard is it write a program that should produce exactly the same output? Call only pure functions from the program, which is exactly what our <span class="calibre8"><span class="calibre39">score-inputs</span></span> function does. </p><p class="calibre12"> Wiring this kind of regression test into a continuous integration build is not difficult. If you do it, think about contributing it to whatever testing framework you use. </p><p class="calibre12"> Now we have partially answered the question, “How do I make sure that my code is correct?” In summary: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Build with small, composable pieces (most should be pure functions). </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Test forms from the inside out at the REPL.</p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> When writing test code, keep input generation, execution, and output validation as separate steps. </p></li><a></a></ul><p class="calibre12"> This last idea is so important that it deserves some library support. So, before we move on, we are going to introduce <span class="calibre8"><span class="calibre39">test.generative</span></span>, a library that aspires to bring simplicity to testing. </p><div class="mbppagebreak"></div><p id="filepos1430311" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">10.3 test.generative</span></span></span></p><p class="calibre34"> The <span class="calibre8"><span class="calibre39">test.generative</span></span> library divides testing into three key steps: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">Generating test inputs</p></li><a></a><li value="2" class="calibre30"><p class="calibre29">Invoking test functions</p></li><a></a><li value="3" class="calibre30"><p class="calibre29">Validating results</p></li><a></a></ul><p class="calibre12"> Each of these three steps is implemented via functions, which are then composed into tests via the <span class="calibre8"><span class="calibre39">defspec</span></span> form. </p><p class="calibre12"> Let’s install <span class="calibre8"><span class="calibre39">test.generative</span></span> and take it for a spin. Add the following line to your <span class="calibre8"><span class="calibre39">project.clj</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​[org.clojure/test.generative "0.1.3"]​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now execute whatever steps you use to reload project code and meet us at the REPL to generate some test data. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Generating Data</span></span></span></p><p class="calibre44"> From the REPL, require the <span class="calibre8"><span class="calibre39">generators</span></span> namespace as follows: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(require '[clojure.test.generative.generators :as gen])​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">generators</span></span> namespace contains functions to generate pseudorandom values for different common datatypes. For example, for every Java primitive, there is a generator function with the same name. Try a few of them: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(gen/int)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 977378563​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(gen/char)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; \A​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(gen/boolean)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Note that your results will likely not be identical to those shown earlier, since the point of these values is to be random. </p><p class="calibre12"> You can also generate random values for different Clojure collection types. These functions are parameterized by the type of collection to make. For example: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(gen/vec gen/boolean)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; [false false true true true false]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(gen/hash-map gen/byte gen/int)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; {32 -504310803, 100 424501842, 5 1439482147, 37 1161641068}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> In addition to the basic types, you can use several knobs to control how the types are generated. You can choose a probability distribution: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(gen/geometric 0.02)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; 10​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> And you can control how collections are sized, with either a constant or a distribution: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(gen/list gen/int 2)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (-1029960512 1985289448)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(gen/list gen/int (gen/uniform 0 5))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; (315829211)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> There are several other goodies, but we won’t spoil all the fun of discovery. Do a <span class="calibre8"><span class="calibre39">dir</span></span> of the namespace, and familiarize yourself with the other standard generators that are available. </p><p class="calibre12"> To test the Clojurebreaker scorer, we will want a function that generates a random secret (or guess). Sticking with the keyword representation for peg colors, such a function could be as follows: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/clojurebreaker/test/clojurebreaker/game_test.clj"><span class="calibre41"><span class="underline">clojurebreaker/test/clojurebreaker/game_test.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> random-secret​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  []​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (gen/vec #(gen/one-of :r :g :b :y) 4))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Don’t forget to try <span class="calibre8"><span class="calibre39">random-secret</span></span> at the REPL before moving on to think about validation. </p><p id="filepos1438322" class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Programmatic Validation</span></span></span></p><p class="calibre44"> Programmatic validation should be more than just a hand-coded spot-check of specific values. Such spot-checks are a poor use of time when we can easily review a set of outputs for validity and then save them as a regression test. Instead, programmatic validators should enforce logical invariants about the input and output data. </p><p class="calibre12"> Here are some invariant properties of the Clojurebreaker scoring function: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> Scoring is symmetric. If you invert the secret and guess arguments, the score should be the same. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> The sum of the exact and unordered matches must be greater than or equal to zero and less than or equal to the number of pegs. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> If you scramble the order of pegs in a guess, the sum of exact and unordered matches in the score will not change. </p></li><a></a></ul><p class="calibre12"> Let’s encode each of these invariants as a boolean function of <span class="calibre8"><span class="calibre39">secret</span></span>, <span class="calibre8"><span class="calibre39">guess</span></span>, and <span class="calibre8"><span class="calibre39">score</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/clojurebreaker/test/clojurebreaker/game_test.clj"><span class="calibre41"><span class="underline">clojurebreaker/test/clojurebreaker/game_test.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">ns</span></span></span><span class="calibre8"> clojurebreaker.game-test​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:use [clojure.test.generative :only (defspec) :as </span><span class="calibre8"><span class="bold"><span class="calibre36">test</span></span></span><span class="calibre8">])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (:require [clojure.test.generative.generators :as gen]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            [clojurebreaker.game :as game]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            [clojure.math.combinatorics :as comb]))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> matches​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="italic"><span class="calibre42">"Given a score, returns total number of exact plus</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre42">   unordered matches."</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  [score]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">+</span></span></span><span class="calibre8"> (:exact score) (:unordered score)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> scoring-is-symmetric​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  [secret guess score]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> score (game/score guess secret)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> scoring-is-bounded-by-number-of-pegs​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  [secret guess score]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">&lt;</span></span></span><span class="calibre8"> 0 (matches score) (</span><span class="calibre8"><span class="bold"><span class="calibre36">count</span></span></span><span class="calibre8"> secret)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> reordering-the-guess-does-not-change-matches​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  [secret guess score]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> #{(matches score)}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     (</span><span class="calibre8"><span class="bold"><span class="calibre36">into</span></span></span><span class="calibre8"> #{} (</span><span class="calibre8"><span class="bold"><span class="calibre36">map</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                #(matches (game/score secret %))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                (comb/permutations guess)))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> While we often type code at the REPL and then paste it into the appropriate file, we went the other way with the invariant functions earlier, adding them to the source file first. But this doesn’t mean we have to lose the immediacy of the REPL. From the REPL, we can reload the namespace and then move into the namespace with <span class="calibre8"><span class="calibre39">in-ns</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(require :reload 'clojurebreaker.game-test)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(in-ns 'clojurebreaker.game-test)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now that we are in the namespace we want to use, we have access to all of its public names and aliases. This makes it convenient to handcraft some sample data as a quick sanity check for the validation functions: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def secret [:r :g :g :b])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(def guess [:r :b :b :y])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(scoring-is-symmetric secret guess​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (game/score secret guess))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(scoring-is-bound-by-number-of-pegs​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  secret guess (game/score secret guess))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(reordering-the-guess-does-not-change-matches​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  secret guess (game/score secret guess))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; true​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> With a test data generator and some validation functions in hand, we are now ready to wire everything together in a <span class="calibre8"><span class="calibre39">defspec</span></span>. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">defspec</span></span></span></p><p class="calibre44"> The <span class="calibre8"><span class="calibre39">defspec</span></span> takes three required arguments: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">A name for the spec</p></li><a></a><li value="2" class="calibre30"><p class="calibre29">The function to test</p></li><a></a><li value="3" class="calibre30"><p class="calibre29">The arguments to generate</p></li><a></a></ul><p class="calibre12"> After the arguments come zero or more body forms, which perform validations. Here is a trivial example: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/clojurebreaker/snippets.clj"><span class="calibre41"><span class="underline">clojurebreaker/snippets.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defspec closed-under-addition​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="bold"><span class="calibre36">+</span></span></span><span class="calibre8">'​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  [^</span><span class="calibre8"><span class="bold"><span class="calibre36">long</span></span></span><span class="calibre8"> a ^</span><span class="calibre8"><span class="bold"><span class="calibre36">long</span></span></span><span class="calibre8"> b]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">assert</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">integer?</span></span></span><span class="calibre8"> %)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The arguments look like normal Clojure arguments, but there is a twist. Normal function arguments can optionally be tagged with type hints. Spec arguments <span class="italic">must</span> be tagged, with hints that tell how to <span class="italic">generate</span> the arguments. </p><p class="calibre12"> The <span class="calibre8"><span class="calibre39">test.generative</span></span> function <span class="calibre8"><span class="calibre39">generate-test-data</span></span> takes an argument spec and generates an infinite sequence of test data. You can call <span class="calibre8"><span class="calibre39">generate-test-data</span></span> directly to generate arguments separately from any test execution: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(take 3​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (test/generate-test-data '[long long]))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ([-5025562857975149833 -5843495416241995736]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    [5694868678511409995 5111195811822994797]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    [-6169532649852302182 -1782466964123969572])​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The body of a <span class="calibre8"><span class="calibre39">defspec</span></span> has access to the arguments by name, just like a normal function. In addition, it also has access to <span class="calibre8"><span class="calibre39">%</span></span>, which holds the return values from calling the test function. In the <span class="calibre8"><span class="calibre39">closed-under-addition</span></span> example, the single validator form checks that the result of addition is an integer, without even bothering to look at the input arguments: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(assert (integer? %))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> More sophisticated validators will typically refer to both the input arguments and the result. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Running Tests</span></span></span></p><p class="calibre44"> Specs are still functions, so you can run them by simply invoking the function. If you evaluated the <span class="calibre8"><span class="calibre39">closed-under-addition</span></span> spec at the REPL while reading the previous section, you can invoke it now, passing in some integers: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(closed-under-addition 1 2)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> But the more interesting thing is to run the spec with generated inputs. There are three helpers in <span class="calibre8"><span class="calibre39">test.generative</span></span> for this purpose: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"><span class="calibre8"><span class="calibre39">test-vars</span></span> takes one or more vars and runs the specs referenced by the vars. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">test-dirs</span></span> takes one or more directories and reflectively finds all specs in those directories and runs them. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">test-namespaces</span></span> takes on more namespaces and reflectively finds all specs in those namespaces and runs them. </p></li><a></a></ul><p class="calibre12"> Let’s run the <span class="calibre8"><span class="calibre39">closed-under-addition</span></span> spec: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(require '[clojure.test.generative :as test])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(test/test-vars #'closed-under-addition)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; [#&lt;core$future_call$reify__5684@603a3e21: :pending&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    #&lt;core$future_call$reify__5684@fc519e2: :pending&gt;]​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The call to <span class="calibre8"><span class="calibre39">test-vars</span></span> returns some number of futures (two in the earlier output). Then nothing happens for about ten seconds, followed by REPL output similar to this: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​{:iterations 179766,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  :msec 10228,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  :var #'clojurebreaker.game-test/closed-under-addition,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  :seed 43}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​{:iterations 156217,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  :msec 10249,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  :var #'clojurebreaker.game-test/closed-under-addition,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  :seed 42}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Behind the scenes, <span class="calibre8"><span class="calibre39">test.generative</span></span> has created a future per processor on your local hardware. Each future runs the tests as many times as possible in ten seconds. The output then shows how many iterations ran on each thread, how much wall-clock time each thread took to finish, and the random seed used to generate the data for each var that was tested. </p><p class="calibre12"><span class="calibre8"><span class="calibre39">test.generative</span></span> exposes several dynamic vars to customize a test run. You can bind <span class="calibre8"><span class="calibre39">test/*msec*</span></span> to change the length of the test run, or you can bind <span class="calibre8"><span class="calibre39">test/*cores*</span></span> to change the number of cores utilized by the test run. You can also bind <span class="calibre8"><span class="calibre39">test/*verbose*</span></span> to have all the inputs printed to <span class="calibre8"><span class="calibre39">*out*</span></span> during the test run. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">When a Spec Fails</span></span></span></p><p class="calibre44"> When a spec fails, <span class="calibre8"><span class="calibre39">test.generative</span></span> provides additional output to assist you in reproducing the problem. Let’s write a spec that will fail by asserting that the sum of two numbers is less than either: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/clojurebreaker/snippets.clj"><span class="calibre41"><span class="underline">clojurebreaker/snippets.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defspec incorrect-spec​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  </span><span class="calibre8"><span class="bold"><span class="calibre36">+</span></span></span><span class="calibre8">'​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  [^</span><span class="calibre8"><span class="bold"><span class="calibre36">long</span></span></span><span class="calibre8"> a ^</span><span class="calibre8"><span class="bold"><span class="calibre36">long</span></span></span><span class="calibre8"> b]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">assert</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">&lt;</span></span></span><span class="calibre8"> a %))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">assert</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">&lt;</span></span></span><span class="calibre8"> b %)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If you run <span class="calibre8"><span class="calibre39">incorrect-spec</span></span>, it will fail quickly with an error like this: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​{:form (#'clojurebreaker.game-test/incorrect-spec​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​        -5025562857975149833 -5843495416241995736),​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​ :iteration 0,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​ :seed 42,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​ :error "Assert failed: (&lt; a %)",​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​ :exception #&lt;AssertionError java.lang.AssertionError:​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            Assert failed: (&lt; a %)&gt;}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">:form</span></span> key gives you the input that failed, and the <span class="calibre8"><span class="calibre39">iteration</span></span> tells what iteration of the input generator caused the failure. Because the test data generation is pseudorandom with a well-known seed, you can get the failure to repeat by simply rerunning the entire test (possibly after adding logging or attaching a debugger). </p><p class="calibre12"> If you do not want to repeat the entire run to get back to the point of a failure, you can access a collection of the forms that caused errors by calling the <span class="calibre8"><span class="calibre39">failures</span></span> function: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(test/failures)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; ({:form​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     (#'clojurebreaker.game-test/incorrect-spec​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      -5025562857975149833 -5843495416241995736)}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    {:form​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​     (#'clojurebreaker.game-test/incorrect-spec​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      -5027215341191833961 -2715953330829768452)}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> From here, it is a simple matter of collection traversal to reevaluate past failing inputs: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(eval (:form (first (test/failures))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; AssertionError Assert failed: (&lt; a %)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> We have now written and run specs and seen how to explore when things go wrong. Next we will put these techniques to use testing the Clojurebreaker <span class="calibre8"><span class="calibre39">score</span></span> function. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Generative Testing the score Function</span></span></span></p><p class="calibre44"> In <a href="#filepos1438322">​<span class="italic">Programmatic Validation</span>​</a>, we created several functions that validated invariants in Clojurebreaker scoring. Now let’s add them to a spec: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/clojurebreaker/test/clojurebreaker/game_test.clj"><span class="calibre41"><span class="underline">clojurebreaker/test/clojurebreaker/game_test.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defspec score-invariants​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  game/score​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  [^{:tag `random-secret} secret​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   ^{:tag `random-secret} guess]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">assert</span></span></span><span class="calibre8"> (scoring-is-symmetric secret guess %))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">assert</span></span></span><span class="calibre8"> (scoring-is-bounded-by-number-of-pegs secret guess %))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">assert</span></span></span><span class="calibre8"> (reordering-the-guess-does-not-change-matches secret guess %)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> This spec shows one new bit of <span class="calibre8"><span class="calibre39">defspec</span></span> semantics: the use of the syntax quote (<span class="calibre8"><span class="calibre39">‘</span></span>) character. The syntax quote on <span class="calibre8"><span class="calibre39">random-secret</span></span> indicates that the generator function is a custom one written by us. There are two rules for quoting names in an argument spec: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"> If a name is not syntax-quoted, then that name is interpreted against the built-in generators from the namespace <span class="calibre8"><span class="calibre39">clojure.test.generative.generators</span></span>. These names happen to be shadow types and factory names from <span class="calibre8"><span class="calibre39">clojure.core</span></span>, which is why the built-in generators look like type hints. </p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> If a name is syntax-quoted, then the name is interpreted by the rules of the namespace the <span class="calibre8"><span class="calibre39">defspec</span></span> resides in. This allows you to use all the normal namespace tools to manage your own generators. </p></li><a></a></ul><p class="calibre12"> And now, the moment of truth. When we run the spec, do the invariants actually hold? </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​#'clojurebreaker.game-test/score-invariants​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; [#&lt;core$future_call$reify__5684@590e130c: :pending&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    #&lt;core$future_call$reify__5684@2b04a681: :pending&gt;]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​;; ten seconds pass​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​{:iterations 1794, :msec 10002, :seed 42,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​ :var #'clojurebreaker.game-test/score-invariants}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​{:iterations 1787, :msec 10001, :seed 43,​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​ :var #'clojurebreaker.game-test/score-invariants}​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Looks good. Can you think of other interesting invariants to test? </p><p class="calibre12"> At this point, we have only scratched the surface of <span class="calibre8"><span class="calibre39">test.generative</span></span>. And, while we like the separation of input generation, execution, and validation, it is certainly possible to use more familiar unit testing, TDD, and BDD approaches in Clojure. If you are interested in these, you should check out the following libraries: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29"><span class="calibre8"><span class="calibre39">clojure.test</span></span>
<a href="#filepos1528786">[62]</a> is a modest unit testing library that is built into Clojure’s own test suite. </p></li><a id="filepos1473181"></a><li value="2" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">Lazytest</span></span>
<a href="#filepos1529107">[63]</a> is a generic library that supports different testing styles atop a few generic representations of tests. </p></li><a id="filepos1473457"></a><li value="3" class="calibre30"><p class="calibre29"><span class="calibre8"><span class="calibre39">Midje</span></span>
<a href="#filepos1529410">[64]</a> emphasizes readable tests, while allowing for both top-down and bottom-up testing. </p></li><a id="filepos1473708"></a></ul><p class="calibre12"> Many of the ideas in <span class="calibre8"><span class="calibre39">test.generative</span></span> are inspired by <span class="calibre8"><span class="calibre39">QuickCheck</span></span>,<a id="filepos1473909"></a><a href="#filepos1529729">[65]</a> a testing library originally written in Haskell but now ported to many languages. If you find <span class="calibre8"><span class="calibre39">test.generative</span></span> interesting, you should definitely check out <span class="calibre8"><span class="calibre39">QuickCheck</span></span>, which has a long development history and many capabilities not yet found in <span class="calibre8"><span class="calibre39">test.generative</span></span>. </p><p class="calibre12"> Now that we have some confidence in our scoring function, let’s see about running a game of Clojurebreaker on the Web. </p><div class="mbppagebreak"></div><p id="filepos1474525" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">10.4 Creating an Interface</span></span></span></p><p class="calibre34"> With a solid foundation, introducing an interface and a playable version of the game should be a breeze. Let’s start with a basic web application. The <span class="italic">noir</span> web framework will serve as a nice base for us to build our application. Creating a new noir project is easy. </p><p class="calibre12"> First, you will need to install the <span class="calibre8"><span class="calibre39">lein-noir</span></span> plug-in to <span class="calibre8"><span class="calibre39">leiningen</span></span>: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​$ lein plugin install lein-noir 1.2.0​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now we can generate our application and launch it: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​$ lein noir new clojurebreaker​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​$ cd clojurebreaker​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​$ lein run​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Point your browser to <a href="http://localhost:8080">http://localhost:8080</a>. You will get the default noir landing page, which isn’t interesting to you at the moment, but it will ensure that you have things set up correctly. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">It’s Finally Time for Some State</span></span></span></p><p class="calibre44"> This is where we will introduce our one and only piece of state. Since we want multiple players to be able to enjoy our game at once and we want to be able to maintain the game’s solution between requests, we will need to store this value somewhere. The great part is that we don’t have to manage it in our code. We can just put it in the browser’s session, leaving our application code free of state management. </p><p class="calibre12"> Let’s start by opening <span class="calibre8"><span class="calibre39">src/clojurebreaker/views/welcome.clj</span></span>. Change the <span class="calibre8"><span class="calibre39">/welcome</span></span> page to just <span class="calibre8"><span class="calibre39">/</span></span>. We need a way to put something in the session if it isn’t already there. Luckily, noir has <span class="calibre8"><span class="calibre39">session/put!</span></span> and <span class="calibre8"><span class="calibre39">session/get</span></span>. Let’s use them. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defpage </span><span class="calibre8"><span class="italic"><span class="calibre42">"/"</span></span></span><span class="calibre8"> []​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">when-not</span></span></span><span class="calibre8"> (session/get :game)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (session/put! :game (</span><span class="calibre8"><span class="bold"><span class="calibre36">.</span></span></span><span class="calibre8">nextInt (java.util.Random.) 1000000)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (common/layout​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   [:p </span><span class="calibre8"><span class="italic"><span class="calibre42">"Welcome to clojurebreaker.</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre42">       Your current game id is "</span></span></span><span class="calibre8"> (session/get :game)]))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If you refresh your browser, you will now see that you have a game ID in your session. If you continue to refresh, it shouldn’t change. If you clear your sessions and refresh, you should see a new game ID. We will use this technique going forward, but we won’t need a randomly generated ID anymore. That was just to demonstrate that the session store is working properly. </p><p class="calibre12"> Create a new file named <span class="calibre8"><span class="calibre39">game.clj</span></span> in <span class="calibre8"><span class="calibre39">src/clojurebreaker/models</span></span>. Here we will put the function we need to generate a new game secret and return it to the view. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">ns</span></span></span><span class="calibre8"> clojurebreaker.models.game)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(</span><span class="calibre8"><span class="bold"><span class="calibre36">defn</span></span></span><span class="calibre8"> create []​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">vec</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">repeatedly</span></span></span><span class="calibre8"> 4 (</span><span class="calibre8"><span class="bold"><span class="calibre36">fn</span></span></span><span class="calibre8"> [] (rand-nth [</span><span class="calibre8"><span class="italic"><span class="calibre42">"r"</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"g"</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"b"</span></span></span><span class="calibre8"> </span><span class="calibre8"><span class="italic"><span class="calibre42">"y"</span></span></span><span class="calibre8">])))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Let’s give this a try in the REPL just to make sure it is producing what we need. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(in-ns 'clojurebreaker.models.game)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​clojurebreaker.models.game=&gt; (dotimes [_ 5] (println (create)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| [g y g b]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| [g r r r]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| [r y g r]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| [b y y b]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| [b g r g]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; nil​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> This is everything we need to start our game. We just need to go back to our view and wire up the code. Remember that <span class="calibre8"><span class="calibre39">test.generative</span></span> can also create your game secret, so feel free to use it instead of the earlier function. This just demonstrates another way of creating a secret. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defpage </span><span class="calibre8"><span class="italic"><span class="calibre42">"/"</span></span></span><span class="calibre8"> []​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">when-not</span></span></span><span class="calibre8"> (session/get :game)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (session/put! :game (game/create)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (common/layout​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    [:p </span><span class="calibre8"><span class="italic"><span class="calibre42">"Welcome to clojurebreaker.</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​</span><span class="calibre8"><span class="italic"><span class="calibre42">        Your current game solution is "</span></span></span><span class="calibre8"> (session/get :game)]))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Also, don’t forget to require <span class="calibre8"><span class="calibre39">clojurebreaker.models.game :as game</span></span> in your namespace declaration. When you refresh your browser, you will see your game solution printed. If the solution is still an ID, you will need to clear your browser’s session data and refresh. Try opening a different browser and visiting the application. You should see a different game solution. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">The Player Interface</span></span></span></p><p class="calibre44"> Now that we have game state, we need an interface for the players. Let’s start by creating a game board. We will need to add the <span class="calibre8"><span class="calibre39">hiccup.form-helpers</span></span> namespace into our namespace declaration with the rest of the hiccup imports. We will now take advantage of noir’s <span class="calibre8"><span class="calibre39">defpartial</span></span> macro. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defpartial board []​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (form-to [:post </span><span class="calibre8"><span class="italic"><span class="calibre42">"/guess"</span></span></span><span class="calibre8">]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   (text-field </span><span class="calibre8"><span class="italic"><span class="calibre42">"one"</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   (text-field </span><span class="calibre8"><span class="italic"><span class="calibre42">"two"</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   (text-field </span><span class="calibre8"><span class="italic"><span class="calibre42">"three"</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   (text-field </span><span class="calibre8"><span class="italic"><span class="calibre42">"four"</span></span></span><span class="calibre8">)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​   (submit-button </span><span class="calibre8"><span class="italic"><span class="calibre42">"Guess"</span></span></span><span class="calibre8">)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">defpartial</span></span> macro is quite useful here, because it is used just like a regular Clojure function. This will come in handy later when we wire in scoring. Give it a try at the REPL: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​clojurebreaker.models.game=&gt; (in-ns 'clojurebreaker.views.welcome)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​clojurebreaker.views.welcome=&gt; (board)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​| "&lt;form action=\"/guess\" method=\"POST\"&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|  &lt;input id=\"one\" name=\"one\" type=\"text\" /&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|  &lt;input id=\"two\" name=\"two\" type=\"text\" /&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|  &lt;input id=\"three\" name=\"three\" type=\"text\" /&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|  &lt;input id=\"four\" name=\"four\" type=\"text\" /&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|  &lt;input type=\"submit\" value=\"Guess\" /&gt;&lt;/form&gt;"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Now we just need to wire it in: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defpage </span><span class="calibre8"><span class="italic"><span class="calibre42">"/"</span></span></span><span class="calibre8"> []​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">when-not</span></span></span><span class="calibre8"> (session/get :game)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (session/put! :game (game/create)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (common/layout (board)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Since we have verified that the session bits are working, we can just remove their display and replace them with the actual game. We now have a way for users to guess. Well, at least we have a way for users to type into a browser. Let’s wire up the server side. </p><p class="calibre12"> Back in the view, we need to create another page to respond to the post to <span class="calibre8"><span class="calibre39">/guess</span></span>. Here we will need to do the following: </p><div class="calibre14"> </div><ul class="calibre15"><li value="1" class="calibre16"><p class="calibre29">Accept the four inputs and send them to the scorer.</p></li><a></a><li value="2" class="calibre30"><p class="calibre29"> Determine whether the player has won the game (four exact matches). If so, congratulate them on winning and add a button to start a new game. </p></li><a></a><li value="3" class="calibre30"><p class="calibre29"> If the user has not won, return the number of exact and unordered matches, as well as the last set of inputs, and display them to the user. </p></li><a></a></ul><p class="calibre12"> To score the request, we need to add the game-scoring functions we created earlier in the chapter. Let’s add <span class="calibre8"><span class="calibre39">exact-matches</span></span>, <span class="calibre8"><span class="calibre39">unordered-matches</span></span>, and <span class="calibre8"><span class="calibre39">score</span></span> to our model. With our scoring functions in place, we can wire up our post handler and complete the first phase of the game. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/clojurebreaker/src/clojurebreaker/views/welcome.clj"><span class="calibre41"><span class="underline">clojurebreaker/src/clojurebreaker/views/welcome.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defpage [:post </span><span class="calibre8"><span class="italic"><span class="calibre42">"/guess"</span></span></span><span class="calibre8">] {:keys [one two three four]}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">let</span></span></span><span class="calibre8"> [result (game/score (session/get :game) [one two three four])]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (</span><span class="calibre8"><span class="bold"><span class="calibre36">if</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">=</span></span></span><span class="calibre8"> (:exact result) 4)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">do</span></span></span><span class="calibre8"> (session/remove! :game)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          (common/layout​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​           [:h2 </span><span class="calibre8"><span class="italic"><span class="calibre42">"Congratulations, you have solved the puzzle!"</span></span></span><span class="calibre8">]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​           (form-to [:get </span><span class="calibre8"><span class="italic"><span class="calibre42">"/"</span></span></span><span class="calibre8">]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                    (submit-button </span><span class="calibre8"><span class="italic"><span class="calibre42">"Start A New Game"</span></span></span><span class="calibre8">))))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​      (</span><span class="calibre8"><span class="bold"><span class="calibre36">do</span></span></span><span class="calibre8"> (session/flash-put! result)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​          (render </span><span class="calibre8"><span class="italic"><span class="calibre42">"/"</span></span></span><span class="calibre8"> {:one one​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                       :two two​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                       :three three​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                       :four four​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                       :exact (:exact result)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                       :unordered (:unordered result)})))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> OK, so this is a bit of a REPL-full. Here we are able to determine whether the player has won the game and handle it appropriately. There are a couple of new things pulled in from noir here that haven’t been introduced yet, though. The <span class="calibre8"><span class="calibre39">:keys</span></span> destructuring after <span class="calibre8"><span class="calibre39">defpage</span></span> is dealing with the arguments passed in from the browser. <span class="calibre8"><span class="calibre39">session/remove!</span></span> does exactly what you think it might do. The interesting bits start with <span class="calibre8"><span class="calibre39">session/flash-put!</span></span>. This will add something to the session for the request immediately following to consume, and then it will disappear. It is similar to the Ruby on Rails flash method. Finally, the <span class="calibre8"><span class="calibre39">render</span></span> function calls the route with the arguments that follow. </p><p class="calibre12"> With just a few modifications, we will be ready to give the game a try. Our / route needs to be able to accept the arguments that it is passed via the call to <span class="calibre8"><span class="calibre39">render</span></span> that we just wrote. Let’s fix that. First modify the <span class="calibre8"><span class="calibre39">board</span></span> partial to accept and destructure arguments passed to it and render results: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/clojurebreaker/src/clojurebreaker/views/welcome.clj"><span class="calibre41"><span class="underline">clojurebreaker/src/clojurebreaker/views/welcome.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defpartial board [{:keys [one two three four exact unordered]}]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">when</span></span></span><span class="calibre8"> (</span><span class="calibre8"><span class="bold"><span class="calibre36">and</span></span></span><span class="calibre8"> exact unordered)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    [:div </span><span class="calibre8"><span class="italic"><span class="calibre42">"Exact: "</span></span></span><span class="calibre8"> exact </span><span class="calibre8"><span class="italic"><span class="calibre42">" Unordered: "</span></span></span><span class="calibre8"> unordered])​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (form-to [:post </span><span class="calibre8"><span class="italic"><span class="calibre42">"/guess"</span></span></span><span class="calibre8">]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​           (text-field </span><span class="calibre8"><span class="italic"><span class="calibre42">"one"</span></span></span><span class="calibre8"> one)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​           (text-field </span><span class="calibre8"><span class="italic"><span class="calibre42">"two"</span></span></span><span class="calibre8"> two)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​           (text-field </span><span class="calibre8"><span class="italic"><span class="calibre42">"three"</span></span></span><span class="calibre8"> three)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​           (text-field </span><span class="calibre8"><span class="italic"><span class="calibre42">"four"</span></span></span><span class="calibre8"> four)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​           (submit-button </span><span class="calibre8"><span class="italic"><span class="calibre42">"Guess"</span></span></span><span class="calibre8">)))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Here we have changed the rendering of the board to respond to the player’s guesses. We will display the results of the guess and place the player’s previous guess back onto the board so that they can modify it and continue. Experiment with this at the REPL to see what output is yielded given certain inputs: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​clojurebreaker.views.welcome=&gt; (board {:one "r"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                                       :two "b"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                                       :three "y"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                                       :four "g"})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|  "&lt;form action=\"/guess\" method=\"POST\"&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|   &lt;input id=\"one\" name=\"one\" type=\"text\" value=\"r\" /&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|   &lt;input id=\"two\" name=\"two\" type=\"text\" value=\"b\" /&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|   &lt;input id=\"three\" name=\"three\" type=\"text\" value=\"y\" /&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|   &lt;input id=\"four\" name=\"four\" type=\"text\" value=\"g\" /&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt;  &lt;input type=\"submit\" value=\"Guess\" /&gt;&lt;/form&gt;"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​clojurebreaker.views.welcome=&gt; (board {:one "r"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                                       :two "b"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                                       :three "y"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                                       :four "g"​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                                       :exact 2​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                                       :unordered 0})​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|  "&lt;div&gt;Exact: 2 Unordered: 0&lt;/div&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|   &lt;form action=\"/guess\" method=\"POST\"&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|   &lt;input id=\"one\" name=\"one\" type=\"text\" value=\"r\" /&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|   &lt;input id=\"two\" name=\"two\" type=\"text\" value=\"b\" /&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|   &lt;input id=\"three\" name=\"three\" type=\"text\" value=\"y\" /&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​|   &lt;input id=\"four\" name=\"four\" type=\"text\" value=\"g\" /&gt;​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt;  &lt;input type=\"submit\" value=\"Guess\" /&gt;&lt;/form&gt;"​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Just one minor change to the / page definition, and we are ready to start playing! </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/clojurebreaker/src/clojurebreaker/views/welcome.clj"><span class="calibre41"><span class="underline">clojurebreaker/src/clojurebreaker/views/welcome.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defpage </span><span class="calibre8"><span class="italic"><span class="calibre42">"/"</span></span></span><span class="calibre8"> {:as guesses}​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (</span><span class="calibre8"><span class="bold"><span class="calibre36">when-not</span></span></span><span class="calibre8"> (session/get :game)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​    (session/put! :game (game/create)))​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​  (common/layout (board (</span><span class="calibre8"><span class="bold"><span class="calibre36">or</span></span></span><span class="calibre8"> guesses nil))))​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Here we are just accepting the arguments from <span class="calibre8"><span class="calibre39">render</span></span> so that we can pass them along to the <span class="calibre8"><span class="calibre39">board</span></span> partial. Since <span class="calibre8"><span class="calibre39">board</span></span> works like a standard Clojure function, this process is trivial. </p><p class="calibre12"> There is just one more thing to do before we can take the game for a spin. We need to add <span class="calibre8"><span class="calibre39">math.combinatorics</span></span> to the <span class="calibre8"><span class="calibre39">project.clj</span></span> file in our noir project. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td colspan="2" valign="top" class="calibre23"><span class="calibre41"><span class="underline">  </span></span><a href="http://media.pragprog.com/titles/shcloj2/code/clojurebreaker/project.clj"><span class="calibre41"><span class="underline">clojurebreaker/project.clj</span></span></a><span class="calibre41"><span class="underline">
</span></span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​(defproject clojurebreaker </span><span class="calibre8"><span class="italic"><span class="calibre42">"0.1.0-SNAPSHOT"</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            :description </span><span class="calibre8"><span class="italic"><span class="calibre42">"Clojurebreaker game for Programming Clojure 2nd Edition"</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            :dependencies [[org.clojure/clojure </span><span class="calibre8"><span class="italic"><span class="calibre42">"1.3.0"</span></span></span><span class="calibre8">]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                           [org.clojure/math.combinatorics </span><span class="calibre8"><span class="italic"><span class="calibre42">"0.0.1"</span></span></span><span class="calibre8">]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                           [org.clojure/test.generative </span><span class="calibre8"><span class="italic"><span class="calibre42">"0.1.3"</span></span></span><span class="calibre8">]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​                           [noir </span><span class="calibre8"><span class="italic"><span class="calibre42">"1.2.0"</span></span></span><span class="calibre8">]]​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​            :main clojurebreaker.server)​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> Rerun <span class="calibre8"><span class="calibre39">lein deps</span></span> and <span class="calibre8"><span class="calibre39">lein run</span></span>, and you can now play Clojurebreaker to your heart’s content. </p><div class="mbppagebreak"></div><p id="filepos1511234" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">10.5 Deploying Your Code</span></span></span></p><p class="calibre34"> Now that you have a complete application, it’s time to put it somewhere for the world to enjoy! Deploying an application to production can be a long and arduous task that involves adding code or moving parts to your application. Luckily, we are going to skip all of those steps and just get to the point. There is a service available that fully supports Clojure application deployment and makes it drop-dead easy. They call themselves Heroku.<a id="filepos1511832"></a><a href="#filepos1530004">[66]</a>
</p><p class="calibre12"> There are a few initial steps to getting an account set up at Heroku, but the deployment process is as easy as checking code into a source control repository. In fact, that is all you have to do. A simple <span class="calibre8"><span class="calibre39">git push</span></span> is how you deploy. </p><p class="calibre12"> To get to the deployment step, you will need to sign up for an account at Heroku. It is fairly straightforward and is completely free. Heroku does have paid offerings, but this example should not cost you a dime. After signing up, you will need to create an application on the Heroku platform. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">The Procfile</span></span></span></p><p class="calibre44"> Heroku uses a special file in your program to let it know how the program should be started. It is called the <span class="calibre8"><span class="calibre39">Procfile</span></span>. Add this to the root of the project. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​web: lein run​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> If you want to ensure that things are set up properly, you can install the foreman gem and run <span class="calibre8"><span class="calibre39">foreman start</span></span>. If that successfully starts your application, you should have no trouble on Heroku. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​foreman start​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​14:35:28 web.1 | started with pid 34538​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​14:35:33 web.1 | Starting server...​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​14:35:33 web.1 | 2011-12-09 14:35:33.042:INFO::Logging to STDERR​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​14:35:33 web.1 | Server started on port [5000].​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​14:35:33 web.1 | You can view the site at http://localhost:5000​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​14:35:33 web.1 | </span><span class="calibre8"><span class="italic"><span class="calibre40">#&lt;Server Server@63ce15f6&gt;</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​14:35:33 web.1 | 2011-12-09 14:35:33.044:INFO::jetty-6.1.26​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​14:35:33 web.1 | 2011-12-09 14:35:33.070:INFO::Started SocketConnector@0.0.0.0:5000​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">The Heroku Library</span></span></span></p><p class="calibre44"> Heroku provides a nice way to programmatically interact with its platform. The only gotcha here is that it requires some additional setup if you don’t already have it. You will need the Ruby programming language along with RubyGems. Your systems package manager should be able to provide you with these items. If not, you can always visit <a href="http://ruby-lang.org">http://ruby-lang.org</a>. </p><p class="calibre12"> Installing the Heroku library is done via RubyGems: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​gem install heroku​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Git</span></span></span></p><p class="calibre44"> This will provide a <span class="calibre8"><span class="calibre39">heroku</span></span> command that you will use for all of your Heroku-based interactions. </p><p class="calibre12"> The next step is to create a git repository inside of your Clojurebreaker codebase. Again, your system’s package manager should be able to provide you with a suitable version of git. If not, you can visit <a href="http://git-scm.org">http://git-scm.org</a>. </p><p class="calibre12"> Once you have git installed, simply run <span class="calibre8"><span class="calibre39">git init</span></span> in the root of the clojurebreaker application: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​git init​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-&gt; Initialized empty Git repository </span><span class="calibre8"><span class="bold"><span class="calibre36">in</span></span></span><span class="calibre8"> ~/clojurebreaker/.git/​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> This will create the initial git shell for your application. Next you need to locally commit your code: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​git add .​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​git commit -m </span><span class="calibre8"><span class="italic"><span class="calibre42">"Initial commit"</span></span></span><span class="calibre8">​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​[master (root-commit) dd4f8a8] initial commit​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​13 files changed, 65860 insertions(+), 0 deletions(-)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​create mode 100644 .gitignore​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​create mode 100644 project.clj​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​create mode 100644 resources/public/css/reset.css​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​create mode 100644 src/clojurebreaker/game.clj​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​create mode 100644 src/clojurebreaker/models/game.clj​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​create mode 100644 src/clojurebreaker/server.clj​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​create mode 100644 src/clojurebreaker/views/common.clj​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​create mode 100644 src/clojurebreaker/views/welcome.clj​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">Housing Your Application</span></span></span></p><p class="calibre44"> At this point, you have staged your code locally to be pushed up to Heroku. Now it’s time to create a Heroku application to house your program: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​heroku create --stack cedar​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​Creating freezing-waterfall-3937... done, stack is cedar​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​http://freezing-waterfall-3937.herokuapp.com/ |​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​git@heroku.com:freezing-waterfall-3937.git​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​Git remote heroku added​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> The <span class="calibre8"><span class="calibre39">--stack</span></span> argument specifies the platform on Heroku that supports Clojure applications. The application will get a random name provided by Heroku with a URL that you can visit to see your running program. You can rename this later if you want. </p><p class="calibre12"><span class="calibre4"><span class="bold"><span class="calibre28">The Deployment</span></span></span></p><p class="calibre44"> The last step is to run <span class="calibre8"><span class="calibre39">git push</span></span>, and Heroku will take care of the rest. </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​git push heroku master​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​Counting objects: 24, done.​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​Delta compression using up to 4 threads.​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​Compressing objects: 100% (15/15), done.​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​Writing objects: 100% (24/24), 230.67 KiB, done.​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​Total 24 (delta 0), reused 0 (delta 0)​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-----&gt; Heroku receiving push​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-----&gt; Clojure app detected​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-----&gt; Installing Leiningen​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​       Downloading: leiningen-1.5.2-standalone.jar​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​       Downloading: rlwrap-0.3.7​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​       Writing: lein script​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-----&gt; Installing dependencies with Leiningen​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​... Output elided ...​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-----&gt; Discovering process types​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​       Procfile declares types -&gt; web​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-----&gt; Compiled slug size is 12.8MB​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​-----&gt; Launching... done, v4​</span><span class="calibre8">
</span>
</td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​       http://stormy-water-3888.herokuapp.com deployed to Heroku​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> You can visit your application using the <span class="calibre8"><span class="calibre39">heroku</span></span> command as well: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><span class="calibre8"><span class="bold"> </span></span>
</td><td valign="top" class="calibre23"><span class="calibre8">​heroku open​</span><span class="calibre8">
</span>
</td></tr></table><p class="calibre38"> This will open a browser and send you right to your deployed application. It might take some time to load on the first visit, but subsequent requests will get faster. You can find an additional Heroku/Clojure tutorial on Heroku’s dev center at <a href="http://devcenter.heroku.com/articles/clojure-web-application">http://devcenter.heroku.com/articles/clojure-web-application</a>. </p><p class="calibre12"> Have fun with your new Clojure web application. Make it better, give it some personality, and share it with the world! </p><div class="mbppagebreak"></div><p id="filepos1527483" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">10.6 Farewell</span></span></span></p><p class="calibre34"> Congratulations. You have come a long way in a short time. You have learned the many ideas that combine to make Clojure great: Lisp, Java, functional programming, and explicit concurrency. And in this chapter, you saw one (of a great many) possible workflows for developing a full application in Clojure. </p><p class="calibre12"> We have only scratched the surface of Clojure’s great potential, and we hope you will take the next step and become an active part of the Clojure community. Join the mailing list.<a id="filepos1528145"></a><a href="#filepos1530321">[67]</a> Hang out on IRC.<a id="filepos1528199"></a><a href="#filepos1530601">[68]</a> The Clojure community is friendly and welcoming, and we would love to hear from you. </p><p class="calibre27"><span class="calibre8"><span class="bold"><span class="calibre28">Footnotes</span></span></span></p><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos1473181"><span class="calibre8">[62]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://clojure.github.com/clojure/clojure.test-api.html"><span class="calibre8">http://clojure.github.com/clojure/clojure.test-api.html</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos1528786"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos1473457"><span class="calibre8">[63]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="https://github.com/stuartsierra/lazytest"><span class="calibre8">https://github.com/stuartsierra/lazytest</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos1529107"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos1473708"><span class="calibre8">[64]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="https://github.com/marick/Midje"><span class="calibre8">https://github.com/marick/Midje</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos1529410"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos1473909"><span class="calibre8">[65]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://en.wikipedia.org/wiki/QuickCheck"><span class="calibre8">http://en.wikipedia.org/wiki/QuickCheck</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos1529729"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos1511832"><span class="calibre8">[66]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://heroku.com"><span class="calibre8">http://heroku.com</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos1530004"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos1528145"><span class="calibre8">[67]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://groups.google.com/group/clojure"><span class="calibre8">http://groups.google.com/group/clojure</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos1530321"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos1528199"><span class="calibre8">[68]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><span class="calibre8"><span class="calibre39">#clojure on irc.freenode.net</span></span><span class="calibre8">
</span></p></td></tr><a id="filepos1530601"></a></table><p class="calibre18"><span class="calibre8"><span class="calibre19"><span class="calibre20">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="mbppagebreak"></div><p id="filepos1530798" class="calibre25"><span class="calibre2"><span class="bold"><span class="calibre43"> Appendix 1</span></span></span></p><br class="calibre11"/><p class="calibre26"><span class="calibre2"><span class="bold"><span class="calibre3">Editor Support</span></span></span></p><p class="calibre12"> Editor support for Clojure is evolving rapidly, so some of the information here may be out-of-date by the time you read this. For the latest information, see the Getting Started<a id="filepos1531240"></a><a href="#filepos1535342">[69]</a> page in the community wiki, which has child pages for a number of different dev environments. </p><p class="calibre12">Clojure code is concise and expressive. As a result, editor support is not quite as important as for some other languages. However, you will want an editor that can at least indent code correctly and can match parentheses.</p><p class="calibre12"> While writing the book, we used Emacs plus Jeffrey Chu’s clojure-mode.<a id="filepos1531731"></a><a href="#filepos1535655">[70]</a> Emacs support for Clojure is quite good, but if you are not already an Emacs user, you might prefer to start with an editor you are familiar with from among those shown here: </p><br class="calibre11"/><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><th valign="top" class="calibre51"><span class="bold">   </span><p class="calibre59"><span class="bold">Editor  </span></p></th><th valign="top" class="calibre51"><span class="bold">   </span><p class="calibre59"><span class="bold">Project Name  </span></p></th><th valign="top" class="calibre51"><span class="bold">   </span><p class="calibre59"><span class="bold">Project URL  </span></p></th></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">Eclipse  </p></td><td valign="top" class="calibre23">   <p class="calibre59">Counterclockwise  </p></td><td valign="top" class="calibre23">   <p class="calibre59">   <a href="http://code.google.com/p/counterclockwise/">http://code.google.com/p/counterclockwise/</a>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">Emacs  </p></td><td valign="top" class="calibre23">   <p class="calibre59">clojure-mode  </p></td><td valign="top" class="calibre23">   <p class="calibre59">   <a href="http://github.com/jochu/clojure-mode">http://github.com/jochu/clojure-mode</a>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">IntelliJ IDEA  </p></td><td valign="top" class="calibre23">   <p class="calibre59">La Clojure  </p></td><td valign="top" class="calibre23">   <p class="calibre59">   <a href="http://plugins.intellij.net/plugin/?id=4050">http://plugins.intellij.net/plugin/?id=4050</a>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">jEdit  </p></td><td valign="top" class="calibre23">   <p class="calibre59">jedit modes  </p></td><td valign="top" class="calibre23">   <p class="calibre59">   <a href="http://github.com/djspiewak/jedit-modes/tree/master/">http://github.com/djspiewak/jedit-modes/tree/master/</a>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">NetBeans  </p></td><td valign="top" class="calibre23">   <p class="calibre59">enclojure  </p></td><td valign="top" class="calibre23">   <p class="calibre59">   <a href="http://enclojure.org">http://enclojure.org</a>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">TextMate  </p></td><td valign="top" class="calibre23">   <p class="calibre59">textmate-clojure  </p></td><td valign="top" class="calibre23">   <p class="calibre59">   <a href="https://github.com/swannodette/textmate-clojure">https://github.com/swannodette/textmate-clojure</a>
</p></td></tr><tr valign="top" class="calibre22"><td valign="top" class="calibre23">   <p class="calibre59">Vim  </p></td><td valign="top" class="calibre23">   <p class="calibre59">VimClojure  </p></td><td valign="top" class="calibre23">   <p class="calibre59">   <a href="http://www.vim.org/scripts/script.php?script_id=2501">http://www.vim.org/scripts/script.php?script_id=2501</a>
</p></td></tr></table><p class="calibre27"><span class="calibre8"><span class="bold"><span class="calibre28">Footnotes</span></span></span></p><table valign="top" class="calibre21"><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos1531240"><span class="calibre8">[69]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://dev.clojure.org/display/doc/Getting+Started"><span class="calibre8">http://dev.clojure.org/display/doc/Getting+Started</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos1535342"></a><tr valign="top" class="calibre22"><td valign="top" class="calibre23"><a href="#filepos1531731"><span class="calibre8">[70]</span></a><span class="calibre8">  </span></td><td valign="top" class="calibre23"><p class="calibre29"><a href="http://github.com/jochu/clojure-mode"><span class="calibre8">http://github.com/jochu/clojure-mode</span></a><span class="calibre8">
</span></p></td></tr><a id="filepos1535655"></a></table><p class="calibre18"><span class="calibre8"><span class="calibre19"><span class="calibre20">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="mbppagebreak"></div><p id="filepos1535852" class="calibre25"><span class="calibre2"><span class="bold"><span class="calibre43"> Appendix 2</span></span></span></p><br class="calibre11"/><p class="calibre26"><span class="calibre2"><span class="bold"><span class="calibre3">Bibliography</span></span></span></p><p class="calibre12"><span class="calibre41"><span class="bold">[Goe06]</span></span>
</p><blockquote class="calibre75"><blockquote class="calibre48">Brian Goetz. <span class="italic"><span class="bold"><span class="calibre76">Java Concurrency in Practice</span></span></span>. Addison-Wesley, Reading, MA, 2006.</blockquote></blockquote><p class="calibre77"><span class="calibre41"><span class="bold">[Hof99]</span></span>
</p><blockquote class="calibre75"><blockquote class="calibre48">Douglas R. Hofstadter. <span class="italic"><span class="bold"><span class="calibre76">Gödel, Escher, Bach: An Eternal Golden Braid</span></span></span>. Basic Books, New York, NY, USA, 20th Anniv, 1999.</blockquote></blockquote><p class="calibre77"><span class="calibre41"><span class="bold">[McC06]</span></span>
</p><blockquote class="calibre75"><blockquote class="calibre48">Steve McConnell}. <span class="italic"><span class="bold"><span class="calibre76">Software Estimation: Demystifying the Black Art</span></span></span>. Microsoft Press, Redmond, WA, 2006.</blockquote></blockquote><p class="calibre18"><span class="calibre8"><span class="calibre19"><span class="calibre20">Copyright © 2012, The Pragmatic Bookshelf.</span></span></span></p><div class="mbppagebreak"></div><p id="filepos1537118" class="calibre31"><span class="calibre32"><span class="bold"><span class="calibre33">You May Be Interested In…</span></span></span></p><p class="calibre34"><span class="italic">Click a cover for more information</span>
</p><p class="calibre12"><a href="http://pragmaticprogrammer.com/titles/bhtmux">   </a><img src="images/00003.jpg" class="calibre78"/><a href="http://pragmaticprogrammer.com/titles/bhtmux">
</a>  <a href="http://pragmaticprogrammer.com/titles/dccar">   </a><img src="images/00004.jpg" class="calibre78"/><a href="http://pragmaticprogrammer.com/titles/dccar">
</a>  <a href="http://pragmaticprogrammer.com/titles/tbcoffee">   </a><img src="images/00001.jpg" class="calibre78"/><a href="http://pragmaticprogrammer.com/titles/tbcoffee">
</a>  <a href="http://pragmaticprogrammer.com/titles/pg_sass">   </a><img src="images/00005.jpg" class="calibre79"/><a href="http://pragmaticprogrammer.com/titles/pg_sass">
</a>  <a href="http://pragmaticprogrammer.com/titles/btlang">   </a><img src="images/00011.jpg" class="calibre78"/><a href="http://pragmaticprogrammer.com/titles/btlang">
</a>  <a href="http://pragmaticprogrammer.com/titles/bksqla">   </a><img src="images/00007.jpg" class="calibre78"/><a href="http://pragmaticprogrammer.com/titles/bksqla">
</a>  </p><hr class="calibre58"/><div class="mbppagebreak"></div><p id="filepos1538569" class="calibre80"><span class="calibre2"><span class="bold">Table of Contents</span></span></p><p class="calibre81"><a href="#filepos109">Programming Clojure</a></p><p class="calibre82"><a href="#filepos2595">​</a></p><p class="calibre82"><a href="#filepos2886">Table of Contents</a></p><p class="calibre82"><a href="#filepos11096">What Readers Are Saying About Programming Clojure, Second Edition</a></p><p class="calibre82"><a href="#filepos13531">Foreword for the Second Edition</a></p><p class="calibre82"><a href="#filepos15113">Foreword for the First Edition</a></p><p class="calibre82"><a href="#filepos17636">Acknowledgments</a></p><p class="calibre82"><a href="#filepos20640">Preface</a></p><blockquote class="calibre48"><a href="#filepos22931">Who This Book Is For</a></blockquote><blockquote class="calibre48"><a href="#filepos24342">What Is in This Book</a></blockquote><blockquote class="calibre48"><a href="#filepos27472">How to Read This Book</a></blockquote><blockquote class="calibre48"><a href="#filepos32041">Notation Conventions</a></blockquote><blockquote class="calibre48"><a href="#filepos40345">Web Resources and Feedback</a></blockquote><blockquote class="calibre48"><a href="#filepos40949">Downloading Sample Code</a></blockquote><p class="calibre82"><a href="#filepos45104">Chapter 1: Getting Started</a></p><blockquote class="calibre48"><a href="#filepos47357">1.1 Why Clojure?</a></blockquote><blockquote class="calibre48"><a href="#filepos94711">1.2 Clojure Coding Quick Start</a></blockquote><blockquote class="calibre48"><a href="#filepos121815">1.3 Exploring Clojure Libraries</a></blockquote><blockquote class="calibre48"><a href="#filepos150081">1.4 Wrapping Up</a></blockquote><p class="calibre82"><a href="#filepos154108">Chapter 2: Exploring Clojure</a></p><blockquote class="calibre48"><a href="#filepos156033">2.1 Forms</a></blockquote><blockquote class="calibre48"><a href="#filepos208768">2.2 Reader Macros</a></blockquote><blockquote class="calibre48"><a href="#filepos215638">2.3 Functions</a></blockquote><blockquote class="calibre48"><a href="#filepos245180">2.4 Vars, Bindings, and Namespaces</a></blockquote><blockquote class="calibre48"><a href="#filepos281250">2.5 Calling Java</a></blockquote><blockquote class="calibre48"><a href="#filepos292238">2.6 Flow Control</a></blockquote><blockquote class="calibre48"><a href="#filepos311519">2.7 Where’s My for Loop?</a></blockquote><blockquote class="calibre48"><a href="#filepos334070">2.8 Metadata</a></blockquote><blockquote class="calibre48"><a href="#filepos344821">2.9 Wrapping Up</a></blockquote><p class="calibre82"><a href="#filepos350588">Chapter 3: Unifying Data with Sequences</a></p><blockquote class="calibre48"><a href="#filepos354001">3.1 Everything Is a Sequence</a></blockquote><blockquote class="calibre48"><a href="#filepos381095">3.2 Using the Sequence Library</a></blockquote><blockquote class="calibre48"><a href="#filepos428764">3.3 Lazy and Infinite Sequences</a></blockquote><blockquote class="calibre48"><a href="#filepos443494">3.4 Clojure Makes Java Seq-able</a></blockquote><blockquote class="calibre48"><a href="#filepos484006">3.5 Calling Structure-Specific Functions</a></blockquote><blockquote class="calibre48"><a href="#filepos537038">3.6 Wrapping Up</a></blockquote><p class="calibre82"><a href="#filepos539895">Chapter 4: Functional Programming</a></p><blockquote class="calibre48"><a href="#filepos542049">4.1 Functional Programming Concepts</a></blockquote><blockquote class="calibre48"><a href="#filepos555532">4.2 How to Be Lazy</a></blockquote><blockquote class="calibre48"><a href="#filepos599478">4.3 Lazier Than Lazy</a></blockquote><blockquote class="calibre48"><a href="#filepos635309">4.4 Recursion Revisited</a></blockquote><blockquote class="calibre48"><a href="#filepos694806">4.5 Wrapping Up</a></blockquote><p class="calibre82"><a href="#filepos699699">Chapter 5: State</a></p><blockquote class="calibre48"><a href="#filepos702197">5.1 Concurrency, Parallelism, and Locking</a></blockquote><blockquote class="calibre48"><a href="#filepos706924">5.2 Refs and Software Transactional Memory</a></blockquote><blockquote class="calibre48"><a href="#filepos741361">5.3 Use Atoms for Uncoordinated, Synchronous Updates</a></blockquote><blockquote class="calibre48"><a href="#filepos749782">5.4 Use Agents for Asynchronous Updates</a></blockquote><blockquote class="calibre48"><a href="#filepos773305">5.5 Managing Per-Thread State with Vars</a></blockquote><blockquote class="calibre48"><a href="#filepos798340">5.6 A Clojure Snake</a></blockquote><blockquote class="calibre48"><a href="#filepos863368">5.7 Wrapping Up</a></blockquote><p class="calibre82"><a href="#filepos867195">Chapter 6: Protocols and Datatypes</a></p><blockquote class="calibre48"><a href="#filepos869565">6.1 Programming to Abstractions</a></blockquote><blockquote class="calibre48"><a href="#filepos896919">6.2 Interfaces</a></blockquote><blockquote class="calibre48"><a href="#filepos901252">6.3 Protocols</a></blockquote><blockquote class="calibre48"><a href="#filepos937760">6.4 Datatypes</a></blockquote><blockquote class="calibre48"><a href="#filepos984443">6.5 Records</a></blockquote><blockquote class="calibre48"><a href="#filepos1020728">6.6 reify</a></blockquote><blockquote class="calibre48"><a href="#filepos1027275">6.7 Wrapping Up</a></blockquote><p class="calibre82"><a href="#filepos1030215">Chapter 7: Macros</a></p><blockquote class="calibre48"><a href="#filepos1031838">7.1 When to Use Macros</a></blockquote><blockquote class="calibre48"><a href="#filepos1033097">7.2 Writing a Control Flow Macro</a></blockquote><blockquote class="calibre48"><a href="#filepos1065738">7.3 Making Macros Simpler</a></blockquote><blockquote class="calibre48"><a href="#filepos1098591">7.4 Taxonomy of Macros</a></blockquote><blockquote class="calibre48"><a href="#filepos1147465">7.5 Wrapping Up</a></blockquote><p class="calibre82"><a href="#filepos1149215">Chapter 8: Multimethods</a></p><blockquote class="calibre48"><a href="#filepos1150910">8.1 Living Without Multimethods</a></blockquote><blockquote class="calibre48"><a href="#filepos1164941">8.2 Defining Multimethods</a></blockquote><blockquote class="calibre48"><a href="#filepos1183130">8.3 Moving Beyond Simple Dispatch</a></blockquote><blockquote class="calibre48"><a href="#filepos1194210">8.4 Creating Ad Hoc Taxonomies</a></blockquote><blockquote class="calibre48"><a href="#filepos1221606">8.5 When Should I Use Multimethods?</a></blockquote><blockquote class="calibre48"><a href="#filepos1241035">8.6 Wrapping Up</a></blockquote><p class="calibre82"><a href="#filepos1242160">Chapter 9: Java Down and Dirty</a></p><blockquote class="calibre48"><a href="#filepos1244409">9.1 Exception Handling</a></blockquote><blockquote class="calibre48"><a href="#filepos1265505">9.2 Wrestling with the Integers</a></blockquote><blockquote class="calibre48"><a href="#filepos1273018">9.3 Optimizing for Performance</a></blockquote><blockquote class="calibre48"><a href="#filepos1300752">9.4 Creating Java Classes in Clojure</a></blockquote><blockquote class="calibre48"><a href="#filepos1333384">9.5 A Real-World Example</a></blockquote><blockquote class="calibre48"><a href="#filepos1385428">9.6 Wrapping Up</a></blockquote><p class="calibre82"><a href="#filepos1386949">Chapter 10: Building an Application</a></p><blockquote class="calibre48"><a href="#filepos1389971">10.1 Scoring a Clojurebreaker Game</a></blockquote><blockquote class="calibre48"><a href="#filepos1411011">10.2 Testing the Scorer</a></blockquote><blockquote class="calibre48"><a href="#filepos1430311">10.3 test.generative</a></blockquote><blockquote class="calibre48"><a href="#filepos1474525">10.4 Creating an Interface</a></blockquote><blockquote class="calibre48"><a href="#filepos1511234">10.5 Deploying Your Code</a></blockquote><blockquote class="calibre48"><a href="#filepos1527483">10.6 Farewell</a></blockquote><p class="calibre82"><a href="#filepos1530798">Appendix 1: Editor Support</a></p><p class="calibre82"><a href="#filepos1535852">Appendix 2: Bibliography</a></p><blockquote class="calibre48"><a href="#filepos1537118">You May Be Interested In…</a></blockquote><div class="mbppagebreak"></div><a></a>
<a></a>
<a></a></div>

{% endraw %}

