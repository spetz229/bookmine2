---
layout: page
title: "Java Concurrency in Practice"
prev: ch02_split_000.html
next: ch02lev1sec1.html
book_path: books/brian-goetz-tim-peierls-joshua-bloch-joseph-bowbeer-david-holmes-doug-lea-java-concurrency-in-practice--_oeb/
---
{% include JB/setup %}
{% raw %}
<div>

<div class="calibre32"></div><h2 id="title-IDANPPF0" class="docPrefaceTitle">Chapter 2. Thread Safety</h2>
<p class="docText1"><a name="iddle1017" class="calibre18" id="iddle1017"></a><a name="iddle1018" class="calibre18" id="iddle1018"></a><a name="iddle1019" class="calibre18" id="iddle1019"></a><a name="iddle1254" class="calibre18" id="iddle1254"></a><a name="iddle1451" class="calibre18" id="iddle1451"></a><a name="iddle1452" class="calibre18" id="iddle1452"></a><a name="iddle1453" class="calibre18" id="iddle1453"></a><a name="iddle1531" class="calibre18" id="iddle1531"></a><a name="iddle1532" class="calibre18" id="iddle1532"></a><a name="iddle1639" class="calibre18" id="iddle1639"></a><a name="iddle1640" class="calibre18" id="iddle1640"></a><a name="iddle1652" class="calibre18" id="iddle1652"></a><a name="iddle1746" class="calibre18" id="iddle1746"></a><a name="iddle1998" class="calibre18" id="iddle1998"></a><a name="iddle1999" class="calibre18" id="iddle1999"></a><a name="iddle2000" class="calibre18" id="iddle2000"></a><a name="iddle2001" class="calibre18" id="iddle2001"></a><a name="iddle2002" class="calibre18" id="iddle2002"></a><a name="iddle2003" class="calibre18" id="iddle2003"></a><a name="iddle2347" class="calibre18" id="iddle2347"></a><a name="iddle2348" class="calibre18" id="iddle2348"></a><a name="iddle2870" class="calibre18" id="iddle2870"></a><a name="iddle2871" class="calibre18" id="iddle2871"></a><a name="iddle2872" class="calibre18" id="iddle2872"></a><a name="iddle3027" class="calibre18" id="iddle3027"></a><a name="iddle3032" class="calibre18" id="iddle3032"></a><a name="iddle3033" class="calibre18" id="iddle3033"></a><a name="iddle3034" class="calibre18" id="iddle3034"></a><a name="iddle3262" class="calibre18" id="iddle3262"></a><a name="iddle3266" class="calibre18" id="iddle3266"></a><a name="iddle3267" class="calibre18" id="iddle3267"></a><a name="iddle3268" class="calibre18" id="iddle3268"></a><a name="iddle3278" class="calibre18" id="iddle3278"></a><a name="iddle3281" class="calibre18" id="iddle3281"></a><a name="iddle3282" class="calibre18" id="iddle3282"></a><a name="iddle3448" class="calibre18" id="iddle3448"></a><a name="iddle3449" class="calibre18" id="iddle3449"></a><a name="iddle4028" class="calibre18" id="iddle4028"></a><a name="iddle4029" class="calibre18" id="iddle4029"></a><a name="iddle4030" class="calibre18" id="iddle4030"></a><a name="iddle4031" class="calibre18" id="iddle4031"></a><a name="iddle4158" class="calibre18" id="iddle4158"></a><a name="iddle4222" class="calibre18" id="iddle4222"></a><a name="iddle4223" class="calibre18" id="iddle4223"></a><a name="iddle4239" class="calibre18" id="iddle4239"></a><a name="iddle4240" class="calibre18" id="iddle4240"></a><a name="iddle4377" class="calibre18" id="iddle4377"></a><a name="iddle4378" class="calibre18" id="iddle4378"></a><a name="iddle4379" class="calibre18" id="iddle4379"></a><a name="iddle4380" class="calibre18" id="iddle4380"></a><a name="iddle4381" class="calibre18" id="iddle4381"></a><a name="iddle4382" class="calibre18" id="iddle4382"></a><a name="iddle4406" class="calibre18" id="iddle4406"></a><a name="iddle4407" class="calibre18" id="iddle4407"></a><a name="iddle4532" class="calibre18" id="iddle4532"></a><a name="iddle4533" class="calibre18" id="iddle4533"></a><a name="iddle4534" class="calibre18" id="iddle4534"></a><a name="iddle4535" class="calibre18" id="iddle4535"></a><a name="iddle4729" class="calibre18" id="iddle4729"></a><a name="iddle4959" class="calibre18" id="iddle4959"></a><a name="iddle5011" class="calibre18" id="iddle5011"></a><a name="iddle5040" class="calibre18" id="iddle5040"></a><a name="iddle5041" class="calibre18" id="iddle5041"></a><a name="iddle5060" class="calibre18" id="iddle5060"></a><a name="iddle5097" class="calibre18" id="iddle5097"></a><a name="iddle5098" class="calibre18" id="iddle5098"></a><a name="iddle5099" class="calibre18" id="iddle5099"></a>Perhaps surprisingly, concurrent programming isn't so much about threads or locks, any more than civil engineering is about rivets and I-beams. Of course, building bridges that don't fall down requires the correct use of a lot of rivets and I-beams, just as building concurrent programs require the correct use of threads and locks. But these are just <span class="docEmphasis">mechanisms</span>means to an end. Writing thread-safe code is, at its core, about managing access to <span class="docEmphasis">state</span>, and in particular to <span class="docEmphasis">shared, mutable state</span>.</p>
<p class="docText1">Informally, an object's <span class="docEmphasis">state</span> is its data, stored in <span class="docEmphasis">state variables</span> such as instance or static fields. An object's state may include fields from other, dependent objects; a <tt class="calibre25">HashMap</tt>'s state is partially stored in the <tt class="calibre25">HashMap</tt> object itself, but also in many <tt class="calibre25">Map.Entry</tt> objects. An object's state encompasses any data that can affect its externally visible behavior.</p>
<p class="docText1">By <span class="docEmphasis">shared</span>, we mean that a variable could be accessed by multiple threads; by <span class="docEmphasis">mutable</span>, we mean that its value could change during its lifetime. We may talk about thread safety as if it were about <span class="docEmphasis">code</span>, but what we are really trying to do is protect <span class="docEmphasis">data</span> from uncontrolled concurrent access.</p>
<p class="docText1">Whether an object needs to be thread-safe depends on whether it will be accessed from multiple threads. This is a property of how the object is <span class="docEmphasis">used</span> in a program, not what it <span class="docEmphasis">does</span>. Making an object thread-safe requires using synchronization to coordinate access to its mutable state; failing to do so could result in data corruption and other undesirable consequences.</p>
<p class="docText1"><span class="docEmphasis">Whenever more than one thread accesses a given state variable, and one of them might write to it, they all must coordinate their access to it using synchronization.</span> The primary mechanism for synchronization in Java is the <tt class="calibre25">synchronized</tt> keyword, which provides exclusive locking, but the term "synchronization" also includes the use of <tt class="calibre25">volatile</tt> variables, explicit locks, and atomic variables.</p>
<p class="docText1">You should avoid the temptation to think that there are "special" situations in which this rule does not apply. A program that omits needed synchronization might appear to work, passing its tests and performing well for years, but it is still broken and may fail at any moment.</p>
<a name="ch02sb01" class="calibre18" id="ch02sb01"></a><p class="calibre21"><table cellspacing="0" width="90%" border="1" cellpadding="5" class="calibre5"><tr class="calibre6"><td class="calibre28">
<p class="docText1">If multiple threads access the same mutable state variable without appropriate synchronization, <span class="docEmphasis">your program is broken</span>. There are three ways to fix it:</p>
<ul class="calibre15"><li class="calibre16"><p class="docText1"><span class="docEmphasis">Don't share</span> the state variable across threads;</p></li><li class="calibre16"><p class="docText1">Make the state variable <span class="docEmphasis">immutable</span>; or</p></li><li class="calibre16"><p class="docText1">Use <span class="docEmphasis">synchronization</span> whenever accessing the state variable.</p></li></ul>
</td></tr></table></p><p class="calibre1"> </p>
<p class="docText1">If you haven't considered concurrent access in your class design, some of these approaches can require significant design modifications, so fixing the problem might not be as trivial as this advice makes it sound. <span class="docEmphasis">It is far easier to design a class to be thread-safe than to retrofit it for thread safety later.</span></p>
<p class="docText1">In a large program, identifying whether multiple threads might access a given variable can be complicated. Fortunately, the same object-oriented techniques that help you write well-organized, maintainable classessuch as encapsulation and data hidingcan also help you create thread-safe classes. The less code that has access to a particular variable, the easier it is to ensure that all of it uses the proper synchronization, and the easier it is to reason about the conditions under which a given variable might be accessed. The Java language doesn't force you to encapsulate stateit is perfectly allowable to store state in public fields (even public static fields) or publish a reference to an otherwise internal objectbut the better encapsulated your program state, the easier it is to make your program thread-safe and to help maintainers keep it that way.</p>
<a name="ch02sb02" class="calibre18" id="ch02sb02"></a><p class="calibre21"><table cellspacing="0" width="90%" border="1" cellpadding="5" class="calibre5"><tr class="calibre6"><td class="calibre28">
<p class="docText1">When designing thread-safe classes, good object-oriented techniquesencapsulation, immutability, and clear specification of invariantsare your best friends.</p>
</td></tr></table></p><p class="calibre1"> </p>
<p class="docText1">There will be times when good object-oriented design techniques are at odds with real-world requirements; it may be necessary in these cases to compromise the rules of good design for the sake of performance or for the sake of backward compatibility with legacy code. Sometimes abstraction and encapsulation are at odds with performancealthough not nearly as often as many developers believebut it is always a good practice first to make your code right, and <span class="docEmphasis">then</span> make it fast. Even then, pursue optimization only if your performance measurements and requirements tell you that you must, and if those same measurements tell you that your optimizations actually made a difference under realistic conditions. <sup class="docFootnote"><a class="calibre2" href="#ch02fn01">[1]</a></sup></p><blockquote class="calibre19"><p class="docFootnote1"><sup class="calibre27"><a name="ch02fn01" class="calibre18" id="ch02fn01">[1]</a></sup> In concurrent code, this practice should be adhered to even more than usual. Because concurrency bugs are so difficult to reproduce and debug, the benefit of a small performance gain on some infrequently used code path may well be dwarfed by the risk that the program will fail in the field.</p></blockquote>
<p class="docText1">If you decide that you simply must break encapsulation, all is not lost. It is still possible to make your program thread-safe, it is just a lot harder. Moreover, the <a name="iddle1257" class="calibre18" id="iddle1257"></a><a name="iddle1258" class="calibre18" id="iddle1258"></a><a name="iddle1749" class="calibre18" id="iddle1749"></a><a name="iddle1750" class="calibre18" id="iddle1750"></a><a name="iddle1909" class="calibre18" id="iddle1909"></a><a name="iddle1910" class="calibre18" id="iddle1910"></a><a name="iddle2004" class="calibre18" id="iddle2004"></a><a name="iddle2005" class="calibre18" id="iddle2005"></a><a name="iddle2022" class="calibre18" id="iddle2022"></a><a name="iddle2023" class="calibre18" id="iddle2023"></a><a name="iddle2032" class="calibre18" id="iddle2032"></a><a name="iddle2518" class="calibre18" id="iddle2518"></a><a name="iddle2519" class="calibre18" id="iddle2519"></a><a name="iddle2522" class="calibre18" id="iddle2522"></a><a name="iddle2534" class="calibre18" id="iddle2534"></a><a name="iddle2547" class="calibre18" id="iddle2547"></a><a name="iddle2580" class="calibre18" id="iddle2580"></a><a name="iddle2581" class="calibre18" id="iddle2581"></a><a name="iddle2715" class="calibre18" id="iddle2715"></a><a name="iddle2864" class="calibre18" id="iddle2864"></a><a name="iddle2865" class="calibre18" id="iddle2865"></a><a name="iddle3522" class="calibre18" id="iddle3522"></a><a name="iddle3523" class="calibre18" id="iddle3523"></a><a name="iddle3889" class="calibre18" id="iddle3889"></a><a name="iddle4395" class="calibre18" id="iddle4395"></a><a name="iddle4396" class="calibre18" id="iddle4396"></a><a name="iddle4481" class="calibre18" id="iddle4481"></a><a name="iddle4482" class="calibre18" id="iddle4482"></a><a name="iddle1676" class="calibre18" id="iddle1676"></a><a name="iddle1679" class="calibre18" id="iddle1679"></a><a name="iddle2401" class="calibre18" id="iddle2401"></a><a name="iddle2866" class="calibre18" id="iddle2866"></a><a name="iddle3638" class="calibre18" id="iddle3638"></a><a name="iddle4338" class="calibre18" id="iddle4338"></a><a name="iddle4385" class="calibre18" id="iddle4385"></a><a name="iddle4386" class="calibre18" id="iddle4386"></a><a name="iddle4732" class="calibre18" id="iddle4732"></a>thread safety of your program will be more fragile, increasing not only development cost and risk but maintenance cost and risk as well. <a class="calibre2" href="ch04.html#ch04">Chapter 4</a> characterizes the conditions under which it is safe to relax encapsulation of state variables.</p>
<p class="docText1">We've used the terms "thread-safe class" and "thread-safe program" nearly interchangeably thus far. Is a thread-safe program one that is constructed entirely of thread-safe classes? Not necessarilya program that consists entirely of thread-safe classes may not be thread-safe, and a thread-safe program may contain classes that are not thread-safe. The issues surrounding the composition of thread-safe classes are also taken up in <a class="calibre2" href="ch04.html#ch04">Chapter 4</a>. In any case, the concept of a thread-safe class makes sense only if the class encapsulates its own state. Thread safety may be a term that is applied to <span class="docEmphasis">code</span>, but it is about <span class="docEmphasis">state</span>, and it can only be applied to the entire body of code that encapsulates its state, which may be an object or an entire program.</p>
<a href="21021536.html" class="calibre2"><img src="pixel.jpg" alt="" border="0" class="calibre26"/></a>
<p class="calibre3"> </p>

</div>

{% endraw %}

