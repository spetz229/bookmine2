---
layout: page
title: "The Joy of Clojure: Thinking the Clojure Way"
prev: None
next: None
book_path: books/the-joy-of-clojure-thinking-the-clojure-way-michael-fogus-chris-houser_oeb/
---
{% include JB/setup %}
{% raw %}
<div>
<p class="calibre1"><span class="calibre2"><span class="bold">The Joy of Clojure: Thinking the Clojure Way</span></span></p><p class="calibre1"><span class="bold">Michael Fogus &amp; Chris Houser </span></p><br class="calibre3"/><br class="calibre3"/><p class="calibre1"><img src="images/00089.jpg" class="calibre4"/></p><div class="mbppagebreak"></div><p id="filepos466" class="calibre5"><span class="calibre6"><span class="bold">Copyright </span></span></p><p class="calibre7">For online information and ordering of this and other Manning books, please visit <a href="http://www.manning.com"><span class="calibre8"><span class="underline">www.manning.com</span></span></a>. The publisher offers discounts on this book when ordered in quantity. For more information, please contact </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">     Special Sales Department<br class="calibre3"/>     Manning Publications Co.<br class="calibre3"/>     180 Broad St.<br class="calibre3"/>     Suite 1323<br class="calibre3"/>     Stamford, CT 06901<br class="calibre3"/>     Email: </tt></span><span class="calibre10"><tt class="calibre11"><span class="italic">orders@manning.com</span></tt></span></blockquote><p class="calibre12">©2011 by Manning Publications Co. All rights reserved.</p><p class="calibre5">No part of this publication may be reproduced, stored in a retrieval system, or transmitted, in any form or by means electronic, mechanical, photocopying, or otherwise, without prior written permission of the publisher. </p><p class="calibre5">Many of the designations used by manufacturers and sellers to distinguish their products are claimed as trademarks. Where those designations appear in the book, and Manning Publications was aware of a trademark claim, the designations have been printed in initial caps or all caps. </p><p class="calibre5"><img src="images/00049.jpg" class="calibre13"/> Recognizing the importance of preserving what has been written, it is Manning’s policy to have the books we publish printed on acid-free paper, and we exert our best efforts to that end. Recognizing also our responsibility to conserve the resources of our planet, Manning books are printed on paper that is at least 15 percent recycled and processed without the use of elemental chlorine. </p><p class="calibre5">
</p><br class="calibre3"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><img src="images/00033.jpg" class="calibre17"/></td><td valign="top" class="calibre16"><span class="calibre10">Manning Publications Co.</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Development editor:</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Susan Harkins</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10"> </span>
</td><td valign="top" class="calibre16"><span class="calibre10">180 Broad St.</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Copyeditor:</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Benjamin Berg</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10"> </span>
</td><td valign="top" class="calibre16"><span class="calibre10">Suite 1323</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Typesetter:</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Dottie Marsico</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10"> </span>
</td><td valign="top" class="calibre16"><span class="calibre10">Stamford, CT 06901</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Cover designer:</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Marija Tudor</span>
</td></tr></table><p class="calibre7">ISBN 978-1-935182-64-1</p><p class="calibre5">Printed in the United States of America</p><p class="calibre5">1 2 3 4 5 6 7 8 9 10 – MAL – 16 15 14 13 12 11</p><div class="mbppagebreak"></div><p id="filepos3680" class="calibre5"><span class="calibre18"><span class="bold">Dedication </span></span></p><blockquote class="calibre9">The Joy of Clojure ... <span class="italic">wherein we teach you the joys of Clojure programming.</span></blockquote><blockquote class="calibre9"><span class="italic">We have written this book for you, the adventurous programmer with prior experience in Java or functional programming languages—especially Lisp. Our aim is to enhance your programming knowledge in general, and your understanding of Clojure in particular, by exploring the philosophy, motivations, and semantics of the Clojure programming language.</span></blockquote><div class="mbppagebreak"></div><p id="filepos4307" class="calibre5"><span class="calibre6"><span class="bold">Brief Table of Contents</span></span></p><blockquote class="calibre19"><a href="#filepos466"><span class="calibre8"><span class="underline">Copyright</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos4307"><span class="calibre8"><span class="underline">Brief Table of Contents</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos8993"><span class="calibre8"><span class="underline">Table of Contents</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos63754"><span class="calibre8"><span class="underline">Foreword</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos68289"><span class="calibre8"><span class="underline">Preface</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos71697"><span class="calibre8"><span class="underline">Acknowledgments</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos75292"><span class="calibre8"><span class="underline">About This Book</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos105806"><span class="calibre8"><span class="underline">1. Foundations</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos106322"><span class="calibre8"><span class="underline">Chapter 1. Clojure philosophy</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos163683"><span class="calibre8"><span class="underline">Chapter 2. Drinking from the Clojure firehose</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos235819"><span class="calibre8"><span class="underline">Chapter 3. Dipping our toes in the pool</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos284570"><span class="calibre8"><span class="underline">2. Data types</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos284964"><span class="calibre8"><span class="underline">Chapter 4. On scalars</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos332652"><span class="calibre8"><span class="underline">Chapter 5. Composite data types</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos428825"><span class="calibre8"><span class="underline">3. Functional programming</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos429362"><span class="calibre8"><span class="underline">Chapter 6. Being lazy and set in your ways</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos485904"><span class="calibre8"><span class="underline">Chapter 7. Functional programming</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos582206"><span class="calibre8"><span class="underline">4. Large-scale design</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos582816"><span class="calibre8"><span class="underline">Chapter 8. Macros</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos642230"><span class="calibre8"><span class="underline">Chapter 9. Combining data and code</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos731329"><span class="calibre8"><span class="underline">Chapter 10. Java.next</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos818901"><span class="calibre8"><span class="underline">Chapter 11. Mutation</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos952172"><span class="calibre8"><span class="underline">5. Tangential considerations</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos952602"><span class="calibre8"><span class="underline">Chapter 12. Performance</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos1001213"><span class="calibre8"><span class="underline">Chapter 13. Clojure changes the way you think</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos1067612"><span class="calibre8"><span class="underline"> Resources</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos1088739"><span class="calibre8"><span class="underline">Index</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos1463166"><span class="calibre8"><span class="underline">List of Figures</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos1479906"><span class="calibre8"><span class="underline">List of Tables</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos1481669"><span class="calibre8"><span class="underline">List of Listings</span></span></a><br class="calibre3"/></blockquote><div class="mbppagebreak"></div><p id="filepos8993" class="calibre5"><span class="calibre6"><span class="bold">Table of Contents</span></span></p><blockquote class="calibre19"><a href="#filepos466"><span class="calibre8"><span class="underline">Copyright</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos4307"><span class="calibre8"><span class="underline">Brief Table of Contents</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos8993"><span class="calibre8"><span class="underline">Table of Contents</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos63754"><span class="calibre8"><span class="underline">Foreword</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos68289"><span class="calibre8"><span class="underline">Preface</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos71697"><span class="calibre8"><span class="underline">Acknowledgments</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos75292"><span class="calibre8"><span class="underline">About This Book</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos105806"><span class="calibre8"><span class="underline">1. Foundations</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos106322"><span class="calibre8"><span class="underline">Chapter 1. Clojure philosophy</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos109937"><span class="calibre8"><span class="underline">1.1. The Clojure way</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos111550"><span class="calibre8"><span class="underline">1.1.1. Simplicity</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos113123"><span class="calibre8"><span class="underline">1.1.2. Freedom to focus</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos114749"><span class="calibre8"><span class="underline">1.1.3. Empowerment</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos117854"><span class="calibre8"><span class="underline">1.1.4. Clarity</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos123793"><span class="calibre8"><span class="underline">1.1.5. Consistency</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos127062"><span class="calibre8"><span class="underline">1.2. Why a(nother) Lisp?</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos128347"><span class="calibre8"><span class="underline">1.2.1. Beauty</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos129728"><span class="calibre8"><span class="underline">1.2.2. Extreme flexibility</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos136000"><span class="calibre8"><span class="underline">1.2.3. Code is data</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos137084"><span class="calibre8"><span class="underline">1.3. Functional programming</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos138757"><span class="calibre8"><span class="underline">1.3.1. A workable definition of functional programming</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos139893"><span class="calibre8"><span class="underline">1.3.2. The implications of functional programming</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos140913"><span class="calibre8"><span class="underline">1.4. Why Clojure isn’t especially object-oriented</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos141542"><span class="calibre8"><span class="underline">1.4.1. Defining terms</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos146638"><span class="calibre8"><span class="underline">1.4.2. Imperative “baked in”</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos148205"><span class="calibre8"><span class="underline">1.4.3. Most of what OOP gives you, Clojure provides</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos161908"><span class="calibre8"><span class="underline">1.5. Summary</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos163683"><span class="calibre8"><span class="underline">Chapter 2. Drinking from the Clojure firehose</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos167160"><span class="calibre8"><span class="underline">2.1. Scalars</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos168247"><span class="calibre8"><span class="underline">2.1.1. Numbers</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos169505"><span class="calibre8"><span class="underline">2.1.2. Integers</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos170661"><span class="calibre8"><span class="underline">2.1.3. Floating-point numbers</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos172112"><span class="calibre8"><span class="underline">2.1.4. Rationals</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos172969"><span class="calibre8"><span class="underline">2.1.5. Symbols</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos173476"><span class="calibre8"><span class="underline">2.1.6. Keywords</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos174203"><span class="calibre8"><span class="underline">2.1.7. Strings</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos174881"><span class="calibre8"><span class="underline">2.1.8. Characters</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos175663"><span class="calibre8"><span class="underline">2.2. Putting things together: collections</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos176090"><span class="calibre8"><span class="underline">2.2.1. Lists</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos178124"><span class="calibre8"><span class="underline">2.2.2. Vectors</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos179004"><span class="calibre8"><span class="underline">2.2.3. Maps</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos180009"><span class="calibre8"><span class="underline">2.2.4. Sets</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos180747"><span class="calibre8"><span class="underline">2.3. Making things happen: functions</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos181130"><span class="calibre8"><span class="underline">2.3.1. Calling functions</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos182516"><span class="calibre8"><span class="underline">2.3.2. Defining functions</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos187018"><span class="calibre8"><span class="underline">2.3.3. Simplifying function definitions with def and defn</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos188967"><span class="calibre8"><span class="underline">2.3.4. In-place functions with #()</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos190361"><span class="calibre8"><span class="underline">2.4. Vars</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos190908"><span class="calibre8"><span class="underline">2.4.1. Declaring bindings using def</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos192948"><span class="calibre8"><span class="underline">2.5. Locals, loops, and blocks</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos193384"><span class="calibre8"><span class="underline">2.5.1. Blocks</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos194137"><span class="calibre8"><span class="underline">2.5.2. Locals</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos195935"><span class="calibre8"><span class="underline">2.5.3. Loops</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos202645"><span class="calibre8"><span class="underline">2.6. Preventing things from happening: quoting</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos203162"><span class="calibre8"><span class="underline">2.6.1. Evaluation</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos205689"><span class="calibre8"><span class="underline">2.6.2. Quoting</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos211278"><span class="calibre8"><span class="underline">2.6.3. Unquote</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos213554"><span class="calibre8"><span class="underline">2.6.4. Unquote-splicing</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos214180"><span class="calibre8"><span class="underline">2.6.5. Auto-gensym</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos215159"><span class="calibre8"><span class="underline">2.7. Leveraging Java via interop</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos216201"><span class="calibre8"><span class="underline">2.7.1. Accessing static class members</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos216992"><span class="calibre8"><span class="underline">2.7.2. Creating Java class instances</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos217899"><span class="calibre8"><span class="underline">2.7.3. Accessing Java instance members with the . operator</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos218764"><span class="calibre8"><span class="underline">2.7.4. Setting Java instance properties</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos219339"><span class="calibre8"><span class="underline">2.7.5. The .. macro</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos221086"><span class="calibre8"><span class="underline">2.7.6. The doto macro</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos222242"><span class="calibre8"><span class="underline">2.7.7. Defining classes</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos222949"><span class="calibre8"><span class="underline">2.8. Exceptional circumstances</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos223301"><span class="calibre8"><span class="underline">2.8.1. A little pitch and catch</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos224797"><span class="calibre8"><span class="underline">2.9. Namespaces</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos225121"><span class="calibre8"><span class="underline">2.9.1. Creating namespaces using ns</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos227295"><span class="calibre8"><span class="underline">2.9.2. Loading other namespaces with :require</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos229279"><span class="calibre8"><span class="underline">2.9.3. Loading and creating mappings with :use</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos232609"><span class="calibre8"><span class="underline">2.9.4. Creating mappings with :refer</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos234007"><span class="calibre8"><span class="underline">2.9.5. Loading Java classes with :import</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos234957"><span class="calibre8"><span class="underline">2.10. Summary</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos235819"><span class="calibre8"><span class="underline">Chapter 3. Dipping our toes in the pool</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos238908"><span class="calibre8"><span class="underline">3.1. Truthiness</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos239485"><span class="calibre8"><span class="underline">3.1.1. What’s truth?</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos240646"><span class="calibre8"><span class="underline">3.1.2. Don’t create Boolean objects</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos243213"><span class="calibre8"><span class="underline">3.1.3. nil versus false</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos244239"><span class="calibre8"><span class="underline">3.2. Nil pun with care</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos248450"><span class="calibre8"><span class="underline">3.3. Destructuring</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos249678"><span class="calibre8"><span class="underline">3.3.1. Your assignment, should you choose to accept it</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos251562"><span class="calibre8"><span class="underline">3.3.2. Destructuring with a vector</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos255272"><span class="calibre8"><span class="underline">3.3.3. Destructuring with a map</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos260119"><span class="calibre8"><span class="underline">3.3.4. Destructuring in function parameters</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos260941"><span class="calibre8"><span class="underline">3.3.5. Destructuring versus accessor methods</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos262019"><span class="calibre8"><span class="underline">3.4. Using the REPL to experiment</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos262663"><span class="calibre8"><span class="underline">3.4.1. Experimenting with seqs</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos265972"><span class="calibre8"><span class="underline">3.4.2. Experimenting with graphics</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos272559"><span class="calibre8"><span class="underline">3.4.3. Putting It All Together</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos274268"><span class="calibre8"><span class="underline">3.4.4. When things go wrong</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos279844"><span class="calibre8"><span class="underline">3.4.5. Just for fun</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos283018"><span class="calibre8"><span class="underline">3.5. Summary</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos284570"><span class="calibre8"><span class="underline">2. Data types</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos284964"><span class="calibre8"><span class="underline">Chapter 4. On scalars</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos288030"><span class="calibre8"><span class="underline">4.1. Understanding precision</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos290389"><span class="calibre8"><span class="underline">4.1.1. Truncation</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos292144"><span class="calibre8"><span class="underline">4.1.2. Promotion</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos294039"><span class="calibre8"><span class="underline">4.1.3. Overflow</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos295453"><span class="calibre8"><span class="underline">4.1.4. Underflow</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos296070"><span class="calibre8"><span class="underline">4.1.5. Rounding errors</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos298944"><span class="calibre8"><span class="underline">4.2. Trying to be rational</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos300109"><span class="calibre8"><span class="underline">4.2.1. Why be rational?</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos302309"><span class="calibre8"><span class="underline">4.2.2. How to be rational</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos304595"><span class="calibre8"><span class="underline">4.2.3. Caveats of rationality</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos305331"><span class="calibre8"><span class="underline">4.3. When to use keywords</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos306126"><span class="calibre8"><span class="underline">4.3.1. How are keywords different from symbols?</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos309412"><span class="calibre8"><span class="underline">4.3.2. Qualifying your keywords</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos312870"><span class="calibre8"><span class="underline">4.4. Symbolic resolution</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos315018"><span class="calibre8"><span class="underline">4.4.1. Metadata</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos316752"><span class="calibre8"><span class="underline">4.4.2. Symbols and namespaces</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos318027"><span class="calibre8"><span class="underline">4.4.3. Lisp-1</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos321046"><span class="calibre8"><span class="underline">4.5. Regular expressions—the second problem</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos322335"><span class="calibre8"><span class="underline">4.5.1. Syntax</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos327466"><span class="calibre8"><span class="underline">4.5.2. Functions</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos330070"><span class="calibre8"><span class="underline">4.5.3. Beware of mutable matchers</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos331343"><span class="calibre8"><span class="underline">4.6. Summary</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos332652"><span class="calibre8"><span class="underline">Chapter 5. Composite data types</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos335390"><span class="calibre8"><span class="underline">5.1. Persistence, sequences, and complexity</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos336264"><span class="calibre8"><span class="underline">5.1.1. “You keep using that word. I do not think it means what you think it means.”</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos339163"><span class="calibre8"><span class="underline">5.1.2. Sequence terms and what they mean</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos348882"><span class="calibre8"><span class="underline">5.1.3. Big-O</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos353970"><span class="calibre8"><span class="underline">5.2. Vectors: creating and using them in all their varieties</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos354795"><span class="calibre8"><span class="underline">5.2.1. Building vectors</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos358828"><span class="calibre8"><span class="underline">5.2.2. Large vectors</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos368638"><span class="calibre8"><span class="underline">5.2.3. Vectors as stacks</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos371400"><span class="calibre8"><span class="underline">5.2.4. Using vectors instead of reverse</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos374577"><span class="calibre8"><span class="underline">5.2.5. Subvectors</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos375857"><span class="calibre8"><span class="underline">5.2.6. Vectors as MapEntries</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos378095"><span class="calibre8"><span class="underline">5.2.7. What vectors aren’t</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos381354"><span class="calibre8"><span class="underline">5.3. Lists: Clojure’s code form data structure</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos382475"><span class="calibre8"><span class="underline">5.3.1. Lists like Lisps like</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos386671"><span class="calibre8"><span class="underline">5.3.2. Lists as stacks</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos387801"><span class="calibre8"><span class="underline">5.3.3. What lists aren’t</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos388921"><span class="calibre8"><span class="underline">5.4. How to use persistent queues</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos390360"><span class="calibre8"><span class="underline">5.4.1. A queue about nothing</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos392907"><span class="calibre8"><span class="underline">5.4.2. Putting things on</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos394769"><span class="calibre8"><span class="underline">5.4.3. Getting things</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos395227"><span class="calibre8"><span class="underline">5.4.4. Taking things off</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos396660"><span class="calibre8"><span class="underline">5.5. Persistent sets</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos397059"><span class="calibre8"><span class="underline">5.5.1. Basic properties of Clojure sets</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos400052"><span class="calibre8"><span class="underline">5.5.2. Keeping your sets in order with sorted-set</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos402031"><span class="calibre8"><span class="underline">5.5.3. contains?</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos403644"><span class="calibre8"><span class="underline">5.5.4. clojure.set</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos408333"><span class="calibre8"><span class="underline">5.6. Thinking in maps</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos409343"><span class="calibre8"><span class="underline">5.6.1. Hash maps</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos413381"><span class="calibre8"><span class="underline">5.6.2. Keeping your keys in order with sorted maps</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos417552"><span class="calibre8"><span class="underline">5.6.3. Keeping your insertions in order with array maps</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos420275"><span class="calibre8"><span class="underline">5.7. Putting it all together: finding the position of items in a sequence</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos422260"><span class="calibre8"><span class="underline">5.7.1. Implementation</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos427722"><span class="calibre8"><span class="underline">5.8. Summary</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos428825"><span class="calibre8"><span class="underline">3. Functional programming</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos429362"><span class="calibre8"><span class="underline">Chapter 6. Being lazy and set in your ways</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos430932"><span class="calibre8"><span class="underline">6.1. On immutability</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos431806"><span class="calibre8"><span class="underline">6.1.1. Defining immutability</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos434761"><span class="calibre8"><span class="underline">6.1.2. Being set in your ways—immutability</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos438527"><span class="calibre8"><span class="underline">6.2. Designing a persistent toy</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos449135"><span class="calibre8"><span class="underline">6.3. Laziness</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos451100"><span class="calibre8"><span class="underline">6.3.1. Familiar laziness with logical-and</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos454343"><span class="calibre8"><span class="underline">6.3.2. Understanding the lazy-seq recipe</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos463850"><span class="calibre8"><span class="underline">6.3.3. Losing your head</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos465791"><span class="calibre8"><span class="underline">6.3.4. Employing infinite sequences</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos468548"><span class="calibre8"><span class="underline">6.3.5. The delay and force macros</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos476519"><span class="calibre8"><span class="underline">6.4. Putting it all together: a lazy quicksort</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos477401"><span class="calibre8"><span class="underline">The Implementation</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos484800"><span class="calibre8"><span class="underline">6.5. Summary</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos485904"><span class="calibre8"><span class="underline">Chapter 7. Functional programming</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos487603"><span class="calibre8"><span class="underline">7.1. Functions in all their forms</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos488662"><span class="calibre8"><span class="underline">7.1.1. First-class functions</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos498652"><span class="calibre8"><span class="underline">7.1.2. Higher-order functions</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos507465"><span class="calibre8"><span class="underline">7.1.3. Pure functions</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos512620"><span class="calibre8"><span class="underline">7.1.4. Named arguments</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos514516"><span class="calibre8"><span class="underline">7.1.5. Constraining functions with pre- and postconditions</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos519998"><span class="calibre8"><span class="underline">7.2. Closures</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos523866"><span class="calibre8"><span class="underline">Functions Returning Closures</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos526022"><span class="calibre8"><span class="underline">Closing Over Parameters</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos527635"><span class="calibre8"><span class="underline">Passing Closures as Functions</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos531643"><span class="calibre8"><span class="underline">Sharing Closure Context</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos543109"><span class="calibre8"><span class="underline">7.3. Thinking recursively</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos544106"><span class="calibre8"><span class="underline">7.3.1. Mundane recursion</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos548820"><span class="calibre8"><span class="underline">7.3.2. Tail calls and recur</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos560143"><span class="calibre8"><span class="underline">7.3.3. Don’t forget your trampoline</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos565545"><span class="calibre8"><span class="underline">7.3.4. Continuation-passing style</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos569849"><span class="calibre8"><span class="underline">7.4. Putting it all together: A* pathfinding</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos570651"><span class="calibre8"><span class="underline">The World</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos571692"><span class="calibre8"><span class="underline">Neighbors</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos575569"><span class="calibre8"><span class="underline">7.4.1. The A* implementation</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos580347"><span class="calibre8"><span class="underline">7.4.2. Notes about the A* implementation</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos581123"><span class="calibre8"><span class="underline">7.5. Summary</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos582206"><span class="calibre8"><span class="underline">4. Large-scale design</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos582816"><span class="calibre8"><span class="underline">Chapter 8. Macros</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos588357"><span class="calibre8"><span class="underline">8.1. Data is code is data</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos592396"><span class="calibre8"><span class="underline">8.1.1. Syntax-quote, unquote, and splicing</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos596516"><span class="calibre8"><span class="underline">8.1.2. Macro rules of thumb</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos598558"><span class="calibre8"><span class="underline">8.2. Defining control structures</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos600221"><span class="calibre8"><span class="underline">8.2.1. Defining control structures without syntax-quote</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos603484"><span class="calibre8"><span class="underline">8.2.2. Defining control structures using syntax-quote and unquoting</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos607261"><span class="calibre8"><span class="underline">8.3. Macros combining forms</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos612355"><span class="calibre8"><span class="underline">8.4. Using macros to change forms</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos621735"><span class="calibre8"><span class="underline">8.5. Using macros to control symbolic resolution time</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos624717"><span class="calibre8"><span class="underline">8.5.1. Anaphora</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos628577"><span class="calibre8"><span class="underline">8.5.2. (Arguably) useful selective name capturing</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos630545"><span class="calibre8"><span class="underline">8.6. Using macros to manage resources</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos634303"><span class="calibre8"><span class="underline">8.7. Putting it all together: macros returning functions</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos641366"><span class="calibre8"><span class="underline">8.8. Summary</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos642230"><span class="calibre8"><span class="underline">Chapter 9. Combining data and code</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos643937"><span class="calibre8"><span class="underline">9.1. Namespaces</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos646681"><span class="calibre8"><span class="underline">9.1.1. Creating namespaces</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos651817"><span class="calibre8"><span class="underline">9.1.2. Expose only what’s needed</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos657392"><span class="calibre8"><span class="underline">9.1.3. Declarative inclusions and exclusions</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos660369"><span class="calibre8"><span class="underline">9.2. Exploring Clojure multimethods with the Universal Design Pattern</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos662250"><span class="calibre8"><span class="underline">9.2.1. The parts</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos665137"><span class="calibre8"><span class="underline">9.2.2. Usage</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos667042"><span class="calibre8"><span class="underline">9.2.3. Multimethods to the rescue</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos669350"><span class="calibre8"><span class="underline">9.2.4. Ad hoc hierarchies for inherited behaviors</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos671470"><span class="calibre8"><span class="underline">9.2.5. Resolving conflict in hierarchies</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos674838"><span class="calibre8"><span class="underline">9.2.6. Arbitrary dispatch for true maximum power</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos677632"><span class="calibre8"><span class="underline">9.3. Types, protocols, and records</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos678564"><span class="calibre8"><span class="underline">9.3.1. Records</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos688662"><span class="calibre8"><span class="underline">9.3.2. Protocols</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos714260"><span class="calibre8"><span class="underline">9.3.3. Building from a more primitive base with deftype</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos718597"><span class="calibre8"><span class="underline">9.4. Putting it all together: a fluent builder for chess moves</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos719711"><span class="calibre8"><span class="underline">9.4.1. Java implementation</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos724064"><span class="calibre8"><span class="underline">9.4.2. Clojure implementation</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos730401"><span class="calibre8"><span class="underline">9.5. Summary</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos731329"><span class="calibre8"><span class="underline">Chapter 10. Java.next</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos735928"><span class="calibre8"><span class="underline">10.1. Generating objects on the fly with proxy</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos737821"><span class="calibre8"><span class="underline">10.1.1. A simple dynamic web service</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos747545"><span class="calibre8"><span class="underline">10.2. Clojure gen-class and GUI programming</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos748075"><span class="calibre8"><span class="underline">10.2.1. Namespaces as class specifications</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos758716"><span class="calibre8"><span class="underline">10.2.2. Exploring user interface design and development with Clojure</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos767521"><span class="calibre8"><span class="underline">10.3. Clojure’s relationship to Java arrays</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos768019"><span class="calibre8"><span class="underline">10.3.1. Types of arrays: primitive and reference</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos774490"><span class="calibre8"><span class="underline">10.3.2. Array mutability</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos777015"><span class="calibre8"><span class="underline">10.3.3. That unfortunate naming convention</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos781224"><span class="calibre8"><span class="underline">10.3.4. Multidimensional arrays</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos782710"><span class="calibre8"><span class="underline">10.3.5. Variadic method/constructor calls</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos783802"><span class="calibre8"><span class="underline">10.4. All Clojure functions implement...</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos784449"><span class="calibre8"><span class="underline">10.4.1. java.util.Comparator</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos786680"><span class="calibre8"><span class="underline">10.4.2. java.lang.Runnable</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos787877"><span class="calibre8"><span class="underline">10.4.3. java.util.concurrent.Callable</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos789320"><span class="calibre8"><span class="underline">10.5. Using Clojure data structures in Java APIs</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos790787"><span class="calibre8"><span class="underline">10.5.1. java.util.List</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos792159"><span class="calibre8"><span class="underline">10.5.2. java.lang.Comparable</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos793612"><span class="calibre8"><span class="underline">10.5.3. java.util.RandomAccess</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos794289"><span class="calibre8"><span class="underline">10.5.4. java.util.Collection</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos796637"><span class="calibre8"><span class="underline">10.5.5. java.util.Set</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos798807"><span class="calibre8"><span class="underline">10.6. definterface</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos799586"><span class="calibre8"><span class="underline">10.6.1. Generating interfaces on the fly</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos804458"><span class="calibre8"><span class="underline">10.7. Be wary of exceptions</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos806018"><span class="calibre8"><span class="underline">10.7.1. A bit of background regarding exceptions</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos808014"><span class="calibre8"><span class="underline">10.7.2. Runtime versus compile-time exceptions</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos814148"><span class="calibre8"><span class="underline">10.7.3. Handling exceptions</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos817094"><span class="calibre8"><span class="underline">10.7.4. Custom exceptions</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos817916"><span class="calibre8"><span class="underline">10.8. Summary</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos818901"><span class="calibre8"><span class="underline">Chapter 11. Mutation</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos823175"><span class="calibre8"><span class="underline">11.1. Software transactional memory with multiversion concurrency control and snapshot isolation</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos824901"><span class="calibre8"><span class="underline">11.1.1. Transactions</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos827930"><span class="calibre8"><span class="underline">11.1.2. Embedded transactions</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos829618"><span class="calibre8"><span class="underline">11.1.3. The things that STM makes easy</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos833159"><span class="calibre8"><span class="underline">11.1.4. Potential downsides</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos834794"><span class="calibre8"><span class="underline">11.1.5. The things that make STM unhappy</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos837442"><span class="calibre8"><span class="underline">11.2. When to use Refs</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos841535"><span class="calibre8"><span class="underline">11.2.1. Coordinated, synchronous change using alter</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos851416"><span class="calibre8"><span class="underline">11.2.2. Commutative change with commute</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos855669"><span class="calibre8"><span class="underline">11.2.3. Vulgar change with ref-set</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos856371"><span class="calibre8"><span class="underline">11.2.4. Fixing write-skew with ensure</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos857832"><span class="calibre8"><span class="underline">11.2.5. Refs under stress</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos862456"><span class="calibre8"><span class="underline">11.3. When to use Agents</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos863646"><span class="calibre8"><span class="underline">11.3.1. In-process versus distributed concurrency models</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos867495"><span class="calibre8"><span class="underline">11.3.2. Controlling I/O with an Agent</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos874840"><span class="calibre8"><span class="underline">11.3.3. The difference between send and send-off</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos879037"><span class="calibre8"><span class="underline">11.3.4. Error handling</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos886372"><span class="calibre8"><span class="underline">11.3.5. When not to use Agents</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos888278"><span class="calibre8"><span class="underline">11.4. When to use Atoms</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos889931"><span class="calibre8"><span class="underline">11.4.1. Sharing across threads</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos891202"><span class="calibre8"><span class="underline">11.4.2. Using Atoms in transactions</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos897207"><span class="calibre8"><span class="underline">11.5. When to use locks</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos900018"><span class="calibre8"><span class="underline">11.5.1. Safe mutation through locking</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos903202"><span class="calibre8"><span class="underline">11.5.2. Using Java’s explicit locks</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos906634"><span class="calibre8"><span class="underline">11.6. When to use futures</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos907702"><span class="calibre8"><span class="underline">11.6.1. Futures as callbacks</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos917093"><span class="calibre8"><span class="underline">11.7. When to use promises</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos918395"><span class="calibre8"><span class="underline">11.7.1. Parallel tasks with promises</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos920882"><span class="calibre8"><span class="underline">11.7.2. Callback API to blocking API</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos923844"><span class="calibre8"><span class="underline">11.7.3. Deterministic deadlocks</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos926896"><span class="calibre8"><span class="underline">11.8. Parallelism</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos927359"><span class="calibre8"><span class="underline">11.8.1. pvalues</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos929858"><span class="calibre8"><span class="underline">11.8.2. pmap</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos931442"><span class="calibre8"><span class="underline">11.8.3. pcalls</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos932992"><span class="calibre8"><span class="underline">11.9. Vars and dynamic binding</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos936275"><span class="calibre8"><span class="underline">11.9.1. The binding macro</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos938809"><span class="calibre8"><span class="underline">11.9.2. Creating a named Var</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos944480"><span class="calibre8"><span class="underline">11.9.3. Creating anonymous Vars</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos945984"><span class="calibre8"><span class="underline">11.9.4. Dynamic scope</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos951111"><span class="calibre8"><span class="underline">11.10. Summary</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos952172"><span class="calibre8"><span class="underline">5. Tangential considerations</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos952602"><span class="calibre8"><span class="underline">Chapter 12. Performance</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos954781"><span class="calibre8"><span class="underline">12.1. Type hints</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos955792"><span class="calibre8"><span class="underline">12.1.1. Advantages of type adornment</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos957246"><span class="calibre8"><span class="underline">12.1.2. Type-hinting arguments and returns</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos961951"><span class="calibre8"><span class="underline">12.1.3. Type-hinting objects</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos962834"><span class="calibre8"><span class="underline">12.2. Transients</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos963334"><span class="calibre8"><span class="underline">12.2.1. Ephemeral garbage</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos965654"><span class="calibre8"><span class="underline">12.2.2. Transients compare in efficiency to mutable collections</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos969517"><span class="calibre8"><span class="underline">12.3. Chunked sequences</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos972808"><span class="calibre8"><span class="underline">12.3.1. Regaining one-at-a-time laziness</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos975700"><span class="calibre8"><span class="underline">12.4. Memoization</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos979309"><span class="calibre8"><span class="underline">12.4.1. Re-examining memoization</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos980680"><span class="calibre8"><span class="underline">12.4.2. A memoization protocol</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos988109"><span class="calibre8"><span class="underline">12.5. Understanding coercion</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos988746"><span class="calibre8"><span class="underline">12.5.1. First rule of coercion: don’t</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos989329"><span class="calibre8"><span class="underline">12.5.2. Corollary: you’re probably not doing it right</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos996017"><span class="calibre8"><span class="underline">12.5.3. Second rule of coercion: don’t</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos996393"><span class="calibre8"><span class="underline">12.5.4. Third rule of coercion: coerce a stable local</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos997905"><span class="calibre8"><span class="underline">12.5.5. Fourth rule of coercion: watch your sizes</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos998286"><span class="calibre8"><span class="underline">12.5.6. Fifth rule of coercion: truncate only as a goal</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos1000351"><span class="calibre8"><span class="underline">12.6. Summary</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos1001213"><span class="calibre8"><span class="underline">Chapter 13. Clojure changes the way you think</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos1003593"><span class="calibre8"><span class="underline">13.1. DSLs</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos1005162"><span class="calibre8"><span class="underline">13.1.1. A ubiquitous DSL</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos1008242"><span class="calibre8"><span class="underline">13.1.2. Putting parentheses around the specification</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos1019273"><span class="calibre8"><span class="underline">13.1.3. A note about Clojure’s approach to DSLs</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos1021032"><span class="calibre8"><span class="underline">13.2. Testing</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos1022542"><span class="calibre8"><span class="underline">13.2.1. Some useful techniques</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos1031355"><span class="calibre8"><span class="underline">13.2.2. Contracts programming</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos1036349"><span class="calibre8"><span class="underline">13.3. A lack of design patterns</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos1037976"><span class="calibre8"><span class="underline">13.3.1. Clojure’s first-class design patterns</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos1045484"><span class="calibre8"><span class="underline">13.4. Error handling and debugging</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos1045900"><span class="calibre8"><span class="underline">13.4.1. Error handling</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos1053902"><span class="calibre8"><span class="underline">13.4.2. Debugging</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos1065349"><span class="calibre8"><span class="underline">13.5. Fare thee well</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos1067612"><span class="calibre8"><span class="underline"> Resources</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre19"><a href="#filepos1067683"><span class="calibre8"><span class="underline">Miscellaneous resources</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos1084542"><span class="calibre8"><span class="underline">Online resources</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos1088739"><span class="calibre8"><span class="underline">Index</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos1463166"><span class="calibre8"><span class="underline">List of Figures</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos1479906"><span class="calibre8"><span class="underline">List of Tables</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre21"><a href="#filepos1481669"><span class="calibre8"><span class="underline">List of Listings</span></span></a><br class="calibre3"/></blockquote><div class="mbppagebreak"></div><p id="filepos63754" class="calibre5"><span class="calibre6"><span class="bold">Foreword </span></span></p><p class="calibre7">The authors of this book have taken an ambitious and aggressive approach to teaching Clojure. You know how everyone loves to say they teach using the “drinking from a fire hydrant” method? Well, at times it feels like these guys are trying to shove that fire hydrant right up... let’s just say it’s a place where you don’t normally put a fire hydrant. This isn’t intended as a first book on programming, and it may not be an ideal first book on Clojure either. The authors assume you’re fearless and, importantly, equipped with a search engine. You’ll want to have Google handy as you go through the examples. The authors blaze through many of the classics of both functional programming and industry programming in a whirlwind tour of Clojure that feels at times more like a class-five tropical storm. You’ll learn fast! </p><p class="calibre5">Our industry, the global programming community, is fashion-driven to a degree that would embarrass haute couture designers from New York to Paris. We’re slaves to fashion. Fashion dictates the programming languages people study in school, the languages employers hire for, the languages that get to be in books on shelves. A naive outsider might wonder if the quality of a language matters a little, just a teeny bit at least, but in the real world fashion trumps all. </p><p class="calibre5">So nobody could be more surprised than I that a Lisp dialect has suddenly become fashionable again. Clojure has only been out for three years, but it’s gaining momentum at a rate that we haven’t seen in a new language in decades. And it doesn’t even have a “killer app” yet, in the way that browsers pushed JavaScript into the spotlight, or Rails propelled Ruby. Or maybe the killer app for Clojure is the JVM itself. Everyone’s fed up with the Java language, but understandably we don’t want to abandon our investment in the Java Virtual Machine and its capabilities: the libraries, the configuration, the monitoring, and all the other entirely valid reasons we still use it. </p><p class="calibre5">For those of us using the JVM or .NET, Clojure feels like a minor miracle. It’s an astoundingly high-quality language, sure—in fact, I’m beginning to think it’s the best I’ve ever seen—yet somehow it has still managed to be fashionable. That’s quite a trick. It gives me renewed hope for the overall future of productivity in our industry. We might just dig ourselves out of this hole we’re in and get back to where every project feels like a legacy-free startup, just like it was in the early days of Java. </p><p class="calibre5">There are still open questions about Clojure’s suitability for production shops, especially around the toolchain. That’s normal and expected for a new language. But Clojure shows so much promise, such beautiful and practical design principles, that everyone seems to be jumping in with both feet anyway. I certainly am. I haven’t had this much fun with a new language since Java arrived on the scene 15 years ago. There have been plenty of pretenders to the JVM throne, languages that promised to take the Java platform to unprecedented new levels. But until now, none of them had the right mix of expressiveness, industrial strength, performance, and just plain fun. </p><p class="calibre5">I think maybe it’s the “fun” part that’s helped make Clojure fashionable.</p><p class="calibre5">In some sense, all this was inevitable, I think. Lisp—the notion of writing your code directly in tree form—is an idea that’s discovered time and again. People have tried all sorts of crazy alternatives, writing code in XML or in opaque binary formats or using cumbersome code generators. But their artificial Byzantine empires always fall into disrepair or crush themselves into collapse while Lisp, the road that wanders through time, remains simple, elegant, and pure. All we needed to get back on that road was a modern approach, and Rich Hickey has given it to us in Clojure. </p><p class="calibre5"><span class="italic">The Joy of Clojure</span> just might help make Clojure as fun for you as it is for us. </p><p class="calibre5">S<span class="italic">TEVE</span> Y<span class="italic">EGGE</span></p><p class="calibre5">G<span class="italic">OOGLE</span></p><p class="calibre5"><a href="http://steve-yegge.blogspot.com"><span class="calibre8"><span class="underline">steve-yegge.blogspot.com</span></span></a></p><div class="mbppagebreak"></div><p id="filepos68289" class="calibre5"><span class="calibre6"><span class="bold">Preface </span></span></p><p class="calibre7">To fully appreciate Clojure, we hearken back to Paul Graham’s essay “Beating the Averages,” an interesting look at the inner workings of his company Viaweb during the years prior to being bought by Yahoo! Inc. in 1998. Though interesting as survey of startup culture, the truly memorable part of the essay was the description of how Viaweb used the programming language Lisp as an advantage over its competition. How could a programming language more than 50 years old provide <span class="italic">any</span> market advantage over Viaweb’s competitors, who were surely using modern enterprise technologies? Without repeating the exact terms of the essay, Graham makes a compelling case for the capability of Lisp to facilitate a more agile programming environment. </p><p class="calibre5">Clojure is a dialect of Lisp directly supporting concurrent software development using functional programming techniques, and like the Lisp described in “Beating the Averages,” provides an environment conducive to agility. Clojure fosters agility in ways that many popular programming languages can’t. Many programming languages are bewitched with most or all of the following: </p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24">Verbosity</li><li value="2" class="calibre24">Unavoidable boilerplate</li><li value="3" class="calibre24">A long thought-code-feedback loop</li><li value="4" class="calibre24">Incidental complexity</li><li value="5" class="calibre24">Difficulties in extension</li><li value="6" class="calibre24">Deficiencies in supporting crucial programming paradigms</li></ul><p class="calibre5">In contrast, Clojure provides a mixture of power and practicality fostering rapid development cycles. But the benefits of Clojure don’t stop with its agile nature—as the clarion call declares, “Multicore is the new hot topic” (Mache Creeger in <span class="italic">ACM Queue</span>, vol. 3, no. 7). </p><p class="calibre5">Though the idea of multicore processors isn’t in itself new, its importance is becoming increasingly focused. Until recently, you could avoid concurrent and parallel programming techniques and instead ride the ever-quickening processor wave to better performance. Well, that ride is slowing to a stop, and Clojure is here to help. </p><p class="calibre5">Clojure provides a unique mix of functional programming and <span class="italic">host symbiosis</span>—an embrace of and direct support for its host platform, in this case the Java Virtual Machine. Additionally, the simplification and often elimination of the complexities involved in coordinated state change have positioned Clojure as an important language moving forward. All software developers must eventually address these problems as a matter of course, and the study, understanding, and eventual utilization of Clojure is an essential path toward conquering them. From topics such as software transactional memory to laziness to immutability, this book will guide you on your way to understanding the “why” of Clojure, in addition to the “how.” </p><p class="calibre5">We’ll be your guides into a thoughtful understanding of the joyfulness in Clojure, for we believe its art is prelude to a new age of software development. </p><div class="mbppagebreak"></div><p id="filepos71697" class="calibre5"><span class="calibre6"><span class="bold">Acknowledgments </span></span></p><p class="calibre7">The authors would like to jointly thank Rich Hickey, the creator of Clojure, for his thoughtful creation, furthering the state of the art in language design. Without his hard work, devotion, and vision, this book would never have been. </p><p class="calibre5">We’d also like to thank the brilliant members of the young Clojure community, including but not limited to: Stuart Halloway, David Edgar Liebke, Christophe Grand, Chas Emerick, Meikel Brandmeyer, Brian Carper, Bradford Cross, Sean Devlin, Tom Faulhaber, Stephen Gilardi, Phil Hagelberg, Konrad Hinsen, George Jahad, David Miller, David Nolen, Laurent Petit, and Stuart Sierra. Finally, we’d like to thank a few early adopters who took the time to provide thoughtful feedback, including Jürgen Hötzel, Robert “Uncle Bob” Martin, Grant Michaels, Mangala Sadhu Sangeet Singh Khalsa, and Sam Aaron. And finally, we would like to thank Steve Yegge for agreeing to write the foreword and for inspiring us over the years. </p><p class="calibre5">Manning sent out the manuscript for peer review at different stages of its development and we would like to thank the following reviewers for their invaluable feedback: Art Gittleman, Stuart Caborn, Jeff Sapp, Josh Heyer, Dave Pawson, Andrew Oswald, Federico Tomassetti, Matt Revelle, Rob Friesel, David Liebke, Pratik Patel, Phil Hagelberg, Rich Hickey, Andy Dingley, Baishampayan Ghose, Chas Emerick, John D’Emic, and Philipp K. Janert. </p><p class="calibre5">Thanks also to the team at Manning for their guidance and support, starting with publisher Marjan Bace, associate publisher Michael Stephens, our development editor Susan Harkins, and the production team of Nicholas Chase, Benjamin Berg, Katie Tennant, Dottie Marsico, and Mary Piergies. And again to Christophe Grand for a final technical review of the mansucript during production. </p><p class="calibre5"><span class="calibre18"><span class="bold">Fogus </span></span></p><p class="calibre7">I’d like to thank my beautiful wife Yuki for her unwavering patience during the writing of this book. Without her I would’ve never made it through. I also owe a great debt to Chris Houser, my coauthor and friend, for teaching me more about Clojure than I ever would’ve thought possible. I’d also like to thank Dr. Larry Albright for introducing me to Lisp and the late Dr. Russel E. Kacher for inspiring in me a passion for learning, curiosity, and reflection. Additionally, I’d like to thank the organizers of the National Capital Area Clojure Users Group—Matthew Courtney, Russ Olsen, and Gray Herter—for providing a place for others in the DC area to discover Clojure. Finally, I’d like to thank my boys Keita and Shota for teaching me the true meaning of love and that it’s not always about me. </p><p class="calibre5"><span class="calibre18"><span class="bold">Chouser </span></span></p><p class="calibre7">My most grateful thanks go to God, the source of all good things. To my parents, thanks for your love and support—your spirit of exploration launched me on a life of wonderful adventure. To my brother Bill, thanks for my earliest introduction to computers and the joys and challenges of programming. To my wife Heather, thanks for your constant encouragement from the very first moments of this book project to the last. To my friend and coauthor Michael Fogus, thanks for the brilliant inspiration and stunning breadth of knowledge you’ve brought to these pages. </p><div class="mbppagebreak"></div><p id="filepos75292" class="calibre5"><span class="calibre6"><span class="bold">About This Book </span></span></p><p class="calibre5"><span class="calibre18"><span class="bold">Why learn Clojure? </span></span></p><blockquote class="calibre9"><span class="italic">The only difference between Shakespeare and you was the size of his idiom list—not the size of his vocabulary.</span></blockquote><blockquote class="calibre25"><span class="italic">Alan Perlis</span></blockquote><p class="calibre5">When this book was conceived, our first instinct was to create a comprehensive comparison between Clojure and its host language, Java. After further reflection, we reached the conclusion that such an approach would be disingenuous at best, and disastrous at worst. Granted, some points of comparison can’t be avoided, but Java is very different from Clojure and to try and distort one to explain the other would respect neither. Therefore, we decided that a better approach would be to focus on “The Clojure Way” of writing code. </p><p class="calibre5">When we become familiar with a programming language, the idioms and constructs of that language serve to define the way we think about and solve programming tasks. It’s therefore natural that when faced with an entirely new language, we find comfort in mentally mapping the new language onto the familiar old. But we plead with you to leave all of your baggage behind; be you from Java, Lisp, Scheme, C#, or Befunge, we ask you to bear in mind that Clojure is its own language and begs an adherence to its own set of idioms. You’ll discover concepts that you can connect between Clojure and languages you already know, but don’t assume that similar things are entirely the same. </p><p class="calibre5">We’ll work hard to guide you through the features and semantics of Clojure to help you build the mental model needed to use the language effectively. Most of the samples in this book are designed to be run in Clojure’s interactive programming environment, commonly known as the <span class="italic">Read-Eval-Print Loop</span>, or <span class="italic">REPL</span>, an extremely powerful environment for experimentation and rapid prototyping. </p><p class="calibre5">By the time you’re done with this book, the Clojure way of thinking about and solving problems will be another comfortable tool in your toolbox. If we succeed, then not only will you be a better Clojure programmer, but you’ll also start seeing your programming language of choice—be it Java, C#, Python, Ruby, J, or Haskell—in an entirely different light. This reassessment of topics that we often take for granted is essential for personal growth. </p><p class="calibre5"><span class="calibre18"><span class="bold">Who should read this book? </span></span></p><blockquote class="calibre9"><span class="italic">Paths are made by walking.</span></blockquote><blockquote class="calibre25"><span class="italic">Franz Kafka</span></blockquote><p class="calibre5">This book isn’t a beginner’s guide to Clojure. We start fast and don’t devote much space to establishing a running Clojure environment, although we do provide some guidance on page xxix. Additionally, this isn’t a book about Clojure’s implementation details, but instead one about its semantical details. This is also not a “cookbook” for Clojure, but instead a thorough investigation into the ingredients that Clojure provides for creating beautiful software. Often we’ll explain how these ingredients mix and why they make a great match, but you won’t find complete recipes for systems. Our examples directly address the discussion at hand and at times leave exposed wiring for you to extend and thus further your own knowledge. It wouldn’t serve us, you, or Clojure to try to awkwardly mold a comprehensive lesson into the guise of a book-length project. Often, language books spend valuable time halfheartedly explaining “real-world” matters totally unrelated to the language itself, and we wish to avoid this trap. We strongly feel that if we show you the “why” of the language, then you’ll be better prepared to take that knowledge and apply it to your real-world problems. In short, if you’re looking for a book amenable to neophytes that will also show you how to migrate Clojure into existing codebases, connect to NoSQL databases, and explore other “real-world” topics, then we recommend the book <span class="italic">Clojure in Action</span> by Amit Rathore (Manning, 2011). </p><p class="calibre5">Having said all of that, we do provide a short introduction to the language and feel that for those of you willing to work hard to understand Clojure, this is indeed the book for you. Additionally, if you already have a background in Lisp programming, then much of the introductory material will be familiar, thus making this book ideal for you. Though by no means perfect, Clojure has a nice combination of features that fit together into a coherent system for solving programming problems. The way Clojure encourages you to think about problems may be different than you’re used to, requiring a bit of work to “get.” But once you cross that threshold, you too may experience a kind of euphoria, and in this book we’ll help you get there. These are exciting times, and Clojure is the language we hope you’ll agree is an essential tool for navigating into the future. </p><p class="calibre5"><span class="calibre18"><span class="bold">Roadmap </span></span></p><p class="calibre7">We’re going to take you on a journey. Perhaps you’ve started on this journey yourself by exploring Clojure beforehand. Perhaps you’re a seasoned Java or Lisp veteran and are coming to Clojure for the first time. Perhaps you’re coming into this book from an entirely different background. In any case, we’re talking to you. This is a self-styled book for the adventurous and will require that you leave your baggage behind and approach the enclosed topics with an open mind. In many ways, Clojure will change the way you view programming, and in other ways it’ll obliterate your preconceived notions. The language has a lot to say about how software should be designed and implemented, and we’ll touch on these topics one by one throughout this book. </p><p class="calibre5"><span class="bold">Foundations </span></p><p class="calibre7">Every so often, a programming language comes along that can be considered foundational. Occasionally a language is invented that shakes the foundations of the software industry and dispels the collective preconceived notions of “good software practices.” These foundational programming languages always introduce a novel approach to software development, alleviating if not eliminating the difficult problems of their time. Any list of foundational languages inevitably raises the ire of language proponents who feel their preferences shouldn’t be ignored. But we’re willing to take this risk and therefore list the following programming languages in this category. </p><p class="calibre5"><span class="bold">Foundational programming languages</span></p><br class="calibre3"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><th scope="col" valign="top" class="calibre26"><p class="calibre27"><span class="calibre10"><span class="bold">Year</span></span></p></th><th scope="col" valign="top" class="calibre26"><p class="calibre27"><span class="calibre10"><span class="bold">Language</span></span></p></th><th scope="col" valign="top" class="calibre26"><p class="calibre27"><span class="calibre10"><span class="bold">Inventor(s)</span></span></p></th><th scope="col" valign="top" class="calibre26"><p class="calibre27"><span class="calibre10"><span class="bold">Interesting reading</span></span></p></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">1957</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Fortran</span>
</td><td valign="top" class="calibre16"><span class="calibre10">John Backus</span>
</td><td valign="top" class="calibre16"><span class="calibre10">John Backus, “The History of Fortran I, II, and III,” </span><span class="calibre10"><span class="italic">IEEE Annals of the History of Computing</span></span><span class="calibre10"> 20, no. 4 (1998). </span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">1958</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Lisp</span>
</td><td valign="top" class="calibre16"><span class="calibre10">John McCarthy</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Richard P. Gabriel and Guy L. Steele Jr., “The Evolution of Lisp” (1992), </span><a href="http://www.dreamsongs.com/Files/HOPL2-Uncut.pdf"><span class="calibre10"><span class="calibre8"><span class="underline">www.dreamsongs.com/Files/HOPL2-Uncut.pdf</span></span></span></a><span class="calibre10">. </span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">1959</span>
</td><td valign="top" class="calibre16"><span class="calibre10">COBOL</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Design by committee</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Edsger Dijkstra, “EWD 498: How Do We Tell Truths That Might Hurt?” in </span><span class="calibre10"><span class="italic">Selected Writings on Computing: A Personal Perspective</span></span><span class="calibre10"> (New York: Springer-Verlag, 1982). </span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">1968</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Smalltalk</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Alan Kay</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Adele Goldberg, </span><span class="calibre10"><span class="italic">Smalltalk-80: The Language and Its Implementation</span></span><span class="calibre10"> (Reading, MA: Addison-Wesley, 1983). </span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">1972</span>
</td><td valign="top" class="calibre16"><span class="calibre10">C</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Dennis Ritchie</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Brian W. Kernighan and Dennis M. Ritchie, </span><span class="calibre10"><span class="italic">The C Programming Language</span></span><span class="calibre10"> (Englewood Cliffs, NJ: Prentice Hall, 1988). </span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">1972</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Prolog</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Alain Colmerauer</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Ivan Bratko, </span><span class="calibre10"><span class="italic">PROLOG: Programming for Artificial Intelligence</span></span><span class="calibre10"> (New York: Addison-Wesley, 2000). </span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">1975</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Scheme</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Guy Steele and Gerald Sussman</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Guy Steele and Gerald Sussman, the “Lambda Papers,” mng.bz/sU33.</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">1983</span>
</td><td valign="top" class="calibre16"><span class="calibre10">C++</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Bjarne Stroustrup</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Bjarne Stroustrup, </span><span class="calibre10"><span class="italic">The Design and Evolution of C++</span></span><span class="calibre10"> (Reading, MA: Addison-Wesley, 1994). </span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">1986</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Erlang</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Telefonaktiebolaget L. M. Ericsson</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Joe Armstrong, “A History of Erlang,” </span><span class="calibre10"><span class="italic">Proceedings of the Third ACM SIGPLAN Conference on History of Programming Languages</span></span><span class="calibre10"> (2007). </span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">1987</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Perl</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Larry Wall</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Larry Wall, Tom Christiansen, and Jon Orwant, </span><span class="calibre10"><span class="italic">Programming Perl</span></span><span class="calibre10"> (Cambridge, MA: O’Reilly, 2000). </span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">1990</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Haskell</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Simon Peyton Jones</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Miran Lipovača, “Learn You a Haskell for Great Good!” </span><a href="http://learnyouahaskell.com/"><span class="calibre10"><span class="calibre8"><span class="underline">http://learnyouahaskell.com/</span></span></span></a><span class="calibre10">. </span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">1995</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Java</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Sun Microsystems</span>
</td><td valign="top" class="calibre16"><span class="calibre10">David Bank, “The Java Saga,” </span><span class="calibre10"><span class="italic">Wired</span></span><span class="calibre10"> 3.12 (1995). </span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">2007</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Clojure?</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Rich Hickey</span>
</td><td valign="top" class="calibre16"><span class="calibre10">You’re reading it.</span>
</td></tr></table><p class="calibre7">Like them or not, there’s little dispute that the listed programming languages have greatly influenced the way that software is constructed. Whether Clojure should be included in this category remains to be seen, but Clojure does borrow heavily from many of the foundational languages and also from other influential programming languages to boot. </p><p class="calibre5"><a href="#filepos106322"><span class="calibre8"><span class="underline">Chapter 1</span></span></a> starts our journey and provides some of the core concepts embraced by Clojure. These concepts should be well understood by the time you’ve finished the chapter. Along the way, we’ll show illustrative code samples highlighting the concepts at hand (and sometimes even pretty pictures). Much of what’s contained in <a href="#filepos106322"><span class="calibre8"><span class="underline">chapter 1</span></span></a> can be deemed “The Clojure Philosophy,” so if you’ve ever wondered what inspired and constitutes Clojure, we’ll provide that for you. </p><p class="calibre5"><a href="#filepos163683"><span class="calibre8"><span class="underline">Chapter 2</span></span></a> provides a fast introduction to specific features and syntax of Clojure. </p><p class="calibre5"><a href="#filepos235819"><span class="calibre8"><span class="underline">Chapter 3</span></span></a> will address general Clojure programming idioms that aren’t easily categorized. From matters of truthiness and style to considerations of packaging and <tt class="calibre11">nil</tt>, <a href="#filepos235819"><span class="calibre8"><span class="underline">chapter 3</span></span></a> is a mixed bag. All of the topics are important in their own right, and to understand them is in many ways a start to understanding a large portion of idiomatic Clojure source code. </p><p class="calibre5"><span class="bold">Data Types </span></p><p class="calibre7">The discussion on scalar data types in <a href="#filepos284964"><span class="calibre8"><span class="underline">chapter 4</span></span></a> will be relatively familiar to most programmers, but some important points beg our attention, arising from Clojure’s interesting nature as a functional programming language hosted on the Java Virtual Machine. Java programmers reading this book will recognize the points made concerning numerical precision (<a href="#filepos288030"><span class="calibre8"><span class="underline">section 4.1</span></span></a>), and Lisp programmers will recognize the discussion on Lisp-1 versus Lisp-2 (<a href="#filepos312870"><span class="calibre8"><span class="underline">section 4.4</span></span></a>). Programmers will appreciate the practical inclusion of regular expressions as first-class syntactical elements (<a href="#filepos321046"><span class="calibre8"><span class="underline">section 4.5</span></span></a>). Finally, long-time Clojure programmers may find that the discussion of rationals and keywords (sections 4.2 and 4.3, respectively) sheds new light on these seemingly innocent types. Regardless of your background, <a href="#filepos284964"><span class="calibre8"><span class="underline">chapter 4</span></span></a> will provide crucial information in understanding the nature of Clojure’s underappreciated scalar types. </p><p class="calibre5">Clojure’s novel persistent data structures will be covered in <a href="#filepos332652"><span class="calibre8"><span class="underline">chapter 5</span></span></a>; this should be enlightening to anyone wishing to look more deeply into them. Persistent data structures lie at the heart of Clojure’s programming philosophy and <span class="italic">must</span> be understood to fully grasp the implications of Clojure’s design decisions. We’ll only touch briefly on the implementation details of these persistent structures, because they’re less important than understanding why and how to use them. </p><p class="calibre5"><span class="bold">Functional Programming </span></p><p class="calibre7"><a href="#filepos429362"><span class="calibre8"><span class="underline">Chapter 6</span></span></a> will deal with the nebulous notions of immutability, persistence, and laziness. We’ll explore Clojure’s use of immutability as the key element in supporting concurrent programming. We’ll likewise show how, in the presence of immutability, many of the problems associated with coordinated state change disappear. Regarding laziness, we’ll explore the ways that Clojure leverages it to reduce the memory footprint and speed execution times. Finally, we’ll cover the interplay between immutability and laziness. For programmers coming from languages that allow unconstrained mutation and strict evaluation of expressions, <a href="#filepos429362"><span class="calibre8"><span class="underline">chapter 6</span></span></a> may prove to be an initially mind-bending experience. But with this mind-bending comes enlightenment, and you’ll likely never view your preferred programming languages in the same light. </p><p class="calibre5"><a href="#filepos485904"><span class="calibre8"><span class="underline">Chapter 7</span></span></a> will tackle Clojure’s approach to functional programming full-on. For those of you coming from a functional programming background, much of the chapter will be familiar, although Clojure will present its own unique blend. But like every programming language dubbed “functional,” Clojure’s implementation will provide a different lens by which to view your previous experience. For those of you wholly unfamiliar with functional programming techniques, <a href="#filepos485904"><span class="calibre8"><span class="underline">chapter 7</span></span></a> will likely be mind-bending. In coming from a language that centers on object hierarchies and imperative programming techniques, the notion of functional programming seems alien. But we believe Clojure’s decision to base its programming model in the functional paradigm to be the correct one, and we hope that you’ll agree. </p><p class="calibre5"><span class="bold">Large-Scale Design </span></p><p class="calibre7">Clojure can be used as the primary language for any application scale, and the discussion of macros in <a href="#filepos582816"><span class="calibre8"><span class="underline">chapter 8</span></span></a> might change your ideas regarding how to develop software. Clojure as a Lisp embraces macros, and we’ll lead you through the process of understanding them and realizing that with great power comes great responsibility. </p><p class="calibre5">In <a href="#filepos642230"><span class="calibre8"><span class="underline">chapter 9</span></span></a>, we’ll guide you through the use of Clojure’s built-in mechanisms for combining and relating code and data. From namespaces to multimethods to types and protocols, we’ll explain how Clojure fosters the design and implementation of large-scale applications. </p><p class="calibre5">Clojure is a symbiotic programming language, meaning that it’s intended to run atop a host environment. For now, the host of choice is the Java Virtual Machine, but the future bodes well for Clojure becoming host-agnostic. In any case, Clojure provides top-notch functions and macros for interacting directly with the host platform. In <a href="#filepos731329"><span class="calibre8"><span class="underline">chapter 10</span></span></a>, we’ll discuss the ways that Clojure interoperates with its host, focusing on the JVM throughout. </p><p class="calibre5">Clojure is built to foster the sane management of program state, which in turn facilitates concurrent programming, as you’ll see in <a href="#filepos818901"><span class="calibre8"><span class="underline">chapter 11</span></span></a>. Clojure’s simple yet powerful state model alleviates most of the headaches involved in such complicated tasks, and we’ll show you how and why to use each. Additionally, we’ll address the matters not directly solved by Clojure, such as how to identify and reduce those elements that should be protected using Clojure’s reference types. </p><p class="calibre5"><span class="bold">Tangential Considerations </span></p><p class="calibre7">The final part of this book will discuss topics that are equally important: the design and development of your application viewed through the lens of the Clojure Philosophy. In <a href="#filepos952602"><span class="calibre8"><span class="underline">chapter 12</span></span></a>, we’ll discuss ways to improve your application’s performance in single-threaded applications. Clojure provides many mechanisms for improving performance, and we’ll delve into each, including their usage and caveats where applicable. And to wrap up our book, in <a href="#filepos1001213"><span class="calibre8"><span class="underline">chapter 13</span></span></a>, we’ll address the ways that Clojure changes the ways that you look at tangential development activities, such as the definition of your application domain language, testing, error-handling, and debugging. </p><p class="calibre5"><span class="calibre18"><span class="bold">Code conventions </span></span></p><p class="calibre7">The source code used throughout this book is formatted in a straightforward and pragmatic fashion. Any source code listings inlined within the text, for example <tt class="calibre11">(:lemonade :fugu)</tt>, will be formatted using a <tt class="calibre11">fixed-width font</tt> and highlighted. Source code snippets outlined as blocks of code will be offset from the left margin, formatted in a <tt class="calibre11">fixed-width font</tt>, and highlighted to stand out: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def population {::zombies 2700 ::humans 9})<br class="calibre3"/>(def per-capita (/ (population ::zombies) (population ::humans)))<br class="calibre3"/>(println per-capita "zombies for every human!")</tt></span></blockquote><p class="calibre12">Whenever a source code snippet indicates the result of an expression, the result will be prefixed by the characters <tt class="calibre11">;=&gt;</tt>. This particular sequence serves a threefold purpose: </p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24">It helps the result stand out from the code expressions.</li><li value="2" class="calibre24">It indicates a Clojure comment.</li><li value="3" class="calibre24">Because of this, whole code blocks can be easily copied from an EBook or PDF version of this book and pasted into a running Clojure REPL: <br class="calibre3"/><tt class="calibre11">(def population {::zombies 2700 ::humans 9})</tt><br class="calibre3"/><tt class="calibre11">(/ (population ::zombies) (population ::humans))</tt><br class="calibre3"/><tt class="calibre11">;=&gt; 300</tt>
</li></ul><p class="calibre5">Additionally, any expected display in the REPL that’s not a returned value (such as exceptions or printouts) will be denoted with a leading ; prior to the actual return value: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(println population)<br class="calibre3"/>; {:user/zombies 2700, :user/humans 9}<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p class="calibre12">In the previous example, the map displayed as <tt class="calibre11">{:user/zombies 2700, :user/humans 9}</tt> is the printed value, whereas <tt class="calibre11">nil</tt> denotes the returned value from the <tt class="calibre11">println</tt> function. If no return value is shown after an expression, then you can assume that it’s either <tt class="calibre11">nil</tt> or negligible to the example at hand. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre28"><span class="calibre10"><span class="bold">Reading Clojure Code</span></span></p><p class="calibre5">When reading Clojure code, skim it when reading left-to-right, paying just enough attention to note important bits of context (<tt class="calibre11">defn</tt>, <tt class="calibre11">binding</tt>, <tt class="calibre11">let</tt>, and so on). When reading from the inside out, pay careful attention to what each expression returns to be passed to the next outer function. This is much easier than trying to remember the whole outer context when reading the innermost expressions. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">All code formatted as either inline or block-level is intended to be typed or pasted exactly as written into Clojure source files or a REPL. We generally won’t show the Clojure prompt <tt class="calibre11">user&gt;</tt> because it’ll cause copy/paste to fail. Finally, we’ll at times use the ellipsis <tt class="calibre11">...</tt> to indicate an elided result or printout. </p><p class="calibre5">Code annotations accompany many of the listings, highlighting important concepts. In some cases, numbered bullets link to explanations that follow the listing. </p><p class="calibre5"><span class="calibre18"><span class="bold">Getting Clojure </span></span></p><p class="calibre7">If you don’t currently have Clojure, then we recommend you retrieve the Clojure REPL package (Cljr) created by David Edgar Liebke, located at <a href="http://joyofclojure.com/cljr"><span class="calibre8"><span class="underline">http://joyofclojure.com/cljr</span></span></a> and installing it via the following instructions. </p><p class="calibre5"><span class="bold">Prerequisites </span></p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24">Java version 1.6 and later</li><li value="2" class="calibre24">An Internet connection</li></ul><p class="calibre5"><span class="bold">Instructions </span></p><p class="calibre7">Run the following from your operating system’s console:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">java -jar cljr-installer.jar</tt></span></blockquote><p class="calibre12">If your chosen download method appended a .zip file extension to the Cljr package, then the following is fine:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">java -jar cljr-installer.jar.zip</tt></span></blockquote><p class="calibre12">You’ll see output from Cljr indicating its installation and package download progress. Once it has completed, you’ll see instructions for running Clj similar to the following: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">Cljr has been successfully installed. Add $HOME/.cljr/bin to your PATH:<br class="calibre3"/><br class="calibre3"/>    $ export PATH=$HOME/.cljr/bin:$PATH<br class="calibre3"/><br class="calibre3"/>Run 'cljr help' for a list of available commands.</tt></span></blockquote><p class="calibre12">Following the steps displayed, run Cljr.</p><p class="calibre5"><span class="bold">Repl </span></p><p class="calibre7">The Cljr package runs a Clojure REPL (Read/Eval/Print Loop) for version 1.2.0—the same version corresponding to this book. When you launch the Cljr program, you’ll see the window shown in the figure below. </p><p class="calibre1"><img src="images/00058.jpg" class="calibre29"/></p><p class="calibre5">
</p><p class="calibre5">The Cljr REPL is similar to the stock Clojure REPL, but with additional convenient features as explained at <a href="http://github.com/fogus/cljr"><span class="calibre8"><span class="underline">http://github.com/fogus/cljr</span></span></a>. </p><p class="calibre5">The book won’t proceed under the assumption that you’re using Cljr but will work regardless of your own personal REPL setup—as long as you’re running Clojure version 1.2. </p><p class="calibre5"><span class="bold">Downloading Code Examples </span></p><p class="calibre7">Source code for all working examples in this book is available for download from the publisher’s website at <a href="http://www.manning.com/TheJoyofClojure"><span class="calibre8"><span class="underline">www.manning.com/TheJoyofClojure</span></span></a>. </p><p class="calibre5"><span class="calibre18"><span class="bold">Author Online </span></span></p><p class="calibre7">Purchase of <span class="italic">The Joy of Clojure</span> includes free access to a private web forum run by Manning Publications where you can make comments about the book, ask technical questions, and receive help from the authors and from other users. To access the forum and subscribe to it, point your web browser to <a href="http://www.manning.com/TheJoyofClojure"><span class="calibre8"><span class="underline">www.manning.com/TheJoyofClojure</span></span></a>. This page provides information on how to get on the forum once you are registered, what kind of help is available, and the rules of conduct on the forum. </p><p class="calibre5">Manning’s commitment to our readers is to provide a venue where a meaningful dialogue between individual readers and between readers and the authors can take place. It is not a commitment to any specific amount of participation on the part of the authors, whose contribution to the AO remains voluntary (and unpaid). We suggest you try asking the authors some challenging questions lest their interest stray! </p><p class="calibre5">The Author Online forum and the archives of previous discussions will be accessible from the publisher’s website as long as the book is in print. </p><p class="calibre5"><span class="calibre18"><span class="bold">About the cover illustration </span></span></p><p class="calibre7">The figure on the cover of <span class="italic">The Joy of Clojure</span> is captioned “The Confidence Man,” which, in 19th century France, could mean anything from a healer or medicine man to a card shark or money lender or traveling salesman. The illustration is taken from a 19th-century edition of Sylvain Maréchal’s four-volume compendium of regional dress customs published in France. Each illustration is finely drawn and colored by hand. The rich variety of Maréchal’s collection reminds us vividly of how culturally apart the world’s towns and regions were just 200 years ago. Isolated from each other, people spoke different dialects and languages. In the streets or in the countryside, it was easy to identify where they lived and what their trade or station in life was just by their dress. </p><p class="calibre5">Dress codes have changed since then and the diversity by region, so rich at the time, has faded away. It is now hard to tell apart the inhabitants of different continents, let alone different towns or regions. Perhaps we have traded cultural diversity for a more varied personal life—certainly for a more varied and fast-paced technological life. </p><p class="calibre5">At a time when it is hard to tell one computer book from another, Manning celebrates the inventiveness and initiative of the computer business with book covers based on the rich diversity of regional life of two centuries ago, brought back to life by Maréchal’s pictures. </p><div class="mbppagebreak"></div><p id="filepos105806" class="calibre5"><span class="calibre6"><span class="bold">Part 1. Foundations </span></span><a></a></p><p class="calibre7">Even the most elaborate mansion must begin with a firm if humble foundation. We begin here by pouring a foundation of knowledge on which you’ll be able to build a solid understanding about Clojure’s less familiar ways. This foundation includes, among other things, the philosophy of programming underlying Clojure, sturdy walls of data and functions, and REPLs and nil puns. </p><div class="mbppagebreak"></div><p id="filepos106322" class="calibre5"><span class="calibre6"><span class="bold">Chapter 1. Clojure philosophy </span></span><a></a></p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">This chapter covers</span>
</p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24"><a href="#filepos109937"><span class="calibre8"><span class="underline">The Clojure way</span></span></a></li><a id="filepos106743"></a><li value="2" class="calibre24"><a href="#filepos127062"><span class="calibre8"><span class="underline">Why a(nother) Lisp?</span></span></a></li><li value="3" class="calibre24"><a href="#filepos137084"><span class="calibre8"><span class="underline">Functional programming</span></span></a></li><li value="4" class="calibre24"><a href="#filepos140913"><span class="calibre8"><span class="underline">Why Clojure isn’t especially object-oriented</span></span></a></li></ul><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">Learning a new language generally requires significant investment of thought and effort, and it is only fair that programmers expect each language they consider learning to justify that investment. Clojure was born out of creator Rich Hickey’s desire to avoid many of the complications, both inherent and incidental, of managing state using traditional object-oriented techniques. Thanks to a thoughtful design based in rigorous programming language research, coupled with a fervent look toward practicality, Clojure has blossomed into an important programming language playing an undeniably important role in the current state of the art in language design. On one side of the equation, Clojure utilizes Software Transactional Memory (STM), agents, a clear distinction between identity and value types, arbitrary polymorphism, and functional programming to provide an environment conducive to making sense of state in general, and especially in the face of concurrency. On the other side, Clojure shares a symbiotic relationship with the <a id="filepos108336"></a>Java Virtual Machine, thus allowing prospective developers to avoid the costs of maintaining yet another infrastructure while leveraging existing libraries. </p><p class="calibre5">In the grand timeline of programming language history, Clojure is an infant; but its colloquialisms (loosely translated as “best practices” or idioms) are rooted<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos109352"><span class="calibre33"><span class="calibre8"><span class="underline">1</span></span></span></a><span class="calibre33">]</span></small></sup> in 50 years of Lisp, as well as 15 years of Java history. Additionally, the enthusiastic community that has exploded since its introduction has cultivated its own set of unique idioms. As mentioned in the preface, the idioms of a language help to define succinct representations of more complicated expressions. Although we will certainly cover idiomatic Clojure code, we will also expand into deeper discussions of the “why” of the language itself. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos109352" class="calibre32"><span class="calibre33">1</span></small></sup><span class="calibre10"> While drawing on the traditions of Lisps (in general) and Java, Clojure in many ways stands as a direct challenge to them for change. </span></blockquote><p class="calibre12">In this chapter, we’ll discuss the weaknesses in existing languages that Clojure was designed to address, how it provides strength in those areas, and many of the design decisions Clojure embodies. We’ll also look at some of the ways existing languages have influenced Clojure, and define terms that will be used throughout the book. </p><p id="filepos109937" class="calibre5"><span class="calibre18"><span class="bold">1.1. The Clojure way </span></span></p><p class="calibre7">We’ll start slowly.</p><p class="calibre5">Clojure is an opinionated language—it doesn’t try to cover all paradigms or provide every checklist bullet-point feature. Instead it provides the features needed to solve all kinds of real-world problems the Clojure way. To reap the most benefit from Clojure, you’ll want to write your code with the same vision as the language itself. As we walk through the language features in the rest of the book, we’ll mention not just what a feature does, but why it’s there and how best to take advantage of it. </p><p class="calibre5">But before we get to that, we’ll first take a high-level view of some of Clojure’s most important philosophical underpinnings. <a href="#filepos111024"><span class="calibre8"><span class="underline">Figure 1.1</span></span></a> lists some broad goals that Rich Hickey had in mind while designing Clojure and some of the more specific decisions that are built into the language to support these goals. </p><p id="filepos111024" class="calibre5"><span class="calibre10"><span class="bold">Figure 1.1. Broad goals of Clojure: this figure shows some of the concepts that underlie the Clojure philosophy, and how they intersect. </span></span><a></a></p><p class="calibre1"><img src="images/00055.jpg" class="calibre34"/></p><p class="calibre5">As the figure illustrates, Clojure’s broad goals are formed from a confluence of supporting goals and functionality, which we will touch on in the following subsections. </p><p id="filepos111550" class="calibre5"><span class="bold">1.1.1. Simplicity </span><a></a></p><p class="calibre7">It’s hard to write simple solutions to complex problems. But every experienced programmer has also stumbled on areas where we’ve made things more complex than necessary, what you might call <a id="filepos111837"></a><span class="italic">incidental complexity</span> as opposed to complexity that’s <span class="italic">essential</span> to the task at hand (<a href="#filepos1079289"><span class="calibre8"><span class="underline">Moseley 2006</span></span></a>). Clojure strives to let you tackle complex problems involving a wide variety of data requirements, multiple concurrent threads, independently developed libraries, and so on without adding incidental complexity. It also provides tools reducing what at first glance may seem like essential complexity. The resulting set of features may not always seem simple, especially when they’re still unfamiliar, but as you read through this book we think you’ll come to see how much complexity Clojure helps strip away. </p><p class="calibre5">One example of incidental complexity is the tendency of modern object-oriented languages to require that every piece of runnable code be packaged in layers of class definitions, inheritance, and type declarations. Clojure cuts through all this by championing the <span class="italic">pure function</span>, which takes a few arguments and produces a return value based solely on those arguments. An enormous amount of Clojure is built from such functions, and most applications can be too, which means that there’s less to think about when trying to solve the problem at hand. </p><p id="filepos113123" class="calibre5"><span class="bold">1.1.2. Freedom to focus </span><a></a></p><p class="calibre7">Writing code is often a constant struggle against distraction, and every time a language requires you to think about syntax, operator precedence, or inheritance hierarchies, it exacerbates the problem. Clojure tries to stay out of your way by keeping things as simple as possible, not requiring you to go through a compile-and-run cycle to explore an idea, not requiring type declarations, and so on. It also gives you tools to mold the language itself so that the vocabulary and grammar available to you fit as well as possible to your problem domain—Clojure is <span class="italic">expressive</span>. It packs a punch, allowing you to perform highly complicated tasks succinctly without sacrificing comprehensibility. </p><p class="calibre5">One key to delivering this freedom is a commitment to dynamic systems. Almost everything defined in a Clojure program can be redefined, even while the program is running: functions, multimethods, types, type hierarchies, and even Java method implementations. Though redefining things on the fly might be scary on a production system, it opens a world of amazing possibilities in how you think about writing programs. It allows for more experimentation and exploration of unfamiliar APIs, and it adds an element of fun that can sometimes be impeded by more static languages and long compilation cycles. </p><p class="calibre5">But Clojure’s not just about having fun. The fun is a by-product of giving programmers the power to be more productive than they ever thought imaginable. </p><p id="filepos114749" class="calibre5"><span class="bold">1.1.3. Empowerment </span><a></a></p><p class="calibre7">Some programming languages have been created primarily to demonstrate some nugget of academia or to explore certain theories of computation. Clojure is <span class="italic">not</span> one of these. Rich Hickey has said on numerous occasions that Clojure has value to the degree that it lets you build interesting and useful applications. </p><p id="filepos115164" class="calibre5">To serve this goal, Clojure strives to be practical—a tool for getting the job done. If a decision about some design point in Clojure had to weigh the trade-offs between the practical solution and a clever, fancy, or theoretically pure solution, usually the practical solution won out. Clojure could try to shield you from Java by inserting a comprehensive API between the programmer and the libraries, but this could make the use of third-party Java libraries more clumsy. So Clojure went the other way: direct, wrapper-free, compiles-to-the-same-bytecode access to Java classes and methods. Clojure strings are Java strings; Clojure function calls are Java method calls—it’s simple, direct, and practical. </p><p class="calibre5">The decision to use the Java Virtual Machine (JVM) itself is a clear example of this practicality. The JVM has some technical weaknesses such as startup time, memory usage, and lack of <span class="italic">tail-call optimization<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos116667"><span class="calibre33"><span class="calibre8"><span class="underline">2</span></span></span></a><span class="calibre33">]</span></small></sup></span> (TCO). But it’s also an amazingly practical platform—it’s mature, fast, and widely deployed. It supports a variety of hardware and operating systems and has a staggering number of libraries and support tools available, all of which Clojure can take advantage of because of this supremely practical decision. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos116667" class="calibre32"><span class="calibre33">2</span></small></sup><span class="calibre10"> Don’t worry if you don’t know what tail-call optimization is. Also don’t worry if you </span><span class="calibre10"><span class="italic">do</span></span><span class="calibre10"> know what TCO is and think the JVM’s lack of it is a critical flaw for a Lisp or functional language such as Clojure. All your concerns will be addressed in </span><a href="#filepos543109"><span class="calibre10"><span class="calibre8"><span class="underline">section 7.3</span></span></span></a><span class="calibre10">. Until then, just relax. </span></blockquote><p class="calibre12">With direct method calls, <tt class="calibre11">proxy</tt>, <tt class="calibre11">gen-class</tt>, <tt class="calibre11">gen-interface</tt> (see <a href="#filepos731329"><span class="calibre8"><span class="underline">chapter 10</span></span></a>), <tt class="calibre11">reify</tt>, <tt class="calibre11">definterface</tt>, <tt class="calibre11">deftype</tt>, and <tt class="calibre11">defrecord</tt> (see <a href="#filepos677632"><span class="calibre8"><span class="underline">section 9.3</span></span></a>), Clojure works hard to provide a bevy of interoperability options, all in the name of helping you get your job done. Practicality is important to Clojure, but many other languages are practical as well. You’ll start to see some ways that Clojure really sets itself apart by looking at how it avoids muddles. </p><p id="filepos117854" class="calibre5"><span class="bold">1.1.4. Clarity </span><a></a></p><blockquote class="calibre9"><span class="italic">When beetles battle beetles in a puddle paddle battle and the beetle battle puddle is a puddle in a bottle they call this a tweetle beetle bottle puddle paddle battle muddle.</span></blockquote><blockquote class="calibre25"><span class="italic">Dr. Seuss</span></blockquote><p class="calibre5">Consider what might be described as a simple snippet of code in a language like Python:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">x = [5]<br class="calibre3"/>process(x)<br class="calibre3"/>x[0] = x[0] + 1</tt></span></blockquote><p class="calibre12">After executing this code, what’s the value of <tt class="calibre11">x</tt>? If you assume <tt class="calibre11">process</tt> doesn’t change the contents of <tt class="calibre11">x</tt> at all, it should be <tt class="calibre11">[6]</tt>, right? But how can you make that assumption? Without knowing exactly what <tt class="calibre11">process</tt> does, and whatever function it calls does, and so on, you can’t be sure at all. </p><p class="calibre5">Even if you’re sure <tt class="calibre11">process</tt> doesn’t change the contents of <tt class="calibre11">x</tt>, add multithreading and now you have another whole set of concerns. What if some other thread changes <a id="filepos119072"></a><tt class="calibre11">x</tt> between the first and third lines? Worse yet, what if something is setting <tt class="calibre11">x</tt> at the moment the third line is doing its assignment—are you sure your platform guarantees an atomic write to that variable, or is it possible that the value will be a corrupted mix of multiple writes? We could continue this thought exercise in hopes of gaining some clarity, but the end result would be the same—what you have ends up not being clear at all, but the opposite: a muddle. </p><p class="calibre5">Clojure strives for code clarity by providing tools to ward off several different kinds of muddles. For the one just described, it provides immutable locals and persistent collections, which together eliminate most of the single- and multithreaded issues all at once. </p><p class="calibre5">You can find yourself in several other kinds of muddles when the language you’re using merges unrelated behavior into a single construct. Clojure fights this by being vigilant about separation of concerns. When things start off separated, it clarifies your thinking and allows you to recombine them only when and to the extent that doing so is useful for a particular problem. <a href="#filepos120543"><span class="calibre8"><span class="underline">Table 1.1</span></span></a> contrasts common approaches that merge concepts together in some other languages with separations of similar concepts in Clojure that will be explained in greater detail throughout this book. </p><p id="filepos120543" class="calibre5"><span class="calibre10"><span class="bold">Table 1.1. Separation of concerns in Clojure </span></span><a></a></p><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><th scope="col" valign="top" class="calibre26"><p class="calibre27"><span class="calibre10"><span class="bold">Conflated</span></span></p></th><th scope="col" valign="top" class="calibre26"><p class="calibre27"><span class="calibre10"><span class="bold">Separated</span></span></p></th><th scope="col" valign="top" class="calibre26"><p class="calibre27"><span class="calibre10"><span class="bold">Where</span></span></p></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">Object with mutable fields</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Values </span><span class="calibre10"><span class="italic">from</span></span><span class="calibre10"> identities </span>
</td><td valign="top" class="calibre16"><a href="#filepos284964"><span class="calibre10"><span class="calibre8"><span class="underline">Chapter 4</span></span></span></a><span class="calibre10"> and </span><a href="#filepos335390"><span class="calibre10"><span class="calibre8"><span class="underline">section 5.1</span></span></span></a>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">Class acts as namespace for methods</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Function namespaces </span><span class="calibre10"><span class="italic">from</span></span><span class="calibre10"> type namespaces </span>
</td><td valign="top" class="calibre16"><a href="#filepos598558"><span class="calibre10"><span class="calibre8"><span class="underline">Sections 8.2</span></span></span></a><span class="calibre10"> and </span><a href="#filepos607261"><span class="calibre10"><span class="calibre8"><span class="underline">8.3</span></span></span></a>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">Inheritance hierarchy made of classes</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Hierarchy of names </span><span class="calibre10"><span class="italic">from</span></span><span class="calibre10"> data and functions </span>
</td><td valign="top" class="calibre16"><a href="#filepos582816"><span class="calibre10"><span class="calibre8"><span class="underline">Chapter 8</span></span></span></a>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">Data and methods bound together lexically</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Data objects </span><span class="calibre10"><span class="italic">from</span></span><span class="calibre10"> functions </span>
</td><td valign="top" class="calibre16"><a href="#filepos430932"><span class="calibre10"><span class="calibre8"><span class="underline">Sections 6.1</span></span></span></a><span class="calibre10"> and </span><a href="#filepos438527"><span class="calibre10"><span class="calibre8"><span class="underline">6.2</span></span></span></a><span class="calibre10"> and </span><a href="#filepos582816"><span class="calibre10"><span class="calibre8"><span class="underline">chapter 8</span></span></span></a>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">Method implementations embedded throughout class inheritance chain</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Interface declarations </span><span class="calibre10"><span class="italic">from</span></span><span class="calibre10"> function implementations </span>
</td><td valign="top" class="calibre16"><a href="#filepos598558"><span class="calibre10"><span class="calibre8"><span class="underline">Sections 8.2</span></span></span></a><span class="calibre10"> and </span><a href="#filepos607261"><span class="calibre10"><span class="calibre8"><span class="underline">8.3</span></span></span></a>
</td></tr></table><p class="calibre7">It can be hard at times to tease apart these concepts in our own minds, but accomplishing it can bring remarkable clarity and a sense of power and flexibility that’s worth the effort. With all these different concepts at your disposal, it’s important that the code and data you work with express this variety in a consistent way. </p><p id="filepos123793" class="calibre5"><span class="bold">1.1.5. Consistency </span><a></a></p><p class="calibre7">Clojure works to provide consistency in two specific ways: consistency of syntax and of data structures.</p><p class="calibre5">Consistency of syntax is about the similarity in form between related concepts. One simple but powerful example of this is the shared syntax of the <tt class="calibre11">for</tt> and <tt class="calibre11">doseq</tt> macros. <a id="filepos124211"></a>They don’t do the same thing—<tt class="calibre11">for</tt> returns a lazy seq whereas <tt class="calibre11">doseq</tt> is for generating side effects—but both support the same mini-language of nested iteration, destructuring, and <tt class="calibre11">:when</tt> and <tt class="calibre11">:while</tt> guards. The similarities stand out when comparing the following examples: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(for [x [:a :b], y (range 5) :when (odd? y)] [x y])<br class="calibre3"/>;=&gt; ([:a 1] [:a 3] [:b 1] [:b 3])<br class="calibre3"/>(doseq [x [:a :b], y (range 5) :when (odd? y)] (prn x y))<br class="calibre3"/>; :a 1<br class="calibre3"/>; :a 3<br class="calibre3"/>; :b 1<br class="calibre3"/>; :b 3<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p class="calibre12">The value of this similarity is having to learn only one basic syntax for both situations, as well as the ease with which you can convert any particular usage of one form to the other if that becomes necessary. </p><p class="calibre5">Likewise, the consistency of data structures is the deliberate design of all of Clojure’s persistent collection types to provide interfaces as similar to each other as possible, as well as to make them as broadly useful as possible. This is actually an extension of the classic Lisp “code is data” philosophy. Clojure data structures aren’t used just for holding large amounts of application data, but also to hold the expression elements of the application itself. They’re used to describe destructuring forms and to provide named options to various built-in functions. Where other object-oriented languages might encourage applications to define multiple incompatible classes to hold different kinds of application data, Clojure encourages the use of compatible map-like objects. </p><p class="calibre5">The benefit of this is that the same set of functions designed to work with Clojure data structures can be applied to all these contexts: large data stores, application code, and application data objects. You can use <tt class="calibre11">into</tt> to build any of these types, <tt class="calibre11">seq</tt> to get a lazy seq to walk through them, <tt class="calibre11">filter</tt> to select elements of any of them that satisfy a particular predicate, and so on. Once you’ve grown accustomed to having the richness of all these functions available everywhere, dealing with a Java or C++ application’s <tt class="calibre11">Person</tt> or <tt class="calibre11">Address</tt> class will feel constraining. </p><p class="calibre5">Simplicity, freedom to focus, empowerment, consistency, and clarity.</p><p class="calibre5">Nearly every element of the Clojure programming language is designed to promote these goals. When writing Clojure code, if you keep in mind the desire to maximize simplicity, empowerment, and the freedom to focus on the real problem at hand, we think you’ll find Clojure provides you the tools you need to succeed. </p><p id="filepos127062" class="calibre5"><span class="calibre18"><span class="bold">1.2. Why a(nother) Lisp? </span></span></p><blockquote class="calibre9"><span class="italic">By relieving the brain of all unnecessary work, a good notation sets it free to concentrate on more advanced problems.</span></blockquote><blockquote class="calibre25"><span class="italic">Alfred North Whitehead</span></blockquote><p id="filepos127416" class="calibre5">Go to any open source project hosting site and perform a search for the term “Lisp interpreter.” You’ll likely get a cyclopean mountain<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos128252"><span class="calibre33"><span class="calibre8"><span class="underline">3</span></span></span></a><span class="calibre33">]</span></small></sup> of results from this seemingly innocuous term. The fact of the matter is that the history of computer science is littered (Fogus 2009) with the abandoned husks of Lisp implementations. Well-intentioned Lisps have come and gone and been ridiculed along the way, and still tomorrow the search results will have grown almost without bounds. Bearing in mind this legacy of brutality, why would anyone want to base their brand-new programming language on the Lisp model? </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos128252" class="calibre32"><span class="calibre33">3</span></small></sup><span class="calibre10"> ...of madness. </span></blockquote><p id="filepos128347" class="calibre35"><span class="bold">1.2.1. Beauty </span><a></a></p><p class="calibre7">Lisp has attracted some of the brightest minds in the history of computer science. But an argument from authority is insufficient, so you shouldn’t judge Lisp on this alone. The real value in the Lisp family of languages can be directly observed through the activity of using it to write applications. The Lisp style is one of expressivity and empowerment, and in many cases outright beauty. Joy awaits the Lisp neophyte. The original Lisp language as defined by John McCarthy in his earth-shattering essay “Recursive Functions of Symbolic Expressions and Their Computation by Machine, Part I” (<a href="#filepos1078083"><span class="calibre8"><span class="underline">McCarthy 1960</span></span></a>) defined the whole language in terms of only seven functions and two special forms: <tt class="calibre11">atom</tt>, <tt class="calibre11">car</tt>, <tt class="calibre11">cdr</tt>, <tt class="calibre11">cond</tt>, <tt class="calibre11">cons</tt>, <tt class="calibre11">eq</tt>, <tt class="calibre11">quote</tt>, <tt class="calibre11">lambda</tt>, and <tt class="calibre11">label</tt>. </p><p class="calibre5">Through the composition of those nine forms, McCarthy was able to describe the whole of computation in a way that takes your breath away. Computer programmers are perpetually in search of beauty, and more often than not, this beauty presents itself in the form of simplicity. Seven functions and two special forms. It doesn’t get more beautiful than that. </p><p id="filepos129728" class="calibre5"><span class="bold">1.2.2. Extreme flexibility </span><a></a></p><p class="calibre7">Why has Lisp persevered for more than 50 years while countless other languages have come and gone? There are probably complex reasons, but chief among them is likely the fact that Lisp as a language genotype (<a href="#filepos1087417"><span class="calibre8"><span class="underline">Tarver 2008</span></span></a>) fosters language flexibility in the extreme. Newcomers to Lisp are sometimes unnerved by its pervasive use of parentheses and prefix notation, which is different than non-Lisp programming languages. The regularity of this behavior not only reduces the number of syntax rules you have to remember, but also makes the writing of macros trivial. We’ll look at macros in more detail in <a href="#filepos582816"><span class="calibre8"><span class="underline">chapter 8</span></span></a>, but to whet your appetite we’ll take a brief look at one now. It’s an example that we’ll get working on in a moment: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn query [max]<br class="calibre3"/>  (SELECT [a b c]<br class="calibre3"/>    (FROM X<br class="calibre3"/>      (LEFT-JOIN Y :ON (= X.a Y.b)))<br class="calibre3"/>    (WHERE (AND (&lt; a 5) (&lt; b ~max)))))</tt></span></blockquote><p id="filepos130968" class="calibre12">We hope some of those words look familiar to you, because this isn’t a book on SQL. Regardless, our point here is that Clojure doesn’t have SQL support built in. The words <tt class="calibre11">SELECT</tt>, <tt class="calibre11">FROM</tt>, and so forth aren’t built-in forms. They’re also not regular functions, because if <tt class="calibre11">SELECT</tt> were, then the use of <tt class="calibre11">a</tt>, <tt class="calibre11">b</tt>, and <tt class="calibre11">c</tt> would be an error, because they haven’t been defined yet. </p><p class="calibre5">So what does it take to define a domain-specific language (DSL) like this in Clojure? Well, it’s not production-ready code and doesn’t tie into any real database servers; but with just one macro and the three functions shown in <a href="#filepos132659"><span class="calibre8"><span class="underline">listing 1.1</span></span></a>, the preceding query returns these handy values: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(query 5)<br class="calibre3"/>;=&gt; ["SELECT a, b, c FROM X LEFT JOIN Y ON (X.a = Y.b)<br class="calibre3"/>         WHERE ((a &lt; 5) AND (b &lt; ?))"<br class="calibre3"/>        [5]]</tt></span></blockquote><p class="calibre12">Note that some words such as <tt class="calibre11">FROM</tt> and <tt class="calibre11">ON</tt> are taken directly from the input expression, whereas others such as <tt class="calibre11">~max</tt> and <tt class="calibre11">AND</tt> are treated specially. The <tt class="calibre11">max</tt> that was given the value <tt class="calibre11">5</tt> when the query was called is extracted from the literal SQL string and provided in a separate vector, perfect for using in a prepared query in a way that will guard against SQL-injection attacks. The <tt class="calibre11">AND</tt> form was converted from the prefix notation of Clojure to the infix notation required by SQL. </p><p id="filepos132659" class="calibre5"><span class="calibre10"><span class="bold">Listing 1.1. A domain-specific language for embedding SQL queries in Clojure </span></span><a></a></p><p class="calibre1"><img src="images/00022.jpg" class="calibre36"/></p><p id="filepos132921" class="calibre5">But the point here isn’t that this is a particularly good SQL DSL—more complete ones are available.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos133779"><span class="calibre33"><span class="calibre8"><span class="underline">4</span></span></span></a><span class="calibre33">]</span></small></sup> Our point is that once you have the skill to easily create a DSL like this, you’ll recognize opportunities to define your own that solve much narrower, application-specific problems than SQL does. Whether it’s a query language for an unusual non-SQL datastore, a way to express functions in some obscure math discipline, or some other application we as authors can’t imagine, having the flexibility to extend the base language like this, without losing access to any of the language’s own features, is a game-changer. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos133779" class="calibre32"><span class="calibre33">4</span></small></sup><span class="calibre10"> One of note is ClojureQL at </span><a href="http://gitorious.org/clojureql"><span class="calibre10"><span class="calibre8"><span class="underline">http://gitorious.org/clojureql</span></span></span></a><span class="calibre10">. </span></blockquote><p class="calibre12">Although we shouldn’t get into too much detail about the implementation, take a brief look at <a href="#filepos132659"><span class="calibre8"><span class="underline">listing 1.1</span></span></a> and follow along as we discuss important aspects of its implementation. </p><p class="calibre5">Reading from the bottom up, you’ll notice the main entry point, the <tt class="calibre11">SELECT</tt> macro. This returns a vector of two items—the first is generated by calling <tt class="calibre11">expand-clause</tt>, which returns the converted query string, whereas the second is another vector of expressions marked by <tt class="calibre11">~</tt> in the input. The <tt class="calibre11">~</tt> is known as <span class="italic">unquote</span> and we discuss its more common uses in <a href="#filepos582816"><span class="calibre8"><span class="underline">chapter 8</span></span></a>. Also note the use of <tt class="calibre11">tree-seq</tt> here to succinctly extract items of interest from a tree of values, namely the input expression. </p><p class="calibre5">The <tt class="calibre11">expand-clause</tt> function takes the first word of a clause, looks it up in the <tt class="calibre11">clause-map</tt>, and calls the appropriate function to do the actual conversion from Clojure s-expression to SQL string. The <tt class="calibre11">clause-map</tt> provides the specific functionality needed for each part of the SQL expression: inserting commas or other SQL syntax, and sometimes recursively calling <tt class="calibre11">expand-clause</tt> when subclauses need to be converted. One of these is the <tt class="calibre11">WHERE</tt> clause, which handles the general conversion of prefix expressions to the infix form required by SQL by delegating to the <tt class="calibre11">expand-expr</tt> function. </p><p class="calibre5">Overall, the flexibility of Clojure demonstrated in this example comes largely from the fact that macros accept code forms, such as the SQL DSL example we showed, and can treat them as data—walking trees, converting values, and more. This works not only because code can be treated as data, but because in a Clojure program, code <span class="italic">is</span> data. </p><p id="filepos136000" class="calibre5"><span class="bold">1.2.3. Code is data </span><a></a></p><p class="calibre7">The notion of “code is data” is difficult to grasp at first. Implementing a programming language where code shares the same footing as its comprising data structures presupposes a fundamental malleability of the language itself. When your language is represented as the inherent data structures, the language itself can manipulate its own <a id="filepos136438"></a>structure and behavior (Graham 1995). You may have visions of Ouroboros after reading the previous sentence, and that wouldn’t be inappropriate, because Lisp can be likened to a self-licking lollypop—more formally defined as <span class="italic">homoiconicity</span>. Lisp’s homoiconicity takes a great conceptual leap in order to fully grasp, but we’ll lead you toward that understanding throughout this book in hopes that you too will come to realize the inherent power. </p><p class="calibre5">There’s a joy in learning Lisp for the first time, and if that’s your experience coming into this book then we welcome you—and envy you. </p><p id="filepos137084" class="calibre5"><span class="calibre18"><span class="bold">1.3. Functional programming </span></span></p><p class="calibre7">Quick, what does <span class="italic">functional programming</span> mean? Wrong answer. </p><p class="calibre5">Don’t be too discouraged, however—we don’t really know the answer either. Functional programming is one of those computing terms<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos138476"><span class="calibre33"><span class="calibre8"><span class="underline">5</span></span></span></a><span class="calibre33">]</span></small></sup> that has a nebulous definition. If you ask 100 programmers for their definition, you’ll likely receive 100 different answers. Sure, some definitions will be similar, but like snowflakes, no two will be exactly the same. To further muddy the waters, the cognoscenti of computer science will often contradict one another in their own independent definitions. Likewise, the basic structure of any definition of functional programming will be different depending on whether your answer comes from someone who favors writing their programs in Haskell, ML, Factor, Unlambda, Ruby, or Qi. How can <span class="italic">any</span> person, book, or language claim authority for functional programming? As it turns out, just as the multitudes of unique snowflakes are all made mostly of water, the core of functional programming across all meanings has its core tenets. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos138476" class="calibre32"><span class="calibre33">5</span></small></sup><span class="calibre10"> Quick, what’s the definition of combinator? How about cloud computing? Enterprise? SOA? Web 2.0? Real-world? Hacker? Often it seems that the only term with a definitive meaning is “yak shaving.” </span></blockquote><p id="filepos138757" class="calibre35"><span class="bold">1.3.1. A workable definition of functional programming </span><a></a></p><p class="calibre7">Whether your own definition of functional programming hinges on the lambda calculus, monadic I/O, delegates, or <tt class="calibre11">java.lang.Runnable</tt>, your basic unit of currency is likely to be some form of procedure, function, or method—herein lies the root. Functional programming concerns and facilitates the application and composition of functions. Further, for a language to be considered functional, its notion of function must be <span class="italic">first-class</span>. The functions of a language must be able to be stored, passed, and returned just like any other piece of data within that language. It’s beyond this core concept that the definitions branch toward infinity, but thankfully, it’s enough to start. Of course, we’ll also present a further definition of Clojure’s style of functional programming that includes such topics as purity, immutability, recursion, laziness, and referential transparency, but those will come later in <a href="#filepos485904"><span class="calibre8"><span class="underline">chapter 7</span></span></a>. </p><p id="filepos139893" class="calibre5"><span class="bold">1.3.2. The implications of functional programming </span><a></a></p><p class="calibre7">Object-oriented programmers and functional programmers will often see and solve a problem in different ways. Whereas an object-oriented mindset will foster the <a id="filepos140178"></a>approach of defining an application domain as a set of nouns (classes), the functional mind will see the solution as the composition or verbs (functions). Though both programmers may in all likelihood generate equivalent results, the functional solution will be more succinct, understandable, and reusable. Grand claims indeed! We hope that by the end of this book you’ll agree that functional programming fosters elegance in programming. It takes a shift in mindset to start from thinking in nouns to arrive at thinking in verbs, but the journey will be worthwhile. In any case, we think there’s much that you can take from Clojure to apply to your chosen language—if only you approach the subject with an open mind. </p><p id="filepos140913" class="calibre5"><span class="calibre18"><span class="bold">1.4. Why Clojure isn’t especially object-oriented </span></span></p><blockquote class="calibre9"><span class="italic">Elegance and familiarity are orthogonal.</span></blockquote><blockquote class="calibre25"><span class="italic">Rich Hickey</span></blockquote><p class="calibre5">Clojure was born out of frustration provoked in large part by the complexities of concurrent programming, complicated by the weaknesses of object-oriented programming in facilitating it. This section explores these weaknesses and lays the groundwork for why Clojure is functional and not object-oriented. </p><p id="filepos141542" class="calibre5"><span class="bold">1.4.1. Defining terms </span><a></a></p><p class="calibre7">Before we begin, it’s useful to define terms.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos141886"><span class="calibre33"><span class="calibre8"><span class="underline">6</span></span></span></a><span class="calibre33">]</span></small></sup></p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos141886" class="calibre32"><span class="calibre33">6</span></small></sup><span class="calibre10"> These terms are also defined and elaborated on in Rich Hickey’s presentation, “Are We There Yet?” (</span><a href="#filepos1074846"><span class="calibre10"><span class="calibre8"><span class="underline">Hickey 2009</span></span></span></a><span class="calibre10">). </span></blockquote><p class="calibre12">The first important term to define is <span class="italic">time</span>. Simply put, time refers to the relative moments when events occur. Over time, the properties associated with an entity—both static and changing, singular or composite—will form a concrescence (<a href="#filepos1084042"><span class="calibre8"><span class="underline">White-head 1929</span></span></a>) and be logically deemed its <span class="italic">identity</span>. It follows from this that at any given time, a snapshot can be taken of an entity’s properties defining its <span class="italic">state</span>. This notion of state is an immutable one because it’s not defined as a mutation in the entity itself, but only as a manifestation of its properties at a given moment in time. Imagine a child’s flip book, as seen in <a href="#filepos143035"><span class="calibre8"><span class="underline">figure 1.2</span></span></a>, to understand the terms fully. </p><p id="filepos143035" class="calibre5"><span class="calibre10"><span class="bold">Figure 1.2. The Runner: a child’s flip book serves to illustrate Clojure’s notions of state, time, and identity. The book itself represents the identity. Whenever you wish to show a change in the illustration, you draw another picture and add it to the end of your flip book. The act of flipping the pages therefore represents the states over time of the image within. Stopping at any given page and observing the particular picture represents the state of the Runner at that moment in time. </span></span><a></a></p><p class="calibre1"><img src="images/00041.jpg" class="calibre37"/></p><p class="calibre5">It’s important to note that in the canon of object-oriented programming, there’s no clear distinction between state and identity. In other words, these two ideas are <a id="filepos143914"></a>conflated into what’s commonly referred to as <span class="italic">mutable state</span>. The classical object-oriented model allows unrestrained mutation of object properties without a willingness to preserve historical states. Clojure’s implementation attempts to draw a clear separation between an object’s state and identity as they relate to time. To state the difference to Clojure’s model in terms of the aforementioned flip book, the mutable state model is different, as seen in <a href="#filepos144469"><span class="calibre8"><span class="underline">figure 1.3</span></span></a>. </p><p id="filepos144469" class="calibre5"><span class="calibre10"><span class="bold">Figure 1.3. The Mutable Runner: modeling state change with mutation requires that you stock up on erasers. Your book becomes a single page, requiring that in order to model changes, you must physically erase and redraw the parts of the picture requiring change. Using this model, you should see that mutation destroys all notion of time, and state and identity become one. </span></span><a></a></p><p class="calibre1"><img src="images/00048.jpg" class="calibre38"/></p><p class="calibre5">Immutability lies at the cornerstone of Clojure, and much of the implementation ensures that immutability is supported efficiently. By focusing on immutability, Clojure eliminates entirely the notion of <span class="italic">mutable state</span> (which is an oxymoron) and instead expounds that most of what’s meant by objects are instead values. <span class="italic">Value</span> by definition refers to an object’s constant representative<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos145789"><span class="calibre33"><span class="calibre8"><span class="underline">7</span></span></span></a><span class="calibre33">]</span></small></sup> amount, magnitude, or epoch. You might ask yourself: what are the implications of the value-based programming semantics of Clojure? </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos145789" class="calibre32"><span class="calibre33">7</span></small></sup><span class="calibre10"> Some entities have no representative value—Pi is an example. But in the realm of computing, where we’re ultimately referring to finite things, this is a moot point. </span></blockquote><p class="calibre12">Naturally, by adhering to a strict model of immutability, concurrency suddenly becomes a simpler (although not simple) problem, meaning if you have no fear that an object’s state will change, then you can promiscuously share it without fear of concurrent modification. Clojure instead isolates value change to its reference types, as we’ll show in <a href="#filepos818901"><span class="calibre8"><span class="underline">chapter 11</span></span></a>. Clojure’s reference types provide a level of indirection to an identity that can be used to obtain consistent, if not always current, states. </p><p id="filepos146638" class="calibre5"><span class="bold">1.4.2. Imperative “baked in” </span><a></a></p><p class="calibre7">Imperative programming is the dominant programming paradigm today. The most unadulterated definition of an imperative programming language is one where a sequence of statements mutates program state. During the writing of this book (and likely for some time beyond), the preferred flavor of imperative programming is the object-oriented style. This fact isn’t inherently bad, because there are countless successful software projects built using object-oriented imperative programming techniques. But from the context of concurrent programming, the object-oriented imperative model is self-cannibalizing. By allowing (and even promoting) unrestrained mutation via <span class="italic">variables</span>, the imperative model doesn’t directly support concurrency. Instead, by allowing a maenadic approach to mutation, there are no guarantees that any variable contains the expected value. Object-oriented programming takes this one step further by aggregating state in object internals. Though individual methods may be thread-safe through locking schemes, there’s no way to ensure a consistent <a id="filepos147823"></a>object state across multiple method calls without expanding the scope of potentially complex locking scheme(s). Clojure instead focuses on functional programming, immutability, and the distinction between state, time, and identity. But object-oriented programming isn’t a lost cause. In fact, there are many aspects that are conducive to powerful programming practice. </p><p id="filepos148205" class="calibre5"><span class="bold">1.4.3. Most of what OOP gives you, Clojure provides </span><a></a></p><p class="calibre7">It should be made clear that we’re not attempting to mark object-oriented programmers as pariahs. Instead, it’s important that we identify the shortcomings of object-oriented programming (OOP) if we’re ever to improve our craft. In the next few subsections we’ll also touch on the powerful aspects of OOP and how they’re adopted, and in some cases improved, by Clojure. </p><p class="calibre5"><span class="calibre10"><span class="bold">Polymorphism and the Expression Problem </span></span></p><p class="calibre7"><span class="italic">Polymorphism</span> is the ability of a function or method to have different definitions depending on the type of the target object. Clojure provides polymorphism via both multimethods and protocols, and both mechanisms are more open and extensible than polymorphism in many languages. </p><p id="filepos149136" class="calibre5"><span class="calibre10"><span class="bold">Listing 1.2. Clojure’s polymorphic protocols </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defprotocol Concatenatable<br class="calibre3"/>  (cat [this other]))<br class="calibre3"/>(extend-type String<br class="calibre3"/>  Concatenatable<br class="calibre3"/>  (cat [this other]<br class="calibre3"/>    (.concat this other)))<br class="calibre3"/>(cat "House" " of Leaves")<br class="calibre3"/>;=&gt; "House of Leaves"</tt></span></blockquote><p class="calibre12">What we’ve done in <a href="#filepos149136"><span class="calibre8"><span class="underline">listing 1.2</span></span></a> is to define a <span class="italic">protocol</span> named <tt class="calibre11">Concatenatable</tt> that groups one or more functions (in this case only one, <tt class="calibre11">cat</tt>) that define the set of functions provided. That means the function <tt class="calibre11">cat</tt> will work for any object that fully satisfies the protocol <tt class="calibre11">Concatenatable</tt>. We then <span class="italic">extend</span> this protocol to the <tt class="calibre11">String</tt> class and define the specific implementation—a function body that concatenates the argument <tt class="calibre11">other</tt> onto the string <tt class="calibre11">this</tt>. We can also extend this protocol to another type: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(extend-type java.util.List<br class="calibre3"/>  Concatenatable<br class="calibre3"/>  (cat [this other]<br class="calibre3"/>    (concat this other)))<br class="calibre3"/>(cat [1 2 3] [4 5 6])<br class="calibre3"/>;=&gt; (1 2 3 4 5 6)</tt></span></blockquote><p class="calibre12">So now the protocol has been extended to two different types, <tt class="calibre11">String</tt> and <tt class="calibre11">java.util.List</tt>, and thus the <tt class="calibre11">cat</tt> function can be called with either type as its first argument—the appropriate implementation will be invoked. </p><p id="filepos150827" class="calibre5">Note that <tt class="calibre11">String</tt> was already defined (in this case by Java itself) before we defined the protocol, and yet we were still able to successfully extend the new protocol to it. This isn’t possible in many languages. For example, Java requires that you define all the method names and their groupings (known as <span class="italic">interfaces</span>) before you can define a class that implements them, a restriction that’s known as the <span class="italic">expression problem</span>. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre28"><span class="calibre10"><span class="bold">The Expression Problem</span></span></p><p class="calibre5">The expression problem refers to the desire to implement an existing set of abstract methods for an existing concrete class without having to change the code that defines either. Object-oriented languages allow you to implement an existing abstract method in a concrete class you control (interface inheritance), but if the concrete class is outside your control, the options for making it implement new or existing abstract methods tend to be sparse. Some dynamic languages such as Ruby and JavaScript provide partial solutions to this problem by allowing you to add methods to an existing concrete object, a feature sometimes known as <span class="italic">monkey-patching</span>. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">A Clojure protocol can be extended to any type where it makes sense, even those that were never anticipated by the original implementor of the type or the original designer of the protocol. We’ll dive deeper into Clojure’s flavor of polymorphism in <a href="#filepos642230"><span class="calibre8"><span class="underline">chapter 9</span></span></a>, but we hope now you have a basic idea of how it works. </p><p class="calibre5"><span class="calibre10"><span class="bold">Subtyping and Interface-Oriented Programming </span></span></p><p class="calibre7">Clojure provides a form of subtyping by allowing the creation of ad-hoc hierarchies. We’ll delve into leveraging the ad-hoc hierarchy facility later, in <a href="#filepos660369"><span class="calibre8"><span class="underline">section 9.2</span></span></a>. Likewise, Clojure provides a capability similar to Java’s interfaces via its protocol mechanism. By defining a logically grouped set of functions, you can begin to define <span class="italic">protocols</span> to which data-type abstractions must adhere. This <span class="italic">abstraction-oriented programming</span> model is key in building large-scale applications, as you’ll discover in <a href="#filepos677632"><span class="calibre8"><span class="underline">section 9.3</span></span></a> and beyond. </p><p class="calibre5"><span class="calibre10"><span class="bold">Encapsulation </span></span></p><p class="calibre7">If Clojure isn’t oriented around classes, then how does it provide encapsulation? Imagine that you need a simple function that, given a representation of a chessboard and a coordinate, returns a simple representation of the piece at the given square. To keep the implementation as simple as possible, we’ll use a vector containing a set of characters corresponding to the colored chess pieces, as shown next. </p><p id="filepos154043" class="calibre5"><span class="calibre10"><span class="bold">Listing 1.3. A simple chessboard representation in Clojure </span></span><a></a></p><p class="calibre1"><img src="images/00023.jpg" class="calibre40"/></p><p id="filepos154287" class="calibre5">There’s no need to complicate matters with the chessboard representation; chess is hard enough. This data structure in the code corresponds directly to an actual chessboard in the starting position, as shown in <a href="#filepos154603"><span class="calibre8"><span class="underline">figure 1.4</span></span></a>. </p><p id="filepos154603" class="calibre5"><span class="calibre10"><span class="bold">Figure 1.4. The corresponding chessboard layout </span></span><a></a></p><p class="calibre1"><img src="images/00015.jpg" class="calibre41"/></p><p class="calibre5">From the figure, you can gather that the black pieces are lowercase characters and white pieces are uppercase. This kind of structure is likely not optimal, but it’s a good start. You can ignore the actual implementation details for now and focus on the client interface to query the board for square occupations. This is a perfect opportunity to enforce encapsulation to avoid drowning the client in board implementation details. Fortunately, programming languages with closures automatically support a form of encapsulation (<a href="#filepos1070644"><span class="calibre8"><span class="underline">Crockford 2008</span></span></a>) to group functions with their supporting data.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos155714"><span class="calibre33"><span class="calibre8"><span class="underline">8</span></span></span></a><span class="calibre33">]</span></small></sup></p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos155714" class="calibre32"><span class="calibre33">8</span></small></sup><span class="calibre10"> This form of encapsulation is described as the module pattern. But the module pattern as implemented with JavaScript provides some level of data hiding also, whereas in Clojure—not so much. </span></blockquote><p class="calibre12">The functions in <a href="#filepos156852"><span class="calibre8"><span class="underline">listing 1.4</span></span></a> are self-evident in their intent<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos156615"><span class="calibre33"><span class="calibre8"><span class="underline">9</span></span></span></a><span class="calibre33">]</span></small></sup> and are encapsulated at the level of the namespace <tt class="calibre11">joy.chess</tt> through the use of the <tt class="calibre11">defn-</tt> macro that creates namespace private functions. The command for using the <tt class="calibre11">lookup</tt> function in this case would be <tt class="calibre11">(joy.chess/lookup (initial-board) "a1")</tt>. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos156615" class="calibre32"><span class="calibre33">9</span></small></sup><span class="calibre10"> And as a nice bonus, these functions can be generalized to project a 2D structure of any size to a 1D representation—which we leave to you as an exercise. </span></blockquote><p id="filepos156852" class="calibre12"><span class="calibre10"><span class="bold">Listing 1.4. Querying the squares of a chessboard </span></span><a></a></p><p class="calibre1"><img src="images/00024.jpg" class="calibre42"/></p><p class="calibre5">Clojure’s namespace encapsulation is the most prevalent form of encapsulation that you’ll encounter when exploring idiomatic source code. But the use of lexical closures provides more options for encapsulation: block-level encapsulation, as shown in <a href="#filepos157551"><span class="calibre8"><span class="underline">listing 1.5</span></span></a>, and local encapsulation, both of which effectively aggregate unimportant details within a smaller scope. </p><p id="filepos157551" class="calibre5"><span class="calibre10"><span class="bold">Listing 1.5. Using block-level encapsulation </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(letfn [(index [file rank]<br class="calibre3"/>          (let [f (- (int file) (int \a))<br class="calibre3"/>                r (* 8 (- 8 (- (int rank) (int \0))))]<br class="calibre3"/>            (+ f r)))]<br class="calibre3"/>  (defn lookup [board pos]<br class="calibre3"/>    (let [[file rank] pos]<br class="calibre3"/>      (board (index file rank)))))</tt></span></blockquote><p id="filepos158108" class="calibre12">It’s often a good idea to aggregate relevant data, functions, and macros at their most specific scope. You’d still call <tt class="calibre11">lookup</tt> as before, but now the ancillary functions aren’t readily visible to the larger enclosing scope—in this case, the namespace <tt class="calibre11">joy.chess</tt>. In the preceding code, we’ve taken the <tt class="calibre11">file-component</tt> and <tt class="calibre11">rank-component</tt> functions and the <tt class="calibre11">*file-key*</tt> and <tt class="calibre11">*rank-key*</tt> values out of the namespace proper and rolled them into a block-level <tt class="calibre11">index</tt> function defined with the body of the <tt class="calibre11">letfn</tt> macro. Within this body, we then define the <tt class="calibre11">lookup</tt> function, thus limiting the client exposure to the chessboard API and hiding the implementation specific functions and forms. But we can further limit the scope of the encapsulation, as shown in the next listing, by shrinking the scope even more to a truly function-local context. </p><p id="filepos159063" class="calibre5"><span class="calibre10"><span class="bold">Listing 1.6. Local encapsulation </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn lookup2 [board pos]<br class="calibre3"/>  (let [[file rank] (map int pos)<br class="calibre3"/>        [fc rc]     (map int [\a \0])<br class="calibre3"/>        f (- file fc)<br class="calibre3"/>        r (* 8 (- 8 (- rank rc)))<br class="calibre3"/>        index (+ f r)]<br class="calibre3"/>    (board index)))</tt></span></blockquote><p class="calibre12">Finally, we’ve now pulled <span class="italic">all</span> of the implementation-specific details into the body of the <tt class="calibre11">lookup2</tt> function itself. This localizes the scope of the <tt class="calibre11">index</tt> function and all auxiliary values to only the relevant party—<tt class="calibre11">lookup2</tt>. As a nice bonus, <tt class="calibre11">lookup2</tt> is simple and compact without sacrificing readability. But Clojure eschews the notion of data-hiding encapsulation featured prominently in most object-oriented languages. </p><p class="calibre5"><span class="calibre10"><span class="bold">Not Everything is an Object </span></span></p><p class="calibre7">Finally, another downside to object-oriented programming is the tight coupling between function and data. In fact, the Java programming language forces you to build programs entirely from class hierarchies, restricting all functionality to containing methods in a highly restrictive “Kingdom of Nouns” (<a href="#filepos1088206"><span class="calibre8"><span class="underline">Yegge 2006</span></span></a>). This environment is so restrictive that programmers are often forced to turn a blind eye to awkward attachments of inappropriately grouped methods and classes. It’s because of the proliferation of this stringent object-centric viewpoint that Java code tends toward being verbose and complex (<a href="#filepos1069893"><span class="calibre8"><span class="underline">Budd 1995</span></span></a>). Clojure functions are data, yet this in no way restricts the decoupling of data and the functions that work upon them. Many of what programmers perceive to be classes are data tables that Clojure provides via <a></a>maps<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos161674"><span class="calibre33"><span class="calibre8"><span class="underline">10</span></span></span></a><span class="calibre33">]</span></small></sup> and records. The final strike against viewing everything as an object is that mathematicians view little (if anything) as objects (<a href="#filepos1067768"><span class="calibre8"><span class="underline">Abadi 1996</span></span></a>). Instead, mathematics is built on the relationships between one set of elements and another through the application of functions. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos161674" class="calibre32"><span class="calibre33">10</span></small></sup><span class="calibre10"> See </span><a href="#filepos408333"><span class="calibre10"><span class="calibre8"><span class="underline">section 5.6</span></span></span></a><span class="calibre10"> for more discussion on this idea. </span></blockquote><p id="filepos161908" class="calibre5"><span class="calibre18"><span class="bold">1.5. Summary </span></span></p><p class="calibre7">We’ve covered a lot of conceptual ground in this chapter, but it was necessary in order to define the terms used throughout the remainder of the book. Likewise, it’s important to understand Clojure’s underpinnings in order to frame the discussion for the rest of the book. If you’ve taken in the previous sections and internalized them, then congratulations: you have a solid basis for proceeding to the rest of the book. But if you’re still not sure what to make of Clojure, it’s okay—we understand that it may be a lot to take in all at once. Understanding will come gradually as we piece together Clojure’s story. For those of you coming from a functional programming background, you’ll likely have recognized much of the discussion in the previous sections, but perhaps with some surprising twists. Conversely, if your background is more rooted in object-oriented programming, then you may get the feeling that Clojure is very different than you’re accustomed to. Though in many ways this is true, in the coming chapters you’ll see how Clojure elegantly solves many of the problems that you deal with on a daily basis. Clojure approaches solving software problems from a different angle than classical object-oriented techniques, but it does so having been motivated by their fundamental strengths and shortcomings. </p><p class="calibre5">With this conceptual underpinning in place, it’s time to make a quick run through Clojure’s technical basics and syntax. We’ll be moving fairly quickly, but no faster than necessary to get to the deeper topics in following chapters. So hang on to your REPL, here we go... </p><div class="mbppagebreak"></div><p id="filepos163683" class="calibre5"><span class="calibre6"><span class="bold">Chapter 2. Drinking from the Clojure firehose </span></span><a></a></p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">This chapter covers</span>
</p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24"><a href="#filepos167160"><span class="calibre8"><span class="underline">Scalars</span></span></a></li><li value="2" class="calibre24"><a href="#filepos175663"><span class="calibre8"><span class="underline">Putting things together: collections</span></span></a></li><li value="3" class="calibre24"><a href="#filepos180747"><span class="calibre8"><span class="underline">Making things happen: functions</span></span></a></li><li value="4" class="calibre24"><a href="#filepos190361"><span class="calibre8"><span class="underline">Vars</span></span></a></li><li value="5" class="calibre24"><a href="#filepos192948"><span class="calibre8"><span class="underline">Locals, loops, and blocks</span></span></a></li><li value="6" class="calibre24"><a href="#filepos202645"><span class="calibre8"><span class="underline">Preventing things from happening: quoting</span></span></a></li><li value="7" class="calibre24"><a href="#filepos215159"><span class="calibre8"><span class="underline">Leveraging Java via interop</span></span></a></li><li value="8" class="calibre24"><a href="#filepos222949"><span class="calibre8"><span class="underline">Exceptional circumstances</span></span></a></li><li value="9" class="calibre24"><a href="#filepos224797"><span class="calibre8"><span class="underline">Namespaces</span></span></a></li></ul><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">This chapter provides a quick tour of the bare necessities—the things you’ll need to know to understand the rest of this book. If you’ve been programming with Clojure for a while, this may be a review, but otherwise it should give you everything you need to start writing Clojure code. In most cases throughout this chapter, the examples provided will be perfunctory in order to highlight the immediate point. <a id="filepos165700"></a>Later in the book we’ll build on these topics and many more, so don’t worry if you don’t quite grasp every feature now—you’ll get there. </p><p class="calibre5">Interaction with Clojure is often performed at the <span class="italic">Read-Eval-Print Loop (REPL)</span>. When starting a new REPL session, you’re presented with a simple prompt: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">user&gt;</tt></span></blockquote><p class="calibre12">The <tt class="calibre11">user</tt> prompt refers to the top-level namespace of the default REPL. It’s at this point that Clojure waits for input expressions. Valid Clojure expressions consist of numbers, symbols, keywords, booleans, characters, functions, function calls, macros, strings, literal maps, vectors, and sets. Some expressions, such as numbers, strings, and keywords, are self-evaluating—when entered, they evaluate to themselves. The Clojure REPL also accepts source comments, which are marked by the semicolon <tt class="calibre11">;</tt> and continue to a newline: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">user&gt; 42    ; numbers evaluate to themselves<br class="calibre3"/>;=&gt; 42<br class="calibre3"/>user&gt; "The Misfits" ; strings do too<br class="calibre3"/>;=&gt; "The Misfits"<br class="calibre3"/>user&gt; :pyotr  ; as do keywords<br class="calibre3"/>;=&gt; :pyotr</tt></span></blockquote><p class="calibre12">Now that we’ve seen several scalar data types, we’ll take a closer look at each of them.</p><p id="filepos167160" class="calibre5"><span class="calibre18"><span class="bold">2.1. Scalars </span></span></p><p class="calibre7">The Clojure language has a rich set of data types. Like most programming languages, it provides scalar types such as integers, strings, and floating-point numbers, each representing a single unit of data. Clojure provides several different categories of scalar data types: integers, floats, rationals, symbols, keywords, strings, characters, booleans, and regex patterns. In this section, we’ll address most of these<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos167930"><span class="calibre33"><span class="calibre8"><span class="underline">1</span></span></span></a><span class="calibre33">]</span></small></sup> categories in turn, providing examples of each. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos167930" class="calibre32"><span class="calibre33">1</span></small></sup><span class="calibre10"> We won’t look at regular expression patterns here, but for details on everything regex-related you can flip forward to </span><a href="#filepos331343"><span class="calibre10"><span class="calibre8"><span class="underline">section 4.6</span></span></span></a><span class="calibre10">. </span></blockquote><p id="filepos168247" class="calibre35"><span class="bold">2.1.1. Numbers </span><a></a></p><p class="calibre7">A number can consist of only the digits 0-9, a decimal point (.), a sign (+ or -), and an optional <span class="italic">e</span> for numbers written in exponential notation. In addition to these elements, numbers in Clojure can take either octal or hexadecimal form and also include an optional <span class="italic">M</span>, that flags a number as a decimal requiring arbitrary precision: an important aspect of numbers in Clojure. In many programming languages, the precision<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos169274"><span class="calibre33"><span class="calibre8"><span class="underline">2</span></span></span></a><span class="calibre33">]</span></small></sup> of numbers is restricted by the host platform, or in the case of Java and C#, defined by the language specification. Clojure on the other hand uses the host language’s primitive numbers when appropriate, but rolls over to the arbitrarily precise versions when needed, or when explicitly specified. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos169274" class="calibre32"><span class="calibre33">2</span></small></sup><span class="calibre10"> With caveats, as we’ll describe in </span><a href="#filepos284964"><span class="calibre10"><span class="calibre8"><span class="underline">chapter 4</span></span></span></a><span class="calibre10">. </span></blockquote><p id="filepos169505" class="calibre35"><span class="bold">2.1.2. Integers </span><a></a></p><p id="filepos169568" class="calibre7">Integers comprise the whole number set, both positive and negative. Any number starting with an optional sign or digit followed exclusively by digits is considered and stored as an integer. Integers in Clojure can theoretically take an infinitely large value, although in practice the size is limited by the memory available. The following numbers are recognized by Clojure as integers: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">42<br class="calibre3"/>+9<br class="calibre3"/>-107<br class="calibre3"/>991778647261948849222819828311491035886734385827028118707676848307166514</tt></span></blockquote><p class="calibre12">The following illustrates the use of decimal, hexadecimal, octal, radix-32, and binary literals, respectively, all representing the same number: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">[127 0x7F 0177 32r3V 2r01111111]<br class="calibre3"/>;=&gt; [127 127 127 127 127]</tt></span></blockquote><p class="calibre12">The radix notation supports up to base 36. Adding signs to the front of each of the integer literals is also legal.</p><p id="filepos170661" class="calibre5"><span class="bold">2.1.3. Floating-point numbers </span><a></a></p><p class="calibre7">Floating-point numbers are the decimal expansion of rational numbers. Like Clojure’s implementation of integers, the floating-point values are arbitrarily precise.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos171523"><span class="calibre33"><span class="calibre8"><span class="underline">3</span></span></span></a><span class="calibre33">]</span></small></sup> Floating-point numbers can take the traditional form of some number of digits and then a decimal point, followed by some number of digits. But floating-point numbers can also take an exponential form (scientific notation) where a significant part is followed by an exponent part separated by a lower or uppercase <span class="italic">E</span>. The following numbers are examples of valid floating-point numbers: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos171523" class="calibre32"><span class="calibre33">3</span></small></sup><span class="calibre10"> With some caveats, as we’ll discuss in </span><a href="#filepos288030"><span class="calibre10"><span class="calibre8"><span class="underline">section 4.1</span></span></span></a><span class="calibre10">. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">1.17<br class="calibre3"/>+1.22<br class="calibre3"/>-2.<br class="calibre3"/>366e7<br class="calibre3"/>32e-14<br class="calibre3"/>10.7e-3</tt></span></blockquote><p class="calibre12">Numbers are largely the same across most programming languages, so we’ll move on to some scalar types that are more unique to Lisp and Lisp-inspired languages. </p><p id="filepos172112" class="calibre5"><span class="bold">2.1.4. Rationals </span><a></a></p><p class="calibre7">Clojure provides a rational type in addition to integer and floating-point numbers. Rational numbers offer a more compact and precise representation of a given value over floating-point. Rationals are represented classically by an integer numerator and denominator, and that’s exactly how they’re represented in Clojure. The following numbers are examples of valid rational numbers: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">22/7<br class="calibre3"/>7/22<br class="calibre3"/>1028798300297636767687409028872/88829897008789478784<br class="calibre3"/>-103/4</tt></span></blockquote><p id="filepos172769" class="calibre12">Something to note about rational numbers in Clojure is that they’ll be simplified if they can—the rational <tt class="calibre11">100/4</tt> will resolve to the integer <tt class="calibre11">25</tt>. </p><p id="filepos172969" class="calibre5"><span class="bold">2.1.5. Symbols </span><a></a></p><p class="calibre7">Symbols in Clojure are objects in their own right, but are often used to represent another value. When a number or a string is evaluated, you get back exactly the same object, but when a symbol is evaluated, you’ll get back whatever value that symbol is referring to in the current context. In other words, symbols are typically used to refer to function parameters, local variables, globals, and Java classes. </p><p id="filepos173476" class="calibre5"><span class="bold">2.1.6. Keywords </span><a></a></p><p class="calibre7">Keywords are similar to symbols, except that they always evaluate to themselves. You’re likely to see the use of keywords far more in Clojure than symbols. The form of a keyword’s literal syntax is as follows: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">:chumby<br class="calibre3"/>:2<br class="calibre3"/>:?<br class="calibre3"/>:ThisIsTheNameOfaKeyword</tt></span></blockquote><p class="calibre12">Although keywords are prefixed by a colon <tt class="calibre11">:</tt>, it’s only part of the literal syntax and not part of the name itself. We go into further detail about keywords in <a href="#filepos305331"><span class="calibre8"><span class="underline">section 4.3</span></span></a>. </p><p id="filepos174203" class="calibre5"><span class="bold">2.1.7. Strings </span><a></a></p><p class="calibre7">Strings in Clojure are represented similarly to the way they’re used in many programming languages: a string is any sequence of characters enclosed within a set of double quotes, including newlines, as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">"This is a string"<br class="calibre3"/>"This is also a<br class="calibre3"/>         String"</tt></span></blockquote><p class="calibre12">Both will be stored as written, but when printed at the REPL, multiline strings will include escapes for the literal newline characters like <tt class="calibre11">"This is also a\n String"</tt>. </p><p id="filepos174881" class="calibre5"><span class="bold">2.1.8. Characters </span><a></a></p><p class="calibre7">Clojure characters are written with a literal syntax prefixed with a backslash and are stored as Java Character objects, as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">\a       ; The character lowercase a<br class="calibre3"/>\A       ; The character uppercase A<br class="calibre3"/>\u0042   ; The unicode character uppercase B<br class="calibre3"/>\\       ; The back-slash character \<br class="calibre3"/>\u30DE   ; The unicode katakana character ?</tt></span></blockquote><p id="filepos175471" class="calibre12">And that’s it for Clojure’s scalar data types. In the next section, we’ll discuss Clojure’s collection data types, which is where the real fun begins. </p><p id="filepos175663" class="calibre5"><span class="calibre18"><span class="bold">2.2. Putting things together: collections </span></span></p><p class="calibre7">We’ll cover the collection types in greater detail in <a href="#filepos332652"><span class="calibre8"><span class="underline">chapter 5</span></span></a>, but because Clojure programs are made up of various kinds of literal collections, it’s helpful to at least glance at the basics of lists, vectors, maps, and sets. </p><p id="filepos176090" class="calibre5"><span class="bold">2.2.1. Lists </span><a></a></p><p class="calibre7">Lists are the classic collection type in List Processing languages, and Clojure is no exception. Literal lists are written with parentheses: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(yankee hotel foxtrot)</tt></span></blockquote><p class="calibre12">When a list is evaluated, the first item of the list—<tt class="calibre11">yankee</tt> in this case—will be resolved to a function, macro, or special form. If <tt class="calibre11">yankee</tt> is a function, the remaining items in the list will be evaluated in order, and the results will be passed to <tt class="calibre11">yankee</tt> as its parameters. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre28"><span class="calibre10"><span class="bold">Forms</span></span></p><p class="calibre5">A <span class="italic">form</span> is any Clojure object meant to be evaluated, including but not limited to lists, vectors, maps, numbers, keywords, and symbols. A <span class="italic">special form</span> is a form with special syntax or special evaluation rules that are typically not implemented using the base Clojure forms. An example of a special form is the <tt class="calibre11">.</tt> (dot) operator used for Java interoperability purposes. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">If on the other hand <tt class="calibre11">yankee</tt> is a macro or special form, the remaining items in the list aren’t necessarily evaluated, but are processed as defined by the macro or operator. </p><p class="calibre5">Lists can contain items of any type, including other collections. Here are some more examples:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(1 2 3 4)<br class="calibre3"/>()<br class="calibre3"/>(:fred ethel)<br class="calibre3"/>(1 2 (a b c) 4 5)</tt></span></blockquote><p class="calibre12">Note that unlike some Lisps, the empty list in Clojure, written as <tt class="calibre11">()</tt>, isn’t the same as <tt class="calibre11">nil</tt>. </p><p id="filepos178124" class="calibre5"><span class="bold">2.2.2. Vectors </span><a></a></p><p class="calibre7">Like lists, vectors store a series of values. There are several differences described in <a href="#filepos388921"><span class="calibre8"><span class="underline">section 5.4</span></span></a>, but for now only two are important. First, vectors have a literal syntax using square brackets: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">[1 2 :a :b :c]</tt></span></blockquote><p class="calibre12">The other important difference is that when evaluated, vectors simply evaluate each item in order. No function or macro call is performed on the vector itself, though if a list appears within the vector, that list is evaluated following the normal rules for a list. Like lists, vectors are type heterogeneous, and as you might guess, the empty vector <tt class="calibre11">[]</tt> isn’t the same as <tt class="calibre11">nil</tt>. </p><p id="filepos179004" class="calibre5"><span class="bold">2.2.3. Maps </span><a></a></p><p id="filepos179062" class="calibre7">Maps store unique keys and one value per key—similar to what some languages and libraries call <span class="italic">dictionaries</span> or <span class="italic">hashes</span>. Clojure actually has several types of maps with different properties, but don’t worry about that for now. Maps can be written using a literal syntax with alternating keys and values inside curly braces. Commas are frequently used between pairs, but are just whitespace like they are everywhere else in Clojure: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">{1 "one", 2 "two", 3 "three"}</tt></span></blockquote><p class="calibre12">Like vectors, every item in a map literal (each key and each value) is evaluated before the result is stored in the map. Unlike vectors, the order in which they’re evaluated isn’t guaranteed. Maps can have items of any type for both keys and values, and the empty map <tt class="calibre11">{}</tt> isn’t the same as <tt class="calibre11">nil</tt>. </p><p id="filepos180009" class="calibre5"><span class="bold">2.2.4. Sets </span><a></a></p><p class="calibre7">Sets are probably the least common collection type that has a literal syntax. Sets store zero or more unique items. They’re written using curly braces with a leading hash: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">#{1 2 "three" :four 0x5}</tt></span></blockquote><p class="calibre12">Again, the empty set <tt class="calibre11">#{}</tt> isn’t the same as <tt class="calibre11">nil</tt>. </p><p class="calibre5">That’s all for now regarding the basic collection types, but <a href="#filepos284964"><span class="calibre8"><span class="underline">chapter 4</span></span></a> will cover in-depth the idiomatic uses of each, including their relative strengths and weaknesses. </p><p id="filepos180747" class="calibre5"><span class="calibre18"><span class="bold">2.3. Making things happen: functions </span></span></p><p class="calibre7">Functions in Clojure are a first-class type, meaning that they can be used the same as any value. Functions can be stored in Vars, held in lists and other collection types, and passed as arguments to and even returned as the result of other functions. </p><p id="filepos181130" class="calibre5"><span class="bold">2.3.1. Calling functions </span><a></a></p><p class="calibre7">Clojure borrows its function calling conventions from Lisp, also known as <span class="italic">prefix notation</span>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(+ 1 2 3)<br class="calibre3"/>;=&gt; 6</tt></span></blockquote><p class="calibre12">The immediately obvious advantage of prefix over infix notation used by C-style languages<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos182300"><span class="calibre33"><span class="calibre8"><span class="underline">4</span></span></span></a><span class="calibre33">]</span></small></sup> is that the former allows any number of operands per operator, whereas infix allows only two. Another, less obvious advantage to structuring code as prefix notation is that it completely eliminates the problem of operator precedence. Clojure makes no distinction between operator notation and regular function calls—all Clojure constructs, functions, macros, and operators are formed using prefix, or fully parenthesized, notation. This uniform structure forms the basis for the incredible flexibility that Lisp-like languages provide. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos182300" class="calibre32"><span class="calibre33">4</span></small></sup><span class="calibre10"> Of course, Java uses infix notation in only a few instances. The remainder of the language forms tend toward C-style ad hoc debauchery. </span></blockquote><p id="filepos182516" class="calibre35"><span class="bold">2.3.2. Defining functions </span><a></a></p><p id="filepos182589" class="calibre7">An anonymous (unnamed) Clojure function can be defined as a special form. A <span class="italic">special form</span> is a Clojure expression that’s part of the core language, but not created in terms of functions, types, or macros. </p><p class="calibre5">An example of a function taking two elements that returns a set of those elements would be defined as</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(fn mk-set [x y] #{x y})<br class="calibre3"/>;=&gt; #&lt;user$eval__1$mk_set__2 user$eval__1$mk_set__2@d3576a2&gt;</tt></span></blockquote><p class="calibre12">Entering this function definition in a Clojure REPL gives us a seemingly strange result. This is because the REPL is showing its internal name for the function object returned by the <tt class="calibre11">fn</tt> special form. This is far from satisfying, given that now that the function has been defined, there’s no apparent way to execute it. It should be noted that the <tt class="calibre11">mk-set</tt> symbol is optional and doesn’t correspond to a globally accessible name for the function, but instead to a name internal to the function itself used for self-calls. Recall from the previous section that the function call form is always <tt class="calibre11">(some-function arguments)</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">((fn [x y] #{x y}) 1 2)<br class="calibre3"/>;=&gt; #{1 2}</tt></span></blockquote><p class="calibre12">The second form to define functions allows for arity overloading of the invocations of a function. <span class="italic">Arity</span> refers to the differences in the argument count that a function will accept. Changing our previous simple set-creating function to accept either one or two arguments would be represented as </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(fn<br class="calibre3"/>  ([x]   #{x})<br class="calibre3"/>  ([x y] #{x y}))</tt></span></blockquote><p class="calibre12">The difference from the previous form is that we can now have any number of argument/body pairs as long as the arity of the arguments differ. Naturally, the execution of such a function for one argument would be </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">((fn<br class="calibre3"/>  ([x]   #{x})<br class="calibre3"/>  ([x y] #{x y})) 42)<br class="calibre3"/>;=&gt; #{42}</tt></span></blockquote><p class="calibre12">As you saw, arguments to functions are bound one-for-one to symbols during the function call, but there is a way for functions to accept a variable<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos185265"><span class="calibre33"><span class="calibre8"><span class="underline">5</span></span></span></a><span class="calibre33">]</span></small></sup> number of arguments: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos185265" class="calibre32"><span class="calibre33">5</span></small></sup><span class="calibre10"> The implementation details of Clojure prevent the creation of functions with an arity larger than 20, but in practice this should rarely, if ever, be an issue. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">((fn arity2 [x y] [x y]) 1 2 3)<br class="calibre3"/>;=&gt; java.lang.IllegalArgumentException: Wrong number of args passed</tt></span></blockquote><p class="calibre12">Clearly, calling the <tt class="calibre11">arity2</tt> function with three arguments won’t work. But what if we wanted it to take any number of arguments? The way to denote variable arguments is to use the <tt class="calibre11">&amp;</tt> symbol followed by a symbol. Every symbol in the arguments list before <a id="filepos186016"></a>the <tt class="calibre11">&amp;</tt> will still be bound one-for-one to the same number of arguments passed during the function call. But any additional arguments will be aggregated in a sequence bound to the symbol following the <tt class="calibre11">&amp;</tt> symbol: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">((fn arity2+ [x y &amp; z] [x y z]) 1 2)<br class="calibre3"/>;=&gt; [1 2 nil]<br class="calibre3"/><br class="calibre3"/>((fn arity2+ [x y &amp; z] [x y z]) 1 2 3 4)<br class="calibre3"/>;=&gt; [1 2 (3 4)]<br class="calibre3"/><br class="calibre3"/>((fn arity2+ [x y &amp; z] [x y z]) 1)<br class="calibre3"/>;=&gt; java.lang.IllegalArgumentException: Wrong number of args passed</tt></span></blockquote><p class="calibre12">Of course, <tt class="calibre11">arity2+</tt> still requires at least two arguments. But this isn’t satisfactory, as it quickly becomes clear that to write programs using only this form would be cumbersome, repetitive, and overly verbose. Thankfully, Clojure provides another, more convenient form to create named functions. </p><p id="filepos187018" class="calibre5"><span class="bold">2.3.3. Simplifying function definitions with def and defn </span><a></a></p><p class="calibre7">The <tt class="calibre11">def</tt> special form is a way to assign a symbolic name to a piece of Clojure data. Clojure functions are first-class; they’re equal citizens with data, allowing assignment to Vars, storage in collections, and as arguments to (or returned from) other functions. This is different from programming languages where functions are functions and data are data, and there’s a world of capability available to the latter that’s incongruous to the former. </p><p class="calibre5">Therefore, in order to associate a name with our previous function using <tt class="calibre11">def</tt>, we’d use </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def make-a-set<br class="calibre3"/>  (fn<br class="calibre3"/>    ([x]   #{x})<br class="calibre3"/>    ([x y] #{x y})))</tt></span></blockquote><p class="calibre12">And we could now call it in a more intuitive way:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(make-a-set 1)<br class="calibre3"/>;=&gt; #{1}<br class="calibre3"/>(make-a-set 1 2)<br class="calibre3"/>;=&gt; #{1 2}</tt></span></blockquote><p class="calibre12">There’s another way to define functions in Clojure using the <tt class="calibre11">defn</tt> macro. While certainly a much nicer way to define and consequently refer to functions by name, using <tt class="calibre11">def</tt> as shown is still cumbersome to use. Instead, the simplest <tt class="calibre11">defn</tt> syntax is a convenient and concise way to create named functions that looks similar to the original <tt class="calibre11">fn</tt> form, and allow an additional documentation string: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn make-a-set<br class="calibre3"/>  "Takes either one or two values and makes a set from them"<br class="calibre3"/>  ([x] #{x})<br class="calibre3"/>  ([x y] #{x y}))</tt></span></blockquote><p class="calibre12">The function can again be called the same as we saw before.</p><p id="filepos188967" class="calibre5"><span class="bold">2.3.4. In-place functions with #() </span><a></a></p><p id="filepos189048" class="calibre7">Clojure provides a shorthand notation for creating an anonymous function using the <tt class="calibre11">#()</tt> reader feature. In a nutshell, <span class="italic">reader features</span> are analogous to preprocessor directives in that they signify that some given form should be replaced with another at read time. In the case of the <tt class="calibre11">#()</tt> form, it’s effectively replaced with the special form <tt class="calibre11">fn</tt>. In fact, anywhere that it’s appropriate to use <tt class="calibre11">#()</tt>, it’s likewise appropriate for the <tt class="calibre11">fn</tt> special form. </p><p class="calibre5">The <tt class="calibre11">#()</tt> form can also accept arguments that are implicitly declared through the use of special symbols prefixed with <tt class="calibre11">%</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def make-a-list_  #(list %))<br class="calibre3"/>(def make-a-list1  #(list %1))<br class="calibre3"/>(def make-a-list2  #(list %1 %2))<br class="calibre3"/>(def make-a-list3  #(list %1 %2 %3))<br class="calibre3"/>(def make-a-list3+ #(list %1 %2 %3 %&amp;))<br class="calibre3"/><br class="calibre3"/>(make-a-list_ 1)<br class="calibre3"/>;=&gt; (1)<br class="calibre3"/><br class="calibre3"/>(make-a-list3+ 1 2 3 4 5)<br class="calibre3"/>;=&gt; (1 2 3 (4 5))</tt></span></blockquote><p class="calibre12">The <tt class="calibre11">%&amp;</tt> argument in <tt class="calibre11">make-a-list3+</tt> is used to specify the variable arguments as discussed previously. </p><p id="filepos190361" class="calibre5"><span class="calibre18"><span class="bold">2.4. Vars </span></span></p><p class="calibre7">Programmers are typically accustomed to dealing with variables and mutation. Clojure’s closest analogy to the variable is the Var. A Var is named by a symbol and holds a single value. Its value can be changed while the program is running, but this is best reserved for the programmer making manual changes. A Var’s value can also be shadowed by a thread local value, though this doesn’t change its original value or <span class="italic">root binding</span>. </p><p id="filepos190908" class="calibre5"><span class="bold">2.4.1. Declaring bindings using def </span><a></a></p><p class="calibre7">Using <tt class="calibre11">def</tt> is the most common way to create Vars in Clojure: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def x 42)</tt></span></blockquote><p class="calibre12">Using <tt class="calibre11">def</tt> to associate the value 42 to the symbol <tt class="calibre11">x</tt> creates what’s known as a <span class="italic">root binding</span>—a binding that’s the same across all threads, unless otherwise rebound relative to specific threads. By default, all threads start with the root binding, which is their associated value in the absence of a thread-bound value. </p><p class="calibre5">The trivial case is that the symbol <tt class="calibre11">x</tt> is bound to the value 42. Because we used <tt class="calibre11">def</tt> to create the Var’s root binding, we should observe that even other threads will view the same root binding by default: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(.start (Thread. #(println "Answer: " x)))<br class="calibre3"/>; Answer: 42</tt></span></blockquote><p id="filepos191973" class="calibre12">Vars don’t require a value; instead we can simply declare them and defer the responsibility of binding their values to individual threads:<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos192342"><span class="calibre33"><span class="calibre8"><span class="underline">6</span></span></span></a><span class="calibre33">]</span></small></sup></p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos192342" class="calibre32"><span class="calibre33">6</span></small></sup><span class="calibre10"> We’ll talk more about per-thread bindings in </span><a href="#filepos818901"><span class="calibre10"><span class="calibre8"><span class="underline">chapter 11</span></span></span></a><span class="calibre10">. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(def y)<br class="calibre3"/>y<br class="calibre3"/>;=&gt; java.lang.IllegalStateException: Var user/y is unbound.</tt></span></blockquote><p class="calibre12">Functions and vars theoretically provide all you need to implement any algorithm, and some languages leave you with exactly these “atomic” constructs. </p><p id="filepos192948" class="calibre5"><span class="calibre18"><span class="bold">2.5. Locals, loops, and blocks </span></span></p><p class="calibre7">Clojure’s function and value binding capabilities provide a basis for much of what a developer needs to start getting operational code, but a large part of the story is missing. Clojure also provides capabilities for creating local value bindings, looping constructs, and aggregating blocks of functionality. </p><p id="filepos193384" class="calibre5"><span class="bold">2.5.1. Blocks </span><a></a></p><p class="calibre7">Use the <tt class="calibre11">do</tt> form when you have a series or block of expressions that need to be treated as one. All the expressions will be evaluated, but only the last one will be returned: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(do<br class="calibre3"/>  6<br class="calibre3"/>  (+ 5 4)<br class="calibre3"/>  3)<br class="calibre3"/>;=&gt; 3</tt></span></blockquote><p class="calibre12">The expressions <tt class="calibre11">6</tt> and <tt class="calibre11">(+ 5 4)</tt> are perfectly valid and legal. The addition in <tt class="calibre11">(+ 5 4)</tt> is even done, but the value is thrown away—only the final expression <tt class="calibre11">3</tt> is returned. The middle bits of the <tt class="calibre11">do</tt> form are typically where the side-effects occur. </p><p id="filepos194137" class="calibre5"><span class="bold">2.5.2. Locals </span><a></a></p><p class="calibre7">Clojure doesn’t have local variables, but it does have locals; they just can’t vary. Locals are created and their scope defined using a <tt class="calibre11">let</tt> form, which starts with a vector that defines the bindings, followed by any number of expressions that make up the body. The vector starts with a binding form (usually just a symbol), which is the name of a new local. This is followed by an expression whose value will be bound to this new local for the remainder of the <tt class="calibre11">let</tt> form. You can continue pairing binding names and expressions to create as many locals as you need. All of them will be available in the body of the <tt class="calibre11">let</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(let [r         5<br class="calibre3"/>      pi        3.1415<br class="calibre3"/>      r-squared (* r r)]<br class="calibre3"/>  (println "radius is" r)<br class="calibre3"/>  (* pi r-squared))</tt></span></blockquote><p id="filepos195145" class="calibre12">The body is sometimes described as an “implicit do” because it follows the same rules: you may include any number of expressions and all will be evaluated, but only the value of the last one is returned. </p><p class="calibre5">All of the binding forms in the previous example are simple symbols: <tt class="calibre11">r</tt>, <tt class="calibre11">pi</tt>, and <tt class="calibre11">r-squared</tt>. More complex binding expressions can be used to pull apart expressions that return collections. This feature is called <span class="italic">destructuring</span>: see <a href="#filepos224797"><span class="calibre8"><span class="underline">section 2.9</span></span></a> for details. </p><p class="calibre5">Because they’re immutable, locals can’t be used to accumulate results; instead, you’d use a high level function or loop/recur form. </p><p id="filepos195935" class="calibre5"><span class="bold">2.5.3. Loops </span><a></a></p><p class="calibre7">The classic way to build a loop in a Lisp is a recursive call, and it’s in Clojure as well. Using recursion sometimes requires thinking about your problem in a different way than imperative languages encourage; but recursion from a tail position is in many ways like a structured <tt class="calibre11">goto</tt>, and has more in common with an imperative loop than it does with other kinds of recursion. </p><p class="calibre5"><span class="calibre10"><span class="bold">Recur </span></span></p><p class="calibre7">Clojure has a special form called <tt class="calibre11">recur</tt> that’s specifically for tail recursion: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn print-down-from [x]<br class="calibre3"/>  (when (pos? x)<br class="calibre3"/>    (println x)<br class="calibre3"/>    (recur (dec x))))</tt></span></blockquote><p class="calibre12">This is nearly identical to how you’d structure a while loop in an imperative language. One significant difference is that the value of <tt class="calibre11">x</tt> isn’t decremented somewhere in the body of the loop. Instead, a new value is calculated as a parameter to <tt class="calibre11">recur</tt>, which immediately does two things: rebinds <tt class="calibre11">x</tt> to the new value and returns control to the top of <tt class="calibre11">print-down-from</tt>. </p><p class="calibre5">If the function has multiple arguments, the <tt class="calibre11">recur</tt> call must as well, just as if you were calling the function by name instead of using the <tt class="calibre11">recur</tt> special form. And just as with a function call, the expressions in the <tt class="calibre11">recur</tt> are evaluated in order first and only then bound to the function arguments simultaneously. </p><p class="calibre5">The previous example doesn’t concern itself with return values; it’s just about the <tt class="calibre11">println</tt> side effects. Here’s a similar loop that builds up an accumulator and returns the final result: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn sum-down-from [sum x]<br class="calibre3"/>  (if (pos? x)<br class="calibre3"/>    (recur (+ sum x) (dec x))<br class="calibre3"/>    sum))</tt></span></blockquote><p class="calibre12">The only ways out of the function are <tt class="calibre11">recur</tt>, which isn’t really a way out, and <tt class="calibre11">sum</tt>. So when <tt class="calibre11">x</tt> is no longer positive, the function will return the value of <tt class="calibre11">sum</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(sum-down-from 0 10)<br class="calibre3"/>;=&gt; 55</tt></span></blockquote><p id="filepos198412" class="calibre12">You may have noticed that the two preceding functions used different blocks: the first <tt class="calibre11">when</tt> and the second <tt class="calibre11">if</tt>. You’ll often see one or the other used as a conditional, but it’s not always immediately apparent why. In general, the reasons to use <tt class="calibre11">when</tt> are </p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24">No else-part is associated with the result of a conditional.</li><li value="2" class="calibre24">You require an implicit <tt class="calibre11">do</tt> in order to perform side-effects. </li></ul><p class="calibre5">The reasons for the use of <tt class="calibre11">if</tt> would therefore be the inverse of those listed. </p><p class="calibre5"><span class="calibre10"><span class="bold">Loop </span></span></p><p class="calibre7">Sometimes you want to loop back not to the top of the function, but to somewhere inside. For example, in <tt class="calibre11">sum-down-from</tt> you might prefer that callers not have to provide an initial value for <tt class="calibre11">sum</tt>. To help, there’s a <tt class="calibre11">loop</tt> form that acts exactly like <tt class="calibre11">let</tt> but provides a target for <tt class="calibre11">recur</tt> to jump to. It’s used like this: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn sum-down-from [initial-x]<br class="calibre3"/>  (loop [sum 0, x initial-x]<br class="calibre3"/>    (if (pos? x)<br class="calibre3"/>      (recur (+ sum x) (dec x))<br class="calibre3"/>      sum)))</tt></span></blockquote><p class="calibre12">Upon entering the <tt class="calibre11">loop</tt> form, the locals <tt class="calibre11">sum</tt> and <tt class="calibre11">x</tt> are initialized, just as they would be for a <tt class="calibre11">let</tt>. </p><p class="calibre5">A <tt class="calibre11">recur</tt> always loops back to the closest enclosing <tt class="calibre11">loop</tt> or <tt class="calibre11">fn</tt>, so in this case it’ll go to the <tt class="calibre11">loop</tt>. The loop locals are rebound to the values given in <tt class="calibre11">recur</tt>. The looping and rebinding will continue until finally <tt class="calibre11">x</tt> is no longer positive. The return value of the whole loop expression is <tt class="calibre11">sum</tt>, just as it was for the earlier function. </p><p class="calibre5"><span class="calibre10"><span class="bold">Tail Position </span></span></p><p class="calibre7">Now that we’ve looked at a couple examples of how to use <tt class="calibre11">recur</tt>, we must discuss an important restriction. The <tt class="calibre11">recur</tt> form can only appear in the tail position of a function or <tt class="calibre11">loop</tt>. So what’s a tail position? Succinctly, a form is in the tail position of an expression when its value may be the return value of the whole expression. Consider this function: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn absolute-value [x]<br class="calibre3"/>  (if (pos? x)<br class="calibre3"/>    x            ; "then" clause<br class="calibre3"/>    (- x)))      ; "else" clause</tt></span></blockquote><p class="calibre12">It takes a single parameter and names it <tt class="calibre11">x</tt>. If <tt class="calibre11">x</tt> is already a positive number, then x is returned; otherwise the opposite of <tt class="calibre11">x</tt> is returned. </p><p class="calibre5">The <tt class="calibre11">if</tt> form is in the function’s tail position because whatever it returns, the whole function will return. The <tt class="calibre11">x</tt> in the “then” clause is also in a tail position of the function. But the <tt class="calibre11">x</tt> in the “else” clause is <span class="italic">not</span> in the function’s tail position because the value of <tt class="calibre11">x</tt> is passed to the <tt class="calibre11">-</tt> function, not returned directly. The else clause as a whole <tt class="calibre11">(- x)</tt> is in a tail position. </p><p class="calibre5">If you try to use the <tt class="calibre11">recur</tt> form somewhere other than a tail position, Clojure will remind you at compile time: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(fn [x] (recur x) (println x))<br class="calibre3"/>; java.lang.UnsupportedOperationException:<br class="calibre3"/>;    Can only recur from tail position</tt></span></blockquote><p id="filepos202245" class="calibre12">You’ve seen how Clojure provides core functionality available to most popular programming languages, albeit from a different bent. But in the next section, we’ll cover the notion of quoting forms, which are in many ways unique to the Lisp family of languages and may seem alien to programmers coming from classically imperative and/ or object-oriented languages. </p><p id="filepos202645" class="calibre5"><span class="calibre18"><span class="bold">2.6. Preventing things from happening: quoting </span></span></p><p class="calibre7">Clojure has two quoting forms: quote and syntax-quote. Both are simple bits of syntax you can put in front of a form in your program. They’re the primary ways for including literal scalars and composites in your Clojure program <span class="italic">without</span> evaluating them as code. But before quoting forms can make sense, you need a solid understanding of how expressions are evaluated. </p><p id="filepos203162" class="calibre5"><span class="bold">2.6.1. Evaluation </span><a></a></p><p class="calibre7">When a collection is evaluated, each of its contained items is evaluated first:<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos203534"><span class="calibre33"><span class="calibre8"><span class="underline">7</span></span></span></a><span class="calibre33">]</span></small></sup></p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos203534" class="calibre32"><span class="calibre33">7</span></small></sup><span class="calibre10"> ...unless it’s a list that starts with the name of a macro or special form. We’ll get to that later. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(cons 1 [2 3])</tt></span></blockquote><p class="calibre12">If you enter this at the REPL, the form as a whole will be evaluated. In this specific example, the function <tt class="calibre11">cons</tt> “constructs” a new sequence with its first argument in the front of the sequence provided as its second. Because the form is a list, each of the items will be evaluated first. A symbol, when evaluated, is resolved to a local, a Var, or a Java class name. If a local or a Var, its value will be returned: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">cons<br class="calibre3"/>;=&gt; #&lt;core$cons__3806 clojure.core$cons__3806@24442c76&gt;</tt></span></blockquote><p class="calibre12">Literal scalar values evaluate to themselves—evaluating one just returns the same thing:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">1<br class="calibre3"/>;=&gt; 1</tt></span></blockquote><p class="calibre12">The evaluation of another kind of collection, a vector, starts again by evaluating the items it contains. Because they’re literal scalars, nothing much happens. Once that’s done, evaluation of the vector can proceed. Vectors, like scalars and maps, evaluate to themselves: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">[2 3]<br class="calibre3"/>;=&gt; [2 3]</tt></span></blockquote><p class="calibre12">Now that all the items of the original list have been evaluated (to a function, the number 1, and the vector [2 3]), evaluation of the whole list can proceed. Lists are <a id="filepos205283"></a>evaluated differently from vectors and maps: they call functions, or trigger special forms, as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(cons 1 [2 3])<br class="calibre3"/>;=&gt; (1 2 3)</tt></span></blockquote><p class="calibre12">Whatever function was at the head of the list, <tt class="calibre11">cons</tt> in this case, is called with the remaining items of the list as arguments. </p><p id="filepos205689" class="calibre5"><span class="bold">2.6.2. Quoting </span><a></a></p><p class="calibre7">Using a special form looks like calling a function—a symbol as the first item of a list:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(quote tena)</tt></span></blockquote><p class="calibre12">Each special form has its own evaluation rules. The <tt class="calibre11">quote</tt> special form simply prevents its argument from being evaluated at all. Though the symbol <tt class="calibre11">tena</tt> by itself might evaluate to the value of a Var with the value <tt class="calibre11">9</tt>, when it’s inside a <tt class="calibre11">quote</tt> form, it won’t: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def tena 9)<br class="calibre3"/>(quote tena)<br class="calibre3"/>;=&gt; tena</tt></span></blockquote><p class="calibre12">Instead, the whole form evaluates to just the symbol itself. This works for arbitrarily complex arguments to <tt class="calibre11">quote</tt>: nested vectors, maps, even lists that would otherwise be function calls, macro calls, or even more special forms. The whole thing is returned: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(quote (cons 1 [2 3]))<br class="calibre3"/>;=&gt; (cons 1 [2 3])</tt></span></blockquote><p class="calibre12">There are a few reasons you might use the <tt class="calibre11">quote</tt> form, but by far the most common is so that you can use a literal list as a data collection without having Clojure try to call a function. We’ve been careful to use vectors in the examples so far in this section because vectors are never themselves function calls. But if we wanted to use a list instead, a naive attempt would fail: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(cons 1 (2 3))<br class="calibre3"/>; java.lang.ClassCastException:<br class="calibre3"/>;    java.lang.Integer cannot be cast to clojure.lang.IFn</tt></span></blockquote><p class="calibre12">That’s Clojure telling us that an integer (the number 2 here) can’t be used as a function. So we have to prevent the form <tt class="calibre11">(2 3)</tt> from being treated like a function call—exactly what <tt class="calibre11">quote</tt> is for: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(cons 1 (quote (2 3)))<br class="calibre3"/>;=&gt; (1 2 3)</tt></span></blockquote><p class="calibre12">In other Lisps, this need is so common that they provide a shortcut: a single quote. Although it’s used less in Clojure, it’s still provided. The previous example can also be written as </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(cons 1 '(2 3))<br class="calibre3"/>;=&gt; (1 2 3)</tt></span></blockquote><p id="filepos208250" class="calibre12">And look at that: one less pair of parens—always welcome in a Lisp. Remember though that <tt class="calibre11">quote</tt> affects all of its argument, not just the top level. So even though it worked in the preceding examples to replace <tt class="calibre11">[]</tt> with <tt class="calibre11">'()</tt>, this may not always give you the results you want: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">[1 (+ 2 3)]      ;=&gt; [1 5]<br class="calibre3"/>'(1 (+ 2 3))     ;=&gt; (1 (+ 2 3))</tt></span></blockquote><p class="calibre12">Finally, note that the empty list <tt class="calibre11">()</tt> already evaluates to itself; it doesn’t need to be quoted. Quoting the empty list isn’t idiomatic Clojure. </p><p class="calibre5"><span class="calibre10"><span class="bold">Syntax-Quote </span></span></p><p class="calibre7">Like the <tt class="calibre11">quote</tt>, syntax-quote prevents its argument and subforms from being evaluated. Unlike <tt class="calibre11">quote</tt>, it has a few extra features that make it ideal for constructing collections to be used as code. </p><p class="calibre5">Syntax-quote is written as a single back-quote:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">`(1 2 3)<br class="calibre3"/>;=&gt; (1 2 3)</tt></span></blockquote><p class="calibre12">It doesn’t expand to a simple form like <tt class="calibre11">quote</tt>, but to whatever set of expressions is required to support the following features.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos209838"><span class="calibre33"><span class="calibre8"><span class="underline">8</span></span></span></a><span class="calibre33">]</span></small></sup></p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos209838" class="calibre32"><span class="calibre33">8</span></small></sup><span class="calibre10"> A future version of Clojure is likely to expand the back-quote to syntax-quote at read time and implement the rest of syntax-quote’s features as a macro or special form. </span></blockquote><p class="calibre12"><span class="calibre10"><span class="bold">Symbol Auto-Qualification </span></span></p><p class="calibre7">A symbol can begin with a namespace and a slash. These can be called <span class="italic">qualified symbols</span>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">clojure.core/map<br class="calibre3"/>clojure.set/union<br class="calibre3"/>i.just.made.this.up/quux</tt></span></blockquote><p class="calibre12">Syntax-quote will automatically qualify all unqualified symbols in its argument:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">`map<br class="calibre3"/>;=&gt; clojure.core/map<br class="calibre3"/>`Integer<br class="calibre3"/>;=&gt; java.lang.Integer<br class="calibre3"/>`(map even? [1 2 3])<br class="calibre3"/>;=&gt; (clojure.core/map clojure.core/even? [1 2 3])</tt></span></blockquote><p class="calibre12">If the symbol doesn’t name a Var or class that exists yet, syntax-quote will use the current namespace:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">`is-always-right<br class="calibre3"/>;=&gt; user/is-always-right</tt></span></blockquote><p class="calibre12">This behavior will come in handy in <a href="#filepos582816"><span class="calibre8"><span class="underline">chapter 8</span></span></a>, when we discuss macros. </p><p id="filepos211278" class="calibre5"><span class="bold">2.6.3. Unquote </span><a></a></p><p class="calibre7">As you discovered, the <tt class="calibre11">quote</tt> special form prevents its argument, and all of its sub-forms, from being evaluated. But there will come a time when you’ll want <span class="italic">some</span> of its <a id="filepos211555"></a>constituent forms to be evaluated. The way to accomplish this feat is to use what’s known as an <span class="italic">unquote</span>. An unquote is used to demarcate specific forms as requiring evaluation by prefixing them with the symbol <tt class="calibre11">~</tt> within the body of a syntax-quote: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">`(+ 10 (* 3 2))<br class="calibre3"/>;=&gt; (clojure.core/+ 10 (clojure.core/* 3 2))<br class="calibre3"/><br class="calibre3"/>`(+ 10 ~(* 3 2))<br class="calibre3"/>;=&gt; (clojure.core/+ 10 6)</tt></span></blockquote><p class="calibre12">What just happened? The final form uses an unquote to evaluate the subform <tt class="calibre11">(* 3 2)</tt>, which of course performs a multiplication of 3 and 2, thus inserting the result into the outermost syntax-quoted form. The unquote can be used to denote any Clojure expression as requiring evaluation: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">`(1 2 ~3)<br class="calibre3"/>;=&gt; (1 2 3)<br class="calibre3"/><br class="calibre3"/>(let [x 2]<br class="calibre3"/>`(1 ~x 3))<br class="calibre3"/>;=&gt; (1 2 3)<br class="calibre3"/><br class="calibre3"/>`(1 ~(2 3))<br class="calibre3"/>;=&gt; java.lang.ClassCastException: java.lang.Integer</tt></span></blockquote><p class="calibre12">Whoops! By using the unquote, we’ve told Clojure that the marked form should be evaluated. But the marked form here is <tt class="calibre11">(2 3)</tt>, and what happens when Clojure encounters an expression like this? It attempts to evaluate it as a function! Therefore, care needs to be taken with unquote to ensure that the form requiring evaluation is of the form that you expect. The more appropriate way to perform the previous task would thus be </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(let [x '(2 3)] `(1 ~x))<br class="calibre3"/>;=&gt; (1 (2 3))</tt></span></blockquote><p class="calibre12">This provides a level of indirection such that the expression being evaluated is no longer <tt class="calibre11">(2 3)</tt> but <tt class="calibre11">x</tt>. But this new way breaks the pattern of the previous examples that returned a list of <tt class="calibre11">(1 2 3)</tt>. </p><p id="filepos213554" class="calibre5"><span class="bold">2.6.4. Unquote-splicing </span><a></a></p><p class="calibre7">Clojure provides a handy feature to solve exactly the problem posed earlier. A variant of unquote called <span class="italic">unquote-splicing</span> works similarly to unquote, but a little differently: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(let [x '(2 3)] `(1 ~@x))<br class="calibre3"/>;=&gt; (1 2 3)</tt></span></blockquote><p class="calibre12">Note the <tt class="calibre11">@</tt> in <tt class="calibre11">~@</tt>, which tells Clojure to unpack the sequence <tt class="calibre11">x</tt>, splicing it into the resulting list rather than inserting it as a nested list. </p><p id="filepos214180" class="calibre5"><span class="bold">2.6.5. Auto-gensym </span><a></a></p><p id="filepos214245" class="calibre7">Sometimes you need an unqualified symbol, such as for a parameter or <tt class="calibre11">let</tt> local name. The easiest way to do this inside a syntax-quote is to append a <tt class="calibre11">#</tt> to the symbol name. This will cause Clojure to generate a new unqualified symbol: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">`potion#<br class="calibre3"/>;=&gt; potion__211__auto__</tt></span></blockquote><p class="calibre12">Sometimes even this isn’t enough, either because you need to refer to the same symbol in multiple syntax-quotes or because you want to capture a particular unqualified symbol. </p><p class="calibre5">Until this point, we’ve covered many of the basic features making Clojure a unique flavor of Lisp. But one of the main goals that Clojure excels at meeting is that of interoperability with a host language and runtime, namely Java and the Java Virtual Machine. </p><p id="filepos215159" class="calibre5"><span class="calibre18"><span class="bold">2.7. Leveraging Java via interop </span></span></p><p class="calibre7">Clojure is symbiotic with its host,<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos215799"><span class="calibre33"><span class="calibre8"><span class="underline">9</span></span></span></a><span class="calibre33">]</span></small></sup> providing its rich and powerful features, while Java provides an object model, libraries, and runtime support. In this section, we’ll take a brief look at how Clojure allows you to access Java classes and class members, and how you can create instances and access their members. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos215799" class="calibre32"><span class="calibre33">9</span></small></sup><span class="calibre10"> We’ll focus on the Java Virtual Machine throughout this book, but Clojure has also been hosted on the .NET Common Language Runtime (CLR) and JavaScript (</span><a href="http://clojurescript.n01se.net/repl/"><span class="calibre10"><span class="calibre8"><span class="underline">http://clojurescript.n01se.net/repl/</span></span></span></a><span class="calibre10">). </span></blockquote><p id="filepos216201" class="calibre35"><span class="bold">2.7.1. Accessing static class members </span><a></a></p><p class="calibre7">Clojure provides powerful mechanisms for accessing, creating, and mutating Java classes and instances. The trivial case is accessing static class properties: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">java.util.Locale/JAPAN<br class="calibre3"/>;=&gt; #&lt;Locale ja_JP&gt;</tt></span></blockquote><p class="calibre12">Idiomatic Clojure prefers that you access static class members using a syntax like accessing a namespace-qualified Var:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(Math/sqrt 9)<br class="calibre3"/>;=&gt; 3.0</tt></span></blockquote><p class="calibre12">The preceding call is to the <tt class="calibre11">java.lang.Math#sqrt</tt> static method. </p><p id="filepos216992" class="calibre5"><span class="bold">2.7.2. Creating Java class instances </span><a></a></p><p class="calibre7">Creating Java class instances is likewise a trivial matter with Clojure. The <tt class="calibre11">new</tt> special form closely mirrors the Java model: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(new java.util.HashMap {"foo" 42 "bar" 9 "baz" "quux"})<br class="calibre3"/>;=&gt; #&lt;HashMap {baz=quux, foo=42, bar=9}&gt;</tt></span></blockquote><p class="calibre12">The second, more succinct, Clojure form to create instances is actually the idiomatic form:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(java.util.HashMap. {"foo" 42 "bar" 9 "baz" "quux"})<br class="calibre3"/>;=&gt; #&lt;HashMap {baz=quux, foo=42, bar=9}&gt;</tt></span></blockquote><p id="filepos217773" class="calibre12">As you can see, the class name was followed by a dot in order to signify a constructor call. </p><p id="filepos217899" class="calibre5"><span class="bold">2.7.3. Accessing Java instance members with the . operator </span><a></a></p><p class="calibre7">To access instance properties, precede the property or method name with a dot:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(.x (java.awt.Point. 10 20))<br class="calibre3"/>;=&gt; 10</tt></span></blockquote><p class="calibre12">This returns the value of the field <tt class="calibre11">x</tt> from the <tt class="calibre11">Point</tt> instance given. </p><p class="calibre5">To access instance methods, the dot form allows an additional argument to be passed to the method:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(.divide (java.math.BigDecimal. "42") 2M)<br class="calibre3"/>;=&gt; 21M</tt></span></blockquote><p class="calibre12">The preceding example calls the <tt class="calibre11">#divide</tt> method on the class <tt class="calibre11">BigDecimal</tt>. </p><p id="filepos218764" class="calibre5"><span class="bold">2.7.4. Setting Java instance properties </span><a></a></p><p class="calibre7">In the absence of mutators in the form <tt class="calibre11">setXXX</tt>, Java instance properties can be set via the <tt class="calibre11">set!</tt> function: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(let [origin (java.awt.Point. 0 0)]<br class="calibre3"/>  (set! (.x origin) 15)<br class="calibre3"/>  (str origin))<br class="calibre3"/>;=&gt; "java.awt.Point[x=15,y=0]"</tt></span></blockquote><p class="calibre12">The first argument to <tt class="calibre11">set!</tt> is the instance member access form. </p><p id="filepos219339" class="calibre5"><span class="bold">2.7.5. The .. macro </span><a></a></p><p class="calibre7">When working with Java, it’s common practice to chain together a sequence of method calls on the return type of the previous method call: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">new java.util.Date().toString().endsWith("2010") /* Java code */</tt></span></blockquote><p class="calibre12">Using Clojure’s dot special form, the following code is equivalent:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(.endsWith (.toString (java.util.Date.)) "2010") ; Clojure code<br class="calibre3"/>;=&gt; true</tt></span></blockquote><p class="calibre12">Though correct, the preceding code is difficult to read and will only become more so when we lengthen the chain of method calls. To combat this, Clojure provides the <tt class="calibre11">..</tt> macro, which can simplify the call chain as follows: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(.. (java.util.Date.) toString (endsWith "2010"))</tt></span></blockquote><p class="calibre12">The preceding <tt class="calibre11">..</tt> call closely follows the equivalent Java code and is much easier to read. Bear in mind, you might not see <tt class="calibre11">..</tt> used often in Clojure code found in the wild outside of the context of macro definitions. Instead, Clojure provides the <tt class="calibre11">-&gt;</tt> and <tt class="calibre11">-&gt;&gt;</tt> macros, which can be used similarly to the <tt class="calibre11">..</tt> macro but are also useful in non-interop <a id="filepos220826"></a>situations, thus making them the preferred method call facilities in most cases. The <tt class="calibre11">-&gt;</tt> and <tt class="calibre11">-&gt;&gt;</tt> macros are covered in more depth in the introduction to <a href="#filepos582816"><span class="calibre8"><span class="underline">chapter 8</span></span></a>. </p><p id="filepos221086" class="calibre5"><span class="bold">2.7.6. The doto macro </span><a></a></p><p class="calibre7">When working with Java, it’s also common to initialize a fresh instance by calling a set of mutators:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">java.util.HashMap props = new java.util.HashMap();   /* More java code. */<br class="calibre3"/>props.put("HOME", "/home/me");                       /* Sorry. */<br class="calibre3"/>props.put("SRC",  "src");<br class="calibre3"/>props.put("BIN",  "classes");</tt></span></blockquote><p class="calibre12">But using this method is overly verbose and can be streamlined using the <tt class="calibre11">doto</tt> macro, which takes the form </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(doto (java.util.HashMap.)<br class="calibre3"/>  (.put "HOME" "/home/me")<br class="calibre3"/>  (.put "SRC"  "src")<br class="calibre3"/>  (.put "BIN"  "classes"))<br class="calibre3"/><br class="calibre3"/>;=&gt; #&lt;HashMap {HOME=/home/me, BIN=classes, SRC=src}&gt;</tt></span></blockquote><p class="calibre12">Though these Java and Clojure comparisons are useful, it shouldn’t be assumed that their compiled structures are the same.</p><p id="filepos222242" class="calibre5"><span class="bold">2.7.7. Defining classes </span><a></a></p><p class="calibre7">Clojure provides the <tt class="calibre11">reify</tt> and <tt class="calibre11">deftype</tt> macros as possible ways to create realizations of Java interfaces, but we’ll defer covering them until <a href="#filepos642230"><span class="calibre8"><span class="underline">chapter 9</span></span></a>. Additionally, Clojure provides a macro named <tt class="calibre11">proxy</tt> that can be used to implement interfaces and extend base classes on the fly. Similarly, using the <tt class="calibre11">gen-class</tt> macro, you can generate statically named classes. More details about <tt class="calibre11">proxy</tt> and <tt class="calibre11">gen-class</tt> are available in <a href="#filepos731329"><span class="calibre8"><span class="underline">chapter 10</span></span></a>. </p><p id="filepos222949" class="calibre5"><span class="calibre18"><span class="bold">2.8. Exceptional circumstances </span></span></p><p class="calibre7">We’ll now talk briefly about Clojure’s facilities for handling exceptions. Like Java, Clojure provides a couple of forms for throwing and catching runtime exceptions: namely <tt class="calibre11">throw</tt> and <tt class="calibre11">catch</tt>, respectively. </p><p id="filepos223301" class="calibre5"><span class="bold">2.8.1. A little pitch and catch </span><a></a></p><p class="calibre7">The mechanism to throw an exception is fairly straightforward:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(throw (Exception. "I done throwed"))<br class="calibre3"/>;=&gt; java.lang.Exception: I done throwed</tt></span></blockquote><p class="calibre12">The syntax for catching exceptions in Clojure is similar to that of Java:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn throw-catch [f]<br class="calibre3"/>  [(try<br class="calibre3"/>    (f)<br class="calibre3"/>    (catch ArithmeticException e "No dividing by zero!")<br class="calibre3"/>    (catch Exception e (str "You are so bad " (.getMessage e)))<br class="calibre3"/>    (finally (println "returning... ")))])<br class="calibre3"/><br class="calibre3"/>(throw-catch #(/ 10 5))<br class="calibre3"/>; returning...<br class="calibre3"/>;=&gt; [2]<br class="calibre3"/><br class="calibre3"/>(throw-catch #(/ 10 0))<br class="calibre3"/>; returning...<br class="calibre3"/>;=&gt; ["No dividing by zero!"]<br class="calibre3"/><br class="calibre3"/>(throw-catch #(throw (Exception. "foo")))<br class="calibre3"/>; returning...<br class="calibre3"/>;=&gt; ["You are so bad foo"]</tt></span></blockquote><p id="filepos224447" class="calibre12">The major difference between the way that Java handles exceptions compared to Clojure is that Clojure doesn’t adhere to checked exception requirements. In the next, final section of our introduction to Clojure, we present namespaces, which might look vaguely familiar if you’re familiar with Java or Common Lisp. </p><p id="filepos224797" class="calibre5"><span class="calibre18"><span class="bold">2.9. Namespaces </span></span></p><p class="calibre7">Clojure’s namespaces provide a way to bundle related functions, macros, and values. In this section, we’ll briefly talk about how to create namespaces and how to reference and use things from other namespaces. </p><p id="filepos225121" class="calibre5"><span class="bold">2.9.1. Creating namespaces using ns </span><a></a></p><p class="calibre7">To create a new namespace, you can use the <tt class="calibre11">ns</tt> macro: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(ns joy.ch2)</tt></span></blockquote><p class="calibre12">Whereupon your REPL prompt will now display as:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">joy.ch2=&gt;</tt></span></blockquote><p class="calibre12">This prompt shows that you’re working within the context of the <tt class="calibre11">joy.ch2</tt> namespace. Clojure also provides a Var <tt class="calibre11">*ns*</tt> that holds the value of the current namespace. Any Var created will be a member of the current namespace: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn hello [] (println "Hello Cleveland!"))<br class="calibre3"/>(defn report-ns [] (str "The current namespace is " *ns*))<br class="calibre3"/><br class="calibre3"/>(report-ns)<br class="calibre3"/>;=&gt; "The current namespace is joy.ch2"</tt></span></blockquote><p class="calibre12">Entering a symbol within a namespace will cause Clojure to attempt to look up its value within the current namespace:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">hello<br class="calibre3"/>;=&gt; #&lt;ch2$hello joy.ch2$hello@2af8f5&gt;</tt></span></blockquote><p class="calibre12">You can create new namespaces at any time:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(ns joy.another)</tt></span></blockquote><p class="calibre12">Again, you’ll notice that your prompt has changed, indicating that the new context is <tt class="calibre11">joy.another</tt>. Attempting to run <tt class="calibre11">report-ns</tt> will no longer work: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(report-ns)<br class="calibre3"/>; java.lang.Exception:<br class="calibre3"/>;   Unable to resolve symbol: report-ns in this context</tt></span></blockquote><p id="filepos226995" class="calibre12">This is because <tt class="calibre11">report-ns</tt> exists in the <tt class="calibre11">joy.ch1</tt> namespace and is only accessible via its fully qualified name <tt class="calibre11">joy.ch2/report-ns</tt>. But this will only work for namespaces created locally or those previously loaded, which we’ll discuss next. </p><p id="filepos227295" class="calibre5"><span class="bold">2.9.2. Loading other namespaces with :require </span><a></a></p><p class="calibre7">Creating a namespace is straightforward, but how do you load namespaces? Clojure provides a convenience directive <tt class="calibre11">:require</tt> to take care of this task. Observe the following: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(ns joy.req<br class="calibre3"/>  (:require clojure.set))<br class="calibre3"/><br class="calibre3"/>(clojure.set/intersection #{1 2 3} #{3 4 5})<br class="calibre3"/>;=&gt; #{3}</tt></span></blockquote><p class="calibre12">Using <tt class="calibre11">:require</tt> indicates that you want the <tt class="calibre11">clojure.set</tt> namespace loaded, but you don’t want the mappings of symbols to functions in the <tt class="calibre11">joy.req</tt> namespace. You can also use the <tt class="calibre11">:as</tt> directive to create an additional alias to <tt class="calibre11">clojure.set</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(ns joy.req-alias<br class="calibre3"/>  (:require [clojure.set :as s]))<br class="calibre3"/><br class="calibre3"/>(s/intersection #{1 2 3} #{3 4 5})<br class="calibre3"/>;=&gt; #{3}</tt></span></blockquote><p class="calibre12">The qualified namespace form looks the same as a call to a static class method. The difference is that a namespace symbol can only be used as a qualifier, whereas a class symbol can also be referenced independently: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">clojure.set<br class="calibre3"/>; java.lang.ClassNotFoundException: clojure.set<br class="calibre3"/><br class="calibre3"/>java.lang.Object<br class="calibre3"/>;=&gt; java.lang.Object</tt></span></blockquote><p class="calibre12">The vagaries of namespace mappings from symbols to Vars both qualified and unqualified have the potential for confusion between class names and static methods in the beginning, but the differences will begin to feel natural as you progress. In addition, idiomatic Clojure code will tend to use <tt class="calibre11">my.Class</tt> and <tt class="calibre11">my.ns</tt> for naming classes and namespaces respectively, to help eliminate potential confusion. </p><p id="filepos229279" class="calibre5"><span class="bold">2.9.3. Loading and creating mappings with :use </span><a></a></p><p class="calibre7">Sometimes you’ll want to create mappings from Vars in another namespace to names in your own, in order to avoid calling each function or macro with the qualifying namespace symbol. To create these unqualified mappings, Clojure provides the <tt class="calibre11">:use</tt> directive: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(ns joy.use-ex<br class="calibre3"/>  (:use [clojure.string :only [capitalize]]))<br class="calibre3"/>(map capitalize ["kilgore" "trout"])<br class="calibre3"/>;=&gt; ("Kilgore" "Trout")</tt></span></blockquote><p id="filepos229912" class="calibre12">The <tt class="calibre11">:use</tt> directive indicates that only the function <tt class="calibre11">capitalize</tt> should be mapped in the namespace <tt class="calibre11">joy.use-ex</tt>. Specifying the Vars that you’d like explicit mappings for is good practice in Clojure, as it avoids creating many unnecessary names within a namespace. Unnecessary names increase the odds of names clashes, which you’ll see next. A similar directive to <tt class="calibre11">:use</tt> for managing precise mappings is <tt class="calibre11">:exclude</tt></p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(ns joy.exclusion<br class="calibre3"/>  (:use [clojure.string :exclude [capitalize]]))<br class="calibre3"/><br class="calibre3"/>; WARNING: replace already refers to: #'clojure.core/replace in namespace:<br class="calibre3"/>;    joy.exclusion, being replaced by: #'clojure.string/replace<br class="calibre3"/>; WARNING: reverse already refers to: #'clojure.core/reverse in namespace:<br class="calibre3"/>;    joy.exclusion, being replaced by: #'clojure.string/reverse<br class="calibre3"/><br class="calibre3"/>(map capitalize ["kilgore" "trout"])<br class="calibre3"/>; java.lang.Exception: Unable to resolve symbol: capitalize in this context</tt></span></blockquote><p class="calibre12">The <tt class="calibre11">:exclude</tt> directive indicates that we wanted to map names for all of <tt class="calibre11">clojure. string</tt>’s Vars except for <tt class="calibre11">capitalize</tt>. Indeed, any attempt to use <tt class="calibre11">capitalize</tt> directly throws an exception. But it’s still accessible via <tt class="calibre11">clojure.string/capitalize</tt>. The reason for this accessibility is because <tt class="calibre11">:use</tt> implicitly performs a <tt class="calibre11">:require</tt> directive in addition to creating mappings. As you might’ve noticed, the creation of the <tt class="calibre11">joy. exclusion</tt> namespace signaled two warnings. The reason was that the <tt class="calibre11">clojure. string</tt> namespace defines two functions <tt class="calibre11">reverse</tt> and <tt class="calibre11">replace</tt> that are already defined in the <tt class="calibre11">clojure.core</tt> namespace—which was already loaded by using <tt class="calibre11">ns</tt>. Therefore, when either of those functions are used, the last Var definition wins: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(reverse "abc")<br class="calibre3"/>;=&gt; "cba"<br class="calibre3"/><br class="calibre3"/>(clojure.core/reverse "abc")<br class="calibre3"/>(\c \b \a)</tt></span></blockquote><p class="calibre12">The <tt class="calibre11">clojure.string</tt> version of <tt class="calibre11">reverse</tt> takes precedence over the <tt class="calibre11">clojure.core</tt> version, which may or may not be what we wanted. You should always strive to eliminate the warnings that Clojure presents in these cases. The most obvious strategy for resolving these particular warnings would be to use the <tt class="calibre11">:require</tt> directive to create a namespace alias with <tt class="calibre11">:as</tt> as we showed in the previous section. </p><p id="filepos232609" class="calibre5"><span class="bold">2.9.4. Creating mappings with :refer </span><a></a></p><p class="calibre7">Clojure also provides a <tt class="calibre11">:refer</tt> directive that works almost exactly like <tt class="calibre11">:use</tt> except that it only creates mappings for libraries that have already been loaded: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(ns joy.yet-another<br class="calibre3"/>  (:refer joy.ch1))<br class="calibre3"/><br class="calibre3"/>(report-ns)<br class="calibre3"/>;=&gt; "The current namespace is #&lt;Namespace joy.yet-another&gt;"</tt></span></blockquote><p id="filepos233146" class="calibre12">The use of <tt class="calibre11">:refer</tt> in this way creates a mapping from the name <tt class="calibre11">report-ns</tt> to the actual function located in the namespace <tt class="calibre11">joy.ch2</tt> so that the function can be called normally. You could also set an alias for the same function using the <tt class="calibre11">:rename</tt> keyword taking a map, as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(ns joy.yet-another<br class="calibre3"/>  (:refer joy.ch1 :rename {hello hi}))<br class="calibre3"/><br class="calibre3"/>(hi)<br class="calibre3"/>; Hello Cleveland!</tt></span></blockquote><p class="calibre12">Any namespaces referenced must already be loaded implicitly by being previously defined or by being one of Clojure’s core namespaces, or explicitly loaded through the use of <tt class="calibre11">:require</tt>. It should be noted that <tt class="calibre11">:rename</tt> also works with the <tt class="calibre11">:use</tt> directive. </p><p id="filepos234007" class="calibre5"><span class="bold">2.9.5. Loading Java classes with :import </span><a></a></p><p class="calibre7">To use unqualified Java classes within any given namespace, they should be imported via the <tt class="calibre11">:import</tt> directive, as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(ns joy.java<br class="calibre3"/>  (:import [java.util HashMap]<br class="calibre3"/>           [java.util.concurrent.atomic AtomicLong]))<br class="calibre3"/><br class="calibre3"/>(HashMap. {"happy?" true})<br class="calibre3"/>;=&gt; #&lt;HashMap {happy?=true}&gt;<br class="calibre3"/><br class="calibre3"/>(AtomicLong. 42)<br class="calibre3"/>;=&gt; 42</tt></span></blockquote><p class="calibre12">As a reminder, any classes in the Java <tt class="calibre11">java.lang</tt> package are automatically imported when namespaces are created. We’ll discuss namespaces in more detail in <a href="#filepos643937"><span class="calibre8"><span class="underline">sections 9.1</span></span></a> and <a href="#filepos747545"><span class="calibre8"><span class="underline">10.2</span></span></a>. </p><p id="filepos234957" class="calibre5"><span class="calibre18"><span class="bold">2.10. Summary </span></span></p><p class="calibre7">We named this chapter “Drinking from the Clojure firehose”—and you’ve made it through! How does it feel? We’ve only provided an overview of the topics needed to move on to the following chapters instead of a full-featured language tutorial. Don’t worry if you don’t fully grasp the entirety of Clojure the programming language; understanding will come as you work your way through the book. </p><p class="calibre5">In the next chapter, we’ll take a step back and delve into some topics that can’t be easily categorized, but that deserve attention because of their ubiquity. It’ll be short and sweet and give you a chance to take a breath before moving into the deeper discussions on Clojure later in the book. </p><div class="mbppagebreak"></div><p id="filepos235819" class="calibre5"><span class="calibre6"><span class="bold">Chapter 3. Dipping our toes in the pool </span></span><a></a></p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">This chapter covers</span>
</p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24"><a href="#filepos238908"><span class="calibre8"><span class="underline">Truthiness</span></span></a></li><a id="filepos236245"></a><li value="2" class="calibre24"><a href="#filepos244239"><span class="calibre8"><span class="underline">Nil punning</span></span></a></li><li value="3" class="calibre24"><a href="#filepos248450"><span class="calibre8"><span class="underline">Destructuring</span></span></a></li><li value="4" class="calibre24"><a href="#filepos262019"><span class="calibre8"><span class="underline">Use the REPL to experiment</span></span></a></li></ul><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">Deeper and broader topics will be covered in later chapters, but now’s a good time to pick through an eclectic selection of smaller topics. The topics covered in this chapter stand alone but are important. Covering them now will be a fun way to start digging into practical matters of how to use Clojure. </p><p class="calibre5">We’ve covered a lot of conceptual ground in the previous chapter and built our Clojure lexicon. In this chapter, we’ll take a bit of a detour into some fundamental underpinnings driving idiomatic Clojure source code. First we’ll explore Clojure’s straightforward notions of Truthiness,<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos238570"><span class="calibre33"><span class="calibre8"><span class="underline">1</span></span></span></a><span class="calibre33">]</span></small></sup> or the distinctions between values <a id="filepos237582"></a>considered logical true and those considered logical false. Much of idiomatic Clojure code is built with matters of Truthiness in mind, and we’ll discuss Clojure’s extremely simple rules. After this we’ll then move on to the notion of nil punning, or treating an empty sequence as <tt class="calibre11">nil</tt>. Those of you coming from a background in Lisp may recognize the term, but Clojure handles nil punning differently. We’ll discuss the idioms related to nil punning in Clojure and their rationale. We’ll then cover destructuring—a powerful mechanism for pulling apart collection types and binding their constituent parts as individual values. Using destructuring within your own code can often lead to extremely concise and elegant solutions, and we’ll provide some examples to illustrate this. Finally, we’ll sit down and pair-program together to gain an appreciation for the power of Clojure’s Read-Eval-Print Loop (REPL). </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos238570" class="calibre32"><span class="calibre33">1</span></small></sup><span class="calibre10"> As a deviation from the definition coined by Stephen Colbert in his television show </span><span class="calibre10"><span class="italic">The Colbert Report</span></span><span class="calibre10">. Ours isn’t about matters of gut feeling but rather about matters of Clojure’s logical truth ideal. </span></blockquote><p id="filepos238908" class="calibre5"><span class="calibre18"><span class="bold">3.1. Truthiness </span></span></p><p class="calibre7">Truthfulness may be an important virtue, but it doesn’t come up much in programming. On the other hand, <span class="italic">Truthiness</span>, or the matter of logical truth values in Clojure, is critical. </p><p class="calibre5">Clojure has one Boolean context: the test expression of the <tt class="calibre11">if</tt> form. Other forms that expect Booleans—<tt class="calibre11">and</tt>, <tt class="calibre11">or</tt>, <tt class="calibre11">when</tt>, and so forth—are macros built on top of <tt class="calibre11">if</tt>. It’s here that Truthiness matters. </p><p id="filepos239485" class="calibre5"><span class="bold">3.1.1. What’s truth? </span><a></a></p><p class="calibre7">Every value looks like <tt class="calibre11">true</tt> to <tt class="calibre11">if</tt>, except for <tt class="calibre11">false</tt> and <tt class="calibre11">nil</tt>. That means that values which some languages treat as false—zero-length strings, empty lists, the number zero, and so on—are all treated as <tt class="calibre11">true</tt> in Clojure: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(if true :truthy :falsey)  ;=&gt; :truthy<br class="calibre3"/>(if [] :truthy :falsey)    ;=&gt; :truthy<br class="calibre3"/>(if nil :truthy :falsey)   ;=&gt; :falsey<br class="calibre3"/>(if false :truthy :falsey) ;=&gt; :falsey</tt></span></blockquote><p class="calibre12">This may feel uncomfortable to you, depending on your background. But because branches in a program’s logic are already one of the most likely places for complexity and bugs, Clojure has opted for a simple rule. There’s no need to check a class’s definition to see if it acts like “false” when you think it should (as is sometimes required in Python, for example). Every object is “true” all the time, unless it’s <tt class="calibre11">nil</tt> or <tt class="calibre11">false</tt>. </p><p id="filepos240646" class="calibre5"><span class="bold">3.1.2. Don’t create Boolean objects </span><a></a></p><p class="calibre7">It’s possible to create an object that looks a lot like, but isn’t actually, <tt class="calibre11">false</tt>. </p><p class="calibre5">Java has left a landmine for you here, so take a moment to look at it so that you can step past it gingerly and get on with your life: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def evil-false (Boolean. "false")) ; NEVER do this</tt></span></blockquote><p class="calibre12">This creates a new instance of Boolean—and that’s already wrong! Because there are only two possible values of Boolean, an instance of each has already been made for <a id="filepos241365"></a>you—they’re named <tt class="calibre11">true</tt> and <tt class="calibre11">false</tt>.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos241785"><span class="calibre33"><span class="calibre8"><span class="underline">2</span></span></span></a><span class="calibre33">]</span></small></sup> But here you’ve gone and done it anyway, created a new instance of Boolean and stored it in a Var named <tt class="calibre11">evil-false</tt>. It looks like <tt class="calibre11">false</tt>: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos241785" class="calibre32"><span class="calibre33">2</span></small></sup><span class="calibre10"> Clojure’s </span><span class="calibre10"><tt class="calibre11">true</tt></span><span class="calibre10"> and </span><span class="calibre10"><tt class="calibre11">false</tt></span><span class="calibre10"> instances are the same as Java’s </span><span class="calibre10"><tt class="calibre11">Boolean/TRUE</tt></span><span class="calibre10"> and </span><span class="calibre10"><tt class="calibre11">Boolean/FALSE</tt></span><span class="calibre10">, respectively. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">evil-false<br class="calibre3"/>;=&gt; false</tt></span></blockquote><p class="calibre12">Sometimes it even acts like <tt class="calibre11">false</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(= false evil-false)<br class="calibre3"/>;=&gt; true</tt></span></blockquote><p class="calibre12">But once it gains your trust, it’ll show you just how wicked it is by acting like <tt class="calibre11">true</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(if evil-false :truthy :falsey)<br class="calibre3"/>;=&gt; :truthy</tt></span></blockquote><p class="calibre12">Java’s own documentation warns against the creation of this evil thing, and now you’ve been warned again. If you just want to parse a string, use the Boolean class’s static <tt class="calibre11">valueOf</tt> method instead of its constructor. This is the right way: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(if (Boolean/valueOf "false") :truthy :falsey)<br class="calibre3"/>;=&gt; :falsey</tt></span></blockquote><p id="filepos243213" class="calibre35"><span class="bold">3.1.3. nil versus false </span><a></a></p><p class="calibre7">Rarely do you need to differentiate between the two false values, but if you do, you can use <tt class="calibre11">nil?</tt> and <tt class="calibre11">false?</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(when (nil? nil) "Actually nil, not false")<br class="calibre3"/>;=&gt; "Actually nil, not false"</tt></span></blockquote><p class="calibre12">Keeping in mind the basic rule that everything in Clojure is truthy unless it’s <tt class="calibre11">false</tt> or <tt class="calibre11">nil</tt> is an astonishingly powerful concept, allowing for elegant solutions. Often programming languages have complicated semantics for Truthiness, but Clojure manages to avoid those matters nicely. You’ll see this simplicity leveraged throughout this book and in all examples of idiomatic Clojure source code. </p><p class="calibre5">Building on that theme, we’ll now discuss the matter of <span class="italic">nil punning</span>, which may or may not surprise you given your background. </p><p id="filepos244239" class="calibre5"><span class="calibre18"><span class="bold">3.2. Nil pun with care </span></span></p><p class="calibre7">Because empty collections act like <tt class="calibre11">true</tt> in Boolean contexts, we need an idiom for testing whether there’s anything in a collection to process. Thankfully, Clojure provides just such a technique: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(seq [1 2 3])<br class="calibre3"/>;=&gt; (1 2 3)<br class="calibre3"/><br class="calibre3"/>(seq [])<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p id="filepos244732" class="calibre12">The <tt class="calibre11">seq</tt> function returns a sequence view of a collection, or <tt class="calibre11">nil</tt> if the collection is empty. In a language like Common Lisp, an empty list acts as a <tt class="calibre11">false</tt> value and can be used as a <span class="italic">pun</span> (a term with the same behavior) for such in determining a looping termination. As you saw in <a href="#filepos180747"><span class="calibre8"><span class="underline">section 2.3</span></span></a>, Clojure’s empty sequences are instead truthy, and therefore to use one as a pun for falsity will lead to heartache and despair. One solution that might come to mind is to use <tt class="calibre11">empty?</tt> in the test, leading to the awkward phrase <tt class="calibre11">(when-not (empty? s) ...)</tt>. Though it would work, this isn’t idiomatic. A better solution would be to use <tt class="calibre11">seq</tt> as a termination condition, as in the following function <tt class="calibre11">print-seq</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn print-seq [s]<br class="calibre3"/>  (when (seq s)<br class="calibre3"/>    (prn (first s))<br class="calibre3"/>    (recur (rest s))))<br class="calibre3"/><br class="calibre3"/>(print-seq [1 2])<br class="calibre3"/>; 1<br class="calibre3"/>; 2<br class="calibre3"/>;=&gt; nil<br class="calibre3"/><br class="calibre3"/>(print-seq [])<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p class="calibre12">There are a number of points to take away from this example. First, the use of <tt class="calibre11">seq</tt> as a terminating condition is the idiomatic way to test whether a sequence is empty. If we tested just <tt class="calibre11">s</tt> instead of <tt class="calibre11">(seq s)</tt>, then the terminating condition wouldn’t occur even for empty collections, leading to an infinite loop. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre28"><span class="calibre10"><span class="bold">Prefer </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">Doseq</span></tt></span></p><p class="calibre5">An important point not mentioned is that it would be best to use <tt class="calibre11">doseq</tt> in this case, but that wouldn’t allow us to illustrate our overarching points: the Clojure forms named with <tt class="calibre11">do</tt> at the start (<tt class="calibre11">doseq</tt>, <tt class="calibre11">dotimes</tt>, <tt class="calibre11">do</tt>, and so on) are intended for side-effects in their bodies and generally return <tt class="calibre11">nil</tt> as their results. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">Second, <tt class="calibre11">rest</tt> is used to consume the sequence on the recursive call, which can return a sequence that’s either empty or not empty (has elements). Clojure also provides a <tt class="calibre11">next</tt> function that returns a <tt class="calibre11">seq</tt> of the <tt class="calibre11">rest</tt>, or <tt class="calibre11">(seq (rest s))</tt>, and thus never returns an empty sequence, but <tt class="calibre11">nil</tt> instead. But <tt class="calibre11">rest</tt> is appropriate here because we’re using <tt class="calibre11">seq</tt> explicitly in each subsequent iteration. Finally, <tt class="calibre11">print-seq</tt> is a template for most functions in Clojure, in that it shows that we should generally not assume <tt class="calibre11">seq</tt> has been called on our collection arguments, but instead call <tt class="calibre11">seq</tt> within the function itself and process based on its result. Using this approach fosters a more generic handling of collections, a topic that we explore in great detail in <a href="#filepos332652"><span class="calibre8"><span class="underline">chapter 5</span></span></a>. In the meantime, it’s important to keep in mind the difference between empty collections and <tt class="calibre11">false</tt> values; otherwise your attempts at nil punning may cause groans all around. </p><p class="calibre5">To top off our trifecta of core Clojure concepts, we next explore the most powerful of the three—destructuring. You’ll see just how powerful this mini-language within Clojure can be toward developing elegant and often beautiful solutions. </p><p id="filepos248450" class="calibre5"><span class="calibre18"><span class="bold">3.3. Destructuring </span></span></p><p id="filepos248530" class="calibre7">In the previous section, we briefly described Clojure’s destructuring facility as a mini-language embedded within Clojure. <span class="italic">Destructuring</span> allows us to positionally bind locals based on an expected form for a composite data structure. In this section, we’ll explore how destructuring can be used to pull apart composite structures into bindings through the lens of a simple rolodex example project. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre28"><span class="calibre10"><span class="bold">Pattern Matching</span></span></p><p class="calibre5">Destructuring is loosely related to pattern matching found in Haskell, KRC, or Scala, but much more limited in scope. For more full-featured pattern matching in Clojure, consider using <a href="http://github.com/dcolthorp/matchure"><span class="calibre8"><span class="underline">http://github.com/dcolthorp/matchure</span></span></a>, which may in the future be included in contrib as clojure.core.match. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p id="filepos249678" class="calibre35"><span class="bold">3.3.1. Your assignment, should you choose to accept it </span><a></a></p><p class="calibre7">You’ve heard that the rolodex project has been overdue, but now every developer assigned to it is out sick. The QA team is ready to go, but one function is still missing and it’s a show-stopper. You’re told to drop everything and write the function ASAP. </p><p class="calibre5">The design? Take a vector of length 3 that represents a person’s first, middle, and last names and return a string that will sort in the normal way, like “Steele, Guy Lewis”. What are you waiting for? Why aren’t you done yet?!?! </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def guys-whole-name ["Guy" "Lewis" "Steele"])<br class="calibre3"/><br class="calibre3"/>(str (nth guys-whole-name 2) ", "<br class="calibre3"/>     (nth guys-whole-name 0) " "<br class="calibre3"/>     (nth guys-whole-name 1)))<br class="calibre3"/>;=&gt; "Steele, Guy Lewis"</tt></span></blockquote><p class="calibre12">Alas, by the time you’ve finished typing <tt class="calibre11">guys-whole-name</tt> for the fourth time, it’s too late. The customers have cancelled their orders, and the whole department is bound to be downsized. </p><p class="calibre5">If only you’d known about destructuring.</p><p class="calibre5">Okay, so you’re not likely to lose your job because your function is twice as many lines as it needs to be, but still that’s a lot of code repeated in a pretty small function. And using index numbers instead of named locals makes the purpose of the function more obscure than necessary. </p><p class="calibre5">Destructuring solves both these problems by allowing you to place a collection of names in a binding form where normally you’d put just a single name. One kind of binding form is the list of parameters given in a function definition. </p><p id="filepos251562" class="calibre5"><span class="bold">3.3.2. Destructuring with a vector </span><a></a></p><p class="calibre7">So let’s try that again, but use destructuring with <tt class="calibre11">let</tt> to create more convenient locals for the parts of Guy’s name: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(let [[f-name m-name l-name] guys-whole-name]<br class="calibre3"/>  (str l-name ", " f-name " " m-name))</tt></span></blockquote><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">Positional destructuring</span>
</p><p id="filepos252163" class="calibre7">This positional destructuring doesn’t work on maps and sets because they’re not logically<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos252702"><span class="calibre33"><span class="calibre8"><span class="underline">3</span></span></span></a><span class="calibre33">]</span></small></sup> aligned sequentially. Thankfully, positional destructuring will work with Java’s <tt class="calibre11">java.util.regex.Matcher</tt> and anything implementing the <tt class="calibre11">CharSequence</tt> and <tt class="calibre11">java.util.RandomAccess</tt> interfaces. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos252702" class="calibre32"><span class="calibre33">3</span></small></sup><span class="calibre10"> Technically, positional destructuring might make sense with sorted sets and maps, but alas it doesn’t operate as such. </span></blockquote><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">This is the simplest form of destructuring, where you want to pick apart a sequential thing (a vector of strings in this case, though a list or other sequential collection would work as well), giving each item a name. </p><p class="calibre5">We don’t need it here, but we can also use an ampersand in a destructuring vector to indicate that any remaining values of the input should be collected into a (possibly lazy) seq: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(let [[a b c &amp; more] (range 10)]<br class="calibre3"/>  (println "a b c are:" a b c)<br class="calibre3"/>  (println "more is:" more))<br class="calibre3"/>; a b c are: 0 1 2<br class="calibre3"/>; more is: (3 4 5 6 7 8 9)<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p class="calibre12">Here the locals <tt class="calibre11">a</tt>, <tt class="calibre11">b</tt>, and <tt class="calibre11">c</tt> are created and bound to the first three values of the range. Because the next symbol is an ampersand, the remaining values are made available as a seq bound to <tt class="calibre11">more</tt>. The name <tt class="calibre11">more</tt> is pretty common for this purpose, but isn’t special—you’ll often see <tt class="calibre11">etc</tt> or <tt class="calibre11">xs</tt> instead, or some other name that makes sense in a particular context. </p><p class="calibre5">The final feature of vector destructuring is <tt class="calibre11">:as</tt>, which can be used to bind a local to the entire collection. It must be placed after the <tt class="calibre11">&amp;</tt> local, if there is one, at the end of the destructuring vector: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(let [range-vec (vec (range 10))<br class="calibre3"/>      [a b c &amp; more :as all] range-vec]<br class="calibre3"/>  (println "a b c are:" a b c)<br class="calibre3"/>  (println "more is:" more)<br class="calibre3"/>  (println "all is:" all))<br class="calibre3"/>; a b c are: 0 1 2<br class="calibre3"/>; more is: (3 4 5 6 7 8 9)<br class="calibre3"/>; all is: [0 1 2 3 4 5 6 7 8 9]<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p class="calibre12">We made <tt class="calibre11">range-vec</tt> a vector in this example, and the directive <tt class="calibre11">:as</tt> binds the input collection as-is, entirely unmolested, so that the vector stays a vector. This is in contrast to <tt class="calibre11">&amp;</tt>, which bound <tt class="calibre11">more</tt> to a seq, not a vector. </p><p id="filepos255272" class="calibre5"><span class="bold">3.3.3. Destructuring with a map </span><a></a></p><p id="filepos255350" class="calibre7">Perhaps passing a name as a three-part vector wasn’t a good idea in the first place. It might be better stored in a map: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def guys-name-map<br class="calibre3"/>  {:f-name "Guy" :m-name "Lewis" :l-name "Steele"})</tt></span></blockquote><p class="calibre12">But now we can’t use a vector to pick it apart effectively. Instead, we use a map:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(let [{f-name :f-name, m-name :m-name, l-name :l-name} guys-name-map]<br class="calibre3"/>  (str l-name ", " f-name " " m-name))</tt></span></blockquote><p class="calibre12">A couple things about this example may jump out at you. One might be that it still seems repetitive—we’ll get to that in a moment. </p><p class="calibre5">Another might be that it looks a bit unexpected to have the keywords like <tt class="calibre11">:f-name</tt> on the right-hand side of each pair even though the input map had keywords on the left. There are a couple reasons for that. The first is to help keep the pattern of the name on the left getting the value specified by the thing on the right. That is, the new local <tt class="calibre11">f-name</tt> gets the value looked up in the map by the key <tt class="calibre11">:f-name</tt>, just as the whole map gets its value from <tt class="calibre11">guys-name-map</tt> in the earlier <tt class="calibre11">def</tt> form. </p><p class="calibre5">The second reason is because it allows us to conjure up other destructuring features by using forms that would otherwise make no sense. Because the item on the left of each pair will be a new local name, it must be a symbol or possibly a nested destructuring form. But one thing it can’t be is a keyword, unless the keyword is a specially supported feature such as <tt class="calibre11">:keys</tt>, <tt class="calibre11">:strs</tt>, <tt class="calibre11">:syms</tt>, <tt class="calibre11">:as</tt>, and <tt class="calibre11">:or</tt>. </p><p class="calibre5">We’ll discuss the <tt class="calibre11">:keys</tt> feature first because it nicely handles the repetitiveness we mentioned earlier. It allows us to rewrite our solution like this: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(let [{:keys [f-name m-name l-name]} guys-name-map]<br class="calibre3"/>  (str l-name ", " f-name " " m-name))</tt></span></blockquote><p class="calibre12">So by using <tt class="calibre11">:keys</tt> instead of a binding form, we’re telling Clojure that the next form will be a vector of names that it should convert to keywords such as <tt class="calibre11">:f-name</tt> in order to look up their values in the input map. Similarly, if we had used <tt class="calibre11">:strs</tt>, Clojure would be looking for items in the map with string keys such as <tt class="calibre11">"f-name"</tt>, and <tt class="calibre11">:syms</tt> would indicate symbol keys. </p><p class="calibre5">The directives <tt class="calibre11">:keys</tt>, <tt class="calibre11">:strs</tt>, <tt class="calibre11">:syms</tt>, and regular named bindings can appear in any combination and in any order. But sometimes you’ll want to get at the original map—in other words, the keys that you didn’t name individually by any of the methods just described. For that, you want <tt class="calibre11">:as</tt>, which works just like it does with vector destructuring: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(let [{f-name :f-name, :as whole-name} guys-name-map]<br class="calibre3"/>  whole-name)<br class="calibre3"/>;=&gt; {:f-name "Guy", :m-name "Lewis", :l-name "Steele"}</tt></span></blockquote><p class="calibre12">If the destructuring map looks up a key that’s not in the source map, it’s normally bound to <tt class="calibre11">nil</tt>, but you can provide different defaults with <tt class="calibre11">:or</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(let [{:keys [title f-name m-name l-name], :or {title "Mr."}} guys-name-map]<br class="calibre3"/>  (println title f-name m-name l-name))<br class="calibre3"/>; Mr. Guy Lewis Steele<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p class="calibre12"><span class="calibre10"><span class="bold">Associative Destructuring </span></span></p><p id="filepos259269" class="calibre7">One final technique worth mentioning is associative destructuring. Using a map to define a number of destructure bindings isn’t limited to maps. We can also destructure a vector by providing a map declaring the local name as indices into them, as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(let [{first-thing 0, last-thing 3} [1 2 3 4]]<br class="calibre3"/>  [first-thing last-thing])<br class="calibre3"/>;=&gt; [1 4]</tt></span></blockquote><p class="calibre12">We’ll explore associative destructuring later in <a href="#filepos430932"><span class="calibre8"><span class="underline">section 6.1</span></span></a> when we discuss Clojure’s support for named structures. You’ve seen the shapes that destructuring takes within the <tt class="calibre11">let</tt> form, but you’re not limited to that exclusively, as we’ll explore next. </p><p id="filepos260119" class="calibre5"><span class="bold">3.3.4. Destructuring in function parameters </span><a></a></p><p class="calibre7">All the preceding examples use <tt class="calibre11">let</tt> to do their destructuring, but exactly the same features are available in function parameters. Each function parameter can destructure a map or sequence: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn print-last-name [{:keys [l-name]}]<br class="calibre3"/>  (println l-name))<br class="calibre3"/><br class="calibre3"/>(print-last-name guys-name-map)<br class="calibre3"/>; Steele<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p class="calibre12">Note that function arguments can include an ampersand as well, but this isn’t the same as destructuring. Instead, that’s part of their general support for multiple function bodies, each with its own number of parameters. </p><p id="filepos260941" class="calibre5"><span class="bold">3.3.5. Destructuring versus accessor methods </span><a></a></p><p class="calibre7">In many object-oriented languages, you might create new classes to manage your application data objects, each with its own set of getter and setter methods. It’s idiomatic in Clojure to instead build your application objects by composing maps and vectors as necessary. This makes destructuring natural and straightforward. So anytime you find that you’re calling <tt class="calibre11">nth</tt> on the same collection a few times, or looking up constants in a map, or using <tt class="calibre11">first</tt> or <tt class="calibre11">next</tt>, consider using destructuring instead. </p><p class="calibre5">Now that we’ve made it through the cursory introduction to Clojure, let’s take some time to pair-program (<a href="#filepos1084323"><span class="calibre8"><span class="underline">Williams 2002</span></span></a>). In the next section, we’ll take many of the bare necessities that you’ve just learned and walk through the creation of a couple interesting functions for drawing pretty pictures within Clojure’s REPL. </p><p id="filepos262019" class="calibre5"><span class="calibre18"><span class="bold">3.4. Using the REPL to experiment </span></span></p><p id="filepos262114" class="calibre7">Most software development projects include a stage where you’re not sure what needs to happen next. Perhaps you need to use a library or part of a library you’ve never touched before. Or perhaps you know what your input to a particular function will be, and what the output should be, but you aren’t sure how to get from one to other. In more static languages, this can be time-consuming and frustrating; but by leveraging the power of the Clojure REPL, the interactive command prompt, it can actually be fun. </p><p id="filepos262663" class="calibre5"><span class="bold">3.4.1. Experimenting with seqs </span><a></a></p><p class="calibre7">Say someone suggests to you that coloring every pixel of a canvas with the xor of its x and y coordinates might produce an interesting image. It shouldn’t be too hard, so you can jump right in. You’ll need to perform an operation on every x and y in a pair of ranges. Do you know how <tt class="calibre11">range</tt> works? </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(range 5)<br class="calibre3"/>;=&gt; (0 1 2 3 4)</tt></span></blockquote><p class="calibre12">That should do nicely for one coordinate. To nest seqs, <tt class="calibre11">for</tt> often does the trick. But again, rather than writing code and waiting until you have enough to warrant compiling and testing, you can just try it: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(for [x (range 2) y (range 2)] [x y])<br class="calibre3"/>;=&gt; ([0 0] [0 1] [1 0] [1 1])</tt></span></blockquote><p class="calibre12">There are the coordinates that will form your input. Now you need to xor them:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(xor 1 2)<br class="calibre3"/>;=&gt; java.lang.Exception: Unable to resolve symbol: xor in this context</tt></span></blockquote><p class="calibre12">Bother—no function named <tt class="calibre11">xor</tt>. Fortunately, Clojure provides <tt class="calibre11">find-doc</tt>, which searches not just function names but also their doc strings for the given term: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(find-doc "xor")<br class="calibre3"/>; -------------------------<br class="calibre3"/>; clojure.core/bit-xor<br class="calibre3"/>; ([x y])<br class="calibre3"/>;   Bitwise exclusive or<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p class="calibre12">So the function you need is called <tt class="calibre11">bit-xor</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(bit-xor 1 2)<br class="calibre3"/>;=&gt; 3</tt></span></blockquote><p class="calibre12">Perfect! Now you want to adjust your earlier <tt class="calibre11">for</tt> form to return the <tt class="calibre11">bit-xor</tt> along with the <tt class="calibre11">x</tt> and <tt class="calibre11">y</tt>. The easiest way to do this will depend on what tool is hosting your REPL. In many, you can just press the up-arrow key on your keyboard a couple of times to bring back the earlier <tt class="calibre11">for</tt> form. You’re not going to want to retype things to make minor adjustments, so take a moment right now to figure out a method you like that will allow you to make a tweak like this by inserting the <tt class="calibre11">bit-xor</tt> call: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(for [x (range 2) y (range 2)] [x y (bit-xor x y)])<br class="calibre3"/>;=&gt; ([0 0 0] [0 1 1] [1 0 1] [1 1 0])</tt></span></blockquote><p id="filepos265366" class="calibre12">That looks about right. Now you’re about to shift gears to pursue the graphics side of this problem, so tuck that bit of code away in a function so it’ll be easy to use later: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn xors [max-x max-y] (for [x (range max-x) y (range max-y)] [x y (bit-<br class="calibre3"/>     xor x y)]))<br class="calibre3"/>(xors 2 2)<br class="calibre3"/>;=&gt; ([0 0 0] [0 1 1] [1 0 1] [1 1 0])</tt></span></blockquote><p class="calibre12">You might even save that into a .clj file somewhere, if you haven’t already.</p><p id="filepos265972" class="calibre5"><span class="bold">3.4.2. Experimenting with graphics </span><a></a></p><p class="calibre7">Clojure’s REPL isn’t just for playing around; it’s also great for experimenting with Java libraries. We believe that there’s no better environment for exploring a Java API than Clojure’s REPL. To illustrate, poke around with java.awt, starting with a Frame: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def frame (java.awt.Frame.))<br class="calibre3"/>;=&gt; #'user/frame</tt></span></blockquote><p class="calibre12">That should’ve created a Frame, but no window appeared. Did it work at all?</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">frame<br class="calibre3"/>;=&gt; #&lt;Frame java.awt.Frame[frame0,0,22,0x0,invalid,hidden,...]&gt;</tt></span></blockquote><p class="calibre12">Well, you have a Frame object, but perhaps the reason you can’t see it is hinted at by the word <span class="italic">hidden</span> in the <tt class="calibre11">#&lt;Frame...&gt;</tt> printout. Perhaps the Frame has a method you need to call to make it visible. One way to find out would be to check the Javadoc of the object, but because you’re at the REPL already, let’s try something else. You’ve already seen how the <tt class="calibre11">for</tt> macro works, so maybe you can check a class for which methods it has to see whether one that you can use is available: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(for [method (seq (.getMethods java.awt.Frame))<br class="calibre3"/>        :let [method-name (.getName method)]<br class="calibre3"/>        :when (re-find #"Vis" method-name)]<br class="calibre3"/>  method-name)<br class="calibre3"/>;=&gt; ("setVisible" "isVisible")</tt></span></blockquote><p class="calibre12">The <tt class="calibre11">for</tt> macro takes a <tt class="calibre11">:let</tt> flag and bindings vector that works similarly to the <tt class="calibre11">let</tt> special form that you use to bind the local <tt class="calibre11">method-name</tt> to the result of calling the method <tt class="calibre11">.getName</tt> on each <tt class="calibre11">method</tt> in turn. The <tt class="calibre11">:when</tt> is used to limit the elements used in its body to only those that return a truthy value in the expression after the directive. Using these directives allows you to iterate through the methods and build a seq of those whose names match a regular expression <tt class="calibre11">#"Vis"</tt>. We’ll cover Clojure’s regular expression syntax in <a href="#filepos283018"><span class="calibre8"><span class="underline">section 3.5</span></span></a>. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre28"><span class="calibre10"><span class="bold">The Contrib Function </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">Show</span></tt></span></p><p class="calibre5">The clojure-contrib library also has a function <tt class="calibre11">show</tt> in the <tt class="calibre11">clojure.contrib.repl-utils</tt> namespace that allows for more useful printouts of class members than we show using <tt class="calibre11">for</tt>. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">Your query returned two potential methods, so try out each of them:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(.isVisible frame)<br class="calibre3"/>;=&gt; false</tt></span></blockquote><p id="filepos269173" class="calibre12">That’s <tt class="calibre11">false</tt>, as you might’ve suspected. Will setting it to <tt class="calibre11">true</tt> make any difference? </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(.setVisible frame true)<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p class="calibre12">It did, but it’s so tiny! Not to worry, as a <tt class="calibre11">Frame</tt> class also has a <tt class="calibre11">.setSize</tt> method that you can use: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(.setSize frame (java.awt.Dimension. 200 200))<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p class="calibre12">And up pops a blank window for you to draw on. At this point, we’ll guide you through the rest of this section, but keep in mind that Java’s official API might be of interest should you choose to extend the example program. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre28"><span class="calibre10"><span class="bold">The </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">Javadoc</span></tt></span><span class="calibre10"><span class="bold"> Function </span></span></p><p class="calibre5">As of Clojure 1.2, a <tt class="calibre11">javadoc</tt> function is automatically available at the REPL to query and view official API documentation: <tt class="calibre11">(javadoc frame)</tt></p><p class="calibre5">This should return a string corresponding to a URL and open a browser window for just the right page of documentation. Prior to Clojure 1.2, this function was in <tt class="calibre11">clojure.contrib.repl-utils</tt>. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">What you need to draw into your Frame is its graphics context, which can be fetched as shown:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def gfx (.getGraphics frame))<br class="calibre3"/>;=&gt; #'user/gfx</tt></span></blockquote><p class="calibre12">Then, to actually draw, you can try out the <tt class="calibre11">fillRect</tt> method of that graphics context. If you’re trying this yourself, make sure the blank window is positioned so that it’s unobscured while you’re typing into your REPL: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(.fillRect gfx 100 100 50 75)</tt></span></blockquote><p class="calibre12">And just like that, you’re drawing on the screen interactively. You should see a single black rectangle in the formerly empty window. Exciting, isn’t it? You could be a kid playing with turtle graphics for the first time, it’s so much fun. But what it needs now is a dash of color: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(.setColor gfx (java.awt.Color. 255 128 0))<br class="calibre3"/>(.fillRect gfx 100 150 75 50)</tt></span></blockquote><p class="calibre12">Now there should be an orange rectangle as well. Perhaps the coloring would make Martha Stewart cry, but you now have tried out all the basic building blocks you’ll need to complete the original task: you have a function that returns a seq of coordinates and their xor values, you have a window you can draw into, and you know how to draw rectangles of different colors. Bear in mind that if you move the actual frame with the mouse, your beautiful graphics will disappear. This is just an artifact of this limited experiment and can be avoided using the full Java Swing capabilities. </p><p id="filepos272559" class="calibre5"><span class="bold">3.4.3. Putting It All Together </span><a></a></p><p id="filepos272636" class="calibre7">What’s left to do? Use the graphics functions you just saw to draw the xor values you created earlier: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(doseq [[x y xor] (xors 200 200)]<br class="calibre3"/>  (.setColor gfx (java.awt.Color. xor xor xor))<br class="calibre3"/>  (.fillRect gfx x y 1 1))</tt></span></blockquote><p class="calibre12">The <tt class="calibre11">xors</tt> function you created earlier generates a seq of vectors, if you remember, where each vector has three elements: the x and y for your coordinates and the xor value that goes with them. The first line here uses destructuring to assign each of those three values to new locals x, y, and xor, respectively. </p><p class="calibre5">The second line sets the “pen” color to a gray level based on the xor value, and the final line draws a single-pixel rectangle at the current coordinates. The resulting graphic is shown in <a href="#filepos273649"><span class="calibre8"><span class="underline">figure 3.1</span></span></a>. </p><p id="filepos273649" class="calibre5"><span class="calibre10"><span class="bold">Figure 3.1. Visualization of xor. This is the graphic drawn by the six or so lines of code we’ve looked at so far—a visual representation of Clojure’s </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">bit-xor</span></tt></span><span class="calibre10"><span class="bold"> function. </span></span></p><p class="calibre1"><img src="images/00059.jpg" class="calibre43"/></p><p class="calibre5">But just because you’ve succeeded doesn’t mean you have to quit. You’ve built up some knowledge and a bit of a toolbox, so why not play with it a little? </p><p id="filepos274268" class="calibre5"><span class="bold">3.4.4. When things go wrong </span><a></a></p><p class="calibre7">For example, the pattern appears to cut off in the middle—perhaps you’d like to see a bit more. Re-enter that last expression, but this time try larger limits: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(doseq [[x y xor] (xors 500 500)]<br class="calibre3"/>  (.setColor gfx (java.awt.Color. xor xor xor))<br class="calibre3"/>  (.fillRect gfx x y 1 1))<br class="calibre3"/>; java.lang.IllegalArgumentException:<br class="calibre3"/>;    Color parameter outside of expected range: Red Green Blue</tt></span></blockquote><p class="calibre12">Whoops. Something went wrong, but what exactly? This gives you a perfect opportunity to try out one final REPL tool. When an exception is thrown from something you try at the REPL, the result is stored in a Var named <tt class="calibre11">*e</tt>. This allows you to get more detail about the expression, such as the stack trace: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(.printStackTrace *e)<br class="calibre3"/>; java.lang.IllegalArgumentException: Color parameter outside of<br class="calibre3"/>;         expected range: Red Green Blue<br class="calibre3"/>;     at clojure.lang.Compiler.eval(Compiler.java:4639)<br class="calibre3"/>;     at clojure.core$eval__5182.invoke(core.clj:1966)<br class="calibre3"/>;     at clojure.main$repl__7283$read_eval_print__7295.invoke(main.clj:180)<br class="calibre3"/>; ...skipping a bit here...<br class="calibre3"/>; Caused by: java.lang.IllegalArgumentException: Color parameter<br class="calibre3"/>;         outside of expected range: Red Green Blue<br class="calibre3"/>;     at java.awt.Color.testColorValueRange(Color.java:298)<br class="calibre3"/>;     at java.awt.Color.&lt;init&gt;(Color.java:382)<br class="calibre3"/>; ...skipping a bit more...<br class="calibre3"/>; ... 11 more<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p id="filepos276130" class="calibre12">That’s a lot of text, but don’t panic. Learning to read Java stack traces will be useful, so let’s pick it apart. </p><p class="calibre5">The first thing to understand is the overall structure of the trace—there are two “causes.” The original or root cause of the exception is listed last—this is the best place to look first.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos276875"><span class="calibre33"><span class="calibre8"><span class="underline">4</span></span></span></a><span class="calibre33">]</span></small></sup> The name and text of the exception there are the same as the REPL printed for us in the first place, though they won’t always be. So let’s look at that next line: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos276875" class="calibre32"><span class="calibre33">4</span></small></sup><span class="calibre10"> This is a runtime exception, the most common kind. If you misuse a macro or find a bug in one, you may see compile-time exceptions. The trace will look similar but will have many more references to Compiler.java. For these traces, the most recent exception (listed first) may be the only one that identifies the filename and line number in your code that’s at fault. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">at java.awt.Color.testColorValueRange(Color.java:298)</tt></span></blockquote><p class="calibre12">Like most lines in the stack trace, this has four parts: the name of the class, the name of the method, the filename, and finally the line number: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">at &lt;class&gt;.&lt;method or constructor&gt;(&lt;filename&gt;:&lt;line&gt;)</tt></span></blockquote><p class="calibre12">In this case, the function name is <tt class="calibre11">testColorValueRange</tt>, which is defined in Java’s own Color.java file. Unless this means more to you than it does to us, let’s move on to the next line: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">at java.awt.Color.&lt;init&gt;(Color.java:382)</tt></span></blockquote><p class="calibre12">It appears that it was the Color’s constructor (called <tt class="calibre11">&lt;init&gt;</tt> in stack traces) that called that test function you saw earlier. So now the picture is pretty clear—when you constructed a Color instance, it checked the values you passed in, decided they were invalid, and threw an appropriate exception. </p><p class="calibre5">If this weren’t enough, you could continue walking down the stack trace until the line</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">... 11 more</tt></span></blockquote><p class="calibre12">This is your cue to jump up to the cause listed before this one to find out what the next 11 stack frames were.</p><p class="calibre5">To fix your invalid Color argument, you can just adjust the <tt class="calibre11">xors</tt> function to return only legal values using the <tt class="calibre11">rem</tt> function, which returns the remainder so you can keep the results under 256: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn xors [xs ys]<br class="calibre3"/>  (for [x (range xs) y (range ys)]<br class="calibre3"/>    [x y (rem (bit-xor x y) 256)]))</tt></span></blockquote><p class="calibre12">Note that you’re redefining an existing function here. This is perfectly acceptable and well-supported behavior. Before moving on, create a function that takes a graphics object and clears it: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn clear [g] (.clearRect g 0 0 200 200))</tt></span></blockquote><p class="calibre12">Calling <tt class="calibre11">(clear gfx)</tt> will clear the <tt class="calibre11">frame</tt>, allowing the <tt class="calibre11">doseq</tt> form you tried before to work perfectly. </p><p id="filepos279844" class="calibre5"><span class="bold">3.4.5. Just for fun </span><a></a></p><p id="filepos279910" class="calibre7">The <tt class="calibre11">bit-xor</tt> function does produce an interesting image, but perhaps you wonder what other functions might look like. Try adding another parameter to <tt class="calibre11">xors</tt> so that you can pass in whatever function you’d like to look at. Because it’s not just <tt class="calibre11">bit-xor</tt> anymore, change the name while you’re at it: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn f-values [f xs ys]<br class="calibre3"/>  (for [x (range xs) y (range ys)]<br class="calibre3"/>    [x y (rem (f x y) 256)]))</tt></span></blockquote><p class="calibre12">You might as well wrap your call to <tt class="calibre11">setSize</tt>, <tt class="calibre11">clear</tt>, and the <tt class="calibre11">doseq</tt> form in a function as well: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn draw-values [f xs ys]<br class="calibre3"/>  (clear gfx)<br class="calibre3"/>  (.setSize frame (java.awt.Dimension. xs ys))<br class="calibre3"/>  (doseq [[x y v] (f-values f xs ys)]<br class="calibre3"/>    (.setColor gfx (java.awt.Color. v v v))<br class="calibre3"/>    (.fillRect gfx x y 1 1)))</tt></span></blockquote><p class="calibre12">This allows you to try out different functions and ranges quite easily. More nice examples are shown in <a href="#filepos281414"><span class="calibre8"><span class="underline">figure 3.2</span></span></a>, resulting from the following: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(draw-values bit-and 256 256)<br class="calibre3"/>(draw-values + 256 256)<br class="calibre3"/>(draw-values * 256 256)</tt></span></blockquote><p id="filepos281414" class="calibre12"><span class="calibre10"><span class="bold">Figure 3.2. Three possible results from </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">draw-values</span></tt></span><span class="calibre10"><span class="bold">. The </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">draw-values</span></tt></span><span class="calibre10"><span class="bold"> function you’ve written can be used to create a variety of graphics. Here are examples, from left to right, of </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">bit-and, +</span></tt></span><span class="calibre10"><span class="bold">, and </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">*</span></tt></span><span class="calibre10"><span class="bold">. </span></span></p><p class="calibre1"><img src="images/00061.jpg" class="calibre44"/></p><p class="calibre5">If this were the beginning or some awkward middle stage of a large project, you’d have succeeded in pushing past this troubling point and could now take the functions you’ve built and drop them into the larger project. </p><p class="calibre5">By trying everything out at the REPL, you’re encouraged to try smaller pieces rather than larger ones. The smaller the piece, the shorter the distance down an incorrect path you’re likely to go. Not only does this reduce the overall development time, but it provides developers more frequent successes that can help keep morale and motivation high through even tough stages of a project. But trial-and-error exploration isn’t enough. An intuitive basis in Clojure is also needed to become highly effective. Throughout this book, we’ll help you to build your intuition in Clojure through discussions of its idioms and its motivating factors and rationale. </p><p id="filepos283018" class="calibre5"><span class="calibre18"><span class="bold">3.5. Summary </span></span></p><p class="calibre7">We started slowly in this chapter in order to take a breather from the sprint that was <a href="#filepos163683"><span class="calibre8"><span class="underline">chapter 2</span></span></a>. Truthiness in Clojure observes a simple rule: every object is true all the time, unless it’s <tt class="calibre11">nil</tt> or <tt class="calibre11">false</tt>. Second, in many Lisp-like languages, the empty list <tt class="calibre11">()</tt>
<a id="filepos283469"></a>and the truth value <tt class="calibre11">nil</tt> are analogous—this is known as <span class="italic">nil-punning</span>—but in Clojure this isn’t the case. Instead, idiomatic Clojure employs the <tt class="calibre11">(seq (rest _))</tt> idiom in the form of the <tt class="calibre11">next</tt> function to provide a mechanism fostering “form follows function” and also to eliminate errors associated with falsety/empty-seq disparity. Finally, destructuring provides a powerful mechanism, a mini-language for binding if you will, for partially or entirely pulling apart the constituent components of composite types. Our trek through the REPL illustrated the power in having the whole language (Graham 2001) at your disposal. As a Clojure programmer, you’ll spend a lot of time in the REPL, and pretty soon you won’t know how you lived without it. </p><p class="calibre5">In the next chapter, we’ll touch on matters concerning Clojure’s seemingly innocent scalar data types. Although in most cases these scalars will expose powerful programming techniques, be forewarned: as you’ll see, the picture isn’t always rosy. </p><div class="mbppagebreak"></div><p id="filepos284570" class="calibre5"><span class="calibre6"><span class="bold">Part 2. Data types </span></span><a></a></p><p class="calibre7">Clojure has squirreled away interesting tidbits even among its data types. The scalar types include some less common items such as keywords and rational numbers, and the composite types are all immutable. In this part, we’ll explore all of them in detail. </p><div class="mbppagebreak"></div><p id="filepos284964" class="calibre5"><span class="calibre6"><span class="bold">Chapter 4. On scalars </span></span><a></a></p><blockquote id="filepos285054" class="calibre9"><span class="italic">It requires a very unusual mind to undertake the analysis of the obvious.</span></blockquote><blockquote class="calibre25"><span class="italic">Alfred North Whitehead</span></blockquote><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">This chapter covers</span>
</p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24"><a href="#filepos288030"><span class="calibre8"><span class="underline">Understanding precision</span></span></a></li><li value="2" class="calibre24"><a href="#filepos298944"><span class="calibre8"><span class="underline">Trying to be rational</span></span></a></li><li value="3" class="calibre24"><a href="#filepos305331"><span class="calibre8"><span class="underline">When to use keywords</span></span></a></li><li value="4" class="calibre24"><a href="#filepos312870"><span class="calibre8"><span class="underline">Symbolic resolution</span></span></a></li><li value="5" class="calibre24"><a href="#filepos321046"><span class="calibre8"><span class="underline">Regular expressions—the second problem</span></span></a></li></ul><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">So far, we’ve covered a somewhat eclectic mix of theoretical and practical concerns. This brings us now to a point where we can dive deeper into a fundamental topic: how Clojure deals with scalar values, including numeric, symbolic, and regular expression values, and how they behave as data and sometimes as code. </p><p class="calibre5">A scalar data type is one that can only hold one value at a time of a number, symbol, keyword, string, or character. Most of the use cases for Clojure’s scalar data types will be familiar to you. But there are some nuances that should be observed. Clojure’s scalar data types exist in an interesting conceptual space. Because of its symbiotic nature, some of the scalar type behaviors walk a conceptual line between <a id="filepos287038"></a>pure Clojure semantics and host semantics. This chapter provides a rundown of some of the idiomatic uses of Clojure’s scalar data types as well as some pitfalls that you might encounter. In most cases, Clojure will shield you from the quirks of its host, but there are times when they’ll demand attention. Clojure’s scalar types have the potential to act like Sybil—sweet and kind one moment, vicious and vile the next—requiring some thought to handle properly. We’ll also talk about this duality and address its limitations and possible mitigation techniques. Additionally, we’ll address the age-old topic of Lisp-1 versus Lisp-2 implementations and how Clojure approaches the matter. Finally, we’ll talk briefly about Clojure’s regular expression literals and how they’re typically used. </p><p class="calibre5">We’ll first cover matters of numerical precision and how the Java Virtual Machine works to thwart your attempts at mathematical nirvana. </p><p id="filepos288030" class="calibre5"><span class="calibre18"><span class="bold">4.1. Understanding precision </span></span></p><p class="calibre7">Numbers in Clojure are by default as precise<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos289786"><span class="calibre33"><span class="calibre8"><span class="underline">1</span></span></span></a><span class="calibre33">]</span></small></sup> as they need to be. Given enough memory, you could store the value of Pi accurately up to a billion places and beyond; in practice, values that large are rarely needed. But it’s sometimes important to provide perfect accuracy at less-precise values. When dealing with raw Clojure functions and forms, it’s a trivial matter to ensure such accuracy; it’s handled automatically. Because Clojure encourages interoperability with its host platform, the matter of accuracy becomes less than certain. This section will talk about real matters of precision related to Clojure’s support for the Java Virtual Machine. As it pertains to programming languages,<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos290273"><span class="calibre33"><span class="calibre8"><span class="underline">2</span></span></span></a><span class="calibre33">]</span></small></sup> numerical precision is proportional to the mechanisms used for storing numerical representations. The Java language specification describes the internal representation of its primitive types thus limiting their precision. Depending on the class of application specialization, a programmer could go an entire career and never be affected by Java’s precision limitations. But many industries require perfect accuracy of arbitrarily precise computations, and it’s here that Clojure can provide a great boon; but with this power come some pointy edges, as we’ll discuss shortly. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos289786" class="calibre32"><span class="calibre33">1</span></small></sup><span class="calibre10"> In a future version of Clojure, this arbitrary precision won’t be the default, but will require explicit flagging (with the aforementioned </span><span class="calibre10"><tt class="calibre11">M</tt></span><span class="calibre10"> for decimal numbers and </span><span class="calibre10"><tt class="calibre11">N</tt></span><span class="calibre10"> for longs). Additionally, overflow of primitive numbers will always signal an exception. </span></blockquote><blockquote class="calibre39"><sup class="calibre31"><small id="filepos290273" class="calibre32"><span class="calibre33">2</span></small></sup><span class="calibre10"> As opposed to arithmetic precision. </span></blockquote><p id="filepos290389" class="calibre35"><span class="bold">4.1.1. Truncation </span><a></a></p><p class="calibre7"><span class="italic">Truncation</span> refers to the limiting of accuracy for a floating-point number based on a deficiency in the corresponding representation. When a number is truncated, its precision is limited such that the maximum number of digits of accuracy is bound by the number of bits that can “fit” into the storage space allowed by its representation. For floating-point values, Clojure truncates by default. Therefore, if high precision is required for your floating-point operations, then explicit typing is required, as seen with the use of the <tt class="calibre11">M</tt> literal in the following: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(let [imadeuapi 3.14159265358979323846264338327950288419716939937M]<br class="calibre3"/>  (println (class imadeuapi))<br class="calibre3"/>  imadeuapi)<br class="calibre3"/>; java.math.BigDecimal<br class="calibre3"/>;=&gt; 3.14159265358979323846264338327950288419716939937M<br class="calibre3"/><br class="calibre3"/>(let [butieatedit 3.14159265358979323846264338327950288419716939937]<br class="calibre3"/>  (println (class butieatedit))<br class="calibre3"/>  butieatedit)<br class="calibre3"/>; java.lang.Double<br class="calibre3"/>;=&gt; 3.141592653589793</tt></span></blockquote><p id="filepos291601" class="calibre12">As we show, the local <tt class="calibre11">butieatedit</tt> is truncated because the default Java double type is insufficient. On the other hand, <tt class="calibre11">imadeuapi</tt> uses Clojure’s literal notation, a suffix character <tt class="calibre11">M</tt>, to declare a value as requiring arbitrary decimal representation. This is one possible way to mitigate truncation for a immensely large range of values, but as we’ll explore in <a href="#filepos298944"><span class="calibre8"><span class="underline">section 4.2</span></span></a>, it’s not a guarantee of perfect precision. </p><p id="filepos292144" class="calibre5"><span class="bold">4.1.2. Promotion </span><a></a></p><p class="calibre7">Clojure is able to detect when overflow occurs, and will promote the value to a numerical representation that can accommodate larger values. In many cases, promotion results in the usage of a pair of classes used to hold exceptionally large values. This promotion within Clojure is automatic, as the primary focus is first correctness of numerical values, then raw speed. It’s important to remember that this promotion <span class="italic">will</span> occur, as shown in the following listing, and your code should accommodate<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos292960"><span class="calibre33"><span class="calibre8"><span class="underline">3</span></span></span></a><span class="calibre33">]</span></small></sup> this certainty. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos292960" class="calibre32"><span class="calibre33">3</span></small></sup><span class="calibre10"> In the example, it’s important to realize that the actual class of the value is changing, so any functions or methods reliant on specific types might not work as expected. </span></blockquote><p id="filepos293214" class="calibre12"><span class="calibre10"><span class="bold">Listing 4.1. Automatic promotion in Clojure </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(def clueless 9)<br class="calibre3"/>(class clueless)<br class="calibre3"/>;=&gt; java.lang.Integer<br class="calibre3"/><br class="calibre3"/>(class (+ clueless 9000000000000000))<br class="calibre3"/>;=&gt; java.lang.Long<br class="calibre3"/><br class="calibre3"/>(class (+ clueless 90000000000000000000))<br class="calibre3"/>;=&gt; java.math.BigInteger<br class="calibre3"/><br class="calibre3"/>(class (+ clueless 9.0))<br class="calibre3"/>;=&gt; java.lang.Double</tt></span></blockquote><p class="calibre12">Java itself has a bevy of contexts under which automatic type conversion will occur, so we advise you to familiarize yourself with those (<a href="#filepos1086913"><span class="calibre8"><span class="underline">Lindholm 1999</span></span></a>) when dealing with Java native libraries. </p><p id="filepos294039" class="calibre5"><span class="bold">4.1.3. Overflow </span><a></a></p><p id="filepos294101" class="calibre7">Integer and long values in Java are subject to overflow errors. When an integer calculation results in a value that’s larger than 32 bits of representation will allow, the bits of storage will “wrap” around. When you’re operating in Clojure, overflow won’t be an issue for most cases, thanks to promotion. But when dealing with numeric operations on primitive types, overflow can occur. Fortunately in these instances an exception will occur rather than propagating inaccuracies: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(+ Integer/MAX_VALUE Integer/MAX_VALUE)<br class="calibre3"/>;=&gt; java.lang.ArithmeticException: integer overflow</tt></span></blockquote><p class="calibre12">Clojure provides a class of unchecked integer and long mathematical operations that assume that their arguments are primitive types. These unchecked operations <span class="italic">will</span> overflow if given excessively large values: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(unchecked-add (Integer/MAX_VALUE) (Integer/MAX_VALUE))<br class="calibre3"/>;=&gt; -2</tt></span></blockquote><p class="calibre12">You should take care with unchecked operations, because there’s no way to detect overflowing values and no reliable way to return from them. Use the unchecked functions only when overflow is desired. </p><p id="filepos295453" class="calibre5"><span class="bold">4.1.4. Underflow </span><a></a></p><p class="calibre7"><span class="italic">Underflow</span> is the inverse of overflow, where a number is so small that its value collapses into zero. Simple examples of underflow for float and doubles can be demonstrated: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(float 0.0000000000000000000000000000000000000000000001)<br class="calibre3"/>;=&gt; 0.0<br class="calibre3"/><br class="calibre3"/>1.0E-430<br class="calibre3"/>;=&gt; 0.0</tt></span></blockquote><p class="calibre12">Underflow presents a danger similar to overflow, except that it occurs only with floating-point numbers.</p><p id="filepos296070" class="calibre5"><span class="bold">4.1.5. Rounding errors </span><a></a></p><p class="calibre7">When the representation of a floating-point value isn’t sufficient for storing its actual value, then rounding errors will occur (Goldberg 1994). Rounding errors are an especially insidious numerical inaccuracy, as they have a habit of propagating throughout a computation and/or build over time, leading to difficulties in debugging. There’s a famous case involving the failure of a Patriot missile caused by a rounding error, resulting in the death of 28 U.S. soldiers in the first Gulf War (<a href="#filepos1081630"><span class="calibre8"><span class="underline">Skeel 1992</span></span></a>). This occurred due to a rounding error in the representation of a count register’s update interval. The timer register was meant to update once every 0.1 seconds, but because the hardware couldn’t represent 0.1 directly, an approximation was used instead. Tragically, the approximation used was subject to rounding error. Therefore, over the course of 100 hours, the rounding accumulated into a timing error of approximately 0.34 seconds. </p><p id="filepos297184" class="calibre5"><span class="calibre10"><span class="bold">Listing 4.2. Illustrating the Patriot missile tragedy </span></span><a></a></p><p class="calibre1"><img src="images/00026.jpg" class="calibre45"/></p><p id="filepos297423" class="calibre5">In the case of the Patriot missile, the deviation of <tt class="calibre11">0.34</tt> seconds was enough to cause a catastrophic software error, resulting in its ineffectiveness. When human lives are at stake, the inaccuracies wrought from rounding errors are unacceptable. For the most part, Clojure will be able to maintain arithmetic accuracies within a certain range, but you shouldn’t take for granted that such will be the case when interacting with Java libraries. </p><p class="calibre5">One way to contribute to rounding errors is to introduce doubles and floats into an operation. In Clojure, any computation involving even a single double will result in a value that’s a double: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(+ 0.1M 0.1M 0.1M 0.1 0.1M 0.1M 0.1M 0.1M 0.1M 0.1M)<br class="calibre3"/>;=&gt; 0.9999999999999999</tt></span></blockquote><p class="calibre12">Can you spot the double?</p><p class="calibre5">This discussion was Java-centric, but Clojure’s ultimate goal is to be platform-agnostic, and the problem of numerical consistency across platforms is a nontrivial matter. It’s still unknown whether the preceding points will be universal across host platforms, so please bear in mind that they should be reexamined when using Clojure outside the context of the JVM. Now that we’ve identified the root issues when dealing with numbers in Clojure, we’ll dive into a successful mitigation technique for dealing with them—rationals. </p><p id="filepos298944" class="calibre5"><span class="calibre18"><span class="bold">4.2. Trying to be rational </span></span></p><p class="calibre7">Clojure provides a data type representing a rational number, and all of its core mathematical functions operate with rational numbers. Clojure’s rationals allow for arbitrarily large numerators and denominators. We won’t go into depth about the limitations of floating-point operations, but the problem can be summarized simply. Given a finite representation of an infinitely large set, a determination must be made which finite subset <span class="italic">is</span> represented. In the case of standard floating-point numbers as representations of real numbers, the distribution of represented numbers is logarithmic (<a href="#filepos1077501"><span class="calibre8"><span class="underline">Kuki 1973</span></span></a>) and not one-for-one. What does this mean in practice? It means that requiring more accuracy in your floating-point operations increases the probability that the corresponding representation won’t be available. In these circumstances, you’ll have to settle for approximations. But Clojure’s rational number type provides a way to retain perfect accuracy when needed. </p><p id="filepos300109" class="calibre5"><span class="bold">4.2.1. Why be rational? </span><a></a></p><p id="filepos300179" class="calibre7">Of course, Clojure provides a decimal type that’s boundless relative to your computer memory, so why wouldn’t you just use those? In short, you can, but decimal operations can be easily corrupted, especially when working with existing Java libraries (<a href="#filepos1076164"><span class="calibre8"><span class="underline">Kahan 1998</span></span></a>) taking and returning primitive types. Additionally, in the case of Java, its underlying <tt class="calibre11">BigDecimal</tt> class is finite in that it uses a 32-bit integer to represent the number of digits to the right of the decimal place. This can represent an extremely large range of values perfectly, but it’s still subject to error: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">1.0E-430000000M<br class="calibre3"/>;=&gt; 1.0E-430000000M<br class="calibre3"/><br class="calibre3"/>1.0E-4300000000M<br class="calibre3"/>;=&gt; java.lang.RuntimeException: java.lang.NumberFormatException</tt></span></blockquote><p class="calibre12">Even if you manage to ensure that your <tt class="calibre11">BigDecimal</tt> values are free from floating-point corruption, you can never protect them from themselves. At some point or another, a floating-point calculation will encounter a number such as 2/3 that will <span class="italic">always</span> require rounding, leading to subtle, yet propagating errors. Finally, floating-point arithmetic is neither associative nor distributive, which may lead to the shocking results shown in this listing. </p><p id="filepos301601" class="calibre5"><span class="calibre10"><span class="bold">Listing 4.3. Floating-point arithmetic isn’t associative or distributive. </span></span><a></a></p><p class="calibre1"><img src="images/00027.jpg" class="calibre46"/></p><p class="calibre5">Therefore, for absolutely precise calculations, rationals are the best choice.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos302168"><span class="calibre33"><span class="calibre8"><span class="underline">4</span></span></span></a><span class="calibre33">]</span></small></sup></p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos302168" class="calibre32"><span class="calibre33">4</span></small></sup><span class="calibre10"> In the case of irrational numbers like Pi, all bets are off. </span></blockquote><p id="filepos302309" class="calibre35"><span class="bold">4.2.2. How to be rational </span><a></a></p><p class="calibre7">Aside from the rational data type, Clojure provides functions that can help to maintain your sanity: <tt class="calibre11">ratio?</tt>, <tt class="calibre11">rational?</tt>, and <tt class="calibre11">rationalize</tt>. Additionally, taking apart rationals is also a trivial matter. </p><p id="filepos302642" class="calibre5">The best way to ensure that your calculations remain as accurate as possible is to ensure that they’re all done using rational numbers. As shown in the following listing, the shocking results from using floating-point numbers have been eliminated. </p><p id="filepos302924" class="calibre5"><span class="calibre10"><span class="bold">Listing 4.4. Being rational preserves associativity and distributive natures. </span></span><a></a></p><p class="calibre1"><img src="images/00029.jpg" class="calibre47"/></p><p class="calibre5">To ensure that your numbers remain rational, you can use <tt class="calibre11">rational?</tt> to check whether a given number is one and then use <tt class="calibre11">rationalize</tt> to convert it to one. There are a few rules of thumb to remember if you want to maintain perfect accuracy in your computations: </p><div class="calibre22"> </div><ol class="calibre48"><li value="1" class="calibre24">Never use Java math libraries unless they return results of <tt class="calibre11">BigDecimal</tt>, and even then be suspicious. </li><li value="2" class="calibre24">Don’t <tt class="calibre11">rationalize</tt> values that are Java float or double primitives. </li><li value="3" class="calibre24">If you must write your own high-precision calculations, do so with rationals.</li><li value="4" class="calibre24">Only convert to a floating-point representation as a last resort.</li></ol><p class="calibre5">Finally, you can extract the constituent parts of a rational using the <tt class="calibre11">numerator</tt> and <tt class="calibre11">denominator</tt> functions: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(numerator (/ 123 10))<br class="calibre3"/>;=&gt; 123<br class="calibre3"/>(denominator (/ 123 10))<br class="calibre3"/>;=&gt; 10</tt></span></blockquote><p class="calibre12">You might never need perfect accuracy in your calculations. When you do, Clojure provides tools for maintaining sanity, but the responsibility to maintain rigor lies with you. </p><p id="filepos304595" class="calibre5"><span class="bold">4.2.3. Caveats of rationality </span><a></a></p><p class="calibre7">Like any tool, Clojure’s rational type is a double-edged sword. The calculation of rational math, though accurate, isn’t nearly as fast as with floats or doubles. Each operation in rational math has an overhead cost (such as finding the least common denominator) that should be accounted for. It does you no good to use rational operations if speed is a primary concern above accuracy. </p><p id="filepos305094" class="calibre5">That covers the numerical scalars, so we’ll move on to two data types that you may not be familiar with unless you happen to come from a background in the Lisp family of languages: keywords and symbols. </p><p id="filepos305331" class="calibre5"><span class="calibre18"><span class="bold">4.3. When to use keywords </span></span></p><p class="calibre7">The purpose of Clojure <span class="italic">keywords</span>, or <span class="italic">symbolic identifiers</span>, can sometimes lead to confusion for first-time Clojure programmers, because their analogue isn’t often found<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos305962"><span class="calibre33"><span class="calibre8"><span class="underline">5</span></span></span></a><span class="calibre33">]</span></small></sup> in other languages. This section will attempt to alleviate the confusion and provide some tips for how keywords are typically used. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos305962" class="calibre32"><span class="calibre33">5</span></small></sup><span class="calibre10"> Ruby has a symbol type that acts, looks, and is used similarly to Clojure keywords. </span></blockquote><p id="filepos306126" class="calibre35"><span class="bold">4.3.1. How are keywords different from symbols? </span><a></a></p><p class="calibre7">Keywords <span class="italic">always</span> refer to themselves. What this means is that the keyword <tt class="calibre11">:magma</tt> always has the value <tt class="calibre11">:magma</tt>, whereas the symbol <tt class="calibre11">ruins</tt> may refer to any legal Clojure value or reference. </p><p class="calibre5"><span class="calibre10"><span class="bold">As Keys </span></span></p><p class="calibre7">Because keywords are self-evaluating and provide fast equality checks, they’re almost always used in the context of map keys. An equally important reason to use keywords as map keys is that they can be used as functions, taking a map as an argument, to perform value lookups: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def population {:zombies 2700, :humans 9})<br class="calibre3"/><br class="calibre3"/>(:zombies population)<br class="calibre3"/>;=&gt; 2700<br class="calibre3"/><br class="calibre3"/>(println (/ (:zombies population)<br class="calibre3"/>            (:humans population))<br class="calibre3"/>         "zombies per capita")<br class="calibre3"/>; 300 zombies per capita</tt></span></blockquote><p class="calibre12">This leads to much more concise code.</p><p class="calibre5"><span class="calibre10"><span class="bold">As Enumerations </span></span></p><p class="calibre7">Often, Clojure code will use keywords as enumeration values, such as <tt class="calibre11">:small</tt>, <tt class="calibre11">:medium</tt>, and <tt class="calibre11">:large</tt>. This provides a nice visual delineation within the source code. </p><p class="calibre5"><span class="calibre10"><span class="bold">As Multimethod Dispatch Values </span></span></p><p class="calibre7">Because keywords are used often as enumerations, they’re ideal candidates for dispatch values for multimethods, which we’ll explore in more detail in <a href="#filepos643937"><span class="calibre8"><span class="underline">section 9.1</span></span></a>. </p><p class="calibre5"><span class="calibre10"><span class="bold">As Directives </span></span></p><p class="calibre7">Another common use for keywords is to provide a directive to a function, multi-method, or macro. A simple way to illustrate this is to imagine a simple function <tt class="calibre11">pour</tt>, shown in <a href="#filepos308601"><span class="calibre8"><span class="underline">listing 4.5</span></span></a>, that takes two numbers and returns a lazy sequence of the range of those numbers. But there’s also a mode for this function that takes a keyword <tt class="calibre11">:toujours</tt>, which will instead return an infinite lazy range starting with the first number and continuing “forever.” </p><p id="filepos308601" class="calibre5"><span class="calibre10"><span class="bold">Listing 4.5. Using a keyword as a function directive </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn pour [lb ub]<br class="calibre3"/>  (cond<br class="calibre3"/>    (= ub :toujours) (iterate inc lb)<br class="calibre3"/>    :else (range lb ub)))<br class="calibre3"/><br class="calibre3"/>(pour 1 10)<br class="calibre3"/>;=&gt; (1 2 3 4 5 6 7 8 9)<br class="calibre3"/><br class="calibre3"/>(pour 1 :toujours)<br class="calibre3"/>; ... runs forever</tt></span></blockquote><p id="filepos309082" class="calibre12">An illustrative bonus with <tt class="calibre11">pour</tt> is that the macro <tt class="calibre11">cond</tt> itself uses a directive <tt class="calibre11">:else</tt> to mark the default conditional case. In this case, <tt class="calibre11">cond</tt> uses the fact that the keyword <tt class="calibre11">:else</tt> is truthy; any keyword (or truthy value) would’ve worked just as well. </p><p id="filepos309412" class="calibre5"><span class="bold">4.3.2. Qualifying your keywords </span><a></a></p><p class="calibre7">Keywords don’t belong to any specific namespace, although they may appear to if namespace qualification is used:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">::not-in-ns<br class="calibre3"/>;=&gt; :user/not-in-ns</tt></span></blockquote><p class="calibre12">The prefix portion of the keyword marked as <tt class="calibre11">:user/</tt> only looks like it’s denoting an owning namespace; in fact, it’s a prefix gathered from the current namespace by the Clojure reader. Observe the use of arbitrary prefixing: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(ns another)<br class="calibre3"/>:user/in-another<br class="calibre3"/>;=&gt; :user/in-another<br class="calibre3"/><br class="calibre3"/>:haunted/name<br class="calibre3"/>;=&gt; :haunted/name</tt></span></blockquote><p class="calibre12">In the first case, we created a namespace <tt class="calibre11">another</tt> and created a keyword <tt class="calibre11">:user/in-another</tt> that appears to belong to the <tt class="calibre11">user</tt> namespace, but in fact is prefixed. In the second example, we created a keyword <tt class="calibre11">:haunted/name</tt> showing that the prefix doesn’t have to belong to a namespace at all, given that one named <tt class="calibre11">haunted</tt> certainly doesn’t exist. But the fact that keywords aren’t members of any given namespace doesn’t mean that namespace-qualifying them is pointless. Instead, it’s often more clear to do so, especially when a namespace aggregates a specific functionality and its keywords are meaningful in that context. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">Separating the plumbing from the domain</span>
</p><p class="calibre7">Within a namespace named <tt class="calibre11">crypto</tt>, the keywords <tt class="calibre11">::rsa</tt> and <tt class="calibre11">::blowfish</tt> make sense as being namespace-qualified. Likewise, should we create a namespace <tt class="calibre11">aquarium</tt>, then using <tt class="calibre11">::blowfish</tt> within is contextually meaningful. Likewise, when adding metadata to structures, you should consider using qualified keywords as keys and directives if their intention is domain-oriented. Observe the following code: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn do-blowfish [directive]<br class="calibre3"/>  (case directive<br class="calibre3"/>    :aquarium/blowfish (println "feed the fish")<br class="calibre3"/>    :crypto/blowfish   (println "encode the message")<br class="calibre3"/>    :blowfish          (println "not sure what to do")))<br class="calibre3"/>(ns crypto)<br class="calibre3"/>(user/do-blowfish :blowfish)<br class="calibre3"/>; not sure what to do<br class="calibre3"/><br class="calibre3"/>(user/do-blowfish ::blowfish)<br class="calibre3"/>; encode the message<br class="calibre3"/>(ns aquarium)<br class="calibre3"/>(user/do-blowfish :blowfish)<br class="calibre3"/>; not sure what to do<br class="calibre3"/>(user/do-blowfish ::blowfish)<br class="calibre3"/>; feed the fish</tt></span></blockquote><p id="filepos312307" class="calibre12">When switching to different namespaces using <tt class="calibre11">ns</tt>, you can use the namespace-qualified keyword syntax to ensure that the correct domain-specific code path is executed. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">Namespace qualification is especially important when you’re creating ad-hoc hierarchies and defining multimethods, both discussed in <a href="#filepos660369"><span class="calibre8"><span class="underline">section 9.2</span></span></a>. </p><p id="filepos312870" class="calibre5"><span class="calibre18"><span class="bold">4.4. Symbolic resolution </span></span></p><p class="calibre7">In the previous section, we covered the differences between symbols and keywords. Whereas keywords were fairly straightforward, symbols abide by a slightly more complicated system for lookup resolution. </p><p class="calibre5">Symbols in Clojure are roughly analogous to identifiers in many other languages—words that refer to other things. In a nutshell, symbols are primarily used to provide a name for a given value. But in Clojure, symbols can also be referred to directly, by using the <tt class="calibre11">symbol</tt> or <tt class="calibre11">quote</tt> function or the <tt class="calibre11">'</tt> special operator. Symbols tend to be discrete entities from one lexical contour to another, and often even within a single contour. Unlike keywords, symbols aren’t unique based solely on name alone, as you can see in the following: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(identical? 'goat 'goat)<br class="calibre3"/>;=&gt; false</tt></span></blockquote><p class="calibre12">The reason <tt class="calibre11">identical?</tt> returns false in this example is because each <tt class="calibre11">goat</tt> symbol is a discrete object that only happens to share a name and therefore a symbolic representation. But that name is the basis for symbol equality: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(= 'goat 'goat)<br class="calibre3"/>;=&gt; true<br class="calibre3"/><br class="calibre3"/>(name 'goat)<br class="calibre3"/>"goat"</tt></span></blockquote><p id="filepos314354" class="calibre12">The <tt class="calibre11">identical?</tt> function in Clojure only ever returns true when the symbols are in fact the same object: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(let [x 'goat y x] (identical? x y))<br class="calibre3"/>;=&gt; true</tt></span></blockquote><p class="calibre12">In the preceding example, <tt class="calibre11">x</tt> is also a symbol, but when evaluated in the <tt class="calibre11">(identical? x x)</tt> form it returns the symbol <tt class="calibre11">goat</tt>, which is actually being stored on the runtime call stack. The question arises: why not make two identically named symbols the same object? The answer lies in metadata, which we discuss next. </p><p id="filepos315018" class="calibre5"><span class="bold">4.4.1. Metadata </span><a></a></p><p class="calibre7">Clojure allows the attachment of metadata to various objects, but for now we’ll focus on attaching metadata to symbols. The <tt class="calibre11">with-meta</tt> function takes an object and a map and returns another object of the same type with the metadata attached. The reason why equally named symbols are often not the same instance is because each can have its own unique metadata: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(let [x (with-meta 'goat {:ornery true})<br class="calibre3"/>      y (with-meta 'goat {:ornery false})]<br class="calibre3"/>  [(= x y)<br class="calibre3"/>   (identical? x y)<br class="calibre3"/>   (meta x)<br class="calibre3"/>   (meta y)])<br class="calibre3"/><br class="calibre3"/>;=&gt; [true false {:ornery true} {:ornery false}]</tt></span></blockquote><p class="calibre12">The two locals <tt class="calibre11">x</tt> and <tt class="calibre11">y</tt> both hold an equal symbol <tt class="calibre11">'goat</tt>, but they’re different instances, each containing separate metadata maps obtained with the <tt class="calibre11">meta</tt> function. The implications of this are that symbol equality isn’t dependent on metadata or identity. This equality semantic isn’t limited to symbols, but is pervasive in Clojure, as we’ll demonstrate throughout this book. You’ll find that keywords can’t hold metadata<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos316601"><span class="calibre33"><span class="calibre8"><span class="underline">6</span></span></span></a><span class="calibre33">]</span></small></sup> because any equally named keyword is the same object. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos316601" class="calibre32"><span class="calibre33">6</span></small></sup><span class="calibre10"> Java class instances, including strings, can’t hold metadata either. </span></blockquote><p id="filepos316752" class="calibre35"><span class="bold">4.4.2. Symbols and namespaces </span><a></a></p><p class="calibre7">Like keywords, symbols don’t belong to any specific namespace. Take, for example, the following code:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(ns where-is)<br class="calibre3"/>(def a-symbol 'where-am-i)<br class="calibre3"/><br class="calibre3"/>a-symbol<br class="calibre3"/>;=&gt; where-am-i<br class="calibre3"/><br class="calibre3"/>(resolve 'a-symbol)<br class="calibre3"/>;=&gt; #'where-is/a-symbol<br class="calibre3"/><br class="calibre3"/>`a-symbol<br class="calibre3"/>;=&gt; where-is/a-symbol</tt></span></blockquote><p id="filepos317285" class="calibre12">The initial evaluation of <tt class="calibre11">a-symbol</tt> shows the expected value <tt class="calibre11">where-am-i</tt>. But attempting to resolve the symbol using <tt class="calibre11">resolve</tt> and using syntax-quote returns what looks like (as printed at the REPL) a namespace-qualified symbol. This is because a symbol’s qualification is a characteristic of evaluation and not inherent in the symbol at all. This also applies to symbols qualified with class names. This evaluation behavior will prove beneficial when we discuss macros in <a href="#filepos582816"><span class="calibre8"><span class="underline">chapter 8</span></span></a>, but for now we can summarize the overarching idea known as Lisp-1 (<a href="#filepos1071935"><span class="calibre8"><span class="underline">Gabriel 2001</span></span></a>). </p><p id="filepos318027" class="calibre5"><span class="bold">4.4.3. Lisp-1 </span><a></a></p><p class="calibre7">Clojure is what’s known as a Lisp-1, which in simple terms means it uses the same name resolution for function and value bindings. In a Lisp-2 programming language like Common Lisp, these name resolutions are performed differently depending on the context of the symbol, be it in a function call position or a function argument position. There are many arguments for and against both Lisp-1 and Lisp-2, but against Lisp-1 one downside bears consideration. Because the same name-resolution scheme is used for functions and their arguments, there’s a real possibility of shadowing existing functions with other locals or Vars. Name shadowing isn’t necessarily non-idiomatic if done thoughtfully, but if done accidentally it can lead to some unexpected and obscure errors. You should take care when naming locals and defining new functions so that name-shadowing complications can be avoided. </p><p class="calibre5">Though name-shadowing errors tend to be rare, the benefit in a simplified mechanism for calling and passing first-class functions far outweighs the negative. Clojure’s adoption of a Lisp-1 resolution scheme makes for cleaner implementations and therefore highlights the solution rather than muddying the waters with the nuances of symbolic lookup. For example, the <tt class="calibre11">best</tt> function highlights this perfectly in the way that it takes the greater-than function <tt class="calibre11">&gt;</tt> and calls it within its body as <tt class="calibre11">f</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn best [f xs]<br class="calibre3"/>  (reduce #(if (f % %2) % %2) xs))<br class="calibre3"/><br class="calibre3"/>(best &gt; [1 3 4 2 7 5 3])<br class="calibre3"/>;=&gt; 7</tt></span></blockquote><p class="calibre12">A similar function body using a Lisp-2 language would require the intervention of another function (in this case <tt class="calibre11">funcall</tt>) responsible for invoking the function explicitly. Likewise, passing any function would require the use of a qualifying tag marking it as a function object, as seen here: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defun best (f xs)<br class="calibre3"/>  (reduce #'(lambda (l r)<br class="calibre3"/>              (if (funcall f l r) l r))<br class="calibre3"/>          xs))<br class="calibre3"/><br class="calibre3"/>(best #'&gt; '(1 3 4 2 7 5 3))<br class="calibre3"/>;=&gt; 7</tt></span></blockquote><p class="calibre12">This section isn’t intended to champion the cause of Lisp-1 over Lisp-2, only to highlight the differences between the two. Many of the design decisions in Clojure provide succinctness in implementation, and Lisp-1 is no exception. The preference for Lisp-1 <a id="filepos320736"></a>versus Lisp-2 typically boils down to matters of style and taste; by all practical measures, they’re equivalent. </p><p class="calibre5">Having covered the two symbolic scalar types, we now move into a type that you’re (for better or worse) likely familiar with: the regular expression. </p><p id="filepos321046" class="calibre5"><span class="calibre18"><span class="bold">4.5. Regular expressions—the second problem </span></span></p><blockquote class="calibre9"><span class="italic">Some people, when confronted with a problem, think “I know, I’ll use regular expressions.” Now they have two problems.</span></blockquote><blockquote class="calibre25"><span class="italic">Jamie Zawinski</span></blockquote><p class="calibre5">Regular expressions are a powerful and compact way to find specific patterns in text strings. Though we sympathize with Zawinski’s attitude and appreciate his wit, sometimes regular expressions are a useful tool to have on hand. Although the full capabilities of regular expressions (or regexes) are well beyond the scope of this section (<a href="#filepos1071646"><span class="calibre8"><span class="underline">Friedl 1997</span></span></a>), we’ll look at some of the ways Clojure leverages Java’s regex capabilities. </p><p class="calibre5">Java’s regular expression engine is reasonably powerful, supporting Unicode and features such as reluctant quantifiers and “look-around” clauses. Clojure doesn’t try to reinvent the wheel and instead provides special syntax for literal Java regex patterns plus a few functions to help Java’s regex capabilities fit better with the rest of Clojure. </p><p id="filepos322335" class="calibre5"><span class="bold">4.5.1. Syntax </span><a></a></p><p class="calibre7">A literal regular expression in Clojure looks like this:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">#"an example pattern"</tt></span></blockquote><p class="calibre12">This produces<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos322979"><span class="calibre33"><span class="calibre8"><span class="underline">7</span></span></span></a><span class="calibre33">]</span></small></sup> a compiled regex object that can be used either directly with Java interop method calls or with any of the Clojure regex functions described later: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos322979" class="calibre32"><span class="calibre33">7</span></small></sup><span class="calibre10"> Literal regex patterns are compiled to java.util.regex.Pattern instances at read-time. This means, for example, if you use a literal regex in a loop, it’s </span><span class="calibre10"><span class="italic">not</span></span><span class="calibre10"> recompiled each time through the loop, but just once when the surrounding code is compiled. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(class #"example")<br class="calibre3"/>;=&gt; java.util.regex.Pattern</tt></span></blockquote><p class="calibre12">Though the pattern is surrounded with double quotes like string literals, the way things are escaped within the quotes isn’t the same. This difference is easiest to see in patterns that use backslash-delimited character classes. When compiled as a regex, a string <tt class="calibre11">"\\d"</tt> will match a single digit and is identical to a literal regex without the double backslash. Note that Clojure will even print the pattern back out using the literal syntax: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(java.util.regex.Pattern/compile "\\d")<br class="calibre3"/>;=&gt; #"\d"</tt></span></blockquote><p class="calibre12">In short, the only rules you need to know for embedding unusual literal characters or predefined character classes are listed in the javadoc for Pattern.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos324516"><span class="calibre33"><span class="calibre8"><span class="underline">8</span></span></span></a><span class="calibre33">]</span></small></sup></p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos324516" class="calibre32"><span class="calibre33">8</span></small></sup><span class="calibre10"> See the online reference at </span><a href="http://java.sun.com/j2se/1.5.0/docs/api/java/util/regex/Pattern.html"><span class="calibre10"><span class="calibre8"><span class="underline">http://java.sun.com/j2se/1.5.0/docs/api/java/util/regex/Pattern.html</span></span></span></a><span class="calibre10">. </span></blockquote><p id="filepos324854" class="calibre12">Regular expressions accept option flags, shown in <a href="#filepos325186"><span class="calibre8"><span class="underline">table 4.1</span></span></a>, that can make a pattern case-insensitive or enable multiline mode, and Clojure’s regex literals starting with <tt class="calibre11">(?&lt;flag&gt;)</tt> set the mode for the rest of the pattern. </p><p id="filepos325186" class="calibre5"><span class="calibre10"><span class="bold">Table 4.1. Regex flags: these are the flags that can be used within Clojure regular expression patterns, their long name, and a description of what they do. See Java’s documentation for the java.util. regex.Pattern class for more details. </span></span><a></a></p><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><th scope="col" valign="top" class="calibre26"><p class="calibre27"><span class="calibre10"><span class="bold">Flag</span></span></p></th><th scope="col" valign="top" class="calibre26"><p class="calibre27"><span class="calibre10"><span class="bold">Flag name</span></span></p></th><th scope="col" valign="top" class="calibre26"><p class="calibre27"><span class="calibre10"><span class="bold">Description</span></span></p></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">d</span>
</td><td valign="top" class="calibre16"><span class="calibre10">UNIX_LINES</span>
</td><td valign="top" class="calibre16"><span class="calibre10">., ^, and $ match only the Unix line terminator '\n'.</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">i</span>
</td><td valign="top" class="calibre16"><span class="calibre10">CASE_INSENSITIVE</span>
</td><td valign="top" class="calibre16"><span class="calibre10">ASCII characters are matched without regard to upper or lower case.</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">x</span>
</td><td valign="top" class="calibre16"><span class="calibre10">COMMENTS</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Whitespace and comments in the pattern are ignored.</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">m</span>
</td><td valign="top" class="calibre16"><span class="calibre10">MULTILINE</span>
</td><td valign="top" class="calibre16"><span class="calibre10">^ and $ match near line terminators instead of only at the beginning or end of the entire input string.</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">s</span>
</td><td valign="top" class="calibre16"><span class="calibre10">DOTALL</span>
</td><td valign="top" class="calibre16"><span class="calibre10">. matches any character including the line terminator.</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">u</span>
</td><td valign="top" class="calibre16"><span class="calibre10">UNICODE_CASE</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Causes the i flag to use Unicode case insensitivity instead of ASCII.</span>
</td></tr></table><p class="calibre7">For example, the pattern <tt class="calibre11">#"(?i)yo"</tt> would match the strings “yo”, “yO”, “Yo”, and “YO”. </p><p id="filepos327466" class="calibre5"><span class="bold">4.5.2. Functions </span><a></a></p><p class="calibre7">Java’s regex Pattern object has several methods that can be used directly, but only <tt class="calibre11">split</tt> is used regularly to split a string into an array<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos327970"><span class="calibre33"><span class="calibre8"><span class="underline">9</span></span></span></a><span class="calibre33">]</span></small></sup> of Strings, breaking the original where the pattern matches: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos327970" class="calibre32"><span class="calibre33">9</span></small></sup><span class="calibre10"> Java arrays don’t print very pleasantly at the Clojure REPL, so we used </span><span class="calibre10"><tt class="calibre11">seq</tt></span><span class="calibre10"> in this example so you can see the Strings inside. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(seq (.split #"," "one,two,three"))<br class="calibre3"/>;=&gt; ("one" "two" "three")</tt></span></blockquote><p class="calibre12">The <tt class="calibre11">re-seq</tt> function is Clojure’s regex workhorse. It returns a lazy seq of all matches in a string, which means it can be used to efficiently test whether a string matches at all or to find all matches in a string or a mapped file: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(re-seq #"\w+" "one-two/three")<br class="calibre3"/>;=&gt; ("one" "two" "three")</tt></span></blockquote><p class="calibre12">The preceding regular expression has no capturing groups, so each match in the returned seq is simply a string. A capturing group in the regex causes each returned item to be a vector: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(re-seq #"\w*(\w)" "one-two/three")<br class="calibre3"/>;=&gt; (["one" "e"] ["two" "o"] ["three" "e"])</tt></span></blockquote><p id="filepos329219" class="calibre12">So where <tt class="calibre11">.split</tt> returns the text between regex matches, <tt class="calibre11">re-seq</tt> returns the matches themselves.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos329669"><span class="calibre33"><span class="calibre8"><span class="underline">10</span></span></span></a><span class="calibre33">]</span></small></sup> Now that we’ve looked at some nice functions you can use, we’ll talk about one object you shouldn’t. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos329669" class="calibre32"><span class="calibre33">10</span></small></sup><span class="calibre10"> If you want both at the same time, you may want to look at the </span><span class="calibre10"><tt class="calibre11">partition</tt></span><span class="calibre10"> function in the </span><span class="calibre10"><tt class="calibre11">clojure-contrib</tt></span><span class="calibre10"> library, found in the </span><span class="calibre10"><tt class="calibre11">clojure.contrib.string</tt></span><span class="calibre10"> namespace. </span></blockquote><p id="filepos330070" class="calibre35"><span class="bold">4.5.3. Beware of mutable matchers </span><a></a></p><p class="calibre7">Java’s regular expression engine includes a <tt class="calibre11">Matcher</tt> object that mutates in a non-thread-safe way as it walks through a string finding matches. This object is exposed by Clojure via the <tt class="calibre11">re-matcher</tt> function and can be used as an argument to <tt class="calibre11">re-groups</tt> and the single-parameter form of <tt class="calibre11">re-find</tt>. We highly recommend avoiding all of these unless you’re certain you know what you’re doing. These dangerous functions are used internally by the implementations of some of the recommended functions described earlier, but in each case they’re careful to disallow access to the <tt class="calibre11">Matcher</tt> object they use. Use Matchers at your own risk, or better yet don’t use them directly<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos331105"><span class="calibre33"><span class="calibre8"><span class="underline">11</span></span></span></a><span class="calibre33">]</span></small></sup> at all. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos331105" class="calibre32"><span class="calibre33">11</span></small></sup><span class="calibre10"> The </span><span class="calibre10"><tt class="calibre11">clojure.contrib.string</tt></span><span class="calibre10"> namespace has a bevy of functions useful for leveraging regular expressions. </span></blockquote><p id="filepos331343" class="calibre5"><span class="calibre18"><span class="bold">4.6. Summary </span></span></p><p class="calibre7">Clojure’s scalar types generally work as expected, but its numerical types have a potential for frustration in certain situations. Though you may rarely encounter issues with numerical precision, keeping in mind the circumstances under which they occur might prove useful in the future. Given its inherent arbitrary-precision big decimal and rational numerics, Clojure provides the tools for perfectly accurate calculations. Keywords in Clojure serve many purposes and are ubiquitous in idiomatic code. When dealing directly with symbols, Clojure’s nature as a Lisp-1 defines the nature of how symbolic resolution occurs. Finally, Clojure provides regular expressions as first-class data types, and their usage is encouraged where appropriate. </p><p class="calibre5">As you might’ve speculated, this chapter was nice and short due to the relative simplicity of scalar types. In the following chapter, we’ll step it up a notch or 10 when covering Clojure’s composite data types. Though scalars are interesting and deeper than expected, the next chapter will start you on your way to understanding Clojure’s true goal: providing a sane approach to application state. </p><div class="mbppagebreak"></div><p id="filepos332652" class="calibre5"><span class="calibre6"><span class="bold">Chapter 5. Composite data types </span></span><a></a></p><blockquote class="calibre9"><span class="italic">It is better to have 100 functions operate on one data structure than 10 functions on 10 data structures.</span></blockquote><blockquote class="calibre25"><span class="italic">Alan Perlis</span></blockquote><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">This chapter covers</span>
</p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24"><a href="#filepos335390"><span class="calibre8"><span class="underline">Persistence, sequences, and complexity</span></span></a></li><li value="2" class="calibre24"><a href="#filepos353970"><span class="calibre8"><span class="underline">Vectors: creating and using them in all their varieties</span></span></a></li><li value="3" class="calibre24"><a href="#filepos381354"><span class="calibre8"><span class="underline">Lists: Clojure’s code form data structure</span></span></a></li><li value="4" class="calibre24"><a href="#filepos388921"><span class="calibre8"><span class="underline">How to use persistent queues</span></span></a></li><li value="5" class="calibre24"><a href="#filepos396660"><span class="calibre8"><span class="underline">Persistent sets</span></span></a></li><li value="6" class="calibre24"><a href="#filepos408333"><span class="calibre8"><span class="underline">Thinking in maps</span></span></a></li><li value="7" class="calibre24"><a href="#filepos420275"><span class="calibre8"><span class="underline">Putting it all together: finding the position of items in a sequence</span></span></a></li></ul><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">Clojure provides a rich set of composite data types and we’ll cover them all: vectors, lists, queues, sets, and maps. In this chapter, we’ll dig into the strengths and weaknesses of each. We’ll spend more time on vectors and maps than on the other types, because those two are used in a wider variety of circumstances and warrant the extra discussion. Finally, we’ll discuss the design of a simple function to leverage <a id="filepos334761"></a>many of the lessons learned in this chapter, and you’ll gain specific insight into the preceding quote. By the way, we use the terms <span class="italic">composite types</span> and <span class="italic">collections</span> interchangeably, so please bear that in mind as we proceed. </p><p class="calibre5">Before we look at the primary collection types individually, we’ll discuss the things they have in common. For example, you may have heard of Clojure’s <span class="italic">sequence abstraction</span>—all the persistent collections use it, so we’ll examine that as well as some algorithmic complexity concepts we’ll be referring to throughout the chapter. </p><p id="filepos335390" class="calibre5"><span class="calibre18"><span class="bold">5.1. Persistence, sequences, and complexity </span></span></p><p class="calibre7">Clojure’s composite data types have some unique properties compared to composites in many mainstream languages. Terms such as <span class="italic">persistent</span> and <span class="italic">sequence</span> come up, and not always in a way that makes their meaning clear. In this section we’ll define their meanings carefully. We’ll also briefly examine the topic of algorithmic complexity and Big-O notation as they apply to Clojure collections. </p><p class="calibre5">The term <span class="italic">persistent</span> is particularly problematic because it means something different in other contexts. In the case of Clojure, we believe that a phrase immortalized by Inigo Montoya from the novel and subsequent film <span class="italic">The Princess Bride</span> summarizes your likely initial reaction... </p><p id="filepos336264" class="calibre5"><span class="bold">5.1.1. “You keep using that word. I do not think it means what you think it means.” </span><a></a></p><p class="calibre7">Although storage to disk may be the more common meaning of <span class="italic">persistent</span> today, Clojure uses an older meaning of the word having to do with immutable in-memory collections with specific properties. In particular, a persistent collection in Clojure allows you to preserve historical versions (Okasaki 1999) of its state, and promises that all versions will have the same update and lookup complexity guarantees. The specific guarantees depend on the collection type, and we’ll cover those details along with each kind of collection. </p><p class="calibre5">Here you can see the difference between a persistent data structure and one that’s not by using a Java array:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def ds (into-array [:willie :barnabas :adam]))<br class="calibre3"/>(seq ds)<br class="calibre3"/>;=&gt; (:willie :barnabas :adam)</tt></span></blockquote><p class="calibre12">What we’ve done is create a three-element array of keywords and used <tt class="calibre11">seq</tt> to produce an object that displays nicely in the REPL. Any change to the array <tt class="calibre11">ds</tt> happens in-place, thus obliterating any historical version: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(aset ds 1 :quentin)<br class="calibre3"/>;=&gt; :quentin<br class="calibre3"/><br class="calibre3"/>(seq ds)<br class="calibre3"/>;=&gt; (:willie :quentin :adam)</tt></span></blockquote><p class="calibre12">But using one of Clojure’s persistent data structures paints a different picture:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def ds [:willie :barnabas :adam])<br class="calibre3"/>ds<br class="calibre3"/>;=&gt; [:willie :barnabas :adam]<br class="calibre3"/><br class="calibre3"/>(def ds1 (replace {:barnabas :quentin} ds))<br class="calibre3"/>ds<br class="calibre3"/>;=&gt; [:willie :barnabas :adam]<br class="calibre3"/><br class="calibre3"/>ds1<br class="calibre3"/>;=&gt; [:willie :quentin :adam]</tt></span></blockquote><p id="filepos338249" class="calibre12">The original vector <tt class="calibre11">ds</tt> did <span class="italic">not</span> change on the replacement of the keyword <tt class="calibre11">:barnabas</tt> but instead created another vector with the changed value. A natural concern when confronted with this picture of persistence is that a naive implementation would copy the whole collection on each change, leading to slow operations and poor use of memory. Clojure’s implementations (<a href="#filepos1068916"><span class="calibre8"><span class="underline">Bagwell 2001</span></span></a>) are instead efficient by sharing structural elements from one version of a persistent structure to another. This may seem magical, but we’ll demystify it in the next chapter. For now it’s sufficient to understand that each instance of a collection is immutable and efficient. This fact opens numerous possibilities that wouldn’t work for standard mutable collections. One of these is the sequence abstraction. </p><p id="filepos339163" class="calibre5"><span class="bold">5.1.2. Sequence terms and what they mean </span><a></a></p><blockquote class="calibre9"><span class="italic">It is better to have 100 functions operate on one data abstraction than 10 functions on 10 data structures.</span></blockquote><blockquote class="calibre25"><span class="italic">Rich Hickey</span></blockquote><p class="calibre5">The words <span class="italic">sequential</span>, <span class="italic">sequence</span>, and <span class="italic">seq</span> don’t sound very different from each other, but they mean specific things in Clojure. We’ll start with specific definitions of each term to help you tell them apart, and then go into a bit of detail about how they relate to equality partitions and the sequence abstraction. </p><p class="calibre5"><span class="calibre10"><span class="bold">Terms </span></span></p><p class="calibre7">A <span class="italic">sequential</span> collection is one that holds a series of values without reordering them. As such it’s one of three broad categories of collection types, which we discuss in the next subsection. </p><p class="calibre5">A <span class="italic">sequence</span> is a sequential collection that represents a series of values that may or may not exist yet. They may be values from a concrete collection or values that are computed as necessary. A sequence may also be empty. </p><p class="calibre5">Clojure has a simple API called <span class="italic">seq</span> for navigating collections. It consist of two functions: <tt class="calibre11">first</tt> and <tt class="calibre11">rest</tt>. If the collection has anything in it, <tt class="calibre11">(first coll)</tt> returns the first element; otherwise it returns <tt class="calibre11">nil</tt>. <tt class="calibre11">(rest coll)</tt> returns a sequence of the items other than the first. If there are no other items, <tt class="calibre11">rest</tt> returns an empty sequence and never <tt class="calibre11">nil</tt>. Functions that promise to return sequences, such as <tt class="calibre11">map</tt> and <tt class="calibre11">filter</tt>, work the same way as <tt class="calibre11">rest</tt>. A <span class="italic">seq</span> is any object that implements the seq API, thereby supporting the functions <tt class="calibre11">first</tt> and <tt class="calibre11">rest</tt>. You might consider it an immutable variant of an enumerator or iterator. </p><p id="filepos341202" class="calibre5">There’s also a function called <tt class="calibre11">seq</tt> that accepts a wide variety of collection-like objects. Some collections, such as lists, implement the seq API directly, so calling <tt class="calibre11">seq</tt> on them returns the collection itself. More often, calling <tt class="calibre11">seq</tt> on a collection returns a new seq object for navigating that collection. In either case, if the collection is empty, <tt class="calibre11">seq</tt> returns <tt class="calibre11">nil</tt> and never an empty sequence. Functions that promise to return seqs (not sequences), such as <tt class="calibre11">next</tt>, work the same way. </p><p class="calibre5">Clojure’s sequence library manipulates collections, strings, arrays, and so on as if they were sequences, using the <tt class="calibre11">seq</tt> function and seq API. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre28"><span class="calibre10"><span class="bold">Beware Type-Based Predicates</span></span></p><p class="calibre5">Clojure includes a few predicates with names like the words just defined. Though they’re not frequently used, it seems worth mentioning that they may not mean exactly what the definitions here might suggest. For example, every object for which <tt class="calibre11">sequential?</tt> returns true is a sequential collection, but it returns false for some that are also sequential. This is because of implementation details that may be improved sometime after Clojure 1.2. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre28"><span class="calibre10"><span class="bold">Equality Partitions </span></span></p><p class="calibre7">Clojure classifies each composite data type into one of three logical categories or partitions: sequentials, maps, and sets. These divisions draw clear distinctions between the types and help define equality semantics. Specifically, two objects will never be equal if they belong to different partitions. Few composite types are actually <span class="italic">sequences</span>, though several such as vectors are <span class="italic">sequential</span>. </p><p class="calibre5">If two sequentials have the same values in the same order, <tt class="calibre11">=</tt> will return true for them, even if their concrete types are different, as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(= [1 2 3] '(1 2 3))<br class="calibre3"/>;=&gt; true</tt></span></blockquote><p class="calibre12">Conversely, even if two collections have the same values in the same order, if one is a sequential collection and the other isn’t, <tt class="calibre11">=</tt> will return false, as shown here: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(= [1 2 3] #{1 2 3})<br class="calibre3"/>;=&gt; false</tt></span></blockquote><p class="calibre12">Examples of things that are sequential include Clojure lists and vectors, and Java lists such as <tt class="calibre11">java.util.ArrayList</tt>. In fact everything that implements <tt class="calibre11">java.util.List</tt> is included in the sequential partition. </p><p class="calibre5">Generally things that fall into the other partitions include <span class="italic">set</span> or <span class="italic">map</span> in their name and so are easy to identify. </p><p class="calibre5"><span class="calibre10"><span class="bold">The Sequence Abstraction </span></span></p><p class="calibre7">Many Lisps build their data types (McCarthy 1962) on the cons-cell abstraction, an elegant two-element structure illustrated in <a href="#filepos344670"><span class="calibre8"><span class="underline">Figure 5.1</span></span></a>. </p><p id="filepos344670" class="calibre5"><span class="calibre10"><span class="bold">Figure 5.1. Each cons-cell is a simple pair, a </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">car</span></tt></span><span class="calibre10"><span class="bold"> and a </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">cdr</span></tt></span><span class="calibre10"><span class="bold">. A. A list with two cells, each of which has a value X and Y as the head (the </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">car</span></tt></span><span class="calibre10"><span class="bold"> in Lisp terminology) and a list as the tail (the </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">cdr</span></tt></span><span class="calibre10"><span class="bold">). This is very similar to </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">first</span></tt></span><span class="calibre10"><span class="bold"> and </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">rest</span></tt></span><span class="calibre10"><span class="bold"> in Clojure sequences. B. A cons-cell with a simple value for both the head and tail. This is called a </span></span><span class="calibre10"><span class="italic"><span class="bold">dotted pair</span></span></span><span class="calibre10"><span class="bold"> but is not supported by any of Clojure’s built in types. </span></span></p><p class="calibre1"><img src="images/00073.jpg" class="calibre49"/></p><p class="calibre5">Clojure also has a couple of cons-cell-like structures that are covered in <a href="#filepos388921"><span class="calibre8"><span class="underline">section 5.4</span></span></a>, but they’re not central to Clojure’s design. Instead, the conceptual interface fulfilled by the cons-cell has been lifted off the concrete structure illustrated previously and <a id="filepos346086"></a>been named <span class="italic">sequence</span>. All an object needs to do to be a sequence is to support the two core functions: <tt class="calibre11">first</tt> and <tt class="calibre11">rest</tt>. This isn’t much, but it’s all that’s required for the bulk of Clojure’s powerful library of sequence functions and macros to be able to operate on the collection: <tt class="calibre11">filter</tt>, <tt class="calibre11">map</tt>, <tt class="calibre11">for</tt>, <tt class="calibre11">doseq</tt>, <tt class="calibre11">take</tt>, <tt class="calibre11">partition</tt>, the list goes on. </p><p class="calibre5">At the same time, a wide variety of objects satisfy this interface. Every Clojure collection provides at least one kind of seq object for walking through its contents, exposed via the <tt class="calibre11">seq</tt> function. Some collections provide more than one; for example vectors support <tt class="calibre11">rseq</tt> and maps support the functions <tt class="calibre11">keys</tt> and <tt class="calibre11">vals</tt>. All of these functions return a seq, or if the collection is empty, <tt class="calibre11">nil</tt>. </p><p class="calibre5">You can see examples of this by looking at the types of objects returned by various expressions. Here’s the map class:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(class (hash-map :a 1))<br class="calibre3"/>;=&gt; clojure.lang.PersistentHashMap</tt></span></blockquote><p class="calibre12">Unsurprisingly, the <tt class="calibre11">hash-map</tt> function returns an object of type <tt class="calibre11">PersistentHashMap</tt>. Passing that map object to <tt class="calibre11">seq</tt> returns an entirely new kind of object: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(seq (hash-map :a 1))<br class="calibre3"/>;=&gt; ([:a 1])<br class="calibre3"/><br class="calibre3"/>(class (seq (hash-map :a 1)))<br class="calibre3"/>;=&gt; clojure.lang.PersistentHashMap$NodeSeq</tt></span></blockquote><p class="calibre12">This class name suggests it’s a seq of nodes on a hash map. Similarly we can get a seq of keys on the same map:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(seq (keys (hash-map :a 1)))<br class="calibre3"/>;=&gt; (:a)<br class="calibre3"/><br class="calibre3"/>(class (keys (hash-map :a 1)))<br class="calibre3"/>;=&gt; clojure.lang.APersistentMap$KeySeq</tt></span></blockquote><p class="calibre12">Note that these specific class names are an implementation detail that may change in the future, but the concepts they embody are central to Clojure and unlikely to change. </p><p class="calibre5">Having laid the foundation for a deeper dive into the sequence abstraction, we now must quickly diverge into a simplified discussion of asymptotic complexity and Big-O notation. If you’re already comfortable with these topics then by all means skip forward to <a href="#filepos353970"><span class="calibre8"><span class="underline">section 5.2</span></span></a>. If you need a refresher or an overview, then the next section is a minimalist introduction (<a href="#filepos1070341"><span class="calibre8"><span class="underline">Cormen 2009</span></span></a>) to the topic. </p><p id="filepos348882" class="calibre5"><span class="bold">5.1.3. Big-O </span><a></a></p><p id="filepos348941" class="calibre7">This book isn’t heavily focused on asymptotic complexity but we do mention it a handful of times throughout, so here we’ll cover the minimum required for understanding these few mentions. You may have gone your entire career without having to understand Big-O notation, and you may likely go the remainder similarly. But that’s no reason not to learn more, and a bit of understanding about Big-O and its implications will go a long way toward helping you in choosing between Clojure collections, as well as to design and analyze algorithms in general. </p><p class="calibre5">Algorithmic complexity is a system for describing the <span class="italic">relative</span> space and time costs for algorithms. Typically the complexity of an algorithm is described using what’s known as Big-O notation. For example, you may have heard that finding an element in a linked list is O(n), which is read as “order n.” What this means is that if you have a list <tt class="calibre11">(:a :b :c)</tt> of length 3, then to verify that the keyword <tt class="calibre11">:c</tt> is in that list requires three comparisons. This highlights the <span class="italic">worst case</span> of list access because <tt class="calibre11">:c</tt> is at the end of the list, but we don’t worry too much about the worst-case scenario unless that’s the only difference between two algorithms. On the other hand, to verify that <tt class="calibre11">:a</tt> is in the same list is O(1), which is read as constant time. Finding <tt class="calibre11">:a</tt> represents the <span class="italic">best case</span> for list access because it’s at the front of the list. Rarely do your lists always look exactly like our example, and therefore you shouldn’t build your hopes that elements will always be at the front. Therefore, in analyzing algorithms you rarely care about the best-case scenario because it’s too rare to matter much. What you really care about when analyzing algorithms is the <span class="italic">expected case</span>, or what you’d likely see in practice. When looking at a few million runs of verifying that some value is contained in a million different lists, you’d inevitably see that the average number of comparisons required approaches whatever the length of a list was, divided by two. But because doubling the length of the list would also double the number of comparisons done in both the expected and worst case, they’re all grouped into the same Big-O category: O(n) also known as <span class="italic">linear time</span>. </p><p class="calibre5">Thus two algorithms that are in the same Big-O category may perform very differently, especially on small work loads. This makes the most difference when there’s a large <span class="italic">constant factor</span>, work that the algorithm has to do up front regardless of the size of the work load. </p><p class="calibre5">When the work load is small, an O(1) algorithm with a large constant factor may be more costly than an O(n) algorithm that’s without extra costs. But as the work load increases, an O(1) algorithm will <span class="italic">always</span> overtake the O(n) algorithm as shown in <a href="#filepos352083"><span class="calibre8"><span class="underline">Figure 5.2</span></span></a>. Big-O doesn’t concern itself with these constant factors or small work loads. </p><p id="filepos352083" class="calibre5"><span class="calibre10"><span class="bold">Figure 5.2. Overtaking the smaller. In Big-O, regardless of the other ancillary costs, the higher order of magnitude will always overtake the lower eventually. </span></span><a></a></p><p class="calibre1"><img src="images/00082.jpg" class="calibre50"/></p><p class="calibre5">When learning about Clojure’s persistent data structures, you’re likely to hear the term O(log<sub class="calibre51"><small class="calibre32"><span class="calibre33">32</span></small></sub> n) for those based on the persistent hash trie and O(log<sub class="calibre51"><small class="calibre32"><span class="calibre33">2</span></small></sub> n) for the sorted structures. Accessing an element in a Clojure persistent structure by index is O(log n), or logarithmic. Logarithmic complexity describes a class of algorithms that are effectively immune from large changes in the size of their data. In the case of Clojure’s persistent structures, what this means is that there’s little difference in “hops” (such as comparisons) between locating an element in a structure containing 100 <a id="filepos353159"></a>elements or 1 million elements. In practice you may notice some difference because for a billion objects O(log<sub class="calibre51"><small class="calibre32"><span class="calibre33">2</span></small></sub> n) would require approximately 30 comparisons for a lookup, whereas O(log<sub class="calibre51"><small class="calibre32"><span class="calibre33">32</span></small></sub> n) would require only about 6. Given the smaller number of operations required for the O(log<sub class="calibre51"><small class="calibre32"><span class="calibre33">32</span></small></sub> n) data structures, they can be viewed as providing a nearly O(1) lookup and update. </p><p class="calibre5">We’ve covered the basic ideas behind persistence and the sequence abstraction, and even touched on the basics of Big-O notation. Now we’ll discuss all of Clojure’s primary collection types and how these concepts apply to each, starting with vectors. </p><p id="filepos353970" class="calibre5"><span class="calibre18"><span class="bold">5.2. Vectors: creating and using them in all their varieties </span></span></p><p class="calibre7">Vectors store zero or more values sequentially indexed by number, a bit like arrays, but are immutable and persistent. They’re versatile and make efficient use of memory and processor resources at both small and large sizes. </p><p class="calibre5">Vectors are probably the most frequently used collection type in Clojure code. They’re used as literals for argument lists and <tt class="calibre11">let</tt> bindings, for holding large amounts of application data, and as stacks and as map entries. We’ll also address the efficiency considerations including growing on the right end, subvectors, and reversals, and finally discuss where vectors aren’t an optimal solution. </p><p id="filepos354795" class="calibre5"><span class="bold">5.2.1. Building vectors </span><a></a></p><p class="calibre7">The vector’s literal square-bracket syntax is one reason you might choose to use a vector over a list. For example, the <tt class="calibre11">let</tt> form would work perfectly well, and with a nearly identical implementation, if it took a literal <span class="italic">list</span> of bindings instead of a literal <span class="italic">vector</span>. But the square brackets are visually different from the round parentheses surrounding the <tt class="calibre11">let</tt> form itself as well as the likely function calls in the body of the <tt class="calibre11">let</tt> form, and this is useful for humans (so we hear). Using vectors to indicate bindings for <tt class="calibre11">let</tt>, <tt class="calibre11">with-open</tt>, <tt class="calibre11">fn</tt>, and such is idiomatic in Clojure and is a pattern you’re encouraged to follow in any similar macros you write. </p><p id="filepos355623" class="calibre5">The most common way to create a vector is with the literal syntax described earlier. But in many cases you’ll want to create a vector out of the contents of some other kind of collection. For this there’s the function <tt class="calibre11">vec</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(vec (range 10))<br class="calibre3"/>;=&gt; [0 1 2 3 4 5 6 7 8 9]</tt></span></blockquote><p class="calibre12">If you already have a vector but want to “pour” several values into it, then <tt class="calibre11">into</tt> is your friend: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(let [my-vector [:a :b :c]]<br class="calibre3"/>  (into my-vector (range 10)))<br class="calibre3"/>;=&gt; [:a :b :c 0 1 2 3 4 5 6 7 8 9]</tt></span></blockquote><p class="calibre12">If you want it to return a vector, the first argument to <tt class="calibre11">into</tt>
<span class="italic">must</span> be a vector. The second arg can be any sequence, such as what <tt class="calibre11">range</tt> returns, or anything else that works with <tt class="calibre11">seq</tt> function. You can view the operation of <tt class="calibre11">into</tt> as similar to a O(n) concatenation based on the size of the second argument.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos357120"><span class="calibre33"><span class="calibre8"><span class="underline">1</span></span></span></a><span class="calibre33">]</span></small></sup> Clojure also provides a <tt class="calibre11">vector</tt> function to build a vector from its arguments, which is handy for constructs like <tt class="calibre11">(map vector a b)</tt>. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos357120" class="calibre32"><span class="calibre33">1</span></small></sup><span class="calibre10"> Vectors can’t be concatenated any more efficiently than O(n). </span></blockquote><p class="calibre12"><span class="calibre10"><span class="bold">Primitive Vectors </span></span></p><p class="calibre7">Clojure can store primitive types inside of vectors using the <tt class="calibre11">vector-of</tt> function, which takes any of <tt class="calibre11">:int</tt>, <tt class="calibre11">:long</tt>, <tt class="calibre11">:float</tt>, <tt class="calibre11">:double</tt>, <tt class="calibre11">:byte</tt>, <tt class="calibre11">:short</tt>, <tt class="calibre11">:boolean</tt>, or <tt class="calibre11">:char</tt> as its argument and returns an empty vector. This returned vector will act just like any other vector, except that it’ll store its contents as primitives internally. All of the normal vector operations still apply, and the new vector will attempt to coerce any additions into its internal type when being added: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(into (vector-of :int) [Math/PI 2 1.3])<br class="calibre3"/>;=&gt; [3 2 1]<br class="calibre3"/>(into (vector-of :char) [100 101 102])<br class="calibre3"/>;=&gt; [\d \e \f]<br class="calibre3"/>(into (vector-of :int) [1 2 623876371267813267326786327863])<br class="calibre3"/>;  java.lang.IllegalArgumentException: Value out of range for int:<br class="calibre3"/>     -8359803716404783817</tt></span></blockquote><p class="calibre12">In addition, all caveats mentioned in <a href="#filepos288030"><span class="calibre8"><span class="underline">section 4.1</span></span></a> regarding overflow, underflow, and so forth also apply to vectors of primitives. </p><p class="calibre5">Using <tt class="calibre11">vec</tt> and <tt class="calibre11">into</tt>, it’s easy to build vectors much larger than are conveniently built using vector literals. But once you have a large vector like that, what are you going to do with it? </p><p id="filepos358828" class="calibre5"><span class="bold">5.2.2. Large vectors </span><a></a></p><p class="calibre7">When collections are small, the performance differences between vectors and lists hardly matters at all. But as both get larger, each becomes dramatically slower at operations the other can still perform efficiently. Vectors are particularly efficient at three things relative to lists: adding or removing things from the right end of the collection, <a id="filepos359275"></a>accessing or changing items in the interior of the collection by numeric index, and walking in reverse order. Adding and removing from the end is done by treating the vector as a stack—we’ll cover that later. </p><p class="calibre5">Any item in a vector can be accessed by its index number from <tt class="calibre11">0</tt> up to but not including <tt class="calibre11">(count my-vector)</tt> in essentially constant time.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos360106"><span class="calibre33"><span class="calibre8"><span class="underline">2</span></span></span></a><span class="calibre33">]</span></small></sup> You can do this using the function <tt class="calibre11">nth</tt>; the function <tt class="calibre11">get</tt>, essentially treating the vector like a map; or by invoking the vector itself as a function. Look at each of these as applied to this example vector: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos360106" class="calibre32"><span class="calibre33">2</span></small></sup><span class="calibre10"> Several operations on Clojure’s persistent data structures are described in this book as “essentially constant time.” In all cases these are O(log<sub class="calibre52"><small class="calibre32"><span class="calibre33">32</span></small></sub> n). </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(def a-to-j (vec (map char (range 65 75))))<br class="calibre3"/>a-to-j<br class="calibre3"/>;=&gt; [\A \B \C \D \E \F \G \H \I \J]</tt></span></blockquote><p class="calibre12">All three of these do the same work and each returns <tt class="calibre11">\E</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(nth a-to-j 4)<br class="calibre3"/>(get a-to-j 4)<br class="calibre3"/>(a-to-j 4)</tt></span></blockquote><p class="calibre12">Which to use is a judgment call, but <a href="#filepos361034"><span class="calibre8"><span class="underline">table 5.1</span></span></a> highlights some points you might consider when choosing. </p><p id="filepos361034" class="calibre5"><span class="calibre10"><span class="bold">Table 5.1. Vector lookup options: the three ways to look up an item in a vector and how each responds to different exceptional circumstances </span></span><a></a></p><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><th scope="col" valign="top" class="calibre26"><span class="calibre10"><span class="bold"> </span></span>
</th><th scope="col" valign="top" class="calibre26"><p class="calibre27"><span class="calibre10"><span class="bold">nth</span></span></p></th><th scope="col" valign="top" class="calibre26"><p class="calibre27"><span class="calibre10"><span class="bold">get</span></span></p></th><th scope="col" valign="top" class="calibre26"><p class="calibre27"><span class="calibre10"><span class="bold">Vector as a function</span></span></p></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">If the vector is nil</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Returns nil</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Returns nil</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Throws an exception</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">If the index is out of range</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Returns “not found” or throws exception</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Returns nil</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Throws an exception</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">Supports a “not found” arg</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Yes (nth [] 9 :whoops) </span>
</td><td valign="top" class="calibre16"><span class="calibre10">Yes (get [] 9 :whoops) </span>
</td><td valign="top" class="calibre16"><span class="calibre10">No</span>
</td></tr></table><p class="calibre7">Because vectors are indexed, they can be efficiently walked in either direction, left-to-right or right-to-left. The <tt class="calibre11">seq</tt> and <tt class="calibre11">rseq</tt> functions return sequences that do exactly that: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(seq a-to-j)<br class="calibre3"/>;=&gt; (\A \B \C \D \E \F \G \H \I \J)<br class="calibre3"/><br class="calibre3"/>(rseq a-to-j)<br class="calibre3"/>;=&gt; (\J \I \H \G \F \E \D \C \B \A)</tt></span></blockquote><p class="calibre12">Any item in a vector can be “changed” using the <tt class="calibre11">assoc</tt> function. Clojure does this in essentially constant time using structural sharing between the old and new vectors as described at the beginning of this chapter: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(assoc a-to-j 4 "no longer E")<br class="calibre3"/>;=&gt; [\A \B \C \D "no longer E" \F \G \H \I \J]</tt></span></blockquote><p class="calibre12">The <tt class="calibre11">assoc</tt> function for vectors only works on indices that already exist in the vector, or as a special case, exactly one step past the end. In this case, the returned vector will <a id="filepos363711"></a>be one item larger than the input vector. More frequently vectors are “grown” using the <tt class="calibre11">conj</tt> function as you’ll see in the next section. </p><p class="calibre5">There are a few higher-powered functions provided that use <tt class="calibre11">assoc</tt> internally. For example, the <tt class="calibre11">replace</tt> function works on both seqs and vectors, but when given a vector, it uses <tt class="calibre11">assoc</tt> to fix up and return a new vector: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(replace {2 :a, 4 :b} [1 2 3 2 3 4])<br class="calibre3"/>;=&gt; [1 :a 3 :a 3 :b]</tt></span></blockquote><p class="calibre12">The functions <tt class="calibre11">assoc-in</tt> and <tt class="calibre11">update-in</tt> are for working with nested structures of vectors and/or maps, like this one:<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos364676"><span class="calibre33"><span class="calibre8"><span class="underline">3</span></span></span></a><span class="calibre33">]</span></small></sup></p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos364676" class="calibre32"><span class="calibre33">3</span></small></sup><span class="calibre10"> Nested vectors are far from the most efficient way to store or process matrices, but they’re convenient to manipulate in Clojure and so make a good example here. More efficient options include a single vector, arrays, or a library for matrix processing such as Colt or Incanter at </span><a href="http://incanter.org"><span class="calibre10"><span class="calibre8"><span class="underline">http://incanter.org</span></span></span></a><span class="calibre10">. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(def matrix<br class="calibre3"/>     [[1 2 3]<br class="calibre3"/>      [4 5 6]<br class="calibre3"/>      [7 8 9]])</tt></span></blockquote><p class="calibre12">All of <tt class="calibre11">assoc-in</tt>, <tt class="calibre11">get-in</tt>, and <tt class="calibre11">update-in</tt> take a series of indices to pick items from each more deeply nested level. For a vector arranged like the earlier <tt class="calibre11">matrix</tt> example, this amounts to row and column coordinates: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(get-in matrix [1 2])<br class="calibre3"/>;=&gt; 6<br class="calibre3"/><br class="calibre3"/>(assoc-in matrix [1 2] 'x)<br class="calibre3"/>;=&gt; [[1 2 3] [4 5 x] [7 8 9]]</tt></span></blockquote><p class="calibre12">The <tt class="calibre11">update-in</tt> function works the same way, but instead of taking a value to <span class="italic">overwrite</span> an existing value, it takes a function to <span class="italic">apply</span> to an existing value. It’ll replace the value at the given coordinates with the return value of the function given: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(update-in matrix [1 2] * 100)<br class="calibre3"/>;=&gt; [[1 2 3] [4 5 600] [7 8 9]]</tt></span></blockquote><p class="calibre12">The coordinates refer to the value <tt class="calibre11">6</tt>, and the function given here is <tt class="calibre11">*</tt> taking an argument <tt class="calibre11">100</tt>, so the slot becomes the return value of <tt class="calibre11">(* 6 100)</tt>. There’s also a function <tt class="calibre11">get-in</tt> for retrieving a value in a nested vector. Before exploring its operation, we’ll create a function <tt class="calibre11">neighbors</tt> in <a href="#filepos366893"><span class="calibre8"><span class="underline">listing 5.1</span></span></a> that given a y-x location in an equilateral 2D matrix, returns a sequence of the locations surrounding it. </p><p id="filepos366893" class="calibre5"><span class="calibre10"><span class="bold">Listing 5.1. A function for finding the neighbors of a spot on a 2D matrix </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn neighbors<br class="calibre3"/>  ([size yx] (neighbors [[-1 0] [1 0] [0 -1] [0 1]] size yx))<br class="calibre3"/>  ([deltas size yx]<br class="calibre3"/>     (filter (fn [new-yx]<br class="calibre3"/>               (every? #(&lt; -1 % size) new-yx))<br class="calibre3"/>             (map #(map + yx %) deltas))))</tt></span></blockquote><p id="filepos367438" class="calibre12">The operation of <tt class="calibre11">neighbors</tt> is fairly straightforward. The <tt class="calibre11">deltas</tt> local describes that a neighbor can be one spot away, but only along the x or y axis (not diagonal). The function first walks through <tt class="calibre11">deltas</tt> and builds a vector of each added to the <tt class="calibre11">yx</tt> point provided. This operation will of course generate illegal point coordinates, so those are then removed using <tt class="calibre11">filter</tt>, which checks to ensure that the indices lie between <tt class="calibre11">-1</tt> and the provided <tt class="calibre11">size</tt>. You can test this function using <tt class="calibre11">get-in</tt> as follows: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(map #(get-in matrix %) (neighbors 3 [0 0]))<br class="calibre3"/>;=&gt; (4 2)</tt></span></blockquote><p class="calibre12">For each neighbor coordinate returned from <tt class="calibre11">neighbors</tt>, we use <tt class="calibre11">get-in</tt> to retrieve the value at that point. Indeed the position <tt class="calibre11">[0 0]</tt> corresponding to the value <tt class="calibre11">1</tt> has the neighboring values <tt class="calibre11">4</tt> and <tt class="calibre11">2</tt>. We’ll use <tt class="calibre11">neighbors</tt> again before this book comes to an end, but next we’ll look at growing and shrinking vectors—treating them like stacks. </p><p id="filepos368638" class="calibre5"><span class="bold">5.2.3. Vectors as stacks </span><a></a></p><p class="calibre7">Classic stacks have at least two operations, <span class="italic">push</span> and <span class="italic">pop</span>, and with respect to Clojure vectors these operations are called <tt class="calibre11">conj</tt> and <tt class="calibre11">pop</tt> respectively. The <tt class="calibre11">conj</tt> function adds elements to and <tt class="calibre11">pop</tt> removes elements from the right side of the stack. Because vectors are immutable, <tt class="calibre11">pop</tt> returns a new vector with the rightmost item dropped—this is different from many mutable stack APIs, which generally return the dropped item. Consequently, <tt class="calibre11">peek</tt> becomes more important as the primary way to get an item from the top of the stack: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def my-stack [1 2 3])<br class="calibre3"/><br class="calibre3"/>(peek my-stack)<br class="calibre3"/>;=&gt; 3<br class="calibre3"/><br class="calibre3"/>(pop my-stack)<br class="calibre3"/>;=&gt; [1 2]<br class="calibre3"/><br class="calibre3"/>(conj my-stack 4)<br class="calibre3"/>;=&gt; [1 2 3 4]<br class="calibre3"/><br class="calibre3"/>(+ (peek my-stack) (peek (pop my-stack)))<br class="calibre3"/>;=&gt; 5</tt></span></blockquote><p class="calibre12">Each of these operations completes in essentially constant time. Most of the time, a vector that’s used as a stack is used that way throughout its life. It’s helpful to future readers of your code to keep this is mind and use the stack operations consistently, even when other functions might work. For example, <tt class="calibre11">last</tt> on a vector returns the same thing as <tt class="calibre11">peek</tt>, but besides being slower, it leads to unnecessary confusion about how the collection is being used. If the algorithm involved calls for a stack, use <tt class="calibre11">conj</tt> not <tt class="calibre11">assoc</tt> for growing the vector, <tt class="calibre11">peek</tt> not <tt class="calibre11">last</tt>, and <tt class="calibre11">pop</tt> not <tt class="calibre11">dissoc</tt> for shrinking it. </p><p class="calibre5">The functions <tt class="calibre11">conj</tt>, <tt class="calibre11">pop</tt>, and <tt class="calibre11">peek</tt> work on any object that implements <tt class="calibre11">clojure.lang.IPersistentStack</tt>.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos371064"><span class="calibre33"><span class="calibre8"><span class="underline">4</span></span></span></a><span class="calibre33">]</span></small></sup> Besides vectors, Clojure lists also implement this interface, <a id="filepos370789"></a>but the functions operate on the left side of lists instead of the right side as with vectors. When operating on either via the stack discipline, it’s best to ignore the ordering, because it tends to just add confusion. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos371064" class="calibre32"><span class="calibre33">4</span></small></sup><span class="calibre10"> The </span><span class="calibre10"><tt class="calibre11">conj</tt></span><span class="calibre10"> function also works with all of Clojure’s other persistent collection types, even if they don’t implement </span><span class="calibre10"><tt class="calibre11">clojure.lang.IPersistentStack</tt></span><span class="calibre10">. </span></blockquote><p id="filepos371400" class="calibre35"><span class="bold">5.2.4. Using vectors instead of reverse </span><a></a></p><p class="calibre7">The ability of vectors to grow efficiently on the right side and then be walked left-to-right produces a noteworthy emergent behavior: idiomatic Clojure code rarely uses the <tt class="calibre11">reverse</tt> function. This is different from most Lisps and schemes. When processing a list, it’s pretty common to want to produce a new list in the same order. But if all you have are classic Lisp lists, often the most natural algorithm<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos372263"><span class="calibre33"><span class="calibre8"><span class="underline">5</span></span></span></a><span class="calibre33">]</span></small></sup> leaves you with a backward list that needs to be reversed. Here’s an example of a function similar to Clojure’s <tt class="calibre11">map</tt></p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos372263" class="calibre32"><span class="calibre33">5</span></small></sup><span class="calibre10"> ...the most natural </span><span class="calibre10"><span class="italic">tail-recursive</span></span><span class="calibre10"> algorithm anyway. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn strict-map1 [f coll]<br class="calibre3"/>  (loop [coll coll, acc nil]<br class="calibre3"/>    (if (empty? coll)<br class="calibre3"/>      (reverse acc)<br class="calibre3"/>      (recur (next coll) (cons (f (first coll)) acc)))))<br class="calibre3"/><br class="calibre3"/>(strict-map1 - (range 5))<br class="calibre3"/>;=&gt; (0 -1 -2 -3 -4)</tt></span></blockquote><p class="calibre12">This is perfectly good, idiomatic Clojure code, except for that glaring <tt class="calibre11">reverse</tt> of the final return value. After the entire list has been walked once to produce the desired values, <tt class="calibre11">reverse</tt> walks it again to get them in the right order. This is both inefficient and nonidiomatic. One way to get rid of the <tt class="calibre11">reverse</tt> is to use a vector instead of a list as the accumulator: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn strict-map2 [f coll]<br class="calibre3"/>  (loop [coll coll, acc []]<br class="calibre3"/>    (if (empty? coll)<br class="calibre3"/>      acc<br class="calibre3"/>      (recur (next coll) (conj acc (f (first coll)))))))<br class="calibre3"/><br class="calibre3"/>(strict-map2 - (range 5))<br class="calibre3"/>;=&gt; [0 -1 -2 -3 -4]</tt></span></blockquote><p class="calibre12">A small change, but the code is now a touch cleaner and a bit faster. It does return a vector instead of a list, but this is rarely a problem, because any client code that wants to treat this as a seq can usually do so automatically.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos374096"><span class="calibre33"><span class="calibre8"><span class="underline">6</span></span></span></a><span class="calibre33">]</span></small></sup></p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos374096" class="calibre32"><span class="calibre33">6</span></small></sup><span class="calibre10"> Another way to get rid of a </span><span class="calibre10"><tt class="calibre11">reverse</tt></span><span class="calibre10"> is to build a lazy sequence instead of a strict collection; this is how Clojure’s own map function is implemented. </span></blockquote><p class="calibre12">The examples we’ve shown so far have all been plain vectors, but we’ll turn now to the special features of some other vector types, starting with subvectors. </p><p id="filepos374577" class="calibre5"><span class="bold">5.2.5. Subvectors </span><a></a></p><p id="filepos374641" class="calibre7">Although items can’t be removed efficiently from a vector (except the rightmost item), subvectors provide a fast way to take a slice of an existing vector based on start and end indices created using the <tt class="calibre11">subvec</tt> function: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(subvec a-to-j 3 6)<br class="calibre3"/>;=&gt; [\D \E \F]</tt></span></blockquote><p class="calibre12">The first index given to <tt class="calibre11">subvec</tt> is inclusive (starts <span class="italic">at</span> index 3) but the second is exclusive (ends <span class="italic">before</span> index 6). The new subvector internally hangs onto the entire original <tt class="calibre11">a-to-j</tt> vector, making each lookup performed on the new vector cause the subvector to do a little offset math and then look it up in the original. This makes creating a sub-vector fast. You can use <tt class="calibre11">subvec</tt> on any kind of vector and it’ll work fine. But there’s special logic for taking a subvec of a subvec, in which case the newest subvector keeps a reference to the <span class="italic">original</span> vector, not the intermediate subvector. This prevents subvectors-of-subvectors from stacking up needlessly, and keeps both the creation and use of the sub-subvecs fast and efficient. </p><p id="filepos375857" class="calibre5"><span class="bold">5.2.6. Vectors as MapEntries </span><a></a></p><p class="calibre7">Clojure’s hash map, just like hash tables or dictionaries in many other languages, has a mechanism to iterate through the entire collection. Clojure’s solution for this iterator is, unsurprisingly, a seq. Each item of this seq needs to include both the key and the value, so they’re wrapped in a MapEntry. When printed, each entry looks like a vector: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(first {:width 10, :height 20, :depth 15})<br class="calibre3"/>;=&gt; [:width 10]</tt></span></blockquote><p class="calibre12">But not only does a MapEntry <span class="italic">look</span> like a vector, it really is one: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(vector? (first {:width 10, :height 20, :depth 15}))<br class="calibre3"/>;=&gt; true</tt></span></blockquote><p class="calibre12">This means you can use all the regular vector functions on it: <tt class="calibre11">conj</tt>, <tt class="calibre11">get</tt>, and so on. It even supports destructuring, which can be handy. For example, the following locals <tt class="calibre11">dimension</tt> and <tt class="calibre11">amount</tt> will take on the value of each key/value pair in turn: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(doseq [[dimension amount] {:width 10, :height 20, :depth 15}]<br class="calibre3"/>  (println (str (name dimension) ":") amount "inches"))<br class="calibre3"/>; width: 10 inches<br class="calibre3"/>; height: 20 inches<br class="calibre3"/>; depth: 15 inches<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p class="calibre12">A MapEntry is its own type and has two functions for retrieving its contents: <tt class="calibre11">key</tt> and <tt class="calibre11">val</tt>, which do exactly the same thing as <tt class="calibre11">(nth my-map 0)</tt> and <tt class="calibre11">(nth my-map 1)</tt>, respectively. These are sometimes useful for the clarity they can bring to your code, but frequently destructuring is used instead, because it’s so darned handy. </p><p id="filepos377793" class="calibre5">So now you know what vectors are, what specific kinds of vectors are included in Clojure, and some of the things that they’re good at doing. To round out your understanding of vectors, we’ll conclude with a brief look at things that vectors are <span class="italic">bad</span> at doing. </p><p id="filepos378095" class="calibre5"><span class="bold">5.2.7. What vectors aren’t </span><a></a></p><p class="calibre7">Vectors are versatile, but there are some commonly desired patterns where they might <span class="italic">seem</span> like a good solution but in fact aren’t. Though we prefer to focus on the positive, we hope a few negative examples will help you escape from using the wrong tool for the job. </p><p class="calibre5"><span class="calibre10"><span class="bold">Vectors Aren’t Sparse </span></span></p><p class="calibre7">If you have a vector of length <span class="italic">n</span>, the only position where you can insert a value is at index <span class="italic">n</span>—appending to the far right end. You can’t skip some indices and insert at a higher index number. If you want a collection indexed by nonsequential numbers, consider a hash map or sorted map. Although you can replace values within a vector, you can’t insert or delete items such that indices for the subsequent items would have to be adjusted. Clojure doesn’t currently have a native persistent collection that supports this kind of operation, but a possible future addition, finger trees, may help for these use cases. </p><p class="calibre5"><span class="calibre10"><span class="bold">Vectors aren’t Queues </span></span></p><p class="calibre7">Some people have tried to use vectors as queues. One approach would be to push onto the right end of the vector using <tt class="calibre11">conj</tt> and then to pop items off the left using <tt class="calibre11">rest</tt> or <tt class="calibre11">next</tt>. The problem with this is that <tt class="calibre11">rest</tt> and <tt class="calibre11">next</tt> return seqs, not vectors, so subsequent <tt class="calibre11">conj</tt> operations wouldn’t behave as desired. Using <tt class="calibre11">into</tt> to convert the seq back into a vector is O(n), which is less than ideal for every <tt class="calibre11">pop</tt>. </p><p class="calibre5">Another approach is to use <tt class="calibre11">subvec</tt> as a “pop,” leaving off the leftmost item. Because <tt class="calibre11">subvec</tt> does return a vector, subsequent <tt class="calibre11">conj</tt> operations will push onto the right end as desired. But as described earlier, <tt class="calibre11">subvec</tt> maintains a reference to the entire underlying vector, so none of the items being popped this way will ever be garbage collected. Also less than ideal. </p><p class="calibre5">So what <span class="italic">would</span> be the ideal way to do queue operations on a persistent collection? Why, use a PersistentQueue, of course. See <a href="#filepos396660"><span class="calibre8"><span class="underline">section 5.5</span></span></a> for details. </p><p class="calibre5"><span class="calibre10"><span class="bold">Vectors aren’t Sets </span></span></p><p class="calibre7">If you want to find out whether a vector contains a particular value, you might be tempted to use the <tt class="calibre11">contains?</tt> function, but you’d be disappointed by the results. Clojure’s <tt class="calibre11">contains?</tt> is for asking whether a particular <span class="italic">key</span>, not <span class="italic">value</span>, is in a collection, which is rarely useful for a vector. </p><p class="calibre5">In this section we showed how to create vectors using literal syntax or by building them up programmatically. We looked at how to push them, pop them, and slice them. We also looked at some of the things vectors can’t do well. One of these was adding and removing items from the left side; though vectors can’t do this, lists can, which we’ll discuss next. </p><p id="filepos381354" class="calibre5"><span class="calibre18"><span class="bold">5.3. Lists: Clojure’s code form data structure </span></span></p><p id="filepos381464" class="calibre7">Clojure’s PersistentLists are by far the simplest of Clojure’s persistent collection types. A PersistentList is a singly linked list where each node knows its distance from the end. List elements can only be found by starting with the first element and walking each prior node in order, and can only be added or removed from the left end. </p><p class="calibre5">In idiomatic Clojure code, lists are used almost exclusively to represent code forms. They’re used literally in code to call functions, macros, and so forth as we’ll discuss shortly. Code forms are also built programmatically to then be <tt class="calibre11">eval</tt>ed or used as the return value for a macro. If the final usage of a collection isn’t as Clojure code, lists rarely offer any value over vectors and are thus rarely used. But lists have rich heritage in Lisps so we’ll discuss when they should be used in Clojure, and also when they shouldn’t—situations in which there are now better options. </p><p id="filepos382475" class="calibre5"><span class="bold">5.3.1. Lists like Lisps like </span><a></a></p><p class="calibre7">All flavors of Lisp have lists that they like to use, and Clojure lists, already introduced in <a href="#filepos163683"><span class="calibre8"><span class="underline">chapter 2</span></span></a>, are similar enough to be familiar. The functions have different names, but what other Lisps call <tt class="calibre11">car</tt> is the same as <tt class="calibre11">first</tt> on a Clojure list. Similarly <tt class="calibre11">cdr</tt> is the same as <tt class="calibre11">next</tt>. But there are substantial differences as well. Perhaps the most surprising is the behavior of <tt class="calibre11">cons</tt>. Both <tt class="calibre11">cons</tt> and <tt class="calibre11">conj</tt> add something to the front of a list, but their arguments in a different order from each other: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(cons 1 '(2 3))<br class="calibre3"/>;=&gt; (1 2 3)<br class="calibre3"/><br class="calibre3"/>(conj '(2 3) 1)<br class="calibre3"/>;=&gt; (1 2 3)</tt></span></blockquote><p class="calibre12">In a departure from classic Lisps, the “right” way to add to the front of a list is with <tt class="calibre11">conj</tt>. For each concrete type, <tt class="calibre11">conj</tt> will add elements in the most efficient way, and for lists this means at the left side. Additionally, a list built using <tt class="calibre11">conj</tt> is homogeneous—all the objects on its <tt class="calibre11">next</tt> chain are guaranteed to be lists, whereas sequences built with <tt class="calibre11">cons</tt> only promise that the result will be some kind of seq. So you can use <tt class="calibre11">cons</tt> to add to the front of a lazy seq, a range, or any other type of seq, but the only way to get a bigger list is to use <tt class="calibre11">conj</tt>.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos384565"><span class="calibre33"><span class="calibre8"><span class="underline">7</span></span></span></a><span class="calibre33">]</span></small></sup> Either way, the <tt class="calibre11">next</tt> part has to be some kind of sequence, which points out another difference from other Lisps: Clojure has no “dotted pair.” If you don’t know what that is, don’t worry about it. All you need to know is that if you want a simple pair in a Clojure program, use a vector of two items. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos384565" class="calibre32"><span class="calibre33">7</span></small></sup><span class="calibre10"> Or to </span><span class="calibre10"><tt class="calibre11">conj</tt></span><span class="calibre10"> or </span><span class="calibre10"><tt class="calibre11">cons</tt></span><span class="calibre10"> onto </span><span class="calibre10"><tt class="calibre11">nil</tt></span><span class="calibre10">. This is a special case, because </span><span class="calibre10"><tt class="calibre11">nil</tt></span><span class="calibre10"> isn’t the same as an empty collection of any specific type. Clojure </span><span class="calibre10"><span class="italic">could</span></span><span class="calibre10"> have just left this unsupported, perhaps throwing an exception if you did </span><span class="calibre10"><tt class="calibre11">(cons 1 nil)</tt></span><span class="calibre10">, but instead it provides a reasonable default behavior: building a list one item long. </span></blockquote><p class="calibre12">All seqs print with rounded parentheses, but this does <span class="italic">not</span> mean they’re the same type or will behave the same way. For example many of these seq types don’t know their own size the way lists do, so calling <tt class="calibre11">count</tt> on them may be O(n) instead of O(1).<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos386045"><span class="calibre33"><span class="calibre8"><span class="underline">8</span></span></span></a><span class="calibre33">]</span></small></sup> An <a id="filepos385731"></a>unsurprising difference between lists in Clojure versus other Lisps is that they’re immutable. At least that had better not be surprising anymore. Changing values within a list is generally discouraged in other Lisps anyway, but in Clojure it’s impossible. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos386045" class="calibre32"><span class="calibre33">8</span></small></sup><span class="calibre10"> You can test for this property of being countable in constant time using the </span><span class="calibre10"><tt class="calibre11">counted?</tt></span><span class="calibre10"> function. For example </span><span class="calibre10"><tt class="calibre11">(counted? (range 10))</tt></span><span class="calibre10"> returns </span><span class="calibre10"><tt class="calibre11">true</tt></span><span class="calibre10"> in Clojure 1.0, but </span><span class="calibre10"><tt class="calibre11">false</tt></span><span class="calibre10"> in 1.1 because the implementation of </span><span class="calibre10"><tt class="calibre11">range</tt></span><span class="calibre10"> changed between those versions and no longer provided O(1) counting. </span></blockquote><p id="filepos386671" class="calibre35"><span class="bold">5.3.2. Lists as stacks </span><a></a></p><p class="calibre7">Lists in all Lisps can be used as stacks, but Clojure goes further by supporting the <tt class="calibre11">IPersistentStack</tt> interface. This means you can use the functions <tt class="calibre11">peek</tt> and <tt class="calibre11">pop</tt> to do roughly the same thing as <tt class="calibre11">first</tt> and <tt class="calibre11">next</tt>. Two details are worth noting. One is that <tt class="calibre11">next</tt> and <tt class="calibre11">rest</tt> are legal on an empty list, but <tt class="calibre11">pop</tt> throws an exception. The other is that <tt class="calibre11">next</tt> on a one-item list returns <tt class="calibre11">nil</tt>, whereas <tt class="calibre11">rest</tt> and <tt class="calibre11">pop</tt> both return an empty list. </p><p class="calibre5">When you want a stack, the choice between using a list versus a vector is a somewhat subtle decision. Their memory organization is quite different, so it may be worth testing your usage to see which performs better. Also, the order of values returned by <tt class="calibre11">seq</tt> on a list is backward compared to <tt class="calibre11">seq</tt> on a vector, and in rare cases this can point to one or the other as the best solution. In the end, it may come down primarily to personal taste. </p><p id="filepos387801" class="calibre5"><span class="bold">5.3.3. What lists aren’t </span><a></a></p><p class="calibre7">Probably the most common misuse of lists is to hold items that will be looked up by index. Though you can use <tt class="calibre11">nth</tt> to get the 42nd (or any other) item from a list, Clojure will have to walk the list from the beginning to find it. Don’t do that. In fact, this is a practical reason why lists can’t be used as functions, as in <tt class="calibre11">((list :a) 0)</tt>. Vectors are good at looking things up by index, so use one of those instead. </p><p class="calibre5">Lists are also not sets. All the reasons we gave in the previous section for why it’s a bad idea to frequently search a vector looking for a particular value apply to lists as well. Even moreso since <tt class="calibre11">contains?</tt> will <span class="italic">always</span> return false for a list. See the section on sets later in this chapter instead. </p><p class="calibre5">Finally, lists aren’t queues. You can add items to one end of a list, but you can’t remove things from the other end. So what should you use when you need a queue? Funny you should ask... </p><p id="filepos388921" class="calibre5"><span class="calibre18"><span class="bold">5.4. How to use persistent queues </span></span></p><p class="calibre7">We mentioned in <a href="#filepos353970"><span class="calibre8"><span class="underline">section 5.2</span></span></a> that new Clojure developers often attempt to implement simple queues using vectors. Though this is possible, such an implementation leaves much to be desired. Instead, Clojure provides a persistent immutable queue that will serve all your queueing needs. In this section we’ll touch on the usage of the <tt class="calibre11">PersistentQueue</tt> class, where its first-in-first-out (FIFO) queueing discipline (<a href="#filepos1076672"><span class="calibre8"><span class="underline">Knuth 1997</span></span></a>) is described by <tt class="calibre11">conj</tt> adding to the rear, <tt class="calibre11">pop</tt> removing from the front, and <tt class="calibre11">peek</tt> returning the front element without removal. </p><p class="calibre5">Before going further, it’s important to point out that Clojure’s <tt class="calibre11">PersistentQueue</tt> is a collection, not a workflow mechanism. Java has classes deriving from the <tt class="calibre11">java.util.concurrent.BlockingQueue</tt> interface for workflow, which often are useful in Clojure programs, and those aren’t these. If you find yourself wanting to <a id="filepos390122"></a>repeatedly check a work queue to see if there’s an item of work to be popped off, or if you want to use a queue to send a task to another thread, you do <span class="italic">not</span> want the <tt class="calibre11">PersistentQueue</tt> discussed in this section. </p><p id="filepos390360" class="calibre5"><span class="bold">5.4.1. A queue about nothing </span><a></a></p><p class="calibre7">Search all you like, but the current implementation of Clojure doesn’t provide<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos391180"><span class="calibre33"><span class="calibre8"><span class="underline">9</span></span></span></a><span class="calibre33">]</span></small></sup> a core construction function for creating persistent queues. That being the case, how would you go about creating a queue? The answer is that there’s a readily available empty queue instance to use, <tt class="calibre11">clojure.lang.PersistentQueue/EMPTY</tt>. The printed representation for Clojure’s queues isn’t incredibly informative, but you can change that by providing a method for them on the <tt class="calibre11">print-method</tt> multimethod, as shown: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos391180" class="calibre32"><span class="calibre33">9</span></small></sup><span class="calibre10"> The Clojure core language grows carefully, tending to incorporate only features that have proven useful. Queues currently stand at the edge of this growth, meaning that there might be more support for them in the future. Unlike the other collections in this chapter, the code you write with queues might be rendered nonidiomatic by future improvements. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defmethod print-method clojure.lang.PersistentQueue<br class="calibre3"/>  [q, w]<br class="calibre3"/>  (print-method '&lt;- w) (print-method (seq q) w) (print-method '-&lt; w))<br class="calibre3"/><br class="calibre3"/>clojure.lang.PersistentQueue/EMPTY<br class="calibre3"/>;=&gt; &gt;-nil-&gt;</tt></span></blockquote><p class="calibre12">Using <tt class="calibre11">print-method</tt> in this way is a convenient mechanism for printing types in logical ways, as we did earlier with the queue-fish that’s not only fun, but indicates an direction of flow for <tt class="calibre11">conj</tt> and <tt class="calibre11">pop</tt>. </p><p class="calibre5">You might think that popping an empty queue would raise an exception, but the fact is that this action results in just another empty queue. Likewise, peeking an empty queue will return <tt class="calibre11">nil</tt>. Not breathtaking for sure, but this behavior helps to ensure that queues work in place of other sequences. In fact, the functions <tt class="calibre11">first</tt>, <tt class="calibre11">rest</tt>, and <tt class="calibre11">next</tt> also work on queues and give the results that you might expect, though <tt class="calibre11">rest</tt> and <tt class="calibre11">next</tt> return seqs not queues. Therefore, if you’re using a queue as a queue, it’s best to use the functions designed for this purpose: <tt class="calibre11">peek</tt>, <tt class="calibre11">pop</tt>, and <tt class="calibre11">conj</tt>. </p><p id="filepos392907" class="calibre5"><span class="bold">5.4.2. Putting things on </span><a></a></p><p class="calibre7">The mechanism for adding elements to a queue is <tt class="calibre11">conj</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def schedule<br class="calibre3"/>  (conj clojure.lang.PersistentQueue/EMPTY<br class="calibre3"/>        :wake-up :shower :brush-teeth))<br class="calibre3"/>;=&gt; &lt;-(:wake-up :shower :brush-teeth)-&lt;</tt></span></blockquote><p class="calibre12">Clojure’s persistent queue is implemented internally using two separate collections, the front being a seq and the rear being a vector, as shown in <a href="#filepos393595"><span class="calibre8"><span class="underline">Figure 5.3</span></span></a>. </p><p id="filepos393595" class="calibre5"><span class="calibre10"><span class="bold">Figure 5.3. The two collections used internally in a single queue. </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">peek</span></tt></span><span class="calibre10"><span class="bold"> returns the front item of the seq, </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">pop</span></tt></span><span class="calibre10"><span class="bold"> returns a new queue with the front of the seq left off, and </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">conj</span></tt></span><span class="calibre10"><span class="bold"> adds a new item to the back of the vector. </span></span></p><p class="calibre1"><img src="images/00092.jpg" class="calibre53"/></p><p class="calibre5">All insertions occur in the rear vector and all removals occur in the front seq, taking advantage of each collection’s strength. When all the items from the front list have <a id="filepos394403"></a>been popped, the back vector is wrapped in a seq to become the new front, and an empty vector is used as the new back. Typically, an immutable queue such as this is implemented with the rear as a list in reverse order, because insertion to the front of a list is an efficient operation. But using a Clojure vector eliminates the need for a reversed list. </p><p id="filepos394769" class="calibre5"><span class="bold">5.4.3. Getting things </span><a></a></p><p class="calibre7">Clojure provides the <tt class="calibre11">peek</tt> function to get the front element in a queue: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(peek schedule)<br class="calibre3"/>;=&gt; :wake-up</tt></span></blockquote><p class="calibre12">The fact that performing <tt class="calibre11">peek</tt> doesn’t modify the contents of a persistent queue should be no surprise by now. </p><p id="filepos395227" class="calibre5"><span class="bold">5.4.4. Taking things off </span><a></a></p><p class="calibre7">To “remove” elements from the front of a queue, use the <tt class="calibre11">pop</tt> function and not <tt class="calibre11">rest</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(pop schedule)<br class="calibre3"/>;=&gt; &lt;-(:shower :brush-teeth)-&lt;<br class="calibre3"/><br class="calibre3"/>(rest schedule)<br class="calibre3"/>;=&gt; (:shower :brush-teeth)</tt></span></blockquote><p class="calibre12">Although <tt class="calibre11">rest</tt> returns something with the same values and even prints the same as what <tt class="calibre11">pop</tt> returns, the former is a seq not a queue. This is potentially the source of subtle bugs, because subsequent attempts to use <tt class="calibre11">conj</tt> on it won’t preserve the speed guarantees of the queue type and the queue functions <tt class="calibre11">pop peek</tt> and <tt class="calibre11">conj</tt> won’t behave as expected. </p><p class="calibre5">We’ve talked numerous times in this chapter about the sequence abstraction, and though it’s an important consideration, it shouldn’t <span class="italic">always</span> be used. Instead, it’s important to know your data structures, their sweet spots, and idiomatic operations. By doing so, you can write code that’s specialized in ways that leverage the performance characteristics you need for a given problem space. Clojure’s persistent queues illustrate this fact perfectly. To further highlight this point, we’ll now explore Clojure’s set type. </p><p id="filepos396660" class="calibre5"><span class="calibre18"><span class="bold">5.5. Persistent sets </span></span></p><p id="filepos396742" class="calibre7">Clojure sets work the same as mathematical sets, in that they’re collections of unsorted unique elements. In this section we’ll cover sets by explaining their strong points, weaknesses, and idioms. We’ll also cover some of the functions from the <tt class="calibre11">clojure.set</tt> namespace. </p><p id="filepos397059" class="calibre5"><span class="bold">5.5.1. Basic properties of Clojure sets </span><a></a></p><p class="calibre7">Sets are functions of their elements that return the matched element or <tt class="calibre11">nil</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(#{:a :b :c :d} :c)<br class="calibre3"/>;=&gt; :c<br class="calibre3"/><br class="calibre3"/>(#{:a :b :c :d} :e)<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p class="calibre12">Set elements can be accessed via the <tt class="calibre11">get</tt> function, which will return the queried value if it exists in the given set: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(get #{:a 1 :b 2} :b)<br class="calibre3"/>;=&gt; :b<br class="calibre3"/><br class="calibre3"/>(get #{:a 1 :b 2} :nothing-doing)<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p class="calibre12">As a final point, sets, like all of Clojure’s collections, support heterogeneous values.</p><p class="calibre5"><span class="calibre10"><span class="bold">How Clojure Populates Sets </span></span></p><p class="calibre7">The key to understanding how Clojure sets determine which elements are discrete lies in one simple statement. Given two elements evaluating as equal, a set will contain only one, independent of concrete types: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">#{[] ()}<br class="calibre3"/>;=&gt; #{[]}<br class="calibre3"/><br class="calibre3"/>#{[1 2] (1 2)}<br class="calibre3"/>;=&gt; #{[1 2]}<br class="calibre3"/><br class="calibre3"/>#{[] () #{} {}}<br class="calibre3"/>;=&gt; #{#{} {} []}</tt></span></blockquote><p class="calibre12">From the first two examples, even though <tt class="calibre11">[]</tt> and <tt class="calibre11">()</tt> are of differing types, they’re considered equal because their elements are equal or in this case empty. But the last example illustrates nicely that collections within an equality partition will always be equal if their elements are equal, but never across partitions. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">Finding items in a sequence using a set and some</span>
</p><p class="calibre7">This property of sets combines with the <tt class="calibre11">some</tt> function to provide an extremely useful idiom for searching a seq for any of multiple items. The <tt class="calibre11">some</tt> function takes a predicate and a sequence. It applies said predicate to each element in turn, returning the first truthy value returned by the predicate or else <tt class="calibre11">nil</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(some #{:b} [:a 1 :b 2])<br class="calibre3"/>;=&gt; :b<br class="calibre3"/><br class="calibre3"/>(some #{1 :b} [:a 1 :b 2])<br class="calibre3"/>;=&gt; 1</tt></span></blockquote><p class="calibre12">Using a set as the predicate supplied to <tt class="calibre11">some</tt> allows you to check whether <span class="italic">any</span> of the truthy values in the set are contained within the given sequence. <span class="italic">This is a frequently used Clojure idiom for searching for containment within a sequence.</span></p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p id="filepos400052" class="calibre35"><span class="bold">5.5.2. Keeping your sets in order with sorted-set </span><a></a></p><p class="calibre7">There’s not much to say about creating sorted sets with the <tt class="calibre11">sorted-set</tt> function. But there’s a simple rule that you should bear in mind: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(sorted-set :b :c :a)<br class="calibre3"/>;=&gt; #{:a :b :c}<br class="calibre3"/><br class="calibre3"/>(sorted-set [3 4] [1 2])<br class="calibre3"/>;=&gt; #{[1 2] [3 4]}<br class="calibre3"/><br class="calibre3"/>(sorted-set :b 2 :c :a 3 1)<br class="calibre3"/>; java.lang.ClassCastException: clojure.lang.Keyword cannot be cast to<br class="calibre3"/>     java.lang.Number</tt></span></blockquote><p id="filepos400718" class="calibre12">As long as the arguments to the <tt class="calibre11">sorted-set</tt> function are mutually comparable, you’ll receive a sorted set; otherwise an exception is thrown. This can manifest itself when dealing with sorted sets down stream from their point of creation, leading to potential confusion: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def my-set (sorted-set :a :b))<br class="calibre3"/><br class="calibre3"/>;; ... some time later<br class="calibre3"/>(conj my-set "a")<br class="calibre3"/>;=&gt; java.lang.ClassCastException: clojure.lang.Keyword cannot be cast to<br class="calibre3"/>     java.lang.String</tt></span></blockquote><p class="calibre12">The difficulty in finding the reason for this exception will increase as the distance between the creation of <tt class="calibre11">my-set</tt> and the call to <tt class="calibre11">conj</tt> increases. You can adjust this rule a bit by using <tt class="calibre11">sorted-set-by</tt> instead, and providing your own comparator. This works exactly like the comparator for <tt class="calibre11">sorted-map-by</tt>, which we’ll cover in section 6.6.2. Sorted maps and sorted sets are also similar in their support of <tt class="calibre11">subseq</tt> to allow efficiently jumping to a particular key in the collection, and walking through it from there. This is covered in <a href="#filepos408333"><span class="calibre8"><span class="underline">section 5.6</span></span></a>. </p><p id="filepos402031" class="calibre5"><span class="bold">5.5.3. contains? </span><a></a></p><p class="calibre7">As we touched on in <a href="#filepos353970"><span class="calibre8"><span class="underline">section 5.2</span></span></a>, there’s sometimes confusion regarding the usage of Clojure’s <tt class="calibre11">contains?</tt> function. Many newcomers to Clojure expect this function to work the same as Java’s <tt class="calibre11">java.util.Collection#contains</tt> method; this assumption is false, as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(contains? #{1 2 4 3} 4)<br class="calibre3"/>;=&gt; true<br class="calibre3"/><br class="calibre3"/>(contains? [1 2 4 3] 4)<br class="calibre3"/>;=&gt; false</tt></span></blockquote><p class="calibre12">If you were to draw a false analogy between Java’s <tt class="calibre11">.contains</tt> methods and <tt class="calibre11">contains?</tt>, then both of the function calls noted here should’ve returned true. The official documentation for <tt class="calibre11">contains?</tt> describes it as a function that returns true if a given <span class="italic">key</span> exists within a collection. When reading the word <span class="italic">key</span>, the notion of a map springs to mind, but the fact that this function also works on sets hints at their implementation details. Sets are implemented as maps with the same element as the key <span class="italic">and</span> value,<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos403529"><span class="calibre33"><span class="calibre8"><span class="underline">10</span></span></span></a><span class="calibre33">]</span></small></sup> but there’s an additional check for containment before insertion. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos403529" class="calibre32"><span class="calibre33">10</span></small></sup><span class="calibre10"> All implementation caveats apply. </span></blockquote><p id="filepos403644" class="calibre35"><span class="bold">5.5.4. clojure.set </span><a></a></p><p id="filepos403710" class="calibre7">Mathematical sets form the basis of much of modern mathematical thought, and Clojure’s basic set functions in the <tt class="calibre11">clojure.set</tt> namespace are a clear reflection of the classical set operations. In this subsection we’ll briefly cover each function and talk about how, when applicable, they differ from the mathematical model. First, we’ll start with a simple picture. </p><p class="calibre5"><a href="#filepos404423"><span class="calibre8"><span class="underline">Figure 5.4</span></span></a> describes the nature of Clojure’s set functions, each of which will be shown presently. Note that Clojure’s set functions take an arbitrary number of sets and apply the operation incrementally. </p><p id="filepos404423" class="calibre5"><span class="calibre10"><span class="bold">Figure 5.4. Basic set operations. The three Venn diagrams show a graphical representation of Clojure’s set functions: intersection, union, and difference. </span></span><a></a></p><p class="calibre1"><img src="images/00103.jpg" class="calibre54"/></p><p class="calibre5"><span class="calibre10"><span class="bold">Intersection </span></span></p><p class="calibre7">Clojure’s <tt class="calibre11">clojure.set/intersection</tt> function works as you might expect. Given two sets, <tt class="calibre11">intersection</tt> returns a set of the common elements. Given <tt class="calibre11">n</tt> sets, it’ll incrementally return the intersection of resulting sets and the next set, as seen in the following code: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(clojure.set/intersection #{:humans :fruit-bats :zombies}<br class="calibre3"/>                          #{:chupacabra :zombies :humans})<br class="calibre3"/>;=&gt; #{:zombies :humans}<br class="calibre3"/><br class="calibre3"/>(clojure.set/intersection #{:pez :gum :dots :skor}<br class="calibre3"/>                          #{:pez :skor :pocky}<br class="calibre3"/>                          #{:pocky :gum :skor})<br class="calibre3"/>;=&gt; #{:skor}</tt></span></blockquote><p class="calibre12">In the first example, the resulting set is simply the common elements between the given sets. The second example is the result of the intersection of the first two sets then intersected with the final set. </p><p class="calibre5"><span class="calibre10"><span class="bold">Union </span></span></p><p class="calibre7">There’s also likely no surprise when using the <tt class="calibre11">clojure.set/union</tt> function: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(clojure.set/union #{:humans :fruit-bats :zombies}<br class="calibre3"/>                   #{:chupacabra :zombies :humans})<br class="calibre3"/>;=&gt; #{:chupacabra :fruit-bats :zombies :humans}<br class="calibre3"/><br class="calibre3"/>(clojure.set/union #{:pez :gum :dots :skor}<br class="calibre3"/>                   #{:pez :skor :pocky}<br class="calibre3"/>                   #{:pocky :gum :skor})<br class="calibre3"/>;=&gt; #{:pez :pocky :gum :skor :dots}</tt></span></blockquote><p id="filepos406662" class="calibre12">Given two sets, the resulting set will contain all of the distinct elements from both. In the first example this means <tt class="calibre11">:zombies</tt> and <tt class="calibre11">:humans</tt> only show up once each in the return value. Note in the second example that more than two sets may be given to <tt class="calibre11">union</tt>, but as expected each value given in any of the input sets is included exactly once in the output set. </p><p class="calibre5"><span class="calibre10"><span class="bold">Difference </span></span></p><p class="calibre7">The only set function that could potentially cause confusion on first glance is <tt class="calibre11">clojure.set/difference</tt>, which by name implies some sort of opposition to a union operation. Working under this false assumption you might assume that <tt class="calibre11">difference</tt> would operate thusly: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(clojure.set/difference #{1 2 3 4} #{3 4 5 6})<br class="calibre3"/>;=&gt; #{1 2 5 6}</tt></span></blockquote><p class="calibre12">But if you were to evaluate this expression in your REPL, you’d receive a very different result:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(clojure.set/difference #{1 2 3 4} #{3 4 5 6})<br class="calibre3"/>;=&gt; #{1 2}</tt></span></blockquote><p class="calibre12">The reason for this result is that Clojure’s <tt class="calibre11">difference</tt> function calculates what’s known as a <span class="italic">relative complement</span> (<a href="#filepos1082195"><span class="calibre8"><span class="underline">Stewart 1995</span></span></a>) between two sets. In other words, <tt class="calibre11">difference</tt> can be viewed as a set subtraction function “removing” all elements in a set A that are also in another set B. </p><p id="filepos408333" class="calibre5"><span class="calibre18"><span class="bold">5.6. Thinking in maps </span></span></p><p class="calibre7">It’s difficult to write a program of any significant size without the need for a map of some sort. The use of maps is ubiquitous in writing software because frankly it’s difficult to imagine a more robust data structure. But we as programmers tend to view maps as a special case structure outside of the normal realm of data objects and classes. The object-oriented school of thought has relegated the map as a supporting player in favor of the class. We’re not going to talk about the merits, or lack thereof, for this relegation here, but in upcoming sections we’ll discuss moving away from thinking in classes and instead thinking in the sequence abstraction, maps, protocols, and types. Having said all of that, it need hardly be mentioned that maps should be used to store named values. In this section we talk about the different types of maps and the tradeoffs surrounding each. </p><p id="filepos409343" class="calibre5"><span class="bold">5.6.1. Hash maps </span><a></a></p><p class="calibre7">Arguably, the most ubiquitous<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos410036"><span class="calibre33"><span class="calibre8"><span class="underline">11</span></span></span></a><span class="calibre33">]</span></small></sup> form of map found in Clojure programs is the hash map, which provides an unsorted key/value associative structure. In addition to the literal syntax touched on in <a href="#filepos163683"><span class="calibre8"><span class="underline">chapter 2</span></span></a>, hash maps can be created using the <tt class="calibre11">hash-map</tt> function, which likewise takes alternating key/value pairs, with or without commas: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos410036" class="calibre32"><span class="calibre33">11</span></small></sup><span class="calibre10"> Although with the pervasiveness of the map literal, the ubiquity may instead fall to the array map. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(hash-map :a 1, :b 2, :c 3, :d 4, :e 5)<br class="calibre3"/>;=&gt; {:a 1, :c 3, :b 2, :d 4, :e 5}</tt></span></blockquote><p id="filepos410404" class="calibre12">Clojure hash maps support heterogeneous keys, meaning that they can be of any type and each key can be of a differing type, as this code shows: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(let [m {:a 1, 1 :b, [1 2 3] "4 5 6"}]<br class="calibre3"/>  [(get m :a) (get m [1 2 3])])<br class="calibre3"/>;=&gt; [1 "4 5 6"]</tt></span></blockquote><p class="calibre12">As we previously mentioned at the beginning of this chapter, many of Clojure’s composite types can be used as functions, and in the case of maps they’re functions of their keys. Using maps in this way will act the same as the use of the <tt class="calibre11">get</tt> function in the previous code sample, as shown when building a vector of two elements: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(let [m {:a 1, 1 :b, [1 2 3] "4 5 6"}]<br class="calibre3"/>  [(m :a) (m [1 2 3])])<br class="calibre3"/>;=&gt; [1 "4 5 6"]</tt></span></blockquote><p class="calibre12">Providing a map to the <tt class="calibre11">seq</tt> function will return a sequence of map entries: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(seq {:a 1, :b 2})<br class="calibre3"/>;=&gt; ([:a 1] [:b 2])</tt></span></blockquote><p class="calibre12">Of course, this sequence appears to be composed of the sets of key/value pairs contained in vectors, and for all practical purposes should be treated as such. In fact, a new hash map can be created idiomatically using this precise structure: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(into {} [[:a 1] [:b 2]])<br class="calibre3"/>;=&gt; {:a 1, :b 2}</tt></span></blockquote><p class="calibre12">Even if your embedded pairs aren’t vectors, they can be made to be for building a new map:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(into {} (map vec '[(:a 1) (:b 2)]))<br class="calibre3"/>;=&gt; {:a 1, :b 2}</tt></span></blockquote><p class="calibre12">In fact, your pairs don’t have to be explicitly grouped, because you can use <tt class="calibre11">apply</tt> to create a hash map given that the key/value pairs are laid out in a sequence consecutively: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(apply hash-map [:a 1 :b 2])<br class="calibre3"/>;=&gt; {:a 1, :b 2}</tt></span></blockquote><p class="calibre12">You can also use <tt class="calibre11">apply</tt> in this way with <tt class="calibre11">sorted-map</tt> and <tt class="calibre11">array-map</tt>. Another idiomatic way to build a map is to use <tt class="calibre11">zipmap</tt> to “zip” together two sequences, the first of which contains the desired keys and the second their corresponding values: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(zipmap [:a :b] [1 2])<br class="calibre3"/>;=&gt; {:b 2, :a 1}</tt></span></blockquote><p class="calibre12">The use of <tt class="calibre11">zipmap</tt> illustrates nicely the final property of map collections. Hash maps in Clojure have no order guarantees. If you do require ordering, then you should use sorted maps, discussed next. </p><p id="filepos413381" class="calibre5"><span class="bold">5.6.2. Keeping your keys in order with sorted maps </span><a></a></p><p id="filepos413478" class="calibre7">It’s impossible to rely on a specific ordering of the key/value pairs for a standard Clojure map, because there are no order guarantees at all. Using the <tt class="calibre11">sorted-map</tt> and <tt class="calibre11">sorted-map-by</tt> functions, you can construct maps with order assurances. By default, the function <tt class="calibre11">sorted-map</tt> will build a map sorted by the comparison of its keys: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(sorted-map :thx 1138 :r2d 2)<br class="calibre3"/>;=&gt; {:r2d 2, :thx 1138}</tt></span></blockquote><p class="calibre12">You may require an alternative key ordering, or perhaps an ordering for keys that isn’t easily comparable. In these cases you must use <tt class="calibre11">sorted-map-by</tt>, which takes an additional comparison function:<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos414461"><span class="calibre33"><span class="calibre8"><span class="underline">12</span></span></span></a><span class="calibre33">]</span></small></sup></p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos414461" class="calibre32"><span class="calibre33">12</span></small></sup><span class="calibre10"> Note that simple boolean functions like </span><span class="calibre10"><tt class="calibre11">&gt;</tt></span><span class="calibre10"> can be used as comparison functions. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(sorted-map "bac" 2 "abc" 9)<br class="calibre3"/>;=&gt; {"abc" 9, "bac" 2}<br class="calibre3"/><br class="calibre3"/>(sorted-map-by #(compare (subs %1 1) (subs %2 1)) "bac" 2 "abc" 9)<br class="calibre3"/>;=&gt; {"bac" 2, "abc" 9}</tt></span></blockquote><p class="calibre12">This means that sorted maps don’t generally support heterogeneous keys the same as hash maps, although it depends on the comparison function provided. For example, the preceding one assumes all keys are strings. The default sorted-map comparison function <tt class="calibre11">compare</tt> supports maps whose keys are all mutually comparable with each other. Attempts to use keys that aren’t supported by whichever comparison function you’re using will generally result in a cast exception: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(sorted-map :a 1, "b" 2)<br class="calibre3"/>;=&gt; java.lang.ClassCastException: clojure.lang.Keyword cannot be cast to<br class="calibre3"/>        java.lang.String</tt></span></blockquote><p class="calibre12">One remarkable feature supported by sorted maps (and also sorted sets) is the ability to jump efficiently to a particular key and walk forward or backward from there through the collection. This is done with the <tt class="calibre11">subseq</tt> and <tt class="calibre11">rsubseq</tt> functions for forward and backward respectively. Even if you don’t know the exact key you want, these functions can be used to “round up” the next closest key that exists. </p><p class="calibre5">Another way that sorted maps and hash maps differ is in their handling of numeric keys. A number of a given magnitude can be represented by many different types; for example <tt class="calibre11">42</tt> can be a long, int, float, and so on. Hash maps would treat each of these different objects as <span class="italic">different</span>, whereas a sorted map would treat them as the same. You can see the contrast in this example, where the hash map keeps both keys while the sorted map keeps just one: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(assoc {1 :int} 1.0 :float)<br class="calibre3"/>;=&gt; {1.0 :float, 1 :int}<br class="calibre3"/><br class="calibre3"/>(assoc (sorted-map 1 :int) 1.0 :float)<br class="calibre3"/>;=&gt; {1 :float}</tt></span></blockquote><p id="filepos416912" class="calibre12">This is because the comparison function used by the sorted map not only determines order by equality, and if two keys compare as equal, only one will be kept. This applies to comparison functions provided to <tt class="calibre11">sorted-map-by</tt> as well as the default comparator shown previously. </p><p class="calibre5">Sorted maps will otherwise work just like hash maps and can be used interchangeably. You should use sorted maps if you need to specify or guarantee a specific key ordering. On the other hand, if you need to maintain insertion ordering, then the use of array maps is required as you’ll see. </p><p id="filepos417552" class="calibre5"><span class="bold">5.6.3. Keeping your insertions in order with array maps </span><a></a></p><p class="calibre7">If you hope to perform an action under the assumption that a given map is insertion-ordered, then you’re setting yourself up for disappointment. But you might already know that Clojure provides a special map that ensures insertion ordering called an array map: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(seq (hash-map :a 1, :b 2, :c 3))<br class="calibre3"/>;=&gt; ([:a 1] [:c 3] [:b 2])<br class="calibre3"/><br class="calibre3"/>(seq (array-map :a 1, :b 2, :c 3))<br class="calibre3"/>;=&gt; ([:a 1] [:b 2] [:c 3])</tt></span></blockquote><p class="calibre12">So when insertion order is important, you should explicitly use an array map. Array maps can be populated quickly by ignoring the form of the key/value pairs and blindly copying them into place. For structures sized below a certain count, the cost associated with map lookup bridges the gap between a linear search through an equally sized array or list. That’s not to say that the map will be slower; instead, it allows the map and linear implementations to be comparable. Sometimes your best choice for a map is not a map at all, and like most things in life there are tradeoffs. Thankfully, Clojure takes care of these considerations for you by adjusting the concrete implementations behind the scenes as the size of the map increases. The precise types in play aren’t important, because Clojure is careful to document its promises and to leave undefined aspects subject to change and/or improvement. It’s usually a bad idea to build your programs around concrete types, and always bad to build around undocumented behaviors. <span class="italic">Clojure handles the underlying efficiency considerations so you don’t have to</span>. But be aware that if ordering is important, you should avoid operations that inadvertently change the underlying map implementation from an array map. </p><p class="calibre5">We’ve covered the basics of Clojure maps in this section, including common usage and construction techniques. Clojure maps, minus some implementation details, shouldn’t be surprising to anyone. It’ll take a while to grow accustomed to dealing with immutable maps, but in time even this nuance will become second nature. </p><p class="calibre5">Now that we’ve looked at Clojure’s primary collection types and their differences in detail, we’ll take some time to work through a simple case study. This case study, creating a function named <tt class="calibre11">pos</tt>, will illustrate the thought processes you might consider on your way toward designing an API built on the principles of the sequence abstraction. </p><p id="filepos420275" class="calibre5"><span class="calibre18"><span class="bold">5.7. Putting it all together: finding the position of items in a sequence </span></span></p><blockquote id="filepos420410" class="calibre9"><span class="italic">We sometimes underestimate the influence of little things.</span></blockquote><blockquote class="calibre25"><span class="italic">Charles W. Chesnutt</span></blockquote><p class="calibre5">The case study for this chapter will be to design and implement a simple function to locate the positional index<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos421326"><span class="calibre33"><span class="calibre8"><span class="underline">13</span></span></span></a><span class="calibre33">]</span></small></sup> of an element within a sequence. We’re going to pool together much of the knowledge that you’ve gained in this chapter in order to illustrate the steps you might take in designing, writing, and ultimately optimizing a Clojure collection function. Of course, we’re going to work against the sequence abstraction and will therefore design the solution accordingly. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos421326" class="calibre32"><span class="calibre33">13</span></small></sup><span class="calibre10"> Stuart Halloway describes a similar function </span><span class="calibre10"><tt class="calibre11">index-of-any</tt></span><span class="calibre10"> in his book </span><span class="calibre10"><span class="italic">Programming Clojure</span></span><span class="calibre10"> that views the problem largely through the lens of reduced complexity. We like his example and this one because it’s simple yet powerful and nicely illustrative of the way that Clojure functions should be written. </span></blockquote><p class="calibre12">The function, named <tt class="calibre11">pos</tt>, <span class="italic">must</span></p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24">Work on any composite type returning indices corresponding to some value</li><li value="2" class="calibre24">Return a numerical index for sequential collections or associated key for maps and sets</li><li value="3" class="calibre24">Otherwise return <tt class="calibre11">nil</tt></li></ul><p id="filepos422260" class="calibre5"><span class="bold">5.7.1. Implementation </span><a></a></p><p class="calibre7">If we were to address each of the requirements for <tt class="calibre11">pos</tt> literally and directly, we might come up with a function that looks like the following listing. </p><p id="filepos422521" class="calibre5"><span class="calibre10"><span class="bold">Listing 5.2. First cut at our position function </span></span><a></a></p><p class="calibre1"><img src="images/00030.jpg" class="calibre55"/></p><p id="filepos422754" class="calibre5">Pretty hideous right? We think so too. Apart from being overly complicated, it’d likely be more useful if we instead returned a sequence of <span class="italic">all</span> the indices matching the item, so we’ll add that to the requirements. But we’ve built a heavy load with the first cut at <tt class="calibre11">pos</tt> and should probably step back a moment to reflect. First of all, it’s probably the wrong approach to handle map types and other sequence types differently. The use of the predicate <tt class="calibre11">map?</tt> to detect the type of the passed collection is incredibly constraining, in that it forces different collections to be processed differently. That’s not to say that the use of type-based predicates is strictly prohibited, only that you should try to favor more generic algorithms or at least to minimize their usage. </p><p class="calibre5">As chance has it, the exact nature of the problem demands that we view collections as a set of values paired with a given index, be it explicit in the case of maps or implicit in the case of other sequences’ positional information. Therefore, imagine how easy this problem would be if all collections were laid out as a sequence of pairs <tt class="calibre11">([index1 value1] [index2 value2] ... [indexn valuen])</tt>. Well, there’s no reason why they couldn’t, as shown next. </p><p id="filepos424090" class="calibre5"><span class="calibre10"><span class="bold">Listing 5.3. An index function </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn index [coll]<br class="calibre3"/>  (cond<br class="calibre3"/>    (map? coll) (seq coll)<br class="calibre3"/>    (set? coll) (map vector coll coll)<br class="calibre3"/>    :else (map vector (iterate inc 0) coll)))</tt></span></blockquote><p class="calibre12">This simple function<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos424785"><span class="calibre33"><span class="calibre8"><span class="underline">14</span></span></span></a><span class="calibre33">]</span></small></sup> can generate a uniform representation for indexed collections: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos424785" class="calibre32"><span class="calibre33">14</span></small></sup><span class="calibre10"> Clojure has a core function </span><span class="calibre10"><tt class="calibre11">keep-indexed</tt></span><span class="calibre10"> that works similarly but doesn’t implicitly build indices along equality partitions. For a vector, you could build the index as </span><span class="calibre10"><tt class="calibre11">(keep-indexed #(-&gt; [% %2]) [:a :b :c :d])</tt></span><span class="calibre10">. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(index [:a 1 :b 2 :c 3 :d 4])<br class="calibre3"/>;=&gt; ([0 :a] [1 1] [2 :b] [3 2] [4 :c] [5 3] [6 :d] [7 4])<br class="calibre3"/><br class="calibre3"/>(index {:a 1 :b 2 :c 3 :d 4})<br class="calibre3"/>;=&gt; ([:a 1] [:b 2] [:c 3] [:d 4])<br class="calibre3"/><br class="calibre3"/>(index #{:a 1 :b 2 :c 3 :d 4})<br class="calibre3"/>;=&gt; ([1 1] [2 2] [3 3] [4 4] [:a :a] [:c :c] [:b :b] [:d :d])</tt></span></blockquote><p class="calibre12">As shown, we’re still using type-based predicates, but we’ve raised the level of abstraction to the equality partitions in order to build contextually relevant indices. Now, the function for finding the positional indices for the desired value is trivial: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn pos [e coll]<br class="calibre3"/>  (for [[i v] (index coll) :when (= e v)] i))<br class="calibre3"/><br class="calibre3"/>(pos 3 [:a 1 :b 2 :c 3 :d 4])<br class="calibre3"/>;=&gt; (5)<br class="calibre3"/>(pos 3 {:a 1, :b 2, :c 3, :d 4})<br class="calibre3"/>;=&gt; (:c)<br class="calibre3"/>(pos 3 [:a 3 :b 3 :c 3 :d 4])<br class="calibre3"/>;=&gt; (1 3 5)<br class="calibre3"/>(pos 3 {:a 3, :b 3, :c 3, :d 4})<br class="calibre3"/>;=&gt; (:a :c :b)</tt></span></blockquote><p id="filepos426405" class="calibre12">Much better! But there’s one more deficiency with the <tt class="calibre11">pos</tt> function from a Clojure perspective. Typically in Clojure it’s more useful to pass a predicate function in cases such as these, so that instead of <tt class="calibre11">pos</tt> determining raw equality, it can build its result along any dimension, as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(pos #{3 4} {:a 1 :b 2 :c 3 :d 4})<br class="calibre3"/>;=&gt; (:c :d)<br class="calibre3"/><br class="calibre3"/>(pos even? [2 3 6 7])<br class="calibre3"/>;=&gt; (0 2)</tt></span></blockquote><p class="calibre12">We can modify <tt class="calibre11">pos</tt> only slightly to achieve the ideal level of flexibility, as shown next. </p><p id="filepos427099" class="calibre5"><span class="calibre10"><span class="bold">Listing 5.4. Our final version of pos </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn pos [pred coll]<br class="calibre3"/> (for [[i v] (index coll) :when (pred v)] i))</tt></span></blockquote><p class="calibre12">We’ve vastly simplified the original solution and generated two potentially useful functions (<a href="#filepos1077918"><span class="calibre8"><span class="underline">Martin 2002</span></span></a>) in the process. By following some simple Clojure principles, we were able to solve the original problem statement in a concise and elegant manner. </p><p id="filepos427722" class="calibre5"><span class="calibre18"><span class="bold">5.8. Summary </span></span></p><p class="calibre7">Clojure favors simplicity in the face of growing software complexity. If problems are easily solved by collection abstractions then those abstractions should be used. Most problems can be modeled on such simple types, yet we continue to build monolithic class hierarchies in a fruitless race toward mirroring the “real world”—whatever that means. Perhaps it’s time to realize that we no longer need to layer self-imposed complexities on top of software solutions that are already inherently complex. Not only does Clojure provide the sequential, set, and map types useful for pulling ourselves from the doldrums of software complexity, but it’s also optimized for dealing with them. </p><p class="calibre5">Now that we’ve discussed each of these types in detail, we’re going to take a step back and talk about three important properties of Clojure’s collection types that until now we’ve only touch upon lightly: immutability, persistence, and laziness. </p><div class="mbppagebreak"></div><p id="filepos428825" class="calibre5"><span class="calibre6"><span class="bold">Part 3. Functional programming </span></span><a></a></p><p class="calibre7">In this part of the book, we’ll expose some of the underpinnings of Clojure’s approach to functional programming, as well as some practical uses of it. Clojure provides mechanisms for immutability, deferred execution, closures, and recursion. We’ll show examples of how these can work together to let you create data structures of your own, and find routes through a weighted graph. </p><div class="mbppagebreak"></div><p id="filepos429362" class="calibre5"><span class="calibre6"><span class="bold">Chapter 6. Being lazy and set in your ways </span></span><a></a></p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">This chapter covers</span>
</p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24"><a href="#filepos432784"><span class="calibre8"><span class="underline">Immutability</span></span></a></li><a id="filepos429793"></a><li value="2" class="calibre24"><a href="#filepos438527"><span class="calibre8"><span class="underline">Designing a persistent toy</span></span></a></li><li value="3" class="calibre24"><a href="#filepos449135"><span class="calibre8"><span class="underline">Laziness</span></span></a></li><li value="4" class="calibre24"><a href="#filepos476519"><span class="calibre8"><span class="underline">Putting it all together: a lazy quicksort</span></span></a></li></ul><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">We’ve now reached the apex of imperative knowledge and stand at the precipice leading toward functional programming. We mentioned in <a href="#filepos180747"><span class="calibre8"><span class="underline">section 2.3</span></span></a> that the definitions of functional programming are widely disparate, and unfortunately this book won’t work to unify them. Instead, we’ll start in this chapter to build a basis for Clojure’s style of functional programming by digging into its core supporting maxims. In addition, this chapter covers in greater depth the parts of Clojure’s composite types that we only touched on. </p><p id="filepos430932" class="calibre5"><span class="calibre18"><span class="bold">6.1. On immutability </span></span></p><p class="calibre7">We’ve touched on immutability throughout this book, but we’ve avoided discussing why Clojure has chosen it as a cornerstone principle. Though no panacea, fostering <a id="filepos431211"></a>immutability at the language level solves many difficult problems right out of the box, while simplifying many others. Coming from a language background where mutability interwoven with imperative programming methods reign, it often requires a significant conceptual leap to twist your mind to accept and utilize immutability and functional programming. In this section, we’ll build a conceptual basis for immutability as it relates to Clojure’s underlying philosophy as well as why you should work to foster immutability even when outside the warming confines of Clojure proper. </p><p id="filepos431806" class="calibre5"><span class="bold">6.1.1. Defining immutability </span><a></a></p><p class="calibre7">In many cases, when talking specifically about Clojure’s immutable data structures, we could be talking about the broader category of immutable objects without loss of meaning. But we should probably set down some conditions defining just what’s meant by immutability. </p><p class="calibre5"><span class="calibre10"><span class="bold">Every Day is Like Sunday </span></span></p><p class="calibre7">An entire branch of philosophy named <span class="italic">predestination</span> is devoted to exploring the notion that there’s no such thing as free will, but instead, everything that we are or ever will be is determined beforehand. Though this possibility for our own lives may seem bleak, the notion does nicely encapsulate the first principle of immutability: all of the possible properties of immutable objects are defined at the time of their construction and can’t be changed thereafter. </p><p id="filepos432784" class="calibre5"><span class="calibre10"><span class="bold">Immutability Through Convention </span></span></p><p class="calibre7">Computer systems are in many ways open systems, providing the keys to the vault if you’re so inclined to grab them. But in order to foster an air of immutability in your own systems, it’s important to create a facade of immutability. Creating immutable classes in Java requires a few steps (<a href="#filepos1072867"><span class="calibre8"><span class="underline">Goetz 2006</span></span></a>). First, a class itself and all of its fields should be labeled as <tt class="calibre11">final</tt>. Next, in no way should an object’s <tt class="calibre11">this</tt> reference escape during construction. And finally, any internal mutable objects should originate, either whole-cloth or through a copy, within the class itself and thus never escape. Obviously we’re simplifying, because there are finer details to this recipe for Java immutability, but for now these simplified highlights serve to show that by observing convention, even an inherently mutable language such as Java can be made to be immutable. Clojure directly supports immutability as a language feature<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos434522"><span class="calibre33"><span class="calibre8"><span class="underline">1</span></span></span></a><span class="calibre33">]</span></small></sup> with its core data structures. By providing immutable data structures as a primary language feature, Clojure separates (<a href="#filepos1084620"><span class="calibre8"><span class="underline">Braithwaite 2007</span></span></a>) the complexity of working with immutable structures from the complexities of their implementation. By providing immutability either as a core language feature or through convention, you can reap enormous benefit. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos434522" class="calibre32"><span class="calibre33">1</span></small></sup><span class="calibre10"> We’re intentionally glossing over Clojure’s features that support mutability such as reference types and transients in order to keep this section focused. </span></blockquote><p id="filepos434761" class="calibre35"><span class="bold">6.1.2. Being set in your ways—immutability </span><a></a></p><p id="filepos434853" class="calibre7">Clojure’s immutable data structures aren’t bolted onto the language as an afterthought or as a choice in an a-la-carte menu. Instead, their inclusion in the language runs deep to its philosophical core. </p><p class="calibre5"><span class="calibre10"><span class="bold">Invariants </span></span></p><p class="calibre7">Invariant-based programming involves the definition of constraints on classes and functions in order to provide assurances that if instances enter into certain states, assertion errors will arise. Providing invariants within a mutable system requires a fair amount of assertion weaving within the methods of any given class. But by observing a practice of immutability, invariants are defined solely within the construction mechanism and can never be violated thereafter. </p><p class="calibre5"><span class="calibre10"><span class="bold">Reasoning </span></span></p><p class="calibre7">Because the life of an immutable object is one of predestiny, the matter of reasoning about its possible states is simplified. It follows that the act of testing such a system is simplified, in that the set of possible states and transitions is constrained. </p><p class="calibre5"><span class="calibre10"><span class="bold">Equality has Meaning </span></span></p><p class="calibre7">Equality in the presence of mutability has no meaning. Equality in the face of mutability and concurrency is utter lunacy. If any two objects resolve as being equal now, then there’s no guarantee that they will a moment from now. And if two objects aren’t equal forever, then they’re technically never equal (<a href="#filepos1069088"><span class="calibre8"><span class="underline">Baker 1993</span></span></a>). Providing immutable objects once again assigns meaning to equality, in that if two objects are equal now, then they’ll always be so. </p><p class="calibre5"><span class="calibre10"><span class="bold">Sharing is Cheap </span></span></p><p class="calibre7">If you’re certain that an object will never change, then sharing said object becomes a simple matter of providing a reference to it. In Java, to do so often requires a lot of defensive copying. Along this vein, because we can freely share references for immutable objects, we can likewise intern them for free. </p><p class="calibre5"><span class="calibre10"><span class="bold">Flattening the Levels of Indirection </span></span></p><p class="calibre7">There’s a marked difference between a mutable object and a mutable reference. The default in Java is that there are references that might point to mutable data. But in Clojure, there are only mutable references. This may seem like a minor detail, but it certainly works to reduce unnecessary complexities. </p><p class="calibre5"><span class="calibre10"><span class="bold">Immutability Fosters Concurrent Programming </span></span></p><blockquote class="calibre9"><span class="italic">Immutable objects are always thread safe.</span></blockquote><blockquote class="calibre9"><span class="italic">Java Concurrency in Practice</span></blockquote><blockquote class="calibre25"><span class="italic">Brian Goetz,</span></blockquote><p class="calibre5">If an object can’t change, it can be shared freely between different threads of execution without fear of concurrent modification errors. There can be little debate about this particular point, but that fact doesn’t answer the question of how mutation occurs. Without delving into the specifics, you likely already know that Clojure <a id="filepos438268"></a>isolates mutation to its reference types while the data wrapped with them is left unchanged. We’ll leave this alone for now, becuase we’ll devote <a href="#filepos818901"><span class="calibre8"><span class="underline">chapter 11</span></span></a> to this and related topics. </p><p id="filepos438527" class="calibre5"><span class="calibre18"><span class="bold">6.2. Designing a persistent toy </span></span></p><p class="calibre7">We won’t go into terrible detail about the internals of Clojure’s persistent data structures—we’ll leave that to others (<a href="#filepos1086710"><span class="calibre8"><span class="underline">Krukow 2009</span></span></a>). But we do want to explore the notion of structural sharing. Our example will be highly simplified compared to Clojure’s implementations, but it should help clarify some of the techniques used. </p><p class="calibre5">The simplest shared-structure type is the list. Two different items can be added to the front of the same list, producing two new lists that share their <tt class="calibre11">next</tt> parts. We’ll try this out by creating a base list and then two new lists from that same base: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def baselist (list :barnabas :adam))<br class="calibre3"/>(def lst1 (cons :willie baselist))<br class="calibre3"/>(def lst2 (cons :phoenix baselist))<br class="calibre3"/><br class="calibre3"/>lst1<br class="calibre3"/>;=&gt; (:willie :barnabas :adam)<br class="calibre3"/><br class="calibre3"/>lst2<br class="calibre3"/>;=&gt; (:phoenix :barnabas :adam)</tt></span></blockquote><p class="calibre12">You can think of <tt class="calibre11">baselist</tt> as a historical version of both <tt class="calibre11">lst1</tt> and <tt class="calibre11">lst2</tt>. But it’s also the shared part of both lists. More than being equal, the <tt class="calibre11">next</tt> parts of both lists are <span class="italic">identical</span>—the same instance: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(= (next lst1) (next lst2))<br class="calibre3"/>;=&gt; true<br class="calibre3"/><br class="calibre3"/>(identical? (next lst1) (next lst2))<br class="calibre3"/>;=&gt; true</tt></span></blockquote><p class="calibre12">So that’s not too complicated, right? But the features supported by lists are also limited. Clojure’s vectors and maps also provide structural sharing, while allowing you to change values anywhere in the collection, not just on one end. The key is the structure each of these datatypes uses internally. We’ll now build a simple tree to help demonstrate how a tree can allow interior changes and maintain shared structure at the same time. </p><p class="calibre5">Each node of our tree will have three fields: a value, a left branch, and a right branch. We’ll put them in a map, like this:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">{:val 5, :L nil, :R nil}</tt></span></blockquote><p class="calibre12">That’s the simplest possible tree—a single node holding the value 5, with empty left and right branches. This is exactly the kind of tree we want to return when a single item is added to an empty tree. To represent an empty tree, we’ll use <tt class="calibre11">nil</tt>. With the structure decision made, we can write our own <tt class="calibre11">conj</tt> function <tt class="calibre11">xconj</tt> to build up our tree, starting with just the code for this initial case: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn xconj [t v]<br class="calibre3"/>  (cond<br class="calibre3"/>    (nil? t) {:val v, :L nil, :R nil}))<br class="calibre3"/><br class="calibre3"/>(xconj nil 5)<br class="calibre3"/>;=&gt; {:val 5, :L nil, :R nil}</tt></span></blockquote><p id="filepos441653" class="calibre12">Hey, it works! Not too impressive yet though, so we need to handle the case where an item is being added to a nonempty tree. We keep our tree in order by putting values less than a node’s <tt class="calibre11">:val</tt> in the left branch, and other values in the right branch. That means we need a test like this: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(&lt; v (:val t))</tt></span></blockquote><p class="calibre12">When that’s true, we need the new value <tt class="calibre11">v</tt> to go into the left branch, <tt class="calibre11">(:L t)</tt>. If this were a mutable tree, we’d <span class="italic">change</span> the value of <tt class="calibre11">:L</tt> to be the new node. Instead, we should build a <span class="italic">new</span> node, copying in the parts of the old node that don’t need to change. Something like this: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">{:val (:val t),<br class="calibre3"/> :L (insert-new-val-here),<br class="calibre3"/> :R (:R t)}</tt></span></blockquote><p class="calibre12">This will be the new root node. Now we just need to figure out what to put for <tt class="calibre11">insert-new-val-here</tt>. If the old value of <tt class="calibre11">:L</tt> is <tt class="calibre11">nil</tt>, we simply need a new single-node tree—we even have code for that already, so we could use <tt class="calibre11">(xconj nil v)</tt>. But what if <tt class="calibre11">:L</tt> isn’t <tt class="calibre11">nil</tt>? In that case, we want to insert <tt class="calibre11">v</tt> in its proper place within whatever tree <tt class="calibre11">:L</tt> is pointing to—so <tt class="calibre11">(:L t)</tt> instead of <tt class="calibre11">nil</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn xconj [t v]<br class="calibre3"/>  (cond<br class="calibre3"/>    (nil? t)       {:val v, :L nil, :R nil}<br class="calibre3"/>    (&lt; v (:val t)) {:val (:val t),<br class="calibre3"/>                    :L (xconj (:L t) v),<br class="calibre3"/>                    :R (:R t)}))<br class="calibre3"/><br class="calibre3"/>(def tree1 (xconj nil 5))<br class="calibre3"/>tree1<br class="calibre3"/>;=&gt; {:val 5, :L nil, :R nil}<br class="calibre3"/><br class="calibre3"/>(def tree1 (xconj tree1 3))<br class="calibre3"/>tree1<br class="calibre3"/>;=&gt; {:val 5, :L {:val 3, :L nil, :R nil}, :R nil}<br class="calibre3"/><br class="calibre3"/>(def tree1 (xconj tree1 2))<br class="calibre3"/>tree1<br class="calibre3"/>;=&gt; {:val 5, :L {:val 3, :L {:val 2, :L nil, :R nil}, :R nil}, :R nil}</tt></span></blockquote><p class="calibre12">There, it’s working. At least it seems to be—there’s a lot of noise in that output, making it difficult to read. Here’s a function to traverse the tree in sorted order, converting it to a seq that will print more succinctly: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn xseq [t]<br class="calibre3"/>  (when t<br class="calibre3"/>    (concat (xseq (:L t)) [(:val t)] (xseq (:R t)))))<br class="calibre3"/>(xseq tree1)<br class="calibre3"/>;=&gt; (2 3 5)</tt></span></blockquote><p id="filepos444400" class="calibre12">Now we just need a final condition for handling the insertion of values that are <span class="italic">not</span> less than the node value: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn xconj [t v]<br class="calibre3"/>  (cond<br class="calibre3"/>    (nil? t)       {:val v, :L nil, :R nil}<br class="calibre3"/>    (&lt; v (:val t)) {:val (:val t),<br class="calibre3"/>                    :L (xconj (:L t) v),<br class="calibre3"/>                    :R (:R t)}<br class="calibre3"/>   :else           {:val (:val t),<br class="calibre3"/>                    :L (:L t),<br class="calibre3"/>                    :R (xconj (:R t) v)}))</tt></span></blockquote><p class="calibre12">Now that we have the thing built, we hope you understand well enough how it’s put together that this demonstration of the shared structure will be unsurprising: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def tree2 (xconj tree1 7))<br class="calibre3"/>(xseq tree2)<br class="calibre3"/>;=&gt; (2 3 5 7)<br class="calibre3"/><br class="calibre3"/>(identical? (:L tree1) (:L tree2))<br class="calibre3"/>;=&gt; true</tt></span></blockquote><p class="calibre12">Both <tt class="calibre11">tree1</tt> and <tt class="calibre11">tree2</tt> share a common structure, which is more easily visualized in <a href="#filepos445764"><span class="calibre8"><span class="underline">figure 6.1</span></span></a>. </p><p id="filepos445764" class="calibre5"><span class="calibre10"><span class="bold">Figure 6.1. Shared structure tree: no matter how big the left side of a tree’s root node is, something can be inserted on the right side without copying, changing, or even examining the left side. All those values will be included in the new tree, along with the inserted value. </span></span><a></a></p><p class="calibre1"><img src="images/00069.jpg" class="calibre56"/></p><p class="calibre5">This example demonstrates several features that it has in common with all of Clojure’s persistent collections:</p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24">Every “change” creates at least a new root node, plus new nodes as needed in the path through the tree to where the new value is being inserted. </li><li value="2" class="calibre24">Values and unchanged branches are never copied, but references to them are copied from nodes in the old tree to nodes in the new one. </li><li value="3" class="calibre24">This implementation is completely thread-safe in a way that’s easy to check—no object that existed before a call to <tt class="calibre11">xconj</tt> is changed in any way, and newly created nodes are in their final state before being returned. There’s no way for any other thread, or even any other functions in the same thread, to see anything in an inconsistent state. </li></ul><p id="filepos447193" class="calibre5">Our example fails, though, when compared to Clojure’s production-quality code: </p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24">It’s just a binary tree.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos447608"><span class="calibre33"><span class="calibre8"><span class="underline">2</span></span></span></a><span class="calibre33">]</span></small></sup><blockquote class="calibre39"><sup class="calibre31"><small id="filepos447608" class="calibre32"><span class="calibre33">2</span></small></sup><span class="calibre10"> Clojure’s sorted collections are binary trees, but its hash maps, hash sets, and vectors all have up to 32 branches per node. This results in dramatically shallower trees, and therefore faster lookups and updates. </span></blockquote></li><li value="2" class="calibre57">It can only store numbers.</li><li value="3" class="calibre24">It’ll overflow the stack if the tree gets too deep.</li><li value="4" class="calibre24">It produces (via <tt class="calibre11">xseq</tt>) a non-lazy seq that will contain a whole copy of the tree. </li><li value="5" class="calibre24">It can create unbalanced trees that’ll have bad “worst case” algorithmic complexity.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos448538"><span class="calibre33"><span class="calibre8"><span class="underline">3</span></span></span></a><span class="calibre33">]</span></small></sup><blockquote class="calibre39"><sup class="calibre31"><small id="filepos448538" class="calibre32"><span class="calibre33">3</span></small></sup><span class="calibre10"> Clojure’s sorted map and sorted set do use a binary tree internally, but they implement red-black trees to keep the left and right sides nicely balanced. </span></blockquote></li></ul><p class="calibre5">Though structural sharing as described using <tt class="calibre11">xconj</tt> as a basis example can reduce the memory footprint of persistent data structures, it alone is insufficient. Instead, Clojure leans heavily on the notion of lazy sequences to further reduce its memory footprint, as we’ll explore further in the next section. </p><p id="filepos449135" class="calibre5"><span class="calibre18"><span class="bold">6.3. Laziness </span></span></p><blockquote class="calibre9"><span class="italic">Through all the windows I only see infinity.</span></blockquote><blockquote class="calibre9">by Mark Z. Danielewski</blockquote><blockquote class="calibre25"><span class="italic">House of Leaves</span></blockquote><p class="calibre5">Clojure is partially a lazy language. This isn’t to say that Clojure vectors lie around the house every day after school playing video games and refusing to get a job. Instead, Clojure is lazy in the way it handles its sequence types—but what does that mean? First, we’ll start by defining what it means for a language to be <span class="italic">eager</span>, or in other words, not lazy. Many programming languages are eager in that arguments to functions are immediately evaluated when passed, and Clojure in most cases follows this pattern as well. Observe the following: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(- 13 (+ 2 2))<br class="calibre3"/>;=&gt; 9</tt></span></blockquote><p class="calibre12">The expression <tt class="calibre11">(+ 2 2)</tt> is eagerly evaluated, in that its result <tt class="calibre11">4</tt> is passed on to the subtraction function during the actual call, and <span class="italic">not</span> at the point of need. But a lazy programming language such as Haskell (<a href="#filepos1075682"><span class="calibre8"><span class="underline">Hudak 2000</span></span></a>) will evaluate a function argument only if that argument is needed in an overarching computation. </p><p class="calibre5">In this section we’ll discuss how laziness can be used to avoid nontermination, unnecessary calculations, and even combinatorially exploding computations. We’ll also discuss the matter of utilizing infinite sequences, a surprisingly powerful technique. Finally, we’ll use Clojure’s <tt class="calibre11">delay</tt> and <tt class="calibre11">force</tt> to build a simple lazy structure. First, we’ll start with a simple example of laziness that you may be familiar with from Java. </p><p id="filepos451100" class="calibre5"><span class="bold">6.3.1. Familiar laziness with logical-and </span><a></a></p><p class="calibre7">Laziness isn’t limited to the case of the evaluation of function arguments; a common example can be found even in eager programming languages. Take the case of Java’s <a id="filepos451388"></a>logical-and operator <tt class="calibre11">&amp;&amp;</tt>. Java implementations optimize this particular operator to avoid performing unnecessary operations should an early subexpression evaluate to <tt class="calibre11">false</tt>. This lazy evaluation in Java allows the following idiom: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">if (obj != null &amp;&amp; obj.isWhatiz()) {<br class="calibre3"/>    ...<br class="calibre3"/>}</tt></span></blockquote><p class="calibre12">For those of you unfamiliar with Java, the preceding code says: “if the object <tt class="calibre11">obj</tt> isn’t <tt class="calibre11">null</tt>, then call the method <tt class="calibre11">isWhatiz</tt>.” Without a short-circuiting (or lazy, if you will) <tt class="calibre11">&amp;&amp;</tt> operator, the preceding operation would always throw a <tt class="calibre11">java.lang.NullPointer-Exception</tt> whenever <tt class="calibre11">obj</tt> was set to <tt class="calibre11">null</tt>. Though this simple example doesn’t qualify Java as a lazy language, it does illustrate the first advantage of lazy evaluation—<span class="italic">laziness allows the avoidance of errors in the evaluation of compound structures</span>. </p><p class="calibre5">Clojure’s <tt class="calibre11">and</tt> operator also works this way, as do a number of other operators, but we won’t discuss this type of short-circuiting laziness too deeply. <a href="#filepos452795"><span class="calibre8"><span class="underline">Listing 6.1</span></span></a> illustrates what we mean using the case of a series of nested <tt class="calibre11">if</tt> expressions. </p><p id="filepos452795" class="calibre5"><span class="calibre10"><span class="bold">Listing 6.1. Short-circuiting </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">if</span></tt></span><span class="calibre10"><span class="bold"> expression </span></span></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn if-chain [x y z]<br class="calibre3"/>  (if x<br class="calibre3"/>    (if y<br class="calibre3"/>      (if z<br class="calibre3"/>        (do<br class="calibre3"/>          (println "Made it!")<br class="calibre3"/>           :all-truthy)))))<br class="calibre3"/><br class="calibre3"/>(if-chain () 42 true)<br class="calibre3"/>; Made it!<br class="calibre3"/>;=&gt; :all-truthy<br class="calibre3"/><br class="calibre3"/>(if-chain true true  false)<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p class="calibre12">The call to <tt class="calibre11">println</tt> is evaluated only in the case of three truthy arguments. But we can perform the equivalent action given only the <tt class="calibre11">and</tt> macro: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn and-chain [x y z]<br class="calibre3"/>  (and x y z (do (println "Made it!") :all-truthy)))<br class="calibre3"/><br class="calibre3"/>(and-chain () 42 true)<br class="calibre3"/>; Made it!<br class="calibre3"/>;=&gt; :all-truthy<br class="calibre3"/><br class="calibre3"/>(and-chain true false true)<br class="calibre3"/>;=&gt; false</tt></span></blockquote><p class="calibre12">You may see tricks like this from time to time, but they’re not widespread in idiomatic Clojure code. Regardless, we’ve presented them as a launching point for the rest of the discussion in the section. We’ll now proceed to discussing how your own Clojure programs can be made more generally lazy by following an important recipe. </p><p id="filepos454343" class="calibre5"><span class="bold">6.3.2. Understanding the lazy-seq recipe </span><a></a></p><p id="filepos454430" class="calibre7">Here’s a seemingly simple function <tt class="calibre11">steps</tt> that takes a sequence and makes a deeply nested structure from it: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(steps [1 2 3 4])<br class="calibre3"/>;=&gt; [1 [2 [3 [4 []]]]]</tt></span></blockquote><p class="calibre12">Seems simple enough, no? Your first instinct might be to tackle this problem recursively, as suggested by the form of the desired result: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn rec-step [[x &amp; xs]]<br class="calibre3"/>  (if x<br class="calibre3"/>    [x (rec-step xs)]<br class="calibre3"/>    []))<br class="calibre3"/><br class="calibre3"/>(rec-step [1 2 3 4])<br class="calibre3"/>;=&gt; [1 [2 [3 [4 []]]]]</tt></span></blockquote><p class="calibre12">Things look beautiful at this point; we’ve created a simple solution to a simple problem. But therein bugbears lurk. What would happen if we ran this same function on a large set? </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(rec-step (range 200000))<br class="calibre3"/>;=&gt; java.lang.StackOverflowError</tt></span></blockquote><p class="calibre12">Observing the example, running the same function over a sequence of 200,000 elements<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos456261"><span class="calibre33"><span class="calibre8"><span class="underline">4</span></span></span></a><span class="calibre33">]</span></small></sup> causes a stack overflow. How can we fix this problem? Perhaps it’s fine to say that you’ll never encounter such a large input set in your own programs; such tradeoffs are made all of the time. But Clojure provides lazy sequences to help tackle such problems without significantly complicating your source code. Additionally, idiomatic Clojure code will always strive to deal with, and produce, lazy sequences. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos456261" class="calibre32"><span class="calibre33">4</span></small></sup><span class="calibre10"> On our machines, 200,000 elements is enough to cause a stack overflow, but your machine may require more or fewer depending on your JVM configuration. </span></blockquote><p class="calibre12">Stepping back a bit, we should examine the lazy-seq recipe for applying laziness to your own functions:</p><div class="calibre22"> </div><ol class="calibre48"><li value="1" class="calibre24">Use the <tt class="calibre11">lazy-seq</tt> macro at the outermost level of your lazy sequence producing expression(s). </li><li value="2" class="calibre24">If you happen to be consuming another sequence during your operations, then use <tt class="calibre11">rest</tt> instead of <tt class="calibre11">next</tt>. </li><li value="3" class="calibre24">Prefer higher-order functions when processing sequences.</li><li value="4" class="calibre24">Don’t hold onto your head.</li></ol><p class="calibre5">These rules of thumb are simple, but they take some practice to utilize to their fullest. For example, #4 is especially subtle in that the trivial case is easy to conceptualize, but it’s more complex to implement in large cases. For now we’ll gloss over #3, because we’ll talk about that approach separately in <a href="#filepos487603"><span class="calibre8"><span class="underline">section 7.1</span></span></a>. </p><p class="calibre5">So how can you leverage these rules of thumb to ensure laziness?</p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">rest versus next</span>
</p><p id="filepos457834" class="calibre7">The difference between <tt class="calibre11">rest</tt> and <tt class="calibre11">next</tt> can be seen in the following example: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def very-lazy (-&gt; (iterate #(do (print \.) (inc %)) 1)<br class="calibre3"/>                    rest rest rest))<br class="calibre3"/>;=&gt; ..#'user/very-lazy<br class="calibre3"/><br class="calibre3"/>(def less-lazy (-&gt; (iterate #(do (print \.) (inc %)) 1)<br class="calibre3"/>                    next next next))<br class="calibre3"/>;=&gt; ...#'user/less-lazy</tt></span></blockquote><p class="calibre12">When building a lazy seq from another, <tt class="calibre11">rest</tt> doesn’t realize any more elements than it needs to; <tt class="calibre11">next</tt> does. In order to determine whether a seq is empty, <tt class="calibre11">next</tt> needs to check whether there’s at least one thing in it, thus potentially causing one extra realization. Here’s an example: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(println (first very-lazy)) ; .4<br class="calibre3"/><br class="calibre3"/>(println (first less-lazy)) ; 4</tt></span></blockquote><p class="calibre12">Grabbing the first element in a lazy seq built with <tt class="calibre11">rest</tt> causes a realization as expected. But the same doesn’t happen for a seq built with <tt class="calibre11">next</tt> because it’s already been previously realized. Using <tt class="calibre11">next</tt> causes a lazy seq to be one element less lazy, which might not be desired if the cost of realization is expensive. In general, we recommend that you use <tt class="calibre11">next</tt> unless you’re specifically trying to write code to be as lazy as possible. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre28"><span class="calibre10"><span class="bold">Utilizing Lazy-Seq and Rest </span></span></p><p class="calibre7">In order to be a proper lazy citizen, you should produce lazy sequences using the <tt class="calibre11">lazy-seq</tt> macro: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn lz-rec-step [s]<br class="calibre3"/>  (lazy-seq<br class="calibre3"/>    (if (seq s)<br class="calibre3"/>      [(first s) (lz-rec-step (rest s))]<br class="calibre3"/>      [])))<br class="calibre3"/><br class="calibre3"/>(lz-rec-step [1 2 3 4])<br class="calibre3"/>;=&gt; (1 (2 (3 (4 ()))))<br class="calibre3"/><br class="calibre3"/>(class (lz-rec-step [1 2 3 4]))<br class="calibre3"/>;=&gt; clojure.lang.LazySeq<br class="calibre3"/><br class="calibre3"/>(dorun (lz-rec-step (range 200000)))<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p class="calibre12">There are a few points of note for our new implementation. First, we’ve eliminated destructuring on the function arguments because the <tt class="calibre11">&amp;</tt> arguments within are implicitly destructured via the <tt class="calibre11">nthnext</tt> function. As we mentioned in our rules of thumb, when consuming a sequence within the body of a <tt class="calibre11">lazy-seq</tt> you’ll want to use <tt class="calibre11">rest</tt>, which we did in <tt class="calibre11">lz-rec-step</tt>. Second, we’re no longer producing nested vectors as the output of the function, but instead a lazy sequence <tt class="calibre11">LazySeq</tt>, which is the by-product of the <tt class="calibre11">lazy-seq</tt> macro. </p><p id="filepos460891" class="calibre5">With only minor adjustments, we’ve created a lazy version of the step function while also maintaining simplicity. The first two rules of the lazy sequence recipe can be used in all cases when producing lazy sequences. You’ll see this pattern over and over in idiomatic Clojure code. </p><p class="calibre5">If what’s going on here still doesn’t quite make sense to you, consider this even simpler example:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn simple-range [i limit]<br class="calibre3"/>  (lazy-seq<br class="calibre3"/>    (when (&lt; i limit)<br class="calibre3"/>      (cons i (simple-range (inc i) limit)))))</tt></span></blockquote><p class="calibre12">This behaves similarly to Clojure’s built-in function <tt class="calibre11">range</tt>, but it’s simpler in that it doesn’t accept a <tt class="calibre11">step</tt> argument and has no support for producing chunked seqs:<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos462003"><span class="calibre33"><span class="calibre8"><span class="underline">5</span></span></span></a><span class="calibre33">]</span></small></sup></p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos462003" class="calibre32"><span class="calibre33">5</span></small></sup><span class="calibre10"> Chunked seqs are a technique for improving performance that we cover in </span><a href="#filepos952602"><span class="calibre10"><span class="calibre8"><span class="underline">chapter 12</span></span></span></a><span class="calibre10">. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(simple-range 0 9)<br class="calibre3"/>;=&gt; (0 1 2 3 4 5 6 7 8)</tt></span></blockquote><p class="calibre12">Note that it follows all the lazy-seq recipe rules you’ve seen so far. <a href="#filepos462756"><span class="calibre8"><span class="underline">Figure 6.2</span></span></a> is a representation of what’s in memory when the REPL has printed the first two items in a <tt class="calibre11">simple-range</tt> seq but hasn’t yet printed any more than that. </p><p id="filepos462756" class="calibre5"><span class="calibre10"><span class="bold">Figure 6.2. Each step of a lazy seq may be in one of two states. If the step is </span></span><a></a><span class="calibre10"><span class="italic"><span class="bold">unrealized</span></span></span><span class="calibre10"><span class="bold">, it’ll contain a function or closure of no arguments (a thunk) that can be called later to realize the step. When this happens, the thunk’s return value is cached instead, and the thunk itself is released as pictured in the first two lazy seq boxes, transitioning the step to the </span></span><span class="calibre10"><span class="italic"><span class="bold">realized</span></span></span><span class="calibre10"><span class="bold"> state. Note that although not shown here, a realized lazy seq may simply contain nothing at all, called </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">nil</span></tt></span><span class="calibre10"><span class="bold">, indicating the end of the seq. </span></span></p><p class="calibre1"><img src="images/00018.jpg" class="calibre58"/></p><p class="calibre5">One way in which complications may arise is by accidentally holding onto the head of a lazy sequence. This is addressed by the third rule of lazy sequences. </p><p id="filepos463850" class="calibre5"><span class="bold">6.3.3. Losing your head </span><a></a></p><p class="calibre7">The primary advantage of laziness in Clojure is that it prevents the full realization of interim results during a calculation. If you manage to hold onto the head of a sequence somewhere within a function, then that sequence will be prevented from being garbage collected. The simplest way to retain the head of a sequence is to bind it to a local. This condition can occur with any type of value bind, be it to a reference type or through the usage of <tt class="calibre11">let</tt> or <tt class="calibre11">binding</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(let [r (range 1e9)] [(first r) (last r)])<br class="calibre3"/>;=&gt; [0 999999999]<br class="calibre3"/><br class="calibre3"/>(let [r (range 1e9)] [(last r) (first r)])<br class="calibre3"/>; java.lang.OutOfMemoryError: GC overhead limit exceeded</tt></span></blockquote><p class="calibre12">Clojure’s compiler can deduce that in the first example, the retention of <tt class="calibre11">r</tt> is no longer needed when the computation of <tt class="calibre11">(last r)</tt> occurs, and therefore aggressively clears it. <a id="filepos464962"></a>But in the second example, the head is needed later in the overall computation and can no longer be safely cleared. Of course, the compiler could perform some rearranging with the order of operations for this case, but it doesn’t because in order to do so safely it would have to guarantee that all of the composite functions were pure. It’s okay if you’re not clear on what a pure function is right now—we’ll cover it in <a href="#filepos487603"><span class="calibre8"><span class="underline">section 7.1</span></span></a>. In a nutshell, take to heart that Clojure can’t rearrange operations, because there’s no way to guarantee that order is unimportant. This is one area where a purely functional lazy language such as Haskell (<a href="#filepos1082938"><span class="calibre8"><span class="underline">Thompson 1999</span></span></a>) really shines by comparison. </p><p id="filepos465791" class="calibre5"><span class="bold">6.3.4. Employing infinite sequences </span><a></a></p><p class="calibre7">Because Clojure’s sequences are lazy, they have the potential to be infinitely long. Clojure provides a number of functions for generating and working with infinite sequences: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">; Run at your own risk<br class="calibre3"/>(iterate (fn [n] (/ n 2)) 1)<br class="calibre3"/>;=&gt; (1 1/2 1/4 1/8 ...)</tt></span></blockquote><p class="calibre12">It sure is a nice trick (although you might not think so had you chosen to ignore our warning), but what could you possibly use infinite sequences for? Working with infinite sequences often fosters more declarative solutions. Take a simple example as a start. Imagine that we have a function that calculates a triangle number for a given integer: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn triangle [n]<br class="calibre3"/>(/ (* n (+ n 1)) 2))<br class="calibre3"/><br class="calibre3"/>(triangle 10)<br class="calibre3"/>;=&gt; 55</tt></span></blockquote><p class="calibre12">The function <tt class="calibre11">triangle</tt> can then be used to build a sequence of the first 10 triangle numbers: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(map triangle (range 1 11))<br class="calibre3"/>;=&gt; (1 3 6 10 15 21 28 36 45 55)</tt></span></blockquote><p class="calibre12">There’s nothing wrong with the preceding solution, but it suffers from a lack of flexibility in that it does what it does and that’s all. By defining a sequence of <span class="italic">all</span> of the triangle numbers as in the following listing, you can perform more interesting “queries” in order to retrieve the desired elements. </p><p id="filepos467498" class="calibre5"><span class="calibre10"><span class="bold">Listing 6.2. Infinite sequences foster declarative solutions. </span></span><a></a></p><p class="calibre1"><img src="images/00032.jpg" class="calibre59"/></p><p id="filepos467745" class="calibre5">The queries used three ubiquitous Clojure functions: <tt class="calibre11">map</tt>, <tt class="calibre11">reduce</tt>, and <tt class="calibre11">filter</tt>. The <tt class="calibre11">map</tt> function applies a function to each element in a sequence and returns the resulting sequence. The <tt class="calibre11">reduce</tt> function applies a function to each value in the sequence <span class="italic">and</span> the running result to accumulate a final value. Finally, the <tt class="calibre11">filter</tt> function applies a function to each element in a sequence and returns a new sequence of those elements where said function returned a truthy value. All three of these functions retain the laziness of a given sequence. </p><p class="calibre5">Defining the infinite sequence of triangle numbers allows you to take elements from it as needed, only calculating those particular items. </p><p id="filepos468548" class="calibre5"><span class="bold">6.3.5. The delay and force macros </span><a></a></p><p class="calibre7">Although Clojure sequences are largely lazy, Clojure itself isn’t. In most cases, expressions in Clojure are evaluated once prior to their being passed into a function rather than at the time of need. But Clojure does provide mechanisms for implementing what are known as <span class="italic">call-by-need semantics</span>. The most obvious of these mechanisms is its macro facilities, but we’ll defer that discussion until <a href="#filepos582816"><span class="calibre8"><span class="underline">chapter 8</span></span></a>. The other mechanism for providing what we’ll call explicit laziness are Clojure’s <tt class="calibre11">delay</tt> and <tt class="calibre11">force</tt>. In short, the <tt class="calibre11">delay</tt> macro is used to defer the evaluation of an expression until explicitly forced using the <tt class="calibre11">force</tt> function. Using these laziness primitives, we can wrap an expression in a call to <tt class="calibre11">delay</tt> and use it only if necessary on the callee’s side: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn defer-expensive [cheap expensive]<br class="calibre3"/>  (if-let [good-enough (force cheap)]<br class="calibre3"/>    good-enough<br class="calibre3"/>    (force expensive)))<br class="calibre3"/><br class="calibre3"/>(defer-expensive (delay :cheap)<br class="calibre3"/>                 (delay (do (Thread/sleep 5000) :expensive)))<br class="calibre3"/>;=&gt; :cheap<br class="calibre3"/><br class="calibre3"/>(defer-expensive (delay false)<br class="calibre3"/>                 (delay (do (Thread/sleep 5000) :expensive)))<br class="calibre3"/>;=&gt; :expensive</tt></span></blockquote><p class="calibre12">You can simulate this behavior with the use of anonymous functions, where <tt class="calibre11">delay</tt> is replaced by <tt class="calibre11">(fn [] expr)</tt> and <tt class="calibre11">force</tt> by <tt class="calibre11">(delayed-fn)</tt>, but using <tt class="calibre11">delay</tt>/<tt class="calibre11">force</tt> allows you to explicitly check for delayed computations using <tt class="calibre11">delay?</tt>. Additionally, <tt class="calibre11">delay</tt> caches its calculation, therefore allowing its wrapped expression to be calculated only once. Of course, you could simulate the same behavior using memoization,<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos470928"><span class="calibre33"><span class="calibre8"><span class="underline">6</span></span></span></a><span class="calibre33">]</span></small></sup> but why would you in this case when <tt class="calibre11">delay</tt> and <tt class="calibre11">force</tt> solve the problem more succinctly? </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos470928" class="calibre32"><span class="calibre33">6</span></small></sup><span class="calibre10"> We’ll cover memoization in </span><a href="#filepos975700"><span class="calibre10"><span class="calibre8"><span class="underline">section 12.4</span></span></span></a><span class="calibre10">. </span></blockquote><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">if-let and when-let</span>
</p><p id="filepos471319" class="calibre7">The <tt class="calibre11">if-let</tt> and <tt class="calibre11">when-let</tt> macros are useful when you’d like to bind the results of an expression based on if it returns a truthy value. This helps to avoid the need to nest <tt class="calibre11">if/when</tt> and <tt class="calibre11">let</tt> as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(if :truthy-thing<br class="calibre3"/>  (let [res :truthy-thing] (println res)))<br class="calibre3"/>; :truthy-thing<br class="calibre3"/><br class="calibre3"/><br class="calibre3"/>(if-let [res :truthy-thing] (println res))<br class="calibre3"/>; :truthy-thing</tt></span></blockquote><p class="calibre12">The latter is much more succinct.</p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">There are more complicated usage patterns for <tt class="calibre11">delay</tt> and <tt class="calibre11">force</tt> besides the simple scheme outlined previously. For example, we can implement a version of the lazy sequence of triangular numbers from a few sections prior using <tt class="calibre11">delay</tt> and <tt class="calibre11">force</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn inf-triangles [n]<br class="calibre3"/>  {:head (triangle n)<br class="calibre3"/>   :tail (delay (inf-triangles (inc n)))})<br class="calibre3"/><br class="calibre3"/>(defn head  [l]   (:head l))<br class="calibre3"/>(defn tail  [l]   (force (:tail l)))</tt></span></blockquote><p class="calibre12">The function <tt class="calibre11">inf-triangles</tt> creates a lazy linked-list of nodes. Each node is a map containing a value mapped to <tt class="calibre11">:head</tt> and a link to the remainder of the list keyed as <tt class="calibre11">:tail</tt>. The head of the list is the result of applying the function <tt class="calibre11">triangle</tt> to the incrementing counter passed recursively within the body of <tt class="calibre11">delay</tt>. As you can imagine, the head of a node is always calculated as we walk down the linked-list, even if it’s never accessed. This type of lazy structure is known as <span class="italic">head strict</span> but differs from Clojure’s <tt class="calibre11">lazy-seq</tt>, which delays both the head and tail and then realizes them at the same time. </p><p class="calibre5">We can now create a structure similar to the original <tt class="calibre11">tri-nums</tt> and start getting at its contained elements: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def tri-nums (inf-triangles 1))<br class="calibre3"/><br class="calibre3"/>(head tri-nums)<br class="calibre3"/>;=&gt; 1<br class="calibre3"/>(head (tail tri-nums))<br class="calibre3"/>;=&gt; 3<br class="calibre3"/>(head (tail (tail tri-nums)))<br class="calibre3"/>;=&gt; 6</tt></span></blockquote><p class="calibre12">One thing to note about the preceding code is that accessing the values <tt class="calibre11">3</tt> and <tt class="calibre11">6</tt> were deferred calculations only occurring on demand. The structure of the example is shown in <a href="#filepos474086"><span class="calibre8"><span class="underline">figure 6.3</span></span></a>. </p><p id="filepos474086" class="calibre5"><span class="calibre10"><span class="bold">Figure 6.3. Lazy linked-list example. Each node of this linked list contains a value (the </span></span><a></a><span class="calibre10"><span class="italic"><span class="bold">head</span></span></span><span class="calibre10"><span class="bold">) and a delay (the </span></span><span class="calibre10"><span class="italic"><span class="bold">tail</span></span></span><span class="calibre10"><span class="bold">). The creation of the next part is forced by a call to </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">tai</span></tt></span><span class="calibre10"><span class="bold">l—it doesn’t exist until then. </span></span></p><p class="calibre1"><img src="images/00025.jpg" class="calibre60"/></p><p id="filepos474679" class="calibre5">Though we can navigate the entire chain of triangular numbers using only <tt class="calibre11">head</tt> and <tt class="calibre11">tail</tt>, it’s probably a better idea<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos475101"><span class="calibre33"><span class="calibre8"><span class="underline">7</span></span></span></a><span class="calibre33">]</span></small></sup> to use them as primitives for more complicated functions: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos475101" class="calibre32"><span class="calibre33">7</span></small></sup><span class="calibre10"> And as we’ll cover in </span><a href="#filepos677632"><span class="calibre10"><span class="calibre8"><span class="underline">section 9.3</span></span></span></a><span class="calibre10">, participating in the ISeq protocol is even better. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn taker [n l]<br class="calibre3"/>  (loop [t n, src l, ret []]<br class="calibre3"/>    (if (zero? t)<br class="calibre3"/>      ret<br class="calibre3"/>      (recur (dec t) (tail src) (conj ret (head src))))))<br class="calibre3"/><br class="calibre3"/>(defn nthr [l n]<br class="calibre3"/>  (if (zero? n)<br class="calibre3"/>    (head l)<br class="calibre3"/>    (recur (tail l) (dec n))))<br class="calibre3"/><br class="calibre3"/>(taker 10 tri-nums)<br class="calibre3"/>;=&gt; [1 3 6 10 15 21 28 36 45 55]<br class="calibre3"/><br class="calibre3"/>(nthr tri-nums 99)<br class="calibre3"/>;=&gt; 5050</tt></span></blockquote><p class="calibre12">Of course, writing programs using <tt class="calibre11">delay</tt> and <tt class="calibre11">force</tt> is an onerous way to go about the problem of laziness, and you’d be better served by using Clojure’s lazy sequences to full effect rather than building your own from these basic blocks. But the preceding code, in addition to being simple to understand, harkens back to <a href="#filepos332652"><span class="calibre8"><span class="underline">chapter 5</span></span></a> and the entire sequence “protocol” being built entirely on the functions <tt class="calibre11">first</tt> and <tt class="calibre11">rest</tt>. Pretty cool, right? </p><p id="filepos476519" class="calibre5"><span class="calibre18"><span class="bold">6.4. Putting it all together: a lazy quicksort </span></span></p><p class="calibre7">In a time when the landscape of programming languages is rife with new programming languages and pregnant with more, it seems inconceivable that the world would need another quicksort implementation. Inconceivable or not, we won’t be deterred from adding yet another to the rich ecosystem of pet problems. Our implementation <a id="filepos476983"></a>of quicksort differs from many in a few key ways. First, we’ll implement a lazy, tail-recursive version. Second, we’ll split the problem such that it can be executed incrementally. Only the calculations required to obtain the part of a sequence desired will be calculated. This will illustrate the fundamental reason for laziness in Clojure: <span class="italic">the avoidance of full realization of interim results</span>. </p><p id="filepos477401" class="calibre5"><span class="bold">The Implementation </span></p><p class="calibre7">Without further ado, we present our quicksort implementation.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos477749"><span class="calibre33"><span class="calibre8"><span class="underline">8</span></span></span></a><span class="calibre33">]</span></small></sup></p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos477749" class="calibre32"><span class="calibre33">8</span></small></sup><span class="calibre10"> This listing uses the </span><span class="calibre10"><tt class="calibre11">list*</tt></span><span class="calibre10"> function, which for some reason is somewhat rarely seen. In cases like this, however, it is exactly what is needed. </span><span class="calibre10"><tt class="calibre11">list*</tt></span><span class="calibre10"> is like </span><span class="calibre10"><tt class="calibre11">list</tt></span><span class="calibre10"> except it expects its last argument to be a list on which to prepend its other arguments. We’ll use it again in </span><a href="#filepos582816"><span class="calibre10"><span class="calibre8"><span class="underline">chapter 8</span></span></span></a><span class="calibre10">. </span></blockquote><p id="filepos478379" class="calibre12"><span class="calibre10"><span class="bold">Listing 6.3. A lazy, tail-recursive quicksort implementation </span></span><a></a></p><p class="calibre1"><img src="images/00034.jpg" class="calibre61"/></p><p class="calibre5">The key detail in the code above is that <tt class="calibre11">sort-parts</tt> works not on a plain sequence of elements but on a carefully constructed list that alternates between lazy seqs and pivots. Every element before each pivot is guaranteed to be less than the pivot and everything after will be greater, but the sequences between the pivots are as yet unsorted. When <tt class="calibre11">qsort</tt> is given an input sequence of numbers to sort, it creates a new work list consisting of just that input sequence and passes this work to <tt class="calibre11">sort-parts</tt>. The loop inside <tt class="calibre11">sort-parts</tt> pulls apart the work, always assuming that the first item, which it binds to <tt class="calibre11">part</tt>, is an unsorted sequence. It also assumes that if there is a second item, which will be at the head of <tt class="calibre11">parts</tt>, it is a pivot. It <tt class="calibre11">recur</tt>s on the sequence at the head of <tt class="calibre11">work</tt>, splitting out pivots and lazy seqs until the sequence of items less than the most recent pivot is empty, in which case the <tt class="calibre11">if-let</tt> test is false, and that most recent pivot is returned as the first item in the sorted seq. The rest of the built up list of work <a id="filepos479779"></a>held by the returned lazy sequence to be passed into <tt class="calibre11">sort-parts</tt> again when subsequent sorted items are needed. </p><p class="calibre5">You can see a snapshot of the work list for the function call <tt class="calibre11">(qsort [2 1 4 3])</tt> in <a href="#filepos480146"><span class="calibre8"><span class="underline">Figure 6.4</span></span></a>, at an intermediate point in its process. </p><p id="filepos480146" class="calibre5"><span class="calibre10"><span class="bold">Figure 6.4. The </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">qsort</span></tt></span><span class="calibre10"><span class="bold"> function shown earlier would use a structure like this for its </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">work</span></tt></span><span class="calibre10"><span class="bold"> list when sorting the vector [</span></span><span class="calibre10"><tt class="calibre11"><span class="bold">2 1 4 3</span></tt></span><span class="calibre10"><span class="bold">]. Note that all the parts described by a standard quicksort implementation are represented here. </span></span></p><p class="calibre1"><img src="images/00074.jpg" class="calibre62"/></p><p class="calibre5">The figure includes the characteristics of a standard quicksort implementation, and you can run it to see that the final sequence is sorted: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(qsort [2 1 4 3])<br class="calibre3"/>;=&gt; (1 2 3 4)<br class="calibre3"/><br class="calibre3"/>(qsort (nom 20))<br class="calibre3"/>;=&gt; (0 2 3 5 6 7 7 8 9 10 11 11 11 12 12 13 14 16 17 19)</tt></span></blockquote><p class="calibre12">The implementation of the <tt class="calibre11">sort-parts</tt> function works to provide an incremental solution for lazy quicksort. This incremental approach stands in opposition to a monolithic approach (<a href="#filepos1080169"><span class="calibre8"><span class="underline">Okasaki 1996</span></span></a>) defined by its performance of the entire calculation when any segment of the sequence is accessed. For example, grabbing the first element in a lazy sequence returned from <tt class="calibre11">qsort</tt> will perform <span class="italic">only</span> the necessary calculations required to get that first item: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(first (qsort (nom 100)))<br class="calibre3"/>;=&gt; 1</tt></span></blockquote><p class="calibre12">Of course, the number returned here will likely be different in your REPL, but the underlying structure of the lazy sequence used internally by <tt class="calibre11">sort-parts</tt> will be similar to that shown in <a href="#filepos482180"><span class="calibre8"><span class="underline">Figure 6.5</span></span></a>. </p><p id="filepos482180" class="calibre5"><span class="calibre10"><span class="bold">Figure 6.5. Internal structure of qsort. Each </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">filter</span></tt></span><span class="calibre10"><span class="bold"> and </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">remove</span></tt></span><span class="calibre10"><span class="bold"> lazily returns items from its parent sequence only as required. So to return the first two items of the seq returned by </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">qsort</span></tt></span><span class="calibre10"><span class="bold">, no </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">remove</span></tt></span><span class="calibre10"><span class="bold"> steps are required from either level A or B. To generate the sequence </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">(4)</span></tt></span><span class="calibre10"><span class="bold">, a single </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">remove</span></tt></span><span class="calibre10"><span class="bold"> step at level B would be needed to eliminate everything less than 3. As more items are forced from the seq returned by </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">qsort</span></tt></span><span class="calibre10"><span class="bold">, more of the internal </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">filter</span></tt></span><span class="calibre10"><span class="bold"> and </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">remove</span></tt></span><span class="calibre10"><span class="bold"> steps will be run. </span></span></p><p class="calibre1"><img src="images/00044.jpg" class="calibre63"/></p><p class="calibre5">The lazy <tt class="calibre11">qsort</tt> will be able to gather the first element because it only takes some small subset of comparisons to gather the numbers into left-side smaller and right-side <a id="filepos483652"></a>larger partitions and sort those smaller pieces only. The characteristic of the quicksort algorithm is especially conducive to laziness, because it’s fairly cheap to make and shuffle partitions where those with a smaller magnitude can be shuffled first. What then are the benefits of a lazy, tail-recursive, incremental quicksort? The answer is that you can take sorted portions of a large sequence without having to pay the cost of sorting its entirety, as the following command hints: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(take 10 (qsort (nom 10000)))<br class="calibre3"/>;=&gt; (0 0 0 4 4 7 7 8 9 9)</tt></span></blockquote><p class="calibre12">On our machines, this command required roughly 11,000 comparisons, which for all intents and purposes is an O(n) operation—an order of magnitude less than quick-sorts’s best case. Bear in mind that as the <tt class="calibre11">take</tt> value gets closer to the number of actual elements, this difference in asymptotic complexity will shrink. But it’s an extremely efficient way to determine the smallest <tt class="calibre11">n</tt> values in a large unsorted (Knuth 1998) sequence. </p><p id="filepos484800" class="calibre5"><span class="calibre18"><span class="bold">6.5. Summary </span></span></p><p class="calibre7">We’ve covered the topics of immutability, persistence, and laziness in this chapter. Clojure’s core composite data types are all immutable and persistent by default, and though this fact might presuppose fundamental inefficiencies, we’ve shown how Clojure addresses them. The implementation of a persistent sorted binary tree demonstrated how structural sharing eliminated the need for full copy-on-write. But structural sharing isn’t enough to guarantee memory efficiency, and that’s where the benefits of laziness come into the fold. The implementation of a lazy, tail-recursive quicksort demonstrated that laziness guarantees that sequences won’t be fully realized in memory at any given step. </p><p class="calibre5">In the next chapter, we’ll dive into Clojure’s notion of functional programming. Along the way, you’ll notice that much of the shape of functional implementations in Clojure will be influenced by the topics discussed in this chapter. </p><div class="mbppagebreak"></div><p id="filepos485904" class="calibre5"><span class="calibre6"><span class="bold">Chapter 7. Functional programming </span></span><a></a></p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">This chapter covers</span>
</p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24"><a href="#filepos487603"><span class="calibre8"><span class="underline">Functions in all their forms</span></span></a></li><li value="2" class="calibre24"><a href="#filepos519998"><span class="calibre8"><span class="underline">Closures</span></span></a></li><li value="3" class="calibre24"><a href="#filepos543109"><span class="calibre8"><span class="underline">Thinking recursively</span></span></a></li><li value="4" class="calibre24"><a href="#filepos569849"><span class="calibre8"><span class="underline">Putting it all together: A* pathfinding</span></span></a></li></ul><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">At the core of functional programming is a formal system of computation known as the <span class="italic">lambda calculus</span> (<a href="#filepos1080965"><span class="calibre8"><span class="underline">Pierce 2002</span></span></a>). Clojure functions, in adherence with the lambda calculus, are first-class—they can be both passed as arguments and returned as results from other functions. This book isn’t about the lambda calculus. Instead we’ll explore Clojure’s particular flavor of functional programming. We’ll cover a vast array of useful topics, including function composition, partial evaluation, recursion, lexical closures, pure functions, function constraints, higher-order functions, and first-class functions. We’ll use that last item as our starting point. </p><p id="filepos487603" class="calibre5"><span class="calibre18"><span class="bold">7.1. Functions in all their forms </span></span></p><p id="filepos487698" class="calibre7">In <a href="#filepos332652"><span class="calibre8"><span class="underline">chapter 5</span></span></a>, we mentioned that most of Clojure’s composite types can be used as functions of their elements. As a refresher, recall that vectors are functions of their indices, so executing <tt class="calibre11">([:a :b] 0)</tt> will return <tt class="calibre11">:a</tt>. But this can be used to greater effect by passing the vector as a function argument: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(map [:chthon :phthor :beowulf :grendel] #{0 3})<br class="calibre3"/>;=&gt; (:chthon :grendel)</tt></span></blockquote><p class="calibre12">In the example, we’ve used the vector as the function to map over a set of indices, indicating its first and fourth elements by index. Clojure collections offer an interesting juxtaposition, in that not only can Clojure collections act as functions, but Clojure functions can also act as data—an idea known as <span class="italic">first-class functions</span>. </p><p id="filepos488662" class="calibre5"><span class="bold">7.1.1. First-class functions </span><a></a></p><p class="calibre7">In a programming language such as Java, there’s no notion of a standalone function.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos489663"><span class="calibre33"><span class="calibre8"><span class="underline">1</span></span></span></a><span class="calibre33">]</span></small></sup> Instead, every problem solvable by Java must be performed with the fundamental philosophy that everything is an object. This view on writing programs is therefore rooted in the idea that behaviors within a program must be either modeled as class instances or attached to them—wise or not. Clojure, on the other hand, is a functional programming language and views the problem of software development as the application of functions to data. Likewise, functions in Clojure enjoy equal standing with data—functions are first-class citizens. Before we start, we should define what makes something first-class: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos489663" class="calibre32"><span class="calibre33">1</span></small></sup><span class="calibre10"> Although the likely inclusion of closures in some future version of Java should go a long way toward invalidating this. Additionally, for those of you coming from a language such as Python, Scala, or another Lisp, the notion of a first-class function is likely not as foreign as we make it out to be. </span></blockquote><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24">It can be created on demand.</li><li value="2" class="calibre24">It can be stored in a data structure.</li><li value="3" class="calibre24">It can be passed as an argument to a function.</li><li value="4" class="calibre24">It can be returned as the value of a function.</li></ul><p class="calibre5">Those of you coming from a background in Java might find the idea of creating functions on demand analogous to the practice of creating anonymous inner classes to handle Swing events (to name only one use case). Though similar enough to start on the way toward understanding functional programming, it’s not a concept likely to bear fruit, so don’t draw conclusions from this analogy. </p><p class="calibre5"><span class="calibre10"><span class="bold">Creating Functions on Demand Using Composition </span></span></p><p class="calibre7">Even a cursory glance at Clojure is enough to confirm that its primary unit of computation is the function, be it created or composed of other functions: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def fifth (comp first rest rest rest rest))<br class="calibre3"/>(fifth [1 2 3 4 5])<br class="calibre3"/>;=&gt; 5</tt></span></blockquote><p id="filepos491321" class="calibre12">The function <tt class="calibre11">fifth</tt> wasn’t defined with <tt class="calibre11">fn</tt> or <tt class="calibre11">defn</tt> forms shown before, but instead built from existing parts using the <tt class="calibre11">comp</tt> (compose) function. But it may be more interesting to take the idea one step further by instead proving a way to build arbitrary <span class="italic">nth</span> functions<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos491876"><span class="calibre33"><span class="calibre8"><span class="underline">2</span></span></span></a><span class="calibre33">]</span></small></sup> as shown here: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos491876" class="calibre32"><span class="calibre33">2</span></small></sup><span class="calibre10"> We know that Clojure provides an nth function that works slightly differently, but in this case please indulge our obtuseness. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn fnth [n]<br class="calibre3"/>  (apply comp<br class="calibre3"/>         (cons first<br class="calibre3"/>               (take (dec n) (repeat rest)))))<br class="calibre3"/><br class="calibre3"/>((fnth 5) '[a b c d e])<br class="calibre3"/>;=&gt; e</tt></span></blockquote><p class="calibre12">The function <tt class="calibre11">fnth</tt> builds a list of the function <tt class="calibre11">rest</tt> of the appropriate length with a final <tt class="calibre11">first cons</tt>ed onto the front. This list is then fed into the <tt class="calibre11">comp</tt> function via <tt class="calibre11">apply</tt>, which takes a function and a sequence of things and effectively calls said function with the list elements as its arguments. At this point, there’s no longer any doubt that the function <tt class="calibre11">fnth</tt> builds new functions on the fly based on its arguments. Creating new functions in this way is a powerful technique, but it takes some practice to think in a compositional way. It’s relatively rare to see more than one open-parenthesis in a row like this in Clojure, but when you see it, it’s almost always because a function (such as <tt class="calibre11">fnth</tt>) is creating and returning a function that’s called immediately. A general rule of thumb is that if you need a function that applies a number of functions serially to the return of the former, then composition is a good fit: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(map (comp keyword #(.toLowerCase %) name) '(a B C))<br class="calibre3"/>;=&gt; (:a :b :c)</tt></span></blockquote><p class="calibre12">Splitting functions into smaller, well-defined pieces fosters composability and, as a result, reuse.</p><p class="calibre5"><span class="calibre10"><span class="bold">Creating Functions on Demand Using Partial Functions </span></span></p><p class="calibre7">There may be times when instead of building a new function from chains of other functions as <tt class="calibre11">comp</tt> allows, you need to build a function from the partial application of another: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">((partial + 5) 100 200)<br class="calibre3"/>;=&gt; 305</tt></span></blockquote><p class="calibre12">The function <tt class="calibre11">partial</tt> builds (<a href="#filepos1087417"><span class="calibre8"><span class="underline">Tarver 2008</span></span></a>) a new function that consists of the partial application of the single argument <tt class="calibre11">5</tt> to the addition function. When the returned partial function is passed the arguments <tt class="calibre11">100</tt> and <tt class="calibre11">200</tt>, the result is their summation plus that of the value <tt class="calibre11">5</tt>
<span class="italic">captured</span> by <tt class="calibre11">partial</tt>. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre28"><span class="calibre10"><span class="bold">Partial Application isn’t Currying</span></span></p><p class="calibre5">The use of <tt class="calibre11">partial</tt> differs from the notion of <span class="italic">currying</span> in a fundamental way. A function built with <tt class="calibre11">partial</tt> will attempt to evaluate whenever it’s given another argument. A curried function <a id="filepos495080"></a>on the other hand will return another curried function until it receives a predetermined number of arguments—only then will it evaluate. Because Clojure allows functions of variable number of arguments, currying makes little sense. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">We’ll discuss more about utilizing <tt class="calibre11">partial</tt> later in this section, but as a final point observe that <tt class="calibre11">((partial + 5) 100 200)</tt> is equivalent to <tt class="calibre11">(#(apply + 5 %&amp;) 100 200)</tt>. </p><p class="calibre5"><span class="calibre10"><span class="bold">Reversing Truth with Complement </span></span></p><p class="calibre7">One final function builder discussed here is the <tt class="calibre11">complement</tt> function. Simply put, this function takes a function that returns a truthy value and returns the opposite truthy value: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(let [truthiness (fn [v] v)]<br class="calibre3"/>  [((complement truthiness) true)<br class="calibre3"/>   ((complement truthiness) 42)<br class="calibre3"/>   ((complement truthiness) false)<br class="calibre3"/>   ((complement truthiness) nil)])<br class="calibre3"/><br class="calibre3"/>;=&gt; [false false true true]<br class="calibre3"/><br class="calibre3"/>((complement even?) 2)<br class="calibre3"/>;=&gt; false</tt></span></blockquote><p class="calibre12">Note that <tt class="calibre11">(complement even?)</tt> is equivalent to <tt class="calibre11">(comp not even?)</tt>. </p><p class="calibre5"><span class="calibre10"><span class="bold">Using Functions as Data </span></span></p><p class="calibre7">First-class functions can not only be treated as data; they <span class="italic">are</span> data. Because a function is first-class, it can be stored in a container expecting a piece of data, be it a local, a reference, collections, or anything able to store a <tt class="calibre11">java.lang.Object</tt>. This is a significant departure from Java, where methods are part of a class but don’t stand alone at runtime (<a href="#filepos1071404"><span class="calibre8"><span class="underline">Forman 2004</span></span></a>). One particularly useful method for treating functions as data is the way that Clojure’s testing framework <tt class="calibre11">clojure.test</tt> stores and validates unit tests in the metadata of a Var holding a function. These unit tests are keyed with the <tt class="calibre11">:test</tt> keyword, laid out as </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn join<br class="calibre3"/>  {:test (fn []<br class="calibre3"/>           (assert<br class="calibre3"/>             (= (join "," [1 2 3]) "1,3,3")))}<br class="calibre3"/>  [sep s]<br class="calibre3"/>  (apply str (interpose sep s)))</tt></span></blockquote><p class="calibre12">We’ve modified our old friend <tt class="calibre11">join</tt> by attaching some metadata containing a <span class="italic">faulty</span> unit test. Of course, by that we mean that the attached unit test is meant to fail in this case. The <tt class="calibre11">clojure.test/run-tests</tt> function is useful for running attached unit tests in the current namespace: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(use '[clojure.test :as t])<br class="calibre3"/>(t/run-tests)<br class="calibre3"/>; Testing user<br class="calibre3"/>;<br class="calibre3"/>; ERROR in (join) (test.clj:646)<br class="calibre3"/>; ...<br class="calibre3"/>; actual: java.lang.AssertionError:<br class="calibre3"/>;  Assert failed: (= (join "," [1 2 3]) "1,3,3")<br class="calibre3"/>; ...</tt></span></blockquote><p id="filepos498369" class="calibre12">As expected, the faulty unit test for <tt class="calibre11">join</tt> failed. Unit tests in Clojure only scratch the surface of the boundless spectrum of examples using functions as data, but for now they’ll do, as we move into the notion of higher-order functions. </p><p id="filepos498652" class="calibre5"><span class="bold">7.1.2. Higher-order functions </span><a></a></p><p class="calibre7">A <span class="italic">higher-order function</span> is a function that does at least one of the following: </p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24">Takes one or more functions as arguments</li><li value="2" class="calibre24">Returns a function as a result</li></ul><p class="calibre5">A Java programmer might be familiar with the practices of subscriber patterns or schemes using more general-purpose callback objects. There are scenarios such as these where Java treats objects like functions, but as with anything in Java, you’re really dealing with objects containing privileged methods. </p><p class="calibre5"><span class="calibre10"><span class="bold">Functions as Arguments </span></span></p><p class="calibre7">In this book, we’ve used and advocated the use of the sequence functions <tt class="calibre11">map</tt>, <tt class="calibre11">reduce</tt>, and <tt class="calibre11">filter</tt>—all of which expect a function argument that’s applied to the elements of the sequence arguments. The use of functions in this way is ubiquitous in Clojure and can make for truly elegant solutions. Let’s look at a simple example of a function that takes a sequence of maps and a function working on each, and returns a sequence sorted by the results of the function. The implementation in Clojure is straightforward and clean: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def plays [{:band "Burial",     :plays 979,  :loved 9}<br class="calibre3"/>            {:band "Eno",        :plays 2333, :loved 15}<br class="calibre3"/>            {:band "Bill Evans", :plays 979,  :loved 9}<br class="calibre3"/>            {:band "Magma",      :plays 2665, :loved 31}])<br class="calibre3"/><br class="calibre3"/>(def sort-by-loved-ratio (partial sort-by #(/ (:plays %) (:loved %))))</tt></span></blockquote><p class="calibre12">The function with the overly descriptive name <tt class="calibre11">sort-by-loved-ratio</tt> is built from the partial application of the function <tt class="calibre11">sort-by</tt> and an anonymous function dividing the <tt class="calibre11">:plays</tt> field by the <tt class="calibre11">:loved</tt> field. This is a simple solution to the problem presented, and its usage is equally so: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(sort-by-loved-ratio plays)<br class="calibre3"/>;=&gt; ({:band "Magma",         :plays 2665, :loved 31}<br class="calibre3"/>     {:band "Burial",        :plays 979,  :loved 9}<br class="calibre3"/>     {:band "Bill Evans",    :plays 979,  :loved 9}<br class="calibre3"/>     {:band "Eno",           :plays 2333, :loved 15})</tt></span></blockquote><p class="calibre12">We intentionally used the additional higher-order function <tt class="calibre11">sort-by</tt> to avoid reimplementing core functions and instead <span class="italic">build our program from existing parts</span>. You should strive for the same whenever possible. </p><p class="calibre5"><span class="calibre10"><span class="bold">Functions as Return Values </span></span></p><p id="filepos501688" class="calibre7">We’ve already used functions returning functions in this chapter with <tt class="calibre11">comp</tt>, <tt class="calibre11">partial</tt>, and <tt class="calibre11">complement</tt>, but you could build functions that do the same. We’ll extend the earlier example to provide a function that sorts rows based on some number of column values. This is similar to the way that spreadsheets operate, in that you can sort on a primary column while falling back on a secondary column to provide the sort order on matching results in the primary. This behavior is typically performed along any number of columns, cascading down from the primary column to the last; each subgroup is sorted appropriately, as the expected result illustrates: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(sort-by (columns [:plays :loved :band]) plays)<br class="calibre3"/>;=&gt; ({:band "Bill Evans", :plays 979,  :loved 9}<br class="calibre3"/>     {:band "Burial",     :plays 979,  :loved 9}<br class="calibre3"/>     {:band "Eno",        :plays 2333, :loved 15}<br class="calibre3"/>     {:band "Magma",      :plays 2665, :loved 31})</tt></span></blockquote><p class="calibre12">This kind of behavior sounds complex on the surface but is shockingly simple<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos503161"><span class="calibre33"><span class="calibre8"><span class="underline">3</span></span></span></a><span class="calibre33">]</span></small></sup> in its Clojure implementation: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos503161" class="calibre32"><span class="calibre33">3</span></small></sup><span class="calibre10"> Strictly speaking, the implementation of </span><span class="calibre10"><tt class="calibre11">columns</tt></span><span class="calibre10"> should use </span><span class="calibre10"><tt class="calibre11">#(% row)</tt></span><span class="calibre10"> instead of just </span><span class="calibre10"><tt class="calibre11">row</tt></span><span class="calibre10">, because we can’t always assume that the row is implemented as a map (a record might be used instead) and therefore directly usable as a function. Records will be discussed further in </span><a href="#filepos582816"><span class="calibre10"><span class="calibre8"><span class="underline">chapter 8</span></span></span></a><span class="calibre10">. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn columns [column-names]<br class="calibre3"/>  (fn [row]<br class="calibre3"/>    (vec (map row column-names))))</tt></span></blockquote><p class="calibre12">Running the preceding expression shows that the rows for <tt class="calibre11">Burial</tt> and <tt class="calibre11">Bill Evans</tt> have a tertiary column sorting. The function <tt class="calibre11">columns</tt> returns another function expecting a map. This return function is then supplied to <tt class="calibre11">sort-by</tt> to provide the value on which the <tt class="calibre11">plays</tt> vector would be sorted. Perhaps you see a familiar pattern: we apply the <tt class="calibre11">column-names</tt> vector as a function across a set of indices, building a sequence of its elements <span class="italic">at</span> those indices. This action will return a sequence of the values of that row for the supplied column names, which is then turned into a vector so that it can then be used as the sorting function,<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos504913"><span class="calibre33"><span class="calibre8"><span class="underline">4</span></span></span></a><span class="calibre33">]</span></small></sup> as structured here: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos504913" class="calibre32"><span class="calibre33">4</span></small></sup><span class="calibre10"> Because </span><span class="calibre10"><tt class="calibre11">sort-by</tt></span><span class="calibre10"> is higher-order, it naturally expects a function argument. As mentioned, vectors can also be used as functions. However, as we will discuss in detail in </span><a href="#filepos783802"><span class="calibre10"><span class="calibre8"><span class="underline">section 10.4</span></span></span></a><span class="calibre10">, all closure functions implement the </span><span class="calibre10"><tt class="calibre11">java.util.Comparator</tt></span><span class="calibre10"> interface, which in this case is the driving force behind the sorting logic behind </span><span class="calibre10"><tt class="calibre11">sort-by</tt></span><span class="calibre10">! </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(vec (map (plays 0) [:plays :loved :band]))<br class="calibre3"/>;=&gt; [979 9 "Burial"]</tt></span></blockquote><p class="calibre12">This resulting vector is then used by <tt class="calibre11">sort-by</tt> to provide the final ordering. </p><p class="calibre5">Building your programs using first-class functions in concert with higher-order functions will reduce complexities and make your codebase more robust and extensible. In the next subsection, we’ll explore pure functions, which all prior functions in this section have been, and explain why your own applications should strive toward purity. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">Prefer higher-order functions when processing sequences</span>
</p><p id="filepos506447" class="calibre7">We mentioned in <a href="#filepos449135"><span class="calibre8"><span class="underline">section 6.3</span></span></a> that one way to ensure that lazy sequences are never fully realized in memory is to prefer (<a href="#filepos1075994"><span class="calibre8"><span class="underline">Hutton 1999</span></span></a>) higher-order functions for processing. Most collection processing can be performed with some combination of the following functions: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">map, reduce, filter, for, some, repeatedly, sort-by, keep take-while, and drop-while</tt></span></blockquote><p class="calibre12">But higher-order functions aren’t a panacea for every solution. Therefore, we’ll cover the topic of recursive solutions deeper in <a href="#filepos543109"><span class="calibre8"><span class="underline">section 7.3</span></span></a> for those cases when higher-order functions fail or are less than clear. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p id="filepos507465" class="calibre35"><span class="bold">7.1.3. Pure functions </span><a></a></p><p class="calibre7">Simply put, <span class="italic">pure functions</span> are regular functions that, through convention, conform to the following simple guidelines: </p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24">The function <span class="italic">always</span> returns the same result, given some expected arguments. </li><li value="2" class="calibre24">The function doesn’t cause any <span class="italic">observable</span> side-effects. </li></ul><p class="calibre5">Though Clojure is designed to minimize and isolate side-effects, it’s by no means a purely functional language. But there are a number of reasons why you’d want to build as much of your system as possible from pure functions, and we’ll enumerate a few presently. </p><p class="calibre5"><span class="calibre10"><span class="bold">Referential Transparency </span></span></p><p class="calibre7">If a function of some arguments always results in the same value and changes no other values within the greater system, then it’s essentially a constant, or referentially transparent (the reference to the function is transparent to time). Take a look at pure function <tt class="calibre11">keys-apply</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn keys-apply [f ks m]<br class="calibre3"/>  "Takes a function, a set of keys, and a map and applies the function<br class="calibre3"/>   to the map on the given keys.  A new map of the results of the function<br class="calibre3"/>   applied to the keyed entries is returned."<br class="calibre3"/>  (let [only (select-keys m ks)]<br class="calibre3"/>    (zipmap (keys only) (map f (vals only)))))<br class="calibre3"/><br class="calibre3"/>(keys-apply #(.toUpperCase %) #{:band} (plays 0))<br class="calibre3"/>;=&gt; {:band "BURIAL"}</tt></span></blockquote><p class="calibre12">Using another pure function <tt class="calibre11">manip-map</tt>, we can then manipulate a set of keys based on a given function: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn manip-map [f ks m]<br class="calibre3"/>  "Takes a function, a set of keys, and a map and applies<br class="calibre3"/>   the function to the map on the given keys.  A modified<br class="calibre3"/>   version of the original map is returned with the results<br class="calibre3"/>   of the function applied to each keyed entry."<br class="calibre3"/>  (conj m (keys-apply f ks m)))<br class="calibre3"/>(manip-map #(int (/ % 2)) #{:plays :loved} (plays 0))<br class="calibre3"/>;=&gt; {:band "Burial", :plays 489, :loved 4}</tt></span></blockquote><p id="filepos510009" class="calibre12">The functions <tt class="calibre11">keys-apply</tt> and <tt class="calibre11">manip-map</tt> are both<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos510744"><span class="calibre33"><span class="calibre8"><span class="underline">5</span></span></span></a><span class="calibre33">]</span></small></sup> pure functions, illustrated by the fact that you can replace them in the context of a larger program with their expected return values and not change the outcome. Pure functions exist outside the bounds of time. But if you make either <tt class="calibre11">keys-apply</tt> or <tt class="calibre11">manip-map</tt> reliant on anything but its arguments or generate a side-effect within, then referential transparency dissolves. We’ll add one more function to illustrate this: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos510744" class="calibre32"><span class="calibre33">5</span></small></sup><span class="calibre10"> These functions are based on a similar implementation created by Steven Gilardi. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn halve! [ks]<br class="calibre3"/>  (map (partial manip-map #(int (/ % 2)) ks) plays))<br class="calibre3"/><br class="calibre3"/>(halve! [:plays])<br class="calibre3"/>;=&gt; ({:band "Burial", :plays 489, :loved 9}<br class="calibre3"/>     {:band "Eno", :plays 1166, :loved 15}<br class="calibre3"/>     {:band "Bill Evans", :plays 489, :loved 9}<br class="calibre3"/>     {:band "Magma", :plays 1332, :loved 31})</tt></span></blockquote><p class="calibre12">The function <tt class="calibre11">halve!</tt> works against the global <tt class="calibre11">plays</tt> and is no longer limited to generating results solely from its arguments. Because <tt class="calibre11">plays</tt> could change at any moment, there’s no guarantee that <tt class="calibre11">halve!</tt> would return the same value given any particular argument. </p><p class="calibre5"><span class="calibre10"><span class="bold">Optimization </span></span></p><p class="calibre7">If a function is referentially transparent, then it can more easily be optimized using techniques such as memoization (discussed in <a href="#filepos952602"><span class="calibre8"><span class="underline">chapter 12</span></span></a>) and algebraic manipulations (<a href="#filepos1083738"><span class="calibre8"><span class="underline">Wadler 1989</span></span></a>). </p><p class="calibre5"><span class="calibre10"><span class="bold">Testability </span></span></p><p class="calibre7">If a function is referentially transparent, then it’s easier to reason about and therefore more straightforward to test. Building <tt class="calibre11">halve!</tt> as an impure function forces the need to test against the possibility that <tt class="calibre11">plays</tt> could change at any time, complicating matters substantially. Imagine the confusion should you add further impure functions based on further external transient values. </p><p id="filepos512620" class="calibre5"><span class="bold">7.1.4. Named arguments </span><a></a></p><p class="calibre7">Some programming languages allow functions to take named arguments; Python is one such language, as seen here:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">def slope(p1=(0,0), p2=(1,1)):<br class="calibre3"/>    return (float(p2[1] - p1[1])) / (p2[0] - p1[0])<br class="calibre3"/><br class="calibre3"/>slope((4,15), (3,21))<br class="calibre3"/>#=&gt; -6.0<br class="calibre3"/><br class="calibre3"/>slope(p2=(2,1))<br class="calibre3"/>#=&gt; 0.5<br class="calibre3"/><br class="calibre3"/>slope()<br class="calibre3"/>#=&gt; 1.0</tt></span></blockquote><p id="filepos513175" class="calibre12">The Python function <tt class="calibre11">slope</tt> calculates the slope of a line given two tuples defining points on a line. The tuples <tt class="calibre11">p1</tt> and <tt class="calibre11">p2</tt> are defined as named parameters, allowing either or both to be omitted in favor of default values, or passed in any order as a named parameter. Clojure provides a similar feature using its destructuring mechanism coupled with the optional arguments flag <tt class="calibre11">&amp;</tt>. The same function would be written using Clojure’s named arguments as in the following listing. </p><p id="filepos513725" class="calibre5"><span class="calibre10"><span class="bold">Listing 7.1. Named arguments in Clojure functions </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn slope<br class="calibre3"/>  [&amp; {:keys [p1 p2] :or {p1 [0 0] p2 [1 1]}}]<br class="calibre3"/>  (float (/ (- (p2 1) (p1 1))<br class="calibre3"/>            (- (p2 0) (p1 0)))))<br class="calibre3"/><br class="calibre3"/>(slope :p1 [4 15] :p2 [3 21])<br class="calibre3"/>;=&gt; -6.0<br class="calibre3"/><br class="calibre3"/>(slope :p2 [2 1])<br class="calibre3"/>;=&gt; 0.5<br class="calibre3"/><br class="calibre3"/>(slope)<br class="calibre3"/>;=&gt; 1.0</tt></span></blockquote><p class="calibre12">Clojure’s named arguments are built on the destructuring mechanism outlined in <a href="#filepos248450"><span class="calibre8"><span class="underline">section 3.3</span></span></a>, allowing much richer ways to declare them. </p><p id="filepos514516" class="calibre5"><span class="bold">7.1.5. Constraining functions with pre- and postconditions </span><a></a></p><p class="calibre7">Every function in Clojure can potentially be constrained on its inputs, its output, and some arbitrary relationship between them. These constraints take the form of preand postcondition vectors contained in a map defined in the function body. We can simplify the <tt class="calibre11">slope</tt> function to the base case to more clearly illustrate the matter of constraints: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn slope [p1 p2]<br class="calibre3"/>  {:pre [(not= p1 p2) (vector? p1) (vector? p2)]<br class="calibre3"/>   :post [(float? %)]}<br class="calibre3"/>  (/ (- (p2 1) (p1 1))<br class="calibre3"/>     (- (p2 0) (p1 0))))</tt></span></blockquote><p class="calibre12">The constraint map defines two entries: <tt class="calibre11">:pre</tt> constraining the input parameters and <tt class="calibre11">:post</tt> the return value. The function calls in the constraint vectors are all expected to return true for the constraints to pass (via logical and). In the case of the revised <tt class="calibre11">slope</tt> function, the input constraints are that the points must not be equal, and they must both be vectors. In the postcondition, the constraint is that the return result must be a floating-point value. We run through a few scenarios in the following listing to see how the new implementation works. </p><p id="filepos515915" class="calibre5"><span class="calibre10"><span class="bold">Listing 7.2. Testing the slope function constraints </span></span><a></a></p><p class="calibre1"><img src="images/00036.jpg" class="calibre64"/></p><p id="filepos516152" class="calibre5">Clojure also provides a simple assertion macro that can be used to emulate some pre- and postconditions. Using <tt class="calibre11">assert</tt> instead of <tt class="calibre11">:pre</tt> is typically fairly straightforward. But using <tt class="calibre11">assert</tt> instead of <tt class="calibre11">:post</tt> is cumbersome and awkward. On the contrary, restricting yourself to constraint maps will cover most of the expected cases covered by <tt class="calibre11">assert</tt>, which can be used to fill in the remaining holes (such as loop invariants). In any case, constraint maps provide standard hooks into the assertion machinery of Clojure, while using <tt class="calibre11">assert</tt> is by its nature ad hoc. Yet another advantage for <tt class="calibre11">:pre</tt> and <tt class="calibre11">:post</tt> is that they allow the assertions to come from a different source than the body of the function, which we’ll address next. </p><p class="calibre5"><span class="calibre10"><span class="bold">Decoupling Assertions from Functions </span></span></p><p class="calibre7">The implementation of <tt class="calibre11">slope</tt> corresponds to a well-established mathematic property. As a result, it makes perfect sense to tightly couple the constraints and the work to be done to perform the calculation. But not all functions are as well-defined as <tt class="calibre11">slope</tt>, and therefore could benefit from some flexibility in their constraints. Imagine a function that takes a map, puts some keys into it, and returns the new map, defined as </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn put-things [m]<br class="calibre3"/>  (into m {:meat "beef" :veggie "broccoli"}))<br class="calibre3"/><br class="calibre3"/>(put-things {})<br class="calibre3"/>;=&gt; {:meat "beef", :veggie "broccoli"}</tt></span></blockquote><p class="calibre12">How would you add constraints to <tt class="calibre11">put-things</tt>? You could add them directly to the function definition, but the consumers of the map might have differing requirements for the entries added. Instead, observe how we can abstract the constraints into another function: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn vegan-constraints [f m]<br class="calibre3"/>  {:pre [(:veggie m)]<br class="calibre3"/>   :post [(:veggie %) (nil? (:meat %))]}<br class="calibre3"/>  (f m))<br class="calibre3"/><br class="calibre3"/>(vegan-constraints put-things {:veggie "carrot"})<br class="calibre3"/>; java.lang.AssertionError: Assert failed: (nil? (:meat %))</tt></span></blockquote><p class="calibre12">The <tt class="calibre11">vegan-constraints</tt> function applies specific constraints to an incoming function, stating that the map coming in and going out should have some kind of veggie and <a id="filepos518685"></a>should never have meat in the result. The beauty of this scheme is that you can create contextual constraints based on the appropriate expected results, as shown next. </p><p id="filepos518864" class="calibre5"><span class="calibre10"><span class="bold">Listing 7.3. Menu constraints </span></span><a></a></p><p class="calibre1"><img src="images/00037.jpg" class="calibre65"/></p><p class="calibre5">By pulling out the assertions into a wrapper function, we’ve detached some domain-specific requirements from a potentially globally useful function and isolated them in <span class="italic">aspects</span> (<a href="#filepos1077703"><span class="calibre8"><span class="underline">Laddad 2003</span></span></a>). By detaching pre- and postconditions from the functions themselves, you can mix in any implementation that you please, knowing that as long as it fulfills the contract (<a href="#filepos1078651"><span class="calibre8"><span class="underline">Meyer 1991</span></span></a>), its interposition is transparent. This is only the beginning of the power of Clojure’s pre- and postconditions, and we’ll come back to it a few times more to see how it can be extended and utilized. </p><p class="calibre5">Now that we’ve covered some of the powerful features available via Clojure’s functions, we’ll take a step further by exploring lexical closures. </p><p id="filepos519998" class="calibre5"><span class="calibre18"><span class="bold">7.2. Closures </span></span></p><blockquote class="calibre9"><span class="italic">On his next walk with Qc Na, Anton attempted to impress his master by saying “Master, I have diligently studied the matter, and now understand that objects are truly a poor man’s closures.” Qc Na responded by hitting Anton with his stick, saying “When will you learn? Closures are a poor man’s object.” At that moment, Anton became enlightened.</span></blockquote><blockquote class="calibre25"><span class="italic">Part of a parable by Anton van Straaten</span></blockquote><p class="calibre5">It took only 30 years, but closures (<a href="#filepos1082513"><span class="calibre8"><span class="underline">Sussman 1975</span></span></a>) are now a key feature of mainstream programming languages—Perl and Ruby support them, and JavaScript derives much of what power it has from closures. So what’s a closure? In a sentence, a <span class="italic">closure</span> is a function that has access to locals from a larger scope, namely the context in which it was defined: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def times-two<br class="calibre3"/>  (let [x 2]<br class="calibre3"/>    (fn [y] (* y x))))</tt></span></blockquote><p class="calibre12">The <tt class="calibre11">fn</tt> form defines a function and uses <tt class="calibre11">def</tt> to store it in a Var named <tt class="calibre11">times-two</tt>. The <tt class="calibre11">let</tt> forms a lexical scope in which the function was defined, so the function gains access to all the locals in that lexical context. That’s what makes this function a closure: it uses the local <tt class="calibre11">x</tt> that was defined <span class="italic">outside</span> the body of the function, and so the <a id="filepos521637"></a>local and its value become a property of the function itself. The function is said to <span class="italic">close over</span> the local<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos521998"><span class="calibre33"><span class="calibre8"><span class="underline">6</span></span></span></a><span class="calibre33">]</span></small></sup><tt class="calibre11">x</tt>, as in the following example: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos521998" class="calibre32"><span class="calibre33">6</span></small></sup><span class="calibre10"> Locals like </span><span class="calibre10"><tt class="calibre11">x</tt></span><span class="calibre10"> in this example are sometimes called </span><span class="calibre10"><span class="italic">free variables</span></span><span class="calibre10">. We don’t use the term because Clojure locals are immutable. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(times-two 5)<br class="calibre3"/>;=&gt; 10</tt></span></blockquote><p class="calibre12">This isn’t terribly interesting, but one way to make a more exciting closure is to have it close over something mutable:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def add-and-get<br class="calibre3"/>  (let [ai (java.util.concurrent.atomic.AtomicInteger.)]<br class="calibre3"/>    (fn [y] (.addAndGet ai y))))<br class="calibre3"/><br class="calibre3"/>(add-and-get 2)<br class="calibre3"/>;=&gt; 2<br class="calibre3"/>(add-and-get 2)<br class="calibre3"/>;=&gt; 4<br class="calibre3"/>(add-and-get 7)<br class="calibre3"/>;=&gt; 11</tt></span></blockquote><p class="calibre12">The <tt class="calibre11">java.util.concurrent.atomic.AtomicInteger</tt> class simply holds an integer value, and its <tt class="calibre11">.addAndGet</tt> method adds to its value, stores the result, and also returns the result. The function <tt class="calibre11">add-and-get</tt> is holding onto the same instance of <tt class="calibre11">Atomic-Integer</tt>, and each time it’s called, the value of that instance is modified. Unlike the earlier <tt class="calibre11">times-two</tt> function, this one can’t be rewritten with the local <tt class="calibre11">ai</tt> defined inside the function. If you tried, each time the function was called, it would create a new instance with a default value of 0 to be created and stored in <tt class="calibre11">ai</tt>—clearly not what should happen. A point of note about this technique is that when closing over something mutable, you run the risk of making your functions impure and thus more difficult to test and reason about, especially if the mutable local is shared. </p><p id="filepos523866" class="calibre5"><span class="bold">Functions Returning Closures </span></p><p class="calibre7">Each of the previous examples created a single closure, but by wrapping similar code in another function definition, you can create more closures on demand. For example, we could take the earlier <tt class="calibre11">times-two</tt> example and generalize it to take an argument instead of using <tt class="calibre11">2</tt> directly: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn times-n [n]<br class="calibre3"/>  (let [x n]<br class="calibre3"/>    (fn [y] (* y x))))</tt></span></blockquote><p class="calibre12">We’ve covered functions returning functions before, but if you’re not already familiar with closures, this may be a stretch. We now have an outer function stored in a Var named <tt class="calibre11">times-n</tt>—note we’ve used <tt class="calibre11">defn</tt> instead of <tt class="calibre11">def</tt>. When <tt class="calibre11">times-n</tt> is called with an argument, it’ll return a new closure created by the <tt class="calibre11">fn</tt> form and closing over the local <tt class="calibre11">x</tt>. The value of <tt class="calibre11">x</tt> for this closure will be whatever was passed in to <tt class="calibre11">times-n</tt>. Thus when we call this returned closure with an argument of its own, it’ll return the value of <tt class="calibre11">y</tt> times <tt class="calibre11">x</tt>, as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(times-n 4)<br class="calibre3"/>;=&gt; #&lt;user$times_n$fn__39 user$times_n$fn__39@427be8c2&gt;</tt></span></blockquote><p id="filepos525267" class="calibre12">Viewing the function form for this closure isn’t too useful, so instead we can store it in a Var, allowing us to call it by a friendlier name such as <tt class="calibre11">times-four</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def times-four (times-n 4))</tt></span></blockquote><p class="calibre12">Here we’re using <tt class="calibre11">def</tt> again simply to store what <tt class="calibre11">times-n</tt> returns—a closure over the number 4: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(times-four 10)<br class="calibre3"/>;=&gt; 40</tt></span></blockquote><p class="calibre12">Note that when calling the closure stored in <tt class="calibre11">times-four</tt>, it used the local it had closed over as well as the argument in the call. </p><p id="filepos526022" class="calibre5"><span class="bold">Closing Over Parameters </span></p><p class="calibre7">In our definition of <tt class="calibre11">times-n</tt>, we created a local <tt class="calibre11">x</tt> using <tt class="calibre11">let</tt> and closed over that instead of closing over the argument <tt class="calibre11">n</tt> directly. But this was only to help focus the discussion on other parts of the function. In fact, closures close over parameters of outer functions in exactly the same way as they do over <tt class="calibre11">let</tt> locals. Thus <tt class="calibre11">times-n</tt> could be defined without any <tt class="calibre11">let</tt> at all: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn times-n [n]<br class="calibre3"/>  (fn [y] (* y n)))</tt></span></blockquote><p class="calibre12">All of the preceding examples would work exactly the same. Here’s another function that creates and returns a closure in a similar way. Note again that the inner function maintains access to the outer parameter even after the outer function has returned: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn divisible [denom]<br class="calibre3"/>  (fn [num]<br class="calibre3"/>    (zero? (rem num denom))))</tt></span></blockquote><p class="calibre12">We don’t have to store a closure in a Var, but can instead create one and call it immediately:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">((divisible 3) 6)<br class="calibre3"/>;=&gt; true<br class="calibre3"/><br class="calibre3"/>((divisible 3) 7)<br class="calibre3"/>;=&gt; false</tt></span></blockquote><p class="calibre12">Instead of storing or calling a closure, a particular need is best served by passing a closure along to another function that will use it. </p><p id="filepos527635" class="calibre5"><span class="bold">Passing Closures as Functions </span></p><p class="calibre7">We’ve shown many examples in previous chapters of higher-order functions built in to Clojure’s core libraries. What we’ve glossed over so far is that anywhere a function is expected, a closure can be used instead. This has dramatic consequences for how powerful these functions can be. </p><p id="filepos528029" class="calibre5">For example, <tt class="calibre11">filter</tt> takes a function (called a <span class="italic">predicate</span> in this case) and a sequence, applies the predicate to each value of the sequence,<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos528607"><span class="calibre33"><span class="calibre8"><span class="underline">7</span></span></span></a><span class="calibre33">]</span></small></sup> and returns a sequence of the just the values for which the predicate returned something truthy. A simple example of its use would be to return only the even numbers from a sequence of numbers: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos528607" class="calibre32"><span class="calibre33">7</span></small></sup><span class="calibre10"> Please don’t construe from this wording that </span><span class="calibre10"><tt class="calibre11">filter</tt></span><span class="calibre10"> always iterates through the whole input sequence. Like most of the seq library, it’s lazy and only consumes as much of the input sequence as needed to produce the values demanded of it. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(filter even? (range 10))<br class="calibre3"/>;=&gt; (0 2 4 6 8)</tt></span></blockquote><p class="calibre12">Note that <tt class="calibre11">filter</tt> only ever passes a single argument to the predicate given it. Without closures, this might be restrictive, but with them we can simply close over the values needed: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(filter (divisible 4) (range 10))<br class="calibre3"/>;=&gt; (0 4 8)</tt></span></blockquote><p class="calibre12">It’s common to define a closure right on the spot where it’s used, closing over whatever local-context is needed, as shown:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn filter-divisible [denom s]<br class="calibre3"/>  (filter (fn [num] (zero? (rem num denom))) s))<br class="calibre3"/><br class="calibre3"/>(filter-divisible 4 (range 10))<br class="calibre3"/>;=&gt; (0 4 8)</tt></span></blockquote><p class="calibre12">This kind of on-the-spot anonymous function definition is desired frequently enough that Clojure spends a little of its small syntax budget on the reader feature to make such cases more succinct. This <tt class="calibre11">#()</tt> form was first introduced in <a href="#filepos163683"><span class="calibre8"><span class="underline">chapter 2</span></span></a>, and in this case could be used to write the definition of <tt class="calibre11">filter-divisible</tt> as </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn filter-divisible [denom s]<br class="calibre3"/>  (filter #(zero? (rem % denom)) s))<br class="calibre3"/><br class="calibre3"/>(filter-divisible 5 (range 20))<br class="calibre3"/>;=&gt; (0 5 10 15)</tt></span></blockquote><p class="calibre12">Though certainly more succinct than the extended anonymous function form and the earlier example using a separate <tt class="calibre11">divisible</tt> function with <tt class="calibre11">filter</tt>, there’s a fine line to balance between reuse<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos531138"><span class="calibre33"><span class="calibre8"><span class="underline">8</span></span></span></a><span class="calibre33">]</span></small></sup> and clarity. Thankfully, in any case the performance differences among the three choices are nominal. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos531138" class="calibre32"><span class="calibre33">8</span></small></sup><span class="calibre10"> By hiding </span><span class="calibre10"><tt class="calibre11">divisible</tt></span><span class="calibre10"> as an anonymous function inside </span><span class="calibre10"><tt class="calibre11">filter-divisible</tt></span><span class="calibre10">, we reduce the reusability of this code with no real benefit. Anonymous functions are best reserved for when the lexical context being closed over is more complex or the body of the function too narrow in use to warrant being its own named function. </span></blockquote><p id="filepos531643" class="calibre35"><span class="bold">Sharing Closure Context </span></p><p class="calibre7">So far, the closures we’ve shown have stood alone, but it’s sometimes useful to have multiple closures closing over the same values. This may take the form of an ad hoc set of closures in a complex lexical environment, such as event callbacks or timer handlers in a nested GUI builder. Or it may be a tidy, specifically designed bundle of values and related functions—something that can be thought of as an object. </p><p id="filepos532161" class="calibre5">To demonstrate this, we’ll build a robot object that has functions for moving it around a grid based on its current position and bearing. For this we need a list of coordinate deltas for compass bearings, starting with north and going clockwise: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def bearings [{:x  0, :y  1}    ; north<br class="calibre3"/>               {:x  1, :y  0}    ; east<br class="calibre3"/>               {:x  0, :y -1}    ; south<br class="calibre3"/>               {:x -1, :y  0}])  ; west</tt></span></blockquote><p class="calibre12">Note that this is on a grid where y increases as you go north and x increases as you go east—mathematical coordinate style rather than spreadsheet cells. </p><p class="calibre5">With this in place, it’s easy to write a function <tt class="calibre11">forward</tt> that takes a coordinate and a bearing, and returns a new coordinate having moved forward one step in the direction of the bearing: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn forward [x y bearing-num]<br class="calibre3"/>  [(+ x (:x (bearings bearing-num)))<br class="calibre3"/>   (+ y (:y (bearings bearing-num)))])</tt></span></blockquote><p class="calibre12">Starting with a bearing of 0 (north) at 5,5 and going one step brings the bot to 5,6:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(forward 5 5 0)<br class="calibre3"/>;=&gt; [5 6]</tt></span></blockquote><p class="calibre12">We can also try starting at 5,5 and with bearing 1 (east) or bearing 2 (south) and see the desired results:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(forward 5 5 1)<br class="calibre3"/>;=&gt; [6 5]<br class="calibre3"/><br class="calibre3"/>(forward 5 5 2)<br class="calibre3"/>;=&gt; [5 4]</tt></span></blockquote><p class="calibre12">But we have no closures yet, so we’ll build a bot object that keeps not just its coordinates, but also its bearing. In the process, we’ll move this standalone <tt class="calibre11">forward</tt> function into the bot object itself. By making this a closure, we’ll also open up possibilities for polymorphism later. So here’s a bot that knows how to move itself forward: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn bot [x y bearing-num]<br class="calibre3"/>  {:coords  [x y]<br class="calibre3"/>   :bearing ([:north :east :south :west] bearing-num)<br class="calibre3"/>   :forward (fn [] (bot (+ x (:x (bearings bearing-num)))<br class="calibre3"/>                        (+ y (:y  (bearings bearing-num)))<br class="calibre3"/>                        bearing-num))})</tt></span></blockquote><p class="calibre12">We can create an instance of this bot and query it for its coordinates or its bearing:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(:coords (bot 5 5 0))<br class="calibre3"/>;=&gt; [5 5]<br class="calibre3"/><br class="calibre3"/>(:bearing (bot 5 5 0))<br class="calibre3"/>;=&gt; :north</tt></span></blockquote><p class="calibre12">But now that we’ve moved the <tt class="calibre11">forward</tt> function inside, we no longer pass in parameters, because it gets everything it needs to know from the state of the bot that it closes <a id="filepos535370"></a>over. Instead, we use <tt class="calibre11">:forward</tt> to fetch the closure from inside the bot object and then use an extra set of parentheses to invoke it with no arguments: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(:coords ((:forward (bot 5 5 0))))<br class="calibre3"/>;=&gt; [5 6]</tt></span></blockquote><p class="calibre12">So now we have a somewhat complicated beastie but still only a single closure in the mix. To make things more interesting, we’ll add <tt class="calibre11">turn-left</tt> and <tt class="calibre11">turn-right<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos536168"><span class="calibre33"><span class="calibre8"><span class="underline">9</span></span></span></a><span class="calibre33">]</span></small></sup></tt> functions, and store them right there in the object with <tt class="calibre11">:forward</tt>: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos536168" class="calibre32"><span class="calibre33">9</span></small></sup><span class="calibre10"> The </span><span class="calibre10"><tt class="calibre11">:turn-right</tt></span><span class="calibre10"> function uses </span><span class="calibre10"><tt class="calibre11">(+ 1 foo</tt></span><span class="calibre10">), even though in general </span><span class="calibre10"><tt class="calibre11">(inc foo)</tt></span><span class="calibre10"> would be more idiomatic. Here it helps highlight to anyone reading the symmetry between </span><span class="calibre10"><tt class="calibre11">turn-right</tt></span><span class="calibre10"> and </span><span class="calibre10"><tt class="calibre11">turn-left</tt></span><span class="calibre10">. In this case, using </span><span class="calibre10"><tt class="calibre11">+</tt></span><span class="calibre10"> is more readable than using </span><span class="calibre10"><tt class="calibre11">inc</tt></span><span class="calibre10"> and so is preferred. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn bot [x y bearing-num]<br class="calibre3"/>  {:coords     [x y]<br class="calibre3"/>   :bearing    ([:north :east :south :west] bearing-num)<br class="calibre3"/>   :forward    (fn [] (bot (+ x (:x (bearings bearing-num)))<br class="calibre3"/>                           (+ y (:y (bearings bearing-num)))<br class="calibre3"/>                           bearing-num))<br class="calibre3"/>   :turn-right (fn [] (bot x y (mod (+ 1 bearing-num) 4)))<br class="calibre3"/>   :turn-left  (fn [] (bot x y (mod (- 1 bearing-num) 4)))})<br class="calibre3"/><br class="calibre3"/>(:bearing ((:forward ((:forward ((:turn-right (bot 5 5 0))))))))<br class="calibre3"/>;=&gt; :east<br class="calibre3"/><br class="calibre3"/>(:coords ((:forward ((:forward ((:turn-right (bot 5 5 0))))))))<br class="calibre3"/>;=&gt; [7 5]</tt></span></blockquote><p class="calibre12">We won’t talk about the verbosity of using the bot object yet, and instead focus on the features leveraged in the definition of <tt class="calibre11">bot</tt> itself. We’re freely mixing values computed when a bot is created (such as the <tt class="calibre11">:bearing</tt>) and functions that create values when called later. The functions are in fact closures, and each has full access to the lexical environment. The fact that there are multiple closures sharing the same environment isn’t awkward or unnatural and flows easily from the properties of closures already shown. </p><p class="calibre5">We’d like to demonstrate one final feature of this pattern for building objects: polymorphism. For example, here’s the definition of a bot that supports all of the same usage as earlier, but this one has its wires crossed or perhaps is designed to work sensibly in Alice’s Wonderland. When told to go forward it instead reverses, and it turns left instead of right and vice versa: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn mirror-bot [x y bearing-num]<br class="calibre3"/>  {:coords     [x y]<br class="calibre3"/>   :bearing    ([:north :east :south :west] bearing-num)<br class="calibre3"/>   :forward    (fn [] (mirror-bot (- x (:x (bearings bearing-num)))<br class="calibre3"/>                                  (- y (:y (bearings bearing-num)))<br class="calibre3"/>                                  bearing-num))<br class="calibre3"/>   :turn-right (fn [] (mirror-bot x y (mod (- 1 bearing-num) 4)))<br class="calibre3"/>   :turn-left  (fn [] (mirror-bot x y (mod (+ 1 bearing-num) 4)))})</tt></span></blockquote><p id="filepos539455" class="calibre12">By bundling the functions that operate on data inside the same structure as the data itself, simple polymorphism is possible. Because each function is a closure, no object state needs to be explicitly passed; instead, each function uses any locals required to do its job. </p><p class="calibre5">It’s likely you cringed at the number of parentheses required to call these particular object closures, and rightfully so. We encourage you to extrapolate from the closure examples when dealing with your own applications, and see how they can solve a variety of tricky and unusual problems. Although this kind of structure is simple and powerful<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos540702"><span class="calibre33"><span class="calibre8"><span class="underline">10</span></span></span></a><span class="calibre33">]</span></small></sup> and may be warranted in some situations, Clojure provides other ways of associating functions with data objects that are more flexible. In fact, the desire to avoid a widespread need for this type of ad hoc implementation has motivated Clojure’s <tt class="calibre11">reify</tt> macro, which we’ll cover in <a href="#filepos677632"><span class="calibre8"><span class="underline">section 9.3</span></span></a>. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos540702" class="calibre32"><span class="calibre33">10</span></small></sup><span class="calibre10"> ...a fact any sufficiently experienced JavaScript programmer would be able to confirm. </span></blockquote><p class="calibre12"><span class="calibre10"><span class="bold">Compile-Time Versus Run-Time </span></span></p><p class="calibre7">When looking at code that includes a closure, it’s not immediately obvious how the work is distributed between compile-time and run-time. In particular, when you see a lot of code or processor-intensive work being done in a closure, you might wonder about the cost of calling the function that creates the closure: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn do-thing-builder [x y z]<br class="calibre3"/>  (fn do-thing [a b]<br class="calibre3"/>    ...<br class="calibre3"/>    (massive-calculation x y z)<br class="calibre3"/>    ...))</tt></span></blockquote><p class="calibre12">But you don’t need to worry. When this whole expression is compiled, bytecode for the bodies of <tt class="calibre11">do-thing</tt> and <tt class="calibre11">do-thing-builder</tt> are generated and stored in memory.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos542443"><span class="calibre33"><span class="calibre8"><span class="underline">11</span></span></span></a><span class="calibre33">]</span></small></sup> In current versions of Clojure, each function definition gets its own class. But when <tt class="calibre11">do-thing-builder</tt> is called, it doesn’t matter how large or slow the body of <tt class="calibre11">do-thing</tt> is—all that’s done at run-time is the creation of an <span class="italic">instance</span> of <tt class="calibre11">do-thing</tt>’s class. This is lightweight and fast. Not until the closure <span class="italic">returned</span> by <tt class="calibre11">do-thing-builder</tt> is called does the complexity or speed of the body of that inner function matter at all. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos542443" class="calibre32"><span class="calibre33">11</span></small></sup><span class="calibre10"> If the code is being compiled ahead of time by the </span><span class="calibre10"><tt class="calibre11">compile</tt></span><span class="calibre10"> function, the generated bytecode is also written to disk in .class files. </span></blockquote><p class="calibre12">In this section, you learned that closures are functions that close over lexical locals, how to create them from inside other functions, how to pass them around and call them, and even how to build lightweight objects using them. Next, we’ll take a look at how functions and closures behave when they call themselves, a pattern lovingly known as <span class="italic">recursion</span>. </p><p id="filepos543109" class="calibre5"><span class="calibre18"><span class="bold">7.3. Thinking recursively </span></span></p><p class="calibre7">You’re likely already familiar with the basics of recursion, and as a result can take heart that we won’t force you to read a beginner’s tutorial again. But because recursive <a id="filepos543406"></a>solutions are prevalent in Clojure code, it’s important that we cover it well enough that you can fully understand Clojure’s recursive offerings. </p><p class="calibre5">Recursion is often viewed as a low-level operation reserved for times when solutions involving higher-order functions either fail or lead to obfuscation. Granted, it’s fun to solve problems recursively because even for those of us who’ve attained some level of acumen with functional programming, finding a recursive solution still injects a bit of magic into our day. Recursion is a perfect building block for creating higher-level looping constructs and functions, which we’ll show in this section. </p><p id="filepos544106" class="calibre5"><span class="bold">7.3.1. Mundane recursion </span><a></a></p><p class="calibre7">A classically recursive algorithm is that of calculating some base number raised to an exponent, or the <tt class="calibre11">pow</tt> function. A straightforward<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos544707"><span class="calibre33"><span class="calibre8"><span class="underline">12</span></span></span></a><span class="calibre33">]</span></small></sup> way to solve this problem recursively is to multiply the base by each successively smaller value of the exponent, as implemented in the following listing. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos544707" class="calibre32"><span class="calibre33">12</span></small></sup><span class="calibre10"> Yes, we’re aware of </span><span class="calibre10"><tt class="calibre11">Math</tt></span><span class="calibre10">/</span><span class="calibre10"><tt class="calibre11">pow</tt></span><span class="calibre10">. </span></blockquote><p id="filepos544926" class="calibre12"><span class="calibre10"><span class="bold">Listing 7.4. A version of </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">pow</span></tt></span><span class="calibre10"><span class="bold"> using mundane recursion </span></span></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn pow [base exp]<br class="calibre3"/>  (if (zero? exp)<br class="calibre3"/>    1<br class="calibre3"/>    (* base (pow base (dec exp)))))<br class="calibre3"/><br class="calibre3"/>(pow 2 10)<br class="calibre3"/>;=&gt; 1024<br class="calibre3"/>(pow 1.01 925)<br class="calibre3"/>;=&gt; 9937.353723241924</tt></span></blockquote><p class="calibre12">We say that the recursive call is <span class="italic">mundane<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos545940"><span class="calibre33"><span class="calibre8"><span class="underline">13</span></span></span></a><span class="calibre33">]</span></small></sup></span> because it’s named explicitly rather than through mutual recursion or implicitly with the <tt class="calibre11">recur</tt> special form. Why is this a problem? The answer lies in what happens when we try to call <tt class="calibre11">pow</tt> with a large value: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos545940" class="calibre32"><span class="calibre33">13</span></small></sup><span class="calibre10"> Typically mundane recursion is referred to as </span><span class="calibre10"><span class="italic">linear</span></span><span class="calibre10">, or the case where the space requirements needed to perform the recursion is proportional to the magnitude of the input. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(pow 2 10000)<br class="calibre3"/>; java.lang.StackOverflowError</tt></span></blockquote><p class="calibre12">The implementation of <tt class="calibre11">pow</tt> is doomed to throw <tt class="calibre11">java.lang.StackOverflowError</tt> because the recursive call is trapped by the multiplication operation. The ideal solution would be a tail-recursive version that uses the explicit <tt class="calibre11">recur</tt> form, thus avoiding stack consumption and the resulting exception. One way to remove the mundane recursive call is to perform the multiplication at a different point, thus freeing the recursive call to occur in the tail position, as shown in the next listing. </p><p id="filepos546930" class="calibre5"><span class="calibre10"><span class="bold">Listing 7.5. A version of </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">pow</span></tt></span><span class="calibre10"><span class="bold"> using tail recursion, accumulator, and helper function </span></span></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn pow [base exp]<br class="calibre3"/>  (letfn [(kapow [base exp acc]<br class="calibre3"/>            (if (zero? exp)<br class="calibre3"/>              acc<br class="calibre3"/>              (recur base (dec exp) (* base acc))))]<br class="calibre3"/>    (kapow base exp 1)))<br class="calibre3"/><br class="calibre3"/>(pow 2 10000)<br class="calibre3"/>;=&gt; ... A very big number</tt></span></blockquote><p id="filepos547587" class="calibre12">This new version of <tt class="calibre11">pow</tt> uses two common techniques for converting mundane recursion to tail recursion. First, it uses a helper function <tt class="calibre11">kapow</tt> that does the majority of the work. Second, <tt class="calibre11">kapow</tt> itself uses an accumulator <tt class="calibre11">acc</tt> that holds the result of the multiplication. The exponent <tt class="calibre11">exp</tt> is no longer used as a multiplicative value but instead functions as a decrementing counter, eliminating a stack explosion. </p><p class="calibre5"><span class="calibre10"><span class="bold">Regular Recursion is Fun Again with Lazy-Seq </span></span></p><p class="calibre7">As mentioned in <a href="#filepos449135"><span class="calibre8"><span class="underline">section 6.3</span></span></a>, the lazy-seq recipe rule of thumb #1 states that you should wrap your outer layer function bodies with the <tt class="calibre11">lazy-seq</tt> macro when generating lazy seqs. The implementation of <tt class="calibre11">lz-rec-step</tt> used mundane recursion but managed to avoid stack overflow exceptions thanks to the use of <tt class="calibre11">lazy-seq</tt>. For functions generating sequences, the use of <tt class="calibre11">lazy-seq</tt> might be a better choice than tail recursion, because often the regular (mundane) recursive definition is the most natural and understandable. </p><p id="filepos548820" class="calibre5"><span class="bold">7.3.2. Tail calls and recur </span><a></a></p><p class="calibre7">In a language such as Clojure, where function locals are immutable, the benefit of tail recursion is especially important for implementing algorithms that require the consumption of a value or the accumulation of a result. Before we get deeper into implementing tail recursion, we’ll take a moment to appreciate the historical underpinnings of tail-call recursion and expound on its further role within Clojure. </p><p class="calibre5"><span class="calibre10"><span class="bold">Generalized Tail-Call Optimization </span></span></p><p class="calibre7">In the <span class="italic">Lambda Papers</span>, Guy L. Steele and Gerald Sussman describe their experiences with the research and implementation of the early versions of the Scheme programming language. The first versions of the interpreter served as a model for Carl Hewitt’s Actor model (<a href="#filepos1074223"><span class="calibre8"><span class="underline">Hewitt 1973</span></span></a>) of concurrent computation, implementing both actors and functions. One day, while eating Ho-Hos,<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos550809"><span class="calibre33"><span class="calibre8"><span class="underline">14</span></span></span></a><span class="calibre33">]</span></small></sup> Steele and Sussman noticed that the implementation of control flow within Scheme, implemented using actors, always ended with one actor calling another in its tail position with the return to the callee being deferred. Armed with their intimate knowledge of the Scheme compiler, Steele and Sussman were able to infer that because the underlying architecture dealing with actors and functions was the same, retaining both was redundant. Therefore, actors were removed from the language and functions remained as the more general construct. Thus, generalized tail-call optimization was thrust (<a href="#filepos1081761"><span class="calibre8"><span class="underline">Steele 1977</span></span></a>) into the world of computer science. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos550809" class="calibre32"><span class="calibre33">14</span></small></sup><span class="calibre10"> This isn’t true, but wouldn’t it be great if it were? </span></blockquote><p id="filepos550948" class="calibre12">Generalized tail-call optimization as found in Scheme (Abelson 1996) can be viewed as analogous to object delegation. Hewitt’s original actor model was rooted heavily in message delegation of arbitrary depth, with data manipulation occurring at any and all levels along the chain. This is similar to an adapter, except that there’s an implicit resource management element involved. In Scheme, any tail call<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos552035"><span class="calibre33"><span class="calibre8"><span class="underline">15</span></span></span></a><span class="calibre33">]</span></small></sup> from a function <tt class="calibre11">A</tt> to a function <tt class="calibre11">B</tt> results in the deallocation of all of <tt class="calibre11">A</tt> local resources and the full delegation of execution to <tt class="calibre11">B</tt>. As a result of this generalized tail-call optimization, the return to the original caller of <tt class="calibre11">A</tt> is directly from <tt class="calibre11">B</tt> instead of back down the call chain through <tt class="calibre11">A</tt> again, as shown in <a href="#filepos552315"><span class="calibre8"><span class="underline">Figure 7.1</span></span></a>. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos552035" class="calibre32"><span class="calibre33">15</span></small></sup><span class="calibre10"> Bear in mind that in this scenario, </span><span class="calibre10"><tt class="calibre11">A</tt></span><span class="calibre10"> and </span><span class="calibre10"><tt class="calibre11">B</tt></span><span class="calibre10"> can be different functions or the same function. </span></blockquote><p id="filepos552315" class="calibre12"><span class="calibre10"><span class="bold">Figure 7.1. Generalized tail-call optimization: if you know that </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">A</span></tt></span><span class="calibre10"><span class="bold"> calls </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">B</span></tt></span><span class="calibre10"><span class="bold"> in the tail position, then you also know that </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">A</span></tt></span><span class="calibre10"><span class="bold">’s resources are no longer needed, allowing Scheme to deallocate them and defer to </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">B</span></tt></span><span class="calibre10"><span class="bold"> for the return call instead. </span></span></p><p class="calibre1"><img src="images/00077.jpg" class="calibre55"/></p><p class="calibre5">Unfortunately for Clojure, neither the Java Virtual Machine nor its bytecode provide generalized tail-call optimization facilities. Clojure does provide a tail call special form <tt class="calibre11">recur</tt>, but it only optimizes the case of a tail-recursive self-call and not the generalized tail call. In the general case, there’s currently no way to reliably optimize (<a href="#filepos1070131"><span class="calibre8"><span class="underline">Clinger 1998</span></span></a>) tail calls. </p><p class="calibre5"><span class="calibre10"><span class="bold">Tail Recursion </span></span></p><p class="calibre7">The following function calculates the greatest common denominator of two numbers:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn gcd [x y]<br class="calibre3"/>  (cond<br class="calibre3"/>     (&gt; x y) (gcd (- x y) y)<br class="calibre3"/>     (&lt; x y) (gcd x (- y x))<br class="calibre3"/>    :else x))</tt></span></blockquote><p id="filepos553922" class="calibre12">The implementation of <tt class="calibre11">gcd</tt> is straightforward, but you’ll notice that we used mundane recursion instead of tail recursion via <tt class="calibre11">recur</tt>. In a language such as Scheme containing generalized tail-call optimization, the recursive calls will be optimized automatically. On the other hand, because of the JVM’s lack of tail-call optimization, the <tt class="calibre11">recur</tt> would be needed in order to avoid stack overflow errors. </p><p class="calibre5">Using the information in <a href="#filepos554649"><span class="calibre8"><span class="underline">table 7.1</span></span></a>, you can replace the mundane recursive calls with the <tt class="calibre11">recur</tt> form, causing <tt class="calibre11">gcd</tt> to be optimized by Clojure’s compiler. </p><p id="filepos554649" class="calibre5"><span class="calibre10"><span class="bold">Table 7.1. Tail positions and recur targets </span></span><a></a></p><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><th scope="col" valign="top" class="calibre26"><p class="calibre27"><span class="calibre10"><span class="bold">Form(s)</span></span></p></th><th scope="col" valign="top" class="calibre26"><p class="calibre27"><span class="calibre10"><span class="bold">Tail position</span></span></p></th><th scope="col" valign="top" class="calibre26"><p class="calibre27"><span class="calibre10"><span class="bold">recur target?</span></span></p></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">fn, defn</span>
</td><td valign="top" class="calibre16"><span class="calibre10">(fn [args] expressions </span><span class="calibre10"><span class="italic">tail</span></span><span class="calibre10">) </span>
</td><td valign="top" class="calibre16"><span class="calibre10">Yes</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">loop</span>
</td><td valign="top" class="calibre16"><span class="calibre10">(loop [bindings] expressions </span><span class="calibre10"><span class="italic">tail</span></span><span class="calibre10">) </span>
</td><td valign="top" class="calibre16"><span class="calibre10">Yes</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">let, letfn, binding</span>
</td><td valign="top" class="calibre16"><span class="calibre10">(let [bindings] expressions </span><span class="calibre10"><span class="italic">tail</span></span><span class="calibre10">) </span>
</td><td valign="top" class="calibre16"><span class="calibre10">No</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">do</span>
</td><td valign="top" class="calibre16"><span class="calibre10">(do expressions </span><span class="calibre10"><span class="italic">tail</span></span><span class="calibre10">) </span>
</td><td valign="top" class="calibre16"><span class="calibre10">No</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">if, if-not</span>
</td><td valign="top" class="calibre16"><span class="calibre10">(if test </span><span class="calibre10"><span class="italic">then tailelse tail</span></span><span class="calibre10">) </span>
</td><td valign="top" class="calibre16"><span class="calibre10">No</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">when, when-not</span>
</td><td valign="top" class="calibre16"><span class="calibre10">(when test expressions </span><span class="calibre10"><span class="italic">tail</span></span><span class="calibre10">) </span>
</td><td valign="top" class="calibre16"><span class="calibre10">No</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">cond</span>
</td><td valign="top" class="calibre16"><span class="calibre10">(cond test test </span><span class="calibre10"><span class="italic">tail</span></span><span class="calibre10"> ...:else </span><span class="calibre10"><span class="italic">else tail</span></span><span class="calibre10">) </span>
</td><td valign="top" class="calibre16"><span class="calibre10">No</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">or, and</span>
</td><td valign="top" class="calibre16"><span class="calibre10">(or test test... </span><span class="calibre10"><span class="italic">tail</span></span><span class="calibre10">) </span>
</td><td valign="top" class="calibre16"><span class="calibre10">No</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">case</span>
</td><td valign="top" class="calibre16"><span class="calibre10">(case const const </span><span class="calibre10"><span class="italic">tail ... default tail</span></span><span class="calibre10">) </span>
</td><td valign="top" class="calibre16"><span class="calibre10">No</span>
</td></tr></table><p class="calibre28"><span class="calibre10"><span class="bold">Why Recur? </span></span></p><p class="calibre7">If you think that you understand why Clojure provides an explicit tail-call optimization form rather than an implicit one, then go ahead and skip to the next section. </p><p class="calibre5">There’s no technical reason why Clojure couldn’t automatically detect and optimize recursive tail calls—Scala does this—but there are valid reasons why Clojure doesn’t. </p><p class="calibre5">First, because there’s no generalized TCO in the JVM, Clojure can only provide a subset of tail-call optimizations: the recursive case and the mutually recursive case (see the next section). By making <tt class="calibre11">recur</tt> an explicit optimization, Clojure doesn’t give the pretense of providing full TCO. </p><p class="calibre5">Second, having <tt class="calibre11">recur</tt> as an explicit form allows the Clojure compiler to detect errors caused by an expected tail call being pushed out of the tail position. If we change <tt class="calibre11">gcd</tt> to always return an integer, then an exception is thrown because the <tt class="calibre11">recur</tt> call is pushed out of the tail position: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn gcd [x y]<br class="calibre3"/>  (int<br class="calibre3"/>    (cond<br class="calibre3"/>       (&gt; x y) (recur (- x y) y)<br class="calibre3"/>       (&lt; x y) (recur x (- y x))<br class="calibre3"/>       :else x)))<br class="calibre3"/><br class="calibre3"/>; java.lang.UnsupportedOperationException: Can only recur from tail position</tt></span></blockquote><p id="filepos559044" class="calibre12">With automatic recursive tail-call optimization, the addition of an outer <tt class="calibre11">int</tt> call wouldn’t necessarily trigger (<a href="#filepos1083919"><span class="calibre8"><span class="underline">Wampler 2009</span></span></a>)<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos559658"><span class="calibre33"><span class="calibre8"><span class="underline">16</span></span></span></a><span class="calibre33">]</span></small></sup> an error condition. But Clojure enforces that a call to <tt class="calibre11">recur</tt> be in the tail position. This benefit will likely cause <tt class="calibre11">recur</tt> to live on, even should the JVM acquire TCO. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos559658" class="calibre32"><span class="calibre33">16</span></small></sup><span class="calibre10"> The Scala 2.8 compiler recognizes a </span><span class="calibre10"><tt class="calibre11">@tailrec</tt></span><span class="calibre10"> annotation and triggers an error whenever a marked function or method can’t be optimized. </span></blockquote><p class="calibre12">The final benefit of <tt class="calibre11">recur</tt> is that it allows the forms <tt class="calibre11">fn</tt> and <tt class="calibre11">loop</tt> to act as anonymous recursion points. </p><p class="calibre5">Why recur indeed.</p><p id="filepos560143" class="calibre5"><span class="bold">7.3.3. Don’t forget your trampoline </span><a></a></p><p class="calibre7">We touched briefly on the fact that Clojure can also optimize a mutually recursive function relationship, but like the tail-recursive case, it’s done explicitly. Mutually recursive functions are nice for implementing finite state machines (FSA), and in this section we’ll show an example of a simple state machine modeling the operation of an elevator (<a href="#filepos1079405"><span class="calibre8"><span class="underline">Mozgovoy 2009</span></span></a>) for a two-story building. There are only four states that the elevator FSA allows: on the first floor with the doors open or closed and on the second floor with the door open or closed. The elevator can also take four distinct commands: open doors, close doors, go up, and go down. Each command is only valid in a certain context; for example, the close command is only valid when the elevator door is open. Likewise, the elevator can only go up when on the first floor and only down when on the second floor, and the door must be shut in both instances. </p><p class="calibre5">We can directly translate these states and transitions into a set of mutually recursive functions by associating the states as a set of functions <tt class="calibre11">ff-open</tt>, <tt class="calibre11">ff-closed</tt>, <tt class="calibre11">sf-closed</tt>, and <tt class="calibre11">sf-open</tt>, and the transitions <tt class="calibre11">:open</tt>, <tt class="calibre11">:close</tt>, <tt class="calibre11">:up</tt>, and <tt class="calibre11">:down</tt>, as conditions for calling the next function. We’d like to create a function <tt class="calibre11">elevator</tt> that starts in the <tt class="calibre11">ff-open</tt> state, takes a sequence of commands, and returns <tt class="calibre11">true</tt> or <tt class="calibre11">false</tt> if they correspond to a legal schedule according to the FSA. For example, the sequence <tt class="calibre11">[:close :open :done]</tt> would be legal, if not pointless, whereas <tt class="calibre11">[:open :open :done]</tt> wouldn’t be legal, because an open door can’t be reopened. The function <tt class="calibre11">elevator</tt> could be implemented as shown next. </p><p id="filepos562122" class="calibre5"><span class="calibre10"><span class="bold">Listing 7.6. Using mutually recursive functions to implement a finite state machine </span></span><a></a></p><p class="calibre1"><img src="images/00039.jpg" class="calibre66"/></p><p id="filepos562391" class="calibre5">Using <tt class="calibre11">letfn</tt> in this way allows you to create local functions that reference each other, whereas <tt class="calibre11">(let [ff-open #(...)] ...)</tt> wouldn’t, because it executes its bindings serially. Each state function contains a <tt class="calibre11">case</tt> macro that dispatches to the next state based on a contextually valid command. For example, the <tt class="calibre11">sf-open</tt> state will transition to the <tt class="calibre11">sf-closed</tt> state given a <tt class="calibre11">:close</tt> command, will return <tt class="calibre11">true</tt> on a <tt class="calibre11">:done</tt> command (corresponding to a legal schedule), or will otherwise return <tt class="calibre11">false</tt>. Each state is similar in that the default <tt class="calibre11">case</tt> command is to return <tt class="calibre11">false</tt> indicating an illegal schedule. One other point of note is that each state function returns a function returning a value rather than directly returning the value. This is done so that the <tt class="calibre11">trampoline</tt> function can manage the stack on the mutually recursive calls, thus avoiding cases where a long schedule would blow the stack. Here’s the operation of <tt class="calibre11">elevator</tt> given a few example schedules: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(elevator [:close :open :close :up :open :open :done])<br class="calibre3"/>;=&gt; false<br class="calibre3"/><br class="calibre3"/>(elevator [:close :up :open :close :down :open :done])<br class="calibre3"/>;=&gt; true<br class="calibre3"/><br class="calibre3"/>;; run at your own risk!<br class="calibre3"/>(elevator (cycle [:close :open]))<br class="calibre3"/>; ... runs forever</tt></span></blockquote><p class="calibre12">Like the <tt class="calibre11">recur</tt> special form, the trampoline for mutual recursion has a definitive syntactic and semantic cost on the structure of your code. But whereas the call to <tt class="calibre11">recur</tt> could be replaced by mundane recursion without too much effect, save for at the edges, the rules for mutual recursion aren’t general. Having said that, the actual rules are simple: </p><div class="calibre22"> </div><ol class="calibre48"><li value="1" class="calibre24">Make all of the functions participating in the mutual recursion return a function instead of their normal result. Normally this is as simple as tacking a <tt class="calibre11">#</tt> onto the front of the outer level of the function body. </li><li value="2" class="calibre24">Invoke the first function in the mutual chain via the <tt class="calibre11">trampoline</tt> function. </li></ol><p id="filepos564727" class="calibre5">The final example won’t cause a stack overflow because the <tt class="calibre11">trampoline</tt> function handles the process of the self calls through the placement of the functions within a list where each function is “bounced” back and forth explicitly, as seen in <a href="#filepos565086"><span class="calibre8"><span class="underline">Figure 7.2</span></span></a>. </p><p id="filepos565086" class="calibre5"><span class="calibre10"><span class="bold">Figure 7.2. Elevator trampoline: the trampoline function explicitly bounces between mutually recursive calls. </span></span><a></a></p><p class="calibre1"><img src="images/00078.jpg" class="calibre67"/></p><p class="calibre5">The typical use case for mutually recursive functions are state machines, of which the <tt class="calibre11">elevator</tt> FSA is only a simple case. </p><p id="filepos565545" class="calibre5"><span class="bold">7.3.4. Continuation-passing style </span><a></a></p><p class="calibre7">Before wrapping up this chapter, we’re going to take time to talk about a style of programming not necessarily prevalent in Clojure, but moreso in the functional tradition: <span class="italic">continuation-passing style</span>. Continuation-passing style (CPS) is a hybrid between recursion and mutual recursion, but with its own set of idioms. We won’t give you a deep survey of CPS, but this subsection should provide a reasonable overview for deeper exploration, should you be so inclined. </p><p class="calibre5">The nutshell version of CPS is that it’s a way of generalizing a computation (<a href="#filepos1071767"><span class="calibre8"><span class="underline">Friedman 2001</span></span></a>) by viewing it in terms of up to three functions: </p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24">An accept function that decides when a computation should terminate</li><li value="2" class="calibre24">A return continuation that’s used to wrap the return values</li><li value="3" class="calibre24">A continuation function used to provide the next step in the computation</li></ul><p class="calibre5">There’s a reason why many sources on CPS will use the factorial function as a base example: because it’s exceptionally illustrative, as we show next. </p><p id="filepos566933" class="calibre5"><span class="calibre10"><span class="bold">Listing 7.7. Factorial function using continuation-passing style </span></span><a></a></p><p class="calibre1"><img src="images/00040.jpg" class="calibre64"/></p><p class="calibre5">Though this approach is definitely different than the normal functional structure, it’s not exactly interesting in and of itself. The power of CPS is that you can extract more generic function builders using CPS. One such builder, shown in the following listing, <a id="filepos567476"></a>can be used to make a range of functions that happen to fall into the same mold of a mathematical folding function. </p><p id="filepos567603" class="calibre5"><span class="calibre10"><span class="bold">Listing 7.8. Continuation-passing style function generator </span></span><a></a></p><p class="calibre1"><img src="images/00042.jpg" class="calibre68"/></p><p class="calibre5">Though this is potentially a powerful technique, there are a number of reasons preventing its widespread adoption in Clojure:</p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24">Without generalized tail-call optimization, the number of continuation calls is bounded by the size of the stack. If your own applications can guarantee a bounded execution path for the CPS calls, then this may not be a problem in practice. </li><li value="2" class="calibre24">In the case of exception handling, CPS can cause the point of failure to bubble out, especially on deferred computations such as in using <tt class="calibre11">delay</tt>, <tt class="calibre11">future</tt>, or <tt class="calibre11">promise</tt>.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos568967"><span class="calibre33"><span class="calibre8"><span class="underline">17</span></span></span></a><span class="calibre33">]</span></small></sup> In the abstract this may not seem to be a problem, but if your continuation function is supposed to throw the error but an outer layer function is doing so instead, then bugs might be difficult to track down. <blockquote class="calibre39"><sup class="calibre31"><small id="filepos568967" class="calibre32"><span class="calibre33">17</span></small></sup><span class="calibre10"> Clojure’s </span><span class="calibre10"><tt class="calibre11">future</tt></span><span class="calibre10"> and </span><span class="calibre10"><tt class="calibre11">promise</tt></span><span class="calibre10"> will be discussed in detail in </span><a href="#filepos818901"><span class="calibre10"><span class="calibre8"><span class="underline">chapter 11</span></span></span></a><span class="calibre10">. </span></blockquote></li><li value="3" class="calibre57">In a language such as Haskell that has ubiquitous lazy evaluation and pure functions, it’s often not necessary to impose a strict order of execution. One way to impose a strict order of execution is to design your programs along the continuation-passing style. Though Clojure isn’t entirely lazy, the matter of outof-order execution isn’t a factor against CPS. But CPS isn’t conducive to parallelization, which is antithetical to Clojure’s very nature. </li></ul><p id="filepos569849" class="calibre5"><span class="calibre18"><span class="bold">7.4. Putting it all together: A* pathfinding </span></span></p><p class="calibre7">A* is a best-first pathfinding algorithm that maintains a set of candidate paths through a “world” with the purpose of finding the least difficult (<a href="#filepos1069759"><span class="calibre8"><span class="underline">Bratko 2000</span></span></a>) path to some goal. The difficulty (or cost) of a path is garnered by the A* algorithm through the use of a function, typically named <tt class="calibre11">f</tt>, that builds an estimate of the total cost from a <a id="filepos570402"></a>start point to the goal. The application of this cost-estimate function <tt class="calibre11">f</tt> is used to sort the candidate paths (<a href="#filepos1073956"><span class="calibre8"><span class="underline">Hart 1968</span></span></a>) in the order most likely to prove least costly. </p><p id="filepos570651" class="calibre5"><span class="bold">The World </span></p><p class="calibre7">To represent the world, we’ll again use a simple 2D matrix representation:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def world [[  1   1   1   1    1]<br class="calibre3"/>            [999 999 999 999    1]<br class="calibre3"/>            [  1   1   1   1    1]<br class="calibre3"/>            [  1 999 999 999  999]<br class="calibre3"/>            [  1   1   1   1    1]])</tt></span></blockquote><p class="calibre12">The <tt class="calibre11">world</tt> structure is made from the values <tt class="calibre11">1</tt> and <tt class="calibre11">999</tt> respectively, corresponding to flat ground and cyclopean mountains. What would you assume is the optimal path from the upper-left corner <tt class="calibre11">[0 0]</tt> to the lower-right <tt class="calibre11">[4 4]</tt>? Clearly the optimal (and only) option is the Z-shaped path around the walls. Implementing an A* algorithm should fit the bill, but first, we’ll talk a little bit about how to do so. </p><p id="filepos571692" class="calibre5"><span class="bold">Neighbors </span></p><p class="calibre7">For any given spot in the world, we need a way to calculate possible next steps. We can do this brute force for small worlds, but we’d like a more general function. It turns out if we restrict the possible moves to north, south, east, and west, then any given move is +/-1 along the x or y axis. Taking advantage of this fact, we can use the <tt class="calibre11">neighbors</tt> function from <a href="#filepos366893"><span class="calibre8"><span class="underline">listing 5.1</span></span></a> as shown here: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(neighbors 5 [0 0])<br class="calibre3"/>;=&gt; ([1 0] [0 1])</tt></span></blockquote><p class="calibre12">From the upper-left point, the only next steps are y=0, x=1 or y=1, x=0. So now that we have that, think about how we might estimate the path cost from any given point. A simple cost estimate turns out to be described as, “from the current point, calculate the expected cost by assuming we can travel to the right edge, then down to the lower-right.” An implementation of the <tt class="calibre11">h</tt> function <tt class="calibre11">estimate-cost</tt> that estimates the remaining path cost is shown next. </p><p id="filepos572883" class="calibre5"><span class="calibre10"><span class="bold">Listing 7.9. A straight-line </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">h</span></tt></span><span class="calibre10"><span class="bold"> function to estimate remaining path cost </span></span></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn estimate-cost [step-cost-est size y x]<br class="calibre3"/>  (* step-cost-est<br class="calibre3"/>     (- (+ size size) y x 2)))<br class="calibre3"/><br class="calibre3"/>(estimate-cost 900 5 0 0)<br class="calibre3"/>;=&gt; 7200<br class="calibre3"/>(estimate-cost 900 5 4 4)<br class="calibre3"/>;=&gt; 0</tt></span></blockquote><p class="calibre12">From the y-x point <tt class="calibre11">[0 0]</tt> the cost of travelling 5 right and 5 down given an estimated single-step cost <tt class="calibre11">step-cost-est</tt> is <tt class="calibre11">9000</tt>. This is a pretty straightforward estimate based on a straight-line path. Likewise, starting at the goal state <tt class="calibre11">[4 4]</tt> would cost nothing. Still needed is the <tt class="calibre11">g</tt> function used to calculate the cost of the path so far, named <tt class="calibre11">path-cost</tt>, which is provided in the following listing. </p><p id="filepos573913" class="calibre5"><span class="calibre10"><span class="bold">Listing 7.10. A </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">g</span></tt></span><span class="calibre10"><span class="bold"> function used to calculate the cost of the path traversed so far </span></span></p><p class="calibre1"><img src="images/00043.jpg" class="calibre69"/></p><p id="filepos574247" class="calibre5">Now that we’ve created an estimated cost function and a current cost function, we can implement a simple <tt class="calibre11">total-cost</tt> function for <tt class="calibre11">f</tt>. </p><p id="filepos574431" class="calibre5"><span class="calibre10"><span class="bold">Listing 7.11. </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">f</span></tt></span><span class="calibre10"><span class="bold"> function to calculate the estimated cost of the path (+ (</span></span><span class="calibre10"><tt class="calibre11"><span class="bold">g</span></tt></span><span class="calibre10"><span class="bold"> ...) (</span></span><span class="calibre10"><tt class="calibre11"><span class="bold">h</span></tt></span><span class="calibre10"><span class="bold"> ...)) </span></span></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn total-cost [newcost step-cost-est size y x]<br class="calibre3"/>  (+ newcost<br class="calibre3"/>     (estimate-cost step-cost-est size y x)))<br class="calibre3"/><br class="calibre3"/>(total-cost 0 900 5 0 0)<br class="calibre3"/>;=&gt; 7200<br class="calibre3"/>(total-cost 1000 900 5 3 4)<br class="calibre3"/>;=&gt; 1900</tt></span></blockquote><p class="calibre12">The second example shows that if we’re one step away with a current cost of <tt class="calibre11">1000</tt>, then the total estimated cost will be <tt class="calibre11">1900</tt>, which is expected. So now we have all of the heuristic pieces in place. You may think that we’ve simplified the heuristic needs of A*, but in fact this is all that there is to it. The actual implementation is complex, which we’ll tackle next. </p><p id="filepos575569" class="calibre5"><span class="bold">7.4.1. The A* implementation </span><a></a></p><p class="calibre7">Before we show the implementation of A*, we need one more auxiliary function <tt class="calibre11">minby</tt>, used to retrieve from a collection the minimum value dictated by some function. The implementation of <tt class="calibre11">min-by</tt> would naturally be a straightforward higher-order function, as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn min-by [f coll]<br class="calibre3"/>  (when (seq coll)<br class="calibre3"/>    (reduce (fn [min this]<br class="calibre3"/>              (if (&gt; (f min) (f this)) this min))<br class="calibre3"/>             coll)))<br class="calibre3"/><br class="calibre3"/>(min-by :cost [{:cost 100} {:cost 36} {:cost 9}])<br class="calibre3"/>;=&gt; {:cost 9}</tt></span></blockquote><p class="calibre12">This function will come in handy when we want to grab the cheapest path determined by the cost heuristic. We’ve delayed enough! We’ll finally implement the A* algorithm so that we navigate around the <tt class="calibre11">world</tt>. The following listing shows a tail-recursive solution. </p><p id="filepos576669" class="calibre5"><span class="calibre10"><span class="bold">Listing 7.12. The main A* algorithm </span></span><a></a></p><p class="calibre1"><img src="images/00045.jpg" class="calibre70"/></p><p class="calibre5">The main thrust of the <tt class="calibre11">astar</tt> function occurs at the check that <tt class="calibre11">(&gt;= newcost oldcost)</tt>. Once we’ve calculated the <tt class="calibre11">newcost</tt> (the cost so far for the cheapest neighbor) and a cost-so-far <tt class="calibre11">oldcost</tt>, we perform one of two actions. The first action occurs when the <tt class="calibre11">newcost</tt> is greater than or equal to the <tt class="calibre11">oldcost</tt> and is to throw away this new path, because it’s clearly a worse alternative. The other action is the core functionality corresponding to the constant sorting of the <tt class="calibre11">work-todo</tt>, based on the cost of the path as determined by the heuristic function <tt class="calibre11">total-cost</tt>. The soul of A* is based on the fact that the potential paths stored in <tt class="calibre11">work-todo</tt> are always sorted and distinct (through the use of a sorted set), based on the estimated path cost function. Each recursive loop through the <tt class="calibre11">astar</tt> function maintains the sorted <tt class="calibre11">routes</tt> based on the current cost knowledge of the path, added to the estimated total cost. </p><p class="calibre5">The results given by the <tt class="calibre11">astar</tt> function for the Z-shaped <tt class="calibre11">world</tt> are shown in the next listing. </p><p id="filepos578082" class="calibre5"><span class="calibre10"><span class="bold">Listing 7.13. Running the A* algorithm on the Z World </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(astar [0 0]<br class="calibre3"/>       900<br class="calibre3"/>       world)<br class="calibre3"/><br class="calibre3"/>;=&gt; [{:cost 17,<br class="calibre3"/>         :yxs [[0 0] [0 1] [0 2] [0 3] [0 4] [1 4] [2 4]<br class="calibre3"/>               [2 3] [2 2] [2 1] [2 0] [3 0] [4 0] [4 1]<br class="calibre3"/>               [4 2] [4 3] [4 4]]}<br class="calibre3"/>        :steps 94]</tt></span></blockquote><p class="calibre12">By following the y-x indices, you’ll notice that the <tt class="calibre11">astar</tt> function traverses the Z World along the path where cost is <tt class="calibre11">1</tt>, as seen in <a href="#filepos578930"><span class="calibre8"><span class="underline">Figure 7.3</span></span></a>. </p><p id="filepos578930" class="calibre5"><span class="calibre10"><span class="bold">Figure 7.3. A graphical representation of Z World clearly shows the optimal/only path. </span></span><a></a></p><p class="calibre1"><img src="images/00076.jpg" class="calibre71"/></p><p class="calibre5">We can also build another world, as shown next, called Shrubbery World that contains a single weakling shrubbery at position <tt class="calibre11">[0 3]</tt>, represented by the number <tt class="calibre11">2</tt>, and see how <tt class="calibre11">astar</tt> navigates it. </p><p id="filepos579454" class="calibre5"><span class="calibre10"><span class="bold">Listing 7.14. The Shrubbery World </span></span><a></a></p><p class="calibre1"><img src="images/00046.jpg" class="calibre72"/></p><p class="calibre5">When tracing the best path, you will see that the <tt class="calibre11">astar</tt> function prefers the nonshrubbery path. But what would happen if we placed a man-eating bunny along the previously safe path, represented by an ominously large number, as shown next? </p><p id="filepos579953" class="calibre5"><span class="calibre10"><span class="bold">Listing 7.15. The bunny world </span></span><a></a></p><p class="calibre1"><img src="images/00005.jpg" class="calibre73"/></p><p id="filepos580168" class="calibre5">As expected, the <tt class="calibre11">astar</tt> function picks the shrubbery path (<tt class="calibre11">2</tt>) path instead of the evil bunny path to reach the final destination. </p><p id="filepos580347" class="calibre5"><span class="bold">7.4.2. Notes about the A* implementation </span><a></a></p><p class="calibre7">The A* algorithm was implemented as idiomatic Clojure source code. Each of the data structures, from the sorted set to the tail-recursive <tt class="calibre11">astar</tt> function, to the higher-order function <tt class="calibre11">min-by</tt>, was functional in nature and therefore extensible as a result. We encourage you to explore the vast array of possible worlds traversable by our A* implementation and see what happens should you change the heuristic (<a href="#filepos1070893"><span class="calibre8"><span class="underline">Dijkstra 1959</span></span></a>) functions along the way. Clojure encourages experimentation, and by partitioning the solution this way, we’ve enabled you to explore different heuristics. </p><p id="filepos581123" class="calibre5"><span class="calibre18"><span class="bold">7.5. Summary </span></span></p><p class="calibre7">We’ve covered a lot about Clojure’s flavor of functional programming in this chapter, and you may have noticed that it looks like many others. Clojure favors an approach where immutable data is transformed through the application of functions. Additionally, Clojure prefers that functions be free of side-effects and referentially transparent (pure) in order to reduce the complexities inherent in widespread data mutation. Lexical closures provide a simple yet powerful mechanism for defining functions that carry around with them the value context in which they were created. This allows certain information to exist beyond their lexical context, much like a poor-man’s object. Finally, Clojure is built with this in mind, in that its primary form of iteration is through tail recursion as a natural result of its focus on immutability. </p><p class="calibre5">In the next chapter, we’ll explore the feature most identified with Lisp: macros.</p><div class="mbppagebreak"></div><p id="filepos582206" class="calibre5"><span class="calibre6"><span class="bold">Part 4. Large-scale design </span></span><a></a></p><p class="calibre7">Clojure is a practical language, not an academic one; and in the real world, programs grow large, change over time, and are confronted with shifting requirements. In this part, we’ll show how Clojure’s Lisp heritage of “code is data” can help address these problems. We’ll demonstrate the use of macros, how to create a fluent builder, the benefits of a language that embraces the Java platform, and how Clojure addresses the mutability of the real world. </p><div class="mbppagebreak"></div><p id="filepos582816" class="calibre5"><span class="calibre6"><span class="bold">Chapter 8. Macros </span></span><a></a></p><blockquote id="filepos582902" class="calibre9"><span class="italic">If you give someone Fortran, he has Fortran. If you give someone Lisp, he has any language he pleases.</span></blockquote><blockquote class="calibre25"><span class="italic">Guy Steele</span></blockquote><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">This chapter covers</span>
</p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24"><a href="#filepos588357"><span class="calibre8"><span class="underline">Data is code is data</span></span></a></li><li value="2" class="calibre24"><a href="#filepos598558"><span class="calibre8"><span class="underline">Defining control structures</span></span></a></li><li value="3" class="calibre24"><a href="#filepos607261"><span class="calibre8"><span class="underline">Macros combining forms</span></span></a></li><li value="4" class="calibre24"><a href="#filepos621735"><span class="calibre8"><span class="underline">Using macros to control symbolic resolution time</span></span></a></li><li value="5" class="calibre24"><a href="#filepos630545"><span class="calibre8"><span class="underline">Using macros to manage resources</span></span></a></li><li value="6" class="calibre24"><a href="#filepos634303"><span class="calibre8"><span class="underline">Putting it all together: macros returning functions</span></span></a></li></ul><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">Macros are where the rubber of “code is data” meets the road of making programs simpler and cleaner. To fully understand macros, you need to understand the different <span class="italic">times</span> of Clojure, of which macros perform the bulk of their work at compile time. We’ll start by looking at what it means for code to be data and data to be used as code. This is the background you’ll need to understand that control structures in Clojure are built out of macros, and how you can build your own. The mechanics of macros are relatively simple, and before you’re halfway through this chapter you’ll <a id="filepos584912"></a>have learned all you technically need to write your own. Where macros get complicated is when you try to bring theoretical knowledge of them into the real world, so to help you combat that we’ll lead you on a tour of practical applications of macros. </p><p class="calibre5">What kinds of problems do macros solve? To start answering that question, consider Clojure’s <tt class="calibre11">-&gt;</tt> and <tt class="calibre11">-&gt;&gt;</tt> macros that return the result of a number of threaded forms. To understand both versions of the arrow macros, we find it useful to think of them as an arrow indicating the flow of data from one function to another—the form <tt class="calibre11">(-&gt; 25 Math/sqrt int list)</tt> can be read as </p><div class="calibre22"> </div><ol class="calibre48"><li value="1" class="calibre24">Take the value 25.</li><li value="2" class="calibre24">Feed it into the method <tt class="calibre11">Math/sqrt</tt>. </li><li value="3" class="calibre24">Feed that result into the function <tt class="calibre11">int</tt>. </li><li value="4" class="calibre24">Feed that result into the function <tt class="calibre11">list</tt>. Graphically, this can be viewed as shown in <a href="#filepos586117"><span class="calibre8"><span class="underline">figure 8.1</span></span></a>. </li></ol><p id="filepos586117" class="calibre5"><span class="calibre10"><span class="bold">Figure 8.1. Arrow macro: each expression is inserted into the following one at compile time, allowing you to write the whole expression inside-out when that feels more natural. </span></span><a></a></p><p class="calibre1"><img src="images/00081.jpg" class="calibre74"/></p><p class="calibre5">It expands into the following expression:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(list (int (Math/sqrt 25)))</tt></span></blockquote><p class="calibre12">When viewed this way, the <tt class="calibre11">-&gt;</tt> macro can be said to <span class="italic">thread</span> a sequence of forms into each in turn. This threading can be done within any form and is <span class="italic">always</span> stitched in as the first argument to the outermost expression. On the other hand, the <tt class="calibre11">-&gt;&gt;</tt> macro will thread the form as the last argument. Observe how the placement of commas<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos587307"><span class="calibre33"><span class="calibre8"><span class="underline">1</span></span></span></a><span class="calibre33">]</span></small></sup> works as visual markers for the stitch point: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos587307" class="calibre32"><span class="calibre33">1</span></small></sup><span class="calibre10"> Because commas are considered whitespace. The use here is instructive and not meant as idiomatic. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(-&gt; (/ 144 12) (/ ,,, 2 3) str keyword list)<br class="calibre3"/>;=&gt; (:2)<br class="calibre3"/><br class="calibre3"/>(-&gt; (/ 144 12) (* ,,, 4 (/ 2 3)) str keyword (list ,,, :33))<br class="calibre3"/>;=&gt; (:32 :33)<br class="calibre3"/><br class="calibre3"/>(-&gt;&gt; a (+ 5 ,,,) (let [a 5] ,,,))<br class="calibre3"/>;=&gt; 10</tt></span></blockquote><p class="calibre12">Using the arrows macro is useful when many sequential operations need to be applied to a single object. So this is one potential use case for macros: taking one form of an expression and transforming it into another form. In this chapter, we’ll also look at using macros to combine forms, change forms, control evaluation and resolution of arguments, manage resources, and build functions. But first, what does it mean that Clojure code is data, and why should you care? </p><p id="filepos588357" class="calibre5"><span class="calibre18"><span class="bold">8.1. Data is code is data </span></span></p><p class="calibre7">You’re already familiar with textual representations of data in your programs, at least with strings, lists, vectors, maps, and so on. Clojure, like other Lisps, takes this one step further by having programs be made <span class="italic">entirely</span> out of data. Function definitions in Clojure programs are also represented using an aggregation of the various data <a id="filepos588824"></a>structures mentioned in the previous chapters. Likewise, the expressions representing the execution of functions and the use of control structures are also data structures! These data representations of functions and their executions represent a concept different from the way other programming languages operate. Typically, there’s a sharp distinction between data structures and functions of the language. In fact, most programming languages don’t even remotely describe the form of functions in their textual representations. With Clojure, there’s no distinction between the textual form and the actual form of a program. When a program is the data that composes the program, then you can write programs to write programs. This may seem like nonsense now, but as you’ll see throughout this chapter, it’s powerful. </p><p class="calibre5">To start with, look at the built-in Clojure function <tt class="calibre11">eval</tt>, whose purpose is to take a data structure representing a Clojure expression, evaluate it, and return the result. This behavior can be seen in the following examples: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(eval 42)<br class="calibre3"/>;=&gt; 42<br class="calibre3"/><br class="calibre3"/>(eval '(list 1 2))<br class="calibre3"/>;=&gt; (1 2)<br class="calibre3"/><br class="calibre3"/>(eval (list 1 2))<br class="calibre3"/>; java.lang.ClassCastException: java.lang.Integer cannot be cast to clojure.<br class="calibre3"/>     lang.IFn</tt></span></blockquote><p class="calibre12">Why did we get an exception for the last example? The answer to that lies in the previous example. The quote in <tt class="calibre11">'(list 1 2)</tt> causes <tt class="calibre11">eval</tt> to view it as <tt class="calibre11">(list 1 2)</tt>, which is the function call to create the resulting list. Likewise, for the final example <tt class="calibre11">eval</tt> received a list of <tt class="calibre11">(1 2)</tt> and attempted to use <tt class="calibre11">1</tt> as a function, thus failing. Not very exciting, is it? The excitement inherent in <tt class="calibre11">eval</tt> stems from something that we mentioned<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos591288"><span class="calibre33"><span class="calibre8"><span class="underline">2</span></span></span></a><span class="calibre33">]</span></small></sup> earlier—if you provide <tt class="calibre11">eval</tt> a list in the form expected of a function call, then <span class="italic">something else</span> should happen. This <span class="italic">something else</span> would be the evaluation of a function call and not of the data structure itself. Look at what happens when we try evaluating something more complicated: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos591288" class="calibre32"><span class="calibre33">2</span></small></sup><span class="calibre10"> All the way back in </span><a href="#filepos192948"><span class="calibre10"><span class="calibre8"><span class="underline">section 2.5</span></span></span></a><span class="calibre10">. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(eval (list (symbol "+") 1 2))<br class="calibre3"/>;=&gt; 3</tt></span></blockquote><p class="calibre12">In words, the steps involved were as follows:</p><div class="calibre22"> </div><ol class="calibre48"><li value="1" class="calibre24">The function <tt class="calibre11">symbol</tt> received a string <tt class="calibre11">+</tt> and returned a symbol data type of <tt class="calibre11">+</tt>. </li><li value="2" class="calibre24">The function <tt class="calibre11">list</tt> received three arguments: a symbol <tt class="calibre11">+</tt>, the integer <tt class="calibre11">1</tt>, and the integer <tt class="calibre11">2</tt>, and returned a list of these elements. </li><li value="3" class="calibre24">The <tt class="calibre11">eval</tt> function received a list data type of <tt class="calibre11">(+ 1 2)</tt>, recognized it as the function call form, and executed the <tt class="calibre11">+</tt> function with the arguments <tt class="calibre11">1</tt> and <tt class="calibre11">2</tt>, returning the integer <tt class="calibre11">3</tt>. </li></ol><p id="filepos592396" class="calibre5"><span class="bold">8.1.1. Syntax-quote, unquote, and splicing </span><a></a></p><p id="filepos592485" class="calibre28"><span class="calibre10"><span class="bold">Listing 8.1. An implementation of </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">eval</span></tt></span><span class="calibre10"><span class="bold"> taking a local context </span></span></p><p class="calibre1"><img src="images/00050.jpg" class="calibre75"/></p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">Handling nested syntax-quotes</span>
</p><p id="filepos592974" class="calibre7">Dealing with nested syntax-quotes can at times be complicated. But you can visualize the way in which unquoting affects the nested structures as result of repeated evaluations (Steele 1990) relative to its nesting level: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(let [x 9, y '(- x)]<br class="calibre3"/>  (println `y)<br class="calibre3"/>  (println ``y)<br class="calibre3"/>  (println ``~y)<br class="calibre3"/>  (println ``~~y)<br class="calibre3"/>  (contextual-eval {'x 36} ``~~y))<br class="calibre3"/>; user/y<br class="calibre3"/>; (quote user/y)<br class="calibre3"/>; user/y<br class="calibre3"/>; (- x)<br class="calibre3"/>;=&gt; -36</tt></span></blockquote><p class="calibre12">The nesting of the syntax-quotes in the first two <tt class="calibre11">println</tt> calls takes the value of <tt class="calibre11">y</tt> further up the abstraction ladder. But by including a single unquote in the third <tt class="calibre11">println</tt>, we again bring it back down. Finally, by unquoting a second time, we’ve created a structure that can then be evaluated—and doing so yields the result <tt class="calibre11">-36</tt>. We had to use <tt class="calibre11">contextual-eval</tt> in the tail because core <tt class="calibre11">eval</tt> doesn’t have access to local bindings—only Var bindings. One final note is that had we attempted to unquote one extra time, we’d have seen the exception <tt class="calibre11">java.lang.IllegalStateException: Var clojure.core/unquote is unbound</tt>. The reason for this error is that unquote is the way to “jump” out of a syntax-quote, and to do so more than nesting allows will cause an error. We won’t use this technique in this chapter, and in most cases you won’t need to utilize it unless you’re planning to create macro-defining macros—something we won’t do until <a href="#filepos1003593"><span class="calibre8"><span class="underline">section 13.1</span></span></a>. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">In section 1.5.6, we mentioned quoting and its effects on evaluation, and in this chapter we’ll expand on that theme fully as it relates to Clojure’s macro facility. But the functionality of the quoting forms is orthogonal to macros, and they can be used independently. As we show<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos595821"><span class="calibre33"><span class="calibre8"><span class="underline">3</span></span></span></a><span class="calibre33">]</span></small></sup> in <a href="#filepos592485"><span class="calibre8"><span class="underline">listing 8.1</span></span></a>, using quoting and unquoting in a function allows us to create an evaluation function, <tt class="calibre11">contextual-eval</tt>, that takes an explicit context map. <a id="filepos595526"></a>Rarely will you see the use of syntax-quote outside the body of a macro, but there’s nothing preventing it from being used this way—and doing so is powerful. But the maximum power of quoting forms is fully realized when used with macros. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos595821" class="calibre32"><span class="calibre33">3</span></small></sup><span class="calibre10"> Thanks to George Jahad for the implementation on which </span><span class="calibre10"><tt class="calibre11">contextual-eval</tt></span><span class="calibre10"> is based. </span></blockquote><p class="calibre12">Working from a model where code is data, Clojure is able to manipulate structures into different executable forms at both runtime and compile time. We’ve already shown how this can be done at runtime using <tt class="calibre11">eval</tt> and <tt class="calibre11">contextual-eval</tt>, but this doesn’t serve the purpose of compile-time manipulation. It probably doesn’t need saying, but because this is a book about Clojure, we will: macros are the way to achieve this effect. </p><p id="filepos596516" class="calibre5"><span class="bold">8.1.2. Macro rules of thumb </span><a></a></p><p class="calibre7">Before we begin, we should list a few rules of thumb to observe when writing macros:</p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24">Don’t write a macro if a function will do. Reserve macros to provide syntactic abstractions or create binding forms.</li><li value="2" class="calibre24">Write an example usage.</li><li value="3" class="calibre24">Expand your example usage by hand.</li><li value="4" class="calibre24">Use <tt class="calibre11">macroexpand</tt>, <tt class="calibre11">macroexpand-1</tt>, and <tt class="calibre11">clojure.walk/macroexpand-all<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos597437"><span class="calibre33"><span class="calibre8"><span class="underline">4</span></span></span></a><span class="calibre33">]</span></small></sup></tt> liberally to understand how your implementation works. <blockquote class="calibre39"><sup class="calibre31"><small id="filepos597437" class="calibre32"><span class="calibre33">4</span></small></sup><span class="calibre10"> The </span><span class="calibre10"><tt class="calibre11">macroexpand-all</tt></span><span class="calibre10"> function is a useful debugging aid, as we’ll demonstrate in this chapter. But it’s worth knowing that unlike the other </span><span class="calibre10"><tt class="calibre11">macroexpand</tt></span><span class="calibre10"> functions, it doesn’t use exactly the same logic as the Clojure compiler itself, and thus may in some unusual circumstances produced misleading results. </span></blockquote></li><li value="5" class="calibre57">Experiment at the REPL.</li><li value="6" class="calibre24">Break complicated macros into smaller functions whenever possible.</li></ul><p class="calibre5">Throughout this chapter, you’ll see all of these rules to varying degrees. Obviously, we’re trying to balance best practices, teaching, and page counts, so we may not always adhere entirely. Even so, we’ll try to highlight those times when we do break from the recommended heuristics. Having said that, we’ll talk first about the most ubiquitous use of macros: creating custom control structures. </p><p id="filepos598558" class="calibre5"><span class="calibre18"><span class="bold">8.2. Defining control structures </span></span></p><p class="calibre7">Most control structures in Clojure are implemented via macros, so they provide a nice starting point for learning how macros can be useful. Macros can be built with or without using syntax-quote, so we’ll show examples of each. </p><p class="calibre5">In languages lacking macros, such as Haskell<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos600021"><span class="calibre33"><span class="calibre8"><span class="underline">5</span></span></span></a><span class="calibre33">]</span></small></sup> for example, the definition of control structures relies on the use of higher-order functions such as we showed in <a href="#filepos498652"><span class="calibre8"><span class="underline">section 7.1.2</span></span></a>. Though this fact in no way limits the ability to create control structures in Haskell, the approach that Lisps take to the problem is different. The most obvious advantage of macros over higher-order functions is that the former manipulate compile-time forms, transforming them into runtime forms. This allows your programs <a id="filepos599655"></a>to be written in ways natural to your problem domain, while still maintaining runtime efficiency. Clojure already provides a rich set of control structures, including but not limited to <tt class="calibre11">doseq</tt>, <tt class="calibre11">while</tt>, <tt class="calibre11">if</tt>, <tt class="calibre11">if-let</tt>, and <tt class="calibre11">do</tt>, but in this section we’ll write a few others. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos600021" class="calibre32"><span class="calibre33">5</span></small></sup><span class="calibre10"> Although there’s a GHC extension named Template Haskell that provides a macro-like capability, this isn’t the norm. </span></blockquote><p id="filepos600221" class="calibre35"><span class="bold">8.2.1. Defining control structures without syntax-quote </span><a></a></p><p class="calibre7">Because the arguments to <tt class="calibre11">defmacro</tt> aren’t evaluated before being passed to the macro, they can be viewed as pure data structures, and manipulated and analyzed as such. Because of this, amazing things can be done on the raw forms supplied to macros even in the absence of unquoting. </p><p class="calibre5">Imagine a macro named <tt class="calibre11">do-until</tt> that will execute all of its clauses evaluating as true <span class="italic">until</span> it gets one that is falsey: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(do-until<br class="calibre3"/>  (even? 2) (println "Even")<br class="calibre3"/>  (odd?  3) (println "Odd")<br class="calibre3"/>  (zero? 1) (println "You never see me")<br class="calibre3"/>  :lollipop (println "Truthy thing"))<br class="calibre3"/>; Even<br class="calibre3"/>; Odd<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p class="calibre12">A good example of this type of macro is Clojure’s core macro <tt class="calibre11">cond</tt>, which with some minor modifications can be made to behave differently: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defmacro do-until [&amp; clauses]<br class="calibre3"/>  (when clauses<br class="calibre3"/>    (list `when (first clauses)<br class="calibre3"/>           (if (next clauses)<br class="calibre3"/>             (second clauses)<br class="calibre3"/>             (throw (IllegalArgumentException.<br class="calibre3"/>                     "do-until requires an even number of forms")))<br class="calibre3"/>           (cons 'do-until (nnext clauses)))))</tt></span></blockquote><p class="calibre12">The first expansion of <tt class="calibre11">do-until</tt> illustrates how this macro operates: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(macroexpand-1 '(do-until true (prn 1) false (prn 2)))<br class="calibre3"/>;=&gt; (when true (prn 1) (do-until false (prn 2)))</tt></span></blockquote><p class="calibre12"><tt class="calibre11">do-until</tt> recursively expands into a series of <tt class="calibre11">when</tt> calls, which themselves expand into a series of <tt class="calibre11">if</tt> expressions: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(require '[clojure.walk :as walk])<br class="calibre3"/>(walk/macroexpand-all '(do-until true (prn 1) false (prn 2)))<br class="calibre3"/>;=&gt; (if true (do (prn 1) (if false (do (prn 2) nil))))<br class="calibre3"/><br class="calibre3"/>(do-until true (prn 1) false (prn 2))<br class="calibre3"/>; 1<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p class="calibre12">Now you could write out the nested <tt class="calibre11">if</tt> structure manually and achieve the same result, but the beauty of macros lies in the fact that they can do so on your behalf while presenting a lightweight and intuitive form. In cases where <tt class="calibre11">do-until</tt> can be used, it removes the need to write and maintain superfluous boilerplate code. This <a id="filepos603106"></a>idea can be extended to macros in general and their propensity to reduce unneeded boilerplate for a large category of circumstances, as the programmer desires. One thing to note about <tt class="calibre11">do-until</tt> is that it’s meant to be used only for side effects, because it’s designed to always return <tt class="calibre11">nil</tt>. Macros starting with <tt class="calibre11">do</tt> tend to act the same. </p><p id="filepos603484" class="calibre5"><span class="bold">8.2.2. Defining control structures using syntax-quote and unquoting </span><a></a></p><p class="calibre7">Not all control structures will be as simple as <tt class="calibre11">do-until</tt>. Instead, there will be times when you’ll want to selectively evaluate macro arguments, structures, or substructures. In this section, we’ll explore one such macro named <tt class="calibre11">unless</tt>, implemented using unquote and unquote-splice. </p><p class="calibre5">Ruby provides a control structure named <tt class="calibre11">unless</tt> that reverses the sense (<a href="#filepos1080694"><span class="calibre8"><span class="underline">Olsen 2007</span></span></a>) of a <tt class="calibre11">when</tt> statement, executing the body of a block when a given condition evaluates to false: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(unless (even? 3) "Now we see it...")<br class="calibre3"/>;=&gt; "Now we see it..."<br class="calibre3"/><br class="calibre3"/>(unless (even? 2) "Now we don't.")<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p class="calibre12">The maverick implementation<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos604821"><span class="calibre33"><span class="calibre8"><span class="underline">6</span></span></span></a><span class="calibre33">]</span></small></sup> of <tt class="calibre11">unless</tt> as demonstrated previously and as shown in the following listing is straightforward. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos604821" class="calibre32"><span class="calibre33">6</span></small></sup><span class="calibre10"> The proper way to define </span><span class="calibre10"><tt class="calibre11">unless</tt></span><span class="calibre10"> is either </span><span class="calibre10"><tt class="calibre11">(defmacro unless [&amp; args] `(when-not ~@args))</tt></span><span class="calibre10"> or even </span><span class="calibre10"><tt class="calibre11">(clojure.contrib.def/defalias unless when-not)</tt></span><span class="calibre10">—or just use </span><span class="calibre10"><tt class="calibre11">when-not</tt></span><span class="calibre10"> from the start. </span></blockquote><p id="filepos605299" class="calibre12"><span class="calibre10"><span class="bold">Listing 8.2. A Clojure Implementation of </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">unless</span></tt></span></p><p class="calibre1"><img src="images/00052.jpg" class="calibre76"/></p><p class="calibre5">The body of the <tt class="calibre11">unless</tt> implementation uses three features first shown in section 1.5.6: syntax-quote (written as a single back-quote), unquote (written as <tt class="calibre11">~</tt>), and unquote-splice (written as <tt class="calibre11">~@</tt>). Syntax-quote allows the <tt class="calibre11">if</tt> form to act as a template for the expression that any use of the macro becomes when expanded. The unquote and splicing-unquote provide the “blanks” where the values for the parameters <tt class="calibre11">condition</tt> and <tt class="calibre11">body</tt> will be inserted. </p><p class="calibre5">Because <tt class="calibre11">unless</tt> relies on the result of a condition for its operation, it’s imperative that it evaluate the condition part using unquote. If we didn’t use unquote in this instance, then instead of evaluating a function <tt class="calibre11">(even? 3)</tt>, it would instead attempt to resolve a namespace Var named <tt class="calibre11">condition</tt> that may not exist—and if it does exist, it <a id="filepos606505"></a>might be arbitrarily truthy at the time of the macro call. Some of the unintended consequences of this mistake are shown in the next listing. </p><p id="filepos606658" class="calibre5"><span class="calibre10"><span class="bold">Listing 8.3. Name capture in </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">unless</span></tt></span></p><p class="calibre1"><img src="images/00031.jpg" class="calibre77"/></p><p class="calibre5">Clearly this isn’t the desired behavior. Instead, by unquoting the <tt class="calibre11">condition</tt> local, we ensure that the function call is used instead. It’s easy to forget to add an unquote to the body of a macro, and depending on the condition of your runtime environment, the problem may not be immediately obvious. </p><p id="filepos607261" class="calibre5"><span class="calibre18"><span class="bold">8.3. Macros combining forms </span></span></p><p class="calibre7">Macros are often used for combining a number of forms and actions into one consistent view. This behavior could be seen in the previous section with the <tt class="calibre11">do-until</tt> macro, but it’s more general. In this section, we’ll show how macros can be used to combine a number of tasks in order to simplify an API. Clojure’s <tt class="calibre11">defn</tt> macro is an instance of this type of macro because it aggregates the processes of creating a function, including </p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24">Creating the corresponding function object using <tt class="calibre11">fn</tt></li><li value="2" class="calibre24">Checking for and attaching a documentation string</li><li value="3" class="calibre24">Building the <tt class="calibre11">:arglists</tt> metadata </li><li value="4" class="calibre24">Binding the function name to a Var</li><li value="5" class="calibre24">Attaching the collected metadata</li></ul><p class="calibre5">You could perform all of these steps over and over again every time you wanted to create a new function, but thanks to macros you can instead use the more convenient <tt class="calibre11">defn</tt> form. Regardless of your application domain and its implementation, programming language boilerplate code inevitably occurs. But identifying these repetitive tasks and writing macros to simplify and reduce or eliminate the tedious copy-paste-tweak cycle can work to reduce the incidental complexities inherent in a project. Where macros differ from techniques familiar to proponents of Java’s object-oriented style—including hierarchies, frameworks, inversion of control, and the like—is that they’re treated no differently by the language itself. Clojure macros work to mold the language into the problem space rather than forcing you to mold the problem space into the constructs of the language. There’s a specific term for this, <span class="italic">domain-specific language</span>, but in Lisp the distinction between DSL and API is thin to the point of transparency. </p><p class="calibre5">Envision a scenario where you want to be able to define Vars that call a function whenever their root bindings change. You could do this using the <tt class="calibre11">add-watch</tt> function <a id="filepos609594"></a>that allows for the attachment of a <span class="italic">watcher</span> to a reference type that’s called whenever a change occurs within. The <tt class="calibre11">add-watch</tt> function itself takes three arguments: a reference, a watch function key, and a watch function called whenever a change occurs. You could enforce that every time someone wants to define a new Var, they must follow these steps: </p><div class="calibre22"> </div><ol class="calibre48"><li value="1" class="calibre24">Define the Var.</li><li value="2" class="calibre24">Define a function (maybe inline to save a step) that will be the watcher.</li><li value="3" class="calibre24">Call <tt class="calibre11">add-watch</tt> with the proper values. </li></ol><p class="calibre5">A meager three steps isn’t too cumbersome a task to remember in a handful of uses, but over the course of a large project it’s easy to forget and/or morph one of these steps when the need to perform them many times occurs. Therefore, perhaps a better approach is to define a macro to perform all of these steps for you, as the following definition does: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defmacro def-watched [name &amp; value]<br class="calibre3"/>  `(do<br class="calibre3"/>     (def ~name ~@value)<br class="calibre3"/>     (add-watch (var ~name)<br class="calibre3"/>                :re-bind<br class="calibre3"/>                (fn [~'key ~'r old# new#]<br class="calibre3"/>                  (println old# " -&gt; " new#)))))</tt></span></blockquote><p class="calibre12">Ignoring symbol resolution and auto-gensym, which we’ll cover in upcoming sections, the macro called as <tt class="calibre11">(def-watched x 2)</tt> expands into roughly the following: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(do (def x 2)<br class="calibre3"/>    (add-watch (var x)<br class="calibre3"/>               :re-bind<br class="calibre3"/>               (fn [key r old new]<br class="calibre3"/>                 (println old " -&gt; " new))))</tt></span></blockquote><p class="calibre12">The results of <tt class="calibre11">def-watched</tt> are thus </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def-watched x (* 12 12))<br class="calibre3"/>x<br class="calibre3"/>;=&gt; 144<br class="calibre3"/><br class="calibre3"/>(def x 0)<br class="calibre3"/>; 144 -&gt; 0</tt></span></blockquote><p class="calibre12">Lisp programs in general (and Clojure programs specifically) use macros of this sort to vastly reduce the boilerplate needed to perform common tasks. Throughout this chapter, you’ll see macros that combine forms, so there’s no need to dwell on the matter here. Instead, we’ll move on to a macro <tt class="calibre11">domain</tt> that does just that, with the added bonus of performing some interesting transformations in the process. </p><p id="filepos612355" class="calibre5"><span class="calibre18"><span class="bold">8.4. Using macros to change forms </span></span></p><p class="calibre7">One way to design macros is to start by writing out example code that you wish worked—code that has the minimal distance between what you must specify and the <a id="filepos612640"></a>specific application domain in which you’re working. Then, with the goal of making this code work, you begin writing macros and functions to fill in the missing pieces. </p><p class="calibre5">For example, when designing software systems, it’s often useful to identify the “things” comprising your given application domain, including their logical groupings. The level of abstraction at this point in the design is best kept high (<a href="#filepos1081436"><span class="calibre8"><span class="underline">Rosenberg 2005</span></span></a>) and shouldn’t include details about implementation. Imagine that you want to describe a simple domain of the ongoing struggle between humans and monsters: </p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24">Man versus monster <div class="calibre22"> </div><ul class="calibre78"><li value="1" class="calibre24">People <div class="calibre22"> </div><ul class="calibre79"><li value="1" class="calibre24">Men (humans) <div class="calibre22"> </div><ul class="calibre79"><li value="1" class="calibre24">Name</li><li value="2" class="calibre24">Have beards?</li></ul></li></ul></li><li value="2" class="calibre24">Monsters <div class="calibre22"> </div><ul class="calibre79"><li value="1" class="calibre24">Chupacabra <div class="calibre22"> </div><ul class="calibre79"><li value="1" class="calibre24">Eats goats?</li></ul></li></ul></li></ul></li></ul><p class="calibre5">Though this is a simple format, it needs work to be programmatically useful. Therefore, the goal of this section is to write macros performing the steps to get from this simple representation to the one more conducive to processing. One such structure is a tree composed of individual generic nodes, each taking a form similar to that shown in the next listing. </p><p id="filepos614432" class="calibre5"><span class="calibre10"><span class="bold">Listing 8.4. Domain DSL’s underlying form </span></span><a></a></p><p class="calibre1"><img src="images/00057.jpg" class="calibre80"/></p><p class="calibre5">You’d never say this is a beautiful format, but it does present practical advantages over the original format—it’s a tree, it’s composed of simple types, it’s regular, and it’s recognizable to some existing libraries. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre28"><span class="calibre10"><span class="bold">Clojure Aphorism</span></span></p><p class="calibre5">Clojure is a design language where the conceptual model is also Clojure.</p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">We’ll start with the outer-level element, <tt class="calibre11">domain</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defmacro domain [name &amp; body]<br class="calibre3"/>  `{:tag :domain,<br class="calibre3"/>    :attrs {:name (str '~name)},<br class="calibre3"/>    :content [~@body]})</tt></span></blockquote><p class="calibre12">The body of <tt class="calibre11">domain</tt> is fairly straightforward in that it sets the domain-level tree node and splices the body of the macro into the <tt class="calibre11">:content</tt> slot. After <tt class="calibre11">domain</tt> expands, you’d expect its body to be composed of a number of <tt class="calibre11">grouping</tt> forms, which are then handled by the aptly named macro: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(declare handle-things)<br class="calibre3"/><br class="calibre3"/>(defmacro grouping [name &amp; body]<br class="calibre3"/>  `{:tag :grouping,<br class="calibre3"/>    :attrs {:name (str '~name)},<br class="calibre3"/>    :content [~@(handle-things body)]})</tt></span></blockquote><p id="filepos616303" class="calibre12">Similarly to <tt class="calibre11">domain</tt>, <tt class="calibre11">grouping</tt> expands into a node with its body spliced into the <tt class="calibre11">:con-tent</tt> slot. But <tt class="calibre11">grouping</tt> differs from <tt class="calibre11">domain</tt> in that it splices in the result of the call to a function <tt class="calibre11">handle-things</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(declare grok-attrs grok-props)<br class="calibre3"/><br class="calibre3"/>(defn handle-things [things]<br class="calibre3"/>  (for [t things]<br class="calibre3"/>    {:tag :thing,<br class="calibre3"/>     :attrs (grok-attrs (take-while (comp not vector?) t))<br class="calibre3"/>     :content (if-let [c (grok-props (drop-while (comp not vector?) t))]<br class="calibre3"/>                [c]<br class="calibre3"/>                [])})))</tt></span></blockquote><p class="calibre12">Because the body of a thing is fairly simple and regular, we can simplify the implementation of <tt class="calibre11">handle-things</tt> by again splitting it into two functions. The first function <tt class="calibre11">grok-attrs</tt> handles everything within the body of a thing that’s not a vector, and the other <tt class="calibre11">grok-props</tt> handles properties that are. In both cases, these leaf-level functions return specifically formed maps: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn grok-attrs [attrs]<br class="calibre3"/>  (into {:name (str (first attrs))}<br class="calibre3"/>        (for [a (rest attrs)]<br class="calibre3"/>          (cond<br class="calibre3"/>            (list? a) [:isa (str (second a))]<br class="calibre3"/>            (string? a) [:comment a]))))</tt></span></blockquote><p class="calibre12">The implementation of <tt class="calibre11">grok-attrs</tt> may seem overly complex, especially given that the example domain model DSL only allows for a comment attribute and an optional <tt class="calibre11">isa</tt> specification. But by laying out this way, we can easily expand the function to handle a richer set of attributes later. Likewise with <tt class="calibre11">grok-props</tt>, we provide a more complicated function to pull apart the vector representing a property so that it’s more conducive to expansion: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn grok-props [props]<br class="calibre3"/>  (when props<br class="calibre3"/>    {:tag :properties, :attrs nil,<br class="calibre3"/>     :content (apply vector (for [p props]<br class="calibre3"/>                 {:tag :property,<br class="calibre3"/>                  :attrs {:name (str (first p))},<br class="calibre3"/>                  :content nil}))}))</tt></span></blockquote><p class="calibre12">Now that we’ve created the pieces, take a look at the new DSL in action in the following listing.</p><p id="filepos618979" class="calibre5"><span class="calibre10"><span class="bold">Listing 8.5. Exploring the domain DSL results </span></span><a></a></p><p class="calibre1"><img src="images/00051.jpg" class="calibre81"/></p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(:tag d)<br class="calibre3"/>;=&gt; :domain<br class="calibre3"/><br class="calibre3"/>(:tag (first (:content d)))<br class="calibre3"/>;=&gt; :grouping</tt></span></blockquote><p id="filepos619398" class="calibre12">Maybe that’s enough to prove to you that we’ve constructed the promised tree, but probably not. Therefore, we can pass a tree into a function that expects one of that form<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos619844"><span class="calibre33"><span class="calibre8"><span class="underline">7</span></span></span></a><span class="calibre33">]</span></small></sup> and see what comes out on the other end: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos619844" class="calibre32"><span class="calibre33">7</span></small></sup><span class="calibre10"> The namespace </span><span class="calibre10"><tt class="calibre11">clojure.contrib.json</tt></span><span class="calibre10"> in the Clojure contrib library also contains some functions that would be able to handle the domain DSL structure seamlessly. Additionally, Enlive (</span><a href="http://mng.bz/8Hh6"><span class="calibre10"><span class="calibre8"><span class="underline">http://mng.bz/8Hh6</span></span></span></a><span class="calibre10">) should also recognize the resultant structure. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(use '[clojure.xml :as xml])<br class="calibre3"/>(xml/emit d)</tt></span></blockquote><p class="calibre12">Performing this function call will print out the corresponding XML representation, minus the pretty printing, shown here.</p><p id="filepos620626" class="calibre5"><span class="calibre10"><span class="bold">Listing 8.6. An XML transformation of the domain DSL structure </span></span><a></a></p><p class="calibre1"><img src="images/00063.jpg" class="calibre82"/></p><p id="filepos620874" class="calibre5">Our approach was to define a single macro entry point <tt class="calibre11">domain</tt>, intended to build the top-level layers of the output data structure and instead pass the remainder on to auxiliary functions for further processing. In this way, the body of the macro expands into a series of function calls, each taking some subset of the remaining structure and returning some result that’s spliced into the final result. This functional composition approach is fairly common when defining macros. The entirety of the domain description could’ve been written within one monolithic macro, but by splitting the responsibilities, you can more easily extend the representations for the constituent parts. </p><p class="calibre5">Macros take data and return data, always. It so happens that in Clojure, code is data and data is code.</p><p id="filepos621735" class="calibre5"><span class="calibre18"><span class="bold">8.5. Using macros to control symbolic resolution time </span></span></p><p class="calibre7">Whereas functions accept and return values that are meaningful to your application at runtime, macros accept and return code forms that are meaningful at compile time. Any symbol has some subtleties depending on whether it’s fully qualified or not, its resolution time, and its lexical context. These factors can be controlled in any particular case by the appropriate use of quoting and unquoting, which we explore in this section. </p><p class="calibre5">Clojure macros are mostly safe from name capture, in that the use of syntax-quote in macros is encouraged and idiomatic, and it’ll resolve symbols at macro-expansion time. This strategy reduces complexity by ensuring that symbols refer to those available at a known instance rather than to those unknown in the execution context. </p><p class="calibre5">For example, consider one of the simplest possible macros:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defmacro resolution [] `x)</tt></span></blockquote><p class="calibre12">Viewing the expansion of this macro is illuminating in understanding how Clojure macros resolve symbols:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(macroexpand '(resolution))<br class="calibre3"/>;=&gt; user/x</tt></span></blockquote><p class="calibre12">The expansion of the macro resolves the namespace of the syntax-quoted symbol <tt class="calibre11">x</tt>. This behavior is useful in Clojure by helping to avoid free name capturing problems that are possible in a macro system such as that found in Common Lisp.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos623751"><span class="calibre33"><span class="calibre8"><span class="underline">8</span></span></span></a><span class="calibre33">]</span></small></sup> Here’s an example that would trip up a lesser implementation of syntax-quote, but which does just what we want in Clojure: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos623751" class="calibre32"><span class="calibre33">8</span></small></sup><span class="calibre10"> Among one of the ways that Common Lisp works to alleviate this kind of problem is the use of gensym. The key difference is that in Common Lisp, you have to be careful to avoid name capturing, whereas Clojure avoids it by default. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(def x 9)<br class="calibre3"/>(let [x 109] (resolution))<br class="calibre3"/>;=&gt; 9</tt></span></blockquote><p id="filepos624210" class="calibre12">The <tt class="calibre11">x</tt> defined in the <tt class="calibre11">let</tt> isn’t the same as the namespace-qualified <tt class="calibre11">user/x</tt> referred to by the macro <tt class="calibre11">resolution</tt>. As you might expect, the macro would’ve thrown an unbound Var exception had we not first executed the call to <tt class="calibre11">def</tt>. </p><p class="calibre5">Clojure does provide a way to defer symbolic resolution for those instances where it may be useful to resolve it within the execution context, which we’ll show now. </p><p id="filepos624717" class="calibre5"><span class="bold">8.5.1. Anaphora </span><a></a></p><p class="calibre7">Anaphora<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos625628"><span class="calibre33"><span class="calibre8"><span class="underline">9</span></span></span></a><span class="calibre33">]</span></small></sup> in spoken language is a term used in a sentence referring back to a previously identified subject or object. It helps to reduce repetition in a phrase by replacing “Jim bought 6,000 Christmas lights and hung all of the Christmas lights,” with “Jim bought 6,000 Christmas lights and hung <span class="italic">them</span> all.” In this case, the word <span class="italic">them</span> is the anaphora. Some programming languages use anaphora, or allow for their simple definition. Scala has a rich set of anaphoric (<a href="#filepos1079993"><span class="calibre8"><span class="underline">Odersky 2008</span></span></a>) patterns primarily focused around its <tt class="calibre11">_</tt> operator: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos625628" class="calibre32"><span class="calibre33">9</span></small></sup><span class="calibre10"> Anaphora is pronounced </span><span class="calibre10"><span class="italic">un-NAF-er-uh</span></span><span class="calibre10">. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">Array(1, 2, 3, 4, 5).map(2 * _)<br class="calibre3"/>//=&gt; res0: Array[Int] = Array(2, 4, 6, 8, 10)</tt></span></blockquote><p class="calibre12">In this Scala example, the underscore serves to refer back to an implicitly passed argument to the <tt class="calibre11">map</tt> function, which in this case would be each element of the array in succession. The same expression could be written with <tt class="calibre11">(x) =&gt; 2 * x</tt>—the syntax for an anonymous function—in the body of the <tt class="calibre11">map</tt> call, but that would be unnecessarily verbose. </p><p class="calibre5">Anaphora don’t nest, and as a result are generally not employed in Clojure. Within a nested structure of anaphoric macros, you can only refer to the most immediate anaphoric binding, and never those from outer lexical contours, as demonstrated in <a href="#filepos627003"><span class="calibre8"><span class="underline">listing 8.7</span></span></a>. For example, the Arc programming language (Graham Arc) contains a macro named <tt class="calibre11">awhen</tt> similar to Clojure’s <tt class="calibre11">when</tt>, save that it implicitly defines a local named <tt class="calibre11">it</tt> used within its body to refer to the value of the checked expression. </p><p id="filepos627003" class="calibre5"><span class="calibre10"><span class="bold">Listing 8.7. An example of anaphora and its weakness </span></span><a></a></p><p class="calibre1"><img src="images/00062.jpg" class="calibre83"/></p><p id="filepos627241" class="calibre5">Clojure provides similar macros that do nest and replace the need for anaphora: <tt class="calibre11">if-let</tt> and <tt class="calibre11">when-let</tt>. When designing your own macros, it’s preferred that you build them along these lines so that the macro itself takes the name to be bound. But just because typical anaphorics are limited, that’s not to say that they’re entirely useless. Instead, for your own libraries you may find that their usage is intuitive. You’ll see the pattern <tt class="calibre11">~'symbol</tt> at times in Clojure macros, because this is the idiomatic way to selectively capture a symbolic name within the body of a macro. The reason for this bit of awkwardness<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos628312"><span class="calibre33"><span class="calibre8"><span class="underline">10</span></span></span></a><span class="calibre33">]</span></small></sup> is because Clojure’s syntax-quote attempts to resolve symbols in the current context, resulting in fully qualified symbols. Therefore, <tt class="calibre11">~'</tt> avoids that resolution by unquoting a quote. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos628312" class="calibre32"><span class="calibre33">10</span></small></sup><span class="calibre10"><span class="italic">Awkwardness is good since it’s a strong signal to make the user aware he is drifting away from the true path to clojure enlightenment.</span></span><span class="calibre10">—Christophe Grand </span></blockquote><p id="filepos628577" class="calibre35"><span class="bold">8.5.2. (Arguably) useful selective name capturing </span><a></a></p><p class="calibre7">We contend that there’s only one case to be made for selective name capturing in Clojure macros—the case when you’re forced to embed third-party macros and functions in your macros that rely on the existence of anaphora. One such macro is the <tt class="calibre11">proxy</tt> macro in Clojure’s core libraries, which provides an anaphoric symbol named <tt class="calibre11">this</tt> within its body for use therein. We’ll cover the <tt class="calibre11">proxy</tt> macro in depth in <a href="#filepos643937"><span class="calibre8"><span class="underline">section 9.1</span></span></a>, so there’s no need to discuss it here. But bear in mind that should this macro ever be embedded within your own macros, you may be forced to use the <tt class="calibre11">~'this</tt> pattern. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre28"><span class="calibre10"><span class="bold">Hygiene</span></span></p><p class="calibre5">A <span class="italic">hygienic</span> macro is one that doesn’t cause name capturing at macro expansion time. Clojure macros help to ensure hygiene by namespace-resolving symbols within the body of syntax-quote at macro-definition time. As you saw, symbols are expanded into the form <tt class="calibre11">user/a-symbol</tt> within the body of syntax-quote. To close this hygienic loop, Clojure also disallows the definition of qualified locals within the body of a macro. In order to selectively capture names within Clojure macros, you <span class="italic">must</span> explicitly do so via the <tt class="calibre11">~'a-symbol</tt> pattern. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">Clojure prefers that symbols be either declared or bound at macro-definition time. But using the resolution deferment strategy outlined earlier, you can relax this requirement for those instances where doing so would be useful. </p><p id="filepos630545" class="calibre5"><span class="calibre18"><span class="bold">8.6. Using macros to manage resources </span></span></p><p class="calibre7">Managing scarce resources or those with a finite lifetime is often viewed as a sweet spot for macro usage. In Java, such activities are almost always performed using the <tt class="calibre11">try/catch/finally</tt> idiom (<a href="#filepos1069400"><span class="calibre8"><span class="underline">Bloch 2008</span></span></a>), as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">try {<br class="calibre3"/>     // open the resource<br class="calibre3"/>}<br class="calibre3"/>catch (Exception e) {<br class="calibre3"/>     // handle any errors<br class="calibre3"/>}<br class="calibre3"/>finally {<br class="calibre3"/>// in any case, release the resource<br class="calibre3"/>}</tt></span></blockquote><p id="filepos631267" class="calibre12">We showed in section 1.5.8 that Clojure also has a <tt class="calibre11">try/catch/finally</tt> form that can be used in the same way, but like the Java idiom, you must remember to explicitly close the resource within the <tt class="calibre11">finally</tt> block. Clojure provides a generic <tt class="calibre11">with-open</tt> macro, demonstrated in <a href="#filepos631838"><span class="calibre8"><span class="underline">listing 8.8</span></span></a>, that when given a “closeable” object bound to a name, will automatically call its <tt class="calibre11">.close</tt> method (assuming that one exists) within a <tt class="calibre11">finally</tt> block. </p><p id="filepos631838" class="calibre5"><span class="calibre10"><span class="bold">Listing 8.8. An example of </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">with-open</span></tt></span></p><p class="calibre1"><img src="images/00064.jpg" class="calibre84"/></p><p class="calibre5">Not all instances of resources in your own programs will be closeable. In these instances, we present a generic template for resource allocating macros that can be used for many cases, shown in the following listing. </p><p id="filepos632346" class="calibre5"><span class="calibre10"><span class="bold">Listing 8.9. A more general template for </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">with-open</span></tt></span><span class="calibre10"><span class="bold">-like macros </span></span></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defmacro with-resource [binding close-fn &amp; body]<br class="calibre3"/>  `(let ~binding<br class="calibre3"/>     (try<br class="calibre3"/>       (do ~@body)<br class="calibre3"/>        (finally<br class="calibre3"/>        (~close-fn ~(binding 0))))))<br class="calibre3"/><br class="calibre3"/>(let [stream (joc-www)]<br class="calibre3"/>  (with-resource [page stream]<br class="calibre3"/>     #(.close %)<br class="calibre3"/>    (.readLine page)))</tt></span></blockquote><p class="calibre12">The macro <tt class="calibre11">with-resource</tt> is generic enough and so generally ubiquitous across differing flavors (Symbolics Inc.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos634009"><span class="calibre33"><span class="calibre8"><span class="underline">11</span></span></span></a><span class="calibre33">]</span></small></sup>) to almost be considered a Lisp design pattern. The <a id="filepos633367"></a>macro <tt class="calibre11">with-resource</tt> differs from <tt class="calibre11">with-open</tt> in that it does not assume that its resource is closeable but instead delegates the task of closing the resource to a <tt class="calibre11">close-fn</tt> function taken as an argument. One final point is that <tt class="calibre11">with-resource</tt> avoids the nesting problem of anaphoric macros because it requires that the resource be named explicitly a la <tt class="calibre11">[stream (joc-www)]</tt>. This approach allows for the proper nesting of <tt class="calibre11">with-resource</tt> macros; and in fact, the use of named bindings marked by vectors is ubiquitous and idiomatic in Clojure. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos634009" class="calibre32"><span class="calibre33">11</span></small></sup><span class="calibre10"> The spirit of this section was inspired by a similar discussion of “Writing Macros to Surround Code.” If you can get your hands on the original Symbolics manuals, do so—they contain a wealth of information. </span></blockquote><p id="filepos634303" class="calibre5"><span class="calibre18"><span class="bold">8.7. Putting it all together: macros returning functions </span></span></p><p class="calibre7">In <a href="#filepos487603"><span class="calibre8"><span class="underline">section 7.1</span></span></a>, we introduced Clojure’s constraint facility that uses pre- and postcondition checks on function arguments and return values respectively to ensure some assertions about said function. In that section, we talked briefly about how separating the constraints from the functions they’re constraining allows you to more flexibly apply different assertion templates based on need and context. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre28"><span class="calibre10"><span class="bold">Clojure Aphorism</span></span></p><p class="calibre5">Clojure programmers don’t write their apps in Clojure. They write the language that they use to write their apps in Clojure.</p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">In this section, we’re going to take this idea one step further by introducing a macro named <tt class="calibre11">contract</tt> that implements a simple DSL to describe function constraints. For example, a proposed DSL should be nameable and describe its pre- and postconditions in an intuitive way, building a higher-order function that will be used to apply its constraints later. The following sketches a contract specifying that a function should take only a positive number and return its value multiplied by 2: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(contract doubler<br class="calibre3"/>  [x]<br class="calibre3"/>  (:require<br class="calibre3"/>    (pos? x))<br class="calibre3"/>  (:ensure<br class="calibre3"/>    (= (* 2 x) %)))</tt></span></blockquote><p class="calibre12">The contract’s <tt class="calibre11">:require</tt> list (Meyer 2000) refers to preconditions, and the <tt class="calibre11">:ensure</tt> list the postconditions. Given this description, how would you start to implement a macro to realize this sketch? If you haven’t already gathered from the section title and the initial problem statement, the macro must return a function, so we’ll start there with the following listing. </p><p id="filepos636559" class="calibre5"><span class="calibre10"><span class="bold">Listing 8.10. The contract top-level macro </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(declare collect-bodies)<br class="calibre3"/><br class="calibre3"/>(defmacro contract [name &amp; forms]<br class="calibre3"/>  (list* `fn name (collect-bodies forms)))</tt></span></blockquote><p class="calibre12">The <tt class="calibre11">contract</tt> macro calls a function <tt class="calibre11">collect-bodies</tt> that hasn’t been written yet, so we had to use <tt class="calibre11">declare</tt> to avoid a compilation error. Hold fast, because we’re going to implement that necessary function soon. But first, imagine what the form of the returned function will be when it finally comes out of <tt class="calibre11">contract</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(fn doubler<br class="calibre3"/>  ([f x]<br class="calibre3"/>     {:post [(= (* 2 x) %)],<br class="calibre3"/>      :pre [(pos? x)]}<br class="calibre3"/>     (f x)))</tt></span></blockquote><p id="filepos637507" class="calibre12">We also want to allow for the multi-arity function definition form so that the <tt class="calibre11">contract</tt> can take more than one specification per arity function, each separated by a vector of symbols. The first step down that path starts with an implementation of <tt class="calibre11">collect-bodies</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(declare build-contract)<br class="calibre3"/><br class="calibre3"/>(defn collect-bodies [forms]<br class="calibre3"/>  (for [form (partition 3 forms)]<br class="calibre3"/>    (build-contract form)))</tt></span></blockquote><p class="calibre12">The primary task of <tt class="calibre11">collect-bodies</tt> is to build a list of the body portion of the <tt class="calibre11">contract</tt>, each partitioned into three segments. These partitions represent the arg-list, <tt class="calibre11">require</tt>s, and <tt class="calibre11">ensure</tt>s of the contract, which we’ll then pass along to another function named <tt class="calibre11">build-contract</tt>, that will build the arity bodies and corresponding constraint maps. This is shown next. </p><p id="filepos638511" class="calibre5"><span class="calibre10"><span class="bold">Listing 8.11. The contract auxiliary function </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">build-contract</span></tt></span></p><p class="calibre1"><img src="images/00066.jpg" class="calibre85"/></p><p class="calibre5">The function <tt class="calibre11">build-contract</tt> is where the heart of contract construction lies, building the arity bodies that contain constraint maps. The difference is that each body is a higher-order function that takes an additional function as an argument, which the arguments are then delegated to. This allows us to compose the contract function with a constrained function, as shown in the next listing. </p><p id="filepos639229" class="calibre5"><span class="calibre10"><span class="bold">Listing 8.12. Composition of contract function and constrained function </span></span><a></a></p><p class="calibre1"><img src="images/00068.jpg" class="calibre86"/></p><p id="filepos639486" class="calibre5">As you might expect, <tt class="calibre11">times2</tt> fulfills the contract, whereas <tt class="calibre11">times3</tt> doesn’t. We could extend <tt class="calibre11">doubler-contract</tt> to handle extended arities, as shown here. </p><p id="filepos639698" class="calibre5"><span class="calibre10"><span class="bold">Listing 8.13. Contract for multiple-arity functions </span></span><a></a></p><p class="calibre1"><img src="images/00008.jpg" class="calibre87"/></p><p class="calibre5">We could extend the contract to cover any number of expected function arities using <tt class="calibre11">contract</tt>, independent of the functions themselves. This provides a nice separation of the work to be done from the expected work to be done. By using the <tt class="calibre11">contract</tt> macro, we’ve provided a way to describe the expectations of a function, including but not limited to </p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24">The possible types of its inputs and output</li><li value="2" class="calibre24">The relationship of the function output to its inputs</li><li value="3" class="calibre24">The expected function arities</li><li value="4" class="calibre24">The “shape” of the inputs and output</li></ul><p class="calibre5">The <tt class="calibre11">contract</tt> macro could be extended in many complementary ways. For example, Clojure’s function constraints are verified using logical <tt class="calibre11">and</tt>—the implications being that any additional pre- or postcondition works to tighten the requirements. But there may be times when loosening the constraints on the inputs and tightening them on the output makes more sense. In any case, this section isn’t about the nuances of contracts programming, and to dig deeper would elude the point that using macros to return functions is an extremely powerful way to extend the capabilities of Clojure itself. </p><p id="filepos641366" class="calibre5"><span class="calibre18"><span class="bold">8.8. Summary </span></span></p><p class="calibre7">We’ve explored various use cases for macros and given examples of each. Though instructive to the point under discussion, we also tried to show how macros can be used to mold Clojure into the language that shortens the gap between your problem space and solution space. In your own unique programs, you should try to do the same. But the most important skill that you can learn on your path toward macro mastery is the ability to recognize when to avoid using them. The general answer of course is whenever, and as often as you can. </p><p class="calibre5">In the next chapter, we’ll cover various powerful way to organize and categorize data types and functions using Clojure’s namespaces, multimethods, types, and protocols. </p><div class="mbppagebreak"></div><p id="filepos642230" class="calibre5"><span class="calibre6"><span class="bold">Chapter 9. Combining data and code </span></span><a></a></p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">This chapter covers</span>
</p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24"><a href="#filepos643937"><span class="calibre8"><span class="underline">Namespaces</span></span></a></li><a id="filepos642651"></a><li value="2" class="calibre24"><a href="#filepos660369"><span class="calibre8"><span class="underline">Exploring Clojure multimethods with the Universal Design Pattern</span></span></a></li><li value="3" class="calibre24"><a href="#filepos677632"><span class="calibre8"><span class="underline">Types, protocols, and records</span></span></a></li><li value="4" class="calibre24"><a href="#filepos718597"><span class="calibre8"><span class="underline">Putting it all together: a fluent builder for chess moves</span></span></a></li></ul><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">Clojure provides powerful features for grouping and partitioning logical units of code and data. Most logical groupings occur within namespaces, Clojure’s analogue to Java packages. We explore how to build, manipulate, and reason about them. Also, in this chapter we’ll play with Clojure’s powerful multimethods that provide polymorphism based on arbitrary dispatch functions. We then uncover recent additions to Clojure supporting <span class="italic">abstraction-oriented programming</span>—types, protocols, and records. Finally, the chapter concludes with the creation of a fluent chess-move facility, comparing a Java approach to solving the problem with a Clojure approach. </p><p id="filepos643937" class="calibre5"><span class="calibre18"><span class="bold">9.1. Namespaces </span></span></p><p id="filepos644014" class="calibre7">Newcomers to Clojure have a propensity to hack away at namespace declarations until they appear to work. This may work sometimes, but it delays the process of learning how to leverage namespaces more effectively. </p><p class="calibre5">From a high-level perspective, namespaces can be likened to a two-level mapping, where the first level is a symbol to a namespace containing mappings of symbols to Vars, as shown in <a href="#filepos645083"><span class="calibre8"><span class="underline">figure 9.1</span></span></a>. This conceptual model<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos644885"><span class="calibre33"><span class="calibre8"><span class="underline">1</span></span></span></a><span class="calibre33">]</span></small></sup> is slightly complicated by the fact that namespaces can be aliased, but even in these circumstances the model holds true. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos644885" class="calibre32"><span class="calibre33">1</span></small></sup><span class="calibre10"> As always, we’re trying to keep the level of discussion limited to abstractions rather than implementation details. </span></blockquote><p id="filepos645083" class="calibre12"><span class="calibre10"><span class="bold">Figure 9.1. The logical layout of namespaces. The process to resolve a Var </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">joy.ns/authors</span></tt></span><span class="calibre10"><span class="bold"> includes a symbolic resolution of the namespace and the Var name. The result is the Var itself. Aliases created with </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">:use</span></tt></span><span class="calibre10"><span class="bold"> work as expected. </span></span></p><p class="calibre1"><img src="images/00083.jpg" class="calibre88"/></p><p class="calibre5">In the simplest possible terms, qualified symbols of the form <tt class="calibre11">joy.ns/authors</tt> cause a two-level lookup: a symbol <tt class="calibre11">joy.ns</tt> used to lookup a namespace map and a symbol <tt class="calibre11">authors</tt> used to retrieve a Var, as shown in the following listing. </p><p id="filepos645922" class="calibre5"><span class="calibre10"><span class="bold">Listing 9.1. Namespace navigation </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(in-ns 'joy.ns)<br class="calibre3"/>(def authors ["Chouser"])<br class="calibre3"/><br class="calibre3"/>(in-ns 'your.ns)<br class="calibre3"/>(clojure.core/refer 'joy.ns)<br class="calibre3"/>joy.ns/authors<br class="calibre3"/>;=&gt; ["Chouser"]<br class="calibre3"/><br class="calibre3"/>(in-ns 'joy.ns)<br class="calibre3"/>(def authors ["Chouser" "Fogus"])<br class="calibre3"/><br class="calibre3"/>(in-ns 'your.ns)<br class="calibre3"/>joy.ns/authors<br class="calibre3"/>;=&gt; ["Chouser" "Fogus"]</tt></span></blockquote><p class="calibre12">Because a symbolic name refers to a Var in the current namespace or another, it follows that any referred Var always evaluates to the current value and not the value present at referral time. </p><p id="filepos646681" class="calibre5"><span class="bold">9.1.1. Creating namespaces </span><a></a></p><p id="filepos646754" class="calibre7">There are a number of ways to create a new namespace; each has its advantages and use cases. The choice of one namespace-creation mechanism over another amounts to choosing the level of control over the default symbolic mappings. </p><p class="calibre5"><span class="calibre10"><span class="bold">NS </span></span></p><p class="calibre7">In idiomatic Clojure source code, you’ll see the <tt class="calibre11">ns</tt> macro used almost exclusively. By using the <tt class="calibre11">ns</tt> macro, you automatically get two sets of symbolic mappings—all classes in the <tt class="calibre11">java.lang</tt> package and all of the functions, macros, and special forms in the <tt class="calibre11">clojure.core</tt> namespace: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(ns chimp)<br class="calibre3"/>(reduce + [1 2 (Integer. 3)])<br class="calibre3"/>;=&gt; 6</tt></span></blockquote><p class="calibre12">Using the <tt class="calibre11">ns</tt> macro creates a namespace if it doesn’t already exist, and switches to that namespace. The <tt class="calibre11">ns</tt> macro is intended for use in source code files and not in the REPL, although there’s nothing preventing it. </p><p class="calibre5"><span class="calibre10"><span class="bold">IN-NS </span></span></p><p class="calibre7">Using the <tt class="calibre11">in-ns</tt> function also imports the <tt class="calibre11">java.lang</tt> package like <tt class="calibre11">ns</tt>; but it doesn’t create any mappings for functions or macros in <tt class="calibre11">clojure.core</tt>. The <tt class="calibre11">in-ns</tt> function also takes an explicit symbol used as the namespace qualifier, as in </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(in-ns 'gibbon)<br class="calibre3"/><br class="calibre3"/>(reduce + [1 2 (Integer. 3)])<br class="calibre3"/>; java.lang.Exception: Unable to resolve symbol: reduce in this context<br class="calibre3"/><br class="calibre3"/>(clojure.core/refer 'clojure.core)<br class="calibre3"/>(reduce + [1 2 (Integer. 3)])<br class="calibre3"/>;=&gt; 6</tt></span></blockquote><p class="calibre12">The <tt class="calibre11">in-ns</tt> function is more amenable to REPL experimentation when dealing with namespaces than <tt class="calibre11">ns</tt>. </p><p class="calibre5"><span class="calibre10"><span class="bold">Create-NS </span></span></p><p class="calibre7">The finest level of control for creating namespaces is provided through the <tt class="calibre11">create-ns</tt> function, which when called takes a symbol and returns a namespace object: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def b (create-ns 'bonobo))<br class="calibre3"/>b<br class="calibre3"/>;=&gt; #&lt;Namespace bonobo&gt;<br class="calibre3"/><br class="calibre3"/>((ns-map b) 'String)<br class="calibre3"/>;=&gt; java.lang.String</tt></span></blockquote><p class="calibre12">The call to <tt class="calibre11">create-ns</tt> doesn’t switch to the named namespace, but it does create Java class mappings automatically. When given a namespace object (retrieved using the <tt class="calibre11">find-ns</tt> function also), you can manipulate its bindings programmatically using the functions <tt class="calibre11">intern</tt> and <tt class="calibre11">ns-unmap</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(intern b 'x 9)<br class="calibre3"/>;=&gt; #'bonobo/x<br class="calibre3"/>bonobo/x<br class="calibre3"/>;=&gt; 9</tt></span></blockquote><p id="filepos649759" class="calibre12">In the preceding code, we bound the symbol <tt class="calibre11">x</tt> to the value <tt class="calibre11">9</tt> in the namespace <tt class="calibre11">bonobo</tt>, and then referenced it directly using its qualified name <tt class="calibre11">bonobo/x</tt>. We can do the same thing for any type of Var binding: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(intern b 'reduce clojure.core/reduce)<br class="calibre3"/>;=&gt; #'bonobo/reduce<br class="calibre3"/><br class="calibre3"/>(intern b '+ clojure.core/+)<br class="calibre3"/>;=&gt; #'bonobo/+<br class="calibre3"/><br class="calibre3"/>(in-ns 'bonobo)<br class="calibre3"/>(reduce + [1 2 3 4 5])<br class="calibre3"/>;=&gt; 15</tt></span></blockquote><p class="calibre12">Because only Java class mappings are created by <tt class="calibre11">create-ns</tt>, you’ll have to <tt class="calibre11">intern</tt> any Clojure core functions, as we did with <tt class="calibre11">+</tt> and <tt class="calibre11">reduce</tt>. You can even inspect the mappings within a namespace programmatically, and likewise remove specific mappings: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(in-ns 'user)<br class="calibre3"/>(get (ns-map 'bonobo) 'reduce)<br class="calibre3"/>;=&gt; #'bonobo/reduce<br class="calibre3"/><br class="calibre3"/>(ns-unmap 'bonobo 'reduce)  ;=&gt; nil<br class="calibre3"/><br class="calibre3"/>(get (ns-map 'bonobo) 'reduce)<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p class="calibre12">Finally, you can wipe a namespace using <tt class="calibre11">remove-ns</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(remove-ns 'bonobo)<br class="calibre3"/>;=&gt; #&lt;Namespace bonobo&gt;<br class="calibre3"/><br class="calibre3"/>(all-ns)<br class="calibre3"/>;=&gt; (#&lt;Namespace clojure.set&gt; #&lt;Namespace clojure.main&gt;<br class="calibre3"/>     #&lt;Namespace clojure.core&gt; #&lt;Namespace clojure.zip&gt;<br class="calibre3"/>     #&lt;Namespace chimp&gt; #&lt;Namespace gibbon&gt;<br class="calibre3"/>     #&lt;Namespace clojure.xml&gt;)</tt></span></blockquote><p class="calibre12">You should be careful when populating namespaces using <tt class="calibre11">create-ns</tt> and <tt class="calibre11">intern</tt>, because they cause potentially confusing side-effects to occur. Their use is intended only for advanced techniques, and even then they should be used cautiously. </p><p id="filepos651817" class="calibre5"><span class="bold">9.1.2. Expose only what’s needed </span><a></a></p><p class="calibre7">Knowing that namespaces operate as a two-level mapping will only get you so far in creating and using them effectively. You must understand other practical matters to use namespaces to their fullest. For example, for a given namespace <tt class="calibre11">joy.contracts</tt>, your directory structure could look like that in <a href="#filepos652310"><span class="calibre8"><span class="underline">figure 9.2</span></span></a>. </p><p id="filepos652310" class="calibre5"><span class="calibre10"><span class="bold">Figure 9.2. Namespace private directories: the directories layout for an illustrative </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">joy.contracts</span></tt></span><span class="calibre10"><span class="bold"> namespace </span></span></p><p class="calibre1"><img src="images/00084.jpg" class="calibre89"/></p><p id="filepos652672" class="calibre5">This directory structure is fairly straightforward, but there are a couple items to note. First, though the namespace is named <tt class="calibre11">joy.contracts</tt>, the corresponding Clojure source file is located in the contracts-lib/src/joy directory. This is a common technique in organizing Java and Clojure projects, where the actual source directories and files are located in a common src subdirectory in the main project directory. The additional files build.xml, pom.xml, and project.clj correspond to the build scripts for Apache Ant, Maven, and Leiningen, respectively. These build scripts will know, through either configuration or convention, that the src directory contains the directories and source files for Clojure namespaces and <span class="italic">not</span> part of the namespace logical layout. If you were to open the contracts.clj file located in contracts-lib/src/joy in your favorite editor, then you might see something like that shown in <a href="#filepos653707"><span class="calibre8"><span class="underline">figure 9.3</span></span></a>. </p><p id="filepos653707" class="calibre5"><span class="calibre10"><span class="bold">Figure 9.3. Namespace private source: the top of the source file for the </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">joy.contracts</span></tt></span><span class="calibre10"><span class="bold"> namespace </span></span></p><p class="calibre1"><img src="images/00012.jpg" class="calibre90"/></p><p class="calibre5">The file contracts.clj defines the namespace <tt class="calibre11">joy.contracts</tt> and defines the function <tt class="calibre11">build-contract</tt> using the <tt class="calibre11">defn-</tt> macro. The use of <tt class="calibre11">defn-</tt> in this way indicates to Clojure that the <tt class="calibre11">build-contract</tt> function is private to the <tt class="calibre11">joy.contracts</tt> namespace. The <tt class="calibre11">defn-</tt> macro is provided for convenience and simply attaches privileged metadata to the Var containing the function. You could attach the same namespace privacy metadata yourself, as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(ns hider.ns)<br class="calibre3"/><br class="calibre3"/>(defn ^{:private true} answer [] 42)<br class="calibre3"/><br class="calibre3"/>(ns seeker.ns<br class="calibre3"/>  (:refer hider.ns))<br class="calibre3"/><br class="calibre3"/>(answer)<br class="calibre3"/>; java.lang.Exception: Unable to resolve symbol: answer in this context</tt></span></blockquote><p class="calibre12">The use of <tt class="calibre11">^{:private true}</tt> in this way will also work within a <tt class="calibre11">def</tt> and a <tt class="calibre11">defmacro</tt>, and for these cases it’s required, because there’s no corresponding <tt class="calibre11">def-</tt> and <tt class="calibre11">defmacro-</tt> in Clojure’s core. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre28"><span class="calibre10"><span class="bold">Hyphens/Underscores</span></span></p><p class="calibre5">If you decide to name your namespaces with hyphens, à la <tt class="calibre11">my-cool-lib</tt>, then the corresponding source file <span class="italic">must</span> be named with underscores in place of the hyphens (my_cool_lib.clj). </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">Because Clojure namespace names are tied to the directory in which they reside, you can also create a certain directory structure conducive to hiding implementation details, as seen in <a href="#filepos656017"><span class="calibre8"><span class="underline">figure 9.4</span></span></a>. </p><p id="filepos656017" class="calibre5"><span class="calibre10"><span class="bold">Figure 9.4. Private API directories: using the folder layout to hide namespace implementation details </span></span><a></a></p><p class="calibre1"><img src="images/00021.jpg" class="calibre91"/></p><p class="calibre5">By creating another subdirectory to contracts-lib/src/joy named impl, you can effectively hide implementation details for your code. The public-facing API would be <a id="filepos656496"></a>located in contracts.clj and the “hidden” implementation details in impl.clj. Your clients would be expected to refer only to the elements in contracts.clj, whereas your library could refer to elements in impl.clj, as shown in <a href="#filepos656809"><span class="calibre8"><span class="underline">figure 9.5</span></span></a>. </p><p id="filepos656809" class="calibre5"><span class="calibre10"><span class="bold">Figure 9.5. Private API source: the client-facing API is located in contracts.clj and the private API in impl.clj. </span></span><a></a></p><p class="calibre1"><img src="images/00090.jpg" class="calibre92"/></p><p class="calibre5">Of course, nothing’s stopping you from also referencing the <tt class="calibre11">joy.contracts.impl</tt> namespace, but you do so at their own peril. There are never any guarantees that implementation details will remain the same shape from one release to the next. </p><p id="filepos657392" class="calibre5"><span class="bold">9.1.3. Declarative inclusions and exclusions </span><a></a></p><p class="calibre7">When defining namespaces, it’s important to include only the references that are likely to be used. Clojure prefers a fine-grained Var mapping via a set of directives on the <tt class="calibre11">ns</tt> macro: <tt class="calibre11">:exclude, :only, :as, :refer-clojure, :import, :use, :load</tt>, and <tt class="calibre11">:require</tt>. </p><p class="calibre5">We’ll describe a namespace named <tt class="calibre11">joy.ns-ex</tt> first in prose and then using <tt class="calibre11">ns</tt> and its directives. In this namespace, we want to exclude the <tt class="calibre11">defstruct</tt> macro from <a id="filepos658019"></a><tt class="calibre11">clojure.core</tt>. Next, we want to use everything in <tt class="calibre11">clojure.set</tt> and <tt class="calibre11">clojure.xml</tt> without namespace qualification. Likewise, we wish to use only the functions <tt class="calibre11">are</tt> and <tt class="calibre11">is</tt> from the <tt class="calibre11">clojure.test</tt> namespace without qualification. We then want to load the <tt class="calibre11">clojure.zip</tt> namespace and alias it as <tt class="calibre11">z</tt>. Finally, we want to import the Java classes <tt class="calibre11">java.util.Date</tt> and <tt class="calibre11">java.io.File</tt>. By providing directives, the problem of namespace inclusions and exclusions become a declarative matter, as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(ns joy.ns-ex<br class="calibre3"/>  (:refer-clojure :exclude [defstruct])<br class="calibre3"/>  (:use (clojure set xml))<br class="calibre3"/>  (:use [clojure.test :only (are is)])<br class="calibre3"/>  (:require (clojure [zip :as z]))<br class="calibre3"/>  (:import (java.util Date)<br class="calibre3"/>           (java.io File)))</tt></span></blockquote><p class="calibre12">We’ll touch on further uses of namespaces throughout the rest of the book, with an extensive example explaining their use as JVM class specifications in <a href="#filepos767521"><span class="calibre8"><span class="underline">section 10.3</span></span></a>. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre28"><span class="calibre10"><span class="bold">Avoid Naked :Use</span></span></p><p class="calibre5">One point of note that we should mention is that the <tt class="calibre11">(:use (clojure set xml))</tt> statement is considered a promiscuous operation and therefore discouraged. The <tt class="calibre11">:use</tt> directive without the <tt class="calibre11">:only</tt> option pulls in all of the public Vars in <tt class="calibre11">clojure.set</tt> and <tt class="calibre11">clojure.xml</tt> indiscriminately. Though this practice is useful when incrementally building your code, it shouldn’t endure into the production environment. When organizing your code along namespaces, it’s good practice to export and import <span class="italic">only</span> those elements needed. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">We now turn our focus to Clojure’s multimethods, a way of defining polymorphic functions based on the results of arbitrary functions, which will get you halfway toward a system of polymorphic types. </p><p id="filepos660369" class="calibre5"><span class="calibre18"><span class="bold">9.2. Exploring Clojure multimethods with the Universal Design Pattern </span></span></p><blockquote class="calibre9"><span class="italic">The most specific event can serve as a general example of a class of events.</span></blockquote><blockquote class="calibre25"><span class="italic">Douglas R. Hofstadter</span></blockquote><p class="calibre5">In Douglas Hofstadter’s Pulitzer prize winning work <span class="italic">Gödel, Escher, Bach: An Eternal Golden Braid</span>, he describes a notion of the <span class="italic">Prototype Principle</span>—the tendency of the human mind to use specific events as models for similar but different events or things. He presents the idea “that there is generality in the specific” (<a href="#filepos1075047"><span class="calibre8"><span class="underline">Hofstadter 1979</span></span></a>). Building on this idea, programmer Steve Yegge coined the term <span class="italic">The Universal Design Pattern (UDP)</span>, extrapolating on Hofstadter’s idea (<a href="#filepos1088385"><span class="calibre8"><span class="underline">Yegge 2008</span></span></a>) and presenting it in terms of prototypal inheritance (<a href="#filepos1083264"><span class="calibre8"><span class="underline">Ungar 1987</span></span></a>). </p><p class="calibre5">The UDP is built on the notion of a map or map-like object. Though not ground-breaking, the flexibility in the UDP derives from the fact that each map contains a reference to a <span class="italic">prototype</span> map used as a parent link to inherited fields. You might wonder how anyone could model a software problem in this way, but we assure you that <a id="filepos661881"></a>countless programmers do so every day when they choose JavaScript (<a href="#filepos1071280"><span class="calibre8"><span class="underline">Flanagan 2006</span></span></a>). In this section, we’ll implement a subset of Yegge’s UDP and discuss how it might be used as the basis for abstraction-oriented programming and polymorphism using Clojure’s multimethods and ad hoc hierarchies. </p><p id="filepos662250" class="calibre5"><span class="bold">9.2.1. The parts </span><a></a></p><p class="calibre7">In addition to the aforementioned prototype reference, the UDP requires a set of supporting functions to operate: <tt class="calibre11">beget, get, put, has?</tt>, and <tt class="calibre11">forget</tt>. The entire UDP is built on these five functions, but we’ll need the first three for this section. </p><p class="calibre5"><span class="calibre10"><span class="bold">Beget </span></span></p><p class="calibre7">The <tt class="calibre11">beget</tt> function performs a simple task. It takes a map and associates its prototype reference to another map, returning a new map: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(ns joy.udp<br class="calibre3"/>  (:refer-clojure :exclude [get]))<br class="calibre3"/><br class="calibre3"/>(defn beget [o p] (assoc o ::prototype p))<br class="calibre3"/><br class="calibre3"/>(beget {:sub 0} {:super 1})<br class="calibre3"/>;=&gt; {:joy.udp/prototype {:super 1}, :sub 0}</tt></span></blockquote><p class="calibre12">To participate in the UDP, maps must have a <tt class="calibre11">:joy.udp/prototype</tt> entry. </p><p class="calibre5"><span class="calibre10"><span class="bold">Put </span></span></p><p class="calibre7">The function <tt class="calibre11">put</tt> takes a key and an associated value and puts them into the supplied map, overwriting any existing key of the same name: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def put assoc)</tt></span></blockquote><p class="calibre12">The <tt class="calibre11">put</tt> function is asymmetric to the functionality of <tt class="calibre11">get</tt>. The <tt class="calibre11">get</tt> method retrieves values anywhere along the prototype chain, whereas <tt class="calibre11">put</tt> only ever inserts at the level of the supplied map. </p><p class="calibre5"><span class="calibre10"><span class="bold">Get </span></span></p><p class="calibre7">Because of the presence of the prototype link, <tt class="calibre11">get</tt> requires more than a simple one-level lookup. Instead, whenever a value isn’t found in a given map, the prototype chain is followed until the end: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn get [m k]<br class="calibre3"/>  (when m<br class="calibre3"/>    (if-let [[_ v] (find m k)]<br class="calibre3"/>      v<br class="calibre3"/>      (recur (::prototype m) k))))<br class="calibre3"/><br class="calibre3"/>(get (beget {:sub 0} {:super 1})<br class="calibre3"/>     :super)<br class="calibre3"/>;=&gt; 1</tt></span></blockquote><p class="calibre12">We don’t explicitly handle the case of “removed” properties, but instead treat them like any other associated value. This is fine because the “not found” value of <tt class="calibre11">nil</tt> is falsey. Most of the time, it’s sufficient to rely on the fact that looking up a nonexistent <a id="filepos664847"></a>key will return <tt class="calibre11">nil</tt>. But in cases where you want to allow users of your functions to store any value at all, including <tt class="calibre11">nil</tt>, you’ll have to be careful to distinguish <tt class="calibre11">nil</tt> from “not found,” and the <tt class="calibre11">find</tt> function is the best way to do this. </p><p id="filepos665137" class="calibre5"><span class="bold">9.2.2. Usage </span><a></a></p><p class="calibre7">Using only <tt class="calibre11">beget, put</tt>, and <tt class="calibre11">get</tt>, you can leverage the UDP in some simple, yet powerful ways. Assume that at birth cats like dogs and only learn to despise them when goaded. Morris the cat has spent most of his life liking 9-Lives cat food and dogs, until the day comes when a surly Shih Tzu leaves him battered and bruised. We can model this unfortunate story as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def cat {:likes-dogs true, :ocd-bathing true})<br class="calibre3"/>(def morris (beget {:likes-9lives true} cat))<br class="calibre3"/>(def post-traumatic-morris (beget {:likes-dogs nil} morris))<br class="calibre3"/><br class="calibre3"/>(get cat :likes-dogs)<br class="calibre3"/>;=&gt; true<br class="calibre3"/><br class="calibre3"/>(get morris :likes-dogs)<br class="calibre3"/>;=&gt; true<br class="calibre3"/><br class="calibre3"/>(get post-traumatic-morris :likes-dogs)<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p class="calibre12">The map <tt class="calibre11">post-traumatic-morris</tt> is like the old <tt class="calibre11">morris</tt> in every way except for the fact that he has learned to hate dogs. Modeling cat and dog societal woes is interesting but far from the only use case for the UDP, as you’ll see next. </p><p class="calibre5"><span class="calibre10"><span class="bold">No Notion of Self </span></span></p><p class="calibre7">Our implementation of the UDP contains no notion of self-awareness via an implicit <tt class="calibre11">this</tt> or <tt class="calibre11">self</tt> reference. Though adding such a feature would probably be possible, we’ve intentionally excluded it in order to draw a clear separation between the prototypes and the functions that work on them (<a href="#filepos1076477"><span class="calibre8"><span class="underline">Keene 1989</span></span></a>). A better solution, and one that follows in line with a deeper Clojure philosophy, would be to access, use, and manipulate these prototypes using Clojure’s multimethods. </p><p id="filepos667042" class="calibre5"><span class="bold">9.2.3. Multimethods to the rescue </span><a></a></p><p class="calibre7">Adding behaviors to the UDP can be accomplished easily using Clojure’s multimethod facilities. <span class="italic">Multimethods</span> provide a way to perform function polymorphism based on the result of an arbitrary dispatch function. Coupled with our earlier UDP implementation, we can implement a prototypal object system with differential inheritance similar to (although not as elegant as) that in the Io language (Dekorte Io). First, we’ll need to define a multimethod <tt class="calibre11">compiler</tt> that dispatches on a key <tt class="calibre11">:os</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defmulti  compiler :os)<br class="calibre3"/>(defmethod compiler ::unix [m] (get m :c-compiler))<br class="calibre3"/>(defmethod compiler ::osx  [m] (get m :c-compiler))</tt></span></blockquote><p id="filepos667913" class="calibre12">The multimethod <tt class="calibre11">compiler</tt> describes a simple scenario: if the function <tt class="calibre11">compiler</tt> is called with a prototype map, then the map is queried for an element <tt class="calibre11">:os</tt>, which has methods defined on the results for either <tt class="calibre11">::unix</tt> or <tt class="calibre11">::osx</tt>. We’ll create some prototype maps to exercise <tt class="calibre11">compiler</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def clone (partial beget {}))<br class="calibre3"/>(def unix   {:os ::unix, :c-compiler "cc", :home "/home", :dev "/dev"})<br class="calibre3"/>(def osx  (-&gt; (clone unix)<br class="calibre3"/>              (put :os ::osx)<br class="calibre3"/>              (put :c-compiler "gcc")<br class="calibre3"/>              (put :home "/Users")))<br class="calibre3"/><br class="calibre3"/>(compiler unix)<br class="calibre3"/>;=&gt; "cc"<br class="calibre3"/><br class="calibre3"/>(compiler osx)<br class="calibre3"/>;=&gt; "gcc"</tt></span></blockquote><p class="calibre12">That’s all there is (<a href="#filepos1079581"><span class="calibre8"><span class="underline">Foote 2003</span></span></a>) to creating behaviors that work against the specific “type” of a prototype map. But a problem of inherited behaviors still persists. Because our implementation of the UDP separates state from behavior, there’s seemingly no way to associate inherited behaviors. But as we’ll now show, Clojure does provide a way to define ad hoc hierarchies that we can use to simulate inheritance within our model. </p><p id="filepos669350" class="calibre5"><span class="bold">9.2.4. Ad hoc hierarchies for inherited behaviors </span><a></a></p><p class="calibre7">Based on the layout of the <tt class="calibre11">unix</tt> and <tt class="calibre11">osx</tt> prototype maps, the property <tt class="calibre11">:home</tt> is overridden in <tt class="calibre11">osx</tt>. We could again duplicate the use of <tt class="calibre11">get</tt> within each method defined (as in <tt class="calibre11">compiler</tt>), but instead we prefer to say that the lookup of <tt class="calibre11">:home</tt> should be a derived function: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defmulti home :os)<br class="calibre3"/>(defmethod home ::unix [m] (get m :home))<br class="calibre3"/><br class="calibre3"/>(home unix)<br class="calibre3"/>;=&gt; "/home"<br class="calibre3"/><br class="calibre3"/>(home osx)<br class="calibre3"/>; java.lang.IllegalArgumentException:<br class="calibre3"/>;   No method in multimethod 'home' for dispatch value: :user/osx</tt></span></blockquote><p class="calibre12">Clojure allows you to define a relationship stating “<tt class="calibre11">::osx</tt> is a <tt class="calibre11">::unix</tt>” and have the derived function take over the lookup behavior using Clojure’s <tt class="calibre11">derive</tt> function: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(derive ::osx ::unix)</tt></span></blockquote><p class="calibre12">Now the <tt class="calibre11">home</tt> function works: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(home osx)<br class="calibre3"/>;=&gt; "/Users"</tt></span></blockquote><p class="calibre12">You can query the derivation hierarchy using the functions <tt class="calibre11">parents, ancestors, descendants</tt>, and <tt class="calibre11">isa?</tt> as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(parents ::osx)<br class="calibre3"/>;=&gt; #{:user/unix}<br class="calibre3"/>(ancestors ::osx)<br class="calibre3"/>;=&gt; #{:user/unix}<br class="calibre3"/><br class="calibre3"/>(descendants ::unix)<br class="calibre3"/>;=&gt; #{:user/osx}<br class="calibre3"/><br class="calibre3"/>(isa? ::osx ::unix)<br class="calibre3"/>;=&gt; true<br class="calibre3"/>(isa? ::unix ::osx)<br class="calibre3"/>;=&gt; false</tt></span></blockquote><p id="filepos671230" class="calibre12">The result of the <tt class="calibre11">isa?</tt> function defines how multimethods dispatch. In the absence of a derivation hierarchy, <tt class="calibre11">isa?</tt> can be likened to pure equality, but with it traverses a derivation graph. </p><p id="filepos671470" class="calibre5"><span class="bold">9.2.5. Resolving conflict in hierarchies </span><a></a></p><p class="calibre7">What if we interject another ancestor into the hierarchy for <tt class="calibre11">::osx</tt> and want to again call the <tt class="calibre11">home</tt> method? Observe the following: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(derive ::osx ::bsd)<br class="calibre3"/>(defmethod home ::bsd [m] "/home")<br class="calibre3"/><br class="calibre3"/>(home osx)<br class="calibre3"/>; java.lang.IllegalArgumentException: Multiple methods in multimethod<br class="calibre3"/>;  'home' match dispatch value: :user/osx -&gt; :user/unix and<br class="calibre3"/>;  :user/bsd, and neither is preferred</tt></span></blockquote><p class="calibre12">As shown in <a href="#filepos672728"><span class="calibre8"><span class="underline">figure 9.6</span></span></a>, <tt class="calibre11">::osx</tt> derives from both <tt class="calibre11">::bsd</tt> and <tt class="calibre11">::unix</tt>, so there’s no way to decide which method to dispatch, because they’re both at the same level in the derivation hierarchy. Fortunately, Clojure provides a way to assign favor to one method over another using the function <tt class="calibre11">prefer-method</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(prefer-method home ::unix ::bsd)<br class="calibre3"/>(home osx)<br class="calibre3"/>;=&gt; "/Users"</tt></span></blockquote><p id="filepos672728" class="calibre12"><span class="calibre10"><span class="bold">Figure 9.6. Hierarchy conflict: most languages allowing type derivations use a built-in conflict-resolution strategy. In the case of CLOS, it’s fully customizable. Clojure requires conflicts to be resolved with </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">prefer-method</span></tt></span><span class="calibre10"><span class="bold">. </span></span></p><p class="calibre1"><img src="images/00091.jpg" class="calibre93"/></p><p class="calibre5">In this case, we used <tt class="calibre11">prefer-method</tt> to explicitly state that for the multimethod <tt class="calibre11">home</tt>, we prefer the method associated with the dispatch value <tt class="calibre11">::unix</tt> over the one for <tt class="calibre11">::bsd</tt>, as illustrated in <a href="#filepos656809"><span class="calibre8"><span class="underline">figure 9.5</span></span></a>. As you’ll recall, the <tt class="calibre11">home</tt> method for <tt class="calibre11">::unix</tt> explicitly used <tt class="calibre11">get</tt> to traverse the prototype chain, which is the preferred behavior. </p><p class="calibre5">As you might expect, removing the <tt class="calibre11">home</tt> method for the <tt class="calibre11">::bsd</tt> dispatch value using <tt class="calibre11">remove-method</tt> will remove the preferential lookup for <tt class="calibre11">::osx</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(remove-method home ::bsd)<br class="calibre3"/>(home osx)<br class="calibre3"/>;=&gt; "/Users"</tt></span></blockquote><p class="calibre12">All of these functions manipulate and operate off of the global hierarchy map directly. If you prefer to reduce these potentially confusing side-effects, then you can define a derivation hierarchy using <tt class="calibre11">make-hierarchy</tt> and <tt class="calibre11">derive</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(derive (make-hierarchy) ::osx ::unix)<br class="calibre3"/>;=&gt; {:parents {:user/osx #{:user/unix}},<br class="calibre3"/>      :ancestors {:user/osx #{:user/unix}},<br class="calibre3"/>      :descendants {:user/unix #{:user/osx}}}</tt></span></blockquote><p id="filepos674644" class="calibre12">Once you have a separate hierarchy in hand, you can provide it to <tt class="calibre11">defmulti</tt> to specify the derivation context, thus preserving the global hierarchy map. </p><p id="filepos674838" class="calibre5"><span class="bold">9.2.6. Arbitrary dispatch for true maximum power </span><a></a></p><p class="calibre7">Until now, we’ve only exercised multimethods using a single privileged <tt class="calibre11">:os</tt> property, but this doesn’t accentuate their true power. Instead, multimethods are fully open and can dispatch on the result of an arbitrary function, even one that can pull apart and/ or combine its inputs into any form: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defmulti  compile-cmd  (juxt :os compiler))<br class="calibre3"/><br class="calibre3"/>(defmethod compile-cmd [::osx "gcc"] [m]<br class="calibre3"/>  (str "/usr/bin/" (get m :c-compiler)))<br class="calibre3"/><br class="calibre3"/>(defmethod compile-cmd :default [m]<br class="calibre3"/>  (str "Unsure where to locate " (get m :c-compiler)))</tt></span></blockquote><p class="calibre12">The dispatch values for the new <tt class="calibre11">compile-cmd</tt> methods are vectors composed of the results of looking up the <tt class="calibre11">:os</tt> key and calling the <tt class="calibre11">compiler</tt> function defined earlier. You can now observe what happens when <tt class="calibre11">compile-cmd</tt> is called: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(compile-cmd osx)<br class="calibre3"/>;=&gt; "/usr/bin/gcc"<br class="calibre3"/><br class="calibre3"/>(compile-cmd unix)<br class="calibre3"/>;=&gt; "Unsure where to locate cc"</tt></span></blockquote><p class="calibre12">Using multimethods and the UDP is an interesting way to build abstractions. Multi-methods and ad hoc hierarchies are open systems, allowing for polymorphic dispatch based on arbitrary functions. Clojure also provides a simpler model for creating abstractions and gaining the benefits of polymorphism—types, protocols, and records—which we’ll cover next. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">The handy-dandy juxt function</span>
</p><p class="calibre7">The <tt class="calibre11">juxt</tt> function is highly useful in defining multimethod dispatch functions. In a nutshell, <tt class="calibre11">juxt</tt> takes a bunch of functions and composes them into a function returning a vector of its argument(s) applied to each given function, as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def each-math (juxt + * - /))<br class="calibre3"/>(each-math 2 3)<br class="calibre3"/>;=&gt; [5 6 -1 2/3]<br class="calibre3"/><br class="calibre3"/>((juxt take drop) 3 (range 9))<br class="calibre3"/>[(0 1 2) (3 4 5 6 7 8)]</tt></span></blockquote><p class="calibre12">Having a convenient and succinct way to build vectors of applied functions is powerful for defining understandable multimethods—although that’s not the limit of <tt class="calibre11">juxt</tt>’s usefulness. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p id="filepos677632" class="calibre5"><span class="calibre18"><span class="bold">9.3. Types, protocols, and records </span></span></p><p id="filepos677728" class="calibre7">We showed in the previous section that Clojure multimethods provide a way to achieve runtime polymorphism based on arbitrary dispatch functions. Though extremely powerful, multimethods are sometimes less than ideal. Interposing a dispatch function into the polymorphism machinery isn’t always conducive to raw speed. Likewise, dispatching on an arbitrary function is often overkill. Therefore, Clojure provides facilities for creating logically grouped polymorphic functions that are both simple and performant—types, records, and protocols. We’ll delve into these topics in this section and introduce the concept of abstraction-oriented programming, predicated on the creation of logical groupings. But first, we’ll discuss the simplest of the three topics, records, which you might recognize. </p><p id="filepos678564" class="calibre5"><span class="bold">9.3.1. Records </span><a></a></p><p class="calibre7">Using maps as data objects is perfectly acceptable and has several lovely features. Chief among these is that maps require no declaration of any sort: you just use literal syntax to build them right on the spot. We showed this in <a href="#filepos519998"><span class="calibre8"><span class="underline">section 7.2</span></span></a> when we built an object like this: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">{:val 5, :l nil, :r nil}</tt></span></blockquote><p class="calibre12">This is handy but is missing things that are often desirable, the most significant of which is a type of its own. The object constructed here is some kind of map, but it isn’t, as far as Clojure is concerned, a <tt class="calibre11">TreeNode</tt>. That means that when used in its simple form as we did here, there’s no clean way<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos679720"><span class="calibre33"><span class="calibre8"><span class="underline">2</span></span></span></a><span class="calibre33">]</span></small></sup> to determine whether any particular map is a <tt class="calibre11">TreeNode</tt> or not. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos679720" class="calibre32"><span class="calibre33">2</span></small></sup><span class="calibre10"> You could test a map for the existence of the keys </span><span class="calibre10"><tt class="calibre11">:val, :l</tt></span><span class="calibre10">, and </span><span class="calibre10"><tt class="calibre11">:r</tt></span><span class="calibre10">, a sort of duck-typing but on fields instead of methods. But because there exists a real possibility than some other kind of object may happen to have these keys but use them in a different way, undesirable complexity and/or unexpected behavior is likely. Fortunately, you can mitigate this risk by using namespace-qualified keywords. Despite the general agreement of experts that ducks are Kosher, we’d definitely classify this particular duck as unclean. </span></blockquote><p class="calibre12">In such circumstances, records become a compelling<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos680853"><span class="calibre33"><span class="calibre8"><span class="underline">3</span></span></span></a><span class="calibre33">]</span></small></sup> solution. You define a record type with a <tt class="calibre11">defrecord</tt> form. For example, a <tt class="calibre11">defrecord</tt> for <tt class="calibre11">TreeNode</tt> looks like this: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos680853" class="calibre32"><span class="calibre33">3</span></small></sup><span class="calibre10"> There was a pre-Clojure 1.2 convention of attaching </span><span class="calibre10"><tt class="calibre11">:type</tt></span><span class="calibre10"> metadata to an object, which can be looked up with the type function, but this approach is rarely if ever needed moving forward. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defrecord TreeNode [val l r])</tt></span></blockquote><p class="calibre12">This creates a new Java class with a constructor that takes a value for each of the fields listed. It also imports that class into your current namespace so you can easily use it to create new instances. </p><p class="calibre5">Here’s how to create an instance of the <tt class="calibre11">TreeNode</tt> record: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(TreeNode. 5 nil nil)<br class="calibre3"/>;=&gt; #:user.TreeNode{:val 5, :l nil, :r nil}</tt></span></blockquote><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">Explicit importing of defrecord and deftype classes</span>
</p><p id="filepos681989" class="calibre7">It’s important to note that when you define a <tt class="calibre11">defrecord</tt> and <tt class="calibre11">deftype</tt>, corresponding classes are generated. These classes are automatically imported into the same namespace where the <tt class="calibre11">defrecord</tt> and <tt class="calibre11">deftype</tt> declarations occur, but <span class="italic">not</span> in any other namespace. Instead, you <span class="italic">must explicitly import</span>
<tt class="calibre11">defrecord</tt> and <tt class="calibre11">deftype</tt> classes using the <tt class="calibre11">import</tt> function or <tt class="calibre11">:import</tt> namespace declaration: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(ns my-cool-ns<br class="calibre3"/>  (:import joy.udp.TreeNode))</tt></span></blockquote><p class="calibre12">Loading a namespace via <tt class="calibre11">:require</tt> or <tt class="calibre11">:use</tt> won’t be enough to import <tt class="calibre11">defrecord</tt> and <tt class="calibre11">deftype</tt> classes. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">The use of <tt class="calibre11">defrecord</tt> buys you several important benefits. First of all, it provides a simple and specific idiom for documenting the expected fields of the object. But it also delivers several important performance improvements. A record will be created more quickly, consume less memory, and look up keys in itself more quickly than the equivalent array map or hash map. Data types can also store primitive values (byte, int, long, and so on), which take up considerably less memory than the equivalent boxed objects (Byte, Integer, Long, and so on) supported by other collection types. </p><p class="calibre5">That’s a lot of benefit, so what does it cost you? The first cost we already mentioned—you must define the record type before using it. Another is that currently, records aren’t printed in a way that the Clojure reader can read, unlike hash maps. This can be a problem if you’re using Clojure’s print functions to save off or transmit data. Here’s what it looks like if we try, successfully, with a literal map and then again, unsuccessfully, with a record: </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">The downfall of defstructs</span>
</p><p class="calibre7">Clojure provides a <tt class="calibre11">defstruct</tt> mechanism, which can be viewed as a way to define a map that acts as an ad hoc class mechanism. These structs defined a set of keys that were required to exist in the map and could therefore not be removed via <tt class="calibre11">dissoc</tt>. With the advent of <tt class="calibre11">defrecord</tt>, the need for structs has been nearly eliminated, and therefore structs aren’t covered in this book. But if you have a code base reliant on structs, then a record can replace them with minimal code changes, as highlighted here: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn change-age [p] (assoc p :age 286))<br class="calibre3"/><br class="calibre3"/>(defstruct person :fname :lname)<br class="calibre3"/>(change-age (struct person "Immanuel" "Kant"))<br class="calibre3"/>;=&gt; {:fname "Immanuel", :lname "Kant", :age 286}<br class="calibre3"/><br class="calibre3"/>(defrecord Person [fname lname])<br class="calibre3"/>(change-age (Person. "Immanuel" "Kant"))<br class="calibre3"/>;=&gt; #:user.Person{:fname "Immanuel", :lname "Kant", :age 286}</tt></span></blockquote><p class="calibre12">Note that the <tt class="calibre11">change-age</tt> function works with either structs or records—no change is required. Only the definition and the mechanism of instantiation need to be updated. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(read-string (pr-str {:val 5, :l nil, :r nil}))<br class="calibre3"/>;=&gt; {:val 5, :l nil, :r nil}<br class="calibre3"/><br class="calibre3"/>(read-string (pr-str (TreeNode. 5 nil nil)))<br class="calibre3"/>; java.lang.RuntimeException: java.lang.Exception: No dispatch macro for:</tt></span></blockquote><p id="filepos685935" class="calibre12">This may change eventually, but there are some tricky problems yet to be worked out before records can be printed and read back in. </p><p class="calibre5">Other noteworthy differences between maps and records include</p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24">Records, unlike maps, can’t serve as functions.</li><li value="2" class="calibre24">Records are never equal to maps with the same key/value mappings.</li></ul><p class="calibre5">You still look up values in records by doing <tt class="calibre11">(:keyword obj)</tt>; it’s just that if <tt class="calibre11">obj</tt> is a record, this code will run dramatically faster. By the way, that means destructuring will still work as well. Records support metadata using <tt class="calibre11">with-meta</tt> and <tt class="calibre11">meta</tt> just like other Clojure collections, and you can even redefine a record if desired to have different fields giving you the compiled performance of Java dynamically. All of these together mean you can build a lot of code on top of simple hash-map objects and then make minimal changes to switch to using records instead, gaining all the performance benefits we already covered. </p><p class="calibre5">You should understand records well enough to be able to reimplement the persistent binary tree from <a href="#filepos332652"><span class="calibre8"><span class="underline">chapter 5</span></span></a> using <tt class="calibre11">defrecord</tt> instead of maps. This is shown in the following listing. Note that we had to add the <tt class="calibre11">defrecord</tt> and change the expressions in <tt class="calibre11">xconj</tt> where objects are created, but the <tt class="calibre11">xseq</tt> function is defined identically to how it was before. </p><p id="filepos687613" class="calibre5"><span class="calibre10"><span class="bold">Listing 9.2. Persistent binary tree built of records </span></span><a></a></p><p class="calibre1"><img src="images/00071.jpg" class="calibre94"/></p><p class="calibre5">You can <tt class="calibre11">assoc</tt> and <tt class="calibre11">dissoc</tt> any key you want—adding keys that weren’t defined in the <tt class="calibre11">defrecord</tt> works, though they have the performance of a regular map. Perhaps more surprisingly, dissocing a key given in the record works but returns a regular map rather than a record. In this example, note that the return value is printed as a plain map, not with the <tt class="calibre11">#:user.TreeNode</tt> prefix of a record: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(dissoc (TreeNodePlus 5 nil nil) :l)<br class="calibre3"/>;=&gt; {:val 5, :r nil}</tt></span></blockquote><p id="filepos688468" class="calibre12">A final benefit of records is how well they integrate with Clojure protocols. But to fully understand how they relate, we must first explore what protocols are. </p><p id="filepos688662" class="calibre5"><span class="bold">9.3.2. Protocols </span><a></a></p><blockquote class="calibre9"><span class="italic">The establishment of protocols ... creates an obvious way for two people who are not directly communicating to structure independently developed code so that it works in a manner that remains coherent when such code is later combined.</span></blockquote><blockquote class="calibre25"><span class="italic">Kent M. Pitman (</span><a href="#filepos1071935"><span class="italic"><span class="calibre8"><span class="underline">Pitman 2001</span></span></span></a><span class="italic">)</span></blockquote><p class="calibre5">A <span class="italic">protocol</span> in Clojure is simply a set of function signatures, each with at least one parameter, that are given a collective name. They fulfill a role somewhat like Java interfaces or C++ pure virtual classes—a class that claims to implement a particular protocol should provide specialized implementations of each of the functions in that protocol. Then, when any of those functions is called, the appropriate implementation is polymorphic on the type of the first parameter, just like Java. In fact, the first parameter to a protocol function corresponds to the target object (the thing to the left of the dot for a method call used in Java source) of a method in object-oriented parlance. </p><p class="calibre5">For example, consider what collections such as stacks (First In, Last Out: FILO) and queues (First In, First Out: FIFO) have in common. Each has a simple function for inserting a thing (call it <tt class="calibre11">push</tt>), a simple function for removing a thing (<tt class="calibre11">pop</tt>), and usually a function to see what would be removed if you removed a thing (<tt class="calibre11">peek</tt>). What we just gave you was an informal description of a protocol; all that’s missing is the name. We can replace the changing third item of the acronym with an <span class="italic">X</span> and call objects that provide these functions FIXO. Note that besides stacks and queues, FIXO could include priority queues, pipes, and other critters. </p><p class="calibre5">So now let’s look at that informal description rewritten as a formal Clojure definition:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defprotocol FIXO<br class="calibre3"/>  (fixo-push [fixo value])<br class="calibre3"/>  (fixo-pop [fixo])<br class="calibre3"/>  (fixo-peek [fixo]))</tt></span></blockquote><p class="calibre12">...and that’s it. The only reason we prefixed the function names with <span class="italic">fixo-</span> is so that they don’t conflict with Clojure’s built-in functions.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos691427"><span class="calibre33"><span class="calibre8"><span class="underline">4</span></span></span></a><span class="calibre33">]</span></small></sup> Besides that, it’s hard to imagine how there could be much less ceremony, isn’t it? </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos691427" class="calibre32"><span class="calibre33">4</span></small></sup><span class="calibre10"> It would be better to fix this problem by defining FIXO in a new namespace and excluding from it the similarly named clojure.core functions, except this would be a distraction from the point of this section. We’ll discuss interesting interactions between namespaces and protocols later in this chapter. </span></blockquote><p class="calibre12">But in order for a protocol to do any good, something must implement it. Protocols are implemented using one of the <span class="italic">extend</span> forms: <tt class="calibre11">extend, extend-type</tt>,<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos692783"><span class="calibre33"><span class="calibre8"><span class="underline">5</span></span></span></a><span class="calibre33">]</span></small></sup> or <tt class="calibre11">extend-protocol</tt>. Each of these does essentially the same thing, but <tt class="calibre11">extend-type</tt> and <a id="filepos692267"></a><tt class="calibre11">extend-protocol</tt> are convenience macros for when you want to provide multiple functions for a given type. For example, the binary <tt class="calibre11">TreeNode</tt> from <a href="#filepos687613"><span class="calibre8"><span class="underline">listing 9.2</span></span></a> is a record, so if we want to extend it, <tt class="calibre11">extend-type</tt> would be most convenient. Because <tt class="calibre11">TreeNode</tt> already has a function <tt class="calibre11">xconj</tt> that works just like <tt class="calibre11">push</tt> should, we’ll start by implementing that: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos692783" class="calibre32"><span class="calibre33">5</span></small></sup><span class="calibre10"> Records are a specialized kind of data type, so </span><span class="calibre10"><tt class="calibre11">extend-type</tt></span><span class="calibre10"> is used for both. We’ll look at data types later in this section. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(extend-type TreeNode<br class="calibre3"/>  FIXO<br class="calibre3"/>  (fixo-push [node value]<br class="calibre3"/>    (xconj node value)))<br class="calibre3"/><br class="calibre3"/>(xseq (fixo-push sample-tree 5/2))<br class="calibre3"/>;=&gt; (2 5/2 3 4 5 6)</tt></span></blockquote><p class="calibre12">The first argument to <tt class="calibre11">extend-type</tt> is the class or interface that the entire rest of the form will be extending. Following the type name are one or more blocks, each starting with the name of the protocol to be extended and followed by one or more functions from that protocol to implement. So in the preceding example, we’re implementing a single function <tt class="calibre11">fixo-push</tt> for <tt class="calibre11">TreeNode</tt> objects, and we call the existing <tt class="calibre11">xconj</tt> function. Got it? The reason this is better than simply defining a regular function named <tt class="calibre11">fixo-push</tt> is that protocols allow for polymorphism. That same function can have a different implementation for a different kind of object. Clojure vectors can act like stacks by extending <tt class="calibre11">FIXO</tt> to vectors: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(extend-type clojure.lang.IPersistentVector<br class="calibre3"/>  FIXO<br class="calibre3"/>  (fixo-push [vector value]<br class="calibre3"/>    (conj vector value)))<br class="calibre3"/><br class="calibre3"/>(fixo-push [2 3 4 5 6] 5/2)<br class="calibre3"/>;=&gt; [2 3 4 5 6 5/2]</tt></span></blockquote><p class="calibre12">Here we’re extending <tt class="calibre11">FIXO</tt> to an interface instead of a concrete class. This means that <tt class="calibre11">fixo-push</tt> is now defined for all classes that inherit from <tt class="calibre11">IPersistentVector</tt>. Note that we can now call <tt class="calibre11">fixo-push</tt> with either a vector or a <tt class="calibre11">TreeNode</tt>, and the appropriate function implementation is invoked. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">Clojure-style mixins</span>
</p><p class="calibre7">As you proceed through this section, you’ll notice that we extend the <tt class="calibre11">FIXO</tt> protocol’s <tt class="calibre11">fixo-push</tt> function in isolation. This works fine for our purposes, but you might want to take note of the implications of this approach. Consider the following: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(use 'clojure.string)<br class="calibre3"/><br class="calibre3"/>(defprotocol StringOps (rev [s]) (upp [s]))<br class="calibre3"/><br class="calibre3"/>(extend-type String<br class="calibre3"/>  StringOps<br class="calibre3"/>  (rev [s] (clojure.string/reverse s)))<br class="calibre3"/><br class="calibre3"/>(rev "Works")<br class="calibre3"/>;=&gt; "skroW"</tt></span></blockquote><p id="filepos695626" class="calibre12">Defining the <tt class="calibre11">StringOps</tt> protocol and extending its <tt class="calibre11">rev</tt> function to <tt class="calibre11">String</tt> seems to work fine. But observe what happens when the protocol is again extended to cover the remaining <tt class="calibre11">upp</tt> function: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(extend-type String<br class="calibre3"/>  StringOps<br class="calibre3"/>  (upp [s] (clojure.string/upper-case s)))<br class="calibre3"/><br class="calibre3"/>(upp "Works")<br class="calibre3"/>;=&gt; "WORKS"<br class="calibre3"/><br class="calibre3"/>(rev "Works?")<br class="calibre3"/>; IllegalArgumentException No implementation of method: :rev<br class="calibre3"/>;   of protocol: #'user/StringOps found for<br class="calibre3"/>;     class: java.lang.String</tt></span></blockquote><p class="calibre12">The reason for this exception is that for a protocol to be fully populated (all of its functions callable), it must be extended fully, per individual type. Protocol extension is at the granularity of the entire protocol and not at a per-function basis. This behavior seems antithetical to the common notion of a <span class="italic">mixin</span>—granules of discrete functionality that can be “mixed into” existing classes, modules, and so on. Clojure too has mixins, but it takes a slightly different approach: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def rev-mixin {:rev clojure.string/reverse})<br class="calibre3"/><br class="calibre3"/>(def upp-mixin {:upp (fn [this] (.toUpperCase this))})<br class="calibre3"/><br class="calibre3"/>(def fully-mixed (merge upp-mixin rev-mixin))<br class="calibre3"/><br class="calibre3"/>(extend String StringOps fully-mixed)<br class="calibre3"/><br class="calibre3"/>(-&gt; "Works" upp rev)<br class="calibre3"/>;=&gt; SKROW</tt></span></blockquote><p class="calibre12">Mixins in Clojure refer to the creation of discrete maps containing protocol function implementations that are combined in such a way as to create a complete implementation of a protocol. Once mixed together (as in the Var <tt class="calibre11">fully-mixed</tt>), only then are types extended to protocols. As with many of Clojure’s features, mixins and protocol extension are fully open. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">What we’ve just done is impossible with Java interfaces or C++ classes, at least in the order we did it. With either of those languages, the concrete type (such as <tt class="calibre11">TreeNode</tt> or vector) must name <span class="italic">at the time it’s defined</span> all the interfaces or classes it’s going to implement. Here we went the other way around—both <tt class="calibre11">TreeNode</tt> and vectors were defined before the <tt class="calibre11">FIXO</tt> protocol even existed, and we easily extended <tt class="calibre11">FIXO</tt> to each of them. This matters in the real world because the concrete types and even the protocol could be provided by third-party libraries—possibly even different third-party libraries—and we could still match them up, provide implementations for the appropriate functions, and get back to work. All this without any adapters, wrappers, monkey-patching, or other incidental complexity getting in the way. In fact, <span class="italic">Clojure polymorphism lives in the protocol functions, not in the classes</span>, as shown in <a href="#filepos698862"><span class="calibre8"><span class="underline">figure 9.7</span></span></a>. </p><p id="filepos698862" class="calibre5"><span class="calibre10"><span class="bold">Figure 9.7. As opposed to the notion of monkey-patching and wrapping, the polymorphism in Clojure resides in the functions themselves and not in the classes worked with. </span></span><a></a></p><p class="calibre1"><img src="images/00093.jpg" class="calibre95"/></p><p id="filepos699217" class="calibre5">You can even extend a protocol to <tt class="calibre11">nil</tt> itself. You’d be forgiven for not immediately seeing why you’d want to do this; but consider how <tt class="calibre11">TreeNode</tt> implements <tt class="calibre11">fixo-push</tt>, and yet the <tt class="calibre11">sample-tree</tt> we’re using was built using <tt class="calibre11">xconj</tt> instead. Trying to build up a tree the same way with <tt class="calibre11">fixo-push</tt> runs into a problem: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(reduce fixo-push nil [3 5 2 4 6 0])<br class="calibre3"/>; java.lang.IllegalArgumentException:<br class="calibre3"/>; No implementation of method: :fixo-push<br class="calibre3"/>;  of protocol: #'user/FIXO found for class: nil</tt></span></blockquote><p class="calibre12">The <tt class="calibre11">xconj</tt> implementation specifically handled the initial <tt class="calibre11">nil</tt> case, but because protocol methods dispatch on the first argument, we need special support from <tt class="calibre11">extend</tt> to get <tt class="calibre11">fixo-push</tt> to behave similarly. This is done by extending a protocol to the value <tt class="calibre11">nil</tt>, like this: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(extend-type nil<br class="calibre3"/>  FIXO<br class="calibre3"/>  (fixo-push [t v]<br class="calibre3"/>    (TreeNode. v nil nil)))<br class="calibre3"/><br class="calibre3"/>(xseq (reduce fixo-push nil [3 5 2 4 6 0]))<br class="calibre3"/>;=&gt; (0 2 3 4 5 6)</tt></span></blockquote><p class="calibre12">All the options and arrangements of code allowed by <tt class="calibre11">extend</tt> can be disorienting, but one thing you can keep firmly in mind is that <tt class="calibre11">extend</tt> is always about a protocol. Each method listed in an <tt class="calibre11">extend</tt> form is implementing an intersection between a protocol and something else. That something else can be a concrete class, an interface, a record type, or even <tt class="calibre11">nil</tt>, but it’s always being connected to a protocol. </p><p class="calibre5">See the following listing for complete implementations of <tt class="calibre11">FIXO</tt> for <tt class="calibre11">TreeNode</tt> and vectors. As mentioned in the sidebar, in order for the <tt class="calibre11">FIXO</tt> protocol to be fully realizable, each of its functions should be mixed in. But you might not always require that a protocol be fully realizable. </p><p id="filepos701372" class="calibre5"><span class="calibre10"><span class="bold">Listing 9.3. Complete implementations of </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">FIXO</span></tt></span><span class="calibre10"><span class="bold"> for </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">TreeNode</span></tt></span><span class="calibre10"><span class="bold"> and vector </span></span></p><p class="calibre1"><img src="images/00072.jpg" class="calibre96"/></p><blockquote id="filepos701761" class="calibre9"><span class="italic">If you’ve done six impossible things this morning, why not round it off with breakfast at Milliways, the Restaurant at the End of the Universe?</span></blockquote><blockquote class="calibre25"><span class="italic">Douglas Adams</span></blockquote><p class="calibre5">Each of the function bodies in the previous example have either had no code in common with each other, or called out to another function such as <tt class="calibre11">xconj</tt> for implementation details that they have in common. These techniques work well when there’s a low level of commonality between the methods being implemented, but sometimes you have many methods of a protocol or even whole protocol implementations that you want to extend to multiple classes. In these cases, some languages would encourage you to create a base class that implements some or all of the methods and then inherit from that. Clojure has a different approach. </p><p class="calibre5"><span class="calibre10"><span class="bold">Sharing Method Implementations </span></span></p><p class="calibre7">Clojure doesn’t encourage implementation inheritance, so although it’s possible to inherit from concrete classes as needed for Java interoperability,<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos703532"><span class="calibre33"><span class="calibre8"><span class="underline">6</span></span></span></a><span class="calibre33">]</span></small></sup> there’s no way to use <tt class="calibre11">extend</tt> to provide a concrete implementation and then build another class on top of that. There are important reasons why Clojure intentionally avoids this, but regardless of the reasons, we’re left with the question of how best to avoid repeating code when similar objects implement the same protocol method. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos703532" class="calibre32"><span class="calibre33">6</span></small></sup><span class="calibre10"> Mechanisms that support something like Java-style implementation inheritance include </span><span class="calibre10"><tt class="calibre11">gen-class, proxy</tt></span><span class="calibre10">, and extending protocol methods to Java abstract classes and interfaces. </span></blockquote><p class="calibre12">The simplest solution is to write a regular function that builds on the protocol’s methods. For example, Clojure’s own <tt class="calibre11">into</tt> takes a collection and uses the <tt class="calibre11">conj</tt> implementation provided by the collection. We can write a similar function for <tt class="calibre11">FIXO</tt> objects like this: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn fixo-into [c1 c2]<br class="calibre3"/>  (reduce fixo-push c1 c2))<br class="calibre3"/><br class="calibre3"/>(xseq (fixo-into (TreeNode. 5 nil nil) [2 4 6 7]))<br class="calibre3"/>;=&gt; (2 4 5 6 7)<br class="calibre3"/><br class="calibre3"/>(seq (fixo-into [5] [2 4 6 7]))<br class="calibre3"/>;=&gt; (5 2 4 6 7)</tt></span></blockquote><p id="filepos704512" class="calibre12">But this is only an option when your function can be defined entirely in terms of the protocol’s methods. If this isn’t the case, you may need the more nuanced solution provided by the <tt class="calibre11">extend</tt> function. We mentioned it earlier but so far have only given examples of a macro built on top of it, <tt class="calibre11">extend-type</tt>. Though this and <tt class="calibre11">extend-protocol</tt> are frequently the most convenient way to implement protocol methods, they don’t provide a natural way to mix in method implementations. The <tt class="calibre11">extend</tt> function takes a map for each protocol you want to implement, and you can build that map however you’d like, including by merging in implementations that are already defined. In the following listing, you should note how a <tt class="calibre11">FIXO</tt> implementation could be defined early using a map and extended to a protocol/record type later (while still maintaining every benefit of using the original map). </p><p id="filepos705474" class="calibre5"><span class="calibre10"><span class="bold">Listing 9.4. Using a map to extend </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">FIXO</span></tt></span><span class="calibre10"><span class="bold"> to </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">TreeNode</span></tt></span></p><p class="calibre1"><img src="images/00035.jpg" class="calibre97"/></p><p class="calibre5">These record objects and the way protocols can be extended to them result in rather differently shaped code than the objects built out of closures that we showed in <a href="#filepos519998"><span class="calibre8"><span class="underline">section 7.2</span></span></a>. Often this ability to define the data and implementation separately is desirable, but you’re likely to find yourself occasionally in a circumstance where closures may feel like a better fit than records, and yet you want to extend a protocol or interface, not just provide ad hoc method names as in <a href="#filepos519998"><span class="calibre8"><span class="underline">section 7.2</span></span></a>. </p><p class="calibre5"><span class="calibre10"><span class="bold">Reify </span></span></p><p class="calibre7">The <tt class="calibre11">reify</tt> macro brings together all the power of function closures and all the performance and protocol participation of <tt class="calibre11">extend</tt> into a single form. For example, say you want a stack-like <tt class="calibre11">FIXO</tt> that’s constrained to a certain fixed size. Any attempt to push items onto one of these fixed-fixos when it’s already full will fail, and an unchanged <a id="filepos706927"></a>object will be returned. The wrinkle in the requirements that makes <tt class="calibre11">reify</tt> a reasonable option is that you’ll want this size limit to be configurable. Thus you’ll need a constructor or factory function, shown next, that takes the size limit and returns an object that will obey that limit. </p><p id="filepos707240" class="calibre5"><span class="calibre10"><span class="bold">Listing 9.5. Size-limited stack </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">FIXO</span></tt></span><span class="calibre10"><span class="bold"> using </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">reify</span></tt></span></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn fixed-fixo<br class="calibre3"/>  ([limit] (fixed-fixo limit []))<br class="calibre3"/>  ([limit vector]<br class="calibre3"/>    (reify FIXO<br class="calibre3"/>      (fixo-push [this value]<br class="calibre3"/>        (if (&lt; (count vector) limit)<br class="calibre3"/>          (fixed-fixo limit (conj vector value))<br class="calibre3"/>          this))<br class="calibre3"/>      (fixo-peek [_]<br class="calibre3"/>        (peek vector))<br class="calibre3"/>      (fixo-pop [_]<br class="calibre3"/>        (pop vector)))))</tt></span></blockquote><p class="calibre12">Just like the <tt class="calibre11">extend</tt> forms, <tt class="calibre11">reify</tt> has method arglists that include the object itself. It’s idiomatic to use name the argument <tt class="calibre11">this</tt> in methods where you need to use it and <tt class="calibre11">_</tt> in methods where you ignore its value. But both these conventions should only be followed where natural. </p><p class="calibre5"><span class="calibre10"><span class="bold">Namespaced Methods </span></span></p><p class="calibre7">A rough analogy can be drawn between protocols and Java interfaces.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos709343"><span class="calibre33"><span class="calibre8"><span class="underline">7</span></span></span></a><span class="calibre33">]</span></small></sup> We’ve noted some of the differences already, but it can be a useful analogy nonetheless. In such a comparison, where record types are concrete classes, you might see that Java packages and C++ namespaces are each like Clojure namespaces. It’s normal in all three of these environments for the interface and the class to each be in a namespace, and not necessarily the same one. For example, probably few readers were surprised to see that when we made the class <tt class="calibre11">IPersistentVector</tt> extend the protocol <tt class="calibre11">user/FIXO</tt>, they were each from a different namespace or package. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos709343" class="calibre32"><span class="calibre33">7</span></small></sup><span class="calibre10"> Those of you familiar with Haskell might recognize analogies to its typeclasses in our discussion. </span></blockquote><p class="calibre12">One way this analogy breaks down is that methods of the protocol itself are namespaced in a way that Java and C++ interfaces aren’t. In those languages, all methods of a class share the same effective namespace, regardless of interfaces they’re implementing. In Clojure, the methods always use the same namespace as the protocol itself, which means a record or type can extend (via <tt class="calibre11">extend, extend-type</tt>, and so on) identically named methods of two different protocols without any ambiguity. This is a subtle feature, but it allows you to avoid a whole category of issues that can come up when trying to combine third-party libraries into a single codebase. </p><p class="calibre5">Note that because the methods share the namespace of their protocol, you can’t have identically named methods in two different protocols if those protocols are in the same namespace. Because both are under the control of the same person, it’s easy <a id="filepos710504"></a>to resolve this by moving one of the protocols to a different namespace or using more specific method names. </p><p class="calibre5"><span class="calibre10"><span class="bold">Method Implementations in Defrecord </span></span></p><p class="calibre7">We’ve already shown how both protocols and interfaces can be extended to record types using the various <tt class="calibre11">extend</tt> forms, but there’s another way to achieve similar results. Protocol and interface method implementations can be written directly inside a <tt class="calibre11">defrecord</tt> form, which ends up looking like the following. </p><p id="filepos711083" class="calibre5"><span class="calibre10"><span class="bold">Listing 9.6. Method implementations in </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">defrecord</span></tt></span></p><p class="calibre1"><img src="images/00075.jpg" class="calibre98"/></p><p class="calibre5">This isn’t only more convenient in many cases, but it can also produce dramatically faster code. Calling a protocol method like <tt class="calibre11">fixo-peek</tt> on a record type that implements it inline can be several times faster than calling the same method on an object that implements it via an <tt class="calibre11">extend</tt> form. Also note that the fields of the object are now available as locals—we use <tt class="calibre11">val</tt> instead of <tt class="calibre11">(:val t)</tt>. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">Polymorphism and recur</span>
</p><p class="calibre7">Throughout this section, we’ve implemented the <tt class="calibre11">fixo-peek</tt> function using different methodologies, but a more subtle difference is worth noting. The first implementation uses <tt class="calibre11">recur</tt> for its recursive call as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(fixo-peek [node]<br class="calibre3"/>  (if (:l node)<br class="calibre3"/>    (recur (:l node))<br class="calibre3"/>    (:val node)))</tt></span></blockquote><p class="calibre12">Because of the nature of <tt class="calibre11">recur</tt>, the first implementation of <tt class="calibre11">fixo-peek</tt> isn’t polymorphic on the recursive call. But the second version of <tt class="calibre11">fixo-peek</tt> uses a different approach: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(fixo-peek [t]<br class="calibre3"/>  (if l<br class="calibre3"/>    (fixo-peek l)<br class="calibre3"/>    val))</tt></span></blockquote><p id="filepos712847" class="calibre12">You’ll notice that the recursive call in the second implementation is direct (mundane) and as a result is polymorphic. In the course of writing your own programs, this difference will probably not cause issues, but it’s worth storing in the back of your mind. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">Putting method definitions inside the <tt class="calibre11">defrecord</tt> form also allows you to implement Java interfaces and extend <tt class="calibre11">java.lang.Object</tt>, which isn’t possible using any <tt class="calibre11">extend</tt> form. Because interface methods can accept and return primitive values as well as boxed objects, implementations of these in <tt class="calibre11">defrecord</tt> can also support primitives. This is important for interoperability and can provide ultimate performance parity with Java code. </p><p class="calibre5">We do need to note one detail of these inline method definitions in relation to <tt class="calibre11">recur</tt>. Specifically, uses of <tt class="calibre11">recur</tt> in these definitions can’t provide a new target object: the initial argument will get the same value as the initial (non-<tt class="calibre11">recur</tt>) call to the method. For example, <tt class="calibre11">fixo-push</tt> takes args <tt class="calibre11">t</tt> and <tt class="calibre11">v</tt>, so if it used <tt class="calibre11">recur</tt>, only a single parameter would be given: the new value for the <tt class="calibre11">v</tt> arg. </p><p id="filepos714260" class="calibre5"><span class="bold">9.3.3. Building from a more primitive base with deftype </span><a></a></p><p class="calibre7">You may have noticed we’ve been using our own function <tt class="calibre11">xseq</tt> throughout the examples in this section, instead of Clojure’s <tt class="calibre11">seq</tt>. This shouldn’t be necessary, as Clojure provides an <tt class="calibre11">ISeqable</tt> interface that its <tt class="calibre11">seq</tt> function can use—all we need to do is to have our own type implement <tt class="calibre11">ISeqable</tt>. But an attempt to do this with <tt class="calibre11">defrecord</tt> is doomed: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defrecord InfiniteConstant [i]<br class="calibre3"/>  clojure.lang.ISeq<br class="calibre3"/>  (seq [this]<br class="calibre3"/>    (lazy-seq (cons i (seq this)))))<br class="calibre3"/>; java.lang.ClassFormatError: Duplicate method<br class="calibre3"/>;   name&amp;signature in class file user/InfiniteConstant</tt></span></blockquote><p class="calibre12">This is because record types are maps and implement everything maps should—<tt class="calibre11">seq</tt> along with <tt class="calibre11">assoc, dissoc, get</tt>, and so forth. Because these are provided for us, we can’t implement them again ourselves, and thus the preceding exception. For the rare case where you’re building your own data structure instead of just creating application-level record types, Clojure provides a lower-level <tt class="calibre11">deftype</tt> construct that’s similar to <tt class="calibre11">defrecord</tt> but doesn’t implement anything at all, so implementing <tt class="calibre11">seq</tt> won’t conflict with anything: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(deftype InfiniteConstant [i]<br class="calibre3"/>  clojure.lang.ISeq<br class="calibre3"/>  (seq [this]<br class="calibre3"/>    (lazy-seq (cons i (seq this)))))<br class="calibre3"/><br class="calibre3"/>(take 3 (InfiniteConstant. 5))<br class="calibre3"/>;=&gt; (5 5 5)</tt></span></blockquote><p id="filepos716061" class="calibre12">But that also means that keyword lookups, <tt class="calibre11">assoc, dissoc</tt>, and so on will remain unimplemented unless we implement them ourselves: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(:i (InfiniteConstant. 5))<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p class="calibre12">The fields we declared are still public and accessible (although you should try to avoid naming them the same at the methods in <tt class="calibre11">java.lang.Object</tt>); they just require normal Java interop forms to get at them: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(.i (InfiniteConstant. 5))<br class="calibre3"/>;=&gt; 5</tt></span></blockquote><p class="calibre12">With all that in mind, the following listing is a final implementation of <tt class="calibre11">TreeNode</tt> using <tt class="calibre11">deftype</tt>, which lets us implement not only <tt class="calibre11">ISeq</tt> so that we can use <tt class="calibre11">seq</tt> instead of <tt class="calibre11">xseq</tt>, but also <tt class="calibre11">IPersistentStack</tt> so we can use <tt class="calibre11">peek, pop</tt>, and <tt class="calibre11">conj</tt> as well as the <tt class="calibre11">fixo-</tt> versions. </p><p id="filepos717118" class="calibre5"><span class="calibre10"><span class="bold">Listing 9.7. Implementing map interfaces with </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">deftype</span></tt></span></p><p class="calibre1"><img src="images/00056.jpg" class="calibre99"/></p><p id="filepos717394" class="calibre5">One final note about <tt class="calibre11">deftype</tt>—it’s the one mechanism by which Clojure lets you create classes with volatile and mutable fields. We won’t go into it here because using such classes is almost never the right solution. Only when you’ve learned how Clojure approaches identity and state, how to use reference types, what it means for a field to be volatile, and all the pitfalls related to that, should you even consider creating classes with mutable fields. By then, you’ll have no problem understanding the official docs for <tt class="calibre11">deftype</tt>, and you won’t need any help from us. </p><p class="calibre5">None of the examples we’ve shown in this section come close to the flexibility of multimethods. All protocol methods dispatch on just the type of the first argument. This is because that’s what Java is good at doing quickly, and in many cases it’s all the polymorphism that’s needed. Clojure once again takes the practical route and makes the highest-performance mechanisms available via protocols, while providing more dynamic behavior than Java does and leaving multimethods on the table for when ultimate flexibility is required. </p><p id="filepos718597" class="calibre5"><span class="calibre18"><span class="bold">9.4. Putting it all together: a fluent builder for chess moves </span></span></p><p class="calibre7">People have been known to say that Java is a verbose programming language. This may be true when compared to the Lisp family of languages, but considerable mind-share has been devoted to devising ways to mitigate its verbosity. One popular technique is known as the <span class="italic">fluent builder</span> (<a href="#filepos1085520"><span class="calibre8"><span class="underline">Fowler 2005</span></span></a>) and can be summed up as the chaining of Java methods to form a more readable and agile instance construction technique. In this section, we’ll show a simple example of a fluent builder supporting the construction of chess move descriptions. We’ll then explain how such a technique is unnecessary within Clojure and instead present an alternative approach that’s simpler, concise, and more extensible. We’ll leverage Clojure’s records in the final solution, illustrating that Java’s class-based paradigm is counter to Clojure’s basic principles and often overkill for Java programs. </p><p id="filepos719711" class="calibre5"><span class="bold">9.4.1. Java implementation </span><a></a></p><p class="calibre7">We’ll start by identifying all of the component parts of a <tt class="calibre11">Move</tt> class including from and to squares, a flag indicating whether the move is a castling move, and also the desired promotion piece if applicable. In order to constrain the discussion, we’ll limit our idea of a <tt class="calibre11">Move</tt> to those elements listed. The next step would be to create a simple class with its properties and a set of constructors, each taking some combination of the expected properties. We’d then generate a set of accessors for the properties, but not their corresponding mutators, because it’s probably best for the move instances to be immutable. </p><p class="calibre5">Having created this simple class and rolled it out to the customers of the chess move API, we begin to notice that our users are sending into the constructor the <tt class="calibre11">to</tt> string before the <tt class="calibre11">from</tt> string, which is sometimes placed after the <tt class="calibre11">promotion</tt>, and so on. After some months of intense design and weeks of development and testing, we release the following elided chess move class: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">public class FluentMove {<br class="calibre3"/>    String from, to, promotion = "";<br class="calibre3"/>    boolean castlep;<br class="calibre3"/><br class="calibre3"/>    public static MoveBuilder desc() { return new MoveBuilder(); }<br class="calibre3"/><br class="calibre3"/>    public String toString() {<br class="calibre3"/>        return "Move " + from +<br class="calibre3"/>           " to " + to +<br class="calibre3"/>           (castlep ? " castle" : "") +<br class="calibre3"/>           (promotion.length() != 0 ? " promote to " + promotion : "");<br class="calibre3"/>     }<br class="calibre3"/><br class="calibre3"/>    public static final class MoveBuilder {<br class="calibre3"/>        FluentMove move = new FluentMove();<br class="calibre3"/><br class="calibre3"/>        public MoveBuilder from(String from) {<br class="calibre3"/>            move.from = from; return this;<br class="calibre3"/>        }<br class="calibre3"/><br class="calibre3"/>        public MoveBuilder to(String to) {<br class="calibre3"/>           move.to = to; return this;<br class="calibre3"/>        }<br class="calibre3"/><br class="calibre3"/>        public MoveBuilder castle() {<br class="calibre3"/>           move.castlep = true; return this;<br class="calibre3"/>        }<br class="calibre3"/><br class="calibre3"/>        public MoveBuilder promoteTo(String promotion) {<br class="calibre3"/>           move.promotion = promotion; return this;<br class="calibre3"/>        }<br class="calibre3"/><br class="calibre3"/>        public FluentMove build() { return move; }<br class="calibre3"/>    }<br class="calibre3"/>}</tt></span></blockquote><p id="filepos722454" class="calibre12">For brevity’s sake, our code has a lot of holes, such as missing checks for fence post errors, <tt class="calibre11">null</tt>, empty strings, assertions, and invariants; it does allow us to illustrate that the code provides a fluent builder given the following <tt class="calibre11">main</tt> method: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">public static void main(String[] args) {<br class="calibre3"/>    FluentMove move = FluentMove.desc()<br class="calibre3"/>         .from("e2")<br class="calibre3"/>         .to("e4").build();<br class="calibre3"/><br class="calibre3"/>     System.out.println(move);<br class="calibre3"/><br class="calibre3"/>     move = FluentMove.desc()<br class="calibre3"/>         .from("a1")<br class="calibre3"/>         .to("c1")<br class="calibre3"/>         .castle().build();<br class="calibre3"/><br class="calibre3"/>     System.out.println(move);<br class="calibre3"/><br class="calibre3"/>     move = FluentMove.desc()<br class="calibre3"/>         .from("a7")<br class="calibre3"/>         .to("a8")<br class="calibre3"/>        .promoteTo("Q").build();<br class="calibre3"/><br class="calibre3"/>     System.out.println(move);<br class="calibre3"/>}<br class="calibre3"/>//  Move e2 to e4<br class="calibre3"/>//  Move a1 to c1 castle<br class="calibre3"/>//  Move a7 to a8 promote to Q</tt></span></blockquote><p id="filepos723655" class="calibre12">The original constructor ambiguities have disappeared, with the only trade-off being a slight increase in complexity of the implementation and the breaking of the common Java getter/setter idioms—both of which we’re willing to live with. But if we’d started the chess move API as a Clojure project, the code would likely be a very different experience for the end user. </p><p id="filepos724064" class="calibre5"><span class="bold">9.4.2. Clojure implementation </span><a></a></p><p class="calibre7">In lieu of Java’s class-based approach, Clojure provides a core set of collection types, and as you might guess, its map type is a nice candidate for move representation: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">{:from "e7", :to "e8", :castle? false, :promotion \Q}</tt></span></blockquote><p class="calibre12">Simple, no?</p><p class="calibre5">In a language like Java, it’s common to represent everything as a class—to do otherwise is either inefficient, non-idiomatic, or outright taboo. Clojure prefers simplification, providing a set of composite types perfect for representing most categories of problems typically handled by class hierarchies. Using Clojure’s composite types makes sense for one simple reason: existing functions, built on a sequence abstraction, <span class="italic">just work</span>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn build-move [&amp; pieces]<br class="calibre3"/>  (apply hash-map pieces))<br class="calibre3"/><br class="calibre3"/>(build-move :from "e7" :to "e8" :promotion \Q)<br class="calibre3"/><br class="calibre3"/>;=&gt; {:from "e7", :to "e8", :promotion \Q}</tt></span></blockquote><p class="calibre12">In two lines, we’ve effectively replaced the Java implementation with an analogous, yet more flexible representation. The term <span class="italic">domain-specific language (DSL)</span> is often thrown around to describe code such as <tt class="calibre11">build-move</tt>, but to Clojure (and Lisps in general) the line between DSL and API is blurred. In the original <tt class="calibre11">FluentMove</tt> class, we required a cornucopia of code in order to ensure the API was agnostic of the ordering of move elements; using a map, we get that for free. Additionally, <tt class="calibre11">FluentMove</tt>, though relatively concise, was still bound by fundamental Java syntactical and semantic constraints. </p><p class="calibre5">There’s one major problem with our implementation—it doesn’t totally replace the Java solution. If you recall, the Java solution utilized the <tt class="calibre11">toString</tt> method to print its representative form. The existence of a polymorphic print facility in Java is nice, and it allows a class creator to define a default print representation for an object when sent to any Java print stream. This means that the same representation is used on the console, in log files, and so on. Using raw maps can’t give us this same behavior, so how can we solve this problem? </p><p class="calibre5"><span class="calibre10"><span class="bold">Using Records </span></span></p><p id="filepos726645" class="calibre7">If we instead use a record, then the solution is as simple as that shown next. </p><p id="filepos726757" class="calibre5"><span class="calibre10"><span class="bold">Listing 9.8. A chess move record </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defrecord Move [from to castle? promotion]<br class="calibre3"/>  Object<br class="calibre3"/>  (toString [this]<br class="calibre3"/>    (str "Move " (:from this)<br class="calibre3"/>         " to " (:to this)<br class="calibre3"/>         (if (:castle? this) " castle"<br class="calibre3"/>           (if-let [p (:promotion this)]<br class="calibre3"/>             (str " promote to " p)<br class="calibre3"/>             "")))))</tt></span></blockquote><p class="calibre12">As we mentioned in the previous section, within the body of a record we can take up to two actions: participate in a protocol, or override any of the methods in the <tt class="calibre11">java.lang.Object</tt> class. For the <tt class="calibre11">Move</tt> record, we override <tt class="calibre11">toString</tt> in order to allow it to participate in Java’s overarching polymorphic print facility, as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(str (Move. "e2" "e4" nil nil))<br class="calibre3"/>;=&gt; "Move e2 to e4"<br class="calibre3"/><br class="calibre3"/>(.println System/out (Move. "e7" "e8" nil \Q))<br class="calibre3"/>; Move e7 to e8 promote to Q</tt></span></blockquote><p class="calibre12">We’ve once again gone back to positional construction using records, but as we’ll show, Clojure even has an answer for this.</p><p class="calibre5"><span class="calibre10"><span class="bold">Separation of Concerns </span></span></p><p class="calibre7">Both <tt class="calibre11">FluentMove</tt> and <tt class="calibre11">build-move</tt> make enormous assumptions about the form of the data supplied to them and do no validation of the input. For <tt class="calibre11">FluentMove</tt>, object-oriented principles dictate that the validation of a well-formed move (not a legal move, mind you) should be determined by the class itself. There are a number of problems with this approach, the most obvious being that to determine whether a move is well-formed, the class needs information about the rules of chess. We can rewrite <tt class="calibre11">FluentMove</tt> to throw an exception to prevent illegal moves from being constructed, but the root problem still remains—<tt class="calibre11">FluentMove</tt> instances are too smart. Perhaps you don’t see this as a problem, but if we were to extend our API to include other aspects of the game of chess, then we’ll find that bits of overlapping chess knowledge would be scattered throughout the class hierarchy. By viewing the move structure as a value, Clojure code provides some freedom in the implementation of a total solution, as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn build-move [&amp; {:keys [from to castle? promotion]}]<br class="calibre3"/>  {:pre [from to]}<br class="calibre3"/>  (Move. from to castle? promotion))<br class="calibre3"/><br class="calibre3"/>(str (build-move :from "e2" :to "e4"))<br class="calibre3"/>;=&gt; "Move e2 to e4"</tt></span></blockquote><p id="filepos729672" class="calibre12">By wrapping the <tt class="calibre11">Move</tt> constructor in a <tt class="calibre11">build-move</tt> function, we put the smarts of constructing moves there instead of in the type itself. In addition, using a precondition, we specified the required fields, and by using Clojure’s named parameters and argument destructuring we’ve again ensured argument order independence. As a final added advantage, Clojure’s records are maps and as a result can operate in almost every circumstance where a map would. As author Rich Hickey proclaimed, any new class in general is itself an island, unusable by <span class="italic">any</span> existing code written by anyone, anywhere. So our point is this: consider throwing the baby out with the bath water. </p><p id="filepos730401" class="calibre5"><span class="calibre18"><span class="bold">9.5. Summary </span></span></p><p class="calibre7">Clojure disavows the typical object-oriented model of development. But that’s not to say that it completely dismisses all that OOP stands for. Instead, Clojure wholeheartedly touts the virtues of interface-oriented programming (or abstraction-oriented programming, as we’ve called it), in addition to runtime polymorphism. But in both cases, the way that Clojure presents these familiar topics is quite different from what you might be accustomed to. In almost every circumstance, Clojure’s abstraction-oriented facilities will sufficiently represent your problem domain, but there may be times when they simply can’t. We’ll preach the virtues of abstractions more throughout the rest of the book, but for now we’re compelled to take a side path into an explorations of Java interoperability. </p><div class="mbppagebreak"></div><p id="filepos731329" class="calibre5"><span class="calibre6"><span class="bold">Chapter 10. Java.next </span></span><a></a></p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">This chapter covers</span>
</p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24"><a href="#filepos735928"><span class="calibre8"><span class="underline">Generating objects on the fly with </span></span><tt class="calibre11"><span class="calibre8"><span class="underline">proxy</span></span></tt></a></li><a id="filepos731809"></a><li value="2" class="calibre24"><a href="#filepos747545"><span class="calibre8"><span class="underline">Clojure </span></span><tt class="calibre11"><span class="calibre8"><span class="underline">gen-class</span></span></tt><span class="calibre8"><span class="underline"> and GUI programming</span></span></a></li><li value="3" class="calibre24"><a href="#filepos767521"><span class="calibre8"><span class="underline">Clojure’s relationship to Java arrays</span></span></a></li><li value="4" class="calibre24"><a href="#filepos783802"><span class="calibre8"><span class="underline">All Clojure functions implement...</span></span></a></li><li value="5" class="calibre24"><a href="#filepos789320"><span class="calibre8"><span class="underline">Using Clojure data structures in Java APIs</span></span></a></li><li value="6" class="calibre24"><a href="#filepos798807"><tt class="calibre11"><span class="calibre8"><span class="underline">definterface</span></span></tt></a></li><li value="7" class="calibre24"><a href="#filepos804458"><span class="calibre8"><span class="underline">Be wary of exceptions</span></span></a></li></ul><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">Regardless of your views on the Java language itself, it’s difficult to deny that the JVM is a stellar piece of software. The confluence of the just-in-time (JIT) compiler, garbage collection, HotSpot, and the flexible bytecode have created an environment that many programmers have chosen to grow their alternative programming languages. Additionally, the deluge of library options hosted on the JVM further make the JVM the language target of choice. From Clojure to Groovy to Scala to Fantom to Frink to Ioke to Jess to JRuby to Jython, there seems to be no lack of options for the enthusiastic polyglot programmer. We may soon see job listings for “JVM programmers.” But where does that leave Java the programming language? </p><p class="calibre5">Java the language isn’t dead.</p><p id="filepos733653" class="calibre5">The JVM is optimized for running Java bytecode, and only recently<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos734605"><span class="calibre33"><span class="calibre8"><span class="underline">1</span></span></span></a><span class="calibre33">]</span></small></sup> have Java.next languages been a consideration. You may ask yourself whether JVM bytecode is equivalent to Java source code, and the answer is no. Instead, languages such as Clojure and Scala compile directly to bytecode and can access Java compiled libraries as needed. Because of their reliance on the JVM as the runtime environment, Clojure and the other Java.next languages will be fundamentally constrained by the limitations of the JVM itself. The limitations of the JVM as defined by the limitations of the Java language specification set the beat by which the Java.next languages dance. Java isn’t dead; it’s alive and well, and it runs the show. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos734605" class="calibre32"><span class="calibre33">1</span></small></sup><span class="calibre10"> More details can be found in JSR-000292, “Supporting Dynamically Typed Languages on the Java Platform.” </span></blockquote><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre28"><span class="calibre10"><span class="bold">The Java.Next Mantra</span></span></p><p class="calibre5">The apprentice avoids all use of Java classes. The journeyman embraces Java classes. The master knows which classes to embrace and which to avoid. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">An expert understanding of the Java Virtual Machine isn’t required for writing powerful applications in Clojure, but it’ll help when issues stemming from host limitations arise. Thankfully, Clojure does a good job of mitigating many of the limitations inherent in its host, but some are too deeply embedded in the fibers of the JVM to avoid. Clojure provides a specific set of interoperability tools: <tt class="calibre11">gen-class, proxy, definterface</tt>, its exceptions facility, and a host of array functions. We’ll touch on each of these in turn, but we’ll begin with the creation of anonymous objects using <tt class="calibre11">proxy</tt>. </p><p id="filepos735928" class="calibre5"><span class="calibre18"><span class="bold">10.1. Generating objects on the fly with proxy </span></span></p><p class="calibre7">There’s a saying within the Clojure community stating (<a href="#filepos1073709"><span class="calibre8"><span class="underline">Halloway 2009</span></span></a>) that Clojure does Java better than Java. This is a bold statement, but not one without merit, as we’ll show throughout this chapter. Java programmers are accustomed to drawing a severe distinction between development time and runtime. Using Clojure’s <tt class="calibre11">proxy</tt> feature allows you to blur this distinction. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre28"><span class="calibre10"><span class="bold">Clojure Aphorism</span></span></p><p class="calibre5">Many software projects require a lot of planning because their implementation languages don’t foster change. Clojure makes it a lot easier to plan for change. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">Clojure’s <tt class="calibre11">proxy</tt> mechanism is meant strictly for interoperability purposes. In <a href="#filepos677632"><span class="calibre8"><span class="underline">section 9.3</span></span></a>, we discussed how <tt class="calibre11">reify</tt> was intended to realize a single instance of a type, protocol, or interface—in other words, abstractions. But when dealing with Java libraries, you’re at times required to extend <span class="italic">concrete classes</span>, and it’s in this circumstance where <tt class="calibre11">proxy</tt> shines. Be aware that by using <tt class="calibre11">proxy</tt>, you bring a lot of Java’s semantics into your Clojure programs. Though extending concrete classes is seen often in Java, doing so in Clojure is considered poor design, leading to fragility, and should therefore be restricted to those instances where interoperability demands it. </p><p id="filepos737821" class="calibre5"><span class="bold">10.1.1. A simple dynamic web service </span><a></a></p><p id="filepos737904" class="calibre7">Using Clojure breaks the ponderous code/compile/run development cycle by adding an element of dynamism into the fold. Take for example a scenario where we want to develop a web service using an existing Java 1.5 API. </p><p id="filepos738154" class="calibre5"><span class="calibre10"><span class="bold">Listing 10.1. A simple dynamic web service </span></span><a></a></p><p class="calibre1"><img src="images/00067.jpg" class="calibre100"/></p><p class="calibre5">After entering the code in <a href="#filepos738154"><span class="calibre8"><span class="underline">listing 10.1</span></span></a>, you should see the message “Hello Cleveland” in your web browser at address http://localhost:8123/joy/hello. This is only marginally interesting, especially because the source is organized in a way that doesn’t take advantage of Clojure’s flexibility. </p><p class="calibre5">If we instead organize the code to bind the return of <tt class="calibre11">default-handler</tt>, we can manipulate the handler independently and update its behavior at runtime, as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(.stop server 0)<br class="calibre3"/><br class="calibre3"/>(def p (default-handler<br class="calibre3"/>         "There's no problem that can't be solved<br class="calibre3"/>          with another level of indirection"))<br class="calibre3"/><br class="calibre3"/>(def server (new-server 8123 "/joy/hello" p))</tt></span></blockquote><p class="calibre12">At this point, visiting the aforementioned URL will show the new message, making this simple server more compelling. But we can take it one step further by making changes without taking the server instance down in such a clumsy fashion. Ideally, we’d like to be able to call a function to change the message at any time: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(change-message p "Our new message")</tt></span></blockquote><p class="calibre12">The implementation of <tt class="calibre11">change-message</tt> is given in the following listing. </p><p id="filepos739919" class="calibre5"><span class="calibre10"><span class="bold">Listing 10.2. Convenience functions for changing the web service message </span></span><a></a></p><p class="calibre1"><img src="images/00080.jpg" class="calibre101"/></p><p id="filepos740177" class="calibre5">We’ve added a few extras to the implementation that will be useful later, but for now concentrate on the fact that <tt class="calibre11">change-message</tt> calls the function <tt class="calibre11">update-proxy</tt> with the proxy object <tt class="calibre11">p</tt> and a map containing an anonymous function keyed on a string referencing a method name to override. The anonymous function looks similar to the <tt class="calibre11">handle</tt> method defined in the returned proxy from the original <tt class="calibre11">default-handler</tt> function, with some extras added for flexibility’s sake. You can test this by entering the following function call: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(change-message p "Hello Dynamic!")</tt></span></blockquote><p class="calibre12">Refreshing your browser will reflect the change made by displaying the string <tt class="calibre11">"Hello Dynamic!"</tt>. If so inclined, you can also inspect the current proxy mappings using the function <tt class="calibre11">proxy-mappings</tt>. The question remains—how does <tt class="calibre11">update-proxy</tt> change the behavior of a previously generated proxy class? </p><p class="calibre5"><span class="calibre10"><span class="bold">It’s Called Proxy for a Reason </span></span></p><p class="calibre7">As we mentioned, the <tt class="calibre11">proxy</tt> function generates the bytecode for an actual class on demand, but it does so in such a way to provide a more dynamic implementation. Instead of inserting the bytecode for the given function bodies directly into the proxy class, Clojure instead generates a proper proxy in which each method looks up the function implementing a method in a map. This trades highly useful dynamic behavior for some runtime cost, but in many cases this is a fair trade. </p><p class="calibre5">Based on the method name, the corresponding function is retrieved from a map and invoked with the <tt class="calibre11">this</tt> reference and the argument(s). </p><p class="calibre5"><span class="calibre10"><span class="bold">Proxies for True Power Dynamism </span></span></p><p class="calibre7">Working from the abstract model in <a href="#filepos742637"><span class="calibre8"><span class="underline">figure 10.1</span></span></a>, observe how Clojure updates the mapped functions within a proxy at runtime. This web service is a humble example, but there’s a point to take away from this exercise: to perform this same task in Java <a id="filepos742481"></a>isn’t impossible but would require an enormous amount of scaffolding to implement properly, whereas in Clojure it’s built into the language. </p><p id="filepos742637" class="calibre5"><span class="calibre10"><span class="bold">Figure 10.1. Proxy lookup: the instance returned by </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">proxy</span></tt></span><span class="calibre10"><span class="bold"> is a proper proxy that does method dispatch to functions in a lookup table. These functions can therefore be swapped out with replacements as needed. </span></span></p><p class="calibre1"><img src="images/00094.jpg" class="calibre102"/></p><p class="calibre5"><span class="calibre10"><span class="bold">Proxies as Proper Citizens </span></span></p><p class="calibre7">In the original <tt class="calibre11">change-message</tt> function, we provided a hook named <tt class="calibre11">fltr</tt> that took the result of the call to the <tt class="calibre11">.getResponseBody</tt> method. Because the result of this method call is a <tt class="calibre11">java.io. OutputStream</tt>, we can use that information to our advantage when creating a filtering function. The use of the <tt class="calibre11">identity</tt> function as the default filter ensures that the usage doesn’t break in the default case; but if we’re to utilize our own filtering function, we must ensure that we properly wrap the original, which again is a perfect use case for <tt class="calibre11">proxy</tt>. A simple implementation of a <tt class="calibre11">screaming-filter</tt> would be implemented as such: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn screaming-filter [o]<br class="calibre3"/>  (proxy [FilterOutputStream] [o]<br class="calibre3"/>    (write [b]<br class="calibre3"/>      (proxy-super write (.getBytes (str "&lt;strong&gt;"<br class="calibre3"/>                                         (.toUpperCase (String. b))<br class="calibre3"/>                                         "&lt;/strong&gt;"))))))</tt></span></blockquote><p class="calibre12">The proxy returned by <tt class="calibre11">screaming-filter</tt> extends the Java class <tt class="calibre11">java.io.FilterOutputStream</tt> to the superclass constructor (via the <tt class="calibre11">[o]</tt> vector). It passes the argument <tt class="calibre11">o</tt>, which corresponds to the <tt class="calibre11">OutputStream</tt> obtained from the <tt class="calibre11">.getResponseBody</tt> method. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre28"><span class="calibre10"><span class="bold">Anaphoric Proxy</span></span></p><p class="calibre5">In <a href="#filepos621735"><span class="calibre8"><span class="underline">section 8.5</span></span></a>, we mentioned that it’s non-idiomatic to write anaphoric macros, yet you might’ve noticed that <tt class="calibre11">proxy</tt> is a contradiction of that statement. The use of the anaphora <tt class="calibre11">this</tt> is subject to the same nesting limitations as previously mentioned and is a good candidate for change in later versions of Clojure. You might notice that the <tt class="calibre11">reify</tt> macro, though similar to <tt class="calibre11">proxy</tt>, doesn’t use an anaphoric <tt class="calibre11">this</tt> but instead requires that it be named explicitly—the preferred approach for your own, and likely the way forward for all future Clojure core macros. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">The call to the <tt class="calibre11">proxy-super</tt> function is similar to Java’s <tt class="calibre11">super.method()</tt> semantics. If we now execute the call to <tt class="calibre11">change-message</tt> passing in <tt class="calibre11">screaming-filter</tt>, we’ll see the expected filtered message in all caps and bold on a browser refresh: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(change-message p screaming-filter "whisper")</tt></span></blockquote><p class="calibre12">Note that in a break from almost every other construct in Clojure, <tt class="calibre11">proxy-super</tt> is <span class="italic">not</span> thread-safe. If some other thread were to call this proxy instance’s <tt class="calibre11">write</tt> method while <tt class="calibre11">proxy-super</tt> was still running, the base class’s method would be called directly, <a id="filepos746497"></a>incorrectly skipping the proxy implementation. So be careful using <tt class="calibre11">proxy-super</tt> and multiple threads in close proximity to each other. </p><p class="calibre5"><span class="calibre10"><span class="bold">Final Points About Proxy </span></span></p><p class="calibre7">Clojure’s proxy capabilities are truly dynamic, allowing you to create fully stubbed proxies using either <tt class="calibre11">construct-proxy, get-proxy-class</tt>, or <tt class="calibre11">init-proxy</tt>. In both cases, a partially to fully realized proxy will be constructed, allowing programmatic customization using <tt class="calibre11">update-proxy</tt> and arbitrary mixin maps. </p><p class="calibre5">There’s a universe of difference between the code outlined in this subsection and systems employing true code hot-loading, but it’s a reasonable facsimile. Using <tt class="calibre11">proxy</tt> is powerful, but doing so creates unnamed instances unavailable for later extension. If you instead wish to create named classes then you’ll need to use Clojure’s <tt class="calibre11">gen-class</tt> mechanism, which we’ll discuss next. </p><p id="filepos747545" class="calibre5"><span class="calibre18"><span class="bold">10.2. Clojure gen-class and GUI programming </span></span></p><p class="calibre7">In <a href="#filepos643937"><span class="calibre8"><span class="underline">section 9.1</span></span></a>, we mentioned that Clojure namespaces can be used as the basis for generating a named class. In this section, we’ll address this topic and others related to Clojure’s <tt class="calibre11">gen-class</tt> function and <tt class="calibre11">:gen-class</tt> namespace directive in the context of writing a simple graphical user interface (GUI) library. </p><p id="filepos748075" class="calibre5"><span class="bold">10.2.1. Namespaces as class specifications </span><a></a></p><p class="calibre7">Similarly to the <tt class="calibre11">ns</tt> example in <a href="#filepos643937"><span class="calibre8"><span class="underline">section 9.1</span></span></a>, the explanation of <tt class="calibre11">gen-class</tt> begs a declarative approach for a namespace defining a class named <tt class="calibre11">joy.gui.DynaFrame</tt>. We’d like this class to extend <tt class="calibre11">javax.swing.JFrame</tt> and declare the Vars providing its overriding method implementations to be prefixed<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos749508"><span class="calibre33"><span class="calibre8"><span class="underline">1</span></span></span></a><span class="calibre33">]</span></small></sup> by the symbol <tt class="calibre11">df-</tt>. In addition, we’d like the class to implement the <tt class="calibre11">clojure.lang.IMeta</tt> interface. We’d also like a place to store information about instances of this class in <tt class="calibre11">state</tt> and would like the initialization function called on construction to be named <tt class="calibre11">df-init</tt>. We’d like to define a single constructor, taking a string and passing it onto the superclass constructor also taking a string. We then want to declare two public methods: the first named <tt class="calibre11">display</tt> taking a <tt class="calibre11">java.awt.Container</tt> and returning <tt class="calibre11">void</tt>, and the second static method <tt class="calibre11">version</tt> taking no arguments and returning a string. Finally, we’ll declare the required imports needed. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos749508" class="calibre32"><span class="calibre33">1</span></small></sup><span class="calibre10"> If you don’t specify a </span><span class="calibre10"><tt class="calibre11">:prefix</tt></span><span class="calibre10">, then the default </span><span class="calibre10"><tt class="calibre11">-</tt></span><span class="calibre10"> will be used. </span></blockquote><p class="calibre12">The worded <tt class="calibre11">DynaFrame</tt> class declaration is complex but has the advantage of having a direct code translation, as shown next. </p><p id="filepos749927" class="calibre5"><span class="calibre10"><span class="bold">Listing 10.3. The </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">DynaFrame</span></tt></span><span class="calibre10"><span class="bold"> class namespace declaration </span></span></p><p class="calibre1"><img src="images/00085.jpg" class="calibre103"/></p><p id="filepos750235" class="calibre5">You can compile this namespace by saving it in a directory joy/gui, located on the classpath, in a file named DynaFrame.clj and executing the function <tt class="calibre11">(compile 'joy.gui.DynaFrame)</tt> in a fresh REPL. This allows a compiled class to be immediately available. But trying to create an instance in the same REPL will prove fruitless: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(joy.gui.DynaFrame. "1st")<br class="calibre3"/><br class="calibre3"/>; java.lang.UnsupportedOperationException:<br class="calibre3"/>;   joy.gui.DynaFrame/df-init not defined</tt></span></blockquote><p class="calibre12">Clearly we haven’t defined the <tt class="calibre11">df-init</tt> function, so we’ll do that now by switching to the <tt class="calibre11">joy.gui.DynaFrame</tt> namespace, defining it outright: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(in-ns 'joy.gui.DynaFrame)<br class="calibre3"/><br class="calibre3"/>(defn df-init [title]<br class="calibre3"/>  [[title] (atom {::title title})])</tt></span></blockquote><p class="calibre12">Now run the following in your REPL:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(joy.gui.DynaFrame. "2nd")<br class="calibre3"/><br class="calibre3"/>; java.lang.UnsupportedOperationException:<br class="calibre3"/>;   meta (joy.gui.DynaFrame/df-meta not defined?)</tt></span></blockquote><p class="calibre12">Because we told the Clojure compiler that the class should implement the <tt class="calibre11">IMeta</tt> interface, we should’ve provided a concrete implementation, which you can do at the REPL: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn df-meta [this] @(.state this))<br class="calibre3"/>(defn version [] "1.0")</tt></span></blockquote><p class="calibre12">As an added bonus, we implemented the static method <tt class="calibre11">version</tt>. To see the effects of these functions, execute the following: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(meta (joy.gui.DynaFrame. "3rd"))<br class="calibre3"/>;=&gt; {:joy.gui.DynaFrame/title "3rd"}<br class="calibre3"/><br class="calibre3"/>(joy.gui.DynaFrame/version)<br class="calibre3"/>;=&gt; "1.0"</tt></span></blockquote><p class="calibre12">We’ve filled in most of the implementation of the <tt class="calibre11">DynaFrame</tt> class except for the <tt class="calibre11">display</tt> function, which you can implement as follows: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn df-display [this pane]<br class="calibre3"/>  (doto this<br class="calibre3"/>    (-&gt; .getContentPane .removeAll)<br class="calibre3"/>    (.setContentPane (doto (JPanel.)<br class="calibre3"/>                       (.add pane BorderLayout/CENTER)))<br class="calibre3"/>    (.pack)<br class="calibre3"/>    (.setVisible true)))</tt></span></blockquote><p id="filepos752869" class="calibre12">You can see <tt class="calibre11">df-display</tt> in action within the REPL by running the following: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def gui (joy.gui.DynaFrame. "4th"))<br class="calibre3"/><br class="calibre3"/>(.display gui (doto (javax.swing.JPanel.)<br class="calibre3"/>                (.add (javax.swing.JLabel. "Charlemagne and Pippin"))))</tt></span></blockquote><p class="calibre12">This will now display the GUI frame seen in <a href="#filepos753417"><span class="calibre8"><span class="underline">figure 10.2</span></span></a>. </p><p id="filepos753417" class="calibre5"><span class="calibre10"><span class="bold">Figure 10.2. A simple use of </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">DynaFrame</span></tt></span><span class="calibre10"><span class="bold">: now that you’ve compiled the </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">DynaFrame</span></tt></span><span class="calibre10"><span class="bold"> class, you can start using it to display simple GUIs. </span></span></p><p class="calibre1"><img src="images/00096.jpg" class="calibre104"/></p><p class="calibre5">And because it’s a <tt class="calibre11">DynaFrame</tt> we should be able to change it on the fly, right? Right: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(.display gui (doto (javax.swing.JPanel.)<br class="calibre3"/>                (.add (javax.swing.JLabel. "Mater semper certa est." ))))</tt></span></blockquote><p class="calibre12">This will change the view to that in <a href="#filepos754370"><span class="calibre8"><span class="underline">figure 10.3</span></span></a>. </p><p id="filepos754370" class="calibre5"><span class="calibre10"><span class="bold">Figure 10.3. A simple dynamic update of </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">DynaFrame</span></tt></span><span class="calibre10"><span class="bold">: we can update the </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">DynaFrame</span></tt></span><span class="calibre10"><span class="bold"> on the fly without restarting. </span></span></p><p class="calibre1"><img src="images/00097.jpg" class="calibre104"/></p><p class="calibre5">But now that you have this interesting little frame, what can you do with it? Next, we’ll experiment with <tt class="calibre11">DynaFrame</tt> as the foundation for agile GUI prototyping. </p><p class="calibre5"><span class="calibre10"><span class="bold">The Guts of Namespace Compilation </span></span></p><p class="calibre7">So what exactly does the <tt class="calibre11">:gen-class</tt> directive provide in terms of generated class files? With or without <tt class="calibre11">:gen-class</tt>, Clojure will generate a set of classes corresponding to each function in a namespace. For the function <tt class="calibre11">joy.gui.DynaFrame/df-dis-play</tt>, a class file will be generated on the classpath of <tt class="calibre11">joy.gui.DynaFrame$df_display</tt> containing (at least) a method <tt class="calibre11">invoke</tt>, at the location CLASSPATH/ joy/gui/DynaFrame$df_display.class, as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">package joy.gui;<br class="calibre3"/>public class DynaFrame$df_display extends AFunction {<br class="calibre3"/>    . . .<br class="calibre3"/>    public Object invoke(Object that, Object container) {<br class="calibre3"/>        . . . display actions . . .<br class="calibre3"/>    }<br class="calibre3"/>}</tt></span></blockquote><p class="calibre12">Of course, this describes implementation details and shouldn’t be considered fact in future version of Clojure. In fact, as shown before, you were able to add implementations for the parts of the <tt class="calibre11">DynaFrame</tt> class at the REPL because Clojure generates a stub that looks up concrete implementations through Vars. But these details are useful for describing the logical product of <tt class="calibre11">:gen-class</tt> and <tt class="calibre11">compile</tt>. The <tt class="calibre11">:gen-class</tt> directive with the argument <tt class="calibre11">:name joy.gui.DynaFrame</tt> creates a class vaguely resembling the following Java source: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">package joy.gui;<br class="calibre3"/><br class="calibre3"/>public class DynaFrame extends javax.swing.JFrame {<br class="calibre3"/>    public final Object state;<br class="calibre3"/>    public DynaFrame(String title) {<br class="calibre3"/>      Object r =  clojure.lang.RT.var("joy.gui.DynaFrame", "df-init")<br class="calibre3"/>                     .invoke(title);<br class="calibre3"/>      Object cargs = clojure.lang.RT.nth(r, 0);<br class="calibre3"/>      state = clojure.lang.RT.nth(r, 1);<br class="calibre3"/>      super((String) clojure.lang.RT.nth(cargs, 0));<br class="calibre3"/>    }<br class="calibre3"/><br class="calibre3"/>    public static String version() { return "1.0"; }<br class="calibre3"/><br class="calibre3"/>    // Delegate to the display function var<br class="calibre3"/>    public void display(Object the_this, java.awt.Container c) {<br class="calibre3"/>        return clojure.lang.RT.var("joy.gui.DynaFrame", "df-display")<br class="calibre3"/>                 .invoke(the_this, c);<br class="calibre3"/>    }<br class="calibre3"/><br class="calibre3"/>    . . .<br class="calibre3"/>}</tt></span></blockquote><p id="filepos757665" class="calibre12">The <tt class="calibre11">:gen-class</tt> directive creates a class that’s a delegate for the Vars (prefixed as specified with <tt class="calibre11">df-</tt>) located in the corresponding namespace, contains the <tt class="calibre11">state</tt>, and also holds any static methods. This is a lot of detail to contend with, but understanding it’s important when arranging your Clojure projects to take advantage of code compilation. </p><p class="calibre5">One final important point when using <tt class="calibre11">gen-class</tt> is the semantics surrounding the <tt class="calibre11">:impl-ns</tt> directive. Our example relies on the fact that the <tt class="calibre11">gen-class</tt> namespace is the same as the implementation namespace (the <tt class="calibre11">:impl-ns</tt>), meaning that the compilation will transitively compile all of the implementation functions. On the other hand, when your implementation and <tt class="calibre11">gen-class</tt> namespaces are distinct, you no longer suffer transitive compilation. This provides the benefit of allowing a mixture of compiled (class files) and uncompiled (.clj files) Clojure products. </p><p id="filepos758716" class="calibre5"><span class="bold">10.2.2. Exploring user interface design and development with Clojure </span><a></a></p><p class="calibre7">Before we begin, we’ll devise a simple model (<a href="#filepos1088053"><span class="calibre8"><span class="underline">_why 2007<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos759564"><span class="calibre33"><span class="calibre8"><span class="underline">3</span></span></span></a><span class="calibre33">]</span></small></sup></span></span></a>) for exploring user interface design. We don’t have to complicate matters, because the goal is only to get a general idea of how Clojure makes a typically painful task like Java GUI development a joy. To achieve this modest goal, we’ll need some simple containers illustrated in <a href="#filepos759769"><span class="calibre8"><span class="underline">figure 10.4</span></span></a>: shelves, stacks, and splitters. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos759564" class="calibre32"><span class="calibre33">3</span></small></sup><span class="calibre10"> Our GUI model in this section is based loosely on the Ruby framework Shoes created by _why. Thank you sir, wherever you are. </span></blockquote><p id="filepos759769" class="calibre12"><span class="calibre10"><span class="bold">Figure 10.4. Basic GUI containers: using only a handful of rudimentary containers, we can build neato GUI prototypes. </span></span><a></a></p><p class="calibre1"><img src="images/00100.jpg" class="calibre105"/></p><p class="calibre5">Because <tt class="calibre11">DynaFrame</tt> requires a <tt class="calibre11">java.awt.Container</tt> as its displayed element, we’ll make each container a derivative thereof. This allows the containers to nest, helping to build richer GUIs. Finally, their forms should mirror their graphical layout, within reason. These three containers are implemented in the following listing. </p><p id="filepos760452" class="calibre5"><span class="calibre10"><span class="bold">Listing 10.4. Simple GUI containers </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(ns joy.gui.socks<br class="calibre3"/>  (:import<br class="calibre3"/>   (joy.gui DynaFrame)<br class="calibre3"/>   (javax.swing Box BoxLayout JTextField JPanel<br class="calibre3"/>                JSplitPane JLabel JButton<br class="calibre3"/>                JOptionPane)<br class="calibre3"/>   (java.awt BorderLayout Component GridLayout FlowLayout)<br class="calibre3"/>   (java.awt.event ActionListener)))<br class="calibre3"/><br class="calibre3"/>(defn shelf [&amp; components]<br class="calibre3"/>  (let [shelf (JPanel.)]<br class="calibre3"/>     (.setLayout shelf (FlowLayout.))<br class="calibre3"/>     (doseq [c components] (.add shelf c))<br class="calibre3"/>     shelf))<br class="calibre3"/><br class="calibre3"/>(defn stack [&amp; components]<br class="calibre3"/>  (let [stack (Box. BoxLayout/PAGE_AXIS)]<br class="calibre3"/>     (doseq [c components]<br class="calibre3"/>       (.setAlignmentX c Component/CENTER_ALIGNMENT)<br class="calibre3"/>       (.add stack c))<br class="calibre3"/>     stack))<br class="calibre3"/><br class="calibre3"/>  (defn splitter [top bottom]<br class="calibre3"/>   (doto (JSplitPane.)<br class="calibre3"/>     (.setOrientation JSplitPane/VERTICAL_SPLIT)<br class="calibre3"/>     (.setLeftComponent top)<br class="calibre3"/>     (.setRightComponent bottom)))</tt></span></blockquote><p id="filepos761773" class="calibre12">These simple GUI elements are built on top of the Java Swing library, where each sub-widget in the <tt class="calibre11">components</tt> argument is added to the properly configured <tt class="calibre11">Container-</tt>derived parent. These are good as a starting point, but still there’s nothing to display unless we dive into the Swing API directly. We can do one better than that by providing a simple base set of widgets: buttons, labels, and text boxes. </p><p id="filepos762231" class="calibre5"><span class="calibre10"><span class="bold">Listing 10.5. A set of simple widgets </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn button [text f]<br class="calibre3"/>  (doto (JButton. text)<br class="calibre3"/>    (.addActionListener<br class="calibre3"/>     (proxy [ActionListener] []<br class="calibre3"/>       (actionPerformed [_] (f))))))<br class="calibre3"/><br class="calibre3"/>(defn txt  [cols t]<br class="calibre3"/>  (doto (JTextField.)<br class="calibre3"/>    (.setColumns cols)<br class="calibre3"/>     (.setText t)))<br class="calibre3"/><br class="calibre3"/>(defn label [txt] (JLabel. txt))</tt></span></blockquote><p class="calibre12">The button element takes a function executed on a mouse-click, so we’ll now provide a JavaScript-like <tt class="calibre11">alert</tt> function as a simple action: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn alert<br class="calibre3"/>  ([msg] (alert nil msg))<br class="calibre3"/>  ([frame msg]<br class="calibre3"/>     (javax.swing.JOptionPane/showMessageDialog frame msg)))</tt></span></blockquote><p class="calibre12">Having built all of these GUI elements, we’ll describe the first simple GUI as shown in <a href="#filepos763424"><span class="calibre8"><span class="underline">figure 10.5</span></span></a>. </p><p id="filepos763424" class="calibre5"><span class="calibre10"><span class="bold">Figure 10.5. </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">DynaFrame</span></tt></span><span class="calibre10"><span class="bold"> alerts: we can create slightly more complex GUIs and attach actions on the fly. </span></span></p><p class="calibre1"><img src="images/00102.jpg" class="calibre106"/></p><p class="calibre5">It seems simple, if not pointless. But you might be pleasantly surprised with the concise code used to describe it:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(.display gui<br class="calibre3"/>  (splitter<br class="calibre3"/>    (button "Procrastinate" #(alert "Eat Cheetos"))genclass<br class="calibre3"/>    (button "Move It" #(alert "Couch to 5k"))))</tt></span></blockquote><p class="calibre12">These widgets are adequate enough to create richer user interfaces, and to illustrate we’ll add one more widget builder for grid-like elements: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11"> (defn grid [x y f]<br class="calibre3"/>   (let [g (doto (JPanel.)<br class="calibre3"/>             (.setLayout (GridLayout. x y)))]<br class="calibre3"/>      (dotimes [i x]<br class="calibre3"/>        (dotimes [j y]<br class="calibre3"/>         (.add g (f))))<br class="calibre3"/>      g))</tt></span></blockquote><p class="calibre12">With a small amount of code, we can build the richer user interface in <a href="#filepos764901"><span class="calibre8"><span class="underline">figure 10.6</span></span></a>. </p><p id="filepos764901" class="calibre5"><span class="calibre10"><span class="bold">Figure 10.6. A much more elaborate </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">DynaFrame</span></tt></span><span class="calibre10"><span class="bold"> GUI: there’s no limit to the complexity of this simple GUI model. Go ahead and experiment to your heart’s content. </span></span></p><p class="calibre1"><img src="images/00001.jpg" class="calibre107"/></p><p id="filepos765317" class="calibre5"><span class="calibre10"><span class="bold">Listing 10.6. A more complex GUI example </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11"> (.display gui<br class="calibre3"/>   (let [g1 (txt 10 "Charlemagne")<br class="calibre3"/>         g2 (txt 10 "Pippin")<br class="calibre3"/>          r  (txt 3 "10")<br class="calibre3"/>          d  (txt 3 "5")]<br class="calibre3"/>      (splitter<br class="calibre3"/>        (stack<br class="calibre3"/>          (shelf (label "Player 1") g1)<br class="calibre3"/>          (shelf (label "Player 2") g2)<br class="calibre3"/>          (shelf (label "Rounds ") r<br class="calibre3"/>                 (label "Delay  ") d))<br class="calibre3"/>        (stack<br class="calibre3"/>          (grid 21 11 #(label "-"))<br class="calibre3"/>          (button "Go!" #(alert (str (.getText g1) " vs. "<br class="calibre3"/>                                     (.getText g2) " for "<br class="calibre3"/>                                     (.getText r)  " rounds, every "<br class="calibre3"/>                                     (.getText d)  " seconds.")))))))</tt></span></blockquote><p id="filepos766553" class="calibre12">Though not perfect, it gives you a good idea how to extend these functions to provide a finer level of control over layout and positioning, as well as ways to provide more functionality to create richer interfaces. How would you go about creating an agile environment for incremental GUI development using plain Java? Clojure allows you to start with a powerful set of primitives and incrementally refine them until they suit your exact needs. </p><p class="calibre5">Though this section started as a description of creating a simple dynamic frame using the <tt class="calibre11">gen-class</tt> facility, we felt it was worthwhile to expand into the realm of dynamic, incremental development. There are times when AOT compilation is absolutely necessary (such as client requirements), but our advice is to avoid it if at all possible. Instead, leverage the dynamic nature of Clojure to its fullest, designing your system to fit into that model. </p><p id="filepos767521" class="calibre5"><span class="calibre18"><span class="bold">10.3. Clojure’s relationship to Java arrays </span></span></p><p class="calibre7">In general, the need to delve into arrays should be limited, but such casual dismissal isn’t always apropos. In this section, we’ll cover some of the uses for Java arrays in Clojure, including but not limited to arrays as multimethod dispatch, primitive versus reference arrays, calling variadic functions and constructors, and multi-dimensional arrays. </p><p id="filepos768019" class="calibre5"><span class="bold">10.3.1. Types of arrays: primitive and reference </span><a></a></p><p class="calibre7">As mentioned in <a href="#filepos288030"><span class="calibre8"><span class="underline">section 4.1</span></span></a>, Clojure numbers are of the boxed variety, but in many cases the Clojure compiler can resolve the correct call for primitive interoperability calls. But it can never resolve the need to pass a primitive array when a reference array is provided instead. </p><p class="calibre5"><span class="calibre10"><span class="bold">Creating Primitive Arrays </span></span></p><p class="calibre7">The Java class <tt class="calibre11">java.lang.StringBuilder</tt> provides<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos769045"><span class="calibre33"><span class="calibre8"><span class="underline">4</span></span></span></a><span class="calibre33">]</span></small></sup> a method <tt class="calibre11">.append(char[])</tt> that appends the primitive <tt class="calibre11">char</tt>s in the passed array to its end. But our first instinct for making this happen in Clojure won’t bear fruit: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos769045" class="calibre32"><span class="calibre33">4</span></small></sup><span class="calibre10"> When dealing with and manipulating strings, your best options can almost always be found in the core </span><span class="calibre10"><tt class="calibre11">clojure.string</tt></span><span class="calibre10"> namespace or the </span><span class="calibre10"><tt class="calibre11">clojure.contrib.string</tt></span><span class="calibre10"> namespace in the Clojure contrib library. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(doto (StringBuilder. "abc")<br class="calibre3"/>  (.append (into-array [\x \y \z])))<br class="calibre3"/><br class="calibre3"/>;=&gt; #&lt;StringBuilder abc[Ljava.lang.Character;@65efb4be&gt;</tt></span></blockquote><p class="calibre12">The problem lies in that Clojure’s <tt class="calibre11">into-array</tt> function doesn’t return a primitive array of <tt class="calibre11">char[]</tt>, but instead a reference array of <tt class="calibre11">Character[]</tt>, forcing the Clojure <a id="filepos769901"></a>compiler to resolve the call as to the <tt class="calibre11">StringBuilder.append(Object)</tt> method instead. That the <tt class="calibre11">Array</tt> class is a subclass of <tt class="calibre11">Object</tt> is a constant cause for headache in Java and clearly can be a problem<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos770477"><span class="calibre33"><span class="calibre8"><span class="underline">5</span></span></span></a><span class="calibre33">]</span></small></sup> for Clojure as well. What we really want to do is ensure that a primitive array is used as the argument to <tt class="calibre11">.append</tt>, which we do here: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos770477" class="calibre32"><span class="calibre33">5</span></small></sup><span class="calibre10"> In this example, it’s preferred that a “java.lang.IllegalArgumentException: No matching method found” exception be thrown, because StringBuilder doesn’t have a method matching </span><span class="calibre10"><tt class="calibre11">.append(Character[])</tt></span><span class="calibre10"> or even </span><span class="calibre10"><tt class="calibre11">.append(Object[])</tt></span><span class="calibre10">. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(doto (StringBuilder. "abc")<br class="calibre3"/>  (.append (char-array [\x \y \z])))<br class="calibre3"/><br class="calibre3"/>;=&gt; #&lt;StringBuilder abcxyz&gt;</tt></span></blockquote><p class="calibre12">Clojure provides a number of primitive array-building functions that work similarly to <tt class="calibre11">char-array</tt>, as summarized in the following list. </p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24"><tt class="calibre11">boolean-array</tt></li><li value="2" class="calibre24"><tt class="calibre11">byte-array</tt></li><li value="3" class="calibre24"><tt class="calibre11">char-array</tt></li><li value="4" class="calibre24"><tt class="calibre11">double-array</tt></li><li value="5" class="calibre24"><tt class="calibre11">float-array</tt></li><li value="6" class="calibre24"><tt class="calibre11">int-array</tt></li><li value="7" class="calibre24"><tt class="calibre11">long-array</tt></li><li value="8" class="calibre24"><tt class="calibre11">object-array</tt></li><li value="9" class="calibre24"><tt class="calibre11">short-array</tt></li></ul><p class="calibre5">You could also use the <tt class="calibre11">make-array</tt> and <tt class="calibre11">into-array</tt> functions to create primitive arrays: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(let [ary (make-array Integer/TYPE 3 3)]<br class="calibre3"/>  (dotimes [i 3]<br class="calibre3"/>    (dotimes [j 3]<br class="calibre3"/>      (aset ary i j (+ i j))))<br class="calibre3"/>  (map seq ary))<br class="calibre3"/><br class="calibre3"/>;=&gt; ((0 1 2) (1 2 3) (2 3 4))<br class="calibre3"/><br class="calibre3"/>(into-array Integer/TYPE [1 2 3])<br class="calibre3"/>;=&gt; #&lt;int[] [I@391be9d4&gt;</tt></span></blockquote><p class="calibre12">Populating arrays can often be an iterative affair, as seen in the previous snippet, but there are often more concise ways to do so when creating reference arrays. </p><p class="calibre5"><span class="calibre10"><span class="bold">Creating Reference Arrays </span></span></p><p class="calibre7">To intentionally create an array of a particular reference type, or of compatible types, use the <tt class="calibre11">into-array</tt> function, passing in a sequence of objects: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(into-array ["a" "b" "c"])<br class="calibre3"/>;=&gt; #&lt;String[] [Ljava.lang.String;@3c3ac93e&gt;<br class="calibre3"/><br class="calibre3"/>(into-array [(java.util.Date.) (java.sql.Time. 0)])<br class="calibre3"/>;=&gt; #&lt;Date[] [Ljava.util.Date;@178aab40&gt;<br class="calibre3"/><br class="calibre3"/>(into-array ["a" "b" 1M])<br class="calibre3"/>; java.lang.IllegalArgumentException: array element type mismatch<br class="calibre3"/><br class="calibre3"/>(into-array Number [1 2.0 3M 4/5])<br class="calibre3"/>;=&gt; #&lt;Number[] [Ljava.lang.Number;@140b6e46&gt;</tt></span></blockquote><p class="calibre12">The function <tt class="calibre11">into-array</tt> determines the type of the resulting array based on the first element of the sequence, and each subsequent element type <span class="italic">must</span> be compatible (a <a id="filepos773716"></a>subclass). To create a heterogeneous array of <tt class="calibre11">java.lang.Object</tt>, use the <tt class="calibre11">to-array</tt> or <tt class="calibre11">to-array-2d</tt> function: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">to-array-2d function:<br class="calibre3"/><br class="calibre3"/>(to-array-2d [[1 2 3]<br class="calibre3"/>              [4 5 6]])<br class="calibre3"/>;=&gt; #&lt;Object[][] [[Ljava.lang.Object;@bdccedd&gt;<br class="calibre3"/><br class="calibre3"/>(to-array ["a" 1M #(%) (proxy [Object] [])])<br class="calibre3"/>;=&gt; #&lt;Object[] [Ljava.lang.Object;@18987a33&gt;<br class="calibre3"/><br class="calibre3"/>(to-array [1 (int 2)])<br class="calibre3"/>;=&gt; #&lt;Object[] [Ljava.lang.Object;@6ad3c65d&gt;</tt></span></blockquote><p class="calibre12">Be wary: primitives will be autoboxed when using either <tt class="calibre11">to-array</tt> or <tt class="calibre11">to-array-2d</tt>. </p><p id="filepos774490" class="calibre5"><span class="bold">10.3.2. Array mutability </span><a></a></p><p class="calibre7">Because JVM arrays are mutable, you need to be aware that their contents can change at any point. For example:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def ary  (into-array [1 2 3]))<br class="calibre3"/>(def sary (seq ary))<br class="calibre3"/>sary<br class="calibre3"/>;=&gt; (1 2 3)</tt></span></blockquote><p class="calibre12">What happens to <tt class="calibre11">sary</tt> if we change the contents of <tt class="calibre11">ary</tt>? </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(aset ary 0 42)<br class="calibre3"/>sary<br class="calibre3"/>;=&gt; (42 2 3)</tt></span></blockquote><p class="calibre12">The seq view of an array is that of the live array and therefore subject to concurrent modification. Be cautious when sharing arrays from one function to the next, and especially across threads. Note that this can be especially disastrous should an array change in the middle of a sequential operation, such as the use of the higher-order array functions <tt class="calibre11">amap</tt> and <tt class="calibre11">areduce</tt>, as might be used to define a sum-of-squares function<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos775823"><span class="calibre33"><span class="calibre8"><span class="underline">6</span></span></span></a><span class="calibre33">]</span></small></sup> for arrays: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos775823" class="calibre32"><span class="calibre33">6</span></small></sup><span class="calibre10"> This function is fairly clear but slower than it should be. We’ll make it faster in </span><a href="#filepos954781"><span class="calibre10"><span class="calibre8"><span class="underline">sections 12.1</span></span></span></a><span class="calibre10"> and </span><a href="#filepos988109"><span class="calibre10"><span class="calibre8"><span class="underline">12.5</span></span></span></a><span class="calibre10">. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn asum-sq [xs]<br class="calibre3"/>  (let [dbl (amap xs i ret<br class="calibre3"/>              (* (aget xs i)<br class="calibre3"/>                 (aget xs i)))]<br class="calibre3"/>    (areduce dbl i ret 0<br class="calibre3"/>      (+ ret (aget dbl i)))))<br class="calibre3"/><br class="calibre3"/>(asum-sq (float-array [1 2 3 4 5]))<br class="calibre3"/>;=&gt; 55.0</tt></span></blockquote><p class="calibre12">At any point during the processing of <tt class="calibre11">asum-sq</tt>, the underlying array could change, causing inaccurate results or worse. You should take great care when using Java’s mutable arrays, though sharing only the seq of an array is perfectly safe because there’s no way to get at the array when you only have a reference to the seq. </p><p id="filepos777015" class="calibre5"><span class="bold">10.3.3. That unfortunate naming convention </span><a></a></p><p id="filepos777104" class="calibre7">You might’ve noticed (how could you miss?) the ugly names printed by the Clojure REPL whenever an array is evaluated. There’s logic to this madness, as part of the jumble is the legal name of the class corresponding to the array—the part formed as <tt class="calibre11">[Ljava.lang.String;</tt>. For example, the previous name corresponded to a 1D array of strings. The representation for a 2D array of strings is then <tt class="calibre11">[[Ljava.lang.String;</tt>, and it therefore follows that <tt class="calibre11">[[[Ljava.lang.String;</tt> is a 3D array of strings. Are you sensing a pattern here? <a href="#filepos777777"><span class="calibre8"><span class="underline">Table 10.1</span></span></a> lays it out. </p><p id="filepos777777" class="calibre5"><span class="calibre10"><span class="bold">Table 10.1. Array type class names and dimensions </span></span><a></a></p><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><th scope="col" valign="top" class="calibre26"><p class="calibre27"><span class="calibre10"><span class="bold">Representation</span></span></p></th><th scope="col" valign="top" class="calibre26"><p class="calibre27"><span class="calibre10"><span class="bold">Array type</span></span></p></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">[Ljava.lang.Object;</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Reference array</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">[B</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Primitive byte array</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">[I</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Primitive int array</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">[C</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Primitive char array</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">[S</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Primitive short array</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">[F</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Primitive float array</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">[D</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Primitive double array</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">[J</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Primitive long array</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">[Z</span>
</td><td valign="top" class="calibre16"><span class="calibre10">Primitive boolean array</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10"><span class="bold">Representation</span></span>
</td><td valign="top" class="calibre16"><span class="calibre10"><span class="bold">Dimension</span></span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">[</span>
</td><td valign="top" class="calibre16"><span class="calibre10">1D</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">[[</span>
</td><td valign="top" class="calibre16"><span class="calibre10">2D</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">...</span>
</td><td valign="top" class="calibre16"><span class="calibre10">and so on...</span>
</td></tr></table><p class="calibre7">Using what you know about arrays, the class representation names can be used to do things such as multimethod dispatch:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(what-is (into-array ["a" "b"]))<br class="calibre3"/>;=&gt; "1d String"<br class="calibre3"/><br class="calibre3"/>(what-is (to-array-2d [[1 2][3 4]]))<br class="calibre3"/>;=&gt; "2d Object"<br class="calibre3"/><br class="calibre3"/>(what-is (make-array Integer/TYPE 2 2 2 2))<br class="calibre3"/>;=&gt; "Primitive 4d int"</tt></span></blockquote><p class="calibre12">You can create methods for identifying arrays and returning a descriptive string using the <tt class="calibre11">&lt;indexterm&gt;&lt;primary&gt;java.lang.Class/forName&lt;/primary&gt;&lt;/indexterm&gt;Class/forName</tt> method as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defmulti what-is class)<br class="calibre3"/>(defmethod what-is (Class/forName "[Ljava.lang.String;") [a] "1d String")<br class="calibre3"/>(defmethod what-is (Class/forName "[[Ljava.lang.Object;") [a] "2d Object")<br class="calibre3"/>(defmethod what-is (Class/forName "[[[[I") [a] "Primitive 4d int")</tt></span></blockquote><p class="calibre12">Though not the most beautiful task to perform in Clojure, it’s easy to understand once you’ve grasped how the array class names are constructed. </p><p id="filepos781224" class="calibre5"><span class="bold">10.3.4. Multidimensional arrays </span><a></a></p><p id="filepos781302" class="calibre7">Observe what happens when the following call is tried: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(what-is (into-array [[1.0] [2.0]]))<br class="calibre3"/>; java.lang.IllegalArgumentException: No method in multimethod<br class="calibre3"/>;  'what-is' for dispatch value: class [Lclojure.lang.PersistentVector;</tt></span></blockquote><p class="calibre12">The problem is that the <tt class="calibre11">into-array</tt> function builds a 1D array of persistent vectors, but we wanted a 2D array of doubles. In order to do this, the array would have to be built differently: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defmethod what-is (Class/forName "[[D") [a] "Primitive 2d double")<br class="calibre3"/>(defmethod what-is (Class/forName "[Lclojure.lang.PersistentVector;") [a]<br class="calibre3"/>  "1d Persistent Vector")<br class="calibre3"/><br class="calibre3"/>(what-is (into-array (map double-array [[1.0] [2.0]])))<br class="calibre3"/>;=&gt; "Primitive 2d double"<br class="calibre3"/><br class="calibre3"/>(what-is (into-array [[1.0] [2.0]]))<br class="calibre3"/>;=&gt; "1d Persistent Vector"</tt></span></blockquote><p class="calibre12">We had to use the <tt class="calibre11">map</tt> function with <tt class="calibre11">double-array</tt> on the inner arrays in order to build the properly typed outer array. When working with multidimensional arrays, be sure that you know what your inner elements should be on creation and create them accordingly. </p><p id="filepos782710" class="calibre5"><span class="bold">10.3.5. Variadic method/constructor calls </span><a></a></p><p class="calibre7">There’s no such thing as a variadic constructor or method at the bytecode level, although Java provides syntactic sugar at the language level. Instead, variadic methods expect an array as their final argument, and this is how they should be accessed in Clojure interop scenarios. Take, for example, the call to the <tt class="calibre11">String/format</tt> function: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(String/format "An int %d and a String %s" (to-array [99, "luftballons"]))<br class="calibre3"/>;=&gt; "An int 99 and a String luftballons"</tt></span></blockquote><p class="calibre12">That covers most of the high points regarding arrays in Clojure interoperability. We’ll touch on them briefly when we talk about performance considerations in <a href="#filepos952602"><span class="calibre8"><span class="underline">chapter 12</span></span></a>, but for now we’ll move on to a more interesting topic: the interoperability underpinnings relating to Clojure’s implementation. </p><p id="filepos783802" class="calibre5"><span class="calibre18"><span class="bold">10.4. All Clojure functions implement... </span></span></p><p class="calibre7">Clojure functions are highly amenable to interoperability. Their underlying classes implement a number of useful interfaces that you can investigate by running <tt class="calibre11">(ancestors (class #()))</tt>. Most of the resulting classes are only applicable to the internals of Clojure itself, but a few interfaces are useful in interop scenarios: <tt class="calibre11">java.util.concurrent.Callable, java.util.Comparator</tt>, and <tt class="calibre11">java.lang.Runnable</tt>. In this section, we’ll talk briefly about each and also provide simple examples. </p><p id="filepos784449" class="calibre5"><span class="bold">10.4.1. java.util.Comparator </span><a></a></p><p id="filepos784524" class="calibre7">Simply put, the <tt class="calibre11">java.util.Comparator</tt> interface defines the signature for a single method <tt class="calibre11">.compare</tt> that takes two objects <tt class="calibre11">l</tt> and <tt class="calibre11">r</tt> and returns -1 if <tt class="calibre11">l &lt; r</tt>, 0 if <tt class="calibre11">l == r</tt>, and &gt; 0 if <tt class="calibre11">l &gt; r</tt>. The static Java method <tt class="calibre11">Collections/sort</tt> provides an implementation that takes a derivative of <tt class="calibre11">java.util.List</tt> and a <tt class="calibre11">Comparator</tt> and destructively sorts the list provided. Using this knowledge, we can provide some basic infrastructure for the remainder of this subsection: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(import '[java.util Comparator Collections ArrayList])<br class="calibre3"/><br class="calibre3"/>(defn gimme [] (ArrayList. [1 3 4 8 2]))<br class="calibre3"/><br class="calibre3"/>(doto (gimme)<br class="calibre3"/>  (Collections/sort (Collections/reverseOrder)))<br class="calibre3"/>;=&gt; #&lt;ArrayList [8, 4, 3, 2, 1]&gt;</tt></span></blockquote><p class="calibre12">In order to write a simple comparator that provides a reverse-sort <tt class="calibre11">Comparator</tt>, we might naively do so: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(doto (gimme)<br class="calibre3"/>  (Collections/sort<br class="calibre3"/>    (reify Comparator<br class="calibre3"/>      (compare [this l r]<br class="calibre3"/>        (cond<br class="calibre3"/>          (&gt; l r) -1<br class="calibre3"/>          (= l r) 0<br class="calibre3"/>          :else 1)))))<br class="calibre3"/>;=&gt; #&lt;ArrayList [8, 4, 3, 2, 1]&gt;</tt></span></blockquote><p class="calibre12">Though this works, Clojure provides a better way by allowing the use of a function as the <tt class="calibre11">Comparator</tt> directly. You can couple this knowledge with the fact that Clojure already provides numerous functions useful for comparison, as shown next. </p><p id="filepos786310" class="calibre5"><span class="calibre10"><span class="bold">Listing 10.7. Useful comparison functions </span></span><a></a></p><p class="calibre1"><img src="images/00095.jpg" class="calibre108"/></p><p class="calibre5">When presented with numerous possible implementation strategies, often the best one in Clojure is the simplest.</p><p id="filepos786680" class="calibre5"><span class="bold">10.4.2. java.lang.Runnable </span><a></a></p><p class="calibre7">Java threads expect an object implementing the <tt class="calibre11">java.lang.Runnable</tt> interface meant for computations returning no value. We won’t get into the specifics of threaded <a id="filepos786956"></a>computation until the next chapter, but the next two examples are simple enough to require little a priori knowledge on the matter. If you wish to pass a function to another Java thread, it’s as simple as providing it as an argument to the <tt class="calibre11">Thread</tt> constructor: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(doto (Thread. #(do (Thread/sleep 5000)<br class="calibre3"/>                    (println "haikeeba!")))<br class="calibre3"/>  .start)<br class="calibre3"/>; =&gt; #&lt;Thread Thread[Thread-3,5,main]&gt;<br class="calibre3"/>; ... 5 seconds later<br class="calibre3"/>; haikeeba!</tt></span></blockquote><p class="calibre12">This scenario is unlikely to occur often, because Clojure’s core concurrency features are often sufficient for most needs. But that’s not always the case, and therefore it’s nice to know that raw Clojure functions can be used seamlessly in the JVM’s concurrency API. </p><p id="filepos787877" class="calibre5"><span class="bold">10.4.3. java.util.concurrent.Callable </span><a></a></p><p class="calibre7">The Java interface <tt class="calibre11">java.util.concurrent.Callable</tt> is specifically meant to be used in a threaded context for computations returning a value. You can use a Clojure function using Java’s <tt class="calibre11">java.util.concurrentFutureTask</tt> class representing a “computation to occur later”: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(import '[java.util.concurrent FutureTask])<br class="calibre3"/><br class="calibre3"/>(let [f (FutureTask. #(do (Thread/sleep 5000) 42))]<br class="calibre3"/>  (.start (Thread. #(.run f)))<br class="calibre3"/>  (.get f))<br class="calibre3"/>; ... 5 seconds later<br class="calibre3"/>;=&gt; 42</tt></span></blockquote><p class="calibre12">The call to <tt class="calibre11">FutureTask.get</tt> as the last expression will stop execution (a behavior known as <span class="italic">blocking</span>) until the function passed to the constructor completes. Because the function in question sleeps for 5 seconds, the call to <tt class="calibre11">.get</tt> must wait. </p><p class="calibre5">Clojure’s interoperability mechanisms are a two-way street. Not only do they allow Java APIs to work seamlessly within Clojure, but they also provide ways for Clojure functions to work in Java APIs. In the next section, we’ll continue on this theme of bidirectional interop with a discussion on the ways that Clojure’s collection types can also be used in traditional Java APIs. </p><p id="filepos789320" class="calibre5"><span class="calibre18"><span class="bold">10.5. Using Clojure data structures in Java APIs </span></span></p><p class="calibre7">Clojure functions are ready to use in many Java APIs, and as it turns out, so are its collection types. Just as the Clojure collections are separated along three distinct equality partitions<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos790393"><span class="calibre33"><span class="calibre8"><span class="underline">7</span></span></span></a><span class="calibre33">]</span></small></sup> (maps, sequences, and sets), so too are its levels of Java collection interoperability support. The Java Collections Framework has a nice high-level design philosophy centered around working against interfaces. These interfaces are additionally cognizant of immutability, in that the mutable parts are optional and the immutable <a id="filepos790133"></a>parts are clearly demarcated. In this section, we’ll give a brief rundown of possible ways that Clojure collections can be used within traditional Java APIs adhering to the immutable collection protocols. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos790393" class="calibre32"><span class="calibre33">7</span></small></sup><span class="calibre10"> A refresher on equality partitions can be found in </span><a href="#filepos339163"><span class="calibre10"><span class="calibre8"><span class="underline">section 5.1.2</span></span></span></a><span class="calibre10"> and throughout the remainder of </span><a href="#filepos332652"><span class="calibre10"><span class="calibre8"><span class="underline">chapter 5</span></span></span></a><span class="calibre10">. </span></blockquote><p id="filepos790787" class="calibre35"><span class="bold">10.5.1. java.util.List </span><a></a></p><p class="calibre7">Clojure sequential collections conform to the immutable parts of the <tt class="calibre11">java.util.List</tt> interface, which in turn extends the <tt class="calibre11">java.util.Collection</tt> and <tt class="calibre11">java.lang.Iterable</tt> interfaces. You can see this conformance in action in the following listing. </p><p id="filepos791159" class="calibre5"><span class="calibre10"><span class="bold">Listing 10.8. </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">java.util.List</span></tt></span><span class="calibre10"><span class="bold"> conformance for sequences and seqs </span></span></p><p class="calibre1"><img src="images/00002.jpg" class="calibre108"/></p><p class="calibre5">That Clojure sequences and seqs don’t provide the mutable API of typical Java collections is obvious. But the implications are that you can’t use them in all Java APIs, such as you might attempt when requiring that a vector be sorted destructively with a Java API call: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(java.util.Collections/sort [3 4 2 1])<br class="calibre3"/>; java.lang.UnsupportedOperationException</tt></span></blockquote><p class="calibre12">A better approach is to either use the method used in the previous section using a Clojure function, or even better to use the Clojure’s <tt class="calibre11">sort</tt> function instead. </p><p id="filepos792159" class="calibre5"><span class="bold">10.5.2. java.lang.Comparable </span><a></a></p><p class="calibre7">The interface <tt class="calibre11">java.lang.Comparable</tt> is the cousin of the <tt class="calibre11">Comparator</tt> interface. <tt class="calibre11">Comparator</tt> refers to objects that can compare two other objects, whereas <tt class="calibre11">Comparable</tt> refers to an object that can <span class="italic">compare itself to</span> another object: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(.compareTo [:a] [:a])<br class="calibre3"/>;=&gt; 0<br class="calibre3"/><br class="calibre3"/>(.compareTo [:a :b] [:a])<br class="calibre3"/>;=&gt; 1<br class="calibre3"/><br class="calibre3"/>(.compareTo [:a :b] [:a :b :c])<br class="calibre3"/>;=&gt; -1<br class="calibre3"/><br class="calibre3"/>(sort [[:a :b :c] [:a] [:a :b]])<br class="calibre3"/>;=&gt; ([:a] [:a :b] [:a :b :c])</tt></span></blockquote><p class="calibre12">One thing to note is that Clojure’s vector implementation is currently the only collection type that implements the <tt class="calibre11">java.lang.Comparable</tt> interface providing the <a id="filepos793099"></a><tt class="calibre11">.compareTo</tt> method. As a result, attempting to compare a different collection type to a vector leads to a confusing error message: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(.compareTo [1 2 3] '(1 2 3))<br class="calibre3"/><br class="calibre3"/>; java.lang.ClassCastException: clojure.lang.PersistentList<br class="calibre3"/>;    cannot be cast to clojure.lang.IPersistentVector</tt></span></blockquote><p class="calibre12">Pay no attention to that class-cast exception behind the curtain.</p><p id="filepos793612" class="calibre5"><span class="bold">10.5.3. java.util.RandomAccess </span><a></a></p><p class="calibre7">In general, the <tt class="calibre11">java.util.RandomAccess</tt> interface is used to indicate that the data type provides constant time indexed access to its elements. This allows for algorithms to follow optimized paths accordingly. This optimization is generally performed by using the <tt class="calibre11">.get</tt> method for access rather than an iterator: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(.get '[a b c] 2)<br class="calibre3"/>;=&gt; c</tt></span></blockquote><p class="calibre12">Vectors are currently the only Clojure collection type that can make such guarantees.</p><p id="filepos794289" class="calibre5"><span class="bold">10.5.4. java.util.Collection </span><a></a></p><p class="calibre7">The <tt class="calibre11">java.util.Collection</tt> interface lies at the heart of the Java Collections Framework, and classes implementing it can play in many of Java’s core collections APIs. A useful idiom taking advantage of this fact is the use of a Clojure sequence as a model to build a mutable sequence for use in the Java Collections API, as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn shuffle [coll]<br class="calibre3"/>  (seq (doto (java.util.ArrayList. coll)<br class="calibre3"/>         java.util.Collections/shuffle)))<br class="calibre3"/><br class="calibre3"/>(shuffle (range 10))<br class="calibre3"/>;=&gt; (3 9 2 5 4 7 8 6 1 0)</tt></span></blockquote><p class="calibre12">It’s difficult to write a proper sequence-shuffling function, so the <tt class="calibre11">shuffle</tt> function takes full advantage of an existing Java API that has been tested and used extensively for years. As an added bonus, <tt class="calibre11">shuffle</tt> is mostly<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos795655"><span class="calibre33"><span class="calibre8"><span class="underline">8</span></span></span></a><span class="calibre33">]</span></small></sup> functional, idiomatic, and fast. Clojure favors immutability but doesn’t trap you into it when there are practical solutions to be leveraged. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos795655" class="calibre32"><span class="calibre33">8</span></small></sup><span class="calibre10"><tt class="calibre11">shuffle</tt></span><span class="calibre10"> isn’t referentially transparent. Can you see why? </span></blockquote><p class="calibre12"><span class="calibre10"><span class="bold">Java.Util.Map </span></span></p><p class="calibre7">Like most of the Clojure collections, its maps are analogous to Java maps in that they can be used in nonmutating contexts. But immutable maps have the added advantage of never requiring defensive copies and will act exactly the same as unmodifiable Java maps: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(java.util.Collections/unmodifiableMap<br class="calibre3"/>  (doto (java.util.HashMap.) (.put :a 1)))<br class="calibre3"/>;=&gt; #&lt;UnmodifiableMap {:a=1}&gt;<br class="calibre3"/>(into {} (doto (java.util.HashMap.) (.put :a 1)))<br class="calibre3"/>;=&gt; {:a 1}</tt></span></blockquote><p id="filepos796508" class="calibre12">In both cases, any attempt to modify the map entry classes of the maps will throw an exception. </p><p id="filepos796637" class="calibre5"><span class="bold">10.5.5. java.util.Set </span><a></a></p><p class="calibre7">In the case of Java and Clojure sets, the use of mutable objects<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos797035"><span class="calibre33"><span class="calibre8"><span class="underline">9</span></span></span></a><span class="calibre33">]</span></small></sup> as elements is highly frowned upon: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos797035" class="calibre32"><span class="calibre33">9</span></small></sup><span class="calibre10"> Clojure’s mutable reference types used to represent a logical identity are perfectly safe to use in sets. We’ll explore the reference types in exquisite detail in the next chapter. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(def x (java.awt.Point. 0 0))<br class="calibre3"/>(def y (java.awt.Point. 0 42))<br class="calibre3"/>(def points #{x y})<br class="calibre3"/>points<br class="calibre3"/>;=&gt; #{#&lt;Point java.awt.Point[x=0,y=0]&gt; #&lt;Point java.awt.Point[x=0,y=42]&gt;}</tt></span></blockquote><p class="calibre12">Everything looks peachy at this point, but introducing mutability into the equation has devastating costs:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(.setLocation y 0 0)<br class="calibre3"/>points<br class="calibre3"/>;=&gt; #{#&lt;Point java.awt.Point[x=0,y=0]&gt; #&lt;Point java.awt.Point[x=0,y=0]&gt;}</tt></span></blockquote><p class="calibre12">Oh boy. Not only have we confused the set <tt class="calibre11">points</tt> by modifying its entries out from underneath it, but we’ve also circumvented Clojure’s value-based semantics and the nature of set-ness. Dealing with mutable objects is extremely difficult to reason about, especially when dealing with collections of them. The gates of a mutable class are wide open, and at any point during the execution of your programs this fact can be exploited, willingly or not. But you can’t always avoid dealing with mutable nasties in Clojure code because of a strict adherence to fostering interoperability. </p><p class="calibre5">We’ve covered the two-way interop for functions and now collection types, but we have one final path to traverse: the use and benefits of Clojure’s <tt class="calibre11">definterface</tt> macro. </p><p id="filepos798807" class="calibre5"><span class="calibre18"><span class="bold">10.6. definterface </span></span></p><p class="calibre7">As we mentioned in <a href="#filepos677632"><span class="calibre8"><span class="underline">section 9.3</span></span></a>, Clojure was built on abstractions in the host platform Java. Types and protocols help to provide a foundation for defining your own abstractions in Clojure itself, for use within a Clojure context. But when interoperating with Java code, protocols and types won’t always suffice. Therefore, you need to be able to generate interfaces in some interop scenarios, and also for performance in cases involving primitive argument and return types. In this section, we’ll talk briefly about generating Java interfaces as the syntax, use cases, and purposes are likely familiar. </p><p id="filepos799586" class="calibre5"><span class="bold">10.6.1. Generating interfaces on the fly </span><a></a></p><p class="calibre7">When you AOT-compile a protocol, you generate a public interface by the same name, with the methods defined. The code in <a href="#filepos800265"><span class="calibre8"><span class="underline">listing 10.9</span></span></a> uses <tt class="calibre11">definterface</tt> to define an <a id="filepos799935"></a>interface <tt class="calibre11">ISliceable</tt>. This interface is used to define an abstract thing that has the ability to be sliced using a method <tt class="calibre11">slice</tt>, which takes start and end indices of type int. Likewise, the interface defines a method <tt class="calibre11">sliceCount</tt> that returns an int representing the number of possible slices. </p><p id="filepos800265" class="calibre5"><span class="calibre10"><span class="bold">Listing 10.9. An interface defining a sliceable object </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(definterface ISliceable<br class="calibre3"/>  (slice [^int s ^int e])<br class="calibre3"/>  (^int sliceCount []))<br class="calibre3"/>;=&gt; user.ISliceable</tt></span></blockquote><p class="calibre12">You’ll notice the inclusion of the type decoration <tt class="calibre11">^int</tt> on the arguments to <tt class="calibre11">slice</tt> and the return type of <tt class="calibre11">sliceCount</tt>. For now you can assume that they operate the same as a type declaration in most languages providing them. They look similar to type hints discussed in <a href="#filepos954781"><span class="calibre8"><span class="underline">section 12.1</span></span></a>, except that only in <tt class="calibre11">definterface</tt> are primitive hints supported. Now we can create an instance implementing the <tt class="calibre11">user.ISliceable</tt> interface, as shown next. </p><p id="filepos801177" class="calibre5"><span class="calibre10"><span class="bold">Listing 10.10. A dummy reified </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">ISliceable</span></tt></span></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(def dumb<br class="calibre3"/>  (reify user.ISliceable<br class="calibre3"/>    (slice [_ s e] [:empty])<br class="calibre3"/>    (sliceCount [_] 42)))<br class="calibre3"/><br class="calibre3"/>(.slice dumb 1 2)<br class="calibre3"/>;=&gt; [:empty]<br class="calibre3"/><br class="calibre3"/>(.sliceCount dumb)<br class="calibre3"/>;=&gt; 42</tt></span></blockquote><p class="calibre12">There’s nothing terribly surprising about <tt class="calibre11">dumb</tt>, but you can instead implement it via <tt class="calibre11">deftype, proxy, gen-class</tt>, or even a Java class. Note that <tt class="calibre11">definterface</tt> works even without AOT compilation. </p><p class="calibre5">We can now take <tt class="calibre11">definterface</tt> to the next logical step and extend the <tt class="calibre11">ISliceable</tt> interface to other types using a well-placed protocol. </p><p id="filepos802096" class="calibre5"><span class="calibre10"><span class="bold">Listing 10.11. Using a protocol to extend </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">ISliceable</span></tt></span></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defprotocol Sliceable<br class="calibre3"/>  (slice [this s e])<br class="calibre3"/>  (sliceCount [this]))<br class="calibre3"/><br class="calibre3"/>(extend user.ISliceable<br class="calibre3"/>  Sliceable<br class="calibre3"/>  {:slice (fn [this s e] (.slice this s e))<br class="calibre3"/>   :sliceCount (fn [this] (.sliceCount this))})<br class="calibre3"/><br class="calibre3"/>(sliceCount dumb)<br class="calibre3"/>;=&gt; 42<br class="calibre3"/><br class="calibre3"/>(slice dumb 0 0)<br class="calibre3"/>;=&gt; [:empty]</tt></span></blockquote><p id="filepos802733" class="calibre12">By extending the <tt class="calibre11">ISliceable</tt> interface along <tt class="calibre11">Sliceable, ISliceable</tt> is able to participate in the protocol, meaning that you have the possibility for extending other types, even final types such as <tt class="calibre11">String</tt>, as shown next. </p><p id="filepos803012" class="calibre5"><span class="calibre10"><span class="bold">Listing 10.12. Extending strings along the </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">Sliceable</span></tt></span><span class="calibre10"><span class="bold"> protocol </span></span></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn calc-slice-count [thing]<br class="calibre3"/>  "Calculates the number of possible slices using the formula:<br class="calibre3"/>     (n + r - 1)!<br class="calibre3"/>     ------------<br class="calibre3"/>      r!(n - 1)!<br class="calibre3"/>   where n is (count thing) and r is 2"<br class="calibre3"/>  (let [! #(reduce * (take % (iterate inc 1)))<br class="calibre3"/>        n (count thing)]<br class="calibre3"/>    (/ (! (- (+ n 2)  1))<br class="calibre3"/>       (* (! 2) (! (- n 1))))))<br class="calibre3"/><br class="calibre3"/>(extend-type String<br class="calibre3"/>  Sliceable<br class="calibre3"/>  (slice [this s e] (.substring this s (inc e)))<br class="calibre3"/>  (sliceCount [this] (calc-slice-count this)))<br class="calibre3"/><br class="calibre3"/>(slice "abc" 0 1)<br class="calibre3"/>;=&gt; "ab"<br class="calibre3"/>(sliceCount "abc")<br class="calibre3"/>;=&gt; 6</tt></span></blockquote><p class="calibre12">The advantages of using <tt class="calibre11">definterface</tt> over <tt class="calibre11">defprotocol</tt> are restricted entirely to the fact that the former allows primitive types for arguments and returns. At some point in the future, the same advantages will likely be extended to the interfaces generated, so use <tt class="calibre11">definterface</tt> sparingly and prefer protocols unless absolutely necessary. </p><p id="filepos804458" class="calibre5"><span class="calibre18"><span class="bold">10.7. Be wary of exceptions </span></span></p><p class="calibre7">There’s been much debate on the virtues of checked exceptions in Java, so we won’t cover that here. Instead, we’ll stick to the facts regarding the nuances the JVM imposes on Clojure’s error-handling facilities. Before we begin, consider the following view on the use of exceptions in Clojure source: </p><blockquote class="calibre9"><span class="italic">When writing Clojure code, use errors to mean</span> can’t continue <span class="italic">and exceptions to mean</span> can or might continue. </blockquote><p class="calibre5">We’ll attempt to constrain ourselves to the generalities of exception handling in this section. If you desire information on deciphering exception messages, we talked about that in <a href="#filepos262019"><span class="calibre8"><span class="underline">section 3.4</span></span></a>. If you’re curious about the effects of exceptions on continuation-passing style, then refer back to <a href="#filepos565545"><span class="calibre8"><span class="underline">section 7.3.4</span></span></a>. We discussed the behavior of Clojure to attempt to supplant numerical inaccuracies by throwing exceptions in <a href="#filepos294039"><span class="calibre8"><span class="underline">section 4.1.3</span></span></a>. If you instead want to learn about the interplay between exceptions and Clojure’s reference types, then such matters can be found throughout <a href="#filepos818901"><span class="calibre8"><span class="underline">chapter 11</span></span></a>. Finally, if you have no idea what an exception is, then we discuss the basics in section 1.5.8. </p><p id="filepos806018" class="calibre5"><span class="bold">10.7.1. A bit of background regarding exceptions </span><a></a></p><p id="filepos806113" class="calibre7">The behavior of Clojure’s exception features directly spawns from the JVM enforcing the promulgation of checked exceptions. Virtuous or not in the context of Java development, checked exceptions are antithetical to closures and higher-order functions. Checked exceptions require that not only should the thrower and the party responsible for handling them declare interest, but every intermediary is also forced to participate. These intermediaries don’t have to actively throw or handle exceptions occurring within, but they must declare that they’ll be “passing through.” Therefore, by including the call to a Java method throwing a checked exception within a closure, Clojure has two possible alternatives: </p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24">Provide a cumbersome exception declaration mechanism on every single function, including closures.</li><li value="2" class="calibre24">By default, declare that all functions throw the root <tt class="calibre11">Exception</tt> or <tt class="calibre11">Runtime-Exception</tt>. </li></ul><p class="calibre5">And as you can probably guess, Clojure takes the second approach, which leads to a condition of multilevel wrapping of exceptions as they pass back up the call stack. This is why you see, in almost any <tt class="calibre11">(.printStackTrace *e)</tt> invocation, the point of origin of an error offset by some number of layers of <tt class="calibre11">java.lang.RuntimeException</tt>. Because Java interfaces and classes get to decide what types of problems potential derivative classes and even callers can have, Clojure needs to handle the base <tt class="calibre11">java.lang.Exception</tt> at every level, because it has to preserve dynamism in the face of a closed system. Unless you’re directly calling something that throws typed exceptions, your best bet is to catch <tt class="calibre11">Exception</tt> and then see what you have in context. </p><p id="filepos808014" class="calibre5"><span class="bold">10.7.2. Runtime versus compile-time exceptions </span><a></a></p><p class="calibre7">There are two contexts in Clojure where exceptions can be thrown: runtime and compile time. In this section we’ll touch on both, explaining how and when to use them. </p><p class="calibre5"><span class="calibre10"><span class="bold">Runtime Exceptions </span></span></p><p class="calibre7">The case of runtime exceptions might be the most familiar, because it’s likely to have been encountered and utilized in your own code. There are two types of runtime exceptions: errors and exceptions. We can illustrate the difference between the two by showing you the following: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn explode [] (explode))<br class="calibre3"/>(try (explode) (catch Exception e "Stack is blown"))<br class="calibre3"/>; java.lang.StackOverflowError</tt></span></blockquote><p class="calibre12">So why were we unable to catch the <tt class="calibre11">java.lang.StackOverflowError</tt>? The reason lies in Java’s exception class hierarchy and the fact that <tt class="calibre11">StackOverflowError</tt> isn’t a derivative of the <tt class="calibre11">Exception</tt> class, but instead of the <tt class="calibre11">Error</tt> class: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(try (explode) (catch StackOverflowError e "Stack is blown"))<br class="calibre3"/>;=&gt; "Stack is blown"<br class="calibre3"/>(try (explode) (catch Error e "Stack is blown"))<br class="calibre3"/>;=&gt; "Stack is blown"<br class="calibre3"/><br class="calibre3"/>(try (explode) (catch Throwable e "Stack is blown"))<br class="calibre3"/>;=&gt; "Stack is blown"<br class="calibre3"/><br class="calibre3"/>(try (throw (RuntimeException.))<br class="calibre3"/>  (catch Throwable e "Catching Throwable is Bad"))<br class="calibre3"/>;=&gt; "Catching Throwable is Bad"</tt></span></blockquote><p id="filepos809785" class="calibre12">We started with a catch of the most specific exception type <tt class="calibre11">StackOverflowError</tt> and gradually decreased specificity until catching <tt class="calibre11">Throwable</tt>, which as you’ll notice also catches a <tt class="calibre11">RuntimeException</tt>. In Java, catching exceptions at the level of <tt class="calibre11">Throwable</tt> is considered bad form, and it should generally be viewed the same in Clojure. Therefore, we suggest that you follow the advice stated in the opening to this section and reserve those deriving from <tt class="calibre11">Errors</tt> for conditions that can’t be continued from and those from <tt class="calibre11">Exception</tt> indicating possible continuation. </p><p class="calibre5"><span class="calibre10"><span class="bold">Compile-Time Exceptions </span></span></p><p class="calibre7">There are a few ways that you might come across compile-time exceptions, the most obvious occurring within the body of a macro:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defmacro do-something [x] `(~x))<br class="calibre3"/>(do-something 1)<br class="calibre3"/>; java.lang.ClassCastException:<br class="calibre3"/>;   java.lang.Integer cannot be cast to clojure.lang.IFn</tt></span></blockquote><p class="calibre12">Though the type of the exception is a <tt class="calibre11">java.lang.ClassCastException</tt>, it was indeed thrown by the compiler, which you’d see if you were to trace the stack using something like <tt class="calibre11">(for [e (.getStackTrace *e)] (.getClassName e))</tt>.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos811594"><span class="calibre33"><span class="calibre8"><span class="underline">10</span></span></span></a><span class="calibre33">]</span></small></sup> It’s perfectly acceptable (and even encouraged) to throw exceptions within your own macros, but it’s important to make a distinction between a compile-time and runtime exception. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos811594" class="calibre32"><span class="calibre33">10</span></small></sup><span class="calibre10"> This is a limited analogy to Groovy’s </span><span class="calibre10"><tt class="calibre11">.?</tt></span><span class="calibre10"> operator. Clojure also provides convenience functions for displaying and handling stack traces in the </span><span class="calibre10"><tt class="calibre11">clojure.stacktrace</tt></span><span class="calibre10"> namespace. </span></blockquote><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre28"><span class="calibre10"><span class="bold">Compile-Time Exceptions</span></span></p><p class="calibre5">Why delay until runtime the reporting of an error that at compile time you know exists?</p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">The way to throw a compile-time exception is to make sure your <tt class="calibre11">throw</tt> doesn’t occur within a syntax-quoted form, as we show in the following listing. </p><p id="filepos812573" class="calibre5"><span class="calibre10"><span class="bold">Listing 10.13. Throwing a compile-time exception </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defmacro pairs [&amp; args]<br class="calibre3"/>  (if (even? (count args))<br class="calibre3"/>   `(partition 2 '~args)<br class="calibre3"/>    (throw (Exception. (str "pairs requires an even number of args")))))<br class="calibre3"/><br class="calibre3"/>(pairs 1 2 3)<br class="calibre3"/>; java.lang.Exception: pairs requires an even number of args<br class="calibre3"/><br class="calibre3"/>(pairs 1 2 3 4)<br class="calibre3"/>;=&gt; ((1 2) (3 4))</tt></span></blockquote><p class="calibre12">Nothing is preventing the exception from being thrown at runtime, but because we know that <tt class="calibre11">pairs</tt> requires an even number of arguments, we instead prefer to fail as early as possible—at compilation time. This difference is clearly demonstrated by repeating the preceding test in a function definition: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(fn [] (pairs 1 2 3))<br class="calibre3"/>; java.lang.Exception: pairs requires an even number of args</tt></span></blockquote><p class="calibre12">A runtime exception wouldn’t have been thrown until this function was called, but because the <tt class="calibre11">pairs</tt> macro threw an exception at compile time, users are notified of their error immediately. Though powerful, you should always try to balance the benefits of compile-time error checking with macros and the advantages that implementing as a function provides (the use in higher-order functions, <tt class="calibre11">apply</tt>, and so on). </p><p id="filepos814148" class="calibre5"><span class="bold">10.7.3. Handling exceptions </span><a></a></p><p class="calibre7">There are two ways to handle exceptions and errors, each defined by the way in which the error-handling mechanisms “flow” through the source. Imagine that you want a macro that provides a limited<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos814819"><span class="calibre33"><span class="calibre8"><span class="underline">11</span></span></span></a><span class="calibre33">]</span></small></sup> null-safe (<a href="#filepos1077340"><span class="calibre8"><span class="underline">Koenig 2007</span></span></a>) arrow that catches any occurrence of a <tt class="calibre11">NullPointerException</tt> in a pipeline: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos814819" class="calibre32"><span class="calibre33">11</span></small></sup><span class="calibre10"> There are much more comprehensive </span><span class="calibre10"><tt class="calibre11">-?&gt;</tt></span><span class="calibre10"> and </span><span class="calibre10"><tt class="calibre11">.?.</tt></span><span class="calibre10"> macros found in the </span><span class="calibre10"><tt class="calibre11">clojure.contrib.core</tt></span><span class="calibre10"> namespace, and those are recommended above the one in this section. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defmacro -?&gt; [&amp; forms]<br class="calibre3"/> `(try (-&gt; ~@forms)<br class="calibre3"/>    (catch NullPointerException _# nil)))<br class="calibre3"/><br class="calibre3"/>(-?&gt; 25 Math/sqrt (+ 100))<br class="calibre3"/>;=&gt; 105.0<br class="calibre3"/><br class="calibre3"/>(-?&gt; 25 Math/sqrt (and nil) (+ 100))<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p class="calibre12">The flow of any occurrence of <tt class="calibre11">NullPointerException</tt> happens from the inner functions of the stitched forms. Conceptually, this flow can be viewed as in <a href="#filepos815962"><span class="calibre8"><span class="underline">figure 10.7</span></span></a>, which describes the way that errors can be caught depending on the direction in which data is moving along the stack. </p><p id="filepos815962" class="calibre5"><span class="calibre10"><span class="bold">Figure 10.7. Outside-in and inside-out error handling. There are two ways to handle errors in Clojure. The typical way is to let exceptions flow from the inner forms to the outer. The other way, discussed in </span></span><a></a><a href="#filepos1045484"><span class="calibre10"><span class="bold"><span class="calibre8"><span class="underline">section 13.4</span></span></span></span></a><span class="calibre10"><span class="bold">, uses dynamic bindings to “reach into” the inner forms to handle them immediately. </span></span></p><p class="calibre1"><img src="images/00003.jpg" class="calibre109"/></p><p class="calibre5">The typical <tt class="calibre11">(try ... (catch ...))</tt> form would therefore be used for the case where the handler catches errors bubbling outward from inner functions and forms, as seen in the <tt class="calibre11">-?&gt;</tt> macro. But if you want to catch errors at their point of origin, you’ll need a way to pass handlers up the stack. Fortunately, Clojure provides a way to do this via its dynamic Var feature, which will be discussed in <a href="#filepos1065349"><span class="calibre8"><span class="underline">section 13.5</span></span></a>. </p><p id="filepos817094" class="calibre5"><span class="bold">10.7.4. Custom exceptions </span><a></a></p><p id="filepos817166" class="calibre7">If you’re inclined to write your own exception and error types, then you’ll need to do so using the <tt class="calibre11">gen-class</tt> feature described in <a href="#filepos747545"><span class="calibre8"><span class="underline">section 10.2</span></span></a>. JVM exceptions again are a closed system, and it might be better to explore other possibilities (Houser EK) for reporting and handling errors in your Clojure code. But, should you wish to ignore this advice, then bear in mind that it’s rare for Clojure core functions to throw exceptions, and even more rarely are they checked exceptions. The idiom is for Clojure to throw derivatives of <tt class="calibre11">RuntimeException</tt> or <tt class="calibre11">Error</tt>, and thus your code should also strive for this when appropriate. </p><p id="filepos817916" class="calibre5"><span class="calibre18"><span class="bold">10.8. Summary </span></span></p><p class="calibre7">Clojure provides an extensive set of data abstractions via its types and protocols. It also provides an extensive interoperability facility through <tt class="calibre11">proxy, gen-class, definterface</tt>, exception handling, and the implementation of core Java collection interfaces. Though we stress that types and protocols will give you the performant abstractions needed for solving most problems, we realize that not all interop scenarios are solved this way. In these circumstances, you should use the features listed in this chapter to push you the remainder of the way toward your solution. Clojure embraces Java interoperability, but it does so in specific ways, and with a specific set of tools. </p><p class="calibre5">In the next chapter, we move on to a rather complex topic, and one that Clojure helps to simplify—shared state concurrency and mutation. </p><div class="mbppagebreak"></div><p id="filepos818901" class="calibre5"><span class="calibre6"><span class="bold">Chapter 11. Mutation </span></span><a></a></p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">This chapter covers</span>
</p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24"><a href="#filepos823175"><span class="calibre8"><span class="underline">Software transactional memory with multiversion concurrency control and snapshot isolation</span></span></a></li><a id="filepos819388"></a><li value="2" class="calibre24"><a href="#filepos837442"><span class="calibre8"><span class="underline">When to use Refs</span></span></a></li><li value="3" class="calibre24"><a href="#filepos862456"><span class="calibre8"><span class="underline">When to use Agents</span></span></a></li><li value="4" class="calibre24"><a href="#filepos888278"><span class="calibre8"><span class="underline">When to use Atoms</span></span></a></li><li value="5" class="calibre24"><a href="#filepos897207"><span class="calibre8"><span class="underline">When to use locks</span></span></a></li><li value="6" class="calibre24"><a href="#filepos906634"><span class="calibre8"><span class="underline">When to use futures</span></span></a></li><li value="7" class="calibre24"><a href="#filepos917093"><span class="calibre8"><span class="underline">When to use promises</span></span></a></li><li value="8" class="calibre24"><a href="#filepos926896"><span class="calibre8"><span class="underline">Parallelism</span></span></a></li><li value="9" class="calibre24"><a href="#filepos932992"><span class="calibre8"><span class="underline">Vars and dynamic binding</span></span></a></li></ul><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">Clojure’s main tenet isn’t the facilitation of concurrency. Instead, Clojure at its core is concerned with the sane management of state, and facilitating concurrent programming naturally falls out of that. The JVM operates on a shared-state concurrency model built around juggling fine-grained locks that protect access to shared data. Even if you can keep all of your locks in order, rarely does such a strategy scale well, and even less frequently does it foster reusability. But Clojure’s state management is simpler to reason about and promotes reusability. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre28"><span class="calibre10"><span class="bold">Clojure Aphorism</span></span></p><p id="filepos821265" class="calibre5">A tangled web of mutation means that <span class="italic">any</span> change to your code potentially occurs in the large. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">In this chapter, we’ll take the grand tour of the mutation primitives and see how Clojure makes concurrent programming not only possible, but fun. Our journey will take us through Clojure’s four major mutable references: Refs, Agents, Atoms, and Vars. When possible and appropriate, we’ll also point out the Java facilities for concurrent programming (including locking) and provide information on the trade-offs involved in choosing them. We’ll also explore parallelism support in Clojure using futures, promises, and a trio of functions <tt class="calibre11">pmap, pvalues</tt>, and <tt class="calibre11">pcalls</tt>. </p><p class="calibre5">Before we dive into the details of Clojure’s reference types, let’s start with a high-level overview of Clojure’s <span class="italic">software transactional memory</span> (STM). </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">Concurrency vs. parallelism</span>
</p><p class="calibre7"><span class="italic">Concurrency</span> refers to the execution of disparate tasks at roughly the same time, each sharing a common resource. The results of concurrent tasks often affect the behavior of other concurrent tasks, and therefore contain an element of nondeterminism. <span class="italic">Parallelism</span> refers to partitioning a task into multiple parts, each run at the same time. Typically, parallel tasks work toward an aggregate goal and the result of one doesn’t affect the behavior of any other parallel task, thus maintaining determinacy. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p id="filepos823175" class="calibre5"><span class="calibre18"><span class="bold">11.1. Software transactional memory with multiversion concurrency contr- rol and snapshot isolation </span></span></p><blockquote class="calibre9"><span class="italic">A faster program that doesn’t work right is useless.</span></blockquote><blockquote class="calibre25"><span class="italic">Simon Peyton-Jones in “Beautiful Concurrency”</span></blockquote><p class="calibre5">In <a href="#filepos106322"><span class="calibre8"><span class="underline">chapter 1</span></span></a>, we defined three important terms: </p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24"><span class="italic">Time</span>—The relative moments when events occur </li><li value="2" class="calibre24"><span class="italic">State</span>—A snapshot of an entity’s properties at a moment in time </li><li value="3" class="calibre24"><span class="italic">Identity</span>—The logical entity identified by a common stream of states occurring over time </li></ul><p class="calibre5">These terms form the foundation for Clojure’s model of state management and mutation. In Clojure’s model, a program must accommodate the fact that when dealing with identities, it’s receiving a snapshot of its properties at a moment in time, not necessarily the most recent. Therefore, all decisions must be made in a continuum. This model is a natural one, as humans and animals alike make all decisions based on their current knowledge of an ever-shifting world. Clojure provides the tools for dealing with identity semantics via its <span class="italic">Ref</span> reference type, the change semantics of which are governed by Clojure’s software transactional memory; this ensures state consistency throughout the application timeline, delineated by a <span class="italic">transaction</span>. </p><p id="filepos824901" class="calibre5"><span class="bold">11.1.1. Transactions </span><a></a></p><p id="filepos824968" class="calibre7">Within the first few moments of using Clojure’s STM, you’ll notice something different than you may be accustomed to: no locks. Consequently, because there’s no need for ad-hoc locking schemes when using STM, there’s no chance of deadlock. Likewise, Clojure’s STM doesn’t require the use of monitors and as a result is free from lost wakeup conditions. Behind the scenes, Clojure’s STM uses <span class="italic">multiversion concurrency control</span> (MVCC) to ensure <span class="italic">snapshot isolation</span>. In simpler terms, snapshot isolation means that each transaction gets its own view of the data that it’s interested in. This <span class="italic">snapshot</span> is made up of in-transaction reference values, forming the foundation of MVCC (<a href="#filepos1083075"><span class="calibre8"><span class="underline">Ullman 1988</span></span></a>). As illustrated in <a href="#filepos826884"><span class="calibre8"><span class="underline">figure 11.1</span></span></a>, each transaction merrily chugs along making changes to in-transaction values only, oblivious to and ambivalent about other transactions. At the conclusion of the transaction, the local values are examined against the modification target for conflicts. An example of a simple possible conflict is if another transaction <tt class="calibre11">B</tt> committed a change to a target reference during the time that transaction <tt class="calibre11">A</tt> was working, thus causing <tt class="calibre11">A</tt> to retry. If no conflicts are found, then the in-trans-action values are committed and the target references are modified with their updated values. Another advantage that STM provides is that in the case of an exception during a transaction, its in-transaction values are thrown away and the exception propagated outward. In the case of lock-based schemes, exceptions can complicate matters ever more, because in most cases locks need to be released (and in some cases, in the correct order) before an exception can be safely propagated up the call stack. </p><p id="filepos826884" class="calibre5"><span class="calibre10"><span class="bold">Figure 11.1. Illustrating an STM retry: Clojure’s STM works much like a database. </span></span><a></a></p><p class="calibre1"><img src="images/00004.jpg" class="calibre110"/></p><p class="calibre5">Because each transaction has its own isolated snapshot, there’s no danger in retrying—the data is never modified until a successful commit occurs. STM transactions can easily nest without taking additional measures to facilitate composition. In languages providing explicit locking for concurrency, matters of composability are often difficult, if not impossible. The reasons for this are far-reaching and the mitigating forces (<a href="#filepos1072867"><span class="calibre8"><span class="underline">Goetz 2006</span></span></a>) complex, but the primary reasons tend to be that lock-based concurrency schemes often hinge on a secret incantation not explicitly understandable through the source itself: for example, the order in which to take and release a set of locks. </p><p id="filepos827930" class="calibre5"><span class="bold">11.1.2. Embedded transactions </span><a></a></p><p class="calibre7">In systems providing embedded transactions, it’s often common for transactions to be nested, thus limiting the scope of restarts (<a href="#filepos1073541"><span class="calibre8"><span class="underline">Gray 1992</span></span></a>). Embedding transactions within Clojure operates differently, as summarized in <a href="#filepos828391"><span class="calibre8"><span class="underline">figure 11.2</span></span></a>. </p><p id="filepos828391" class="calibre5"><span class="calibre10"><span class="bold">Figure 11.2. Clojure’s embedded transactions: a restart in any of Clojure’s embedded transactions </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">A, B, b</span></tt></span><span class="calibre10"><span class="bold">, and </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">C</span></tt></span><span class="calibre10"><span class="bold"> causes a restart in the whole subsuming transaction. This is unlike a fully embedded transaction system where the subtransactions can be used to restrain the scope of restarts. </span></span></p><p class="calibre1"><img src="images/00006.jpg" class="calibre111"/></p><p class="calibre5">In some database systems, transactions can be used to limit the scope of a restart as shown when transaction <tt class="calibre11">embedded.b</tt> restarts only as far back as its own scope. Clojure has but one transaction per thread, thus causing all subtransactions to be subsumed into the larger transaction. Therefore, when a restart occurs in the (conceptual) subtransaction <tt class="calibre11">clojure.b</tt>, it causes a restart of the larger transaction. Though not shown, some transaction systems provide committal in each subtransaction; in Clojure, commit only occurs at the outermost larger transaction. </p><p id="filepos829618" class="calibre5"><span class="bold">11.1.3. The things that STM makes easy </span><a></a></p><p id="filepos829703" class="calibre7">The phrase TANSTAAFL, meaning “There ain’t no such thing as a free lunch,” was popularized in the excellent sci-fi novel <span class="italic">The Moon Is a Harsh Mistress</span> (<a href="#filepos1074471"><span class="calibre8"><span class="underline">Heinlein 1966</span></span></a>) and is an apt response to the view that STM is a panacea for concurrency complexities. </p><p id="filepos830061" class="calibre5">As you proceed through this chapter, we urge you to keep this in the back of your mind, because it’s important to realize that though Clojure facilitates concurrent programming, it doesn’t solve it for you. But there are a few things that Clojure’s STM implementation simplifies in solving difficult concurrent problems. </p><p class="calibre5"><span class="calibre10"><span class="bold">Consistent Information </span></span></p><p class="calibre7">The STM allows you to perform arbitrary sets of read/write operations on arbitrary sets of data in a consistent (<a href="#filepos1080816"><span class="calibre8"><span class="underline">Papadimitriou 1986</span></span></a>) way. By providing these assurances, the STM allows your programs to make decisions given overlapping subsets of information. Likewise, Clojure’s STM helps to solve the reporting problem—the problem of getting a consistent view of the world in the face of massive concurrent modification and reading, without stopping (locking). </p><p class="calibre5"><span class="calibre10"><span class="bold">No Need for Locks </span></span></p><p class="calibre7">In any sized application, the inclusion of locks for managing concurrent access to shared data adds complexity. There are many factors adding to this complexity, but chief among them are the following: </p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24">You can’t use locks without supplying extensive error handling. This is critical in avoiding orphaned locks (locks held by a thread that has died). </li><li value="2" class="calibre24">Every application requires that you reinvent a whole new locking scheme.</li><li value="3" class="calibre24">Locking schemes often require that you impose a total ordering that’s difficult to enforce in client code, frequently leading to a priority inversion scenario. </li></ul><p class="calibre5">Locking schemes are difficult to design correctly and become increasingly so as the number of locks grows. Clojure’s STM eliminates the need for locking and as a result eliminates dreaded deadlock scenarios. Clojure’s STM provides a story for managing state consistently. Adhering to this story will go a long way toward helping you solve software problems effectively. This is true even when concurrent programming isn’t a factor in your design. </p><p class="calibre5"><span class="calibre10"><span class="bold">Aci </span></span></p><p class="calibre7">In the verbiage of database transactions is a well-known acronym ACID, which refers to the properties ensuring transactional reliability. Clojure’s STM provides the first three properties: <span class="italic">atomicity</span>, <span class="italic">consistency</span>, and <span class="italic">isolation</span>. The other, <span class="italic">durability</span>, is missing due to the fact that Clojure’s STM resides in-memory and is therefore subject to data loss in the face of catastrophic system failure. Clojure relegates the problem of maintaining durability to the application developer instead of supplying common strategies by default: database persistence, external application logs, serialization, and so on. </p><p id="filepos833159" class="calibre5"><span class="bold">11.1.4. Potential downsides </span><a></a></p><p class="calibre7">There are two potential problems inherent in STMs in general, which we’ll only touch on briefly here.</p><p class="calibre5"><span class="calibre10"><span class="bold">Write Skew </span></span></p><p class="calibre7">For the most part, you can write correct programs simply by putting all access and changes to references in appropriately scoped transactions. The one exception to this <a id="filepos833639"></a>is <span class="italic">write skew</span>, which occurs in MVCC systems such as Clojure’s. Write skew can occur when one transaction uses the value of a reference to regulate its behavior but doesn’t write to that reference. At the same time, another transaction updates the value for that same reference. One way to avoid this would be to do a “dummy write” in the first transaction, but Clojure provides a less costly solution: the <tt class="calibre11">ensure</tt> function. This scenario is rare in Clojure applications, but possible. </p><p class="calibre5"><span class="calibre10"><span class="bold">Live-Lock </span></span></p><p class="calibre7"><span class="italic">Live-lock</span> refers to a set of transaction(s) that repeatedly restart one another. Clojure combats live-lock in a couple of ways. First, there are transaction restart limits that will raise an error when breached. Generally this occurs when the units of work within some number of transactions is too large. The second way that Clojure combats live-lock is called <span class="italic">barging</span>. Barging refers to some careful logic in the STM implementation allowing an older transaction to continue running while younger transactions retry. </p><p id="filepos834794" class="calibre5"><span class="bold">11.1.5. The things that make STM unhappy </span><a></a></p><p class="calibre7">Certain things can rarely (if ever) be safely performed within a transaction, and in this section we’ll talk briefly about each. </p><p class="calibre5"><span class="calibre10"><span class="bold">I/O </span></span></p><p class="calibre7">Any I/O operation in the body of a transaction is highly discouraged. Due to restarts, the embedded I/O could at best be rendered useless, and cause great harm at worst. It’s advised that you employ the <tt class="calibre11">io!</tt> macro whenever performing I/O operations: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(io! (.println System/out "Haikeeba!"))<br class="calibre3"/>; Haikeeba!</tt></span></blockquote><p class="calibre12">When this same statement is used in a transaction, an exception is thrown:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(dosync (io! (.println System/out "Haikeeba!")))<br class="calibre3"/>; java.lang.IllegalStateException: I/O in transaction</tt></span></blockquote><p class="calibre12">Though it may not be feasible to use <tt class="calibre11">io!</tt> in every circumstance, it’s a good idea to do so whenever possible. </p><p class="calibre5"><span class="calibre10"><span class="bold">Class Instance Mutation </span></span></p><p class="calibre7">Unrestrained instance mutation is often not <span class="italic">idempotent</span>, meaning that running a set of mutating operations multiple times often displays different results. </p><p class="calibre5"><span class="calibre10"><span class="bold">Large Transactions </span></span></p><p class="calibre7">Though the size of transactions is highly subjective, the general rule of thumb when partitioning units of work should always be <span class="italic">get in and get out as quickly as possible</span>. </p><p class="calibre5">Though it’s important to understand that transactions will help to simplify the management of state, you should strive to minimize their footprint in your code. The use of I/O and instance mutation is often an essential part of many applications; it’s important to work to separate your programs into logical partitions, keeping I/O and its ilk on one side, and transaction processing and mutation on the other. Fortunately for us, Clojure provides a powerful toolset for making the management of mutability <a id="filepos837118"></a>sane, but none of the tools provide a shortcut to thinking. Multithreaded programming is a difficult problem, independent of specifics, and Clojure’s state-management tools won’t solve this problem magically. We’ll help to guide you through the proper use of these tools starting with Clojure’s Ref type. </p><p id="filepos837442" class="calibre5"><span class="calibre18"><span class="bold">11.2. When to use Refs </span></span></p><p class="calibre7">Clojure currently provides four different reference types to aide in concurrent programming: Refs, Agents, Atoms, and Vars. All but Vars are considered shared references and allow for changes to be seen across threads of execution. The most important point to remember about choosing between reference types is that although their features sometimes overlap, each has an ideal use. All the reference types and their primary characteristics are shown in <a href="#filepos838084"><span class="calibre8"><span class="underline">figure 11.3</span></span></a>. </p><p id="filepos838084" class="calibre5"><span class="calibre10"><span class="bold">Figure 11.3. Clojure’s four reference types are listed across the top, with their features listed down the left. Atoms are for lone synchronous objects. Agents are for asynchronous actions. Vars are for thread-local storage. Refs are for synchronously coordinating multiple objects. </span></span><a></a></p><p class="calibre1"><img src="images/00007.jpg" class="calibre112"/></p><p class="calibre5">The unique feature of Refs is that they’re <span class="italic">coordinated</span>. This means that reads and writes to multiple refs can be made in a way that guarantees no race conditions. <span class="italic">Asynchronous</span> means that the request to update is queued to happen in another thread some time later, while the thread that made the request continues immediately. <span class="italic">Retriable</span> indicates that the work done to update a reference’s value is speculative and may have to be repeated. Finally, <span class="italic">thread-local</span> means that thread safety is achieved by isolating changes to state to a single thread. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">dothreads</span>
</p><p class="calibre7">To illustrate some major points, we’ll use a function <tt class="calibre11">dothreads!</tt> that launches a given number of threads each running a function a number of times: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(import '(java.util.concurrent Executors))<br class="calibre3"/>(def *pool* (Executors/newFixedThreadPool<br class="calibre3"/>              (+ 2 (.availableProcessors (Runtime/getRuntime)))))<br class="calibre3"/><br class="calibre3"/>(defn dothreads! [f &amp; {thread-count :threads<br class="calibre3"/>                       exec-count :times<br class="calibre3"/>                      :or {thread-count 1 exec-count 1}}]<br class="calibre3"/>  (dotimes [t thread-count]<br class="calibre3"/>    (.submit *pool* #(dotimes [_ exec-count] (f)))))</tt></span></blockquote><p class="calibre12">The <tt class="calibre11">dothreads!</tt> function is of limited utility—throwing a bunch of threads at a function to see if it breaks. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">Value access via the <tt class="calibre11">@</tt> reader feature or the <tt class="calibre11">deref</tt> function provide a uniform client interface, regardless of the reference type used. On the other hand, the write mechanism associated with each reference type is unique by name and specific behavior, but <a id="filepos840697"></a>similar in structure. Each referenced value is changed through the application<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos841233"><span class="calibre33"><span class="calibre8"><span class="underline">1</span></span></span></a><span class="calibre33">]</span></small></sup> of a pure function. The result of this function will become the new referenced value. Finally, all reference types allow the association of a validator function via <tt class="calibre11">setvalidator</tt> that will be used as the final gatekeeper on any value change. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos841233" class="calibre32"><span class="calibre33">1</span></small></sup><span class="calibre10"> Except for </span><span class="calibre10"><tt class="calibre11">ref-set</tt></span><span class="calibre10"> on Refs, </span><span class="calibre10"><tt class="calibre11">reset!</tt></span><span class="calibre10"> on Atoms, and </span><span class="calibre10"><tt class="calibre11">set!</tt></span><span class="calibre10"> on Vars. </span></blockquote><p id="filepos841535" class="calibre35"><span class="bold">11.2.1. Coordinated, synchronous change using alter </span><a></a></p><p class="calibre7">A Ref is a reference type allowing synchronous, coordinated change to its contained value. What does this mean? By enforcing that any change to a Ref’s value occurs in a transaction, Clojure can guarantee that change happens in a way that maintains a consistent view of the referenced value in all threads. But there’s a question as to what constitutes coordination. We’ll construct a simple vector of Refs to represent a 3 x 3 chess board: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def initial-board<br class="calibre3"/>     [[:- :k :-]<br class="calibre3"/>      [:- :- :-]<br class="calibre3"/>      [:- :K :-]])<br class="calibre3"/><br class="calibre3"/>(defn board-map [f bd]<br class="calibre3"/>  (vec (map #(vec (for [s %] (f s))) bd)))</tt></span></blockquote><p class="calibre12">Just as in <a href="#filepos190361"><span class="calibre8"><span class="underline">section 2.4</span></span></a>, the lowercase keyword represents a dark king piece and the uppercase a light king piece. We’ve chosen to represent the board as a 2D vector of Refs (which are created by the <tt class="calibre11">board-map</tt> function). There are other ways to represent our board, but we’ve chosen this because it’s nicely illustrative—the act of moving a piece would require a <span class="italic">coordinated</span> change in two reference squares, or else a change to one square in one thread could lead to another thread observing that square as occupied. Likewise, this problem requires synchronous change, because it would be no good for pieces of the same color to move consecutively. Refs are the only game in town to ensure that the necessary coordinated change occurs synchronously. Before you see Refs in action, we need to define auxiliary functions: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn reset!<br class="calibre3"/>  "Resets the board state.  Generally these types of functions are a<br class="calibre3"/>   bad idea, but matters of page count force our hand."<br class="calibre3"/>  []<br class="calibre3"/>  (def board (board-map ref initial-board))<br class="calibre3"/>  (def to-move (ref [[:K [2 1]] [:k [0 1]]]))<br class="calibre3"/>  (def num-moves (ref 0)))<br class="calibre3"/><br class="calibre3"/>(def king-moves (partial neighbors<br class="calibre3"/>     [[-1 -1] [-1 0] [-1 1] [0 -1] [0 1] [1 -1] [1 0] [1 1]] 3))<br class="calibre3"/><br class="calibre3"/>(defn good-move? [to enemy-sq]<br class="calibre3"/>  (when (not= to enemy-sq) to))<br class="calibre3"/><br class="calibre3"/>(defn choose-move [[[mover mpos][_ enemy-pos]]]<br class="calibre3"/>  [mover (some #(good-move? % enemy-pos)<br class="calibre3"/>               (shuffle (king-moves mpos)))])</tt></span></blockquote><p id="filepos844230" class="calibre12">The <tt class="calibre11">to-move</tt> structure describes the order of moves, so in the base case, it states that the light king <tt class="calibre11">:K</tt> at y=2,x=1 moves before the dark king <tt class="calibre11">:k</tt> at y=0,x=1. We reuse the <tt class="calibre11">neighbors</tt> function from <a href="#filepos569849"><span class="calibre8"><span class="underline">section 7.4</span></span></a> to build a legal-move generator for chess king pieces. We do this by using <tt class="calibre11">partial</tt> supplied with the kingly position deltas and the <tt class="calibre11">board</tt> size. The <tt class="calibre11">good-move?</tt> function states that a move to a square is legal only if the enemy isn’t already located there. The function <tt class="calibre11">choose-move</tt> destructures the <tt class="calibre11">to-move</tt> vector and chooses a good move from a shuffled sequence of legal moves. The <tt class="calibre11">choose-move</tt> function can be tested in isolation: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(reset!)<br class="calibre3"/>(take 5 (repeatedly #(choose-move @to-move)))<br class="calibre3"/>;=&gt; ([:K [1 0]] [:K [1 1]] [:K [1 1]] [:K [1 0]] [:K [2 0]])</tt></span></blockquote><p class="calibre12">And now we’ll create a function to make a random move for the piece at the front of <tt class="calibre11">to-move</tt>, shown next. </p><p id="filepos845435" class="calibre5"><span class="calibre10"><span class="bold">Listing 11.1. Using </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">alter</span></tt></span><span class="calibre10"><span class="bold"> to update a Ref </span></span></p><p class="calibre1"><img src="images/00086.jpg" class="calibre113"/></p><p class="calibre5">The <tt class="calibre11">alter</tt> function appears four times within the <tt class="calibre11">dosync</tt>, so that the <tt class="calibre11">from</tt> and <tt class="calibre11">to</tt> positions, as well as the <tt class="calibre11">to-move</tt> Refs, are updated in a coordinated fashion. We’re using the <tt class="calibre11">place</tt> function as the <tt class="calibre11">alter</tt> function, which states “given a <tt class="calibre11">to</tt> piece and a <tt class="calibre11">from</tt> piece, always return the <tt class="calibre11">to</tt> piece.” Observe what occurs when <tt class="calibre11">make-move</tt> is run once: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(make-move)<br class="calibre3"/>;=&gt; [[:k [0 1]] [:K [2 0]]]<br class="calibre3"/>(board-map deref board)<br class="calibre3"/>;=&gt; [[:- :k :-] [:- :- :-] [:K :- :-]]<br class="calibre3"/>@num-moves<br class="calibre3"/>;=&gt; 1</tt></span></blockquote><p class="calibre12">We’ve successfully made a change to two board squares, the <tt class="calibre11">to-move</tt> structure, and <tt class="calibre11">num-moves</tt> using the uniform state change model. By itself, this model of state change is compelling. The semantics are simple to understand: give a reference a function that determines how the value changes. This is the model of sane state change that Clojure preaches. But we can now throw a bunch of threads at this solution and still maintain consistency: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn go [move-fn threads times]<br class="calibre3"/>  (dothreads! move-fn :threads threads :times times))<br class="calibre3"/><br class="calibre3"/>(go make-move 100 100)<br class="calibre3"/>(board-map #(dosync (deref %)) board)<br class="calibre3"/>;=&gt; [[:k :- :-] [:- :- :-] [:K :- :-]]<br class="calibre3"/>@to-move<br class="calibre3"/>;=&gt; [[:k [0 0]] [:K [2 0]]]<br class="calibre3"/>@num-moves<br class="calibre3"/>;=&gt; 10001</tt></span></blockquote><p id="filepos847407" class="calibre12"><a href="#filepos847883"><span class="calibre8"><span class="underline">Figure 11.4</span></span></a> shows that at the time of the transaction, the <span class="italic">in-transaction</span> value of the <tt class="calibre11">to</tt> square is set to <tt class="calibre11">(apply place @SQUARE-REF PIECE)</tt>. At the end of the transaction, the STM uses this in-transaction value as the commit value. If any other transaction had updated any other coordinated Ref before commit time, then the whole transaction would be retried. </p><p id="filepos847883" class="calibre5"><span class="calibre10"><span class="bold">Figure 11.4. Alter path: the in-transaction value 9 for the Ref </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">num-moves</span></tt></span><span class="calibre10"><span class="bold"> is retrieved in the body of the transaction and manipulated with the </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">alter</span></tt></span><span class="calibre10"><span class="bold"> function </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">inc</span></tt></span><span class="calibre10"><span class="bold">. This resulting value 10 is eventually used for the commit-time value, unless a retry is required. </span></span></p><p class="calibre1"><img src="images/00009.jpg" class="calibre114"/></p><p class="calibre5">Clojure’s retry mechanism guarantees that the Refs in a transaction are always coordinated upon commit because all other transactions line up waiting their turn to commit their coordinated values. Look at what happens should the Ref updates happen in separate transactions: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn bad-make-move []<br class="calibre3"/>  (let [move (choose-move @to-move)]<br class="calibre3"/>    (dosync (move-piece move @to-move))<br class="calibre3"/>    (dosync (update-to-move move))))<br class="calibre3"/><br class="calibre3"/>(go bad-make-move 100 100)<br class="calibre3"/>(board-map #(dosync (deref %)) board)<br class="calibre3"/>;=&gt; [[:- :K :-] [:- :- :-] [:- :K :-]]</tt></span></blockquote><p class="calibre12">Clearly something has gone awry, and as we mentioned, the reason lies in splitting the updates of the <tt class="calibre11">to</tt> and <tt class="calibre11">from</tt> Refs into different transactions. Being separated into two transactions means that they’re (potentially) running on different timelines. Because <tt class="calibre11">board</tt> and <tt class="calibre11">to-move</tt> are dependent, their states <span class="italic">must</span> be coordinated, but we’ve broken that necessity with <tt class="calibre11">bad-make-move</tt>. Therefore, somewhere along the line <tt class="calibre11">board</tt> was updated from two subsequent timelines where it was <tt class="calibre11">:K</tt>’s turn to move! </p><p class="calibre5">As shown in <a href="#filepos850181"><span class="calibre8"><span class="underline">figure 11.5</span></span></a>, either transaction can commit or be restarted; but because the two Refs are no longer in the same transaction, the occurrences of these conditions become staggered over time, leading to inconsistent values. </p><p id="filepos850181" class="calibre5"><span class="calibre10"><span class="bold">Figure 11.5. Splitting coordinated Refs: if Refs </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">A</span></tt></span><span class="calibre10"><span class="bold"> and </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">B</span></tt></span><span class="calibre10"><span class="bold"> should be coordinated, then splitting their updates across different transactions is dangerous. Value </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">a?</span></tt></span><span class="calibre10"><span class="bold"> is eventually committed to </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">A</span></tt></span><span class="calibre10"><span class="bold">, but the update for </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">B</span></tt></span><span class="calibre10"><span class="bold"> never commits due to retry and coordination is lost. Another error occurs if </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">B</span></tt></span><span class="calibre10"><span class="bold">’s change depends on </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">A</span></tt></span><span class="calibre10"><span class="bold">’s value and </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">A</span></tt></span><span class="calibre10"><span class="bold"> and </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">B</span></tt></span><span class="calibre10"><span class="bold"> are split across transactions. There are no guarantees that the dependent values refer to the same timeline. </span></span></p><p class="calibre1"><img src="images/00010.jpg" class="calibre115"/></p><p id="filepos851416" class="calibre5"><span class="bold">11.2.2. Commutative change with commute </span><a></a></p><p id="filepos851502" class="calibre7"><a href="#filepos847883"><span class="calibre8"><span class="underline">Figure 11.4</span></span></a> showed that using <tt class="calibre11">alter</tt> can cause a transaction to retry if a Ref it depends on is modified and committed while it’s running. But there may be circumstances where the value of a Ref within a given transaction isn’t important to its completion semantics. For example, the <tt class="calibre11">num-moves</tt> Ref is a simple counter, and surely its value at any given time is irrelevant for determining how it should be incremented. To handle these loose dependency circumstances, Clojure offers an operation named <tt class="calibre11">commute</tt>. What if we were to change the <tt class="calibre11">make-move</tt> function to use the <tt class="calibre11">commute</tt> function instead of <tt class="calibre11">alter</tt>? </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn move-piece [[piece dest] [[_ src] _]]<br class="calibre3"/>  (commute (get-in board dest) place piece)<br class="calibre3"/>  (commute (get-in board src ) place :-)<br class="calibre3"/>  (commute num-moves inc))<br class="calibre3"/><br class="calibre3"/>(reset!)<br class="calibre3"/>(go make-move 100 100)<br class="calibre3"/>(board-map deref board)<br class="calibre3"/>;=&gt; [[:K :- :-] [:- :- :-] [:- :- :k]]<br class="calibre3"/>@to-move<br class="calibre3"/>;=&gt; [[:K [0 0]] [:k [2 2]]]</tt></span></blockquote><p class="calibre12">Everything looks great! But you can’t assume that the same will work for <tt class="calibre11">update-to-move</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn update-to-move [move]<br class="calibre3"/>  (commute to-move #(vector (second %) move)))<br class="calibre3"/><br class="calibre3"/>(go make-move 100 100)<br class="calibre3"/>(board-map #(dosync (deref %)) board)<br class="calibre3"/>;=&gt; [[:- :- :-] [:- :K :-] [:- :- :K]]<br class="calibre3"/>@to-move<br class="calibre3"/>[[:K [2 2]] [:K [1 1]]]</tt></span></blockquote><p id="filepos853266" class="calibre12">Thanks to our rash decision, we’ve once again introduced inconsistency into the system. But why? The reason lies in the fact that the new <tt class="calibre11">update-to-move</tt> isn’t amenable to the semantics of the <tt class="calibre11">commute</tt> function. <tt class="calibre11">commute</tt> allows for more concurrency in the STM by devaluing in-transaction value disparity resulting from another transaction’s commit. In other words, <a href="#filepos853937"><span class="calibre8"><span class="underline">figure 11.6</span></span></a> shows that the in-transaction value of a Ref is initially set as when using <tt class="calibre11">alter</tt>, but the <span class="italic">commit time</span> value is reset just before <tt class="calibre11">commute</tt> commits. </p><p id="filepos853937" class="calibre5"><span class="calibre10"><span class="bold">Figure 11.6. Commute path: the in-transaction value 9 in the </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">num-moves</span></tt></span><span class="calibre10"><span class="bold"> Ref is retrieved in the body of the transaction and manipulated with the </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">commute</span></tt></span><span class="calibre10"><span class="bold"> function. But the </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">commute</span></tt></span><span class="calibre10"><span class="bold"> function </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">inc</span></tt></span><span class="calibre10"><span class="bold"> is again run at commit time with the current value 13 contained in the Ref. The result of this action serves as the committed value 14. </span></span></p><p class="calibre1"><img src="images/00013.jpg" class="calibre116"/></p><p class="calibre5">By retrieving the most current value for a Ref at the time of commit, the values committed might not be those corresponding to the in-transaction state. This leads to a condition of update reordering that your application <span class="italic">must</span> accommodate. Of course, this new function isn’t commutative because <tt class="calibre11">vector</tt> doesn’t give the same answer if its argument order is switched. </p><p class="calibre5">Using <tt class="calibre11">commute</tt> is useful as long as the following conditions aren’t problematic: </p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24">The value you see in-transaction may not be the value that gets committed at commit time.</li><li value="2" class="calibre24">The function you give to <tt class="calibre11">commute</tt> will be run at least twice—once to compute the in-transaction value, and again to compute the commit value. It might be run any number of times. </li></ul><p id="filepos855669" class="calibre5"><span class="bold">11.2.3. Vulgar change with ref-set </span><a></a></p><p class="calibre7">The function <tt class="calibre11">ref-set</tt> is different from <tt class="calibre11">alter</tt> and <tt class="calibre11">commute</tt> in that instead of changing a Ref based on a function of its value, it does so given a raw value: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(dosync (ref-set to-move '[[:K [2 1]] [:k [0 1]]]))<br class="calibre3"/>;=&gt; [[:K [2 1]] [:k [0 1]]]</tt></span></blockquote><p class="calibre12">In general, this sort of vulgar change should be avoided. But because the Refs have become out of sync, perhaps you could be forgiven in using <tt class="calibre11">ref-set</tt> to fix it—just this once. </p><p id="filepos856371" class="calibre5"><span class="bold">11.2.4. Fixing write-skew with ensure </span><a></a></p><p class="calibre7"><span class="italic">Snapshot isolation</span> means that within a transaction, all enclosed Ref states represent the <span class="italic">same</span> moment in time. Any Ref value that you see inside a transaction will <span class="italic">never</span> change unless <span class="italic">you</span> change it within that transaction. Your algorithms should be devised so that all you care about is that the values of the references haven’t changed before commit <a id="filepos856865"></a>(unless your change function is commutative, as mentioned previously). If those values have changed, then the transaction retries, and you try again. Earlier, we talked about write skew, a condition occurring when you make decisions based on the intransaction value of a Ref that’s never written to, which is also changed at the same time. Avoiding write skew is accomplished using Clojure’s <tt class="calibre11">ensure</tt> function, which guarantees a read-only Ref isn’t modified by another thread. The <tt class="calibre11">make-move</tt> function isn’t subject to write skew because it has no invariants on read data and in fact never reads a Ref that it doesn’t eventually write. This design is ideal because it allows other threads to calculate moves without having to stop them, while any given transaction does the same. But in your own applications, you may be confronted with a true read invariant scenario, and it’s in such a scenario that <tt class="calibre11">ensure</tt> will help. </p><p id="filepos857832" class="calibre5"><span class="bold">11.2.5. Refs under stress </span><a></a></p><p class="calibre7">After you’ve created your Refs and written your transactions, and simple isolated tests are passing, you may yet run into difficulties in larger integration tests because of how Refs behave under stress from multiple transactions. As a rule of thumb, it’s best to avoid having both short- and long-running transactions interacting with the same Ref. Clojure’s STM implementation will usually compensate eventually regardless, but you’ll soon see some less-than-ideal consequences of ignoring this rule. </p><p class="calibre5">To demonstrate this problem, <a href="#filepos859869"><span class="calibre8"><span class="underline">listing 11.2</span></span></a> shows a function designed specifically to over-stress a Ref. It does this by starting a long-running or slow transaction in another thread, where work is simulated by a 200ms sleep, but all it’s really doing is reading the Ref in a transaction. This requires the STM to know of a stable value for the Ref for the full 200ms. Meanwhile, the main thread runs quick transactions 500 times in a row, each one incrementing the value in the Ref and thereby frustrating the slow transaction’s attempts to see a stable value. The STM works to overcome this frustration by growing the history of values kept for the Ref. But by default this history is limited to 10 entries, and our perverse function can easily saturate that: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(stress-ref (ref 0))<br class="calibre3"/>;=&gt; :done<br class="calibre3"/>; r is: 500, history: 10, after: 26 tries</tt></span></blockquote><p class="calibre12">You may see a slightly different number of tries, but the important detail is that the slow transaction is unable to successfully commit and print the value of <tt class="calibre11">r</tt> until the main thread has finished its frantic looping and returned <tt class="calibre11">:done</tt>. The Ref’s history started at a default of 0 and grew to 10, but this was still insufficient. </p><p id="filepos859869" class="calibre5"><span class="calibre10"><span class="bold">Listing 11.2. How to make a Ref squirm </span></span><a></a></p><p class="calibre1"><img src="images/00087.jpg" class="calibre117"/></p><p id="filepos860093" class="calibre5">Remember that our real problem here is mixing short- and long-running transactions on the same Ref. But if this is truly unavoidable, Clojure allows us to create a Ref with a more generous cap on the history size: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(stress-ref (ref 0 :max-history 30))<br class="calibre3"/>; r is: 410, history: 20, after: 21 tries<br class="calibre3"/>;=&gt; :done</tt></span></blockquote><p class="calibre12">Again, your numbers may be different, but this time the Ref’s history grew sufficiently (reaching 20 in this run) to allow the slow transaction to finish first and report about <tt class="calibre11">r</tt> before all 500 quick transactions completed. In this run, only 410 had finished when the slow transaction committed. </p><p class="calibre5">But the slow transaction still had to be retried 20 times, with the history growing one step large each time, before it was able to complete. If our slow transaction were doing real work instead of just sleeping, this could represent a lot of wasted computing effort. If your tests or production environment reveal this type of situation and the underlying transaction size difference can’t be resolved, one final Ref option can help. Because you can see that the history will likely need to be 20 anyway, you may as well start it off closer to its goal: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(stress-ref (ref 0 :min-history 15 :max-history 30))<br class="calibre3"/>; r is: 97, history: 19, after: 5 tries<br class="calibre3"/>;=&gt; :done</tt></span></blockquote><p class="calibre12">This time the slow transaction finished before even 100 of the quick transactions had finished; and even though the history grew to roughly the same size, starting it off at 15 meant the slow transaction only retried 4 times before succeeding. </p><p class="calibre5">The use of Refs to guarantee coordinated change is generally simple for managing state in a synchronous fashion, and tuning with <tt class="calibre11">:min-history</tt> and <tt class="calibre11">:max-history</tt> is rarely required. But not all changes in your applications will require coordination, nor will they need to be synchronous. For these circumstances, Clojure also provides another reference type, the Agent, that provides independent asynchronous changes, which we’ll discuss next. </p><p id="filepos862456" class="calibre5"><span class="calibre18"><span class="bold">11.3. When to use Agents </span></span></p><p class="calibre7">Like all Clojure reference types, an Agent represents an <span class="italic">identity</span>, a specific thing whose value can change over time. Each Agent has a queue to hold actions that need to be performed on its value, and each action will produce a new value for the Agent to hold and pass to the subsequent action. Thus the state of the Agent advances through time, action after action, and by their nature only one action at a time can be operating on a given Agent. Of course, other actions can be operating on other Agents at the same time, each in its own thread. </p><p id="filepos863130" class="calibre5">You can queue an action on any Agent by using <tt class="calibre11">send</tt> or <tt class="calibre11">send-off</tt>, the minor difference between which we’ll discuss later. Agents are integrated with STM transactions, and within a transaction any actions sent are held until the transaction commits or are thrown away if the transaction retries. Thus <tt class="calibre11">send</tt> and <tt class="calibre11">send-off</tt> are <span class="italic">not</span> considered side-effects in the context of a <tt class="calibre11">dosync</tt>, because they handle retries correctly and gracefully. </p><p id="filepos863646" class="calibre5"><span class="bold">11.3.1. In-process versus distributed concurrency models </span><a></a></p><p class="calibre7">Both Clojure and Erlang are designed (<a href="#filepos1068638"><span class="calibre8"><span class="underline">Armstrong 2007</span></span></a>) specifically with concurrent programming in mind, and Erlang’s process<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos864283"><span class="calibre33"><span class="calibre8"><span class="underline">2</span></span></span></a><span class="calibre33">]</span></small></sup> model is similar in some ways to Clojure Agents, so it’s fair to briefly compare how they each approach the problem. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos864283" class="calibre32"><span class="calibre33">2</span></small></sup><span class="calibre10"> It’s interesting that popular opinion has tagged Erlang processes with the “actor” tag although the language implementers rarely, if ever, use that term. Therefore, because the Erlang elite choose not to use that term, we’ll avoid doing so also... almost. </span></blockquote><p class="calibre12">Erlang takes a distributed, share-nothing (Armstrong 2007b) approach; Clojure instead promotes shared, immutable data. The key to Clojure’s success is the fact that its composite data structures are immutable, because immutable structures can be freely shared among disparate threads. Erlang’s composite data structures are also immutable, but because the communication model is distributed, the underlying theme is always one of dislocation. The implications of this are that all knowledge of the world under consideration is provided via messages. But with Clojure’s in-process model, data structures are always accessible directly, as illustrated in <a href="#filepos865644"><span class="calibre8"><span class="underline">figure 11.7</span></span></a>, whereas Erlang makes copies of the data sent back and forth between processes. This works well for Erlang and allows it to provide its fault recovery guarantees, but many application domains can benefit from the shared-memory model provided by Clojure. </p><p id="filepos865644" class="calibre5"><span class="calibre10"><span class="bold">Figure 11.7. Clojure agents versus Erlang processes: each Agent and process starts with the value 1. Both receive an </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">inc</span></tt></span><span class="calibre10"><span class="bold"> request simultaneously but can only process one at a time, so more are queued. Requests to the process are queued until a response can be delivered, whereas any number of simultaneous derefs can be done on an Agent. Despite what this illustration may suggest, an Agent is not just an actor with a hat on. </span></span></p><p class="calibre1"><img src="images/00014.jpg" class="calibre118"/></p><p class="calibre5">The second difference is that Erlang messages block on reception, opening up the possibility for deadlock. On the other hand, when interacting with Clojure Agents, both sends and derefs proceed immediately and never block or wait on the Agent. <a id="filepos866594"></a>Clojure does have an <tt class="calibre11">await</tt> function that can be used to block a thread until a particular Agent has processed a message, but this function is specifically disallowed in Agent threads (and also STM transactions) in order to prevent accidentally creating this sort of deadlock. </p><p class="calibre5">The final difference lies in the fact that Agents allow for arbitrary update functions whereas Erlang processes are bound to static pattern-matched message handling routines. In other words, pattern matching couples the data and update logic, whereas the former decouples them. Erlang is an excellent language for solving the extremely difficult problem of distributed computation, but Clojure’s concurrency mechanisms service the in-process programming model more flexibly than Erlang allows (<a href="#filepos1084884"><span class="calibre8"><span class="underline">Clementson 2008</span></span></a>). </p><p id="filepos867495" class="calibre5"><span class="bold">11.3.2. Controlling I/O with an Agent </span><a></a></p><p class="calibre7">One handy use for Agents is to serialize access to a resource, such as an file or other I/O stream. For example, imagine we want to provide a way for multiple threads to report their progress on various tasks, giving each report a unique incrementing number. </p><p class="calibre5">Because the state we want to hold is known, we can go ahead and create the Agent:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def log-agent (agent 0))</tt></span></blockquote><p class="calibre12">Now we’ll supply an action function to send to <tt class="calibre11">log-agent</tt>. All action functions take as their first argument the current state of the Agent and can take any number of other arguments that are sent: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn do-log [msg-id message]<br class="calibre3"/>  (println msg-id ":" message)<br class="calibre3"/>  (inc msg-id))</tt></span></blockquote><p class="calibre12">Here <tt class="calibre11">msg-id</tt> is the state—the first time <tt class="calibre11">do-log</tt> is sent to the Agent, <tt class="calibre11">msg-id</tt> will be <tt class="calibre11">0</tt>. The return value of the action function will be the new Agent state, incrementing it to <tt class="calibre11">1</tt> after that first action. </p><p class="calibre5">Now we need to do some work worth logging about, but for this example we’ll just pretend:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn do-step [channel message]<br class="calibre3"/>  (Thread/sleep 1)<br class="calibre3"/>  (send-off log-agent do-log (str channel message)))<br class="calibre3"/><br class="calibre3"/>(defn three-step [channel]<br class="calibre3"/>  (do-step channel " ready to begin (step 0)")<br class="calibre3"/>  (do-step channel " warming up (step 1)")<br class="calibre3"/>  (do-step channel " really getting going now (step 2)")<br class="calibre3"/>  (do-step channel " done! (step 3)"))</tt></span></blockquote><p class="calibre12">To see how <tt class="calibre11">log-agent</tt> will correctly queue and serialize the messages, we need to start a few threads, each yammering away at the Agent, shown next: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn all-together-now []<br class="calibre3"/>  (dothreads! #(three-step "alpha"))<br class="calibre3"/>  (dothreads! #(three-step "beta"))<br class="calibre3"/>  (dothreads! #(three-step "omega")))<br class="calibre3"/>(all-together-now)<br class="calibre3"/>; 0 : alpha ready to being (step 0)<br class="calibre3"/>; 1 : omega ready to being (step 0)<br class="calibre3"/>; 2 : beta ready to being (step 0)<br class="calibre3"/>; 3 : alpha warming up (step 1)<br class="calibre3"/>; 4 : alpha really getting going now (step 2)<br class="calibre3"/>; 5 : omega warming up (step 1)<br class="calibre3"/>; 6 : alpha done! (step 3)<br class="calibre3"/>; 7 : omega really getting going now (step 2)<br class="calibre3"/>; 8 : omega done! (step 3)<br class="calibre3"/>; 9 : beta warming up (step 1)<br class="calibre3"/>; 10 : beta really getting going now (step 2)<br class="calibre3"/>; 11 : beta done! (step 3)</tt></span></blockquote><p id="filepos870513" class="calibre12">Your output is likely to look different, but one thing that should be exactly the same is the stable, incrementing IDs assigned by the Agent, even while the alpha, beta, and omega threads fight for control. </p><p class="calibre5">There are several other possible approaches to solving this problem, and it can be constructive to contrast them. The simplest alternative would be to hold a lock while printing and incrementing. Besides the general risk of deadlocks when a complex program has multiple locks, there are some specific drawbacks even if this would be the only lock in play. For one, each client thread would block anytime there was contention for the lock, and unless some fairness mechanism were used, there’d be at least a slight possibility of one or more threads being “starved” and never having an opportunity to print or proceed with their work. Because Agent actions are queued and don’t block waiting for their action to be processed, neither of these is a concern. </p><p class="calibre5">Another option would be to use a blocking queue to hold pending log messages. Client threads would be able to add messages to the queue without blocking and with adequate fairness. But you’d generally need to dedicate a thread to popping messages from the queue and printing them, or write code to handle starting and stopping the printing thread as needed. Why write such code when Agents do this for you already? When no actions are queued, the Agent in our example has no thread assigned to it.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos872276"><span class="calibre33"><span class="calibre8"><span class="underline">3</span></span></span></a><span class="calibre33">]</span></small></sup></p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos872276" class="calibre32"><span class="calibre33">3</span></small></sup><span class="calibre10"> Using Agents for logging might not be appropriate in all cases. For example, in probing scenarios, the number of log events could be extremely high. Coupling this volume with serialization could make the Agent unable to catch its ever-growing queue. </span></blockquote><p class="calibre12">Agents have other features that may or may not be useful in any given situation. One is that the current state of an Agent can be observed cheaply. In the previous example, this would allow us to discover the ID of the next message to be written out, as follows: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">@log-agent<br class="calibre3"/>;=&gt; 11</tt></span></blockquote><p class="calibre12">Here the Agent is idle—no actions are queued or running, but the same expression would work equally well if the Agent were running. </p><p class="calibre5">Other features include the <tt class="calibre11">await</tt> and <tt class="calibre11">await-for</tt> functions, which allow a sending thread to block until all the actions it’s sent to a given set of Agents have completed. <a id="filepos873396"></a>This could be useful in this logging example if we wanted to be sure a particular message had been written out before proceeding: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(do-step "important: " "this must go out")<br class="calibre3"/>(await log-agent)</tt></span></blockquote><p class="calibre12">The <tt class="calibre11">await-for</tt> function is similar but allows you to specify a number of milliseconds after which to time out, even if the queued actions still haven’t completed. </p><p class="calibre5">A final feature Agents provide is that the set of actions you can send to an Agent is <span class="italic">open</span>. You can tell an Agent to do something that wasn’t even conceived of at the time the Agent was designed. For example, we could tell the Agent to skip ahead several IDs, and this action would be queued up along with all the <tt class="calibre11">log-message</tt> actions and executed by the Agent when its turn came: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(send log-agent (fn [_] 1000))<br class="calibre3"/><br class="calibre3"/>(do-step "epsilon " "near miss")<br class="calibre3"/>; 1000 : epsilon near miss</tt></span></blockquote><p class="calibre12">This is another area in which Clojure allows you to extend your design on the fly instead of requiring recompiling or even restarting your app. If you’re paying attention, you might wonder why we used <tt class="calibre11">send</tt> in that last example rather than <tt class="calibre11">send-off</tt>. </p><p id="filepos874840" class="calibre5"><span class="bold">11.3.3. The difference between send and send-off </span><a></a></p><p class="calibre7">You can use either <tt class="calibre11">send</tt> or <tt class="calibre11">send-off</tt> with any Agent. When you use <tt class="calibre11">send-off</tt> as we did in most of the examples so far, only a single action queue is involved: the one managed by the individual Agent. Anytime the Agent has a <tt class="calibre11">send-off</tt> action queued, it has a thread assigned to it, working through the queue. With <tt class="calibre11">send</tt>, there’s a second queue—actions still go into the Agent’s queue, but then the Agent itself queues up waiting for a thread from a fixed-sized pool of threads. The size of this fixed pool is based on the number of processors the JVM is running on, so it’s a bad idea to use <tt class="calibre11">send</tt> with any actions that might block, tying up one of these limited number of threads. These differences are illustrated in <a href="#filepos875814"><span class="calibre8"><span class="underline">figure 11.8</span></span></a>. </p><p id="filepos875814" class="calibre5"><span class="calibre10"><span class="bold">Figure 11.8. Agents using </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">send</span></tt></span><span class="calibre10"><span class="bold"> versus </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">send-off</span></tt></span><span class="calibre10"><span class="bold">. When an Agent is idle, no CPU resources are being consumed. Each action is sent to an Agent using either </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">send</span></tt></span><span class="calibre10"><span class="bold"> or </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">send-off</span></tt></span><span class="calibre10"><span class="bold">, which determines which thread pool will be used to dequeue and apply the action. Because actions queued with </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">send</span></tt></span><span class="calibre10"><span class="bold"> are applied by a limited thread pool, the Agents queue up for access to these threads, a constraint that doesn’t apply to actions queued with </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">send-off</span></tt></span><span class="calibre10"><span class="bold">. </span></span></p><p class="calibre1"><img src="images/00016.jpg" class="calibre119"/></p><p id="filepos876840" class="calibre5">We can make this scenario play out if we make a gaggle of Agents and send them actions that sleep for a moment. Here’s a little function that does this, using whichever send function we specify, and then waits for all the actions to complete: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn exercise-agents [send-fn]<br class="calibre3"/>  (let [agents (map #(agent %) (range 10))]<br class="calibre3"/>    (doseq [a agents]<br class="calibre3"/>      (send-fn a (fn [_] (Thread/sleep 1000))))<br class="calibre3"/>    (doseq [a agents]<br class="calibre3"/>      (await a))))</tt></span></blockquote><p class="calibre12">If we use <tt class="calibre11">send-off</tt>, all the agents will begin their one-second wait more or less simultaneously, each in its own thread. So the entire sequence of them will complete in slightly over one second: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(time (exercise-agents send-off))<br class="calibre3"/>; "Elapsed time: 1008.771296 msecs"</tt></span></blockquote><p class="calibre12">Now we can demonstrate why it’s a bad idea to mix <tt class="calibre11">send</tt> with actions that block: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(time (exercise-agents send))<br class="calibre3"/>; "Elapsed time: 3001.555086 msecs"</tt></span></blockquote><p class="calibre12">The exact elapsed time you’ll see will depend on the number of processors you have, but if you have fewer than eight you’ll see this example takes at least two seconds to complete. The threads in the fixed-size pool are all clogged up waiting for <tt class="calibre11">sleep</tt> to finish, so the other Agents queue up waiting for a free thread. Because clearly the computer could complete all 10 actions in about one second using <tt class="calibre11">send-off</tt>, using <tt class="calibre11">send</tt> is a bad idea. </p><p class="calibre5">So that’s it: <tt class="calibre11">send</tt> is for actions that stay busy using the processor and not blocking on I/O or other threads, whereas <tt class="calibre11">send-off</tt> is for actions that might block, sleep, or otherwise tie up the thread. This is why we used <tt class="calibre11">send-off</tt> for the threads that printed log lines and <tt class="calibre11">send</tt> for the one that did no I/O at all. </p><p id="filepos879037" class="calibre5"><span class="bold">11.3.4. Error handling </span><a></a></p><p class="calibre7">We’ve been fortunate so far—none of these Agent actions have thrown an exception. But real life is rarely so kind. Most of the other reference types are synchronous and so exceptions thrown while updating their state bubble up the call stack in a normal way, to be caught with a regular <tt class="calibre11">try/catch</tt> in your application (or not). Because Agent actions run in other threads after the sending thread has moved on, we need a different mechanism for handling exceptions that are thrown by Agent actions. As of Clojure 1.2, you can choose between two different error-handling modes for each Agent: <tt class="calibre11">:continue</tt> and <tt class="calibre11">:fail</tt>. </p><p class="calibre5"><span class="calibre10"><span class="bold">:Fail </span></span></p><p class="calibre7">By default, new Agents start out using the <tt class="calibre11">:fail</tt> mode, where an exception thrown by an Agent’s action will be captured by the Agent and held so that you can see it later. Meanwhile, the Agent will be considered <span class="italic">failed</span> or <span class="italic">stopped</span> and will stop processing its <a id="filepos880160"></a>action queue—all the queued actions will have to wait patiently until someone clears up the Agent’s error. </p><p class="calibre5">One common mistake when dealing with Agents is to forget that your action function <span class="italic">must</span> take at least one argument for the Agent’s current state. For example, we might try to reset the log-agent’s current message ID like this: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(send log-agent (fn [] 2000))   ; incorrect<br class="calibre3"/><br class="calibre3"/>@log-agent<br class="calibre3"/>;=&gt; 1001</tt></span></blockquote><p class="calibre12">At first glance it looks like the action we sent had no effect, or perhaps hasn’t been applied yet. But we’d wait in vain for that Agent to do anything ever again without intervention, because it’s <span class="italic">stopped</span>. One way to determine this is with the <tt class="calibre11">agent-error</tt> function: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(agent-error log-agent)<br class="calibre3"/>;=&gt; #&lt;IllegalArgumentException java.lang.IllegalArgumentException:<br class="calibre3"/>;      Wrong number of args passed to: user$eval--509$fn&gt;</tt></span></blockquote><p class="calibre12">This returns the error of a stopped Agent, or <tt class="calibre11">nil</tt> if it’s still running fine. Another way to see whether an Agent is stopped is to try to send another action to it: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(send log-agent (fn [_] 3000))<br class="calibre3"/>; java.lang.RuntimeException: Agent is failed, needs restart</tt></span></blockquote><p class="calibre12">Even though this action would’ve worked fine, the Agent has failed and so no further sends are allowed. The state of <tt class="calibre11">log-agent</tt> remains unchanged: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">@log-agent<br class="calibre3"/>;=&gt; 1001</tt></span></blockquote><p class="calibre12">In order to get the Agent back into working order, we need to restart it:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(restart-agent log-agent 2500 :clear-actions true)<br class="calibre3"/>;=&gt; 2500</tt></span></blockquote><p class="calibre12">This resets the value of <tt class="calibre11">log-agent</tt> to 2500 and deletes all those actions patiently waiting in their queue. If we hadn’t included the <tt class="calibre11">:clear-actionstrue</tt> option, those actions would’ve survived and the Agent would continue processing them. Either way, the Agent is now in good working order again, and so we can again <tt class="calibre11">send</tt> and <tt class="calibre11">send-off</tt> to it: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(send-off log-agent do-log "The agent, it lives!")<br class="calibre3"/>; 2500 : The agent, it lives!<br class="calibre3"/>;=&gt; #&lt;Agent@72898540: 2500&gt;</tt></span></blockquote><p class="calibre12">Note that <tt class="calibre11">restart-agent</tt> only makes sense and thus is only allowed when the Agent has failed. If it hasn’t failed, any attempt to restart it throws an exception in the thread making the attempt, and the Agent is left undisturbed: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(restart-agent log-agent 2500 :clear-actions true)<br class="calibre3"/>;=&gt; java.lang.RuntimeException: Agent does not need a restart</tt></span></blockquote><p id="filepos883417" class="calibre12">This mode is perhaps most appropriate for manual intervention. Agents that normally don’t have errors but in a running system end up failing can use the <tt class="calibre11">:fail</tt> mode to keep from doing anything too bad until a human can take things in hand, check to see what happened, choose an appropriate new state for the Agent, and restart it just as we did here. </p><p class="calibre5"><span class="calibre10"><span class="bold">:Continue </span></span></p><p class="calibre7">The other error mode that Agents currently support is <tt class="calibre11">:continue</tt>, where any action that throws an exception is skipped and the Agent proceeds to the next queued action if any. This is most useful when combined with an error handler—if you specify an <tt class="calibre11">:error-handler</tt> when you create an Agent, that Agent’s error mode defaults to <tt class="calibre11">:continue</tt>. The Agent calls the error handler when an action throws an exception and doesn’t proceed to the next action until the handler returns. This gives the handler a chance to report the error in some appropriate way. For example, we could have <tt class="calibre11">log-agent</tt> handle faulty actions by logging the attempt: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn handle-log-error [the-agent the-err]<br class="calibre3"/>  (println "An action sent to the log-agent threw " the-err))<br class="calibre3"/><br class="calibre3"/>(set-error-handler! log-agent handle-log-error)<br class="calibre3"/><br class="calibre3"/>(set-error-mode! log-agent :continue)</tt></span></blockquote><p class="calibre12">With the error mode and handler set up, sending faulty actions does cause reports to be printed as we wanted:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(send log-agent (fn [x] (/ x 0)))   ; incorrect<br class="calibre3"/>; An action sent to the log-<br class="calibre3"/>     agent threw java.lang.ArithmeticException: Divide by zero<br class="calibre3"/>;=&gt; #&lt;Agent@66200db9: 2501&gt;<br class="calibre3"/><br class="calibre3"/>(send log-agent (fn [] 0))           ; also incorrect<br class="calibre3"/>; An action sent to the log-agent threw java.lang.IllegalArgumentException:<br class="calibre3"/>;   Wrong number of args passed to: user$eval--820$fn<br class="calibre3"/>;=&gt; #&lt;Agent@66200db9: 2501&gt;</tt></span></blockquote><p class="calibre12">And the Agent stays in good shape, always ready for new actions to be sent:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(send-off log-agent do-log "Stayin' alive, stayin' alive...")<br class="calibre3"/>; 2501 : Stayin' alive, stayin' alive...</tt></span></blockquote><p class="calibre12">Note that error handlers can’t change the state of the Agent (ours keeps its current message id of 2501 throughout the preceding tests). Error handlers are also supported in the <tt class="calibre11">:fail</tt> error mode, but handlers can’t call <tt class="calibre11">restart-agent</tt> so they’re less often useful for <tt class="calibre11">:fail</tt> than they are for the <tt class="calibre11">:continue</tt> error mode. </p><p id="filepos886372" class="calibre5"><span class="bold">11.3.5. When not to use Agents </span><a></a></p><p class="calibre7">It can be tempting to repurpose Agents for any situation requiring the spawning of new threads. Their succinct syntax and “Clojurey” feel often make this temptation strong. But though Agents perform beautifully when each one is representing a real identity in your application, they start to show weaknesses when used a sort of “green thread” abstraction. In cases where you just need a bunch of worker threads banging <a id="filepos886905"></a>away on some work, or you have a specific long-running thread polling or blocking on events, or any other kind of situation where it doesn’t seem useful that the Agent maintain a value, you’ll usually be able to find a better mechanism than Agents. In these cases, there’s every reason to consider using a Java <tt class="calibre11">Thread</tt> directly, or a Java executor (as we did with <tt class="calibre11">dothreads!</tt>) to manage a pool of threads, or in some cases perhaps a Clojure future. </p><p class="calibre5">Another common temptation is to use Agents when you need state held but you don’t actually want the sending thread to proceed until the Agent action you sent is complete. This can be done by using <tt class="calibre11">await</tt>, but it’s another form of abuse that should be avoided. For one, because you’re not allowed to use <tt class="calibre11">await</tt> in an Agent’s action, as you try to use this technique in more and more contexts you’re likely to run into a situation where it won’t work. But in general, there’s probably a reference type that will do a better job of behaving the way you want. Because this is essentially an attempt to use Agents as if they were synchronous, you may have more success with one of the other shared synchronous types. In particular, Atoms are shared and uncoordinated just like Agents, but they’re synchronous and so may fit better. </p><p id="filepos888278" class="calibre5"><span class="calibre18"><span class="bold">11.4. When to use Atoms </span></span></p><p class="calibre7">Atoms are like Refs in that they’re synchronous but are like Agents in that they’re independent (uncoordinated). An Atom may seem at first glance similar to a variable, but as we proceed you’ll see that any similarities are at best superficial. The use cases for Atoms are similar to those of <span class="italic">compare-and-swap</span> (CAS) spinning operations. Anywhere you might want to atomically compute a value given an existing value and swap in the new value, an Atom will suffice. Atom updates occur locally to the calling thread, and execution continues after the Atom value has been changed. If another thread <tt class="calibre11">B</tt> changes the value in an Atom before thread <tt class="calibre11">A</tt> is successful, then <tt class="calibre11">A</tt> retries. But these retries are spin-loop and don’t occur within the STM, and thus Atom changes can’t be coordinated with changes to other reference types. You should take care when embedding changes to Atoms within Clojure’s transactions because as you know, transactions can potentially be retried numerous times. Once an Atom’s value is set, it’s set, and it doesn’t roll back when a transaction is retried, so in effect this should be viewed as a side effect. Therefore, use Atoms in transactions only when you’re certain that an attempt to update its value, performed numerous times, is idempotent. </p><p class="calibre5">Aside from the normal use of <tt class="calibre11">@</tt> and <tt class="calibre11">deref</tt> to query an Atom’s value, you can also use the mutating functions <tt class="calibre11">swap!, compare-and-set!</tt>, and <tt class="calibre11">reset!</tt>. </p><p id="filepos889931" class="calibre5"><span class="bold">11.4.1. Sharing across threads </span><a></a></p><p class="calibre7">As we mentioned, Atoms are thread safe and can be used when you require a lightweight mutable reference to be shared across threads. A simple case is one of a globally accessible incrementing timer created using the <tt class="calibre11">atom</tt> function: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def *time* (atom 0))<br class="calibre3"/>(defn tick [] (swap! *time* inc))<br class="calibre3"/>(dothreads! tick :threads 1000 :times 100)<br class="calibre3"/>@*time*<br class="calibre3"/>;=&gt; 100000</tt></span></blockquote><p id="filepos890528" class="calibre12">Though this will work, Java already provides a concurrent class for just such a purpose, <tt class="calibre11">java.util.concurrent.atomic.AtomicInteger</tt>, which can be used similarly: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def *time* (java.util.concurrent.atomic.AtomicInteger. 0))<br class="calibre3"/>(defn tick [] (.getAndIncrement *time*))<br class="calibre3"/>(dothreads! tick :threads 1000 :times 100)<br class="calibre3"/>*time*<br class="calibre3"/>;=&gt; 100000</tt></span></blockquote><p class="calibre12">Though the use of <tt class="calibre11">AtomicInteger</tt> is more appropriate in this case, the use of an Atom works to show that it’s safe to use across threads. </p><p id="filepos891202" class="calibre5"><span class="bold">11.4.2. Using Atoms in transactions </span><a></a></p><p class="calibre7">Just because we said that Atoms should be used carefully within transactions, that’s not to say that they can never be used in that way. In fact, the use of an Atom as the reference holding a function’s memoization cache is idempotent on update. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre28"><span class="calibre10"><span class="bold">Memoization</span></span></p><p class="calibre5"><span class="italic">Memoization</span> is a way for a function to store calculated values in a cache so that multiple calls to the function can retrieve previously calculated results from the cache, instead of performing potentially expensive calculations every time. Clojure provides a core function <tt class="calibre11">memoize</tt> that can be used on any referentially transparent function. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">Individual requirements from memoization are highly personal, and a generic approach isn’t always the appropriate solution for every problem. We’ll discuss personalized memoization strategies in <a href="#filepos975700"><span class="calibre8"><span class="underline">section 12.4</span></span></a>, but for now we’ll use an illustrative example appropriate for Atom usage. </p><p class="calibre5"><span class="calibre10"><span class="bold">Atomic Memoization </span></span></p><p class="calibre7">The core <tt class="calibre11">memoize</tt> function is great for creating simple function caches, but it has some limitations. First, it doesn’t allow for custom caching and expiration strategies. Additionally, <tt class="calibre11">memoize</tt> doesn’t allow you to manipulate the cache for the purposes of clearing it in part or wholesale. Therefore, we’ll create a function <tt class="calibre11">manipulable-memoize</tt> that allows us to get at the cache and perform operations on it directly. Throughout the book, we’ve mentioned Clojure’s metadata facility, and for this example it will come in handy. We can take in the function to be memoized and attach some metadata<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos893638"><span class="calibre33"><span class="calibre8"><span class="underline">4</span></span></span></a><span class="calibre33">]</span></small></sup> with an Atom containing the cache itself for later manipulation. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos893638" class="calibre32"><span class="calibre33">4</span></small></sup><span class="calibre10"> The ability to attach metadata to functions is a recent addition to Clojure version 1.2. </span></blockquote><p id="filepos893807" class="calibre12"><span class="calibre10"><span class="bold">Listing 11.3. A resettable </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">memoize</span></tt></span><span class="calibre10"><span class="bold"> function </span></span></p><p class="calibre1"><img src="images/00028.jpg" class="calibre120"/></p><p id="filepos894104" class="calibre5">As shown in <a href="#filepos893807"><span class="calibre8"><span class="underline">listing 11.3</span></span></a>, we’ve slightly modified the core <tt class="calibre11">memoize</tt> function to attach the Atom to the function being memoized. You can now observe <tt class="calibre11">manipulable-memoize</tt> in action: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def slowly (fn [x] (Thread/sleep 3000) x))<br class="calibre3"/>(time [(slowly 9) (slowly 9)])<br class="calibre3"/>; "Elapsed time: 6000.63 msecs"<br class="calibre3"/>;=&gt; [9 9]<br class="calibre3"/><br class="calibre3"/>(def sometimes-slowly (manipulable-memoize slowly))<br class="calibre3"/>(time [(sometimes-slowly 108) (sometimes-slowly 108)])<br class="calibre3"/>; "Elapsed time: 3000.409 msecs"<br class="calibre3"/>;=&gt; [108 108]</tt></span></blockquote><p class="calibre12">The call to <tt class="calibre11">slowly</tt> is always... well... slow, as you’d expect. But the call to <tt class="calibre11">sometimes-slowly</tt> is only slow on the first call given a certain argument. This too is just as you’d expect. Now we can inspect <tt class="calibre11">sometimes-slowly</tt>’s cache and perform some operations on it: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(meta sometimes-slowly)<br class="calibre3"/>;=&gt; {:cache #&lt;Atom@e4245: {(108) 108}&gt;}<br class="calibre3"/><br class="calibre3"/>(let [cache (:cache (meta sometimes-slowly))]<br class="calibre3"/>  (swap! cache dissoc '(108)))<br class="calibre3"/>;=&gt; {}</tt></span></blockquote><p class="calibre12">You may wonder why we used <tt class="calibre11">swap!</tt> to <tt class="calibre11">dissoc</tt> the cached argument <tt class="calibre11">108</tt> instead of using <tt class="calibre11">(reset! cache {})</tt>. There are certainly valid use cases for the wholesale reset of an Atom’s value, and this case is arguably one. But it’s good practice to set your reference values via the application of a function rather than the in-place value setting. In this way, you can be more selective about the value manipulations being performed. Having said that, here are the consequences our actions had: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(meta sometimes-slowly)<br class="calibre3"/>;=&gt; {:cache #&lt;Atom@e4245: {}&gt;}<br class="calibre3"/><br class="calibre3"/>(time (sometimes-slowly 108))<br class="calibre3"/>; "Elapsed time: 3000.3 msecs"<br class="calibre3"/>;=&gt; 108</tt></span></blockquote><p class="calibre12">And yes, you can see that we were able to remove the cached argument value <tt class="calibre11">108</tt> using the metadata map attached to the function <tt class="calibre11">sometimes-slowly</tt>. There are better ways to allow for pointed cache removal than this, but for now you can take heart in that using an Atom, we’ve allowed for the local mutation of a reference in a thread-safe way. Additionally, because of the nature of memoization, you can use these memoized functions in a transaction without ill effect. Bear in mind that if you do use this in a transaction, then any attempt to remove values from the cache may not be <a id="filepos896931"></a>met with the results expected. Depending on the interleaving of your removal and any restarts, the value(s) you remove might be reinserted on the next time through the restart. But even this condition is agreeable if your only concern is reducing total cache size. </p><p id="filepos897207" class="calibre5"><span class="calibre18"><span class="bold">11.5. When to use locks </span></span></p><p class="calibre7">Clojure’s reference types and parallel primitives cover a vast array of use cases. Additionally, Java’s rich set of concurrency classes found in the <tt class="calibre11">java.util.concurrent</tt> package are readily available. But even with this arsenal of tools at your disposal, there still may be circumstances where explicit locking is the only option available, the common case being the modification of arrays concurrently. We’ll start with a simple protocol to describe a concurrent, mutable, <span class="italic">safe array</span> that holds an internal array instance, allowing you to access it or mutate it safely. A naive implementation can be seen in the following listing. </p><p id="filepos897979" class="calibre5"><span class="calibre10"><span class="bold">Listing 11.4. A simple </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">SafeArray</span></tt></span><span class="calibre10"><span class="bold"> protocol </span></span></p><p class="calibre1"><img src="images/00038.jpg" class="calibre121"/></p><p class="calibre5">If you’ll notice, we used the <tt class="calibre11">:refer-clojure</tt> namespace directive to <tt class="calibre11">:exclude</tt> the array and sequence functions that the <tt class="calibre11">SafeArray</tt> protocol overrides. We did this not only because it’s important to know how to use <tt class="calibre11">:refer-clojure</tt>, but also because we’re changing the semantics of <tt class="calibre11">aset</tt> to take a mutating function as its last argument instead of a raw value. We then used the <tt class="calibre11">:require</tt> directive to alias the Clojure namespace as <tt class="calibre11">clj</tt>, thus avoiding the need to use the fully qualified function names a la <tt class="calibre11">clojure.core/aget</tt>. </p><p class="calibre5">The dumb array created by <tt class="calibre11">make-dumb-array</tt> is stored in a closure created by <tt class="calibre11">reify</tt>, and unguarded access is provided without concern for concurrent matters. Using this implementation across threads is disastrous, as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn pummel [a]<br class="calibre3"/>  (dothreads! #(dotimes [i (count a)] (aset a i inc)) :threads 100))<br class="calibre3"/>(def D (make-dumb-array Integer/TYPE 8))<br class="calibre3"/>(pummel D)<br class="calibre3"/><br class="calibre3"/>;; wait for pummel to terminate<br class="calibre3"/><br class="calibre3"/>(seq D)<br class="calibre3"/>;=&gt; (82 84 65 63 83 65 83 87)</tt></span></blockquote><p id="filepos899564" class="calibre12">This is very wrong—100 threads incrementing concurrently should result in <tt class="calibre11">100</tt> for each array slot. To add insult to injury, Clojure didn’t throw a <tt class="calibre11">Concurrent-ModificationException</tt> as you might’ve expected, but instead just silently went along doing very bad things. Next, we’ll talk a little about locking and provide an alternate implementation for <tt class="calibre11">SafeArray</tt> using locking primitives. </p><p id="filepos900018" class="calibre5"><span class="bold">11.5.1. Safe mutation through locking </span><a></a></p><p class="calibre7">Currently, the only<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos900465"><span class="calibre33"><span class="calibre8"><span class="underline">5</span></span></span></a><span class="calibre33">]</span></small></sup> way to safely modify and see consistent values for a mutable object across threads in Clojure is through locking. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos900465" class="calibre32"><span class="calibre33">5</span></small></sup><span class="calibre10"> Although a potential future addition to Clojure named </span><span class="calibre10"><span class="italic">pods</span></span><span class="calibre10"> may provide another. </span></blockquote><p class="calibre12"><span class="calibre10"><span class="bold">References Around Evil Mutable Things </span></span></p><p class="calibre7">Wrapping a mutable object in a Clojure reference type provides <span class="italic">absolutely no guarantees for safe concurrent modification</span>. Doing this will at best explode immediately or, worse, provide inaccurate results. </p><p class="calibre5">If at all possible, locking should be avoided; but for those times when it’s unavoidable, the <tt class="calibre11">locking</tt> macro will help. The <tt class="calibre11">locking</tt> macro takes a single parameter acting as the locking monitor and a body that executes in the monitor context. Any writes and reads to the monitor object are thread safe, and as a bonus the monitor is <span class="italic">always</span> released at the end of the block. One of the major complexities in concurrent programming using locks is that all errors must be handled fully and appropriately; otherwise you risk orphaned locks, and they spell deadlock. But the <tt class="calibre11">locking</tt> macro will always release the lock, even in the face of exceptions. </p><p id="filepos901733" class="calibre5"><span class="calibre10"><span class="bold">Listing 11.5. An implementation of the </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">SafeArray</span></tt></span><span class="calibre10"><span class="bold"> protocol using the </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">locking</span></tt></span><span class="calibre10"><span class="bold"> macro </span></span></p><p class="calibre1"><img src="images/00047.jpg" class="calibre122"/></p><p id="filepos902134" class="calibre5">We used the <tt class="calibre11">locking</tt> macro on both the <tt class="calibre11">aget</tt> and <tt class="calibre11">aset</tt> functions so that they can both maintain consistency concurrently. Because <tt class="calibre11">aset</tt> calls <tt class="calibre11">aget</tt>, the <tt class="calibre11">locking</tt> macro is called twice. This isn’t a problem because <tt class="calibre11">locking</tt> is <span class="italic">reentrant</span>, or able to be called multiple times in the same thread. Typically, you’d have to manage the releasing of reentrant locking mechanism to match the number of times called, but fortunately <tt class="calibre11">locking</tt> manages that for us. </p><p class="calibre5">The <tt class="calibre11">locking</tt> macro is the simplest way to perform primitive locking in Clojure. But the implementation of <tt class="calibre11">make-safe-array</tt> is coarse in that the locks used are guarding the entire array. Any readers or writers wishing to access or update any slot in the array <span class="italic">must</span> wait their turn, a bottleneck known as <span class="italic">contention</span>. If you need finer-grained locking, the locking facilities provided by Java will help to gain more control, a topic we cover next. </p><p id="filepos903202" class="calibre5"><span class="bold">11.5.2. Using Java’s explicit locks </span><a></a></p><p class="calibre7">Java provides a set of explicit locks in the <tt class="calibre11">java.util.concurrent.locks</tt> package that can also be used as shown in the following listing. One such lock is provided by the <tt class="calibre11">java.util.concurrent.locks.ReentrantLock</tt> class. </p><p id="filepos903555" class="calibre5"><span class="calibre10"><span class="bold">Listing 11.6. An implementation of the </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">SafeArray</span></tt></span><span class="calibre10"><span class="bold"> protocol using </span></span><span class="calibre10"><tt class="calibre11"><span class="bold">ReentrantLock</span></tt></span></p><p class="calibre1"><img src="images/00060.jpg" class="calibre123"/></p><p id="filepos903922" class="calibre5">The first point of note is that we use a technique (simplified for clarity) called <span class="italic">lock striping</span> (<a href="#filepos1074683"><span class="calibre8"><span class="underline">Herlihy 2008</span></span></a>) to reduce the contention of guarding the array as a whole using <tt class="calibre11">locking</tt>. The target array <tt class="calibre11">a</tt>’s slots are guarded by half the number of locks, each chosen using the simple formula <tt class="calibre11">(mod target-index num-locks)</tt>. This scheme allows readers and writers to (potentially) act independently when accessing different array slots. It’s crucial that we closed over the lock instance array <tt class="calibre11">L</tt> because for explicit locks to work, each access <span class="italic">must</span> lock and unlock the <span class="italic">same</span> instance. Additionally, we’re calling the <tt class="calibre11">.unlock</tt> method in the body of a <tt class="calibre11">finally</tt> expression, because failing to do so is a recipe for disaster. Unlike the <tt class="calibre11">locking</tt> macro, the <tt class="calibre11">ReentrantLock</tt> class doesn’t manage lock release automatically. Finally, you can also use the <tt class="calibre11">ReentrantLock</tt> in a way equivalent to using the <tt class="calibre11">locking</tt> macro, but using <tt class="calibre11">ReentrantLock</tt> gives you the choice of using <tt class="calibre11">proxy</tt> to provide more complex semantics than <tt class="calibre11">locking</tt> can provide. </p><p class="calibre5">One flaw of the <tt class="calibre11">make-smart-array</tt> function is that it uses the same locks for readers and writers. But you can allow for more concurrency if you enable some number of readers to access array slots without blocking at all by using the <tt class="calibre11">java.util.concurrent.locks.ReentrantReadWriteLock</tt> class. The <tt class="calibre11">ReentrantReadWriteLock</tt> class holds two lock instances, one for reads and one for writes, and by adding another lock array you can take advantage of this fact. We won’t get into that exercise here, but if you choose to do so then you can use the implementation of <tt class="calibre11">make-smart-array</tt> as a guide. </p><p class="calibre5">Using the various locking mechanisms, you can guarantee consistency across threads for mutable objects. But as we showed with explicit locks, there’s an expected incantation to unlocking that must be strictly observed. Though not necessarily complex in the <tt class="calibre11">SafeArray</tt> implementations, the conceptual baggage incurred in the semantics of explicit locking scheme doesn’t scale well. The <tt class="calibre11">java.util.concurrent</tt> package contains a cacophony of concurrency primitives above and beyond simple locks, but it’s not our goal to provide a comprehensive survey herein. </p><p class="calibre5">Now that we’ve covered the matter of guaranteeing coordinated state across disparate threads, we turn our attention to a different topic: parallelization. </p><p id="filepos906634" class="calibre5"><span class="calibre18"><span class="bold">11.6. When to use futures </span></span></p><p class="calibre7">Clojure includes two reference types supporting parallelism: <span class="italic">futures</span> and <span class="italic">promises</span>. Futures, the subject of this section, are simple yet elegant constructs useful for partitioning a typically sequential operation into discrete parts. These parts can then be asynchronously processed across numerous threads that will block if the enclosed expression hasn’t finished. All subsequent dereferencing will return the calculated value. The simplest example of the use of a future is as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(time (let [x (future (do (Thread/sleep 5000) (+ 41 1)))]<br class="calibre3"/>  [@x @x]))<br class="calibre3"/>; "Elapsed time: 5001.682 msecs"<br class="calibre3"/>;=&gt; [42 42]</tt></span></blockquote><p id="filepos907496" class="calibre12">The processing time of the <tt class="calibre11">do</tt> block is only paid for on the first dereference of the future <tt class="calibre11">x</tt>. Futures represent expressions that have yet to be computed. </p><p id="filepos907702" class="calibre5"><span class="bold">11.6.1. Futures as callbacks </span><a></a></p><p class="calibre7">One nice use case for futures is in the context of a callback mechanism. Normally you might call out to a remote-procedure call (RPC), wait for it to complete, and then proceed with some task depending on the return value. But what happens if you need to make multiple RPC calls? Should you be forced to wait for them all serially? Thanks to futures, the answer is no. In this section, we’ll use futures to create an aggregate task that finds the total number of occurrences of a string within a given set of Twitter<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos908611"><span class="calibre33"><span class="calibre8"><span class="underline">6</span></span></span></a><span class="calibre33">]</span></small></sup> feeds. This aggregate task will be split into numerous parallel subtasks via futures. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos908611" class="calibre32"><span class="calibre33">6</span></small></sup><span class="calibre10"> Twitter is online at </span><a href="http://twitter.com"><span class="calibre10"><span class="calibre8"><span class="underline">http://twitter.com</span></span></span></a><span class="calibre10">. </span></blockquote><p class="calibre12"><span class="calibre10"><span class="bold">Counting Word Occurrences in a Set of Twitter Feeds </span></span></p><p class="calibre7">Upon going to a personal Twitter page such as <a href="http://twitter.com/fogus"><span class="calibre8"><span class="underline">http://twitter.com/fogus</span></span></a>, you can find a link to the RSS 2.0 feed for that user. We’ll use this feed as the input to our functions. An RSS 2.0 feed is an XML document used to represent a piece of data that’s constantly changing. The layout of a Twitter RSS entry is straightforward: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">&lt;rss version="2.0"&gt;<br class="calibre3"/>  &lt;channel&gt;<br class="calibre3"/>    &lt;title&gt;Twitter / fogus&lt;/title&gt;<br class="calibre3"/>    &lt;link&gt;http://twitter.com/fogus&lt;/link&gt;<br class="calibre3"/>    &lt;item&gt;<br class="calibre3"/>      &lt;title&gt;fogus: Thinking about #Clojure futures.&lt;/title&gt;<br class="calibre3"/>      &lt;link&gt;http://twitter.com/fogus/statuses/12180102647/&lt;/link&gt;<br class="calibre3"/>    &lt;/item&gt;<br class="calibre3"/>  &lt;/channel&gt;<br class="calibre3"/>&lt;/rss&gt;</tt></span></blockquote><p class="calibre12">There’s more to the content of a typical RSS feed, but for our purposes we wish to only retrieve the <tt class="calibre11">title</tt> element of the <tt class="calibre11">item</tt> elements (there can be more than one). To do this, we need to first parse the XML and put it into a convenient format. If you recall from <a href="#filepos612355"><span class="calibre8"><span class="underline">section 8.4</span></span></a>, we created a domain DSL to create a tree built on a simple node structure of tables with the keys <tt class="calibre11">:tag, :attrs</tt>, and <tt class="calibre11">:content</tt>. As mentioned, that structure is leveraged in many Clojure libraries, and we’ll take advantage of this fact. Clojure provides some core functions in the <tt class="calibre11">clojure.xml</tt> and <tt class="calibre11">clojure.zip</tt> namespaces to help make sense of the feed: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(require '(clojure [xml :as xml]))<br class="calibre3"/>(require '(clojure [zip :as zip]))<br class="calibre3"/><br class="calibre3"/>(defmulti rss-children class)<br class="calibre3"/>(defmethod rss-children String [uri-str]<br class="calibre3"/>(-&gt; (xml/parse uri-str)<br class="calibre3"/>    zip/xml-zip<br class="calibre3"/>    zip/down<br class="calibre3"/>    zip/children))</tt></span></blockquote><p id="filepos911113" class="calibre12">Using the function <tt class="calibre11">clojure.xml/parse</tt>, we can retrieve the XML for a Twitter RSS feed and convert it into the familiar tree format. That tree is then passed into a function <tt class="calibre11">clojure.zip/xml-zip</tt> that converts that structure into another data structure called a <span class="italic">zipper</span>. The form and semantics of the zipper are beyond the scope of this book (<a href="#filepos1075864"><span class="calibre8"><span class="underline">Huet 1997</span></span></a>), but using it in this case allows us to easily navigate <span class="italic">down</span> from the root <tt class="calibre11">rss</tt> XML node to the <tt class="calibre11">channel</tt> node, where we then retrieve its children. The child nodes returned from <tt class="calibre11">rss-children</tt> contain other items besides <tt class="calibre11">item</tt> nodes (<tt class="calibre11">title, link</tt>, and so forth) that need to be filtered out. Once we have those <tt class="calibre11">item</tt> nodes, we then want to retrieve the <tt class="calibre11">title</tt> text and count the number of occurrences of the target text (case-insensitive). We perform all of these tasks using the function <tt class="calibre11">count-tweet-text-task</tt>, defined in the following listing. </p><p id="filepos912196" class="calibre5"><span class="calibre10"><span class="bold">Listing 11.7. Creating a future task to count word occurrences in a tweet </span></span><a></a></p><p class="calibre1"><img src="images/00070.jpg" class="calibre124"/></p><p class="calibre5">We’ll now try to count some text in a Twitter feed to see what happens:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(count-tweet-text-task<br class="calibre3"/>  "#clojure"<br class="calibre3"/>  "http://twitter.com/statuses/user_timeline/46130870.rss")<br class="calibre3"/>;=&gt; 7</tt></span></blockquote><p class="calibre12">The result you see is highly dependent on when you run this function, because the RSS feeds are ever-changing. But using the <tt class="calibre11">count-tweet-text-task</tt> function, we can build a sequence of tasks to be performed over some number of Twitter feeds. Before we do that, we’ll create a convenience macro <tt class="calibre11">as-futures</tt> to take said sequence and dispatch the enclosed actions across some futures. </p><p id="filepos913208" class="calibre5"><span class="calibre10"><span class="bold">Listing 11.8. A macro to dispatch a sequence of futures </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defmacro as-futures [[a args] &amp; body]<br class="calibre3"/>  (let [parts          (partition-by #{'=&gt;} body)<br class="calibre3"/>        [acts _ [res]] (partition-by #{:as} (first parts))<br class="calibre3"/>        [_ _ task]     parts]<br class="calibre3"/>    `(let [~res (for [~a ~args] (future  ~@acts))]<br class="calibre3"/>       ~@task)))</tt></span></blockquote><p id="filepos913773" class="calibre12">The <tt class="calibre11">as-futures</tt> macro implemented in <a href="#filepos913208"><span class="calibre8"><span class="underline">listing 11.8</span></span></a> names a binding corresponding to the arguments for a given action, which is then dispatched across a number of futures, after which a task is run against the futures sequence. The body of <tt class="calibre11">as-futures</tt> is segmented so that we can clearly specify the needed parts—the action arguments, the action to be performed for each argument, and the tasks to be run against the resulting sequence of futures: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(as-futures [&lt;arg-name&gt; &lt;all-args&gt;]<br class="calibre3"/>  &lt;actions-using-args&gt;<br class="calibre3"/>  :as &lt;results-name&gt;<br class="calibre3"/> =&gt;<br class="calibre3"/>  &lt;actions-using-results&gt;)</tt></span></blockquote><p class="calibre12">To simplify the macro implementation, we use the <tt class="calibre11">:as</tt> keyword and <tt class="calibre11">=&gt;</tt> symbol to clearly delineate its segments. The <tt class="calibre11">as-futures</tt> body only exits after the task body finishes—as determined by the execution of the futures. We can use <tt class="calibre11">as-futures</tt> to perform the original task with a new function <tt class="calibre11">tweet-occurrences</tt>, implemented in the following listing. </p><p id="filepos915023" class="calibre5"><span class="calibre10"><span class="bold">Listing 11.9. Counting string occurrences in Twitter feeds fetched in parallel </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn tweet-occurrences [tag &amp; feeds]<br class="calibre3"/>  (as-futures [feed feeds]<br class="calibre3"/>    (count-tweet-text-task tag feed)<br class="calibre3"/>    :as results<br class="calibre3"/>   =&gt;<br class="calibre3"/>    (reduce (fn [total res] (+ total @res))<br class="calibre3"/>            0<br class="calibre3"/>            results)))</tt></span></blockquote><p class="calibre12">The <tt class="calibre11">as-futures</tt> macro builds a sequence of futures named <tt class="calibre11">results</tt>, enclosing the call to <tt class="calibre11">count-tweet-text-task</tt> across the unique set of Twitter feeds provided. We then sum the counts returned from the dereferencing of the individual futures, as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(tweet-occurrences "#Clojure"<br class="calibre3"/>  "http://twitter.com/statuses/user_timeline/46130870.rss"<br class="calibre3"/>  "http://twitter.com/statuses/user_timeline/14375110.rss"<br class="calibre3"/>  "http://twitter.com/statuses/user_timeline/5156041.rss"<br class="calibre3"/>  "http://twitter.com/statuses/user_timeline/21439272.rss")<br class="calibre3"/>;=&gt; 22</tt></span></blockquote><p class="calibre12">And that’s that. Using only a handful of functions and macros, plus using the built-in core facilities for XML parsing and navigation, we’ve created a simple Twitter occurrences counter. Our implementation has some trade-offs made in the name of page count. First, we blindly dereference the future in <tt class="calibre11">tweet-occurrences</tt> when calculating the sum. If the future’s computation freezes, then the dereference would likewise freeze. Using some combination of <tt class="calibre11">future-done?</tt>, <tt class="calibre11">future-cancel</tt>, and <tt class="calibre11">future-cancelled?</tt> in your own programs, you can skip, retry, or eliminate ornery feeds from the calculation. Futures are only one way to perform parallel computation in Clojure, and in the next section we’ll talk about another—promises. </p><p id="filepos917093" class="calibre5"><span class="calibre18"><span class="bold">11.7. When to use promises </span></span></p><p id="filepos917181" class="calibre7">Another tool that Clojure provides for parallel computation is the <tt class="calibre11">promise</tt> and <tt class="calibre11">deliver</tt> mechanisms. Promises are similar to futures, in that they represent a unit of computation to be performed on a separate thread. Likewise, the blocking semantics when dereferencing an unfinished promise are also the same. Whereas futures encapsulate an arbitrary expression that caches its value in the future upon completion, promises are placeholders for values whose construction is fulfilled by another thread via the <tt class="calibre11">deliver</tt> function. A simple example is as follows: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def x (promise))<br class="calibre3"/>(def y (promise))<br class="calibre3"/>(def z (promise))<br class="calibre3"/><br class="calibre3"/>(dothreads! #(deliver z (+ @x @y)))<br class="calibre3"/><br class="calibre3"/>(dothreads!<br class="calibre3"/>  #(do (Thread/sleep 2000) (deliver x 52)))<br class="calibre3"/><br class="calibre3"/>(dothreads!<br class="calibre3"/>  #(do (Thread/sleep 4000) (deliver y 86)))<br class="calibre3"/><br class="calibre3"/>(time @z)<br class="calibre3"/>; "Elapsed time: 3995.414 msecs"<br class="calibre3"/>;=&gt; 138</tt></span></blockquote><p class="calibre12">Promises are write-once; any further attempt to deliver will throw an exception.</p><p id="filepos918395" class="calibre5"><span class="bold">11.7.1. Parallel tasks with promises </span><a></a></p><p class="calibre7">We can create a macro similar to <tt class="calibre11">as-futures</tt> for handling promises, but because of the more advanced value semantics, the implementation is thus more complicated. We again wish to provide a named set of tasks, but we’d additionally like to name the corresponding promises so that we can then execute over the eventual results, which we do next. </p><p id="filepos918866" class="calibre5"><span class="calibre10"><span class="bold">Listing 11.10. A macro to dispatch a sequence of promises across a number of threads </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defmacro with-promises [[n tasks _ as] &amp; body]<br class="calibre3"/>  (when as<br class="calibre3"/>    `(let [tasks# ~tasks<br class="calibre3"/>           n# (count tasks#)<br class="calibre3"/>           promises# (take n# (repeatedly promise))]<br class="calibre3"/>      (dotimes [i# n#]<br class="calibre3"/>        (dothreads!<br class="calibre3"/>          (fn []<br class="calibre3"/>            (deliver (nth promises# i#)<br class="calibre3"/>                     ((nth tasks# i#))))))<br class="calibre3"/>      (let [~n tasks#<br class="calibre3"/>            ~as promises#]<br class="calibre3"/>        ~@body))))</tt></span></blockquote><p class="calibre12">We could then build a rudimentary parallel testing facility, dispatching tests across disparate threads and summing the results when all of the tests are done: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defrecord TestRun [run passed failed])<br class="calibre3"/><br class="calibre3"/>(defn pass [] true)<br class="calibre3"/>(defn fail [] false)<br class="calibre3"/><br class="calibre3"/>(defn run-tests [&amp; all-tests]<br class="calibre3"/>  (with-promises<br class="calibre3"/>    [tests all-tests :as results]<br class="calibre3"/>    (into (TestRun. 0 0 0)<br class="calibre3"/>          (reduce #(merge-with + %1 %2) {}<br class="calibre3"/>            (for [r results]<br class="calibre3"/>              (if @r<br class="calibre3"/>                {:run 1 :passed 1}<br class="calibre3"/>                {:run 1 :failed 1}))))))<br class="calibre3"/><br class="calibre3"/>(run-tests pass fail fail fail pass)<br class="calibre3"/>;=&gt; #:user.TestRun{:run 5, :passed 2, :failed 3}</tt></span></blockquote><p id="filepos920693" class="calibre12">This unit-testing model is simplistic by design in order to illustrate parallelization using promises and not to provide a comprehensive testing framework. </p><p id="filepos920882" class="calibre5"><span class="bold">11.7.2. Callback API to blocking API </span><a></a></p><p class="calibre7">Promises, much like futures, are useful for executing RPC on separate threads. This can be useful if you need to parallelize a group of calls to an RPC service, but there’s a converse use case also. Often, RPC APIs take arguments to the service calls and also a callback function to be executed when the call completes. Using the <tt class="calibre11">rss-children</tt> function from the previous section, we can construct an archetypal RPC function: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn tweet-items [k feed]<br class="calibre3"/>  (k<br class="calibre3"/>    (for [item (filter (comp #{:item} :tag) (rss-children feed))]<br class="calibre3"/>      (-&gt; item :content first :content))))</tt></span></blockquote><p class="calibre12">The <tt class="calibre11">tweet-items</tt> function is a distillation of the <tt class="calibre11">count-tweet-text-task</tt> function from the previous chapter, as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(tweet-items<br class="calibre3"/>  count<br class="calibre3"/>  "http://twitter.com/statuses/user_timeline/46130870.rss")<br class="calibre3"/>;=&gt; 16</tt></span></blockquote><p class="calibre12">The argument <tt class="calibre11">k</tt> to <tt class="calibre11">tweet-items</tt> is the callback, or continuation, that’s called with the filtered RPC results. This API is fine, but there are times when a blocking call is more appropriate than callback based call. We can use a promise to achieve this blocking behavior with the following: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(let [p (promise)]<br class="calibre3"/>  (tweet-items #(deliver p (count %))<br class="calibre3"/>               "http://twitter.com/statuses/user_timeline/46130870.rss")<br class="calibre3"/>  @p)<br class="calibre3"/>;=&gt; 16</tt></span></blockquote><p class="calibre12">And as you see, the call blocks until the deliver occurs. This is a fine way to transform the callback into a blocking call, but we’d like a way to do this generically. Fortunately, <a id="filepos922915"></a>most well-written RPC APIs follow the same form for their callback functions/methods, so we can create a macro to wrap this up nicely in the following listing. </p><p id="filepos923086" class="calibre5"><span class="calibre10"><span class="bold">Listing 11.11. A macro for transforming a callback-based function to a blocking call </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defmacro cps-&gt;fn [f k]<br class="calibre3"/>  `(fn [&amp; args#]<br class="calibre3"/>    (let [p# (promise)]<br class="calibre3"/>      (apply ~f (fn [x#] (deliver p# (~k x#))) args#)<br class="calibre3"/>      @p#)))<br class="calibre3"/><br class="calibre3"/>(def count-items (cps-&gt;fn tweet-items count))<br class="calibre3"/><br class="calibre3"/>(count-items "http://twitter.com/statuses/user_timeline/46130870.rss")<br class="calibre3"/>;=&gt; 16</tt></span></blockquote><p class="calibre12">This is a simple solution to a common problem that you may have already encountered in your own applications.</p><p id="filepos923844" class="calibre5"><span class="bold">11.7.3. Deterministic deadlocks </span><a></a></p><p class="calibre7">You can cause a deadlock in your applications by never delivering to a promise. One possibly surprising advantage of using promises is that if a promise can deadlock, it’ll deadlock deterministically. Because only a single thread can ever deliver on a promise, only that thread will ever cause a deadlock. We can create a cycle in the dependencies between two promises to observe a deadlock using the following code: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def kant (promise))<br class="calibre3"/>(def hume (promise))<br class="calibre3"/><br class="calibre3"/>(dothreads!<br class="calibre3"/>  #(do (println "Kant has" @kant) (deliver hume :thinking)))<br class="calibre3"/><br class="calibre3"/>(dothreads!<br class="calibre3"/>  #(do (println "Hume is" @hume) (deliver kant :fork)))</tt></span></blockquote><p class="calibre12">The Kant thread is waiting for the delivery of the value for <tt class="calibre11">kant</tt> from the Hume thread, which in turn is waiting for the value for <tt class="calibre11">hume</tt> from the Kant thread. Attempting either <tt class="calibre11">@kant</tt> or <tt class="calibre11">@hume</tt> in the REPL will cause an immediate deadlock. Furthermore, this deadlock will happen <span class="italic">every</span> time; it’s deterministic rather than dependent on odd thread timings or the like. Deadlocks are never nice, but deterministic deadlocks are better than nondeterministic.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos925442"><span class="calibre33"><span class="calibre8"><span class="underline">7</span></span></span></a><span class="calibre33">]</span></small></sup></p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos925442" class="calibre32"><span class="calibre33">7</span></small></sup><span class="calibre10"> There are experts in concurrent programming who will say that naïve locking schemes are also deterministic. Our simple example is illustrative, but alas it isn’t representative of a scheme that you may devise for your own code. In complex designs where promises are created in one place and delivered in a remote locale, determining deadlock will naturally be more complex. Therefore, we’d like to use this space to coin a new phrase: “determinism is relative.” </span></blockquote><p class="calibre12">We’ve only touched the surface for the potential that promises represent. In fact, the pieces that we’ve assembled in this section represent some of the basic building blocks of dataflow (<a href="#filepos1083576"><span class="calibre8"><span class="underline">Van Roy 2004</span></span></a>) concurrency. But any attempt to serve justice to dataflow concurrency in a single section would be a futile effort. At its essence, <a id="filepos926419"></a>dataflow deals with the process of dynamic changes in values causing dynamic changes in dependent “formulas.” This type of processing finds a nice analogy in the way that spreadsheet cells operate, some representing values and others dependent formulas that change as the former also change. </p><p class="calibre5">Continuing our survey of Clojure’s parallelization primitives, we’ll next discuss some of the functions provided in the core library. </p><p id="filepos926896" class="calibre5"><span class="calibre18"><span class="bold">11.8. Parallelism </span></span></p><p class="calibre7">In the previous two sections we built two useful macros <tt class="calibre11">as-futures</tt> and <tt class="calibre11">with-promises</tt>, allowing you to parallelize a set of operations across numerous threads. But Clojure has functions in its core library providing similar functionality named <tt class="calibre11">pmap, pvalues</tt>, and <tt class="calibre11">pcalls</tt>, which we’ll cover briefly in this section. </p><p id="filepos927359" class="calibre5"><span class="bold">11.8.1. pvalues </span><a></a></p><p class="calibre7">The <tt class="calibre11">pvalues</tt> macro is analogous to the <tt class="calibre11">as-futures</tt> macro, in that it executes an arbitrary number of expressions in parallel. Where it differs is that it returns a lazy sequence of the results of all the enclosed expressions, as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(pvalues 1 2 (+ 1 2))<br class="calibre3"/>;=&gt; (1 2 3)</tt></span></blockquote><p class="calibre12">The important point to remember when using <tt class="calibre11">pvalues</tt> is that the return type is a lazy sequence, meaning that your access costs might not always present themselves as expected: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn sleeper [s thing] (Thread/sleep (* 1000 s)) thing)<br class="calibre3"/>(defn pvs [] (pvalues<br class="calibre3"/>               (sleeper 2 :1st)<br class="calibre3"/>               (sleeper 3 :2nd)<br class="calibre3"/>               (keyword "3rd")))<br class="calibre3"/><br class="calibre3"/>(-&gt; (pvs) first time)<br class="calibre3"/>;  "Elapsed time: 2000.309 msecs"<br class="calibre3"/>;=&gt; :1st</tt></span></blockquote><p class="calibre12">The total time cost of accessing the first value in the result of <tt class="calibre11">pvs</tt> is only the cost of its own calculation. But accessing any subsequent element costs as much as the most expensive element before it, which you can verify by accessing the last element: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(-&gt; (pvs) last time)<br class="calibre3"/>; "Elapsed time: 4001.435 msecs"<br class="calibre3"/>;=&gt; :3rd</tt></span></blockquote><p class="calibre12">This may prove a disadvantage if you want to access the result of a relatively cheap expression that happens to be placed after a more costly expression. More accurately, all seq values within a sliding window<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos929505"><span class="calibre33"><span class="calibre8"><span class="underline">8</span></span></span></a><span class="calibre33">]</span></small></sup> are forced, so processing time is limited by the most costly element therein. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos929505" class="calibre32"><span class="calibre33">8</span></small></sup><span class="calibre10"> Currently, the window size is </span><span class="calibre10"><span class="italic">N</span></span><span class="calibre10">+2, where </span><span class="calibre10"><span class="italic">N</span></span><span class="calibre10"> is the number of CPU cores. But this is an implementation detail, so it’s enough to know only that the sliding window exists. </span></blockquote><p id="filepos929858" class="calibre35"><span class="bold">11.8.2. pmap </span><a></a></p><p id="filepos929918" class="calibre7">The <tt class="calibre11">pmap</tt> function is the parallel version of the core <tt class="calibre11">map</tt> function. Given a function and a set of sequences, the application of the function to each matching element happens in parallel: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(-&gt;&gt; [1 2 3]<br class="calibre3"/>     (pmap (comp inc (partial sleeper 2)))<br class="calibre3"/>     doall<br class="calibre3"/>     time)<br class="calibre3"/>; "Elapsed time: 2000.811 msecs"<br class="calibre3"/>;=&gt; (2 3 4)</tt></span></blockquote><p class="calibre12">The total cost of realizing the result of mapping a costly increment function is again limited by the most costly execution time within the aforementioned sliding window. Clearly, in this contrived case, using <tt class="calibre11">pmap</tt> provides a benefit, so why not just replace every call to <tt class="calibre11">map</tt> in your programs with a call to <tt class="calibre11">pmap</tt>? Surely this would lead to faster execution times if the <tt class="calibre11">map</tt> functions were all applied in parallel, no? The answer is a resounding: it depends. A definite cost is associated with keeping the resulting sequence result coordinated, and to indiscriminately use <tt class="calibre11">pmap</tt> might actually incur that cost unnecessarily, leading to a performance penalty. But if you’re certain that the cost of the function application outweighs the cost of the coordination, then <tt class="calibre11">pmap</tt> might help to realize performance gains. Only through experimentation will you be able to determine whether <tt class="calibre11">pmap</tt> is the right choice. </p><p id="filepos931442" class="calibre5"><span class="bold">11.8.3. pcalls </span><a></a></p><p class="calibre7">Finally, Clojure provides a <tt class="calibre11">pcalls</tt> function that takes an arbitrary number of functions taking no arguments and calls them in parallel, returning a lazy sequence of the results. The use shouldn’t be a surprise by now: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(-&gt; (pcalls<br class="calibre3"/>      #(sleeper 2 :1st)<br class="calibre3"/>      #(sleeper 3 :2nd)<br class="calibre3"/>      #(keyword "3rd"))<br class="calibre3"/>    doall<br class="calibre3"/>    time)<br class="calibre3"/>; "Elapsed time: 3001.039 msecs"<br class="calibre3"/>;=&gt; (:1st :2nd :3rd)</tt></span></blockquote><p class="calibre12">The same benefits and trade-offs associated with <tt class="calibre11">pvalues</tt> and <tt class="calibre11">pmap</tt> also apply to <tt class="calibre11">pcalls</tt> and should be considered before use. </p><p class="calibre5">Executing costly operations in parallel can be a great boon when used properly, but should by no means be considered a magic potion guaranteeing speed gains. There’s currently no magical formula for determining which parts of an application can be parallelized—the onus is on you to determine your application’s parallel potential. What Clojure provides is a set of primitives, including futures, promises, <tt class="calibre11">pmap, pvalues</tt>, and <tt class="calibre11">pcalls</tt> as the building blocks for your own personalized parallelization needs. </p><p id="filepos932849" class="calibre5">In the next section, we’ll cover the ubiquitous Var, but from a different perspective than we have thus far. </p><p id="filepos932992" class="calibre5"><span class="calibre18"><span class="bold">11.9. Vars and dynamic binding </span></span></p><p class="calibre7">The last reference type we’ll explore is perhaps the most commonly used—the Var. Vars are most often used because of two main features: </p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24">Vars can be named and interned in a namespace.</li><li value="2" class="calibre24">Vars can provide thread-local state.</li></ul><p class="calibre5">It’s through the second feature that Vars contribute most usefully to the reference type landscape. The thread-local value of a Var by definition can only be read from or written to a single thread, and thus provides the thread-safe semantics you’ve come to expect from a Clojure reference type. </p><p class="calibre5">But before you can start experimenting with Vars at the REPL, we to need address some consequences of the first feature. The other reference objects you’ve looked at aren’t themselves named and so are generally <span class="italic">stored</span> in something with a name. This means that when the name is evaluated, you get the reference object, not the value. To get the object’s value, you have to use <tt class="calibre11">deref</tt>. Named Vars flip this around—evaluating their name gives the value, so if you want the Var object, you need to pass the name to the special operator <tt class="calibre11">var</tt>. </p><p class="calibre5">With this knowledge in hand, you can experiment with an existing Var. Clojure provides a Var named <tt class="calibre11">*read-eval*</tt>,<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos934811"><span class="calibre33"><span class="calibre8"><span class="underline">9</span></span></span></a><span class="calibre33">]</span></small></sup> so you can get its current value by evaluating its name: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos934811" class="calibre32"><span class="calibre33">9</span></small></sup><span class="calibre10"><tt class="calibre11">*read-eval*</tt></span><span class="calibre10"> happens to be a Var that has a default configuration useful for this discussion about Vars—its actual purpose is unimportant here. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">*read-eval*<br class="calibre3"/>;=&gt; true</tt></span></blockquote><p class="calibre12">No <tt class="calibre11">deref</tt> needed, because <tt class="calibre11">*read-eval*</tt> is a named Var. Now for the Var object itself: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(var *read-eval*)<br class="calibre3"/>;=&gt; #'clojure.core/*read-eval*</tt></span></blockquote><p class="calibre12">That’s interesting—when a named Var object is printed, it starts with <tt class="calibre11">#'</tt> and is then followed by the fully qualified name of the Var. The <tt class="calibre11">#'</tt> reader feature expands to the Var operator—it means the same thing: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">#'*read-eval*<br class="calibre3"/>;=&gt; #'clojure.core/*read-eval*</tt></span></blockquote><p class="calibre12">Now that you’ve seen how to refer to Var objects, you can look at how they behave. The Var <tt class="calibre11">*read-eval*</tt> is one of those provided by Clojure that’s specifically meant to be given thread-local bindings but by default has only a root binding. You should’ve seen its root binding when you evaluated it earlier—by default, <tt class="calibre11">*read-eval*</tt> is bound to <tt class="calibre11">true</tt>. </p><p id="filepos936275" class="calibre5"><span class="bold">11.9.1. The binding macro </span><a></a></p><p id="filepos936347" class="calibre7">The root binding of a Var can act as the base of a stack, with each thread’s local bindings pushing onto that stack and popping off of it as requested. The most common mechanism for pushing and popping thread-local bindings is the macro <tt class="calibre11">binding</tt>. It takes one or more Var names and a value for each that will initialize the new binding when it’s pushed. These bindings remain in effect until control passes out of the <tt class="calibre11">binding</tt> macro, at which point they’re popped off the stack. </p><p class="calibre5">Here’s a simple example of a function that prints the current value of the Var <tt class="calibre11">*read-eval*</tt>, either the root or thread-local value, whichever is currently in effect: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn print-read-eval []<br class="calibre3"/>  (println "*read-eval* is currently" *read-eval*))</tt></span></blockquote><p class="calibre12">This function calls <tt class="calibre11">print-read-eval</tt> three times, the first and last of which will print the root binding. The middle time, <tt class="calibre11">binding</tt> is in effect: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn binding-play []<br class="calibre3"/>  (print-read-eval)<br class="calibre3"/>  (binding [*read-eval* false]<br class="calibre3"/>    (print-read-eval))<br class="calibre3"/>  (print-read-eval))</tt></span></blockquote><p class="calibre12">This results in the Var temporarily having a thread-local value of <tt class="calibre11">false</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(binding-play)<br class="calibre3"/>; *read-eval* is currently true<br class="calibre3"/>; *read-eval* is currently false<br class="calibre3"/>; *read-eval* is currently true</tt></span></blockquote><p class="calibre12">This is a like thread B in <a href="#filepos938265"><span class="calibre8"><span class="underline">figure 11.9</span></span></a>, which also shows a simpler scenario than thread A and a more complex one than thread C. </p><p id="filepos938265" class="calibre5"><span class="calibre10"><span class="bold">Figure 11.9. Thread-local Var bindings. This illustration depicts a single Var being used from three different threads. Each rounded box is a Var binding, either thread-local or root. Each star is the Var being deref’ed, with the solid arrow pointing to the binding used. The dotted lines point from a thread-local binding to the next binding on the stack. </span></span><a></a></p><p class="calibre1"><img src="images/00017.jpg" class="calibre125"/></p><p id="filepos938809" class="calibre5"><span class="bold">11.9.2. Creating a named Var </span><a></a></p><p class="calibre7">Vars are most commonly created with the special operator <tt class="calibre11">def</tt> or one of the many macros that expands to a form that has a <tt class="calibre11">def</tt> inside: </p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24"><tt class="calibre11">defn</tt>—For putting a function in a Var </li><li value="2" class="calibre24"><tt class="calibre11">defmacro</tt>—For putting a macro in a Var </li><li value="3" class="calibre24"><tt class="calibre11">defonce</tt>—For setting the value of an unbound Var </li><li value="4" class="calibre24"><tt class="calibre11">defmulti</tt>—For putting a multimethod in a Var </li></ul><p class="calibre5">There are a few others in <tt class="calibre11">clojure.core<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos940390"><span class="calibre33"><span class="calibre8"><span class="underline">10</span></span></span></a><span class="calibre33">]</span></small></sup></tt> and many more in <tt class="calibre11">contrib</tt>. What they have in common is that <a id="filepos939799"></a>each of these will intern a Var in the current namespace. Clojure will search for the named Var in the current namespace. If one is found, it’s used; otherwise, a new Var is created and added to the namespace, and that one is used.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos940912"><span class="calibre33"><span class="calibre8"><span class="underline">11</span></span></span></a><span class="calibre33">]</span></small></sup> The Var (specifically the root binding of the Var) is bound to whatever value, function, or macro (and so on) was given. The Var itself is returned: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos940390" class="calibre32"><span class="calibre33">10</span></small></sup><span class="calibre10"> It’s likely that starting with Clojure 1.3 Vars will only have the ability to take on thread-local values when defined using </span><span class="calibre10"><tt class="calibre11">defdynamic</tt></span><span class="calibre10"> or marked with metadata like </span><span class="calibre10"><tt class="calibre11">^{:dynamic true}</tt></span><span class="calibre10">. Throughout this book, we will take the latter approach with high confidence that it will just work in 1.3. </span></blockquote><blockquote class="calibre39"><sup class="calibre31"><small id="filepos940912" class="calibre32"><span class="calibre33">11</span></small></sup><span class="calibre10"> Not all macros starting with </span><span class="calibre10"><tt class="calibre11">def</tt></span><span class="calibre10"> necessarily create or intern Vars. Some that don’t: </span><span class="calibre10"><tt class="calibre11">defmethod, defrecord</tt></span><span class="calibre10">, and </span><span class="calibre10"><tt class="calibre11">deftype</tt></span><span class="calibre10">. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(def favorite-color :green)<br class="calibre3"/>#'user/favorite-color</tt></span></blockquote><p class="calibre12">When a Var is printed, its fully qualified name is given, along with the namespace where the Var is interned (<tt class="calibre11">user</tt>) and the Var’s name itself (<tt class="calibre11">favorite-color</tt>). These are preceded by <tt class="calibre11">#'</tt> because unlike the other reference types, a named Var is automatically dereferenced when its name is evaluated—no explicit <tt class="calibre11">@</tt> or call to <tt class="calibre11">deref</tt> is required: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">favorite-color<br class="calibre3"/>;=&gt; :green</tt></span></blockquote><p class="calibre12">So in order to refer to a Var instead of the value it’s bound to, you need to use <tt class="calibre11">#'</tt> or the special form <tt class="calibre11">var</tt>, which are equivalent: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(var favorite-color)<br class="calibre3"/>;=&gt; #'user/favorite-color</tt></span></blockquote><p class="calibre12">A Var can exist (or <span class="italic">not</span> exist) in any of four states. The precise state a Var is in can be determined using the functions <tt class="calibre11">resolve, bound?</tt>, and <tt class="calibre11">thread-bound?</tt> as shown in <a href="#filepos942578"><span class="calibre8"><span class="underline">Table 11.1</span></span></a>. </p><p id="filepos942578" class="calibre5"><span class="calibre10"><span class="bold">Table 11.1. Var states </span></span><a></a></p><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><th scope="col" valign="top" class="calibre26"><p class="calibre27"><span class="calibre10"><span class="bold">Initialization mechanism</span></span></p></th><th scope="col" valign="top" class="calibre26"><p class="calibre27"><span class="calibre10"><span class="bold">(resolve ’x)</span></span></p></th><th scope="col" valign="top" class="calibre26"><p class="calibre27"><span class="calibre10"><span class="bold">(bound? #’x)</span></span></p></th><th scope="col" valign="top" class="calibre26"><p class="calibre27"><span class="calibre10"><span class="bold">(thread-bound? #’x)</span></span></p></th></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">(def x)</span>
</td><td valign="top" class="calibre16"><span class="calibre10">#'user/x</span>
</td><td valign="top" class="calibre16"><span class="calibre10">false</span>
</td><td valign="top" class="calibre16"><span class="calibre10">false</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">(def x 5)</span>
</td><td valign="top" class="calibre16"><span class="calibre10">#'user/x</span>
</td><td valign="top" class="calibre16"><span class="calibre10">true</span>
</td><td valign="top" class="calibre16"><span class="calibre10">false</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">(binding [x 7] ...)</span>
</td><td valign="top" class="calibre16"><span class="calibre10">#'user/x</span>
</td><td valign="top" class="calibre16"><span class="calibre10">true</span>
</td><td valign="top" class="calibre16"><span class="calibre10">true</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10">(with-local-vars [x 9] ...)</span>
</td><td valign="top" class="calibre16"><span class="calibre10">nil</span>
</td><td valign="top" class="calibre16"><span class="calibre10">true (bound? x)</span>
</td><td valign="top" class="calibre16"><span class="calibre10">true (thread-bound? x)</span>
</td></tr></table><p class="calibre7">The first row of the table shows the results of <tt class="calibre11">resolve, bound?</tt>, and <tt class="calibre11">thread-bound?</tt> when a var <tt class="calibre11">x</tt> is unbound. The remaining rows show how to change <tt class="calibre11">x</tt> to cause those functions to return the values shown. </p><p id="filepos944480" class="calibre5"><span class="bold">11.9.3. Creating anonymous Vars </span><a></a></p><p class="calibre7">Vars don’t always have names, nor do they need to be interned in a namespace. The <tt class="calibre11">with-local-vars</tt> macro creates Vars and gives them thread-local bindings all at once, but it <span class="italic">won’t</span> intern them. Instead, they’re bound to locals, which means that the associated Var isn’t implicitly looked up by symbolic name. You need to use <tt class="calibre11">deref</tt> or <tt class="calibre11">var-get</tt> to get the current value of the Var. Here’s an example of a Var <tt class="calibre11">x</tt> created and <a id="filepos945059"></a>interned with <tt class="calibre11">def</tt>, and then a local <tt class="calibre11">x</tt> that shadows it and is bound to a new var via <tt class="calibre11">with-local-vars</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def x 42)<br class="calibre3"/>{:outer-var-value x<br class="calibre3"/> :with-locals (with-local-vars [x 9]<br class="calibre3"/>                {:local-var x<br class="calibre3"/>                 :local-var-value (var-get x)})}<br class="calibre3"/><br class="calibre3"/>;=&gt; {:outer-var-value 42,<br class="calibre3"/>     :with-locals {:local-var #&lt;Var: --unnamed--&gt;,<br class="calibre3"/>                   :local-var-value 9}}</tt></span></blockquote><p class="calibre12">Within the body of the <tt class="calibre11">with-local-vars</tt> macro, the bound value can bet set using <tt class="calibre11">(var-set &lt;var&gt; &lt;value&gt;)</tt>, which will of course only affect the thread-local value. It’s almost stunning how rarely <tt class="calibre11">with-local-vars</tt> is useful. </p><p id="filepos945984" class="calibre5"><span class="bold">11.9.4. Dynamic scope </span><a></a></p><p class="calibre7">Vars have dynamic scope, which contrasts with the lexical scope of <tt class="calibre11">let</tt> locals. The most obvious difference is that with a lexical local, you can easily see where it was initialized by looking at the nested structure of the code. A Var, on the other hand, may have been initialized by a <tt class="calibre11">binding</tt> anywhere earlier in the call stack, not necessarily nearby in the code at all. This difference can create unexpectedly complex interactions and is one of the few areas where Clojure does little to help you address such complexity. </p><p class="calibre5">An example of this complexity is shown by using the <tt class="calibre11">binding</tt> macro or any macro built on top of it, such as <tt class="calibre11">with-precision</tt> and <tt class="calibre11">with-out-str</tt>. For example, we can use the <tt class="calibre11">with-precision</tt> macro to conveniently set up the <tt class="calibre11">*math-context*</tt> Var: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(with-precision 4<br class="calibre3"/>  (/ 1M 3))<br class="calibre3"/>;=&gt; 0.3333M</tt></span></blockquote><p class="calibre12">We need to use <tt class="calibre11">with-precision</tt> here because if we don’t tell <tt class="calibre11">BigDecimal</tt> we’re okay with it rounding off the result, it’ll refuse to return anything in this case: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(/ 1M 3)<br class="calibre3"/>; java.lang.ArithmeticException: Non-terminating decimal expansion;<br class="calibre3"/>;   no exact representable decimal result.</tt></span></blockquote><p class="calibre12">With that in mind, can you see why <tt class="calibre11">with-precision</tt> isn’t doing its job in the next snippet? The only thing that makes it different from the example that worked earlier is we’re using <tt class="calibre11">map</tt> to produce a sequence of three numbers instead of just one: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(with-precision 4<br class="calibre3"/>  (map (fn [x] (/ x 3)) (range 1M 4M)))<br class="calibre3"/><br class="calibre3"/>; java.lang.ArithmeticException: Non-terminating decimal expansion;<br class="calibre3"/>;   no exact representable decimal result.</tt></span></blockquote><p class="calibre12">The problem is that <tt class="calibre11">map</tt> is lazy and therefore doesn’t call the function given to it immediately. Instead, it waits until the REPL tries to print it, and then does the division. Although the <tt class="calibre11">map</tt> and the function it calls are within the <span class="italic">lexical scope</span> of <tt class="calibre11">with-binding</tt>, and <tt class="calibre11">with-binding</tt> itself uses a thread-local binding internally, it doesn’t care <a id="filepos948562"></a>about lexical scope. When the division operation is performed, we’ve already left the <span class="italic">dynamic scope</span> of the <tt class="calibre11">with-precision</tt>, and it no longer has any effect. The <tt class="calibre11">BigDecimal</tt> behavior drops back to its default, and it throws an exception. </p><p class="calibre5">One way to solve this is to make sure that all the division is done before leaving the dynamic scope. Clojure’s <tt class="calibre11">doall</tt> function is perfect for this: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(with-precision 4<br class="calibre3"/>  (doall (map (fn [x] (/ x 3)) (range 1M 4M))))<br class="calibre3"/>;=&gt; (0.3333M 0.6667M 1M)</tt></span></blockquote><p class="calibre12">One drawback is that it completely defeats <tt class="calibre11">map</tt>’s laziness. An alternate solution is to have the function provided to <tt class="calibre11">map</tt> re-create, when it’s run, the dynamic scope in which the function was created. Clojure provides a handy macro <tt class="calibre11">bound-fn</tt> to do exactly that: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(with-precision 4<br class="calibre3"/>  (map (bound-fn [x] (/ x 3)) (range 1M 4M)))<br class="calibre3"/>;=&gt; (0.3333M 0.6667M 1M)</tt></span></blockquote><p class="calibre12">Now the sequence being returned is still lazy, but before each item is computed, the dynamic scope of <tt class="calibre11">*math-context*</tt> is re-created and the exception is avoided. </p><p class="calibre5">This kind of mismatch between a function definition that appears lexically inside a form like <tt class="calibre11">with-precision</tt> or <tt class="calibre11">binding</tt> and yet has a different dynamic scope when called doesn’t cause problems with lazy sequences alone. You may also see problems with functions sent to Agents as actions or with the body of a future, because these are executed in other threads outside the dynamic scope where they’re set up. </p><p class="calibre5">Problems related to dynamic scope aren’t even exclusive to Vars. The scope of a <tt class="calibre11">try/catch</tt> is also dynamic and can have similarly unexpected behavior. For example, <tt class="calibre11">with-open</tt> uses <tt class="calibre11">try/finally</tt> to close a file automatically when execution leaves its dynamic scope. Failing to account for this can lead to an error when trying to write to a closed file, because the dynamic scope of <tt class="calibre11">with-open</tt> has been left. Though <tt class="calibre11">bound-fn</tt> can help make the dynamic scope of a Var borrow from its lexical scope, the only way to deal with <tt class="calibre11">try/catch</tt> is to make sure everything is executed before leaving its dynamic scope. </p><p id="filepos951111" class="calibre5"><span class="calibre18"><span class="bold">11.10. Summary </span></span></p><p class="calibre7">This has been the most complex chapter of the book. State management is a complicated process that can quickly lose all semblance of sanity in the face of concurrent modifications. Clojure’s main tenet is not to foster concurrency, but instead to provide the tools for the sane management of state. As a result of this focus, sane concurrency follows. Clojure also provides the building blocks for you to parallelize computations across disparate threads of execution. From the expression-centric future, to the function-centric set-once “variable” promise, to the core functions <tt class="calibre11">pcalls, pvalues</tt>, and <tt class="calibre11">pmap</tt>, Clojure gives you the raw materials for your specialized needs. Finally, we talked in depth about Clojure’s Var, dynamic binding, and the mechanics of thread-locals. </p><p class="calibre5">The next chapter deals with performance considerations and how to make your Clojure programs much faster.</p><div class="mbppagebreak"></div><p id="filepos952172" class="calibre5"><span class="calibre6"><span class="bold">Part 5. Tangential considerations </span></span><a></a></p><p class="calibre7">Some topics are so interesting and important that we must include them, even if they don’t fit well in another chapter or warrant a chapter to themselves. In this part, we’ll cover several such topics, including transient collections, domain-specific languages, and testing. </p><div class="mbppagebreak"></div><p id="filepos952602" class="calibre5"><span class="calibre6"><span class="bold">Chapter 12. Performance </span></span><a></a></p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">This chapter covers</span>
</p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24"><a href="#filepos954781"><span class="calibre8"><span class="underline">Type hints</span></span></a></li><a id="filepos953012"></a><li value="2" class="calibre24"><a href="#filepos962834"><span class="calibre8"><span class="underline">Transients</span></span></a></li><li value="3" class="calibre24"><a href="#filepos969517"><span class="calibre8"><span class="underline">Chunked sequences</span></span></a></li><li value="4" class="calibre24"><a href="#filepos975700"><span class="calibre8"><span class="underline">Memoization</span></span></a></li><li value="5" class="calibre24"><a href="#filepos988109"><span class="calibre8"><span class="underline">Understanding coercion</span></span></a></li></ul><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">Now that we’ve spent a book’s worth of material learning the why and how of Clojure, it’s high time we turned our attention to the subject of performance. There’s a meme in programming that can be summarized as follows: make it work first, then make it fast. Throughout this book, we’ve taught you the ways that Clojure allows you to “make it work,” and now we’re going to tell how to make it fast. </p><p class="calibre5">In many cases, Clojure’s compiler will be able to highly optimize idiomatic Clojure source code. But there are times when the form of your functions, especially in interoperability scenarios, will prove to be ambiguous or even outright counter to compiler optimizations. Therefore, we’ll lead you through optimization techniques such as type hints, transients, chunked sequences, memoization, and coercion. Using some combination of these techniques will help you approach, and sometimes exceed, the performance of Java itself. </p><p class="calibre5">The most obvious place to start, and the one you’re most likely encounter, is type hinting—so this is where we’ll begin.</p><p id="filepos954781" class="calibre5"><span class="calibre18"><span class="bold">12.1. Type hints </span></span></p><p id="filepos954859" class="calibre7">The path of least resistance in Clojure often produces the fastest and most efficient compiled code, but not always. The beauty of Clojure is that this path of least resistance allows simple techniques for gaining speed via type hints. The first thing to know about type hints is that they’re used to indicate that an object is an instance of some class—never a primitive. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre28"><span class="calibre10"><span class="bold">The Rule of Type Hinting</span></span></p><p class="calibre5">Write your code so that it’s first and foremost correct; then add type-hint adornment to gain speed. Don’t trade the efficiency of the program for the efficiency of the programmer. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p id="filepos955792" class="calibre35"><span class="bold">12.1.1. Advantages of type adornment </span><a></a></p><p class="calibre7">There are epic debates about the virtues of static versus dynamic type systems; we won’t engage in those arguments here. But there are a few advantages to a dynamic type system like Clojure’s that also allows type hinting to occur after the bulk of development. One such advantage is that in a static type system, the cost of changing argument lists is extended to all of the callers, whereas in Clojure the cost is deferred until adornment time or even outright avoided.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos956854"><span class="calibre33"><span class="calibre8"><span class="underline">1</span></span></span></a><span class="calibre33">]</span></small></sup> This scenario isn’t limited to the case of function arguments in Clojure nor to statically typed languages, but instead to any typed element. This dynamic type system provides an agile experience in general to Clojure, which can later be optimized when there’s a need. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos956854" class="calibre32"><span class="calibre33">1</span></small></sup><span class="calibre10"> Aside from the case where type hints don’t require client changes, the use of keyword arguments as seen in </span><a href="#filepos487603"><span class="calibre10"><span class="calibre8"><span class="underline">section 7.1</span></span></span></a><span class="calibre10"> can help to localize additional function requirements to only the callers needing them. </span></blockquote><p id="filepos957246" class="calibre35"><span class="bold">12.1.2. Type-hinting arguments and returns </span><a></a></p><p class="calibre7">If you recall from <a href="#filepos767521"><span class="calibre8"><span class="underline">section 10.3</span></span></a>, we created a function <tt class="calibre11">asum-sq</tt> that took an array of floats and performed a sum of squares on its contents. Unfortunately, <tt class="calibre11">asum-sq</tt> wasn’t as fast as it could’ve been. We can illuminate the cause of its inefficiency using a REPL flag named <tt class="calibre11">*warn-on-reflection*</tt>, which by default is set to false: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(set! *warn-on-reflection* true)<br class="calibre3"/>;=&gt; true</tt></span></blockquote><p class="calibre12">What this seemingly innocuous statement does is to signal to the REPL to report when the compiler encounters a condition where it can’t infer the type of an object and must use reflection to garner it at runtime. You’ll see a reflection warning by entering <tt class="calibre11">asum-sq</tt> into the REPL: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn asum-sq [xs]<br class="calibre3"/>  (let [dbl (amap xs i ret<br class="calibre3"/>              (* (aget xs i)<br class="calibre3"/>                 (aget xs i)))]<br class="calibre3"/>    (areduce dbl i ret 0<br class="calibre3"/>      (+ ret (aget dbl i)))))<br class="calibre3"/><br class="calibre3"/>; Reflection warning - call to aclone can't be resolved.<br class="calibre3"/>; ...</tt></span></blockquote><p id="filepos958691" class="calibre12">Though not terribly informative in and of itself, the fact that a reflection warning occurs is portentous. Running the call to <tt class="calibre11">asum-sq</tt> in a tight loop verifies that something is amiss: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(time (dotimes [_ 10000] (asum-sq (float-array [1 2 3 4 5]))))<br class="calibre3"/>; "Elapsed time: 410.539 msecs"<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p class="calibre12">Though the reflection warning didn’t point to the precise inefficiency, you can infer where it could be given that Clojure deals with the <tt class="calibre11">java.lang.Object</tt> class across function boundaries. Therefore, you can assume that the problem lies in the argument <tt class="calibre11">xs</tt> coming into the function as something unexpected. Adding two type hints to <tt class="calibre11">xs</tt> and <tt class="calibre11">dbl</tt> (because it’s built from <tt class="calibre11">xs</tt>) might do the trick: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn asum-sq [ ^floats xs]<br class="calibre3"/>  (let [^floats dbl (amap xs i ret<br class="calibre3"/>  ...</tt></span></blockquote><p class="calibre12">Rerunning the tight loop verifies that the assumption was correct:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(time (dotimes [_ 10000] (asum-sq (float-array [1 2 3 4 5]))))<br class="calibre3"/>; "Elapsed time: 17.087 msecs"<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p class="calibre12">This is a dramatic increase in speed using a simple type hint that casts the incoming array <tt class="calibre11">xs</tt> to one containing primitive floats. The whole range of array type hints is shown next: </p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24"><tt class="calibre11">objects</tt></li><li value="2" class="calibre24"><tt class="calibre11">ints</tt></li><li value="3" class="calibre24"><tt class="calibre11">longs</tt></li><li value="4" class="calibre24"><tt class="calibre11">floats</tt></li><li value="5" class="calibre24"><tt class="calibre11">doubles</tt></li><li value="6" class="calibre24"><tt class="calibre11">chars</tt></li><li value="7" class="calibre24"><tt class="calibre11">shorts</tt></li><li value="8" class="calibre24"><tt class="calibre11">bytes</tt></li><li value="9" class="calibre24"><tt class="calibre11">booleans</tt></li></ul><p class="calibre5">The problems might still not be solved, especially if you want to do something with the return value of <tt class="calibre11">asum-sq</tt>, as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(.intValue (asum-sq (float-array [1 2 3 4 5])))<br class="calibre3"/>; Reflection warning, reference to field intValue can't be resolved.<br class="calibre3"/>;=&gt; 55</tt></span></blockquote><p class="calibre12">This is because the compiler can’t garner the type of the return value and must therefore use reflection to do so. By hinting the return type of <tt class="calibre11">asum-sq</tt>, the problem goes away: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn ^Float asum-sq [ ^floats xs]<br class="calibre3"/>  ...<br class="calibre3"/><br class="calibre3"/>(.intValue (asum-sq (float-array [1 2 3 4 5])))<br class="calibre3"/>;=&gt; 55</tt></span></blockquote><p class="calibre12">With minor decoration on the <tt class="calibre11">asum-sq</tt> function, we’ve managed to increase its speed as well as potentially increasing the speed of expressions downstream. </p><p id="filepos961951" class="calibre5"><span class="bold">12.1.3. Type-hinting objects </span><a></a></p><p id="filepos962026" class="calibre7">In addition to allowing for the hinting of function arguments and return values, you can also hint arbitrary objects. If you didn’t have control over the source to <tt class="calibre11">asum-sq</tt>, then these reflection problem would be insurmountable when executing <tt class="calibre11">(.intValue (asum-sq (float-array [1 2 3 4 5])))</tt>. But you can instead hint at the point of usage and gain the same advantage as if <tt class="calibre11">asum-sq</tt> had been hinted all along: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(.intValue ^Float (asum-sq (float-array [1 2 3 4 5])))<br class="calibre3"/>;=&gt; 55</tt></span></blockquote><p class="calibre12">All isn’t lost when you don’t own a piece of code causing performance problems, because Clojure is flexible in the placement of type hints. </p><p id="filepos962834" class="calibre5"><span class="calibre18"><span class="bold">12.2. Transients </span></span></p><p class="calibre7">We’ve harped on you for this entire book about the virtues of persistent data structures and how wonderful they are. In this section, we’ll present an optimization technique provided by Clojure called <span class="italic">transients</span>, which offer a mutable view of a collection. It seems like blasphemy, but we assure you there’s a good reason for their existence, which we’ll discuss currently. </p><p id="filepos963334" class="calibre5"><span class="bold">12.2.1. Ephemeral garbage </span><a></a></p><p class="calibre7">The design of Clojure is such that it presumes that the JVM is extremely efficient at garbage collection of ephemeral (or short-lived) objects, and in fact it is. But as you can imagine based on what you’ve learned so far, Clojure does create a lot of young objects that are never again accessed, shown (in spirit) here: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(reduce merge [{1 3} {1 2} {3 4} {3 5}])<br class="calibre3"/>;=&gt; {1 2, 3 5}</tt></span></blockquote><p class="calibre12">A naive implementation<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos964413"><span class="calibre33"><span class="calibre8"><span class="underline">2</span></span></span></a><span class="calibre33">]</span></small></sup> of <tt class="calibre11">reduce</tt> would build intermediate maps corresponding to the different phases of accumulation. The accumulation of these short-lived instances can in some circumstances cause inefficiencies, which transients are meant to address. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos964413" class="calibre32"><span class="calibre33">2</span></small></sup><span class="calibre10"> The actual implementation of </span><span class="calibre10"><tt class="calibre11">reduce</tt></span><span class="calibre10"> follows a reduce protocol that delegates to a smart “internal reduce” mechanism that’s meant for data structures that know the most efficient way to reduce themselves. </span></blockquote><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre28"><span class="calibre10"><span class="bold">The Rule of Transients</span></span></p><p class="calibre5">Write your code so that it’s first and foremost correct using the immutable collections and operations; then, make changes to use transients for gaining speed. But you might be better served by writing idiomatic and correct code and letting the natural progression of speed enhancements introduced in new versions of Clojure take over. Spot optimizations often quickly become counter-optimizations by preventing the language/libraries from doing something better. </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">We’ll explore how you can use transients in the next section.</p><p id="filepos965654" class="calibre5"><span class="bold">12.2.2. Transients compare in efficiency to mutable collections </span><a></a></p><p id="filepos965764" class="calibre7">Mutable objects generally don’t make new allocations during intermediate phases of an operation on a single collection type, and comparing persistent data structures against that measure assumes a lesser memory efficiency. But you can use transients to provide not only efficiency of allocation, but often of execution as well. Take a function <tt class="calibre11">zencat</tt>, intended to work similarly to Clojure’s <tt class="calibre11">concat</tt>, but with vectors exclusively: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn zencat1 [x y]<br class="calibre3"/>  (loop [src y, ret x]<br class="calibre3"/>    (if (seq src)<br class="calibre3"/>      (recur (next src) (conj ret (first src)))<br class="calibre3"/>      ret)))<br class="calibre3"/><br class="calibre3"/>(zencat1 [1 2 3] [4 5 6])<br class="calibre3"/>;=&gt; [1 2 3 4 5 6]<br class="calibre3"/><br class="calibre3"/>(time (dotimes [_ 1000000] (zencat1 [1 2 3] [4 5 6])))<br class="calibre3"/>; "Elapsed time: 486.408 msecs"<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p class="calibre12">The implementation is simple enough, but it’s not all that it could be. The effects of using transients is shown next.</p><p id="filepos966899" class="calibre5"><span class="calibre10"><span class="bold">Listing 12.1. A concatenation function using transients </span></span><a></a></p><p class="calibre1"><img src="images/00079.jpg" class="calibre126"/></p><p class="calibre5">Wait, what? It seems that by using transients, we’ve actually made things worse—but have we? The answer lies in the question, “what am I actually measuring?” The timing code is executing <tt class="calibre11">zencat2</tt> in a tight loop. This type of timing isn’t likely representative of actual use, and instead highlights an important consideration: the use of <tt class="calibre11">persistent!</tt> and <tt class="calibre11">transient</tt>, though constant time, aren’t free. By measuring the use of transients in a tight loop, we’ve introduced a confounding measure, with the disparate cost of using transients compared to the cost of concatenating two small vectors. A better benchmark would instead be to measure the concatenation of larger vectors, therefore minimizing the size-relative cost of transients: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def bv (vec (range 1e6)))<br class="calibre3"/><br class="calibre3"/>(first (time (zencat1 bv bv)))<br class="calibre3"/>; "Elapsed time: 181.988 msecs"<br class="calibre3"/>;=&gt; 0<br class="calibre3"/><br class="calibre3"/>(first (time (zencat2 bv bv)))<br class="calibre3"/>; "Elapsed time: 39.353 msecs"<br class="calibre3"/>;=&gt; 0</tt></span></blockquote><p id="filepos968286" class="calibre12">In the case of concatenating large vectors, the use of transients is ~4.5 times faster than the purely functional approach. Be careful how you use transients in your own applications, because as you saw, they’re an incredible boon in some cases, and quite the opposite in others. Likewise, be careful designing performance measurements, because they might not always measure what you think. </p><p class="calibre5">Because transients are a mutable view of a collection, you should take care when exposing outside of localized contexts. Fortunately, Clojure doesn’t allow a transient to be modified across threads and will throw an exception if attempted. But it’s easy enough to forget that you’re dealing with a transient and return it from a function. That’s not to say that you couldn’t return a transient from a function—it can be useful to build a pipeline of functions that work in concert against a transient structure. Instead, we ask that you remain mindful when doing so. </p><p class="calibre5">The use of transients can help to gain speed in many circumstances. But be mindful of the trade-offs when using them, because they’re not cost-free operations. </p><p id="filepos969517" class="calibre5"><span class="calibre18"><span class="bold">12.3. Chunked sequences </span></span></p><p class="calibre7">With the release of Clojure 1.1, the granularity of Clojure’s laziness was changed from a one-at-a-time model to a chunk-at-a-time model. Instead of walking through a sequence one node at a time, chunked sequences provide a windowed view (<a href="#filepos1069516"><span class="calibre8"><span class="underline">Boncz 2005</span></span></a>) on sequences some number of elements wide, as illustrated here: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def gimme #(do (print \.) %))<br class="calibre3"/><br class="calibre3"/>(take 1 (map gimme (range 32)))</tt></span></blockquote><p class="calibre12">You might expect that this snippet would print <tt class="calibre11">(.0)</tt> because we’re only grabbing the first element, and if you’re running Clojure 1.0, that’s exactly what you’d see. But in later versions, the picture is different: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">;=&gt; (................................0)</tt></span></blockquote><p class="calibre12">If you count the dots, you’ll see exactly 32, which is what you’d expect given the statement from the first paragraph. Expanding a bit further, if you increase the argument to <tt class="calibre11">range</tt> to be 33 instead, you’ll see the following: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(take 1 (map gimme (range 33)))<br class="calibre3"/>;=&gt; (................................0)</tt></span></blockquote><p class="calibre12">Again you can count 32 dots. Moving the chunky window to the right is as simple as obtaining the 33rd element:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(take 1 (drop 32 (map gimme (range 64))))<br class="calibre3"/>;=&gt; (................................................................32)</tt></span></blockquote><p id="filepos971369" class="calibre12">As we showed in <a href="#filepos332652"><span class="calibre8"><span class="underline">chapter 5</span></span></a>, Clojure’s sequences are implemented as trees fanning out at increments of 32 elements per node. Therefore, chunks of size 32 are a natural fit, allowing for the garbage collection of larger chunks of memory as seen in <a href="#filepos971780"><span class="calibre8"><span class="underline">figure 12.1</span></span></a>. </p><p id="filepos971780" class="calibre5"><span class="calibre10"><span class="bold">Figure 12.1. Clojure’s chunked sequences allow a windowed view of a sequence. This model is more efficient, in that it allows for larger swaths of memory to be reclaimed by the garbage collector and better cache locality in general. There’s a cost to total laziness, but often the benefit gained is worth the cost. </span></span><a></a></p><p class="calibre1"><img src="images/00019.jpg" class="calibre127"/></p><p class="calibre5">You might be worried that chunked sequences have squashed the entire point of lazy sequences, and for small sequences this would be correct. But the benefits of lazy sequences are striking when dealing with cyclopean magnitudes or sequences larger than memory. Chunked sequences in the extreme cases are an incredible boon because not only do they make sequence functions more efficient overall, they still fulfill the promise of lazy sequences: avoiding full realization of interim results. </p><p id="filepos972808" class="calibre5"><span class="bold">12.3.1. Regaining one-at-a-time laziness </span><a></a></p><p class="calibre7">There are legitimate concerns about this chunked model, and one such concern is the desire for a one-at-a-time model to avoid exploding computations. Assuming that you have such a requirement, one counterpoint against chunked sequences is that of building an infinite sequence of Mersenne primes.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos973541"><span class="calibre33"><span class="calibre8"><span class="underline">3</span></span></span></a><span class="calibre33">]</span></small></sup> Implicit realization of the first 32 Mersenne primes through chunked sequences will finish long after the Sun has died. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos973541" class="calibre32"><span class="calibre33">3</span></small></sup><span class="calibre10"> See </span><a href="http://en.wikipedia.org/wiki/Mersenne_Primes"><span class="calibre10"><span class="calibre8"><span class="underline">http://en.wikipedia.org/wiki/Mersenne_Primes</span></span></span></a><span class="calibre10">. </span></blockquote><p class="calibre12">But you can use <tt class="calibre11">lazy-seq</tt> to create a function <tt class="calibre11">seq1</tt> that can be used to restrict (or dechunkify, if you will) a lazy sequence and enforce the one-at-a-time model, as in the following listing. </p><p id="filepos974049" class="calibre5"><span class="calibre10"><span class="bold">Listing 12.2. A dechunkifying </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">seq1</span></tt></span><span class="calibre10"><span class="bold"> function </span></span></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn seq1 [s]<br class="calibre3"/>  (lazy-seq<br class="calibre3"/>    (when-let [[x] (seq s)]<br class="calibre3"/>      (cons x (seq1 (rest s))))))<br class="calibre3"/><br class="calibre3"/>(take 1 (map gimme (seq1 (range 32))))<br class="calibre3"/>;=&gt; (.0)<br class="calibre3"/><br class="calibre3"/>(take 1 (drop 32 (map gimme (seq1 (range 64)))))<br class="calibre3"/>;=&gt; (.................................32)</tt></span></blockquote><p id="filepos974654" class="calibre12">You can again safely generate your lazy, infinite sequence of Mersenne primes. The world rejoices. But <tt class="calibre11">seq1</tt> eliminates the garbage-collection efficiencies of the chunked model and again regressed back to that shown in <a href="#filepos974986"><span class="calibre8"><span class="underline">figure 12.2</span></span></a>. </p><p id="filepos974986" class="calibre5"><span class="calibre10"><span class="bold">Figure 12.2. Using </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">seq1</span></tt></span><span class="calibre10"><span class="bold">, you can again reclaim the one-at-a-time sequence model. Though not as efficient as the chunked model, it does again provide total sequence laziness. </span></span></p><p class="calibre1"><img src="images/00020.jpg" class="calibre128"/></p><p class="calibre5">Clojure may one day provide an official API for one-at-a-time lazy sequence granularity, but for now <tt class="calibre11">seq1</tt> will suffice. We advise that you instead stick to the chunked model, because you’ll probably never notice its effects during normal usage. </p><p id="filepos975700" class="calibre5"><span class="calibre18"><span class="bold">12.4. Memoization </span></span></p><p class="calibre7">As we mentioned briefly in <a href="#filepos888278"><span class="calibre8"><span class="underline">section 11.4</span></span></a>, memoization (<a href="#filepos1079064"><span class="calibre8"><span class="underline">Michie 1968</span></span></a>) refers to storing a cache of values local to a function so that its arguments can be retrieved rather than calculated on every call. The cache is a simple mapping of a given set of arguments to a previously calculated result. In order for this to work, the memoized function <span class="italic">must</span> be referentially transparent, which we discussed in <a href="#filepos487603"><span class="calibre8"><span class="underline">section 7.1</span></span></a>. Clojure comes with a <tt class="calibre11">memoize</tt> function that can be used to build a memoized version of any referentially transparent function, as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def gcd (memoize<br class="calibre3"/>           (fn [x y]<br class="calibre3"/>             (cond<br class="calibre3"/>               (&gt; x y) (recur (- x y) y)<br class="calibre3"/>               (&lt; x y) (recur x (- y x))<br class="calibre3"/>               :else x))))<br class="calibre3"/><br class="calibre3"/>(gcd 1000645475 56130776629010010)<br class="calibre3"/>;=&gt; 215</tt></span></blockquote><p class="calibre12">Defining a “greatest common denominator” function using <tt class="calibre11">memoize</tt> helps to speed subsequent calculations using the arguments <tt class="calibre11">1000645475</tt> and <tt class="calibre11">56130776629010010</tt>. The function <tt class="calibre11">memoize</tt> wraps another function<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos978140"><span class="calibre33"><span class="calibre8"><span class="underline">4</span></span></span></a><span class="calibre33">]</span></small></sup> in a cache lookup pass-through function and returns it. This allows you to use <tt class="calibre11">memoize</tt> on literally any referentially transparent function. The operation of the <tt class="calibre11">memoize</tt> is analogous to, but not exactly the operation of Clojure’s lazy sequences that cache the results of their realized portions. This general technique can be useful, but the indiscriminate storage provided by <tt class="calibre11">memoize</tt> might not always be appropriate. Therefore, we’ll take a step back and devise a way to generalize the operation of memoization into useful abstractions and build a framework for employing caching strategies more appropriate to the domain at hand. </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos978140" class="calibre32"><span class="calibre33">4</span></small></sup><span class="calibre10"> You might’ve noticed that we explicitly bound the Var </span><span class="calibre10"><tt class="calibre11">gcd</tt></span><span class="calibre10"> to the memoization of an anonymous function but then used </span><span class="calibre10"><tt class="calibre11">recur</tt></span><span class="calibre10"> for implementing the function body. This approach suffers from the inability to cache the intermediate results (</span><a href="#filepos1079812"><span class="calibre10"><span class="calibre8"><span class="underline">Norvig 1991</span></span></span></a><span class="calibre10">) of </span><span class="calibre10"><tt class="calibre11">gcd</tt></span><span class="calibre10">. We leave the solution to this short-coming as an exercise for the reader. </span></blockquote><p id="filepos978813" class="calibre12">Similar to Haskell’s typeclasses, Clojure’s protocols define a set of signatures providing a framework of adherence to a given set of features. This section serves a threefold goal: </p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24">Discussion of memoization</li><li value="2" class="calibre24">Discussion of protocol design</li><li value="3" class="calibre24">Discussion of abstraction-oriented programming</li></ul><p id="filepos979309" class="calibre5"><span class="bold">12.4.1. Re-examining memoization </span><a></a></p><p class="calibre7">As mentioned in <a href="#filepos888278"><span class="calibre8"><span class="underline">section 11.4</span></span></a>, memoization is a personal affair, requiring a certain domain knowledge to perform efficiently and correctly. That’s not to say that the core <tt class="calibre11">memoize</tt> function is useless, only that the base case doesn’t cover all cases. In this section, we’ll define a memoization protocol in terms of the primitive operations: <tt class="calibre11">lookup, has?, hit</tt>, and <tt class="calibre11">miss</tt>. Instead of providing a memoization facility that allows the removal of individual cache items, it’s a better idea to provide one that allows for dynamic cache-handling strategies.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos980259"><span class="calibre33"><span class="calibre8"><span class="underline">5</span></span></span></a><span class="calibre33">]</span></small></sup></p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos980259" class="calibre32"><span class="calibre33">5</span></small></sup><span class="calibre10"> This section is motivated by the fantastic work of the brilliant Clojurians Meikel Brandmeyer, Christophe Grand, and Eugen Dück summarized at </span><a href="http://kotka.de/blog/2010/03/memoize_done_right.html"><span class="calibre10"><span class="calibre8"><span class="underline">http://kotka.de/blog/2010/03/memoize_done_right.html</span></span></span></a><span class="calibre10">. </span></blockquote><p id="filepos980680" class="calibre35"><span class="bold">12.4.2. A memoization protocol </span><a></a></p><p class="calibre7">The protocol for a general-purpose cache feature is provided in the following listing.</p><p id="filepos980877" class="calibre5"><span class="calibre10"><span class="bold">Listing 12.3. A protocol for caching </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defprotocol CacheProtocol<br class="calibre3"/>  (lookup  [cache e])<br class="calibre3"/>  (has?    [cache e] )<br class="calibre3"/>  (hit     [cache e])<br class="calibre3"/>  (miss    [cache e ret]))</tt></span></blockquote><p class="calibre12">The function <tt class="calibre11">lookup</tt> retrieves the item in the cache if it exists. The function <tt class="calibre11">has?</tt> will check for a cached value. The function <tt class="calibre11">hit</tt> is called when an item is found in the cache, and <tt class="calibre11">miss</tt> is called when it’s <span class="italic">not</span>. If you’re familiar with creating Java interfaces, the process of creating a protocol should be familiar. Moving on, we next implement the core <tt class="calibre11">memoize</tt> functionality. </p><p id="filepos981713" class="calibre5"><span class="calibre10"><span class="bold">Listing 12.4. A basic cache type </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(deftype BasicCache [cache]<br class="calibre3"/>  CacheProtocol<br class="calibre3"/>  (lookup [_ item]<br class="calibre3"/>    (get cache item))<br class="calibre3"/>  (has? [_ item]<br class="calibre3"/>    (contains? cache item))<br class="calibre3"/>  (hit [this item] this)<br class="calibre3"/>  (miss [_ item result]<br class="calibre3"/>    (BasicCache. (assoc cache item result))))</tt></span></blockquote><p id="filepos982226" class="calibre12">The <tt class="calibre11">BasicCache</tt> takes a <tt class="calibre11">cache</tt> on construction used for its internal operations. Testing the basic caching protocol in isolation shows: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def cache (BasicCache. {}))<br class="calibre3"/><br class="calibre3"/>(lookup (miss cache '(servo) :robot) '(servo))<br class="calibre3"/>;=&gt; :robot</tt></span></blockquote><p class="calibre12">In the case of a miss, the item to be cached is added and a new instance of <tt class="calibre11">BasicCache</tt> (with the cached entry added) is returned for retrieval using <tt class="calibre11">lookup</tt>. This is a simple model for a basic caching protocol, but not terribly useful in isolation. We can go further by creating an auxiliary function <tt class="calibre11">through</tt>, meaning in effect, “pass an element through the cache and return its value”: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn through [cache f item]<br class="calibre3"/>  (if (has? cache item)<br class="calibre3"/>    (hit cache item)<br class="calibre3"/>    (miss cache item (delay (apply f item)))))</tt></span></blockquote><p class="calibre12">With <tt class="calibre11">through</tt>, the value corresponding to a cache <tt class="calibre11">item</tt> (function arguments in this case) would either be retrieved from the cache via the <tt class="calibre11">hit</tt> function, or calculated and stored via <tt class="calibre11">miss</tt>. You’ll notice that the calculation <tt class="calibre11">(apply f item)</tt> is wrapped in a <tt class="calibre11">delay</tt> call instead of performed outright or lazily through an ad hoc initialization mechanism. The use of an explicit delay in this way helps to ensure that the value is calculated only on first retrieval. With these pieces in place, we can then create a <tt class="calibre11">PluggableMemoization</tt> type, as shown next. </p><p id="filepos983962" class="calibre5"><span class="calibre10"><span class="bold">Listing 12.5. A type implementing pluggable memoization </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(deftype PluggableMemoization [f cache]<br class="calibre3"/>  CacheProtocol<br class="calibre3"/>  (has? [_ item] (has? cache item))<br class="calibre3"/>  (hit  [this item] this)<br class="calibre3"/>  (miss [_ item result]<br class="calibre3"/>    (PluggableMemoization. f (miss cache item result)))<br class="calibre3"/>  (lookup [_ item]<br class="calibre3"/>    (lookup cache item)))</tt></span></blockquote><p class="calibre12">The purpose of the <tt class="calibre11">PluggableMemoization</tt> type is to act as a delegate to an underlying implementation of a <tt class="calibre11">CacheProtocol</tt> occurring in the implementations for <tt class="calibre11">hit, miss</tt>, and <tt class="calibre11">lookup</tt>. Likewise, the <tt class="calibre11">PluggableMemoization</tt> delegation is interposed at the protocol points to ensure that when utilizing the <tt class="calibre11">CacheProtocol</tt>, the <tt class="calibre11">Pluggable-Memoization</tt> type is used and not the <tt class="calibre11">BasicCache</tt>. We’ve made a clear distinction between a caching protocol fulfilled by <tt class="calibre11">BasicCache</tt> and a concretized memoization fulfilled by <tt class="calibre11">PluggableMemoization</tt> and <tt class="calibre11">through</tt>. With the creation of separate abstractions, you can use the appropriate concrete realization in its proper context. Clojure programs will be composed of various abstractions. In fact, the term <span class="italic">abstraction-oriented programming</span> is used to describe Clojure’s specific philosophy of design. </p><p class="calibre5">The original <tt class="calibre11">manipulable-memoize</tt> function from <a href="#filepos888278"><span class="calibre8"><span class="underline">section 11.4</span></span></a> is modified in the following listing to conform to our memoization cache realization. </p><p id="filepos985718" class="calibre5"><span class="calibre10"><span class="bold">Listing 12.6. A function for applying pluggable memoization to a function </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn memoization-impl [cache-impl]<br class="calibre3"/>  (let [cache (atom cache-impl)]<br class="calibre3"/>    (with-meta<br class="calibre3"/>      (fn [&amp; args]<br class="calibre3"/>        (let [cs (swap! cache through (.f cache-impl) args)]<br class="calibre3"/>          @(lookup cs args)))<br class="calibre3"/>      {:cache cache})))</tt></span></blockquote><p id="filepos986264" class="calibre12">If you’ll recall from the implementation of the <tt class="calibre11">through</tt> function, we stored delay objects in the cache requiring they be deferenced when looked up. Returning to our old friend the <tt class="calibre11">slowly</tt> function, we can exercise the new memoization technique as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def slowly (fn [x] (Thread/sleep 3000) x))<br class="calibre3"/>(def sometimes-slowly (memoization-impl<br class="calibre3"/>                        (PluggableMemoization.<br class="calibre3"/>                          slowly<br class="calibre3"/>                          (BasicCache. {}))))<br class="calibre3"/><br class="calibre3"/>(time [(sometimes-slowly 108) (sometimes-slowly 108)])<br class="calibre3"/>; "Elapsed time: 3001.611 msecs"<br class="calibre3"/>;=&gt; [108 108]<br class="calibre3"/><br class="calibre3"/>(time [(sometimes-slowly 108) (sometimes-slowly 108)])<br class="calibre3"/>; "Elapsed time: 0.049 msecs"<br class="calibre3"/>;=&gt; [108 108]</tt></span></blockquote><p class="calibre12">You can now fulfill your personalized memoization needs by implementing pointed realizations of <tt class="calibre11">CacheProtocol</tt>, plugging them into instances of <tt class="calibre11">PluggableMemoization</tt>, and applying them as needed via function redefinition, higher-order functions, or dynamic binding. Countless caching strategies can be used to better support your needs, each displaying different characteristics, or if needed your problem may call for something wholly new. </p><p class="calibre5">We’ve only scratched the surface of memoization in this section in favor of providing a more generic substrate on which to build your own memoization strategies. Using Clojure’s abstraction-oriented programming techniques, your own programs will likewise be more generic and be built largely from reusable parts. </p><p id="filepos988109" class="calibre5"><span class="calibre18"><span class="bold">12.5. Understanding coercion </span></span></p><p class="calibre7">Although Clojure is a dynamically typed language, it does provide mechanisms for specifying value types. The first of these mechanisms, type hints, was covered in <a href="#filepos954781"><span class="calibre8"><span class="underline">section 12.1</span></span></a>. The second, <span class="italic">coercion</span>, is the subject of this section. Although the nature of type hints and coercion are similar, their intended purposes are quite different. In the case of coercion, its purpose is to get at the primitive data type for a value, which we’ll show next. </p><p id="filepos988746" class="calibre5"><span class="bold">12.5.1. First rule of coercion: don’t </span><a></a></p><p id="filepos988832" class="calibre7">Clojure’s compiler is sophisticated enough that in many ways it’ll be unnecessary to coerce values into primitives. It’s often better to start with a function or code block devoid of coercions. Unless your specific application requires the utmost speed in execution, it’s better to stick with the version that favors simplicity over the alternative. But should you decide that coercion might be the choice for you, then this section will provide guidance. </p><p id="filepos989329" class="calibre5"><span class="bold">12.5.2. Corollary: you’re probably not doing it right </span><a></a></p><p class="calibre7">If you’ve determined that coercion can help, then it’s worth stressing that you have to be careful when going down that road. In many cases with coercion, the act of adding it can actually <span class="italic">slow</span> your functions. The reason lies in the nature of Clojure. Functional composition leads to passing arguments back and forth between pieces, and in the circumstance of coercion you’re just boxing and unboxing<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos990635"><span class="calibre33"><span class="calibre8"><span class="underline">6</span></span></span></a><span class="calibre33">]</span></small></sup> from one call to the next. This particular circumstance is especially devious within the body of a loop, and follows the same performance degradations observed with Java. Clojure’s unboxing is an explicit<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos990897"><span class="calibre33"><span class="calibre8"><span class="underline">7</span></span></span></a><span class="calibre33">]</span></small></sup> operation performed using the coercion functions, so there’s a speck of light there. Unfortunately, autoboxing is still a danger and should be avoided if speed is a concern, as we’ll explore now: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos990635" class="calibre32"><span class="calibre33">6</span></small></sup><span class="calibre10"> Autoboxing is the automatic conversion the Java compiler makes between the primitive types and their corresponding object wrapper classes. </span></blockquote><blockquote class="calibre39"><sup class="calibre31"><small id="filepos990897" class="calibre32"><span class="calibre33">7</span></small></sup><span class="calibre10"> Except when directly or indirectly (via inlining or a macro body) calling a method. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn occur-count [words]<br class="calibre3"/>  (let [res (atom {})]<br class="calibre3"/>    (doseq [w words] (swap! res assoc w (+ 1 (@res w 0))))<br class="calibre3"/>    @res))<br class="calibre3"/><br class="calibre3"/>(defn roll [n d]<br class="calibre3"/>  (reduce + (take n (repeatedly #(inc (rand-int d))))))<br class="calibre3"/><br class="calibre3"/>(time (dorun (occur-count (take 1000000 (repeatedly #(roll 3 6))))))<br class="calibre3"/>; "Elapsed time: 4055.505 msecs"</tt></span></blockquote><p class="calibre12">The function <tt class="calibre11">occur-count</tt> will return a map of the occurrence counts<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos992270"><span class="calibre33"><span class="calibre8"><span class="underline">8</span></span></span></a><span class="calibre33">]</span></small></sup> found in a given sequence. This fairly straightforward implementation uses the function <tt class="calibre11">roll</tt> to populate a sequence with a million simulated rolls of three six-sided dice. But four seconds seems like a long time to wait, so perhaps we can speed things up by using coercions. An initial attempt to gain speed may be to pull out the stored count from the table and coerce it into an <tt class="calibre11">int</tt>: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos992270" class="calibre32"><span class="calibre33">8</span></small></sup><span class="calibre10"> Clojure has a function </span><span class="calibre10"><tt class="calibre11">frequencies</tt></span><span class="calibre10"> that does this, so we provide </span><span class="calibre10"><tt class="calibre11">occur-count</tt></span><span class="calibre10"> for illustrative purposes only. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn occur-count [words]<br class="calibre3"/>  (let [res (atom {})]<br class="calibre3"/>    (doseq [w words]<br class="calibre3"/>      (let [v (int (@res w 0))]<br class="calibre3"/>        (swap! res assoc w (+ 1 v))))<br class="calibre3"/>    @res))<br class="calibre3"/>(time (dorun (occur-count (take 1000000 (repeatedly #(roll 3 6))))))<br class="calibre3"/>; "Elapsed time: 4385.8 msecs"</tt></span></blockquote><p id="filepos993007" class="calibre12">Well, that didn’t work. The reason for a decrease in speed is that although we’re specifying the type at the outer loop, we haven’t reduced the need to box and unbox that value further downstream in the <tt class="calibre11">roll</tt> function. We might then be led to try and optimize the <tt class="calibre11">roll</tt> function too: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn roll [n d]<br class="calibre3"/>  (let [p (int d)]<br class="calibre3"/>    (reduce + (take n (repeatedly #(inc (rand-int p)))))))<br class="calibre3"/><br class="calibre3"/>(time (dorun (occur-count (take 1000000 (repeatedly #(roll 3 6))))))<br class="calibre3"/>; "Elapsed time: 4456.393 msecs"<br class="calibre3"/>;=&gt; nil</tt></span></blockquote><p class="calibre12">Again we’ve made matters worse and have spread the problems over the surface of the entire code. Being adventurous, we grasp for straws and attempt to force integer arithmetic with <tt class="calibre11">roll</tt> by using the <tt class="calibre11">unchecked-inc</tt> function: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn roll [n d]<br class="calibre3"/>  (let [p (int d)]<br class="calibre3"/>    (reduce + (take n (repeatedly #(unchecked-inc (rand-int p)))))))<br class="calibre3"/><br class="calibre3"/>(time (dorun (occur-count (take 1000000 (repeatedly #(roll 3 6))))))</tt></span></blockquote><p class="calibre12">Go ahead and run that in the REPL, then go get some coffee and a bagel. Toast the bagel. Eat the bagel. Drink the coffee. By that time, you might’ve received a result. </p><p class="calibre5">So what happened? In an attempt to be clever, we’ve confused the Clojure compiler into near unconsciousness. Instead of making direct calls to Clojure’s math functions, we’re now making calls indirectly via Java reflection! You can observe this by setting <tt class="calibre11">*warn-on-reflection*</tt> to <tt class="calibre11">true</tt> and reentering <tt class="calibre11">roll</tt>. </p><p class="calibre5">How can we speed things up? The problem isn’t with coercion itself, but instead with the implementations of <tt class="calibre11">roll</tt> and <tt class="calibre11">occur-count</tt>. You can observe significant speed-ups by rethinking your original implementations <span class="italic">first</span> and then resorting to coercion second. The use of coercion should <span class="italic">always</span> be preceded by a reevaluation of your implementation, because often by doing so you can eliminate the need for coercion altogether, as shown next. </p><p id="filepos995383" class="calibre5"><span class="calibre10"><span class="bold">Listing 12.7. Using coercion to gain speed </span></span><a></a></p><p class="calibre1"><img src="images/00088.jpg" class="calibre129"/></p><p id="filepos995611" class="calibre5">By refactoring the original functions, we’ve gained a five-fold increase in speed and yet used only a single coercion. Additionally, we’ve managed to make the new implementation faster while also maintaining clarity. This should be a general goal when writing your Clojure code, and when forced to make a trade between the two, it might be a good idea to favor clarity. </p><p id="filepos996017" class="calibre5"><span class="bold">12.5.3. Second rule of coercion: don’t </span><a></a></p><p class="calibre7">In the previous example, there’s too much noise in collection and sequence operations for primitive coercion to help much. This goes to show that it’s important to remember that the Clojure compiler will often do a better job at optimization than you. </p><p id="filepos996393" class="calibre5"><span class="bold">12.5.4. Third rule of coercion: coerce a stable local </span><a></a></p><p class="calibre7">When coercing a local to a primitive type, it’s tempting to do so at the point of use, but this practice should be avoided. A good rule of thumb for coercion is to coerce only within a local context via <tt class="calibre11">let, binding</tt>, or <tt class="calibre11">loop</tt>. This provides a stable value point for the primitive, allowing you to reuse that same local elsewhere in the same function without having to again coerce at different points of use. This can be illustrated by the following: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn mean<br class="calibre3"/>  "Takes a sequence of integers and returns their mean value"<br class="calibre3"/>  [sq]<br class="calibre3"/>  (let [length (int (count sq))]<br class="calibre3"/>    (if (zero? length)<br class="calibre3"/>      0<br class="calibre3"/>      (/ (int (reduce + sq)) length))))</tt></span></blockquote><p class="calibre12">The <tt class="calibre11">length</tt> value has been bound in the <tt class="calibre11">let</tt>, allowing it to be reused twice within the body of the function. This allows for a cleaner implementation than the alternative, which coerces the results of <tt class="calibre11">(count sq)</tt> in multiple places. Using this advice and the fact that Clojure provides lexical scope by default, you can also avoid the need to define a name-mangled local by instead using <tt class="calibre11">let</tt> to rebind original argument names to coerced values <tt class="calibre11">(defn [x] (let [x (int x)] ...))</tt>. </p><p id="filepos997905" class="calibre5"><span class="bold">12.5.5. Fourth rule of coercion: watch your sizes </span><a></a></p><p class="calibre7">Primitive type coercions in Clojure act the same as type truncation in Java. If a given value is coerced into a type that can’t hold a value of its magnitude, then data loss will occur, and in the case of integer overflow, exceptions will be thrown. </p><p id="filepos998286" class="calibre5"><span class="bold">12.5.6. Fifth rule of coercion: truncate only as a goal </span><a></a></p><p class="calibre7">By default, Clojure doesn’t limit the accuracy of mathematical operations, but this can occur when using coercion. There will be many instances in your own projects when speed is more important than accuracy in mathematical operations. Likewise, there will also be times when truncation is necessary, especially when dealing with Java library methods that take primitive types: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(Math/round 1.23897398798929929872987890030893796768727987138M)<br class="calibre3"/>; java.lang.IllegalArgumentException:<br class="calibre3"/>;   No matching method found: round</tt></span></blockquote><p id="filepos999044" class="calibre12">When a method or function isn’t overloaded, the Clojure compiler can determine whether an argument can be coerced to a primitive type and will do so if able. The preceding issue exception arises from the fact that <tt class="calibre11">Math/round</tt> is overloaded, taking either a float or double typed argument. Therefore, you have to explicitly use coercion to truncate the argument: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(Math/round (float 1.23897398798929929872987890030893796768727987138M))<br class="calibre3"/>;=&gt; 1</tt></span></blockquote><p class="calibre12">Our goal in using the truncating operation <tt class="calibre11">float</tt> was to get a result that we knew wouldn’t be affected by truncation. But many instances will arise when truncation will affect your results and will often do so to your detriment. Therefore, it’s best to be wary when using coercion, because it propagates inaccuracies. It’s best to limit its usage when truncation is desired and document vigorously when it’s absolutely needed for speed. </p><p class="calibre5">Coercion can be an effective tool in your Clojure applications, but take care to be sure you understand the caveats. If you take away one lesson from this section, let it be this: <span class="italic">do not rush to coercion.</span></p><p id="filepos1000351" class="calibre5"><span class="calibre18"><span class="bold">12.6. Summary </span></span></p><p class="calibre7">Clojure provides numerous ways to gain speed in your applications. Using some combination of type hints, transients, chunked sequences, memoization, and coercion, you should be able to achieve noticeable performance gains. Like any powerful tool, these performance techniques should be used cautiously and thoughtfully. But once you’ve determined that performance can be gained, their use is minimally intrusive and often natural to the unadorned implementation. </p><p class="calibre5">In the final chapter, we’ll cover a number of ways that the Clojure way of thinking might be different from what you’re accustomed to. The discussion therein, when explored with an open mind, will change the way that you write software. </p><div class="mbppagebreak"></div><p id="filepos1001213" class="calibre5"><span class="calibre6"><span class="bold">Chapter 13. Clojure changes the way you think </span></span><a></a></p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre30"><span class="bold">This chapter covers</span>
</p><div class="calibre22"> </div><ul class="calibre23"><li value="1" class="calibre24"><a href="#filepos1003593"><span class="calibre8"><span class="underline">DSLs</span></span></a></li><a id="filepos1001639"></a><li value="2" class="calibre24"><a href="#filepos1021032"><span class="calibre8"><span class="underline">Testing</span></span></a></li><li value="3" class="calibre24"><a href="#filepos1036349"><span class="calibre8"><span class="underline">A lack of design patterns</span></span></a></li><li value="4" class="calibre24"><a href="#filepos1045484"><span class="calibre8"><span class="underline">Error handling and debugging</span></span></a></li><li value="5" class="calibre24"><a href="#filepos1065349"><span class="calibre8"><span class="underline">Fare thee well</span></span></a></li></ul><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">In this final chapter, we cover some tangential topics that you might already be familiar with, but perhaps not from a Clojure perspective. Our discussion will start with domain-specific languages (DSLs) and the unique way that Clojure applications are built from a layering of unique application-specific DSLs. Next, you’re unlikely to be ignorant of the general push toward a test-driven development (TDD) philosophy, with a special focus on unit testing. We’ll explore why Clojure is especially conducive to unit testing and why it’s often unnecessary. Next, whether you agree with the cult of design patterns or not, it’s inarguable that patterns have changed the way that object-oriented software is designed and developed. The classical design patterns are often invisible, or at times outright nonexistent in Clojure <a id="filepos1003113"></a>code, which we’ll discuss in this chapter. As we’ll then show, error handling in Clojure flows in two directions: from inner functions to outer via exceptions, and from outer functions in via dynamic bindings. Finally, we’ll explore how having the entire language at your disposal can help to change the way that your debugging occurs. We hope that by the time you’ve finished this chapter, you’ll agree—Clojure changes the way you think about programming. </p><p id="filepos1003593" class="calibre5"><span class="calibre18"><span class="bold">13.1. DSLs </span></span></p><blockquote class="calibre9"><span class="italic">Lisp is not the right language for any particular problem. Rather, Lisp encourages one to attack a new problem by implementing new languages tailored to that problem.</span></blockquote><blockquote class="calibre25"><span class="italic">“Lisp: A Language for Stratified Design” (</span><a href="#filepos1067987"><span class="italic"><span class="calibre8"><span class="underline">Abelson 1988</span></span></span></a><span class="italic">)</span></blockquote><p class="calibre5">In <a href="#filepos582816"><span class="calibre8"><span class="underline">chapter 8</span></span></a>, we explored the notion of a domain-specific language for describing domains. This meta-circularity, while playful, was meant to make a subtle point: Clojure blurs, and often obliterates, the line between DSL and API. When a language is built from the same data structures that the language itself manipulates, it’s known as <span class="italic">homoiconic</span> (<a href="#filepos1079179"><span class="calibre8"><span class="underline">Mooers 1965</span></span></a>). When a programming language is homoiconic, it’s simple to mold the language into a form that bridges the gap between the problem and solution domains. When designing DSLs in Clojure, it’s important to determine when the existing language facilities will suffice (<a href="#filepos1081305"><span class="calibre8"><span class="underline">Raymond 2003</span></span></a>) and when it’s appropriate to create one from whole cloth (<a href="#filepos1072363"><span class="calibre8"><span class="underline">Ghosh 2010</span></span></a>). In this section we’ll do both and provide a little discussion about each. </p><p id="filepos1005162" class="calibre5"><span class="bold">13.1.1. A ubiquitous DSL </span><a></a></p><p class="calibre7">The declarative language SQL is among the most widespread DSLs in use today. In <a href="#filepos127062"><span class="calibre8"><span class="underline">section 1.2</span></span></a> we showed a simple Clojure DSL, which provided a simple subset of the <tt class="calibre11">SELECT</tt> statement that created a representational SQL string. Though that particular example was meant to be instructive, Clojure provides a comprehensive library for relational algebra, on which SQL is based (<a href="#filepos1070750"><span class="calibre8"><span class="underline">Date 2009</span></span></a>). Imagine a dataset of the following: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def artists<br class="calibre3"/>  #{{:artist "Burial"  :genre-id 1}<br class="calibre3"/>    {:artist "Magma"   :genre-id 2}<br class="calibre3"/>    {:artist "Can"     :genre-id 3}<br class="calibre3"/>    {:artist "Faust"   :genre-id 3}<br class="calibre3"/>    {:artist "Ikonika" :genre-id 1}<br class="calibre3"/>    {:artist "Grouper"}})<br class="calibre3"/><br class="calibre3"/>(def genres<br class="calibre3"/>  #{{:genre-id 1 :genre-name "Dubstep"}<br class="calibre3"/>    {:genre-id 2 :genre-name "Zeuhl"}<br class="calibre3"/>    {:genre-id 3 :genre-name "Prog"}<br class="calibre3"/>    {:genre-id 4 :genre-name "Drone"}})</tt></span></blockquote><p class="calibre12">You can try Clojure’s relational functions by entering the examples shown in the following listing.</p><p id="filepos1006584" class="calibre5"><span class="calibre10"><span class="bold">Listing 13.1. Examples of Clojure’s relational algebra functions </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(require '[clojure.set :as ra])<br class="calibre3"/>(def ALL identity)<br class="calibre3"/><br class="calibre3"/>(ra/select ALL genres)<br class="calibre3"/>;=&gt; #{{:genre-id 4, :genre-name "Drone"}<br class="calibre3"/>       {:genre-id 3, :genre-name "Prog"}<br class="calibre3"/>       {:genre-id 2, :genre-name "Zeuhl"}<br class="calibre3"/>       {:genre-id 1, :genre-name "Dubstep"}}<br class="calibre3"/><br class="calibre3"/>(ra/select #(#{1 3} (:genre-id %)) genres)<br class="calibre3"/>;=&gt; #{{:genre-id 3, :genre-name "Prog"}<br class="calibre3"/>       {:genre-id 1, :genre-name "Dubstep"}}<br class="calibre3"/><br class="calibre3"/>(take 2 (ra/select ALL (ra/join artists genres)))<br class="calibre3"/>;=&gt; #{{:artist "Burial",  :genre-id 1, :genre-name "Dubstep"}<br class="calibre3"/>      {:artist "Magma",   :genre-id 2, :genre-name "Zeuhl"}}</tt></span></blockquote><p id="filepos1007562" class="calibre12">The relational functions in <tt class="calibre11">clojure.set</tt> are a perfect example of the way that Clojure blurs the line between API and DSL. No macro tricks are involved, but through the process of functional composition, the library provides a highly expressive syntax matching closely (<a href="#filepos1068343"><span class="calibre8"><span class="underline">Abiteboul 1995</span></span></a>) that of SQL itself. Though you might be tempted to create a custom query language for your own application(s), there are times when the relational functions are exactly what you need. Your time might be better spent solving actual problems, one of which we’ll cover in the following section. </p><p id="filepos1008242" class="calibre5"><span class="bold">13.1.2. Putting parentheses around the specification </span><a></a></p><p class="calibre7">Many applications deal in measurements of differing units. For example, it’s widely known that the U.S. works almost exclusively in English units of measure, whereas most of the rest of the planet works in SI, or metric units. To convert<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos1008928"><span class="calibre33"><span class="calibre8"><span class="underline">1</span></span></span></a><span class="calibre33">]</span></small></sup> from one to the other isn’t an arduous task and can be handled easily with a set of functions of this general form: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos1008928" class="calibre32"><span class="calibre33">1</span></small></sup><span class="calibre10"> A spectacular general-purpose JVM language named Frink excels at conversions of many different units. We highly advocate exploring Frink at your next available opportunity: </span><a href="http://futureboy.us/frinkdocs/"><span class="calibre10"><span class="calibre8"><span class="underline">http://futureboy.us/frinkdocs/</span></span></span></a><span class="calibre10">. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn meters-&gt;feet [m] (* m 3.28083989501312))<br class="calibre3"/>(defn meters-&gt;miles [m] (* m 0.000621))<br class="calibre3"/><br class="calibre3"/>(meters-&gt;feet 1609.344)<br class="calibre3"/>;=&gt; 5279.9999999999945<br class="calibre3"/><br class="calibre3"/>(meters-&gt;miles 1609.344)<br class="calibre3"/>;=&gt; 0.999402624</tt></span></blockquote><p class="calibre12">This approach will certainly work if only a few functions define the extent of your conversion needs. But if your applications are like ours, then you probably need to convert to and from differing units of measure of many different magnitudes. You may also need to convert back and forth between units of time, dimension, orientation, and a host of others. Therefore it’d be nice to be able to write a specification of unit conversions (<a href="#filepos1075419"><span class="calibre8"><span class="underline">Hoyte 2008</span></span></a>) as a Clojure DSL and use its results as a low-level layer <a id="filepos1010279"></a>for high-layer application specifics. This is precisely the nature of Lisp development in general—each level in an application provides the primitive abstractions for the levels above it. </p><p class="calibre5">In this section, we’re going to create a small specification and then convert it into a Clojure DSL using a technique coined by Rainer Joswig as “putting parentheses around the specification.” </p><p class="calibre5"><span class="calibre10"><span class="bold">Defunits </span></span></p><p class="calibre7">An ideal representation for a unit-conversion specification language would be simple:</p><blockquote class="calibre9"><span class="italic">Our base unit of distance is the meter. There are 1,000 meters in a kilometer. There are 100 centimeters in a meter. There are 10 millimeters in a centimeter. There are 3.28083 feet in a meter. And finally, there are 5,280 feet in a mile.</span></blockquote><p class="calibre5">Of course, to make sense of free text is a huge task in any language, so it behooves us to change it so that it’s easier to reason about programmatically, but not so much that it’s cumbersome for someone attempting to describe unit conversions. As a first pass, we’ll try to group the most obvious parts using some Clojure syntactical elements: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(Our base unit of distance is the :meter<br class="calibre3"/>  [There are 1000 :meters in a :kilometer]<br class="calibre3"/>  [There are 100 :centimeters in a :meter]<br class="calibre3"/>  [There are 10 :millimeters in a :centimeter]<br class="calibre3"/>  [There are 3.28083 :feet in a :meter]<br class="calibre3"/>  [There are 5280 :feet in a :mile])</tt></span></blockquote><p class="calibre12">This specification is starting to look a little like Clojure code, but it would still be difficult to parse this into a usable form. Likewise, it’ll be difficult for the person writing the specification to use the correct terms, avoid spelling mistakes, properly punctuate, and so forth. In a word, this form is still not useful. It’d be ideal if we could make this into a form that’s still recognizable to both Clojure <span class="italic">and</span> a conversion expert. We’ll try one more time: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(define unit of distance<br class="calibre3"/>  {:m 1,<br class="calibre3"/>   :km 1000,<br class="calibre3"/>   :cm 1/100,<br class="calibre3"/>   :mm [1/10 of a :cm],<br class="calibre3"/>   :ft 0.3048,<br class="calibre3"/>   :mile [is 5280 :ft]})</tt></span></blockquote><p class="calibre12">This <span class="italic">almost</span> looks like Clojure source code, except for a few minor details. We’ve changed the measure of feet from an “in a” relationship to a relative one with regard to the meter base unit. Also, a vector indicates the use of a different relative unit, keeping the DSL regular in its meaning between one conversion and the next and providing a way to describe intermediate relative units of measure. Those definitions look like a map, so we should write a utility function that takes a unit and a map like the preceding one and returns the number of units it takes to compose the base unit. </p><p id="filepos1013436" class="calibre5"><span class="calibre10"><span class="bold">Listing 13.2. A function for calculating compositional units of a base unit </span></span><a></a></p><p class="calibre1"><img src="images/00098.jpg" class="calibre130"/></p><p id="filepos1013697" class="calibre5">The function <tt class="calibre11">relative-units</tt> goes through the map <tt class="calibre11">units</tt> looking up units and multiplying their compositional values. When it finds an indirect specification (such as millimeters defined in terms of centimeters), it traverse the chain of indirect references multiplying the factors along the way, as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(relative-units :m {:m 1 :cm 100 :mm [10 :cm]})<br class="calibre3"/>;=&gt; 1<br class="calibre3"/><br class="calibre3"/>(relative-units :cm {:m 1 :cm 100 :mm [10 :cm]})<br class="calibre3"/>;=&gt; 100<br class="calibre3"/><br class="calibre3"/>(relative-units :mm {:m 1 :cm 100 :mm [10 :cm]})<br class="calibre3"/>;=&gt; 1000</tt></span></blockquote><p class="calibre12">We changed the unit conversions map to remove the natural language phrase “in a,” because English isn’t good for a DSL. Natural language often lacks the precision that a simple yet regular form has. Now that we have the auxiliary function created, we’d like to create a macro to interpret the unit specification as shown: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defunits-of distance :m<br class="calibre3"/>  :km 1000<br class="calibre3"/>  :cm 1/100<br class="calibre3"/>  :mm [1/10 :cm]<br class="calibre3"/>  :ft 0.3048<br class="calibre3"/>  :mile [5280 :ft])</tt></span></blockquote><p class="calibre12">This is a simplification versus the original verbal form of the conversion specification. This final form is indubitably more conducive to parsing, yet doesn’t appreciably sacrifice readability. The implementation of the <tt class="calibre11">defunits-of</tt> macro is presented in the following listing. </p><p id="filepos1015317" class="calibre5"><span class="calibre10"><span class="bold">Listing 13.3. A </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">defunits-of</span></tt></span><span class="calibre10"><span class="bold"> macro </span></span></p><p class="calibre1"><img src="images/00065.jpg" class="calibre131"/></p><p id="filepos1015603" class="calibre5">The macro <tt class="calibre11">defunits-of</tt> is different than any macro that you’ve seen thus far, but it’s typical for macros that expand into another macro definition. In this book you’ve yet to see a macro that builds another macro and uses multiple levels of nested<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos1016541"><span class="calibre33"><span class="calibre8"><span class="underline">2</span></span></span></a><span class="calibre33">]</span></small></sup> syntax-quotes. You won’t likely see macros of this complexity often, but in this case we use nested syntax-quotes so that we can feed structures from the inner layers of the nested macros to the outer layers, processing each fully before proceeding. At this point, we can now run a call to the <tt class="calibre11">defunits-of</tt> macro with the simplified metric to English units conversion specification to define a new macro named <tt class="calibre11">unit-of-distance</tt>: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos1016541" class="calibre32"><span class="calibre33">2</span></small></sup><span class="calibre10"> We talked briefly about making sense out of nested syntax-quotes in </span><a href="#filepos588357"><span class="calibre10"><span class="calibre8"><span class="underline">section 8.1</span></span></span></a><span class="calibre10">. However, you’re not likely to need them very often. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(unit-of-distance 1 :m)<br class="calibre3"/>;=&gt; 1<br class="calibre3"/><br class="calibre3"/>(unit-of-distance 1 :mm)<br class="calibre3"/>;=&gt; 1/1000<br class="calibre3"/><br class="calibre3"/>(unit-of-distance 1 :ft)<br class="calibre3"/>;=&gt; 0.3048<br class="calibre3"/><br class="calibre3"/>(unit-of-distance 1 :mile)<br class="calibre3"/>;=&gt; 1609.344</tt></span></blockquote><p class="calibre12">Perfect! Everything is relative to the base unit <tt class="calibre11">:m</tt>, just as we’d like (read as “how many meters are in a _”). The generated macro <tt class="calibre11">unit-of-distance</tt> allows you to work in your given system of measures relative to a standard system without loss of precision or the need for a bevy of awkward conversion functions. To calculate the distance a home run hit by the Orioles’ Matt Wieters travels in Canada is a simple call to <tt class="calibre11">(unit-of-distance 441 :ft)</tt> away. The expansion of the <tt class="calibre11">distance</tt> specification given as <tt class="calibre11">(defunits-of distance :m ...)</tt> looks approximately like the following: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defmacro unit-of-distance [G__43 G__44]<br class="calibre3"/>  `(* ~G__43<br class="calibre3"/>     (case ~G__44<br class="calibre3"/>       :mile 1609.344<br class="calibre3"/>       :km 1000<br class="calibre3"/>       :cm 1/100<br class="calibre3"/>       :m 1<br class="calibre3"/>        :mm 1/1000<br class="calibre3"/>       :ft 0.3048)))</tt></span></blockquote><p class="calibre12">The <tt class="calibre11">defunits-of</tt> macro is an interpreter of the unit-conversion DSL, which generates another macro <tt class="calibre11">unit-of-distance</tt> that performs a straightforward lookup of relative unit values. Amazingly, the expansion given by <tt class="calibre11">(macroexpand '(unit-of-distance 1:cm))</tt> is that of a simple multiplication <tt class="calibre11">(* 1 1/100)</tt>. This is an awe-inspiring revelation. What we’ve managed to achieve is to fuse the notion of compilation and evaluation <a id="filepos1018721"></a>by writing a relative units of measure “mini-language” that’s interpreted into a simple multiplication at compile time! </p><p class="calibre5">This is nothing new; Lisp programmers have known about this technique for decades, but it never ceases to amaze. There’s one downside to our implementation—it allows for circular conversion specifications (seconds defined in terms of minutes, which are then defined in terms of seconds), but this can be identified and handled in <tt class="calibre11">relative-units</tt> if you’re so inclined. </p><p id="filepos1019273" class="calibre5"><span class="bold">13.1.3. A note about Clojure’s approach to DSLs </span><a></a></p><p class="calibre7">DSLs and control structures implemented as macros in Common Lisp tend to be written in a style more conducive to macro writers. But Clojure macros such as <tt class="calibre11">defunitof, cond</tt>, and <tt class="calibre11">case</tt> are idiomatic in their minimalism; their component parts are paired and meant to be grouped through proper spacing. Clojure macro writers should understand that the proliferation and placement of parentheses are legitimate concerns for some, and as a result you should strive to reduce the number whenever possible. Why would you explicitly group your expressions when their groupings are only a call to <tt class="calibre11">partition</tt> away? </p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><p class="calibre28"><span class="calibre10"><span class="bold">Clojure Aphorism</span></span></p><p class="calibre5">If a project elicits a sense of being lost, then start from the bottom up.</p><br class="calibre3"/><table border="1" valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16">
</td></tr></table><br class="calibre3"/><p class="calibre7">DSLs are an important part of a Clojure programmer’s toolset and stem from a long Lisp tradition. When Paul Graham talks about “bottom-up programming” in his perennial work <span class="italic">On Lisp</span>, this is what he’s referring to. In Clojure, it’s common practice to start by defining and implementing a low-level language specifically for the levels above. Creating complex software systems is hard, but using this approach, you can build the complicated parts out of smaller, simpler pieces. </p><p class="calibre5">Clojure changes the way that you think.</p><p id="filepos1021032" class="calibre5"><span class="calibre18"><span class="bold">13.2. Testing </span></span></p><p class="calibre7">Object-oriented programs can be highly complicated beasts to test properly, thanks to mutating state coupled with the need to test across class hierarchies. Programs are a vast tapestry of interweaving execution paths, and to test each path comprehensively is difficult, if not impossible. In the face of unrestrained mutation, the execution paths are overlaid with mutation paths, further adding to the chaos. Conversely, Clojure programs tend to be compositions of pure functions with isolated pools of mutation. The result of this approach helps to foster an environment conducive to unit testing. But though the layers of an application are composed of numerous functions, each individually and compositionally tested, the layers themselves and the wiring between them must also be tested. </p><p class="calibre5">Test-driven development (<a href="#filepos1069282"><span class="calibre8"><span class="underline">Beck 2002</span></span></a>) has conquered the software world, and at its core it preaches that test development should drive the architecture of the overall application. Unfortunately, this approach isn’t likely to bear fruit in your Clojure <a id="filepos1022273"></a>programs. Instead, Clojure provides the foundation for a contracts-based program specification that’s more amenable for writing correct programs. But before we discuss contracts, we’ll touch on the ways Clojure facilitates one part of TDD, unit testing. </p><p id="filepos1022542" class="calibre5"><span class="bold">13.2.1. Some useful techniques </span><a></a></p><p class="calibre7">We don’t want to disparage test-driven development, because its goals are virtuous and testing in general is essential. Because Clojure programs are organized using namespaces, and they are themselves aggregations of functions, often pure, the act of devising a unit-test suite at the namespace boundary is often mechanical in its directness. From a larger perspective, devising comprehensive test strategies is the subject of numerous volumes and therefore outside of the scope of this book; but there are a few Clojure-specific techniques that we wish to discuss. </p><p class="calibre5"><span class="calibre10"><span class="bold">Using With-Var-Root to Stub </span></span></p><p class="calibre7"><span class="italic">Stubbing</span> (<a href="#filepos1085684"><span class="calibre8"><span class="underline">Fowler 2007</span></span></a>) is the act of supplying an imitation implementation of a function for testing purposes. One mechanism that can perform this stubbing is the <tt class="calibre11">with-redefs</tt> macro implemented in the following listing. Though this exact macro will likely be included in future versions of Clojure, it’s not in Clojure 1.2, so a definition is provided. </p><p id="filepos1023771" class="calibre5"><span class="calibre10"><span class="bold">Listing 13.4. Macro to aid in mocking </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn with-redefs-fn [binding-map func &amp; args]<br class="calibre3"/>  (let [root-bind (fn [m]<br class="calibre3"/>                    (doseq [[a-var a-val] m] (.bindRoot a-var a-val)))<br class="calibre3"/>        old-vals (zipmap (keys binding-map)<br class="calibre3"/>                          (map deref (keys binding-map)))]<br class="calibre3"/>    (try<br class="calibre3"/>      (root-bind binding-map)<br class="calibre3"/>      (apply func args)<br class="calibre3"/>      (finally<br class="calibre3"/>        (root-bind old-vals)))))<br class="calibre3"/><br class="calibre3"/>(defmacro with-redefs [bindings &amp; body]<br class="calibre3"/>  `(with-redefs-fn ~(zipmap (map #(list `var %) (take-nth 2 bindings))<br class="calibre3"/>                            (take-nth 2 (next bindings)))<br class="calibre3"/>                   (fn [] ~@body)))</tt></span></blockquote><p class="calibre12">The function <tt class="calibre11">rss-children</tt> from <a href="#filepos906634"><span class="calibre8"><span class="underline">section 11.6</span></span></a> parses a Twitter RSS2 feed, returning a sequence of the top-level feed elements. Testing functions that rely on <tt class="calibre11">rss-children</tt> is futile against live Twitter feeds, so a stubbed implementation returning a known sequence would be more prudent, as shown next. </p><p id="filepos1025228" class="calibre5"><span class="calibre10"><span class="bold">Listing 13.5. Using </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">with-redefs</span></tt></span><span class="calibre10"><span class="bold"> to create stubs </span></span></p><p class="calibre1"><img src="images/00099.jpg" class="calibre132"/></p><p id="filepos1025528" class="calibre5">The <tt class="calibre11">tweetless-rss-children</tt> function returns a sequence of some canned data. Therefore, when testing the <tt class="calibre11">count-rss2-children</tt> function we temporarily change the value of <tt class="calibre11">rss-children</tt> so that it resolves to <tt class="calibre11">tweetless-rss-children</tt> instead. This change is made at the root of the <tt class="calibre11">rss-children</tt> Var and so is visible to all threads. As long as all the test calls to it are made before control leaves the <tt class="calibre11">with-redefs</tt> form, the stub will be invoked every time. Because <tt class="calibre11">tweet-occurrences</tt> doesn’t return until it collects results from all the futures it creates, it will use the redef given by <tt class="calibre11">with-redefs</tt>: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(with-redefs [rss-children tweetless-rss-children]<br class="calibre3"/>  (tweet-occurrences "dummy" "test-url"))<br class="calibre3"/>;=&gt; 0</tt></span></blockquote><p class="calibre12">Another option that is sometimes suggested is to use binding in place of <tt class="calibre11">with-redefs</tt>. This would push a thread-local binding for <tt class="calibre11">rss-children</tt>, which might seem attractive in that it could allow other threads to bind the same Var to a different stub function, potentially for simultaneously running different tests. But because <tt class="calibre11">tweetoccurrences</tt> uses futures, the other threads will be calling <tt class="calibre11">rss-children</tt> and will see the root binding rather than the stub,<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos1027175"><span class="calibre33"><span class="calibre8"><span class="underline">3</span></span></span></a><span class="calibre33">]</span></small></sup> causing an error: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos1027175" class="calibre32"><span class="calibre33">3</span></small></sup><span class="calibre10"> Alpha versions for Clojure 1.3 handle </span><span class="calibre10"><tt class="calibre11">binding</tt></span><span class="calibre10">’s interaction with </span><span class="calibre10"><tt class="calibre11">future</tt></span><span class="calibre10"> and Agent </span><span class="calibre10"><tt class="calibre11">send</tt></span><span class="calibre10"> differently, passing dynamic bindings through to code executed in these other thread contexts. But because these are not the only kinds of threads that can be spawned, </span><span class="calibre10"><tt class="calibre11">with-redefs</tt></span><span class="calibre10"> (which may be included in Clojure 1.3) is still recommended for mocking out functions during tests. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(binding [rss-children tweetless-rss-children]<br class="calibre3"/>  (tweet-occurrences "dummy" "test-url"))<br class="calibre3"/><br class="calibre3"/>; java.util.concurrent.ExecutionException:<br class="calibre3"/>;   java.io.FileNotFoundException: test-url</tt></span></blockquote><p class="calibre12">When the root binding of <tt class="calibre11">rss-children</tt> runs, it tries to actually load “test-url” and fails, instead of calling our stub and succeeding. The <tt class="calibre11">with-redefs</tt> macro is a better solution for mocking. </p><p class="calibre5"><span class="calibre10"><span class="bold">Clojure.Test as Specification </span></span></p><p class="calibre7">Clojure ships with a testing library in the <tt class="calibre11">clojure.test</tt> namespace used to create test suites that can further serve as partial system specifications. We won’t provide a comprehensive survey of the <tt class="calibre11">clojure.test</tt> functionality, but you should get a feel for how it works. Unit-test specifications in Clojure are declarative in nature, as shown next. </p><p id="filepos1028876" class="calibre5"><span class="calibre10"><span class="bold">Listing 13.6. clojure.test as a partial specification </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(require '[clojure.test :as test])<br class="calibre3"/><br class="calibre3"/>(test/deftest feed-tests<br class="calibre3"/>  (with-redefs [rss-children tweetless-rss-children]<br class="calibre3"/>    (test/testing "RSS2 Child Counting"<br class="calibre3"/>      (test/is (= 1000 (count-rss2-children "dummy"))))<br class="calibre3"/>    (test/testing "Twitter Occurrence Counting"<br class="calibre3"/>      (test/is (= 0 (count-tweet-text-task "#clojure" ""))))))<br class="calibre3"/><br class="calibre3"/>(defn test-ns-hook []<br class="calibre3"/>  (feed-tests))</tt></span></blockquote><p id="filepos1029566" class="calibre12">Clojure’s test library provides a DSL for describing unit test cases. If you’ll notice, we added a failing test to the <tt class="calibre11">RSS2 Child Counting</tt> test so that when run, the test will fail as expected: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(test/run-tests 'user)<br class="calibre3"/>; Testing user<br class="calibre3"/>;<br class="calibre3"/>;  FAIL in (feed-tests) (NO_SOURCE_FILE:101)<br class="calibre3"/>;  RSS2 Child Counting<br class="calibre3"/>;  expected: (= 1000 (count-rss2-children "dummy"))<br class="calibre3"/>;   actual: (not (= 1000 1))<br class="calibre3"/>;<br class="calibre3"/>;  Ran 1 tests containing 2 assertions.<br class="calibre3"/>;  1 failures, 0 errors.<br class="calibre3"/>;=&gt; {:type :summary, :test 1, :pass 1, :fail 1, :error 0}</tt></span></blockquote><p class="calibre12">Though tests are a good way to find <span class="italic">some</span> errors, they make few guarantees that the system works properly. The ideal approach is the design and implementation of a framework corresponding closely with the domain of the application itself. This framework would ideally take the literal form of a domain DSL built incrementally through an interaction with domain experts and <span class="italic">must</span> come before testing begins. No amount of testing can substitute for thoroughly thinking through the fundamental design details. That’s not to say that the domain DSLs should be fully realized from the start; instead, the form of the DSL and its constituent parts should be reflective of the actual domain. In our experience, there are no languages comparable to Clojure for this kind of domain modeling, save for perhaps Haskell, Factor, and Scala. Having said that, the domain isn’t simply defined by the shape of its language; it also includes its expectations, which we’ll discuss presently. </p><p id="filepos1031355" class="calibre5"><span class="bold">13.2.2. Contracts programming </span><a></a></p><p class="calibre7">Test-driven development is in many ways a heuristic affair. People tend to only test the error conditions and expectations that they can conceptualize. Surely there’s no such thing as an exhaustive test suite, but in many cases test suites tend toward a local maxima. There’s a better way to define semantic expectations within your application: using Clojure pre- and postconditions. </p><p class="calibre5"><span class="calibre10"><span class="bold">Revisiting Pre- and Postconditions </span></span></p><p class="calibre7">In <a href="#filepos487603"><span class="calibre8"><span class="underline">section 7.1</span></span></a>, we explored Clojure’s pre- and postcondition facility. Function constraint specification is a conceptually simple model for declaring the expectations for any given function. Function constraints can cover the full range of expected conditions imposed on the function’s inputs, its outputs, and their relative natures. The beauty of specifying constraints is that they can augment a testing regimen with the application of random values. The reason this works is that you can effectively throw out <a id="filepos1032555"></a>the values that fail the preconditions and instead focus on the values that cause error in the postconditions. We’ll try this approach for a simple function to square a number: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def sqr (partial<br class="calibre3"/>  (contract sqr-contract<br class="calibre3"/>    [n]<br class="calibre3"/>    (require (number? n))<br class="calibre3"/>    (ensure (pos? %)))<br class="calibre3"/>  #(* % %)))<br class="calibre3"/><br class="calibre3"/>[(sqr 10) (sqr -9)]<br class="calibre3"/>;=&gt; [100 81]</tt></span></blockquote><p class="calibre12">The contract for <tt class="calibre11">sqr</tt> states simply: require a number and ensure that its return is positive. Now we can create a simple test driver<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos1033497"><span class="calibre33"><span class="calibre8"><span class="underline">4</span></span></span></a><span class="calibre33">]</span></small></sup> that throws many random values at it to see if it breaks: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos1033497" class="calibre32"><span class="calibre33">4</span></small></sup><span class="calibre10"> For the sake of highlighting this technique, we’ve simplified our test driver. Testing a limited range of input values might not be an appropriate approach in all circumstances. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(doseq [n (range Short/MIN_VALUE Short/MAX_VALUE)]<br class="calibre3"/>  (try<br class="calibre3"/>    (sqr n)<br class="calibre3"/>    (catch AssertionError e<br class="calibre3"/>      (println "Error on input" n)<br class="calibre3"/>      (throw e))))<br class="calibre3"/><br class="calibre3"/>; Error on input 0<br class="calibre3"/>;=&gt; java.lang.AssertionError: Assert failed: (pos? %)</tt></span></blockquote><p class="calibre12">Even when adhering to the tenets of the preconditions, we’ve uncovered an error in the <tt class="calibre11">sqr</tt> function at the postcondition end. Postconditions should be viewed as the guarantee of the return value given that the preconditions are met. The reason for the postcondition error is that the function’s contract doesn’t specify that the number <tt class="calibre11">n</tt> should be nonzero. By adding a check for zero <tt class="calibre11">(not= 0 n)</tt> in the preconditions, we can guarantee that the <tt class="calibre11">sqr</tt> function acts as expected. To perform this same verification using unit testing is trivial in this case, but what if the edge condition wasn’t as obvious? In such a case, it’s probable that the error might not be caught until it’s too late. Of course, there’s no guarantee that your contracts are comprehensive, but that’s why domain expertise is often critical when defining them. </p><p class="calibre5"><span class="calibre10"><span class="bold">Advantages of Pre- and Postconditions </span></span></p><p class="calibre7">Function constraints aren’t code. They take the form of code, but that fact is only a matter of representation. Instead, constraints should be viewed as a specification language describing expectations and result assurances. On the other hand, unit tests are code, and code has bugs. Contracts, on the other hand, are essential semantic coupling. </p><p class="calibre5">Another potential advantage of contracts over tests is that in some cases, tests can be generated from the contracts themselves. Also, pre- and postconditions are amenable to being expressed as an overall description of the system itself, which can thus be <a id="filepos1035854"></a>fed into a rule base for query and verification. Both of these cases are outside of the scope of this book, but you shouldn’t be surprised if they make their way into future versions of Clojure. There’s tremendous potential in Clojure’s pre- and postconditions. Though they’re currently low-level constructs, they can be used to express full-blown design by contract facilities for your own applications. </p><p class="calibre5">Clojure changes the way that you think.</p><p id="filepos1036349" class="calibre5"><span class="calibre18"><span class="bold">13.3. A lack of design patterns </span></span></p><blockquote class="calibre9"><span class="italic">Any sufficiently complicated C or Fortran program contains an ad hoc, informally-specified, bug-ridden, slow implementation of half of Common Lisp.</span></blockquote><blockquote class="calibre25"><span class="italic">Greenspun’s Tenth Rule</span></blockquote><p class="calibre5">The book <span class="italic">Design Patterns: Elements of Reusable Object-Oriented Software</span> (<a href="#filepos1072162"><span class="calibre8"><span class="underline">Gamma et al 1995</span></span></a>) was a seminal work of software design and development. You’d be hard pressed to find a software programmer in this day and age who’s not familiar with this work. The book describes 24 software best practices encountered throughout the course of experience in developing software projects of varying sizes. </p><p class="calibre5">Design patterns have obtained a bad reputation in some circles, whereas in others they’re considered indispensable. From our perspective, design patterns are a way to express software best practices in a language-neutral way. But where patterns fall short is that they don’t represent pure abstraction. Instead, design patterns have come to be viewed as goals in and of themselves, which is likely the source of the antagonism aimed at them. The ability to think in abstractions is an invaluable skill for a software programmer to strengthen. In this section, we’ll attempt to dissuade you from viewing Clojure features as design patterns (Norvig 1998) and instead as an inherent nameless quality. </p><p id="filepos1037976" class="calibre5"><span class="bold">13.3.1. Clojure’s first-class design patterns </span><a></a></p><p class="calibre7">Most if not all of the patterns listed in the book are applicable to functional programming languages in general, and to Clojure in particular. But at its most pragmatic, the patterns described are aimed at patching deficiencies in popular object-oriented programming languages. This practical view of design patterns isn’t directly relevant to Clojure, because in many ways the patterns are ever-present and are first-class citizens of the language itself. We won’t provide a comprehensive survey of the ways that Clojure implements or eliminates popular design patterns but will provide enough to make our point. </p><p class="calibre5"><span class="calibre10"><span class="bold">Observer </span></span></p><p class="calibre7">Clojure’s <tt class="calibre11">add-watch</tt> and <tt class="calibre11">remove-watch</tt> functions provide the underpinnings of an observer (publisher/subscriber) capability based on reference types. We can illustrate this through the implementation of the simple <tt class="calibre11">defformula</tt> macro shown in <a href="#filepos1039165"><span class="calibre8"><span class="underline">listing 13.7</span></span></a>. </p><p id="filepos1039165" class="calibre5"><span class="calibre10"><span class="bold">Listing 13.7. A macro to create spreadsheet-cell-like formulas </span></span><a></a></p><p class="calibre1"><img src="images/00011.jpg" class="calibre133"/></p><p id="filepos1039413" class="calibre5">By using watchers on references, you can use <tt class="calibre11">defformula</tt> to provide an abstract value that changes when any of its parts change. A more traditional Lisp approach is to provide predefined hooks (<a href="#filepos1072747"><span class="calibre8"><span class="underline">Glickstein 1997</span></span></a>) that are called at certain times within the execution cycle. In addition, using <tt class="calibre11">proxy</tt> or <tt class="calibre11">gen-class</tt> to extend <tt class="calibre11">java.util.Observable</tt> is the most straightforward way to wire into existing source code using the Observer pattern. </p><p class="calibre5"><span class="calibre10"><span class="bold">Strategy </span></span></p><p class="calibre7">Algorithm strategies selected at runtime are common practice in Clojure, and there are a number of ways to implement them. One such way is via continuation-passing style, as we explored in <a href="#filepos543109"><span class="calibre8"><span class="underline">section 7.3</span></span></a>. A more general solution is to pass the desired function as an argument to a higher-order function, such as you’d see in the ubiquitous <tt class="calibre11">map, reduce</tt>, and <tt class="calibre11">filter</tt> functions. Further, we’ll provide a case of dynamic error functions in the next section illustrating how Clojure’s multimethods are a more powerful substitute for the classic strategy pattern. </p><p class="calibre5"><span class="calibre10"><span class="bold">Visitor </span></span></p><p class="calibre7">The Visitor pattern is designed to describe a way to decouple operations on a structure from the structure itself. Even casual observers will see the parallel to Clojure’s multimethods, protocols, types, proxies, and reify features. </p><p class="calibre5"><span class="calibre10"><span class="bold">Abstract Factory </span></span></p><p class="calibre7">The Abstract Factory pattern is used to describe a way to create related objects without having to name explicit types at the point of creation. Clojure’s types avoid the creation of explicit hierarchies (although ad hoc hierarchies can be created, as seen in <a href="#filepos660369"><span class="calibre8"><span class="underline">section 9.2</span></span></a>). Therefore, in Clojure this particular usage scenario is relegated to use within Java interoperability contexts. But the use of factory functions to abstract the <a id="filepos1041654"></a>call to the constructors of types and records is idiomatic and in fact actively promoted. The reasons for a Clojure-style factory are to simplify the importing requirements of a type or record, and also to add additional project-specific functionality to the constructor (keyword arguments, default values, and so on). </p><p class="calibre5"><span class="calibre10"><span class="bold">Interpreter </span></span></p><p class="calibre7">The Interpreter pattern is in every way Greenspun’s Tenth Rule formalized. Many projects of sufficient size can be well served by the inclusion of a specialized grammar describing parts of the system itself. Clojure macros make the matter of creating specialized grammars a first-class member of the language. </p><p class="calibre5"><span class="calibre10"><span class="bold">Builder </span></span></p><p class="calibre7">The creation of complex structures from representation is central to Clojure programming, although it’s viewed differently from a similar object-oriented approach—the Builder pattern. In <a href="#filepos612355"><span class="calibre8"><span class="underline">section 8.4</span></span></a>, we used a simple data representation as the input to Clojure’s <tt class="calibre11">clojure.xml/emit</tt> function to produce an analogous XML representation. If you preferred a different output representation, then you could write another conversion function. If you preferred finer control over the constituent parts, then you could write functions or multimethods for each and specialize at runtime. </p><p class="calibre5"><span class="calibre10"><span class="bold">Façade </span></span></p><p class="calibre7">The use of Clojure namespaces, as seen in <a href="#filepos643937"><span class="calibre8"><span class="underline">section 9.1</span></span></a>, is the most obvious way to provide a simplified façade for a more complex API. You can also use the varying levels of encapsulation (as outlined in <a href="#filepos190361"><span class="calibre8"><span class="underline">section 2.4</span></span></a>) for more localized façades. </p><p class="calibre5"><span class="calibre10"><span class="bold">Iterator </span></span></p><p class="calibre7">Iteration in Clojure is defined through an adherence to the seq protocol, as outlined in <a href="#filepos335390"><span class="calibre8"><span class="underline">section 5.1</span></span></a> and later elaborated on in <a href="#filepos677632"><span class="calibre8"><span class="underline">sections 9.3</span></span></a> about types and protocols. </p><p class="calibre5"><span class="calibre10"><span class="bold">Dependency Injection </span></span></p><p class="calibre7">Though not a classical pattern in the <span class="italic">Design Patterns</span> sense, dependency injection has become a de facto pattern for object-oriented languages that don’t allow overridable class constructors. This condition requires that separate factory methods and/or classes create concrete instances conforming to a given interface. In forsaking the ability to define classes, Clojure completely avoids the problem that DI solves. Instead, Clojure’s closest analogue to this “pattern” is the use of functions returning closures that are specialized based on the original arguments. Likewise, you could use partial application and composition similarly. </p><p class="calibre5">We could go further with this survey, but to do so would belabor the point: most of what are known as design patterns are either invisible or trivial to implement in Clojure. But what about the Prototype pattern, you ask? We implemented the UDP in <a href="#filepos660369"><span class="calibre8"><span class="underline">section 9.2</span></span></a>. Decorators or chain of responsibility? Why not use a macro that returns a function built from a list of forms spliced into the <tt class="calibre11">-&gt;</tt> or <tt class="calibre11">-&gt;&gt;</tt> macro? Proxies would likely be implemented as closures and so would commands. The list goes on and on, and in the end you must face the inevitable—Clojure changes the way that you think. </p><p id="filepos1045484" class="calibre5"><span class="calibre18"><span class="bold">13.4. Error handling and debugging </span></span></p><p id="filepos1045580" class="calibre7">Our goal throughout this book was to show the proper way to write Clojure code, with mostly deferral and hand-waving regarding error handling and debugging. In this section, we’ll cover these topics with what you might view as a unique twist, depending on your programming background. </p><p id="filepos1045900" class="calibre5"><span class="bold">13.4.1. Error handling </span><a></a></p><p class="calibre7">As we showed in <a href="#filepos815962"><span class="calibre8"><span class="underline">figure 10.7</span></span></a>, there are two directions for handling errors. The first, and likely most familiar, refers to the passive handling of exceptions bubbling outward from inner functions. But built on Clojure’s dynamic Var binding is a more active mode of error handling, where handlers are pushed into inner functions. In <a href="#filepos951111"><span class="calibre8"><span class="underline">section 11.10</span></span></a>, we mentioned that the <tt class="calibre11">binding</tt> form is used to create thread-local bindings, but its utility isn’t limited to this use case. In its purest form, dynamic scope is a structured form of a side effect (<a href="#filepos1082061"><span class="calibre8"><span class="underline">Steele 1978</span></span></a>). You can use it to push Vars down a call stack from the outer layers of a function nesting into the inner layers, a technique that we’ll demonstrate next. </p><p class="calibre5"><span class="calibre10"><span class="bold">Dynamic Tree Traversal </span></span></p><p class="calibre7">In <a href="#filepos612355"><span class="calibre8"><span class="underline">section 8.4</span></span></a>, we built a simple tree structure for a domain model where each node was of this form: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">{:tag &lt;node form&gt;, :attrs {}, :content [&lt;nodes&gt;]}</tt></span></blockquote><p class="calibre12">As it turns out, the traversal of a tree built from such nodes is straightforward using mundane recursion, as shown:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn traverse [node f]<br class="calibre3"/>  (when node<br class="calibre3"/>    (f node)<br class="calibre3"/>    (doseq [child (:content node)]<br class="calibre3"/>      (traverse child f))))</tt></span></blockquote><p class="calibre12">For each node in the tree, the function <tt class="calibre11">f</tt> is called with the node itself, and then each of the node’s children is traversed in turn. Observe how <tt class="calibre11">traverse</tt> works for a single root node: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(traverse {:tag :flower :attrs {:name "Tanpopo"} :content []}<br class="calibre3"/>          println)<br class="calibre3"/><br class="calibre3"/>; {:tag :flower, :attrs {:name Tanpopo}, :content []}</tt></span></blockquote><p class="calibre12">But it’s much more interesting if we traverse trees larger than a single node. Therefore, we can build a quick tree from an XML representation using Clojure’s <tt class="calibre11">clojure.</tt></p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">xml/parse function:<br class="calibre3"/><br class="calibre3"/>(use '[clojure.xml :as xml])<br class="calibre3"/><br class="calibre3"/>(def DB<br class="calibre3"/>  (-&gt; "&lt;zoo&gt;<br class="calibre3"/>         &lt;pongo&gt;<br class="calibre3"/>           &lt;animal&gt;orangutan&lt;/animal&gt;<br class="calibre3"/>         &lt;/pongo&gt;<br class="calibre3"/>         &lt;panthera&gt;<br class="calibre3"/>           &lt;animal&gt;Spot&lt;/animal&gt;<br class="calibre3"/>           &lt;animal&gt;lion&lt;/animal&gt;<br class="calibre3"/>           &lt;animal&gt;Lopshire&lt;/animal&gt;<br class="calibre3"/>         &lt;/panthera&gt;<br class="calibre3"/>       &lt;/zoo&gt;"<br class="calibre3"/>      .getBytes<br class="calibre3"/>      (java.io.ByteArrayInputStream.)<br class="calibre3"/>      xml/parse))</tt></span></blockquote><p id="filepos1049237" class="calibre12">The <tt class="calibre11">DB</tt> Var contains an animal listing for a small zoo. Note that two of the animals listed have the elements <tt class="calibre11">Spot</tt> and <tt class="calibre11">Lopshire</tt>; both are seemingly out of order for a zoo. Therefore, we can write a function to handle these nefarious intruders. </p><p id="filepos1049540" class="calibre5"><span class="calibre10"><span class="bold">Listing 13.8. Handling nefarious tree nodes with exceptions </span></span><a></a></p><p class="calibre1"><img src="images/00101.jpg" class="calibre134"/></p><p class="calibre5">The multimethod <tt class="calibre11">visit</tt> can be used as the input function to the <tt class="calibre11">traverse</tt> function and will only trigger when a node with the <tt class="calibre11">:tag</tt> attribute of <tt class="calibre11">:animal</tt> is encountered. When the method triggered on <tt class="calibre11">:animal</tt> is executed, the node <tt class="calibre11">:content</tt> is destructured and checked against the offending <tt class="calibre11">Spot</tt> and <tt class="calibre11">Lopshire</tt> values. When found, the devious node is then passed along to an error handler <tt class="calibre11">handle-weird-animal</tt> for reporting.<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos1050682"><span class="calibre33"><span class="calibre8"><span class="underline">5</span></span></span></a><span class="calibre33">]</span></small></sup> By default, the error handler throws an exception. This model of error handling is the inside-out model of exceptions. But handling errors in this way stops the processing: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos1050682" class="calibre32"><span class="calibre33">5</span></small></sup><span class="calibre10"> The metadata </span><span class="calibre10"><tt class="calibre11">{:dynamic true}</tt></span><span class="calibre10"> attached to </span><span class="calibre10"><tt class="calibre11">handle-weird-animal</tt></span><span class="calibre10"> isn’t really used in Clojure 1.2, but it may be required in future versions of Clojure starting with 1.3 to allow the dynamic binding we’re about to demonstrate. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(traverse DB visit)<br class="calibre3"/>; orangutan<br class="calibre3"/>; java.lang.Exception: Spot must be 'dealt with'</tt></span></blockquote><p class="calibre12">We’ve managed to identify <tt class="calibre11">Spot</tt>, but the equally repugnant <tt class="calibre11">Lopshire</tt> escapes our grasp. It’d be nice to instead use a different version of <tt class="calibre11">handle-weird-animal</tt> that allows us to both identify and deal with every such weird creature. We could pass <tt class="calibre11">handle-weird-animal</tt> along as an argument to be used as an error continuation,<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos1052345"><span class="calibre33"><span class="calibre8"><span class="underline">6</span></span></span></a><span class="calibre33">]</span></small></sup> but <a id="filepos1051831"></a>that pollutes the argument list of every function along the way. Likewise, we could inject <tt class="calibre11">catch</tt> blocks at a point further down the call chain, say within <tt class="calibre11">visit</tt>, but we might not be able to change the source, and if we could it makes for a more insidious pollution. Instead, using a dynamic binding is a perfect solution, because it allows us to attach specific error handlers at any depth in the stack according to their appropriate context: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos1052345" class="calibre32"><span class="calibre33">6</span></small></sup><span class="calibre10"> See </span><a href="#filepos543109"><span class="calibre10"><span class="calibre8"><span class="underline">section 7.3</span></span></span></a><span class="calibre10"> for more information on continuation-passing style. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defmulti handle-weird  (fn [{[name] :content}] name))<br class="calibre3"/><br class="calibre3"/>(defmethod handle-weird "Spot" [_]<br class="calibre3"/>  (println "Transporting Spot to the circus."))<br class="calibre3"/><br class="calibre3"/>(defmethod handle-weird "Lopshire" [_]<br class="calibre3"/>  (println "Signing Lopshire to a book deal."))<br class="calibre3"/><br class="calibre3"/>(binding [handle-weird-animal handle-weird]<br class="calibre3"/>  (traverse DB visit))<br class="calibre3"/><br class="calibre3"/>; orangutan<br class="calibre3"/>; Transporting Spot to the circus.<br class="calibre3"/>; lion<br class="calibre3"/>; Signing Lopshire to a book deal.</tt></span></blockquote><p class="calibre12">As you might expect, this approach works across threads to allow for thread-specific handlers:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(def _ (future<br class="calibre3"/>         (binding [handle-weird-animal #(println (:content %))]<br class="calibre3"/>           (traverse DB visit))))<br class="calibre3"/>; orangutan<br class="calibre3"/>; [Spot]<br class="calibre3"/>; lion<br class="calibre3"/>; [Lopshire]</tt></span></blockquote><p class="calibre12">What we’ve outlined here is a simplistic model for a grander error-handling scheme. Using dynamic scope via <tt class="calibre11">binding</tt> is the preferred way to handle recoverable errors in a context-sensitive manner. </p><p id="filepos1053902" class="calibre5"><span class="bold">13.4.2. Debugging </span><a></a></p><p class="calibre7">The natural progression of debugging techniques as discovered by a newcomer to Clojure follows a fairly standard progression:</p><br class="calibre3"/><table valign="top" class="calibre14"><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10"><span class="bold">1</span></span>
</td><td valign="top" class="calibre16"><span class="calibre10">(println)</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10"><span class="bold">2</span></span>
</td><td valign="top" class="calibre16"><span class="calibre10">A macro to make (println) inclusion simpler</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10"><span class="bold">3</span></span>
</td><td valign="top" class="calibre16"><span class="calibre10">Some variation on debugging as discussed in this section</span>
</td></tr><tr valign="top" class="calibre15"><td valign="top" class="calibre16"><span class="calibre10"><span class="bold">4</span></span>
</td><td valign="top" class="calibre16"><span class="calibre10">IDEs, monitoring, and profiling tools</span>
</td></tr></table><p class="calibre7">Many Clojure programmers stay at step 1, because it’s simple to understand and also highly useful, but there are better ways. After all, you’re dealing with Clojure—a highly dynamic programming environment. Observe the following function: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn div [n d] (int (/ n d)))</tt></span></blockquote><p id="filepos1055195" class="calibre12">The function <tt class="calibre11">div</tt> simply divides two numbers and returns an integer value. You can break <tt class="calibre11">div</tt> in a number of ways, but the most obvious is to call it with zero as the denominator: <tt class="calibre11">(div 10 0)</tt>. Such an example would likely not give you cause for concern should it fail, because the conditions under which it fails are fairly limited, well known, and easily identified. But not all errors are this simple, and the use of <tt class="calibre11">println</tt> is fairly limited. Instead, a better tool would likely be a generic breakpoint<sup class="calibre31"><small class="calibre32"><span class="calibre33">[</span><a href="#filepos1056105"><span class="calibre33"><span class="calibre8"><span class="underline">7</span></span></span></a><span class="calibre33">]</span></small></sup> that could be inserted at will and used to provide a debug console for the current valid execution context. Imagine it would work as follows: </p><blockquote class="calibre9"><sup class="calibre31"><small id="filepos1056105" class="calibre32"><span class="calibre33">7</span></small></sup><span class="calibre10"> The code in this section is based on </span><span class="calibre10"><tt class="calibre11">debug-repl</tt></span><span class="calibre10"> created by the amazing George Jahad, extended by Alex Osborne, and integrated into Swank-Clojure by Hugo Duncan. </span></blockquote><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn div [n d] (break) (int (/ n d)))<br class="calibre3"/>(div 10 0)<br class="calibre3"/>debug=&gt;</tt></span></blockquote><p class="calibre12">At this prompt, you can query the current lexical environment, experiment with different code, and then resume the previous execution as before. As it turns out, such a tool is within your grasp. </p><p class="calibre5"><span class="calibre10"><span class="bold">A Breakpoint Macro </span></span></p><p class="calibre7">We hope that by the end of this section, you’ll understand that Lisps in general, and Clojure in particular, provide an environment where the whole of the language truly is “always available” (<a href="#filepos1073199"><span class="calibre8"><span class="underline">Graham 1993</span></span></a>). First of all, an interesting fact to note is that the Clojure REPL is available and extensible via the Clojure REPL itself, via the <tt class="calibre11">clojure.main/repl</tt> function. By accessing the REPL implementation directly, you can customize it as you see fit for application-specific tasks. </p><p class="calibre5">Typing <tt class="calibre11">(clojure.main/repl)</tt> at the REPL seemingly does nothing, but rest assured you’ve started a sub-REPL. What use is this? To start, the <tt class="calibre11">repl</tt> function takes a number of named parameters, each used to customize the launched REPL in different ways. We’ll utilize three such hooks—<tt class="calibre11">:prompt, :eval</tt>, and <tt class="calibre11">:read</tt>—to fulfill a breakpoint functionality. </p><p class="calibre5"><span class="calibre10"><span class="bold">Overriding the Repl’s Reader </span></span></p><p class="calibre7">The <tt class="calibre11">repl</tt> function’s <tt class="calibre11">:read</tt> hook takes a function of two arguments: the first corresponding to a desired display prompt, and the second to a desired exit form. We want the debug console to provide convenience functions—we’d like it to show all of the available lexical bindings and also to resume execution. It also needs to be able to read valid Clojure forms, but because that’s too complex a task, we’ll instead farm that functionality out to Clojure’s default REPL reader. </p><p id="filepos1058516" class="calibre5"><span class="calibre10"><span class="bold">Listing 13.9. A modest debug console reader </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn readr [prompt exit-code]<br class="calibre3"/>  (let [input (clojure.main/repl-read prompt exit-code)]<br class="calibre3"/>    (if (= input ::tl)<br class="calibre3"/>      exit-code<br class="calibre3"/>      input)))</tt></span></blockquote><p id="filepos1058911" class="calibre12">We can start testing the reader immediately: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(readr #(print "invisible=&gt; ") ::exit)<br class="calibre3"/>[1 2 3]<br class="calibre3"/>;=&gt; [1 2 3]<br class="calibre3"/><br class="calibre3"/>(readr #(print "invisible=&gt; ") ::exit)<br class="calibre3"/>::tl<br class="calibre3"/>;=&gt; :user/exit</tt></span></blockquote><p class="calibre12">The prompt that we specified was of course not printed, and typing <tt class="calibre11">::tl</tt> at the prompt did nothing because the <tt class="calibre11">readr</tt> function isn’t yet provided to the <tt class="calibre11">repl</tt> as its <tt class="calibre11">:read</tt> hook. But before we do that, we need to provide a function for the <tt class="calibre11">:eval</tt> hook. Needless to say, this is a more complex task. </p><p class="calibre5"><span class="calibre10"><span class="bold">Overriding the Repl’s Evaluator </span></span></p><p class="calibre7">In order to evaluate things in context, we first need a function cab to garner the bindings in the current context. Fortunately for us, Clojure macros provide an implicit argument <tt class="calibre11">&amp;env</tt> that’s a map of the local bindings available at macro-expansion time. We can then extract from <tt class="calibre11">&amp;env</tt> the values associated with the bindings and zip them up with their names into a map for the local context, as shown next. </p><p id="filepos1060199" class="calibre5"><span class="calibre10"><span class="bold">Listing 13.10. Creating a map of the local context using </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">&amp;env</span></tt></span></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defmacro local-context []<br class="calibre3"/>  (let [symbols (keys &amp;env)]<br class="calibre3"/>     (zipmap (map (fn [sym] `(quote ~sym)) symbols) symbols)))<br class="calibre3"/><br class="calibre3"/>(local-context)<br class="calibre3"/>;=&gt; {}<br class="calibre3"/><br class="calibre3"/>(let [a 1, b 2, c 3]<br class="calibre3"/>  (let [b 200]<br class="calibre3"/>    (local-context)))<br class="calibre3"/>;=&gt; {a 1, b 200, c 3}</tt></span></blockquote><p class="calibre12">The <tt class="calibre11">local-context</tt> macro provides a map to the most immediate lexical bindings, which is what we want. But what we really want to do is to provide a way to evaluate expressions with this contextual bindings map. Wouldn’t you know it, the <tt class="calibre11">contextual-eval</tt> function from <a href="#filepos588357"><span class="calibre8"><span class="underline">section 8.1</span></span></a> fits the bill. So now that we have the bulk of the implementation complete, we’ll now hook into the <tt class="calibre11">repl</tt> function to provide a breakpoint facility. </p><p class="calibre5"><span class="calibre10"><span class="bold">Putting It All Together </span></span></p><p class="calibre7">The hard parts are done, so to wire them into a usable debugging console is relatively easy, as shown next.</p><p id="filepos1061580" class="calibre5"><span class="calibre10"><span class="bold">Listing 13.11. The implementation of a breakpoint macro </span></span><a></a></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defmacro break []<br class="calibre3"/>  `(clojure.main/repl<br class="calibre3"/>    :prompt #(print "debug=&gt; ")<br class="calibre3"/>    :read readr<br class="calibre3"/>    :eval (partial contextual-eval (local-context))))</tt></span></blockquote><p class="calibre12">Using this macro, we can now debug the original <tt class="calibre11">div</tt> function: </p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">(defn div [n d] (break) (int (/ n d)))<br class="calibre3"/>(div 10 0)<br class="calibre3"/>debug=&gt;</tt></span></blockquote><p class="calibre12">Querying locals to find the “problem” is simple:</p><blockquote class="calibre9"><span class="calibre10"><tt class="calibre11">debug=&gt; n<br class="calibre3"/>;=&gt; 10<br class="calibre3"/>debug=&gt; d<br class="calibre3"/>;=&gt; 0<br class="calibre3"/>debug=&gt; (local-context)<br class="calibre3"/>;=&gt; {div #&lt;user$div__155 user$div__155@51e67ac&gt;, n 10, d 0}<br class="calibre3"/>debug=&gt; ::tl<br class="calibre3"/>; java.lang.ArithmeticException: Divide by zero</tt></span></blockquote><p class="calibre12">So there’s the problem! We passed in a zero as the denominator. We should fix that.</p><p class="calibre5"><span class="calibre10"><span class="bold">Multiple Breakpoints and Breakpoints in Macros </span></span></p><p class="calibre7">What would be the point if you couldn’t set multiple breakpoints? Fortunately, you can, as we show in the following listing.</p><p id="filepos1063085" class="calibre5"><span class="calibre10"><span class="bold">Listing 13.12. Using multiple breakpoints in function </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">keys-apply</span></tt></span></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defn keys-apply [f ks m]<br class="calibre3"/>  (break)<br class="calibre3"/>  (let [only (select-keys m ks)]<br class="calibre3"/>    (break)<br class="calibre3"/>    (zipmap (keys only) (map f (vals only)))))<br class="calibre3"/><br class="calibre3"/>(keys-apply inc [:a :b] {:a 1, :b 2, :c 3})<br class="calibre3"/><br class="calibre3"/>debug=&gt; only<br class="calibre3"/>; java.lang.Exception: Unable to resolve symbol: only in this context<br class="calibre3"/>debug=&gt; ks<br class="calibre3"/>;=&gt; [:a :b]<br class="calibre3"/>debug=&gt; m<br class="calibre3"/>;=&gt; {:a 1, :b 2, :c 3}<br class="calibre3"/>debug=&gt; ::tl<br class="calibre3"/>debug=&gt; only<br class="calibre3"/>;=&gt; {:b 2, :a 1}<br class="calibre3"/>debug=&gt; ::tl<br class="calibre3"/>;=&gt; {:a 2, :b 3}</tt></span></blockquote><p class="calibre12">And finally, you can use breakpoints within the body of a macro (in its expansion, not its logic), as shown next.</p><p id="filepos1064108" class="calibre5"><span class="calibre10"><span class="bold">Listing 13.13. Using a breakpoint in a macro </span></span><a></a><span class="calibre10"><tt class="calibre11"><span class="bold">awhen</span></tt></span></p><blockquote class="calibre39"><span class="calibre10"><tt class="calibre11">(defmacro awhen [expr &amp; body]<br class="calibre3"/>  (break)<br class="calibre3"/>  `(let [~'it ~expr]<br class="calibre3"/>     (if ~'it<br class="calibre3"/>       (do (break) ~@body))))<br class="calibre3"/><br class="calibre3"/>(awhen [1 2 3] (it 2))<br class="calibre3"/>debug=&gt; it<br class="calibre3"/>; java.lang.Exception: Unable to resolve symbol: it in this context<br class="calibre3"/>debug=&gt; expr<br class="calibre3"/>;=&gt; [1 2 3]<br class="calibre3"/>debug=&gt; body<br class="calibre3"/>;=&gt; ((it 2))<br class="calibre3"/>debug=&gt; ::tl<br class="calibre3"/>debug=&gt; it<br class="calibre3"/>;=&gt; [1 2 3]<br class="calibre3"/>debug=&gt; (it 1)<br class="calibre3"/>;=&gt;  2<br class="calibre3"/>debug=&gt; ::tl<br class="calibre3"/>;=&gt; 3</tt></span></blockquote><p id="filepos1064931" class="calibre12">There’s much room for improvement, but we believe that the point has been made. Having access to the underpinnings of the language allows you to create a powerful debugging environment with little code. We’ve run out of ideas by now, so we’ll say our credo only once more, and we hope by now you believe us. </p><p class="calibre5">Clojure changes the way that you think.</p><p id="filepos1065349" class="calibre5"><span class="calibre18"><span class="bold">13.5. Fare thee well </span></span></p><p class="calibre7">This book possess many lacunae, but it’s this way by design. In many cases, we’ve skipped approaches to solving problems via a certain route to avoid presenting nonidiomatic code. In many examples, we’ve left exposed wiring. For example, the <tt class="calibre11">defcontract</tt> macro requires that you partially apply the contract to the function under constraint instead of providing a comprehensive contract overlay façade. It was our goal to leave wiring exposed because exposed wiring can be explored, tampered with, and ultimately enhanced—which we hope you’ll find the motivation to do. We’ve worked hard to provide a vast array of relevant references should you choose to further enhance your understanding of the workings and motivations for Clojure. But it’s likely that we’ve missed some excellent resources, and we hope that you instead are able to uncover them in time. Finally, this wasn’t a survey of Clojure, and many of the functions available to you weren’t used in this book. We provide some pointers in the resource list, but there’s no way that we could do justice to the libraries and applications mentioned and those unmentioned. We implore you to look deeper into the functionality of not only Clojure, but the rich ecology of libraries and applications that have sprung up in its relatively short life span. </p><p class="calibre5">Thank you for taking the time to read this book; we hope it was as much a pleasure to read as it was for us to write. Likewise, we hope that you’ll continue your journey with Clojure. Should you choose to diverge from this path, then we hope that some of what you’ve learned has helped you to view the art of programming in a new light. Clojure is an opinionated language, but it and most of its community believe that these opinions can work to enhance the overall state of affairs in our software industry. The onus is on us to make our software robust, performant, and extensible. We believe that the path toward these goals lies with Clojure. </p><p class="calibre5">Do you?</p><p class="calibre5">—F<span class="italic">OGUS AND</span> H<span class="italic">OUSER 2010</span></p><div class="mbppagebreak"></div><p id="filepos1067612" class="calibre5"><span class="calibre6"><span class="bold">Resources </span></span></p><p id="filepos1067683" class="calibre5"><span class="calibre18"><span class="bold">Miscellaneous resources </span></span></p><p id="filepos1067768" class="calibre5">Abadi, Martin, and Luca Cardelli. 1996. <span class="italic">A Theory of Objects</span>. New York: Springer. Although not a mathematical concept, object-oriented programming has obtained rigor with this gem. </p><p id="filepos1067987" class="calibre5">Abelson, Harold, and Gerald Jay Sussman. 1988. “Lisp: A Language for Stratified Design.”<span class="italic">AI Memo</span> (MIT) 986. </p><p class="calibre5">_____. 1996. <span class="italic">Structure and Interpretation of Computer Programs.</span> Cambridge, MA: MIT Press. There is no better book for learning Scheme and the fine art of programming. </p><p id="filepos1068343" class="calibre5">Abiteboul, Serge, Richard Hull, and Victor Vianu. 1995. <span class="italic">Foundations of Databases</span>. Boston: Addison-Wesley. Clojure’s <tt class="calibre11">clojure.set</tt> namespace is actually modeled more on the named conjunctive algebra, for which this book provides a great reference. </p><p id="filepos1068638" class="calibre5">Armstrong, Joe. 2007. <span class="italic">Programming Erlang</span>. Raleigh, NC: Pragmatic Bookshelf. </p><p class="calibre5">_____. 2007. “A History of Erlang.” <span class="italic">Proceedings of the Third ACM SIGPLAN Conference on History of Programming Languages.</span></p><p id="filepos1068916" class="calibre5">Bagwell, Phil. 2001. <span class="italic">Ideal Hash Trees.</span> Technical report. Clojure’s persistent data structures owe a lot to Phil Bagwell’s paper. </p><p id="filepos1069088" class="calibre5">Baker, Henry. 1993. “Equal Rights for Functional Objects or, The More Things Change, The More They Are the Same.” ACM SIGPLAN OOPS <span class="italic">Messenger</span> 4, no. 4. </p><p id="filepos1069282" class="calibre5">Beck, Kent. 2002. <span class="italic">Test Driven Development: By Example</span>. Boston: Addison-Wesley. </p><p id="filepos1069400" class="calibre5">Bloch, Joshua. 2008. <span class="italic">Effective Java</span>. Upper Saddle River, NJ: Addison-Wesley. </p><p id="filepos1069516" class="calibre5">Boncz, Peter, Zukowski Marcin, and Niels Nes. 2005. “MonetDB/X100: Hyper-Pipelining Query Execution.” <span class="italic">Proceedings of the CIDR Conference</span>. This paper motivated the implementation of chunked sequences. </p><p id="filepos1069759" class="calibre5">Bratko, Ivan. 2000. <span class="italic">PROLOG: Programming for Artificial Intelligence.</span> New York: Addison Wesley. </p><p id="filepos1069893" class="calibre5">Budd, Timothy. 1995. <span class="italic">Multiparadigm Programming in Leda.</span> Reading, MA: Addison-Wesley. This is an expanded discussion of the complexities wrought from a mono-paradigm approach to software development. </p><p id="filepos1070131" class="calibre5">Clinger, William. 1998. “Proper Tail Recursion and Space Efficiency.” <span class="italic">Proceedings of the ACM SIGPLAN 1998 Conference on Programming Language Design and Implementation.</span></p><p id="filepos1070341" class="calibre5">Cormen, Thomas, Charles Leiserson, Ronald Rivest, and Clifford Stein. 2009. <span class="italic">Introduction to Algorithms</span>. Cambridge, MA: MIT Press. This is a great reference on algorithmic complexity and Big-O, and as an added bonus, you could use it to stop a charging rhinoceros. </p><p id="filepos1070644" class="calibre5">Crockford, Douglas. 2008. <span class="italic">JavaScript: The Good Parts.</span> Yahoo Press. </p><p id="filepos1070750" class="calibre5">Date, C.J. 2009. <span class="italic">SQL and Relational Theory: How to Write Accurate SQL Code</span>. Sebastopol, CA: O’Reilly. </p><p id="filepos1070893" class="calibre5">Dijkstra, Edsger Wijbe. 1959. “A Note on Two Problems in Connexion with Graphs.” <span class="italic">Numerische Mathematik</span> 1, no. 1. You could change the <tt class="calibre11">h</tt> function in <a href="#filepos572883"><span class="calibre8"><span class="underline">listing 7.9</span></span></a> to (<tt class="calibre11">defn dijkstra-estimate-cost [step-cost-est sz y x] 0</tt>) to conform to the ideal presented in this paper. </p><p id="filepos1071280" class="calibre5">Flanagan, David. 2006. <span class="italic">JavaScript: The Definitive Guide.</span> Sebastopol, CA: O’Reilly. </p><p id="filepos1071404" class="calibre5">Forman, Ira, and Nate Forman. 2004. <span class="italic">Java Reflection in Action.</span> Greenwich, CT: Manning. Although reflection provides some meta-level manipulation, it’s quite apart from the notion of functions as data. </p><p id="filepos1071646" class="calibre5">Friedl, Jeffrey. 1997. <span class="italic">Mastering Regular Expressions.</span> Sebastopol, CA: O’Reilly. </p><p id="filepos1071767" class="calibre5">Friedman, Daniel, Mitchell Wand, and Christopher T. Haynes. 2001. <span class="italic">Essentials of Programming Languages</span>. Cambridge, MA: MIT Press. </p><p id="filepos1071935" class="calibre5">Gabriel, Richard, and Kent Pitman. 2001. “Technical Issues of Separation in Function Cells and Value Cells.” This is a more thorough examination of the differences between Lisp-1 and Lisp-2. </p><p id="filepos1072162" class="calibre5">Gamma, Erich, Richard Helm, Ralph Johnson, and John Vlissides. 1995. <span class="italic">Design Patterns: Elements of Reusable Object-Oriented Software.</span> Reading, MA: Addison-Wesley. </p><p id="filepos1072363" class="calibre5">Ghosh, Debasish. 2010. <span class="italic">DSLs in Action.</span> Greenwich, CT: Manning. There is a much finer level of distinction determining what constitutes whole cloth, including that between internal and external DSLs. In this book, we focus on the classical Lisp model of internal DSLs, but <span class="italic">DSLs in Action</span> provides a survey of many DSL-creation techniques. </p><p id="filepos1072747" class="calibre5">Glickstein, Bob. 1997. <span class="italic">Writing GNU Emacs Extension</span>s. Sebastopol, CA: O’Reilly. </p><p id="filepos1072867" class="calibre5">Goetz, Brian. 2006. <span class="italic">Java Concurrency in Practice</span>. Upper Saddle River, NJ: Addison-Wesley. Why haven’t you read this yet? </p><p class="calibre5">Goldberg, David. 1991. “What Every Computer Scientist Should Know About Floating-Point Arithmetic.” <span class="italic">Computing Surveys</span> (March). </p><p id="filepos1073199" class="calibre5">Graham, Paul. 1993. <span class="italic">On Lisp.</span> Englewood Cliffs, NJ: Prentice Hall. Is there any book or any author more influential to the current generation of dynamic programmers than Graham and <span class="italic">On Lisp</span>? </p><p class="calibre5">_____. 1995. <span class="italic">ANSI Common Lisp.</span> Englewood Cliffs, NJ: Prentice Hall. </p><p id="filepos1073541" class="calibre5">Gray, Jim, and Andreas Reuter. 1992. <span class="italic">Transaction Processing: Concepts and Techniques.</span> San Mateo, CA: Morgan Kaufmann Publishers. </p><p id="filepos1073709" class="calibre5">Halloway, Stuart. 2009. “Clojure is a better Java than Java.” Presented at the Greater Atlanta Software Symposium, Atlanta. The origin of the phrase “Java.next” most likely stems from this talk by Halloway. </p><p id="filepos1073956" class="calibre5">Hart, Peter, Nils Nilsson, and Bertram Raphael. 1968. “A Formal Basis for the Heuristic Determination of Minimum Cost Paths.” <span class="italic">IEEE Transactions on Systems Science and Cybernetics In Systems Science and Cybernetics</span> 4, no. 2. </p><p id="filepos1074223" class="calibre5">Hewitt, Carl, Peter Bishop, and Richard Steiger. 1973. “A Universal Modular ACTOR Formalism for Artificial Intelligence.” <span class="italic">Proceedings of the Third International Joint Conference on Artificial Intelligence.</span></p><p id="filepos1074471" class="calibre5">Heinlein, Robert. 1966. <span class="italic">The Moon Is a Harsh Mistress</span>. New York: Putnam. We had considered offering an implementation of Mike as an appendix, but we ran over our page count. </p><p id="filepos1074683" class="calibre5">Herlihy, Maurice, and Nir Shavit. 2008. <span class="italic">The Art of Multiprocessor Programming</span>. Amsterdam; Boston: Elsevier/Morgan Kaufmann. </p><p id="filepos1074846" class="calibre5">Hickey, Rich. 2009. “Are We There Yet?” Presented at JVM Languages Summit. This wonderful presentation made firm the popular view of Rich as Philosopher Programmer. </p><p id="filepos1075047" class="calibre5">Hofstadter, Douglas. 1979. <span class="italic">Gödel, Escher, Bach: An Eternal Golden Braid</span>. New York: Basic Books. See the sections “Classes and Instances,” “The Prototype Principle,” and “The Splitting-off of Instances from Classes” for more detail of the topics in <a href="#filepos660369"><span class="calibre8"><span class="underline">section 9.2</span></span></a>. </p><p id="filepos1075419" class="calibre5">Hoyte, Doug. 2008. <span class="italic">Let Over Lambda</span>. Lulu.com. This is an amazing look into the mind-bending power of Common Lisp macros that provided the motivation for the DSLs section of this book. It will blow your mind—in a good way. </p><p id="filepos1075682" class="calibre5">Hudak, Paul. 2000. <span class="italic">The Haskell School of Expression: Learning Functional Programming Through Multimedia.</span> New York: Cambridge University Press. </p><p id="filepos1075864" class="calibre5">Huet, Gerard. 1997. “Functional Pearl: The Zipper.” <span class="italic">Journal of Functional Programming</span>. </p><p id="filepos1075994" class="calibre5">Hutton, Graham. 1999. “A Tutorial on the Universality and Expressiveness of fold.” <span class="italic">Journal of Functional Programming</span> 9, no. 4. </p><p id="filepos1076164" class="calibre5">Kahan, William, and Joseph Darcy. 1998. “How Java’s Floating-Point Hurts Everyone Everywhere.” Presented at the ACM Workshop on Java for High-Performance Network Computing. This paper provides more information on the cyclopian nightmares awaiting you in Java floating point. </p><p id="filepos1076477" class="calibre5">Keene, Sonya. 1989. <span class="italic">Object-Oriented Programming in Common Lisp: A Programmer’s Guide to CLOS.</span> Boston: Addison-Wesley. The best book on CLOS ever written. </p><p id="filepos1076672" class="calibre5">Knuth, Donald. 1997. <span class="italic">The Art of Computer Programming: Volume 1 - Fundamental Algorithms</span>. Reading, MA: Addison-Wesley. This book goes into exquisite detail about the primary characteristics of FIFO queues and is highly recommended reading. </p><p class="calibre5">_____. 1998. <span class="italic">The Art of Computer Programming, Vol. 3: Sorting and Searching</span>. Reading, MA: Addison-Wesley. Running quick-sort on a sorted sequence is an O(n<sup class="calibre31"><small class="calibre32"><span class="calibre33">2</span></small></sup>) operation, which for our implementation in <a href="#filepos429362"><span class="calibre8"><span class="underline">chapter 6</span></span></a> completely defeats its laziness. </p><p id="filepos1077340" class="calibre5">Koenig, Dierk, Andrew Glover, Paul King, Guilaume LaForge, and Jon Skeet. 2007. <span class="italic">Groovy in Action.</span> Greenwich, CT: Manning. </p><p id="filepos1077501" class="calibre5">Kuki, Hirondo, and William James Cody. 1973. “A Statistical Study of the Accuracy of Floating Point Number Systems.” <span class="italic">Communications of the ACM</span> 1973 16, no. 4. </p><p id="filepos1077703" class="calibre5">Laddad, Ramnivas. 2003. <span class="italic">AspectJ in Action: Practical Aspect-Oriented Programming.</span> Greenwich, CT: Manning. We do not do justice to the notion of aspects—so read this instead. </p><p id="filepos1077918" class="calibre5">Martin, Robert. 2002. <span class="italic">Agile Software Development: Principles, Patterns, and Practices.</span> Upper Saddle River, NJ: Prentice Hall. </p><p id="filepos1078083" class="calibre5">McCarthy, John. 1960. “Recursive Functions of Symbolic Expressions and Their Computation by Machine, Part I.” <span class="italic">Communications of the ACM</span>. This is the essay that started it all. </p><p class="calibre5">_____. 1962. <span class="italic">LISP 1.5 Programmer’s Manual.</span> Cambridge, MA: MIT Press. Lisp had an array type at least as early as 1962. Sadly, this fact is little known. </p><p class="calibre5">McConnell, Steve. 2004. <span class="italic">Code Complete: A Practical Handbook of Software Construction</span>. Redmond, WA: Microsoft Press. </p><p id="filepos1078651" class="calibre5">Meyer, Bertrand. 1991. <span class="italic">Eiffel: The Language</span>. New York: Prentice Hall. The programming language Eiffel relies heavily on contract-based programming methodologies, a cornerstone element of Fogus’s philosophy of Apperception-Driven Development. </p><p class="calibre5">_____. 2000. <span class="italic">Object-Oriented Software Construction.</span> Upper Saddle River, NJ: Prentice Hall. </p><p id="filepos1079064" class="calibre5">Michie, Donald. 1968. “Memo Functions and Machine Learning.” <span class="italic">Nature 218.</span></p><p id="filepos1079179" class="calibre5">Mooers, Calvin, and Peter Deutsch. 1965. “TRAC, A Text-Handling Language.”</p><p id="filepos1079289" class="calibre5">Moseley, Ben, and Peter Marks. 2006. “Out of the Tar Pit.” Presented at SPA2006.</p><p id="filepos1079405" class="calibre5">Mozgovoy, Maxim. 2009. <span class="italic">Algorithms, Languages, Automata, and Compilers: A Practical Approach.</span> Sudbury, MA: Jones and Bartlett Publishers. </p><p id="filepos1079581" class="calibre5">Noble, James, and Brian Foote. 2003. “Attack of the Clones.” <span class="italic">Proceedings of the 2002 Conference on Pattern Languages of Programs 13</span>. The <tt class="calibre11">clone</tt> function is inspired by this paper. </p><p id="filepos1079812" class="calibre5">Norvig, Peter. 1991. <span class="italic">Paradigms of Artificial Intelligence Programming: Case Studies in Common Lisp.</span> San Francisco: Morgan Kaufman Publishers. </p><p id="filepos1079993" class="calibre5">Odersky, Martin, Lex Spoon, and Bill Venners. 2008. <span class="italic">Programming in Scala: A Comprehensive Step-by-step Guide.</span> Mountain View, CA: Artima. </p><p id="filepos1080169" class="calibre5">Okasaki, Chris. 1996. “The Role of Lazy Evaluation in Amortized Data Structures.” Presented at the International Conference on Functional Programming. This is a much more thorough discussion of incremental vs. monolithic computation. </p><p class="calibre5">_____. 1999. <span class="italic">Purely Functional Datastructures.</span> Cambridge University Press. Chris Okasaki to the rescue again! Clojure’s persistent queue implementation is based on Okasaki’s batched queue from this seminal work. </p><p id="filepos1080694" class="calibre5">Olsen, Russ. 2007. <span class="italic">Design Patterns in Ruby</span>. Upper Saddle River, NJ: Addison-Wesley </p><p id="filepos1080816" class="calibre5">Papadimitriou, Christos. 1986. <span class="italic">Theory of Database Concurrency Control</span>. New York: Computer Science Press, Inc. </p><p id="filepos1080965" class="calibre5">Pierce, Benjamin. 2002. <span class="italic">Types and Programming Languages</span>. Cambridge, MA: MIT Press. Fun fact: Representing numbers using lambda calculus is known as <span class="italic">church encoding</span>. The church-encoded number 9 would be represented as <tt class="calibre11">(fn [f] (fn [x] (f (f (f (f (f (f (f (f (f x)))))))))))</tt> in Clojure. </p><p id="filepos1081305" class="calibre5">Raymond, Eric. 2003. <span class="italic">The Art of Unix Programming</span>. Reading, MA: Addison-Wesley Professional. </p><p id="filepos1081436" class="calibre5">Rosenberg, Doug, Mark Collins-Cope, and Matt Stephens. 2005. <span class="italic">Agile Development with ICONIX Process: People, Process, and Pragmatism.</span> Berkeley, CA: Apress. </p><p id="filepos1081630" class="calibre5">Skeel, Robert. 1992. “Roundoff Error and the Patriot Missile.” <span class="italic">SIAM News</span> 25, no. 4: 11. </p><p id="filepos1081761" class="calibre5">Steele, Guy L. 1977. “Lambda: the Ultimate GOTO.” <span class="italic">ACM Conference Proceedings</span>. </p><p class="calibre5">_____. 1990. <span class="italic">Common LISP: The Language.</span> Bedford, MA: Digital Press. This is a very witty book in addition to being packed with information. </p><p id="filepos1082061" class="calibre5">Steele, Guy L., and Gerald Sussman. 1978. “The Art of the Interpreter.” <span class="italic">AI Memo</span> (MIT) 453. </p><p id="filepos1082195" class="calibre5">Stewart, Ian. 1995. <span class="italic">Concepts of Modern Mathematics.</span> New York: Dover. These Dover math books are often true gems. It would be great to see an adventurous publisher print a similar series revolving around C.S.-relevant topics—monads, category theory, lambda calculus, and so on. </p><p id="filepos1082513" class="calibre5">Sussman, Gerald, and Guy L. Steele. 1975. “Scheme: An Interpreter for the Extended Lambda Calculus.” <span class="italic">Higher-Order and Symbolic Computation</span> 11, no. 4. This is a discussion of Scheme’s early implementation of lexical closures. </p><p class="calibre5">Symbolics Inc. 1986. <span class="italic">Reference Guide to Symbolics Common Lisp: Language Concepts</span>. Symbolics Release 7 Document Set. </p><p id="filepos1082938" class="calibre5">Thompson, Simon. 1999. <span class="italic">Haskell: The Craft of Functional Programming.</span> Reading, MA: Addison-Wesley. </p><p id="filepos1083075" class="calibre5">Ullman, Jeffrey. 1988. <span class="italic">Principles of Database &amp; Knowledge-Base Systems Vol. 1: Classical Database Systems.</span> Rockville, MD: Computer Science Press. </p><p id="filepos1083264" class="calibre5">Ungar, David, and Randal Smith. 1987. “SELF: The power of simplicity.” Presented at the Conference on Object-Oriented Programming Systems, Languages, and Applications (OOPSLA), Orlando. The Self programming language is likely the greatest influence on prototypal inheritance. </p><p id="filepos1083576" class="calibre5">Van Roy, Peter, and Seif Haridi. 2004. <span class="italic">Concepts, Techniques, and Models of Computer Programming.</span> Cambridge, MA: MIT Press. </p><p id="filepos1083738" class="calibre5">Wadler, Philip. 1989. “Theorems for Free!” Presented at the fourth International Conference on Functional Programming and Computer Architecture. </p><p id="filepos1083919" class="calibre5">Wampler, Dean, and Alex Payne. 2009. <span class="italic">Programming Scala.</span> Sebastopol, CA: O’Reilly. </p><p id="filepos1084042" class="calibre5">Whitehead, Alfred North. 1929. <span class="italic">Process and Reality: An Essay in Cosmology.</span> Cambridge University Press. For a general overview of Whitehead, see <span class="italic">The Wit And Wisdom of Alfred North Whitehead</span> by A.H. Johnson (Boston, Beacon Press, 1947). </p><p id="filepos1084323" class="calibre5">Williams, Laurie. 2002. <span class="italic">Pair Programming Illuminated.</span> Boston: Addison-Wesley Professional. The limitations of the book format only shadow the idealistic model of pair programming. </p><p id="filepos1084542" class="calibre5"><span class="calibre18"><span class="bold">Online resources </span></span></p><p id="filepos1084620" class="calibre5">Braithwaite, Reginald. 2007. “Why Why Functional Programming Matters Matters.” <a href="http://mng.bz/2pZP"><span class="calibre8"><span class="underline">http://mng.bz/2pZP</span></span></a>. This column discusses a language-level separation of concerns. </p><p id="filepos1084884" class="calibre5">Clementson, Bill. 2008. “Clojure could be to Concurrency-Oriented Programming what Java was to OOP.” <a href="http://bc.tech.coop/blog/081201.html"><span class="calibre8"><span class="underline">http://bc.tech.coop/blog/081201.html</span></span></a>. A much deeper discussion concerning Erlang actors and Clojure agents. </p><p class="calibre5">Dekorte, Steve. Io. <a href="http://iolanguage.com"><span class="calibre8"><span class="underline">http://iolanguage.com</span></span></a>. </p><p class="calibre5">Fogus, Michael. Lithp. <a href="http://github.com/fogus/lithp"><span class="calibre8"><span class="underline">http://github.com/fogus/lithp</span></span></a>. </p><p id="filepos1085520" class="calibre5">Fowler, Martin. 2005. “Fluent Interface.” <a href="http://mng.bz/e2r5"><span class="calibre8"><span class="underline">http://mng.bz/e2r5</span></span></a>. </p><p id="filepos1085684" class="calibre5">_____. 2007. “Mocks Aren’t Stubs.” <a href="http://mng.bz/mq95"><span class="calibre8"><span class="underline">http://mng.bz/mq95</span></span></a>. </p><p class="calibre5">Graham, Paul. Arc. <a href="http://www.paulgraham.com/arc.html"><span class="calibre8"><span class="underline">www.paulgraham.com/arc.html</span></span></a>. </p><p class="calibre5">_____. 2001. “What Made Lisp Different.” <a href="http://www.paulgraham.com/diff.html"><span class="calibre8"><span class="underline">www.paulgraham.com/diff.html</span></span></a>. As Paul Graham states, “The whole language always available” appears as a theme throughout this book and as a finale in <a href="#filepos1065349"><span class="calibre8"><span class="underline">section 13.5</span></span></a>. </p><p class="calibre5">Houser, Chris. error-kit API. <a href="http://mng.bz/07FF"><span class="calibre8"><span class="underline">http://mng.bz/07FF</span></span></a>. The <tt class="calibre11">clojure.contrib.error-kit</tt> namespace contains an open error system similar to CL conditions that don’t require recompilation when defining new error types. </p><p id="filepos1086710" class="calibre5">Krukow, Karl. 2009. “Understanding Clojure’s PersistentVector Implementation.” <a href="http://mng.bz/tmjv"><span class="calibre8"><span class="underline">http://mng.bz/tmjv</span></span></a>. </p><p id="filepos1086913" class="calibre5">Lindholm, Tim, and Frank Yellin. 1999. Java Virtual Machine Specification. <a href="http://java.sun.com/docs/books/jvms/"><span class="calibre8"><span class="underline">http://java.sun.com/docs/books/jvms/</span></span></a>. </p><p class="calibre5">Peter. 1998. “Design Patterns in Dynamic Programming.” <a href="http://norvig.com/design-patterns/"><span class="calibre8"><span class="underline">http://norvig.com/design-patterns/</span></span></a>. The section on design patterns was inspired by this presentation. </p><p id="filepos1087417" class="calibre5">Tarver Mark. 2008. <span class="italic">Functional Programming in Qi.</span>
<a href="http://www.lambdassociates.org/Book/page000.htm"><span class="calibre8"><span class="underline">www.lambdassociates.org/Book/page000.htm</span></span></a>. Some programming languages perform partial application automatically when a function is supplied with fewer than the expected number of arguments. One such language is Qi. </p><p class="calibre5">_____. 2009. “The Next Lisp: Back to the Future.” <a href="http://mng.bz/8wA9"><span class="calibre8"><span class="underline">http://mng.bz/8wA9</span></span></a>. The notion of Lisp as a programming language genotype is explored. </p><p id="filepos1088053" class="calibre5">_why. Shoes. <a href="http://github.com/shoes/shoes"><span class="calibre8"><span class="underline">http://github.com/shoes/shoes</span></span></a>. </p><p id="filepos1088206" class="calibre5">Yegge, Steve. 2006. “Execution in the Kingdom of Nouns.” <a href="http://mng.bz/9ApS"><span class="calibre8"><span class="underline">http://mng.bz/9ApS</span></span></a>. </p><p id="filepos1088385" class="calibre5">_____. 2008. “The Universal Design Pattern.” <a href="http://mng.bz/6531"><span class="calibre8"><span class="underline">http://mng.bz/6531</span></span></a>. Like many programmers of our generation, we were in many ways inspired and influenced by Steve Yegge’s work—which is why we asked him to write this book’s foreword. </p><div class="mbppagebreak"></div><p id="filepos1088739" class="calibre5"><span class="calibre6"><span class="bold">Index</span></span></p><p class="calibre5"><span class="calibre10">[</span><a href="#filepos1091620"><span class="calibre10"><span class="calibre8"><span class="underline">SYMBOL</span></span></span></a><span class="calibre10">][</span><a href="#filepos1097366"><span class="calibre10"><span class="calibre8"><span class="underline">A</span></span></span></a><span class="calibre10">][</span><a href="#filepos1114939"><span class="calibre10"><span class="calibre8"><span class="underline">B</span></span></span></a><span class="calibre10">][</span><a href="#filepos1121354"><span class="calibre10"><span class="calibre8"><span class="underline">C</span></span></span></a><span class="calibre10">][</span><a href="#filepos1155163"><span class="calibre10"><span class="calibre8"><span class="underline">D</span></span></span></a><span class="calibre10">][</span><a href="#filepos1178407"><span class="calibre10"><span class="calibre8"><span class="underline">E</span></span></span></a><span class="calibre10">][</span><a href="#filepos1191663"><span class="calibre10"><span class="calibre8"><span class="underline">F</span></span></span></a><span class="calibre10">][</span><a href="#filepos1207029"><span class="calibre10"><span class="calibre8"><span class="underline">G</span></span></span></a><span class="calibre10">][</span><a href="#filepos1214231"><span class="calibre10"><span class="calibre8"><span class="underline">H</span></span></span></a><span class="calibre10">][</span><a href="#filepos1220568"><span class="calibre10"><span class="calibre8"><span class="underline">I</span></span></span></a><span class="calibre10">][</span><a href="#filepos1247025"><span class="calibre10"><span class="calibre8"><span class="underline">J</span></span></span></a><span class="calibre10">][</span><a href="#filepos1267133"><span class="calibre10"><span class="calibre8"><span class="underline">K</span></span></span></a><span class="calibre10">][</span><a href="#filepos1269527"><span class="calibre10"><span class="calibre8"><span class="underline">L</span></span></span></a><span class="calibre10">][</span><a href="#filepos1290897"><span class="calibre10"><span class="calibre8"><span class="underline">M</span></span></span></a><span class="calibre10">][</span><a href="#filepos1316013"><span class="calibre10"><span class="calibre8"><span class="underline">N</span></span></span></a><span class="calibre10">][</span><a href="#filepos1332204"><span class="calibre10"><span class="calibre8"><span class="underline">O</span></span></span></a><span class="calibre10">][</span><a href="#filepos1339037"><span class="calibre10"><span class="calibre8"><span class="underline">P</span></span></span></a><span class="calibre10">][</span><a href="#filepos1358873"><span class="calibre10"><span class="calibre8"><span class="underline">Q</span></span></span></a><span class="calibre10">][</span><a href="#filepos1361188"><span class="calibre10"><span class="calibre8"><span class="underline">R</span></span></span></a><span class="calibre10">][</span><a href="#filepos1389962"><span class="calibre10"><span class="calibre8"><span class="underline">S</span></span></span></a><span class="calibre10">][</span><a href="#filepos1421874"><span class="calibre10"><span class="calibre8"><span class="underline">T</span></span></span></a><span class="calibre10">][</span><a href="#filepos1442861"><span class="calibre10"><span class="calibre8"><span class="underline">U</span></span></span></a><span class="calibre10">][</span><a href="#filepos1446908"><span class="calibre10"><span class="calibre8"><span class="underline">V</span></span></span></a><span class="calibre10">][</span><a href="#filepos1456967"><span class="calibre10"><span class="calibre8"><span class="underline">W</span></span></span></a><span class="calibre10">][</span><a href="#filepos1461242"><span class="calibre10"><span class="calibre8"><span class="underline">X</span></span></span></a><span class="calibre10">][</span><a href="#filepos1462953"><span class="calibre10"><span class="calibre8"><span class="underline">Y</span></span></span></a><span class="calibre10">]</span></p><p id="filepos1091620" class="calibre5"><span class="bold">SYMBOL</span></p><p class="calibre5"><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos584912"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos584912"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos165700"><span class="calibre10"><span class="calibre8"><span class="underline">;</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos226995"><span class="calibre10"><span class="calibre8"><span class="underline">:as</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos252163"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos252163"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos656496"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos656496"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos913773"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos913773"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos229912"><span class="calibre10"><span class="calibre8"><span class="underline">:exclude</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos656496"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos656496"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos896931"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos896931"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos233146"><span class="calibre10"><span class="calibre8"><span class="underline">:import</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos656496"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos656496"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos656496"><span class="calibre10"><span class="calibre8"><span class="underline">:load</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos656496"><span class="calibre10"><span class="calibre8"><span class="underline">:only</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos513175"><span class="calibre10"><span class="calibre8"><span class="underline">:post</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos513175"><span class="calibre10"><span class="calibre8"><span class="underline">:pre</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos652672"><span class="calibre10"><span class="calibre8"><span class="underline">:private</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos229912"><span class="calibre10"><span class="calibre8"><span class="underline">:refer</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos656496"><span class="calibre10"><span class="calibre8"><span class="underline">:refer-clojure</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos896931"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos896931"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos229912"><span class="calibre10"><span class="calibre8"><span class="underline">:require</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos656496"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos656496"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos255350"><span class="calibre10"><span class="calibre8"><span class="underline">:strs</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos495080"><span class="calibre10"><span class="calibre8"><span class="underline">:test</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos229912"><span class="calibre10"><span class="calibre8"><span class="underline">:use</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos656496"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos656496"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos658019"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos658019"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos658019"><span class="calibre10"><span class="calibre8"><span class="underline">naked :use</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos217773"><span class="calibre10"><span class="calibre8"><span class="underline">..</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos932849"><span class="calibre10"><span class="calibre8"><span class="underline">*read-eval*</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos954859"><span class="calibre10"><span class="calibre8"><span class="underline">*warn-on-reflection*</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos993007"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos993007"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos252163"><span class="calibre10"><span class="calibre8"><span class="underline">&amp;</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos259269"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos259269"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span></p><p id="filepos1097366" class="calibre5"><span class="bold">A</span></p><p class="calibre5"><a href="#filepos567476"><span class="calibre10"><span class="calibre8"><span class="underline">A* pathfinding</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos567476"><span class="calibre10"><span class="calibre8"><span class="underline">astar</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos570402"><span class="calibre10"><span class="calibre8"><span class="underline">candidate paths</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos570402"><span class="calibre10"><span class="calibre8"><span class="underline">cost-estimate function</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos567476"><span class="calibre10"><span class="calibre8"><span class="underline">path-finding</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos150827"><span class="calibre10"><span class="calibre8"><span class="underline">abstraction-oriented programming</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos642651"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos642651"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos661881"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos661881"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos677728"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos677728"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos729672"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos729672"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos978813"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos978813"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos612640"><span class="calibre10"><span class="calibre8"><span class="underline">abstractions</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos674644"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos674644"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos733653"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos733653"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos796508"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos796508"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos974654"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos974654"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos982226"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos982226"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos717394"><span class="calibre10"><span class="calibre8"><span class="underline">accessors</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos830061"><span class="calibre10"><span class="calibre8"><span class="underline">ACID</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos150827"><span class="calibre10"><span class="calibre8"><span class="underline">ad-hoc hierarchies</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos312307"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos312307"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos661881"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos661881"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos667913"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos667913"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos674644"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos674644"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1039413"><span class="calibre10"><span class="calibre8"><span class="underline">8<sup class="calibre135"><small class="calibre32"><a href="#filepos1039413"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos667913"><span class="calibre10"><span class="calibre8"><span class="underline">derivation hierarchy</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos671230"><span class="calibre10"><span class="calibre8"><span class="underline">make-hierarchy</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos954859"><span class="calibre10"><span class="calibre8"><span class="underline">adornment</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos821265"><span class="calibre10"><span class="calibre8"><span class="underline">Agents</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos837118"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos837118"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos860093"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos860093"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos866594"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos866594"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos948562"><span class="calibre10"><span class="calibre8"><span class="underline">17<sup class="calibre135"><small class="calibre32"><a href="#filepos948562"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos880160"><span class="calibre10"><span class="calibre8"><span class="underline">agent-error</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos866594"><span class="calibre10"><span class="calibre8"><span class="underline">await</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos886905"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos886905"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos870513"><span class="calibre10"><span class="calibre8"><span class="underline">await-for</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos860093"><span class="calibre10"><span class="calibre8"><span class="underline">queue</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos873396"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos873396"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos880160"><span class="calibre10"><span class="calibre8"><span class="underline">restart-agent</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos863130"><span class="calibre10"><span class="calibre8"><span class="underline">send</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos873396"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos873396"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos863130"><span class="calibre10"><span class="calibre8"><span class="underline">send-off</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos873396"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos873396"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos866594"><span class="calibre10"><span class="calibre8"><span class="underline">serialize access</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos717394"><span class="calibre10"><span class="calibre8"><span class="underline">agile</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos954859"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos954859"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos766553"><span class="calibre10"><span class="calibre8"><span class="underline">Ahead of Time Compilation (AOT)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos796508"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos796508"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos761773"><span class="calibre10"><span class="calibre8"><span class="underline">alert</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos348941"><span class="calibre10"><span class="calibre8"><span class="underline">algorithm</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos658019"><span class="calibre10"><span class="calibre8"><span class="underline">alias</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos624210"><span class="calibre10"><span class="calibre8"><span class="underline">anaphora</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos742481"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos742481"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos633367"><span class="calibre10"><span class="calibre8"><span class="underline">anaphoric</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos624210"><span class="calibre10"><span class="calibre8"><span class="underline">anaphoric macros</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos742481"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos742481"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos667913"><span class="calibre10"><span class="calibre8"><span class="underline">ancestors</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos451388"><span class="calibre10"><span class="calibre8"><span class="underline">and (logical)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos639486"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos639486"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos487698"><span class="calibre10"><span class="calibre8"><span class="underline">anonymous inner classes</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos652672"><span class="calibre10"><span class="calibre8"><span class="underline">Apache Ant</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos410404"><span class="calibre10"><span class="calibre8"><span class="underline">apply</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos491321"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos491321"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos309082"><span class="calibre10"><span class="calibre8"><span class="underline">aquarium</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos624210"><span class="calibre10"><span class="calibre8"><span class="underline">Arc (programming language)</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos624210"><span class="calibre10"><span class="calibre8"><span class="underline">awhen</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos606505"><span class="calibre10"><span class="calibre8"><span class="underline">arglists</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos305094"><span class="calibre10"><span class="calibre8"><span class="underline">argument</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos324854"><span class="calibre10"><span class="calibre8"><span class="underline">arrays</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos334761"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos334761"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos341202"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos341202"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos766553"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos766553"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos773716"><span class="calibre10"><span class="calibre8"><span class="underline">amap</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos773716"><span class="calibre10"><span class="calibre8"><span class="underline">areduce</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos781302"><span class="calibre10"><span class="calibre8"><span class="underline">multidimensional arrays</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos766553"><span class="calibre10"><span class="calibre8"><span class="underline">primitive arrays</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos766553"><span class="calibre10"><span class="calibre8"><span class="underline">reference arrays</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos773716"><span class="calibre10"><span class="calibre8"><span class="underline">seq of an array</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos911113"><span class="calibre10"><span class="calibre8"><span class="underline">as-futures</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos926419"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos926419"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos252163"><span class="calibre10"><span class="calibre8"><span class="underline">as-is</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos518685"><span class="calibre10"><span class="calibre8"><span class="underline">aspects</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos359275"><span class="calibre10"><span class="calibre8"><span class="underline">assoc</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos685935"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos685935"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos300179"><span class="calibre10"><span class="calibre8"><span class="underline">associative</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos363711"><span class="calibre10"><span class="calibre8"><span class="underline">assoc-in</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos773716"><span class="calibre10"><span class="calibre8"><span class="underline">asum-sq</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos954859"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos954859"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos837118"><span class="calibre10"><span class="calibre8"><span class="underline">asynchronous</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos860093"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos860093"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos830061"><span class="calibre10"><span class="calibre8"><span class="underline">atomicity</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos886905"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos886905"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos821265"><span class="calibre10"><span class="calibre8"><span class="underline">Atoms</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos837118"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos837118"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos886905"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos886905"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos886905"><span class="calibre10"><span class="calibre8"><span class="underline">compare-and-set!</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos988832"><span class="calibre10"><span class="calibre8"><span class="underline">autoboxing</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos214245"><span class="calibre10"><span class="calibre8"><span class="underline">auto-gensym</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos609594"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos609594"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span></p><p id="filepos1114939" class="calibre5"><span class="bold">B</span></p><p class="calibre5"><a href="#filepos320736"><span class="calibre10"><span class="calibre8"><span class="underline">backslash</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos847407"><span class="calibre10"><span class="calibre8"><span class="underline">bad-make-move</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos661881"><span class="calibre10"><span class="calibre8"><span class="underline">beget</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos965764"><span class="calibre10"><span class="calibre8"><span class="underline">benchmark</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos317285"><span class="calibre10"><span class="calibre8"><span class="underline">best</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1035854"><span class="calibre10"><span class="calibre8"><span class="underline">best practices</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos348941"><span class="calibre10"><span class="calibre8"><span class="underline">best-case</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos567476"><span class="calibre10"><span class="calibre8"><span class="underline">best-first</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos945059"><span class="calibre10"><span class="calibre8"><span class="underline">BigDecimal</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos334761"><span class="calibre10"><span class="calibre8"><span class="underline">Big-O</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos346086"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos346086"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos334761"><span class="calibre10"><span class="calibre8"><span class="underline">algorithmic complexity</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos346086"><span class="calibre10"><span class="calibre8"><span class="underline">asymptotic complexity</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos483652"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos483652"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos348941"><span class="calibre10"><span class="calibre8"><span class="underline">linear time</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos348941"><span class="calibre10"><span class="calibre8"><span class="underline">logarithmic complexity</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos248530"><span class="calibre10"><span class="calibre8"><span class="underline">bind</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos248530"><span class="calibre10"><span class="calibre8"><span class="underline">binding</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1025528"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1025528"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos262114"><span class="calibre10"><span class="calibre8"><span class="underline">bit-xor</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos191973"><span class="calibre10"><span class="calibre8"><span class="underline">blocks</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos198412"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos198412"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos599655"><span class="calibre10"><span class="calibre8"><span class="underline">boilerplate</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos606505"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos606505"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos532161"><span class="calibre10"><span class="calibre8"><span class="underline">bot object</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1018721"><span class="calibre10"><span class="calibre8"><span class="underline">bottom-up programming</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos939799"><span class="calibre10"><span class="calibre8"><span class="underline">bound</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos988832"><span class="calibre10"><span class="calibre8"><span class="underline">boxing</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos988832"><span class="calibre10"><span class="calibre8"><span class="underline">autoboxing</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos988832"><span class="calibre10"><span class="calibre8"><span class="underline">unboxing</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1055195"><span class="calibre10"><span class="calibre8"><span class="underline">breakpoint</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos637507"><span class="calibre10"><span class="calibre8"><span class="underline">build-contract</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos652672"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos652672"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos726645"><span class="calibre10"><span class="calibre8"><span class="underline">build-move</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos355623"><span class="calibre10"><span class="calibre8"><span class="underline">byte</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos539455"><span class="calibre10"><span class="calibre8"><span class="underline">bytecode</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos733653"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos733653"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos740177"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos740177"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos781302"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos781302"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos958691"><span class="calibre10"><span class="calibre8"><span class="underline">bytes</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span></p><p id="filepos1121354" class="calibre5"><span class="bold">C</span></p><p class="calibre5"><a href="#filepos124211"><span class="calibre10"><span class="calibre8"><span class="underline">C (programming language)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos165700"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos165700"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos695626"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos695626"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos706927"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos706927"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos300179"><span class="calibre10"><span class="calibre8"><span class="underline">calculations, precise</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos314354"><span class="calibre10"><span class="calibre8"><span class="underline">call stack</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos528029"><span class="calibre10"><span class="calibre8"><span class="underline">callbacks</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos920693"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos920693"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos467745"><span class="calibre10"><span class="calibre8"><span class="underline">call-by-need</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos262114"><span class="calibre10"><span class="calibre8"><span class="underline">canvas</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos229912"><span class="calibre10"><span class="calibre8"><span class="underline">capitalize</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos324854"><span class="calibre10"><span class="calibre8"><span class="underline">capturing group</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos346086"><span class="calibre10"><span class="calibre8"><span class="underline">car</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos381464"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos381464"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos562391"><span class="calibre10"><span class="calibre8"><span class="underline">case</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1018721"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1018721"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos717394"><span class="calibre10"><span class="calibre8"><span class="underline">chaining</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos737904"><span class="calibre10"><span class="calibre8"><span class="underline">change-message</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos742481"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos742481"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos355623"><span class="calibre10"><span class="calibre8"><span class="underline">char</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos320736"><span class="calibre10"><span class="calibre8"><span class="underline">character classes</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos172769"><span class="calibre10"><span class="calibre8"><span class="underline">characters, in a string</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos958691"><span class="calibre10"><span class="calibre8"><span class="underline">chars</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos150827"><span class="calibre10"><span class="calibre8"><span class="underline">chess</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos717394"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos717394"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos723655"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos723655"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos840697"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos840697"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos844230"><span class="calibre10"><span class="calibre8"><span class="underline">choose-move</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos971369"><span class="calibre10"><span class="calibre8"><span class="underline">chunked sequences</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos119072"><span class="calibre10"><span class="calibre8"><span class="underline">clarity</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos995611"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos995611"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos276130"><span class="calibre10"><span class="calibre8"><span class="underline">clear</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos880160"><span class="calibre10"><span class="calibre8"><span class="underline">clear-actions</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos619398"><span class="calibre10"><span class="calibre8"><span class="underline">clojure.contrib.json</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos265366"><span class="calibre10"><span class="calibre8"><span class="underline">clojure.contrib.repl-utils</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos229912"><span class="calibre10"><span class="calibre8"><span class="underline">clojure.core</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos646754"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos646754"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos658019"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos658019"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos936347"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos936347"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos746497"><span class="calibre10"><span class="calibre8"><span class="underline">clojure.lang.IMeta</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos367438"><span class="calibre10"><span class="calibre8"><span class="underline">clojure.lang.IPersistentStack</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos390122"><span class="calibre10"><span class="calibre8"><span class="underline">clojure.lang.PersistentQueue/EMPTY</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1055195"><span class="calibre10"><span class="calibre8"><span class="underline">clojure.main/repl</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos226995"><span class="calibre10"><span class="calibre8"><span class="underline">clojure.set</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos396742"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos396742"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos403710"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos403710"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos658019"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos658019"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1007562"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos1007562"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos229912"><span class="calibre10"><span class="calibre8"><span class="underline">clojure.string</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos495080"><span class="calibre10"><span class="calibre8"><span class="underline">clojure.test</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos658019"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos658019"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1025528"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos1025528"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos495080"><span class="calibre10"><span class="calibre8"><span class="underline">clojure.test/run-tests</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos658019"><span class="calibre10"><span class="calibre8"><span class="underline">clojure.xml</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos907496"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos907496"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1041654"><span class="calibre10"><span class="calibre8"><span class="underline">clojure.xml/emit</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos911113"><span class="calibre10"><span class="calibre8"><span class="underline">clojure.xml/parse</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1045580"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1045580"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos658019"><span class="calibre10"><span class="calibre8"><span class="underline">clojure.zip</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos907496"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos907496"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos911113"><span class="calibre10"><span class="calibre8"><span class="underline">clojure.zip/xml-zip</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos154287"><span class="calibre10"><span class="calibre8"><span class="underline">closures</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos518685"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos518685"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos704512"><span class="calibre10"><span class="calibre8"><span class="underline">8<sup class="calibre135"><small class="calibre32"><a href="#filepos704512"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos806113"><span class="calibre10"><span class="calibre8"><span class="underline">9<sup class="calibre135"><small class="calibre32"><a href="#filepos806113"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos896931"><span class="calibre10"><span class="calibre8"><span class="underline">10<sup class="calibre135"><small class="calibre32"><a href="#filepos896931"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1041654"><span class="calibre10"><span class="calibre8"><span class="underline">11<sup class="calibre135"><small class="calibre32"><a href="#filepos1041654"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos525267"><span class="calibre10"><span class="calibre8"><span class="underline">closing over parameters</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos521637"><span class="calibre10"><span class="calibre8"><span class="underline">functions returning closures</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos154287"><span class="calibre10"><span class="calibre8"><span class="underline">lexical closures</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos525267"><span class="calibre10"><span class="calibre8"><span class="underline">passing closures as functions</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos528029"><span class="calibre10"><span class="calibre8"><span class="underline">sharing closure context</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos953012"><span class="calibre10"><span class="calibre8"><span class="underline">coercion</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos986264"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos986264"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos999044"><span class="calibre10"><span class="calibre8"><span class="underline">fifth rule of coercion</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos988832"><span class="calibre10"><span class="calibre8"><span class="underline">first rule of coercion</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos995611"><span class="calibre10"><span class="calibre8"><span class="underline">fourth rule of coercion</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos995611"><span class="calibre10"><span class="calibre8"><span class="underline">second rule of coercion</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos995611"><span class="calibre10"><span class="calibre8"><span class="underline">third rule of coercion</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos633367"><span class="calibre10"><span class="calibre8"><span class="underline">collect-bodies</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos244732"><span class="calibre10"><span class="calibre8"><span class="underline">collection</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos962026"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos962026"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos172769"><span class="calibre10"><span class="calibre8"><span class="underline">colon</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos501688"><span class="calibre10"><span class="calibre8"><span class="underline">columns</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos165700"><span class="calibre10"><span class="calibre8"><span class="underline">commenting</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos324854"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos324854"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos863130"><span class="calibre10"><span class="calibre8"><span class="underline">commits</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos244732"><span class="calibre10"><span class="calibre8"><span class="underline">Common Lisp (programming language)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos317285"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos317285"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos620874"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos620874"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1018721"><span class="calibre10"><span class="calibre8"><span class="underline">9<sup class="calibre135"><small class="calibre32"><a href="#filepos1018721"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos346086"><span class="calibre10"><span class="calibre8"><span class="underline">cdr</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos381464"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos381464"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos671230"><span class="calibre10"><span class="calibre8"><span class="underline">Common Lisp Object System (CLOS)</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos317285"><span class="calibre10"><span class="calibre8"><span class="underline">funcall</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos317285"><span class="calibre10"><span class="calibre8"><span class="underline">Lisp-2</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos491321"><span class="calibre10"><span class="calibre8"><span class="underline">comp</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos501688"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos501688"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos400718"><span class="calibre10"><span class="calibre8"><span class="underline">comparator</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos886905"><span class="calibre10"><span class="calibre8"><span class="underline">compare-and-swap</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos539455"><span class="calibre10"><span class="calibre8"><span class="underline">compile</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos750235"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos750235"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos460891"><span class="calibre10"><span class="calibre8"><span class="underline">compiler</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos750235"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos750235"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos766553"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos766553"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos953012"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos953012"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos988832"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos988832"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos276130"><span class="calibre10"><span class="calibre8"><span class="underline">Compiler.java</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos539455"><span class="calibre10"><span class="calibre8"><span class="underline">compile-time</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos809785"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos809785"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos495080"><span class="calibre10"><span class="calibre8"><span class="underline">complement</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos501688"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos501688"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1041654"><span class="calibre10"><span class="calibre8"><span class="underline">composition</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos965764"><span class="calibre10"><span class="calibre8"><span class="underline">concat</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos140178"><span class="calibre10"><span class="calibre8"><span class="underline">concrescence</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos150827"><span class="calibre10"><span class="calibre8"><span class="underline">concrete classes</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos692267"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos692267"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos699217"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos699217"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos733653"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos733653"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos982226"><span class="calibre10"><span class="calibre8"><span class="underline">concrete realization</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos106743"><span class="calibre10"><span class="calibre8"><span class="underline">concurrency</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos143914"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos143914"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos434853"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos434853"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos819388"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos819388"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos853266"><span class="calibre10"><span class="calibre8"><span class="underline">11<sup class="calibre135"><small class="calibre32"><a href="#filepos853266"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos866594"><span class="calibre10"><span class="calibre8"><span class="underline">14<sup class="calibre135"><small class="calibre32"><a href="#filepos866594"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos896931"><span class="calibre10"><span class="calibre8"><span class="underline">15<sup class="calibre135"><small class="calibre32"><a href="#filepos896931"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos903922"><span class="calibre10"><span class="calibre8"><span class="underline">18<sup class="calibre135"><small class="calibre32"><a href="#filepos903922"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos773716"><span class="calibre10"><span class="calibre8"><span class="underline">concurrent modification</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos899564"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos899564"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos434853"><span class="calibre10"><span class="calibre8"><span class="underline">concurrent modification errors</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos819388"><span class="calibre10"><span class="calibre8"><span class="underline">concurrent programming</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos863130"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos863130"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos899564"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos899564"><span class="calibre33"><span class="calibre8"><span class="underline">rd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos824968"><span class="calibre10"><span class="calibre8"><span class="underline">lost wakeup</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos863130"><span class="calibre10"><span class="calibre8"><span class="underline">model, distributed</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos830061"><span class="calibre10"><span class="calibre8"><span class="underline">priority inversion</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos821265"><span class="calibre10"><span class="calibre8"><span class="underline">vs. parallelism</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos309082"><span class="calibre10"><span class="calibre8"><span class="underline">cond</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos599655"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos599655"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1018721"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos1018721"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos965764"><span class="calibre10"><span class="calibre8"><span class="underline">confounding</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos367438"><span class="calibre10"><span class="calibre8"><span class="underline">conj</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos374641"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos374641"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos381464"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos381464"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos438268"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos438268"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos701761"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos701761"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos202245"><span class="calibre10"><span class="calibre8"><span class="underline">cons</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos381464"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos381464"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos119072"><span class="calibre10"><span class="calibre8"><span class="underline">consistency</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos830061"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos830061"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos844230"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos844230"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos903922"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos903922"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos830061"><span class="calibre10"><span class="calibre8"><span class="underline">reporting problem</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos348941"><span class="calibre10"><span class="calibre8"><span class="underline">constant factor</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos965764"><span class="calibre10"><span class="calibre8"><span class="underline">constant time</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos217773"><span class="calibre10"><span class="calibre8"><span class="underline">constructors</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos276130"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos276130"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos706927"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos706927"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos723655"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos723655"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos746497"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos746497"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1041654"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos1041654"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos377793"><span class="calibre10"><span class="calibre8"><span class="underline">contains?</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos385731"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos385731"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos400718"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos400718"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos564727"><span class="calibre10"><span class="calibre8"><span class="underline">continuation-passing style (CPS)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos802733"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos802733"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1039413"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos1039413"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos564727"><span class="calibre10"><span class="calibre8"><span class="underline">accept function</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos564727"><span class="calibre10"><span class="calibre8"><span class="underline">return continuation</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos876840"><span class="calibre10"><span class="calibre8"><span class="underline">continue</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos883417"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos883417"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos619398"><span class="calibre10"><span class="calibre8"><span class="underline">contrib</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos936347"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos936347"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos582902"><span class="calibre10"><span class="calibre8"><span class="underline">control structures</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos588824"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos588824"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos595526"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos595526"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos603106"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos603106"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1013697"><span class="calibre10"><span class="calibre8"><span class="underline">conversion specification</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos840697"><span class="calibre10"><span class="calibre8"><span class="underline">coordination</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos929918"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos929918"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos793099"><span class="calibre10"><span class="calibre8"><span class="underline">copies, defensive</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos381464"><span class="calibre10"><span class="calibre8"><span class="underline">counted</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos962026"><span class="calibre10"><span class="calibre8"><span class="underline">counter-optimizations</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos911113"><span class="calibre10"><span class="calibre8"><span class="underline">count-tweet-text-task</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos920693"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos920693"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos646754"><span class="calibre10"><span class="calibre8"><span class="underline">create-ns</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos309082"><span class="calibre10"><span class="calibre8"><span class="underline">crypto</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span></p><p id="filepos1155163" class="calibre5"><span class="bold">D</span></p><p class="calibre5"><a href="#filepos431211"><span class="calibre10"><span class="calibre8"><span class="underline">data structures, immutable</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos824968"><span class="calibre10"><span class="calibre8"><span class="underline">database</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos824968"><span class="calibre10"><span class="calibre8"><span class="underline">deadlock</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos830061"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos830061"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos863130"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos863130"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos899564"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos899564"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos922915"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos922915"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos922915"><span class="calibre10"><span class="calibre8"><span class="underline">deterministic</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1055195"><span class="calibre10"><span class="calibre8"><span class="underline">debug</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1055195"><span class="calibre10"><span class="calibre8"><span class="underline">debug console</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1003113"><span class="calibre10"><span class="calibre8"><span class="underline">debugging</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1058911"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1058911"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1064931"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos1064931"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1055195"><span class="calibre10"><span class="calibre8"><span class="underline">debug-repl</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos169568"><span class="calibre10"><span class="calibre8"><span class="underline">decimal</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos464962"><span class="calibre10"><span class="calibre8"><span class="underline">declarative</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1003113"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1003113"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos633367"><span class="calibre10"><span class="calibre8"><span class="underline">declare</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos186016"><span class="calibre10"><span class="calibre8"><span class="underline">def</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos518685"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos518685"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos525267"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos525267"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos652672"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos652672"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos936347"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos936347"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos945059"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos945059"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos737904"><span class="calibre10"><span class="calibre8"><span class="underline">default-handler</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1035854"><span class="calibre10"><span class="calibre8"><span class="underline">defformula</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos796508"><span class="calibre10"><span class="calibre8"><span class="underline">definterface</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos599655"><span class="calibre10"><span class="calibre8"><span class="underline">defmacro</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos652672"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos652672"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos936347"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos936347"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos674644"><span class="calibre10"><span class="calibre8"><span class="underline">defmulti</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos936347"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos936347"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos154287"><span class="calibre10"><span class="calibre8"><span class="underline">defn</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos186016"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos186016"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos521637"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos521637"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos606505"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos606505"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos652672"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos652672"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos936347"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos936347"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos936347"><span class="calibre10"><span class="calibre8"><span class="underline">defonce</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos802733"><span class="calibre10"><span class="calibre8"><span class="underline">defprotocol</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos677728"><span class="calibre10"><span class="calibre8"><span class="underline">defrecord</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos710504"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos710504"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos656496"><span class="calibre10"><span class="calibre8"><span class="underline">defstruct</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos681989"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos681989"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos681989"><span class="calibre10"><span class="calibre8"><span class="underline">downfall of defstructs</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1013697"><span class="calibre10"><span class="calibre8"><span class="underline">defunits-of</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos609594"><span class="calibre10"><span class="calibre8"><span class="underline">def-watched</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos447193"><span class="calibre10"><span class="calibre8"><span class="underline">delay</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos467745"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos467745"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos474679"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos474679"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos567476"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos567476"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos986264"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos986264"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos757665"><span class="calibre10"><span class="calibre8"><span class="underline">delegate</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos982226"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos982226"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1041654"><span class="calibre10"><span class="calibre8"><span class="underline">dependency injection (DI)</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos837118"><span class="calibre10"><span class="calibre8"><span class="underline">deref</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos886905"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos886905"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos932849"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos932849"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos939799"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos939799"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos667913"><span class="calibre10"><span class="calibre8"><span class="underline">derive</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos667913"><span class="calibre10"><span class="calibre8"><span class="underline">descendants</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1035854"><span class="calibre10"><span class="italic"><span class="calibre8"><span class="underline">Design Patterns: Elements of Reusable Object-Oriented Software</span></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos124211"><span class="calibre10"><span class="calibre8"><span class="underline">destructuring</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos248530"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos248530"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos272636"><span class="calibre10"><span class="calibre8"><span class="underline">9<sup class="calibre135"><small class="calibre32"><a href="#filepos272636"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos283469"><span class="calibre10"><span class="calibre8"><span class="underline">10<sup class="calibre135"><small class="calibre32"><a href="#filepos283469"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos513175"><span class="calibre10"><span class="calibre8"><span class="underline">11<sup class="calibre135"><small class="calibre32"><a href="#filepos513175"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos844230"><span class="calibre10"><span class="calibre8"><span class="underline">12<sup class="calibre135"><small class="calibre32"><a href="#filepos844230"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos259269"><span class="calibre10"><span class="calibre8"><span class="underline">associative destructuring</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos259269"><span class="calibre10"><span class="calibre8"><span class="underline">in function parameters</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos255350"><span class="calibre10"><span class="calibre8"><span class="underline">nested</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos259269"><span class="calibre10"><span class="calibre8"><span class="underline">versus accessor methods</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos255350"><span class="calibre10"><span class="calibre8"><span class="underline">with a map</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos252163"><span class="calibre10"><span class="calibre8"><span class="underline">with a vector</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos821265"><span class="calibre10"><span class="calibre8"><span class="underline">determinacy</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos252163"><span class="calibre10"><span class="calibre8"><span class="underline">directive</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos265366"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos265366"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos649759"><span class="calibre10"><span class="calibre8"><span class="underline">directory structure</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos269173"><span class="calibre10"><span class="calibre8"><span class="underline">disappear</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos671230"><span class="calibre10"><span class="calibre8"><span class="underline">dispatch</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos746497"><span class="calibre10"><span class="calibre8"><span class="underline">display</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos367438"><span class="calibre10"><span class="calibre8"><span class="underline">dissoc</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos681989"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos681989"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos894104"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos894104"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos300179"><span class="calibre10"><span class="calibre8"><span class="underline">distributive</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos191973"><span class="calibre10"><span class="calibre8"><span class="underline">do</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos603106"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos603106"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos907496"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos907496"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos948562"><span class="calibre10"><span class="calibre8"><span class="underline">doall</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos269173"><span class="calibre10"><span class="calibre8"><span class="underline">documentation, viewing</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos612640"><span class="calibre10"><span class="calibre8"><span class="underline">domain</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos130968"><span class="calibre10"><span class="calibre8"><span class="underline">domain-specific language (DSL)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos312307"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos312307"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos606505"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos606505"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos616303"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos616303"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos633367"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos633367"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos723655"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos723655"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1001639"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos1001639"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1018721"><span class="calibre10"><span class="calibre8"><span class="underline">10<sup class="calibre135"><small class="calibre32"><a href="#filepos1018721"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1029566"><span class="calibre10"><span class="calibre8"><span class="underline">11<sup class="calibre135"><small class="calibre32"><a href="#filepos1029566"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos1032555"><span class="calibre10"><span class="calibre8"><span class="underline">domain expertise</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos1010279"><span class="calibre10"><span class="calibre8"><span class="underline">putting parentheses around the specification</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos1015603"><span class="calibre10"><span class="calibre8"><span class="underline">unit conversion DSL</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos276130"><span class="calibre10"><span class="calibre8"><span class="underline">don’t panic</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos119072"><span class="calibre10"><span class="calibre8"><span class="underline">doseq</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos244732"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos244732"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos276130"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos276130"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos844230"><span class="calibre10"><span class="calibre8"><span class="underline">dosync</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos863130"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos863130"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos837118"><span class="calibre10"><span class="calibre8"><span class="underline">dothreads!</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos886905"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos886905"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos220826"><span class="calibre10"><span class="calibre8"><span class="underline">doto</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos291601"><span class="calibre10"><span class="calibre8"><span class="underline">double</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos355623"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos355623"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos781302"><span class="calibre10"><span class="calibre8"><span class="underline">double-array</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos320736"><span class="calibre10"><span class="calibre8"><span class="underline">double-backslash</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos320736"><span class="calibre10"><span class="calibre8"><span class="underline">double-quotes</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos297423"><span class="calibre10"><span class="calibre8"><span class="underline">doubles</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos958691"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos958691"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos599655"><span class="calibre10"><span class="calibre8"><span class="underline">do-until</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos269173"><span class="calibre10"><span class="calibre8"><span class="underline">drawing</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos677728"><span class="calibre10"><span class="calibre8"><span class="underline">duck typing</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos833639"><span class="calibre10"><span class="calibre8"><span class="underline">dummy write</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos830061"><span class="calibre10"><span class="calibre8"><span class="underline">durability</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos750235"><span class="calibre10"><span class="calibre8"><span class="underline">DynaFrame.clj</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos945059"><span class="calibre10"><span class="calibre8"><span class="underline">dynamic scope</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1045580"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1045580"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1051831"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos1051831"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos954859"><span class="calibre10"><span class="calibre8"><span class="underline">dynamic type systems</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos986264"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos986264"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span></p><p id="filepos1178407" class="calibre5"><span class="bold">E</span></p><p class="calibre5"><a href="#filepos140178"><span class="calibre10"><span class="calibre8"><span class="underline">elegance</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos241365"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos241365"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos320736"><span class="calibre10"><span class="calibre8"><span class="underline">embedding</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos115164"><span class="calibre10"><span class="calibre8"><span class="underline">empowerment</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos338249"><span class="calibre10"><span class="calibre8"><span class="underline">empty sequence</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos244732"><span class="calibre10"><span class="calibre8"><span class="underline">empty?</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos150827"><span class="calibre10"><span class="calibre8"><span class="underline">encapsulation</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1041654"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos1041654"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos154287"><span class="calibre10"><span class="calibre8"><span class="underline">block-level encapsulation</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos154287"><span class="calibre10"><span class="calibre8"><span class="underline">local encapsulation</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos154287"><span class="calibre10"><span class="calibre8"><span class="underline">namespace encapsulation</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos619398"><span class="calibre10"><span class="calibre8"><span class="underline">Enlive</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos305094"><span class="calibre10"><span class="calibre8"><span class="underline">enumeration values</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos338249"><span class="calibre10"><span class="calibre8"><span class="underline">enumerator</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1058911"><span class="calibre10"><span class="calibre8"><span class="underline">env</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos962026"><span class="calibre10"><span class="calibre8"><span class="underline">ephemeral</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos305094"><span class="calibre10"><span class="calibre8"><span class="underline">equality</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos312307"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos312307"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos434853"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos434853"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos671230"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos671230"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos341202"><span class="calibre10"><span class="calibre8"><span class="underline">equality partitions</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos422754"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos422754"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos786956"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos786956"><span class="calibre33"><span class="calibre8"><span class="underline">rd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos341202"><span class="calibre10"><span class="calibre8"><span class="underline">equality semantics</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos802733"><span class="calibre10"><span class="calibre8"><span class="underline">error handling</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos883417"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos883417"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1045580"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos1045580"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos320736"><span class="calibre10"><span class="calibre8"><span class="underline">escaped</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos202245"><span class="calibre10"><span class="calibre8"><span class="underline">evaluation</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos592974"><span class="calibre10"><span class="calibre8"><span class="underline">contextual-eval</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1058911"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1058911"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos588824"><span class="calibre10"><span class="calibre8"><span class="underline">eval</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1055195"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1055195"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos1003113"><span class="calibre10"><span class="calibre8"><span class="underline">meta-circular</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos220826"><span class="calibre10"><span class="calibre8"><span class="underline">exceptions</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos276130"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos276130"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos726645"><span class="calibre10"><span class="calibre8"><span class="underline">9<sup class="calibre135"><small class="calibre32"><a href="#filepos726645"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos802733"><span class="calibre10"><span class="calibre8"><span class="underline">10<sup class="calibre135"><small class="calibre32"><a href="#filepos802733"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos824968"><span class="calibre10"><span class="calibre8"><span class="underline">20<sup class="calibre135"><small class="calibre32"><a href="#filepos824968"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><a href="#filepos876840"><span class="calibre10"><span class="calibre8"><span class="underline">exceptions</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos968286"><span class="calibre10"><span class="calibre8"><span class="underline">exceptions</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos1003113"><span class="calibre10"><span class="calibre8"><span class="underline">exceptions</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos1045580"><span class="calibre10"><span class="calibre8"><span class="underline">exceptions</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos220826"><span class="calibre10"><span class="calibre8"><span class="underline">catch</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1051831"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1051831"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos802733"><span class="calibre10"><span class="calibre8"><span class="underline">checked</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos276130"><span class="calibre10"><span class="calibre8"><span class="underline">compile-time</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos809785"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos809785"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos899564"><span class="calibre10"><span class="calibre8"><span class="underline">ConcurrentModification-Exception</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos631267"><span class="calibre10"><span class="calibre8"><span class="underline">finally</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos903922"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos903922"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos802733"><span class="calibre10"><span class="calibre8"><span class="underline">handling</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos809785"><span class="calibre10"><span class="calibre8"><span class="underline">java.lang.ClassCastException</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos806113"><span class="calibre10"><span class="calibre8"><span class="underline">java.lang.Exception</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos451388"><span class="calibre10"><span class="calibre8"><span class="underline">java.lang.NullPointer-Exception</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos806113"><span class="calibre10"><span class="calibre8"><span class="underline">java.lang.RuntimeException</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos806113"><span class="calibre10"><span class="calibre8"><span class="underline">runtime</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos806113"><span class="calibre10"><span class="calibre8"><span class="underline">runtime vs. compile-time</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos220826"><span class="calibre10"><span class="calibre8"><span class="underline">throw</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos272636"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos272636"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos809785"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos809785"><span class="calibre33"><span class="calibre8"><span class="underline">rd</span></span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos132921"><span class="calibre10"><span class="calibre8"><span class="underline">expand-clause</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1015603"><span class="calibre10"><span class="calibre8"><span class="underline">expansion</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos348941"><span class="calibre10"><span class="calibre8"><span class="underline">expected case</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos646754"><span class="calibre10"><span class="calibre8"><span class="underline">experimentation</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos150827"><span class="calibre10"><span class="calibre8"><span class="underline">expression problem</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos147823"><span class="calibre10"><span class="calibre8"><span class="underline">extend</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos688468"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos688468"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos699217"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos699217"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos710504"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos710504"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos688468"><span class="calibre10"><span class="calibre8"><span class="underline">extend-protocol</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos704512"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos704512"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos688468"><span class="calibre10"><span class="calibre8"><span class="underline">extend-type</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos704512"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos704512"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos619398"><span class="calibre10"><span class="calibre8"><span class="underline">Extensible Markup Language (XML)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos907496"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos907496"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1041654"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos1041654"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span></p><p id="filepos1191663" class="calibre5"><span class="bold">F</span></p><p class="calibre5"><a href="#filepos136438"><span class="calibre10"><span class="calibre8"><span class="underline">Factor (programming language)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1029566"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1029566"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1041654"><span class="calibre10"><span class="calibre8"><span class="underline">factory methods</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos876840"><span class="calibre10"><span class="calibre8"><span class="underline">fail</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos883417"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos883417"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos237582"><span class="calibre10"><span class="calibre8"><span class="underline">false</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos279910"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos279910"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos237582"><span class="calibre10"><span class="calibre8"><span class="underline">evil-false</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos731809"><span class="calibre10"><span class="calibre8"><span class="underline">Fantom (programming language)</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos722454"><span class="calibre10"><span class="calibre8"><span class="underline">fence post errors</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos338249"><span class="calibre10"><span class="calibre8"><span class="underline">filter</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos467745"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos467745"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos498369"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos498369"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos528029"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos528029"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1039413"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos1039413"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos262114"><span class="calibre10"><span class="calibre8"><span class="underline">find-doc</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos646754"><span class="calibre10"><span class="calibre8"><span class="underline">find-ns</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos559044"><span class="calibre10"><span class="calibre8"><span class="underline">finite state machines</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos338249"><span class="calibre10"><span class="calibre8"><span class="underline">first</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos346086"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos346086"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos381464"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos381464"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos474679"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos474679"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos491321"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos491321"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos385731"><span class="calibre10"><span class="calibre8"><span class="underline">First In, First Out (FIFO)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos688468"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos688468"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos688468"><span class="calibre10"><span class="calibre8"><span class="underline">First In, Last Out (FILO)</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos136438"><span class="calibre10"><span class="calibre8"><span class="underline">first-class</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos186016"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos186016"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos495080"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos495080"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos876840"><span class="calibre10"><span class="calibre8"><span class="underline">fixed-size pool</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos688468"><span class="calibre10"><span class="calibre8"><span class="underline">FIXO</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos699217"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos699217"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos704512"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos704512"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos710504"><span class="calibre10"><span class="calibre8"><span class="underline">fixo-peek</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos692267"><span class="calibre10"><span class="calibre8"><span class="underline">fixo-push</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos699217"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos699217"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos712847"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos712847"><span class="calibre33"><span class="calibre8"><span class="underline">rd</span></span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos127416"><span class="calibre10"><span class="calibre8"><span class="underline">flexibility</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos355623"><span class="calibre10"><span class="calibre8"><span class="underline">float</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos999044"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos999044"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos169568"><span class="calibre10"><span class="calibre8"><span class="underline">floating point</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos287038"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos287038"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos297423"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos297423"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos355623"><span class="calibre10"><span class="calibre8"><span class="underline">overflow</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos294101"><span class="calibre10"><span class="calibre8"><span class="underline">rounding error</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos294101"><span class="calibre10"><span class="calibre8"><span class="underline">underflow</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos355623"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos355623"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos958691"><span class="calibre10"><span class="calibre8"><span class="underline">floats</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos717394"><span class="calibre10"><span class="calibre8"><span class="underline">fluent builder</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos723655"><span class="calibre10"><span class="calibre8"><span class="underline">FluentMove</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos182589"><span class="calibre10"><span class="calibre8"><span class="underline">fn</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos189048"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos189048"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos353159"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos353159"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos518685"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos518685"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos559044"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos559044"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos606505"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos606505"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos119072"><span class="calibre10"><span class="calibre8"><span class="underline">for</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos262114"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos262114"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos447193"><span class="calibre10"><span class="calibre8"><span class="underline">force</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos467745"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos467745"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos474679"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos474679"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos305094"><span class="calibre10"><span class="calibre8"><span class="underline">forever</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos175471"><span class="calibre10"><span class="calibre8"><span class="underline">form</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos521637"><span class="calibre10"><span class="calibre8"><span class="underline">free variables</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos111837"><span class="calibre10"><span class="calibre8"><span class="underline">freedom to focus</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos988832"><span class="calibre10"><span class="calibre8"><span class="underline">frequencies</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos731809"><span class="calibre10"><span class="calibre8"><span class="underline">Frink (programming language)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1007562"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1007562"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos856865"><span class="calibre10"><span class="calibre8"><span class="underline">frustrating</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos896931"><span class="calibre10"><span class="calibre8"><span class="underline">fully qualified</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos932849"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos932849"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos939799"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos939799"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos262114"><span class="calibre10"><span class="calibre8"><span class="underline">fun</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos179062"><span class="calibre10"><span class="calibre8"><span class="underline">functions</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos305094"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos305094"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos189048"><span class="calibre10"><span class="calibre8"><span class="underline">anonymous</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos498369"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos498369"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos528029"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos528029"><span class="calibre33"><span class="calibre8"><span class="underline">rd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos740177"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos740177"><span class="calibre33"><span class="calibre8"><span class="underline">th</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos182589"><span class="calibre10"><span class="calibre8"><span class="underline">arity</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos179062"><span class="calibre10"><span class="calibre8"><span class="underline">Calling Functions</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos329219"><span class="calibre10"><span class="calibre8"><span class="underline">dangerous</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos688468"><span class="calibre10"><span class="calibre8"><span class="underline">function signatures</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos562391"><span class="calibre10"><span class="calibre8"><span class="underline">local</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos259269"><span class="calibre10"><span class="calibre8"><span class="underline">multiple function bodies</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos510009"><span class="calibre10"><span class="calibre8"><span class="underline">named arguments</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span></p><p id="filepos1207029" class="calibre5"><span class="bold">G</span></p><p class="calibre5"><a href="#filepos1035854"><span class="calibre10"><span class="calibre8"><span class="underline">Gang of Four</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos731809"><span class="calibre10"><span class="calibre8"><span class="underline">garbage collection</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos962026"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos962026"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos971369"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos971369"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos553922"><span class="calibre10"><span class="calibre8"><span class="underline">gcd</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos220826"><span class="calibre10"><span class="calibre8"><span class="underline">gen-class</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos746497"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos746497"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos752869"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos752869"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos766553"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos766553"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos817166"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos817166"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1039413"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos1039413"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos547587"><span class="calibre10"><span class="calibre8"><span class="underline">generalized tail-call optimization</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos567476"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos567476"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos244732"><span class="calibre10"><span class="calibre8"><span class="underline">generic</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos127416"><span class="calibre10"><span class="calibre8"><span class="underline">genotype</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos620874"><span class="calibre10"><span class="calibre8"><span class="underline">gensym</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos359275"><span class="calibre10"><span class="calibre8"><span class="underline">get</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos374641"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos374641"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos396742"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos396742"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos410404"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos410404"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos363711"><span class="calibre10"><span class="calibre8"><span class="underline">get-in</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos723655"><span class="calibre10"><span class="calibre8"><span class="underline">getter</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos674644"><span class="calibre10"><span class="calibre8"><span class="underline">global hierarchy map</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos860093"><span class="calibre10"><span class="calibre8"><span class="underline">goal</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos658019"><span class="calibre10"><span class="italic"><span class="calibre8"><span class="underline">Gödel, Escher, Bach: An Eternal Golden Braid</span></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos844230"><span class="calibre10"><span class="calibre8"><span class="underline">good-move</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1018721"><span class="calibre10"><span class="calibre8"><span class="underline">Graham, Paul</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1055195"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1055195"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos272636"><span class="calibre10"><span class="calibre8"><span class="underline">graphic</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos528029"><span class="calibre10"><span class="calibre8"><span class="underline">graphical user interface (GUI)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos746497"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos746497"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos752869"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos752869"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos766553"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos766553"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos269173"><span class="calibre10"><span class="calibre8"><span class="underline">graphics context</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos550948"><span class="calibre10"><span class="calibre8"><span class="underline">greatest common denominator</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos974654"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos974654"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos883417"><span class="calibre10"><span class="calibre8"><span class="underline">green thread</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1035854"><span class="calibre10"><span class="calibre8"><span class="underline">Greenspun’s Tenth Rule</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1041654"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1041654"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos731809"><span class="calibre10"><span class="calibre8"><span class="underline">Groovy (programming language)</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span></p><p id="filepos1214231" class="calibre5"><span class="bold">H</span></p><p class="calibre5"><a href="#filepos420410"><span class="calibre10"><span class="calibre8"><span class="underline">Halloway, Stuart</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos733653"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos733653"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos978813"><span class="calibre10"><span class="calibre8"><span class="underline">has</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos413478"><span class="calibre10"><span class="calibre8"><span class="underline">hash maps</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos346086"><span class="calibre10"><span class="calibre8"><span class="underline">hash-map</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos374641"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos374641"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos406662"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos406662"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos681989"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos681989"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos136438"><span class="calibre10"><span class="calibre8"><span class="underline">Haskell (programming language)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos248530"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos248530"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos447193"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos447193"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos464962"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos464962"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos567476"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos567476"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos595526"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos595526"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos706927"><span class="calibre10"><span class="calibre8"><span class="underline">9<sup class="calibre135"><small class="calibre32"><a href="#filepos706927"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos978813"><span class="calibre10"><span class="calibre8"><span class="underline">11<sup class="calibre135"><small class="calibre32"><a href="#filepos978813"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1029566"><span class="calibre10"><span class="calibre8"><span class="underline">13<sup class="calibre135"><small class="calibre32"><a href="#filepos1029566"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos567476"><span class="calibre10"><span class="calibre8"><span class="underline">out of order execution</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos595526"><span class="calibre10"><span class="calibre8"><span class="underline">Template Haskell</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos706927"><span class="calibre10"><span class="calibre8"><span class="underline">typeclasses</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos978813"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos978813"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos574247"><span class="calibre10"><span class="calibre8"><span class="underline">heuristic</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos108336"><span class="calibre10"><span class="calibre8"><span class="underline">Hickey, Rich</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos729672"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos729672"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos265366"><span class="calibre10"><span class="calibre8"><span class="underline">hidden</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos726645"><span class="calibre10"><span class="calibre8"><span class="underline">hierarchy</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos856865"><span class="calibre10"><span class="calibre8"><span class="underline">history</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos136438"><span class="calibre10"><span class="calibre8"><span class="underline">homoiconicity</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1003113"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1003113"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1039413"><span class="calibre10"><span class="calibre8"><span class="underline">hooks</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1055195"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1055195"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos348941"><span class="calibre10"><span class="calibre8"><span class="underline">hops</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos287038"><span class="calibre10"><span class="calibre8"><span class="underline">host semantics</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1007562"><span class="calibre10"><span class="calibre8"><span class="underline">Hoyte, Doug</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos652672"><span class="calibre10"><span class="calibre8"><span class="underline">hyphens</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span></p><p id="filepos1220568" class="calibre5"><span class="bold">I</span></p><p class="calibre5"><a href="#filepos833639"><span class="calibre10"><span class="calibre8"><span class="underline">I/O</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos866594"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos866594"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos876840"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos876840"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos833639"><span class="calibre10"><span class="calibre8"><span class="underline">idempotent</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos886905"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos886905"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos312307"><span class="calibre10"><span class="calibre8"><span class="underline">identical?</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos312307"><span class="calibre10"><span class="calibre8"><span class="underline">identifiers</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos106743"><span class="calibre10"><span class="calibre8"><span class="underline">identity</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos140178"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos140178"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos314354"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos314354"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos717394"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos717394"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos742481"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos742481"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos796508"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos796508"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos821265"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos821265"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos860093"><span class="calibre10"><span class="calibre8"><span class="underline">8<sup class="calibre135"><small class="calibre32"><a href="#filepos860093"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos883417"><span class="calibre10"><span class="calibre8"><span class="underline">9<sup class="calibre135"><small class="calibre32"><a href="#filepos883417"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1051831"><span class="calibre10"><span class="calibre8"><span class="underline">IDEs</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos681989"><span class="calibre10"><span class="calibre8"><span class="underline">idiom</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos208250"><span class="calibre10"><span class="calibre8"><span class="underline">idiomatic</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos214245"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos214245"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos244732"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos244732"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos287038"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos287038"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos353159"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos353159"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos370789"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos370789"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos410404"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos410404"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos451388"><span class="calibre10"><span class="calibre8"><span class="underline">8<sup class="calibre135"><small class="calibre32"><a href="#filepos451388"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos580168"><span class="calibre10"><span class="calibre8"><span class="underline">9<sup class="calibre135"><small class="calibre32"><a href="#filepos580168"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos584912"><span class="calibre10"><span class="calibre8"><span class="underline">10<sup class="calibre135"><small class="calibre32"><a href="#filepos584912"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos620874"><span class="calibre10"><span class="calibre8"><span class="underline">11<sup class="calibre135"><small class="calibre32"><a href="#filepos620874"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos646754"><span class="calibre10"><span class="calibre8"><span class="underline">12<sup class="calibre135"><small class="calibre32"><a href="#filepos646754"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos706927"><span class="calibre10"><span class="calibre8"><span class="underline">13<sup class="calibre135"><small class="calibre32"><a href="#filepos706927"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos953012"><span class="calibre10"><span class="calibre8"><span class="underline">14<sup class="calibre135"><small class="calibre32"><a href="#filepos953012"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos962026"><span class="calibre10"><span class="calibre8"><span class="underline">15<sup class="calibre135"><small class="calibre32"><a href="#filepos962026"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1018721"><span class="calibre10"><span class="calibre8"><span class="underline">16<sup class="calibre135"><small class="calibre32"><a href="#filepos1018721"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos198412"><span class="calibre10"><span class="calibre8"><span class="underline">if</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos451388"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos451388"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos599655"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos599655"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos471319"><span class="calibre10"><span class="calibre8"><span class="underline">if-let</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos627241"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos627241"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos262114"><span class="calibre10"><span class="calibre8"><span class="underline">image</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos279910"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos279910"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos119072"><span class="calibre10"><span class="calibre8"><span class="underline">immutability</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos143914"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos143914"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos195145"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos195145"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos334761"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos334761"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos367438"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos367438"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos385731"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos385731"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos394403"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos394403"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos416912"><span class="calibre10"><span class="calibre8"><span class="underline">8<sup class="calibre135"><small class="calibre32"><a href="#filepos416912"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos429793"><span class="calibre10"><span class="calibre8"><span class="underline">9<sup class="calibre135"><small class="calibre32"><a href="#filepos429793"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos521637"><span class="calibre10"><span class="calibre8"><span class="underline">10<sup class="calibre135"><small class="calibre32"><a href="#filepos521637"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos547587"><span class="calibre10"><span class="calibre8"><span class="underline">11<sup class="calibre135"><small class="calibre32"><a href="#filepos547587"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos717394"><span class="calibre10"><span class="calibre8"><span class="underline">12<sup class="calibre135"><small class="calibre32"><a href="#filepos717394"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos786956"><span class="calibre10"><span class="calibre8"><span class="underline">13<sup class="calibre135"><small class="calibre32"><a href="#filepos786956"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos863130"><span class="calibre10"><span class="calibre8"><span class="underline">14<sup class="calibre135"><small class="calibre32"><a href="#filepos863130"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos962026"><span class="calibre10"><span class="calibre8"><span class="underline">15<sup class="calibre135"><small class="calibre32"><a href="#filepos962026"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos143914"><span class="calibre10"><span class="calibre8"><span class="underline">imperative programming</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos195145"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos195145"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos431211"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos431211"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos656496"><span class="calibre10"><span class="calibre8"><span class="underline">implementation details</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos195145"><span class="calibre10"><span class="calibre8"><span class="underline">implicit do</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos847407"><span class="calibre10"><span class="calibre8"><span class="underline">inc</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos853266"><span class="calibre10"><span class="calibre8"><span class="underline">inconsistency</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos248530"><span class="calibre10"><span class="calibre8"><span class="underline">index numbers</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos305094"><span class="calibre10"><span class="calibre8"><span class="underline">infinite lazy range</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos244732"><span class="calibre10"><span class="calibre8"><span class="underline">infinite loop</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos447193"><span class="calibre10"><span class="calibre8"><span class="underline">infinite sequence</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos464962"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos464962"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos971369"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos971369"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos179062"><span class="calibre10"><span class="calibre8"><span class="underline">infix notation</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos111837"><span class="calibre10"><span class="calibre8"><span class="underline">inheritance</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos658019"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos658019"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos664847"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos664847"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos664847"><span class="calibre10"><span class="calibre8"><span class="underline">differential</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos701761"><span class="calibre10"><span class="calibre8"><span class="underline">implementation inheritance</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos150827"><span class="calibre10"><span class="calibre8"><span class="underline">interface inheritance</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos661881"><span class="calibre10"><span class="calibre8"><span class="underline">prototype chain</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos671230"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos671230"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos658019"><span class="calibre10"><span class="calibre8"><span class="underline">prototype maps</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos667913"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos667913"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos667913"><span class="calibre10"><span class="calibre8"><span class="underline">inherited behaviors</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos276130"><span class="calibre10"><span class="calibre8"><span class="underline">init</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos746497"><span class="calibre10"><span class="calibre8"><span class="underline">init-proxy</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos866594"><span class="calibre10"><span class="calibre8"><span class="underline">in-process programming model</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos276130"><span class="calibre10"><span class="calibre8"><span class="underline">instance</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos314354"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos314354"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos355623"><span class="calibre10"><span class="calibre8"><span class="underline">int</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos559044"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos559044"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos169568"><span class="calibre10"><span class="calibre8"><span class="underline">integers</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos294101"><span class="calibre10"><span class="calibre8"><span class="underline">overflow</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos262114"><span class="calibre10"><span class="calibre8"><span class="underline">interactive command prompt</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos124211"><span class="calibre10"><span class="calibre8"><span class="underline">interfaces</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos150827"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos150827"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos688468"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos688468"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos699217"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos699217"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos712847"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos712847"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos786956"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos786956"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos978813"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos978813"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos646754"><span class="calibre10"><span class="calibre8"><span class="underline">intern</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos932849"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos932849"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos939799"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos939799"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos962026"><span class="calibre10"><span class="calibre8"><span class="underline">internal reduce</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos320736"><span class="calibre10"><span class="calibre8"><span class="underline">interop</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos175471"><span class="calibre10"><span class="calibre8"><span class="underline">interoperability</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos287038"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos287038"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos701761"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos701761"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos712847"><span class="calibre10"><span class="calibre8"><span class="underline">8<sup class="calibre135"><small class="calibre32"><a href="#filepos712847"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos733653"><span class="calibre10"><span class="calibre8"><span class="underline">9<sup class="calibre135"><small class="calibre32"><a href="#filepos733653"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos766553"><span class="calibre10"><span class="calibre8"><span class="underline">10<sup class="calibre135"><small class="calibre32"><a href="#filepos766553"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos781302"><span class="calibre10"><span class="calibre8"><span class="underline">11<sup class="calibre135"><small class="calibre32"><a href="#filepos781302"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos786956"><span class="calibre10"><span class="calibre8"><span class="underline">12<sup class="calibre135"><small class="calibre32"><a href="#filepos786956"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos796508"><span class="calibre10"><span class="calibre8"><span class="underline">13<sup class="calibre135"><small class="calibre32"><a href="#filepos796508"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos953012"><span class="calibre10"><span class="calibre8"><span class="underline">14<sup class="calibre135"><small class="calibre32"><a href="#filepos953012"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1039413"><span class="calibre10"><span class="calibre8"><span class="underline">15<sup class="calibre135"><small class="calibre32"><a href="#filepos1039413"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos217773"><span class="calibre10"><span class="calibre8"><span class="underline">accessing Java instance members</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos214245"><span class="calibre10"><span class="calibre8"><span class="underline">accessing static class members</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos214245"><span class="calibre10"><span class="calibre8"><span class="underline">creating Java class instances</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos217773"><span class="calibre10"><span class="calibre8"><span class="underline">setting Java instance properties</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1018721"><span class="calibre10"><span class="calibre8"><span class="underline">interpreted</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos355623"><span class="calibre10"><span class="calibre8"><span class="underline">into</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos377793"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos377793"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos701761"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos701761"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos766553"><span class="calibre10"><span class="calibre8"><span class="underline">into-array</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos781302"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos781302"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos958691"><span class="calibre10"><span class="calibre8"><span class="underline">ints</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos722454"><span class="calibre10"><span class="calibre8"><span class="underline">invariants</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos856865"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos856865"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos606505"><span class="calibre10"><span class="calibre8"><span class="underline">inversion of control</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos752869"><span class="calibre10"><span class="calibre8"><span class="underline">invoke</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos664847"><span class="calibre10"><span class="calibre8"><span class="underline">Io (programming language)</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos731809"><span class="calibre10"><span class="calibre8"><span class="underline">Ioke (programming language)</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos667913"><span class="calibre10"><span class="calibre8"><span class="underline">isa?</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos474679"><span class="calibre10"><span class="calibre8"><span class="underline">ISeq</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos712847"><span class="calibre10"><span class="calibre8"><span class="underline">ISeqable</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos799935"><span class="calibre10"><span class="calibre8"><span class="underline">ISliceable</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos830061"><span class="calibre10"><span class="calibre8"><span class="underline">isolation</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos244732"><span class="calibre10"><span class="calibre8"><span class="underline">iteration</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1041654"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1041654"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos338249"><span class="calibre10"><span class="calibre8"><span class="underline">iterator</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos374641"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos374641"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span></p><p id="filepos1247025" class="calibre5"><span class="bold">J</span></p><p class="calibre5"><a href="#filepos592974"><span class="calibre10"><span class="calibre8"><span class="underline">Jahad, George</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos217773"><span class="calibre10"><span class="calibre8"><span class="underline">Java</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos733653"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos733653"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos995611"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos995611"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos108336"><span class="calibre10"><span class="calibre8"><span class="underline">Java (programming language)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos115164"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos115164"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos124211"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos124211"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos150827"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos150827"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos158108"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos158108"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos165700"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos165700"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos202245"><span class="calibre10"><span class="calibre8"><span class="underline">8<sup class="calibre135"><small class="calibre32"><a href="#filepos202245"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos214245"><span class="calibre10"><span class="calibre8"><span class="underline">9<sup class="calibre135"><small class="calibre32"><a href="#filepos214245"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos220826"><span class="calibre10"><span class="calibre8"><span class="underline">10<sup class="calibre135"><small class="calibre32"><a href="#filepos220826"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos302642"><span class="calibre10"><span class="calibre8"><span class="underline">12<sup class="calibre135"><small class="calibre32"><a href="#filepos302642"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos385731"><span class="calibre10"><span class="calibre8"><span class="underline">13<sup class="calibre135"><small class="calibre32"><a href="#filepos385731"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos431211"><span class="calibre10"><span class="calibre8"><span class="underline">14<sup class="calibre135"><small class="calibre32"><a href="#filepos431211"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos498369"><span class="calibre10"><span class="calibre8"><span class="underline">16<sup class="calibre135"><small class="calibre32"><a href="#filepos498369"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos646754"><span class="calibre10"><span class="calibre8"><span class="underline">17<sup class="calibre135"><small class="calibre32"><a href="#filepos646754"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos688468"><span class="calibre10"><span class="calibre8"><span class="underline">18<sup class="calibre135"><small class="calibre32"><a href="#filepos688468"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos695626"><span class="calibre10"><span class="calibre8"><span class="underline">19<sup class="calibre135"><small class="calibre32"><a href="#filepos695626"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos706927"><span class="calibre10"><span class="calibre8"><span class="underline">20<sup class="calibre135"><small class="calibre32"><a href="#filepos706927"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><a href="#filepos731809"><span class="calibre10"><span class="calibre8"><span class="underline">Java (programming language)</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos737904"><span class="calibre10"><span class="calibre8"><span class="underline">Java (programming language)</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos742481"><span class="calibre10"><span class="calibre8"><span class="underline">Java (programming language)</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos757665"><span class="calibre10"><span class="calibre8"><span class="underline">Java (programming language)</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos786956"><span class="calibre10"><span class="calibre8"><span class="underline">Java (programming language)</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos821265"><span class="calibre10"><span class="calibre8"><span class="underline">Java (programming language)</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos886905"><span class="calibre10"><span class="calibre8"><span class="underline">Java (programming language)</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos902134"><span class="calibre10"><span class="calibre8"><span class="underline">Java (programming language)</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos995611"><span class="calibre10"><span class="calibre8"><span class="underline">Java (programming language)</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos119072"><span class="calibre10"><span class="calibre8"><span class="underline">Java</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos487698"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos487698"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos786956"><span class="calibre10"><span class="calibre8"><span class="underline">Java Collections Framework</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos793099"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos793099"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos265366"><span class="calibre10"><span class="calibre8"><span class="underline">Java libraries</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos723655"><span class="calibre10"><span class="calibre8"><span class="underline">polymorphic print facility</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos781302"><span class="calibre10"><span class="calibre8"><span class="underline">variadic constructor</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos108336"><span class="calibre10"><span class="calibre8"><span class="underline">Java Virtual Machine (JVM)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos115164"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos115164"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos214245"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos214245"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos287038"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos287038"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos297423"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos297423"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos550948"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos550948"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos559044"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos559044"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos731809"><span class="calibre10"><span class="calibre8"><span class="underline">8<sup class="calibre135"><small class="calibre32"><a href="#filepos731809"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos773716"><span class="calibre10"><span class="calibre8"><span class="underline">10<sup class="calibre135"><small class="calibre32"><a href="#filepos773716"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos802733"><span class="calibre10"><span class="calibre8"><span class="underline">11<sup class="calibre135"><small class="calibre32"><a href="#filepos802733"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos819388"><span class="calibre10"><span class="calibre8"><span class="underline">12<sup class="calibre135"><small class="calibre32"><a href="#filepos819388"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos873396"><span class="calibre10"><span class="calibre8"><span class="underline">13<sup class="calibre135"><small class="calibre32"><a href="#filepos873396"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos962026"><span class="calibre10"><span class="calibre8"><span class="underline">14<sup class="calibre135"><small class="calibre32"><a href="#filepos962026"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos731809"><span class="calibre10"><span class="calibre8"><span class="underline">HotSpot</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos265366"><span class="calibre10"><span class="calibre8"><span class="underline">java.awt</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos746497"><span class="calibre10"><span class="calibre8"><span class="underline">java.awt.Container</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos757665"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos757665"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos265366"><span class="calibre10"><span class="calibre8"><span class="underline">java.awt.Frame</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos742481"><span class="calibre10"><span class="calibre8"><span class="underline">java.io.FilterOutputStream</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos742481"><span class="calibre10"><span class="calibre8"><span class="underline">java.io.OutputStream</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos233146"><span class="calibre10"><span class="calibre8"><span class="underline">java.lang</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos646754"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos646754"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos790133"><span class="calibre10"><span class="calibre8"><span class="underline">java.lang.Iterable</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos999044"><span class="calibre10"><span class="calibre8"><span class="underline">java.lang.Math/round</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos495080"><span class="calibre10"><span class="calibre8"><span class="underline">java.lang.Object</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos726645"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos726645"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos773716"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos773716"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos958691"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos958691"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos781302"><span class="calibre10"><span class="calibre8"><span class="underline">java.lang.Runnable</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos543406"><span class="calibre10"><span class="calibre8"><span class="underline">java.lang.StackOverflowError</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos806113"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos806113"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos147823"><span class="calibre10"><span class="calibre8"><span class="underline">java.lang.String</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos781302"><span class="calibre10"><span class="calibre8"><span class="underline">java.lang.String/format</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos766553"><span class="calibre10"><span class="calibre8"><span class="underline">java.lang.StringBuilder</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos886905"><span class="calibre10"><span class="calibre8"><span class="underline">java.lang.Thread</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos733653"><span class="calibre10"><span class="calibre8"><span class="underline">Java.next</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos733653"><span class="calibre10"><span class="calibre8"><span class="underline">Java.next Mantra</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos341202"><span class="calibre10"><span class="calibre8"><span class="underline">java.util.ArrayList</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos790133"><span class="calibre10"><span class="calibre8"><span class="underline">java.util.Collection</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos784524"><span class="calibre10"><span class="calibre8"><span class="underline">java.util.Collections/sort</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos781302"><span class="calibre10"><span class="calibre8"><span class="underline">java.util.Comparator</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos896931"><span class="calibre10"><span class="calibre8"><span class="underline">java.util.concurrent</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos903922"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos903922"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos786956"><span class="calibre10"><span class="calibre8"><span class="underline">java.util.concurrent FutureTask</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos521637"><span class="calibre10"><span class="calibre8"><span class="underline">java.util.concurrent.atomic. AtomicInteger</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos890528"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos890528"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos385731"><span class="calibre10"><span class="calibre8"><span class="underline">java.util.concurrent.Blocking-Queue</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos781302"><span class="calibre10"><span class="calibre8"><span class="underline">java.util.concurrent.Callable</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos902134"><span class="calibre10"><span class="calibre8"><span class="underline">java.util.concurrent.locks</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos902134"><span class="calibre10"><span class="calibre8"><span class="underline">java.util.concurrent.locks. ReentrantLock</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos903922"><span class="calibre10"><span class="calibre8"><span class="underline">java.util.concurrent.locks. ReentrantReadWriteLock</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos147823"><span class="calibre10"><span class="calibre8"><span class="underline">java.util.List</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos341202"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos341202"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos784524"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos784524"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos790133"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos790133"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1039413"><span class="calibre10"><span class="calibre8"><span class="underline">java.util.Observable</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos252163"><span class="calibre10"><span class="calibre8"><span class="underline">java.util.RandomAccess</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos252163"><span class="calibre10"><span class="calibre8"><span class="underline">java.util.regex.Matcher</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos329219"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos329219"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos320736"><span class="calibre10"><span class="calibre8"><span class="underline">java.util.regex.Pattern</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos269173"><span class="calibre10"><span class="calibre8"><span class="underline">javadoc</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos320736"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos320736"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos150827"><span class="calibre10"><span class="calibre8"><span class="underline">JavaScript (programming language)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos518685"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos518685"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos539455"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos539455"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos661881"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos661881"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos746497"><span class="calibre10"><span class="calibre8"><span class="underline">javax.swing.JFrame</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos731809"><span class="calibre10"><span class="calibre8"><span class="underline">Jess (programming language)</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1010279"><span class="calibre10"><span class="calibre8"><span class="underline">Joswig, Ranier</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos746497"><span class="calibre10"><span class="calibre8"><span class="underline">joy.gui.DynaFrame</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos731809"><span class="calibre10"><span class="calibre8"><span class="underline">JRuby (programming language)</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos731809"><span class="calibre10"><span class="calibre8"><span class="underline">just-in-time (JIT)</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos674644"><span class="calibre10"><span class="calibre8"><span class="underline">juxt</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos731809"><span class="calibre10"><span class="calibre8"><span class="underline">Jython (programming language)</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span></p><p id="filepos1267133" class="calibre5"><span class="bold">K</span></p><p class="calibre5"><a href="#filepos547587"><span class="calibre10"><span class="calibre8"><span class="underline">kapow</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos422754"><span class="calibre10"><span class="calibre8"><span class="underline">keep-indexed</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos255350"><span class="calibre10"><span class="calibre8"><span class="underline">key</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos346086"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos346086"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos374641"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos374641"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos506447"><span class="calibre10"><span class="calibre8"><span class="underline">keys-apply</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos954859"><span class="calibre10"><span class="calibre8"><span class="underline">keyword arguments</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos172769"><span class="calibre10"><span class="calibre8"><span class="underline">keywords</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos305094"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos305094"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos840697"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos840697"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos309082"><span class="calibre10"><span class="calibre8"><span class="underline">plumbing, separating from domain</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos309082"><span class="calibre10"><span class="calibre8"><span class="underline">qualified</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos329219"><span class="calibre10"><span class="calibre8"><span class="underline">ubiquity of</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos158108"><span class="calibre10"><span class="calibre8"><span class="underline">Kingdom of Nouns</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span></p><div class="mbppagebreak"></div><p id="filepos1269527" class="calibre35"><span class="bold">L</span></p><p class="calibre5"><a href="#filepos136438"><span class="calibre10"><span class="calibre8"><span class="underline">lambda calculus</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos547587"><span class="calibre10"><span class="italic"><span class="calibre8"><span class="underline">Lambda Papers</span></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos447193"><span class="calibre10"><span class="calibre8"><span class="underline">language, eager</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos367438"><span class="calibre10"><span class="calibre8"><span class="underline">last</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos652672"><span class="calibre10"><span class="calibre8"><span class="underline">Leiningen</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos191973"><span class="calibre10"><span class="calibre8"><span class="underline">let</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos214245"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos214245"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos265366"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos265366"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos353159"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos353159"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos460891"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos460891"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos518685"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos518685"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos525267"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos525267"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos624210"><span class="calibre10"><span class="calibre8"><span class="underline">8<sup class="calibre135"><small class="calibre32"><a href="#filepos624210"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos945059"><span class="calibre10"><span class="calibre8"><span class="underline">9<sup class="calibre135"><small class="calibre32"><a href="#filepos945059"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos995611"><span class="calibre10"><span class="calibre8"><span class="underline">10<sup class="calibre135"><small class="calibre32"><a href="#filepos995611"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos158108"><span class="calibre10"><span class="calibre8"><span class="underline">letfn</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos562391"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos562391"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos518685"><span class="calibre10"><span class="calibre8"><span class="underline">lexical scope</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos945059"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos945059"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos995611"><span class="calibre10"><span class="calibre8"><span class="underline">8<sup class="calibre135"><small class="calibre32"><a href="#filepos995611"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos1055195"><span class="calibre10"><span class="calibre8"><span class="underline">lexical bindings</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos528029"><span class="calibre10"><span class="calibre8"><span class="underline">lexical context</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos620874"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos620874"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos624210"><span class="calibre10"><span class="calibre8"><span class="underline">lexical contour</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos528029"><span class="calibre10"><span class="calibre8"><span class="underline">lexical environment</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos535370"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos535370"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1055195"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos1055195"><span class="calibre33"><span class="calibre8"><span class="underline">rd</span></span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos276130"><span class="calibre10"><span class="calibre8"><span class="underline">line number</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos324854"><span class="calibre10"><span class="calibre8"><span class="underline">line terminators</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos416912"><span class="calibre10"><span class="calibre8"><span class="underline">linear search</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos108336"><span class="calibre10"><span class="calibre8"><span class="underline">Lisp (programming language family)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos124211"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos124211"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos169568"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos169568"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos179062"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos179062"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos195145"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos195145"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos214245"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos214245"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos305094"><span class="calibre10"><span class="calibre8"><span class="underline">8<sup class="calibre135"><small class="calibre32"><a href="#filepos305094"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos341202"><span class="calibre10"><span class="calibre8"><span class="underline">9<sup class="calibre135"><small class="calibre32"><a href="#filepos341202"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos370789"><span class="calibre10"><span class="calibre8"><span class="underline">11<sup class="calibre135"><small class="calibre32"><a href="#filepos370789"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos381464"><span class="calibre10"><span class="calibre8"><span class="underline">12<sup class="calibre135"><small class="calibre32"><a href="#filepos381464"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos487698"><span class="calibre10"><span class="calibre8"><span class="underline">13<sup class="calibre135"><small class="calibre32"><a href="#filepos487698"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos631267"><span class="calibre10"><span class="calibre8"><span class="underline">14<sup class="calibre135"><small class="calibre32"><a href="#filepos631267"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos717394"><span class="calibre10"><span class="calibre8"><span class="underline">15<sup class="calibre135"><small class="calibre32"><a href="#filepos717394"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1010279"><span class="calibre10"><span class="calibre8"><span class="underline">16<sup class="calibre135"><small class="calibre32"><a href="#filepos1010279"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1018721"><span class="calibre10"><span class="calibre8"><span class="underline">17<sup class="calibre135"><small class="calibre32"><a href="#filepos1018721"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1039413"><span class="calibre10"><span class="calibre8"><span class="underline">18<sup class="calibre135"><small class="calibre32"><a href="#filepos1039413"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos127416"><span class="calibre10"><span class="calibre8"><span class="underline">beauty of</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos341202"><span class="calibre10"><span class="calibre8"><span class="underline">cons-cell</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos287038"><span class="calibre10"><span class="calibre8"><span class="underline">Lisp-1</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos317285"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos317285"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos175471"><span class="calibre10"><span class="calibre8"><span class="underline">lists</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos205283"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos205283"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos341202"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos341202"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos381464"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos381464"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos476983"><span class="calibre10"><span class="calibre8"><span class="underline">9<sup class="calibre135"><small class="calibre32"><a href="#filepos476983"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos588824"><span class="calibre10"><span class="calibre8"><span class="underline">10<sup class="calibre135"><small class="calibre32"><a href="#filepos588824"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos385731"><span class="calibre10"><span class="calibre8"><span class="underline">as stacks</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos237582"><span class="calibre10"><span class="calibre8"><span class="underline">empty</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos381464"><span class="calibre10"><span class="calibre8"><span class="underline">PersistentList</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos381464"><span class="calibre10"><span class="calibre8"><span class="underline">singly linked</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos320736"><span class="calibre10"><span class="calibre8"><span class="underline">literal</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos172769"><span class="calibre10"><span class="calibre8"><span class="underline">literal syntax</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos355623"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos355623"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos377793"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos377793"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos406662"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos406662"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos677728"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos677728"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos833639"><span class="calibre10"><span class="calibre8"><span class="underline">live-lock</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos528029"><span class="calibre10"><span class="calibre8"><span class="underline">local-context</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1058911"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1058911"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos191973"><span class="calibre10"><span class="calibre8"><span class="underline">locals</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos317285"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos317285"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos460891"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos460891"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos521637"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos521637"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos547587"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos547587"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos939799"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos939799"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos995611"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos995611"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos1058911"><span class="calibre10"><span class="calibre8"><span class="underline">local bindings</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos143914"><span class="calibre10"><span class="calibre8"><span class="underline">locking</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos819388"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos819388"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos824968"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos824968"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos830061"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos830061"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos870513"><span class="calibre10"><span class="calibre8"><span class="underline">9<sup class="calibre135"><small class="calibre32"><a href="#filepos870513"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos899564"><span class="calibre10"><span class="calibre8"><span class="underline">12<sup class="calibre135"><small class="calibre32"><a href="#filepos899564"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos786956"><span class="calibre10"><span class="calibre8"><span class="underline">blocking</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos863130"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos863130"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos870513"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos870513"><span class="calibre33"><span class="calibre8"><span class="underline">rd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos903922"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos903922"><span class="calibre33"><span class="calibre8"><span class="underline">th</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos917181"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos917181"><span class="calibre33"><span class="calibre8"><span class="underline">th</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos902134"><span class="calibre10"><span class="calibre8"><span class="underline">contention</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos903922"><span class="calibre10"><span class="calibre8"><span class="underline">explicit locks</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos870513"><span class="calibre10"><span class="calibre8"><span class="underline">fairness</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos830061"><span class="calibre10"><span class="calibre8"><span class="underline">orphaning</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos899564"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos899564"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos902134"><span class="calibre10"><span class="calibre8"><span class="underline">reentrant</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos903922"><span class="calibre10"><span class="calibre8"><span class="underline">striping</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos830061"><span class="calibre10"><span class="calibre8"><span class="underline">total ordering</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos866594"><span class="calibre10"><span class="calibre8"><span class="underline">log-agent</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos348941"><span class="calibre10"><span class="calibre8"><span class="underline">logarithmic</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos866594"><span class="calibre10"><span class="calibre8"><span class="underline">logging</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos873396"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos873396"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos355623"><span class="calibre10"><span class="calibre8"><span class="underline">long</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos958691"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos958691"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos320736"><span class="calibre10"><span class="calibre8"><span class="underline">look-around clauses</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos154287"><span class="calibre10"><span class="calibre8"><span class="underline">lookup</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos305094"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos305094"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos978813"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos978813"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos195145"><span class="calibre10"><span class="calibre8"><span class="underline">loops</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos559044"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos559044"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos995611"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos995611"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos516152"><span class="calibre10"><span class="calibre8"><span class="underline">loop invariants</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos198412"><span class="calibre10"><span class="calibre8"><span class="underline">loop locals</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos244732"><span class="calibre10"><span class="calibre8"><span class="underline">loop termination</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos324854"><span class="calibre10"><span class="calibre8"><span class="underline">lowercase</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span></p><p id="filepos1290897" class="calibre5"><span class="bold">M</span></p><p class="calibre5"><a href="#filepos165700"><span class="calibre10"><span class="calibre8"><span class="underline">M literal</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos287038"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos287038"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos595526"><span class="calibre10"><span class="calibre8"><span class="underline">macroexpand</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos595526"><span class="calibre10"><span class="calibre8"><span class="underline">macroexpand-1</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos127416"><span class="calibre10"><span class="calibre8"><span class="underline">macros</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos175471"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos175471"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos208250"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos208250"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos276130"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos276130"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos317285"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos317285"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos467745"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos467745"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos592974"><span class="calibre10"><span class="calibre8"><span class="underline">9<sup class="calibre135"><small class="calibre32"><a href="#filepos592974"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos606505"><span class="calibre10"><span class="calibre8"><span class="underline">12<sup class="calibre135"><small class="calibre32"><a href="#filepos606505"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos612640"><span class="calibre10"><span class="calibre8"><span class="underline">15<sup class="calibre135"><small class="calibre32"><a href="#filepos612640"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos620874"><span class="calibre10"><span class="calibre8"><span class="underline">16<sup class="calibre135"><small class="calibre32"><a href="#filepos620874"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><a href="#filepos633367"><span class="calibre10"><span class="calibre8"><span class="underline">macros</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos809785"><span class="calibre10"><span class="calibre8"><span class="underline">macros</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos911113"><span class="calibre10"><span class="calibre8"><span class="underline">macros</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos1013697"><span class="calibre10"><span class="calibre8"><span class="underline">macros</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos1035854"><span class="calibre10"><span class="calibre8"><span class="underline">macros</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos1041654"><span class="calibre10"><span class="calibre8"><span class="underline">macros</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos1051831"><span class="calibre10"><span class="calibre8"><span class="underline">macros</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos1058911"><span class="calibre10"><span class="calibre8"><span class="underline">macros</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos606505"><span class="calibre10"><span class="calibre8"><span class="underline">combining forms</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos198412"><span class="calibre10"><span class="calibre8"><span class="underline">compile-time</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos582902"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos582902"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos595526"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos595526"><span class="calibre33"><span class="calibre8"><span class="underline">rd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos620874"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos620874"><span class="calibre33"><span class="calibre8"><span class="underline">th</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos806113"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos806113"><span class="calibre33"><span class="calibre8"><span class="underline">th</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos627241"><span class="calibre10"><span class="calibre8"><span class="underline">hygienic</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos1015603"><span class="calibre10"><span class="calibre8"><span class="underline">macro that builds another macro</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos627241"><span class="calibre10"><span class="calibre8"><span class="underline">macro-definition time</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos620874"><span class="calibre10"><span class="calibre8"><span class="underline">macro-expansion time</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1058911"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1058911"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos633367"><span class="calibre10"><span class="calibre8"><span class="underline">returning functions</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos595526"><span class="calibre10"><span class="calibre8"><span class="underline">rules of thumb</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos627241"><span class="calibre10"><span class="calibre8"><span class="underline">selective Name Capturings</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos609594"><span class="calibre10"><span class="calibre8"><span class="underline">using to change forms</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos620874"><span class="calibre10"><span class="calibre8"><span class="underline">using to control symbolic resolution time</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos627241"><span class="calibre10"><span class="calibre8"><span class="underline">using to manage resources</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos929918"><span class="calibre10"><span class="calibre8"><span class="underline">magical formula</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos722454"><span class="calibre10"><span class="calibre8"><span class="underline">main</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos769901"><span class="calibre10"><span class="calibre8"><span class="underline">make-array</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos896931"><span class="calibre10"><span class="calibre8"><span class="underline">make-dumb-array</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos856865"><span class="calibre10"><span class="calibre8"><span class="underline">make-move</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos902134"><span class="calibre10"><span class="calibre8"><span class="underline">make-safe-array</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos903922"><span class="calibre10"><span class="calibre8"><span class="underline">make-smart-array</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos506447"><span class="calibre10"><span class="calibre8"><span class="underline">manip-map</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos179062"><span class="calibre10"><span class="calibre8"><span class="underline">map</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos305094"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos305094"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos314354"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos314354"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos338249"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos338249"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos370789"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos370789"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos406662"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos406662"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos416912"><span class="calibre10"><span class="calibre8"><span class="underline">10<sup class="calibre135"><small class="calibre32"><a href="#filepos416912"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos422754"><span class="calibre10"><span class="calibre8"><span class="underline">12<sup class="calibre135"><small class="calibre32"><a href="#filepos422754"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos467745"><span class="calibre10"><span class="calibre8"><span class="underline">13<sup class="calibre135"><small class="calibre32"><a href="#filepos467745"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos498369"><span class="calibre10"><span class="calibre8"><span class="underline">14<sup class="calibre135"><small class="calibre32"><a href="#filepos498369"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos677728"><span class="calibre10"><span class="calibre8"><span class="underline">15<sup class="calibre135"><small class="calibre32"><a href="#filepos677728"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos723655"><span class="calibre10"><span class="calibre8"><span class="underline">17<sup class="calibre135"><small class="calibre32"><a href="#filepos723655"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos781302"><span class="calibre10"><span class="calibre8"><span class="underline">18<sup class="calibre135"><small class="calibre32"><a href="#filepos781302"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos929918"><span class="calibre10"><span class="calibre8"><span class="underline">19<sup class="calibre135"><small class="calibre32"><a href="#filepos929918"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos945059"><span class="calibre10"><span class="calibre8"><span class="underline">20<sup class="calibre135"><small class="calibre32"><a href="#filepos945059"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><a href="#filepos1010279"><span class="calibre10"><span class="calibre8"><span class="underline">map</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos1039413"><span class="calibre10"><span class="calibre8"><span class="underline">map</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos410404"><span class="calibre10"><span class="calibre8"><span class="underline">array map</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos416912"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos416912"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos681989"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos681989"><span class="calibre33"><span class="calibre8"><span class="underline">rd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos346086"><span class="calibre10"><span class="calibre8"><span class="underline">PersistentHashMap</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos406662"><span class="calibre10"><span class="calibre8"><span class="underline">thinking in maps</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos324854"><span class="calibre10"><span class="calibre8"><span class="underline">mapped file</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos945059"><span class="calibre10"><span class="calibre8"><span class="underline">math-context</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos652672"><span class="calibre10"><span class="calibre8"><span class="underline">Maven</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos860093"><span class="calibre10"><span class="calibre8"><span class="underline">max-history</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos127416"><span class="calibre10"><span class="calibre8"><span class="underline">McCarthy, John</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos510009"><span class="calibre10"><span class="calibre8"><span class="underline">memoization</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos890528"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos890528"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos953012"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos953012"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos974654"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos974654"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos999044"><span class="calibre10"><span class="calibre8"><span class="underline">17<sup class="calibre135"><small class="calibre32"><a href="#filepos999044"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos982226"><span class="calibre10"><span class="calibre8"><span class="underline">BasicCache</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos974654"><span class="calibre10"><span class="calibre8"><span class="underline">cache</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos982226"><span class="calibre10"><span class="calibre8"><span class="underline">caching protocol</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos978813"><span class="calibre10"><span class="calibre8"><span class="underline">hit</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos890528"><span class="calibre10"><span class="calibre8"><span class="underline">manipulable-memoize</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos982226"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos982226"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos978813"><span class="calibre10"><span class="calibre8"><span class="underline">memoization protocol</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos890528"><span class="calibre10"><span class="calibre8"><span class="underline">memoize</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos974654"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos974654"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos978813"><span class="calibre10"><span class="calibre8"><span class="underline">miss</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos982226"><span class="calibre10"><span class="calibre8"><span class="underline">PluggableMemoization</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos982226"><span class="calibre10"><span class="calibre8"><span class="underline">through</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos971369"><span class="calibre10"><span class="calibre8"><span class="underline">Mersenne primes</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos309082"><span class="calibre10"><span class="calibre8"><span class="underline">metadata</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos314354"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos314354"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos495080"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos495080"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos606505"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos606505"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos652672"><span class="calibre10"><span class="calibre8"><span class="underline">8<sup class="calibre135"><small class="calibre32"><a href="#filepos652672"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos685935"><span class="calibre10"><span class="calibre8"><span class="underline">9<sup class="calibre135"><small class="calibre32"><a href="#filepos685935"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos890528"><span class="calibre10"><span class="calibre8"><span class="underline">12<sup class="calibre135"><small class="calibre32"><a href="#filepos890528"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos314354"><span class="calibre10"><span class="calibre8"><span class="underline">attaching</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos314354"><span class="calibre10"><span class="calibre8"><span class="underline">meta</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos685935"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos685935"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos314354"><span class="calibre10"><span class="calibre8"><span class="underline">with-meta</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos685935"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos685935"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos265366"><span class="calibre10"><span class="calibre8"><span class="underline">methods</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos276130"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos276130"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1007562"><span class="calibre10"><span class="calibre8"><span class="underline">metric units</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos574247"><span class="calibre10"><span class="calibre8"><span class="underline">min-by</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos580168"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos580168"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos860093"><span class="calibre10"><span class="calibre8"><span class="underline">min-history</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos124211"><span class="calibre10"><span class="calibre8"><span class="underline">mini-language</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos248530"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos248530"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1018721"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos1018721"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos692267"><span class="calibre10"><span class="calibre8"><span class="underline">mixins</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos136438"><span class="calibre10"><span class="calibre8"><span class="underline">ML (programming language)</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos824968"><span class="calibre10"><span class="calibre8"><span class="underline">monitors</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos899564"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos899564"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos899564"><span class="calibre10"><span class="calibre8"><span class="underline">monitor context</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos150827"><span class="calibre10"><span class="calibre8"><span class="underline">monkey-patching</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos699217"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos699217"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos334761"><span class="calibre10"><span class="calibre8"><span class="underline">Montoya, Inigo</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos252163"><span class="calibre10"><span class="calibre8"><span class="underline">more</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos717394"><span class="calibre10"><span class="calibre8"><span class="underline">Move</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos726645"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos726645"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos324854"><span class="calibre10"><span class="calibre8"><span class="underline">multi-line mode</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos147823"><span class="calibre10"><span class="calibre8"><span class="underline">multimethods</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos305094"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos305094"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos312307"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos312307"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos664847"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos664847"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos671230"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos671230"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos717394"><span class="calibre10"><span class="calibre8"><span class="underline">8<sup class="calibre135"><small class="calibre32"><a href="#filepos717394"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1039413"><span class="calibre10"><span class="calibre8"><span class="underline">10<sup class="calibre135"><small class="calibre32"><a href="#filepos1039413"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1049237"><span class="calibre10"><span class="calibre8"><span class="underline">11<sup class="calibre135"><small class="calibre32"><a href="#filepos1049237"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos777104"><span class="calibre10"><span class="calibre8"><span class="underline">multimethod dispatch</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos671230"><span class="calibre10"><span class="calibre8"><span class="underline">prefer-method</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos671230"><span class="calibre10"><span class="calibre8"><span class="underline">remove-method</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos856865"><span class="calibre10"><span class="calibre8"><span class="underline">multiple transactions</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos824968"><span class="calibre10"><span class="calibre8"><span class="underline">multiversion concurrency control (MVCC)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos833639"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos833639"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos853266"><span class="calibre10"><span class="calibre8"><span class="underline">snapshot isolation</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos833639"><span class="calibre10"><span class="calibre8"><span class="underline">write skew</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos856865"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos856865"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span></p><p id="filepos1316013" class="calibre5"><span class="bold">N</span></p><p class="calibre5"><a href="#filepos317285"><span class="calibre10"><span class="calibre8"><span class="underline">name resolution</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos317285"><span class="calibre10"><span class="calibre8"><span class="underline">name shadowing</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos620874"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos620874"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos513175"><span class="calibre10"><span class="calibre8"><span class="underline">named arguments</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos259269"><span class="calibre10"><span class="calibre8"><span class="underline">named structures</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos154287"><span class="calibre10"><span class="calibre8"><span class="underline">namespaces</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos165700"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos165700"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos214245"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos214245"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos224447"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos224447"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos233146"><span class="calibre10"><span class="calibre8"><span class="underline">8<sup class="calibre135"><small class="calibre32"><a href="#filepos233146"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos309082"><span class="calibre10"><span class="calibre8"><span class="underline">9<sup class="calibre135"><small class="calibre32"><a href="#filepos309082"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos314354"><span class="calibre10"><span class="calibre8"><span class="underline">13<sup class="calibre135"><small class="calibre32"><a href="#filepos314354"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos396742"><span class="calibre10"><span class="calibre8"><span class="underline">14<sup class="calibre135"><small class="calibre32"><a href="#filepos396742"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos603106"><span class="calibre10"><span class="calibre8"><span class="underline">15<sup class="calibre135"><small class="calibre32"><a href="#filepos603106"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos620874"><span class="calibre10"><span class="calibre8"><span class="underline">16<sup class="calibre135"><small class="calibre32"><a href="#filepos620874"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos644014"><span class="calibre10"><span class="calibre8"><span class="underline">18<sup class="calibre135"><small class="calibre32"><a href="#filepos644014"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><a href="#filepos649759"><span class="calibre10"><span class="calibre8"><span class="underline">namespaces</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos677728"><span class="calibre10"><span class="calibre8"><span class="underline">namespaces</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos706927"><span class="calibre10"><span class="calibre8"><span class="underline">namespaces</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos746497"><span class="calibre10"><span class="calibre8"><span class="underline">namespaces</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos757665"><span class="calibre10"><span class="calibre8"><span class="underline">namespaces</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos907496"><span class="calibre10"><span class="calibre8"><span class="underline">namespaces</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos932849"><span class="calibre10"><span class="calibre8"><span class="underline">namespaces</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos939799"><span class="calibre10"><span class="calibre8"><span class="underline">namespaces</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos1041654"><span class="calibre10"><span class="calibre8"><span class="underline">namespaces</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos746497"><span class="calibre10"><span class="calibre8"><span class="underline">as class specifications</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos752869"><span class="calibre10"><span class="calibre8"><span class="underline">compilation</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos646754"><span class="calibre10"><span class="calibre8"><span class="underline">in-ns</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos995611"><span class="calibre10"><span class="calibre8"><span class="underline">name-mangled local</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos752869"><span class="calibre10"><span class="calibre8"><span class="underline">namespace compilation</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos309082"><span class="calibre10"><span class="calibre8"><span class="underline">namespace qualification</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos224447"><span class="calibre10"><span class="calibre8"><span class="underline">ns</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos312307"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos312307"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos646754"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos646754"><span class="calibre33"><span class="calibre8"><span class="underline">rd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos656496"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos656496"><span class="calibre33"><span class="calibre8"><span class="underline">th</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos746497"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos746497"><span class="calibre33"><span class="calibre8"><span class="underline">th</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos652672"><span class="calibre10"><span class="calibre8"><span class="underline">privacy</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos226995"><span class="calibre10"><span class="calibre8"><span class="underline">qualification</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos309082"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos309082"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos624210"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos624210"><span class="calibre33"><span class="calibre8"><span class="underline">rd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos646754"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos646754"><span class="calibre33"><span class="calibre8"><span class="underline">th</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos658019"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos658019"><span class="calibre33"><span class="calibre8"><span class="underline">th</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos649759"><span class="calibre10"><span class="calibre8"><span class="underline">remove-ns</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos644014"><span class="calibre10"><span class="calibre8"><span class="underline">two-level mapping</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos649759"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos649759"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos165700"><span class="calibre10"><span class="calibre8"><span class="underline">user</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1013697"><span class="calibre10"><span class="calibre8"><span class="underline">natural language</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos363711"><span class="calibre10"><span class="calibre8"><span class="underline">neighbors</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos570402"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos570402"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos844230"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos844230"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos824968"><span class="calibre10"><span class="calibre8"><span class="underline">nest</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1015603"><span class="calibre10"><span class="calibre8"><span class="underline">nested syntax-quotes</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos214245"><span class="calibre10"><span class="calibre8"><span class="underline">new</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos244732"><span class="calibre10"><span class="calibre8"><span class="underline">next</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos283469"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos283469"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos341202"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos341202"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos377793"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos377793"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos438268"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos438268"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos454430"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos454430"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos175471"><span class="calibre10"><span class="calibre8"><span class="underline">nil</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos237582"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos237582"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos255350"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos255350"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos279910"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos279910"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos338249"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos338249"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos346086"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos346086"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos396742"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos396742"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos420410"><span class="calibre10"><span class="calibre8"><span class="underline">8<sup class="calibre135"><small class="calibre32"><a href="#filepos420410"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos438268"><span class="calibre10"><span class="calibre8"><span class="underline">9<sup class="calibre135"><small class="calibre32"><a href="#filepos438268"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos460891"><span class="calibre10"><span class="calibre8"><span class="underline">10<sup class="calibre135"><small class="calibre32"><a href="#filepos460891"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos603106"><span class="calibre10"><span class="calibre8"><span class="underline">11<sup class="calibre135"><small class="calibre32"><a href="#filepos603106"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos699217"><span class="calibre10"><span class="calibre8"><span class="underline">12<sup class="calibre135"><small class="calibre32"><a href="#filepos699217"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos880160"><span class="calibre10"><span class="calibre8"><span class="underline">13<sup class="calibre135"><small class="calibre32"><a href="#filepos880160"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos283469"><span class="calibre10"><span class="calibre8"><span class="underline">nil pun</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos821265"><span class="calibre10"><span class="calibre8"><span class="underline">nondeterminism</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos447193"><span class="calibre10"><span class="calibre8"><span class="underline">non-termination</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos329219"><span class="calibre10"><span class="calibre8"><span class="underline">non-thread-safe</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos140178"><span class="calibre10"><span class="calibre8"><span class="underline">nouns</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos646754"><span class="calibre10"><span class="calibre8"><span class="underline">ns-unmap</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos359275"><span class="calibre10"><span class="calibre8"><span class="underline">nth</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos385731"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos385731"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos457834"><span class="calibre10"><span class="calibre8"><span class="underline">nthnext</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos722454"><span class="calibre10"><span class="calibre8"><span class="underline">null</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos165700"><span class="calibre10"><span class="calibre8"><span class="underline">numbers</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos169568"><span class="calibre10"><span class="calibre8"><span class="underline">binary</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos297423"><span class="calibre10"><span class="calibre8"><span class="underline">distribution of represented numbers</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos165700"><span class="calibre10"><span class="calibre8"><span class="underline">hexadecimal</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos169568"><span class="calibre10"><span class="calibre8"><span class="underline">octal</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos291601"><span class="calibre10"><span class="calibre8"><span class="underline">promotion</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos169568"><span class="calibre10"><span class="calibre8"><span class="underline">radix notation</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos169568"><span class="calibre10"><span class="calibre8"><span class="underline">radix-32</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos169568"><span class="calibre10"><span class="calibre8"><span class="underline">scientific notation</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos329219"><span class="calibre10"><span class="calibre8"><span class="underline">numerical precision</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span></p><p id="filepos1332204" class="calibre5"><span class="bold">O</span></p><p class="calibre5"><a href="#filepos106743"><span class="calibre10"><span class="calibre8"><span class="underline">object-oriented programming</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos111837"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos111837"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos124211"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos124211"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos140178"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos140178"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos147823"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos147823"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos158108"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos158108"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos202245"><span class="calibre10"><span class="calibre8"><span class="underline">9<sup class="calibre135"><small class="calibre32"><a href="#filepos202245"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos406662"><span class="calibre10"><span class="calibre8"><span class="underline">10<sup class="calibre135"><small class="calibre32"><a href="#filepos406662"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos606505"><span class="calibre10"><span class="calibre8"><span class="underline">12<sup class="calibre135"><small class="calibre32"><a href="#filepos606505"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos726645"><span class="calibre10"><span class="calibre8"><span class="underline">16<sup class="calibre135"><small class="calibre32"><a href="#filepos726645"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1001639"><span class="calibre10"><span class="calibre8"><span class="underline">17<sup class="calibre135"><small class="calibre32"><a href="#filepos1001639"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1035854"><span class="calibre10"><span class="calibre8"><span class="underline">19<sup class="calibre135"><small class="calibre32"><a href="#filepos1035854"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><a href="#filepos1041654"><span class="calibre10"><span class="calibre8"><span class="underline">object-oriented programming</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos671230"><span class="calibre10"><span class="calibre8"><span class="underline">conflict resolution strategy</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos111837"><span class="calibre10"><span class="calibre8"><span class="underline">hierarchies</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos158108"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos158108"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos426405"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos426405"><span class="calibre33"><span class="calibre8"><span class="underline">rd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos606505"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos606505"><span class="calibre33"><span class="calibre8"><span class="underline">th</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos723655"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos723655"><span class="calibre33"><span class="calibre8"><span class="underline">th</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1018721"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos1018721"><span class="calibre33"><span class="calibre8"><span class="underline">th</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1039413"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos1039413"><span class="calibre33"><span class="calibre8"><span class="underline">th</span></span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos958691"><span class="calibre10"><span class="calibre8"><span class="underline">objects</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos248530"><span class="calibre10"><span class="calibre8"><span class="underline">obscure</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos988832"><span class="calibre10"><span class="calibre8"><span class="underline">occur-count</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1018721"><span class="calibre10"><span class="italic"><span class="calibre8"><span class="underline">On Lisp</span></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos968286"><span class="calibre10"><span class="calibre8"><span class="underline">one-at-a-time realization</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos111837"><span class="calibre10"><span class="calibre8"><span class="underline">operator precedence</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos179062"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos179062"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos953012"><span class="calibre10"><span class="calibre8"><span class="underline">optimizations</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos962026"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos962026"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos993007"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos993007"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos324854"><span class="calibre10"><span class="calibre8"><span class="underline">option flags</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos255350"><span class="calibre10"><span class="calibre8"><span class="underline">or (logical)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1041654"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1041654"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos255350"><span class="calibre10"><span class="calibre8"><span class="underline">original map</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span></p><p id="filepos1339037" class="calibre5"><span class="bold">P</span></p><p class="calibre5"><a href="#filepos255350"><span class="calibre10"><span class="calibre8"><span class="underline">pair</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos567476"><span class="calibre10"><span class="calibre8"><span class="underline">parallelism</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos821265"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos821265"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos903922"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos903922"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos913773"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos913773"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos929918"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos929918"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos922915"><span class="calibre10"><span class="calibre8"><span class="underline">dataflow</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos127416"><span class="calibre10"><span class="calibre8"><span class="underline">parentheses</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos667913"><span class="calibre10"><span class="calibre8"><span class="underline">parents</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos491321"><span class="calibre10"><span class="calibre8"><span class="underline">partial</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos501688"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos501688"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos844230"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos844230"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1018721"><span class="calibre10"><span class="calibre8"><span class="underline">partition</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos294101"><span class="calibre10"><span class="calibre8"><span class="underline">Patriot missile</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos248530"><span class="calibre10"><span class="calibre8"><span class="underline">pattern matching</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos866594"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos866594"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos272636"><span class="calibre10"><span class="calibre8"><span class="underline">patterns</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos320736"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos320736"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos821265"><span class="calibre10"><span class="calibre8"><span class="underline">pcalls</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos926419"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos926419"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos367438"><span class="calibre10"><span class="calibre8"><span class="underline">peek</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos385731"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos385731"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos394403"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos394403"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos688468"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos688468"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos681989"><span class="calibre10"><span class="calibre8"><span class="underline">performance</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos717394"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos717394"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos953012"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos953012"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos999044"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos999044"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos968286"><span class="calibre10"><span class="calibre8"><span class="underline">measurements</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos518685"><span class="calibre10"><span class="calibre8"><span class="underline">Perl (programming language)</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos119072"><span class="calibre10"><span class="calibre8"><span class="underline">persistent data structures</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos334761"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos334761"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos348941"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos348941"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos381464"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos381464"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos438268"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos438268"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos447193"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos447193"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos962026"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos962026"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos348941"><span class="calibre10"><span class="calibre8"><span class="underline">persistent hash trie</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos262114"><span class="calibre10"><span class="calibre8"><span class="underline">pixel</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos821265"><span class="calibre10"><span class="calibre8"><span class="underline">pmap</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos926419"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos926419"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos886905"><span class="calibre10"><span class="calibre8"><span class="underline">polling</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos106743"><span class="calibre10"><span class="calibre8"><span class="underline">polymorphism</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos150827"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos150827"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos532161"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos532161"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos661881"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos661881"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos674644"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos674644"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos688468"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos688468"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos717394"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos717394"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos729672"><span class="calibre10"><span class="calibre8"><span class="underline">8<sup class="calibre135"><small class="calibre32"><a href="#filepos729672"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos873396"><span class="calibre10"><span class="calibre8"><span class="underline">pool</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos367438"><span class="calibre10"><span class="calibre8"><span class="underline">pop</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos385731"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos385731"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos688468"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos688468"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos420410"><span class="calibre10"><span class="calibre8"><span class="underline">pos</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos248530"><span class="calibre10"><span class="calibre8"><span class="underline">positionally</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos513175"><span class="calibre10"><span class="calibre8"><span class="underline">postconditions</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos633367"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos633367"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos639486"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos639486"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1032555"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos1032555"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos543406"><span class="calibre10"><span class="calibre8"><span class="underline">pow</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos633367"><span class="calibre10"><span class="calibre8"><span class="underline">preconditions</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos729672"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos729672"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1032555"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos1032555"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos127416"><span class="calibre10"><span class="calibre8"><span class="underline">prefix notation</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos179062"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos179062"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos165700"><span class="calibre10"><span class="calibre8"><span class="underline">primitives</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos294101"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos294101"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos355623"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos355623"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos712847"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos712847"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos802733"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos802733"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos958691"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos958691"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos986264"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos986264"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos995611"><span class="calibre10"><span class="calibre8"><span class="underline">8<sup class="calibre135"><small class="calibre32"><a href="#filepos995611"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos195145"><span class="calibre10"><span class="calibre8"><span class="underline">println</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos451388"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos451388"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos592974"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos592974"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1051831"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos1051831"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos390122"><span class="calibre10"><span class="calibre8"><span class="underline">print-method</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos954859"><span class="calibre10"><span class="calibre8"><span class="underline">programmer efficiency</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos420410"><span class="calibre10"><span class="italic"><span class="calibre8"><span class="underline">Programming Clojure</span></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos147823"><span class="calibre10"><span class="calibre8"><span class="underline">protocols</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos474679"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos474679"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos677728"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos677728"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos688468"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos688468"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos699217"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos699217"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos704512"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos704512"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos796508"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos796508"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos896931"><span class="calibre10"><span class="calibre8"><span class="underline">8<sup class="calibre135"><small class="calibre32"><a href="#filepos896931"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos978813"><span class="calibre10"><span class="calibre8"><span class="underline">9<sup class="calibre135"><small class="calibre32"><a href="#filepos978813"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1041654"><span class="calibre10"><span class="calibre8"><span class="underline">11<sup class="calibre135"><small class="calibre32"><a href="#filepos1041654"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos978813"><span class="calibre10"><span class="calibre8"><span class="underline">design of</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos658019"><span class="calibre10"><span class="calibre8"><span class="underline">Prototype Principle</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos752869"><span class="calibre10"><span class="calibre8"><span class="underline">prototyping</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos688468"><span class="calibre10"><span class="calibre8"><span class="underline">pure virtual classes</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos506447"><span class="calibre10"><span class="calibre8"><span class="underline">purely functional</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos968286"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos968286"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos688468"><span class="calibre10"><span class="calibre8"><span class="underline">push</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos821265"><span class="calibre10"><span class="calibre8"><span class="underline">pvalues</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos926419"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos926419"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos115164"><span class="calibre10"><span class="calibre8"><span class="underline">Python (programming language)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos237582"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos237582"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos487698"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos487698"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos510009"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos510009"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span></p><p id="filepos1358873" class="calibre5"><span class="bold">Q</span></p><p class="calibre5"><a href="#filepos136438"><span class="calibre10"><span class="calibre8"><span class="underline">Qi (programming language)</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos385731"><span class="calibre10"><span class="calibre8"><span class="underline">queues</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos394403"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos394403"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos876840"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos876840"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos385731"><span class="calibre10"><span class="calibre8"><span class="underline">PersistentQueue</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos688468"><span class="calibre10"><span class="calibre8"><span class="underline">priority queues</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos390122"><span class="calibre10"><span class="calibre8"><span class="underline">queue-fish</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos474679"><span class="calibre10"><span class="calibre8"><span class="underline">quicksort</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos476983"><span class="calibre10"><span class="calibre8"><span class="underline">qsort</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos202245"><span class="calibre10"><span class="calibre8"><span class="underline">quote</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos312307"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos312307"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos588824"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos588824"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos627241"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos627241"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span></p><p id="filepos1361188" class="calibre5"><span class="bold">R</span></p><p class="calibre5"><a href="#filepos262114"><span class="calibre10"><span class="calibre8"><span class="underline">range</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos305094"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos305094"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos355623"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos355623"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos381464"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos381464"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos460891"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos460891"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos968286"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos968286"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos169568"><span class="calibre10"><span class="calibre8"><span class="underline">rationals</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos300179"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos300179"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos169568"><span class="calibre10"><span class="calibre8"><span class="underline">denominator</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos302642"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos302642"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos169568"><span class="calibre10"><span class="calibre8"><span class="underline">numerator</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos302642"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos302642"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos300179"><span class="calibre10"><span class="calibre8"><span class="underline">ratio</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos297423"><span class="calibre10"><span class="calibre8"><span class="underline">rational</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos300179"><span class="calibre10"><span class="calibre8"><span class="underline">rationalize</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1055195"><span class="calibre10"><span class="calibre8"><span class="underline">read</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos189048"><span class="calibre10"><span class="calibre8"><span class="underline">reader feature</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos165700"><span class="calibre10"><span class="calibre8"><span class="underline">Read-Eval-Print Loop (REPL)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos182589"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos182589"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos202245"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos202245"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos224447"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos224447"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos272636"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos272636"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos283469"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos283469"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos406662"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos406662"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos460891"><span class="calibre10"><span class="calibre8"><span class="underline">8<sup class="calibre135"><small class="calibre32"><a href="#filepos460891"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos479779"><span class="calibre10"><span class="calibre8"><span class="underline">9<sup class="calibre135"><small class="calibre32"><a href="#filepos479779"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos646754"><span class="calibre10"><span class="calibre8"><span class="underline">10<sup class="calibre135"><small class="calibre32"><a href="#filepos646754"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos750235"><span class="calibre10"><span class="calibre8"><span class="underline">11<sup class="calibre135"><small class="calibre32"><a href="#filepos750235"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos777104"><span class="calibre10"><span class="calibre8"><span class="underline">12<sup class="calibre135"><small class="calibre32"><a href="#filepos777104"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos922915"><span class="calibre10"><span class="calibre8"><span class="underline">13<sup class="calibre135"><small class="calibre32"><a href="#filepos922915"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos932849"><span class="calibre10"><span class="calibre8"><span class="underline">14<sup class="calibre135"><small class="calibre32"><a href="#filepos932849"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos945059"><span class="calibre10"><span class="calibre8"><span class="underline">15<sup class="calibre135"><small class="calibre32"><a href="#filepos945059"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos954859"><span class="calibre10"><span class="calibre8"><span class="underline">16<sup class="calibre135"><small class="calibre32"><a href="#filepos954859"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos993007"><span class="calibre10"><span class="calibre8"><span class="underline">17<sup class="calibre135"><small class="calibre32"><a href="#filepos993007"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1055195"><span class="calibre10"><span class="calibre8"><span class="underline">18<sup class="calibre135"><small class="calibre32"><a href="#filepos1055195"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos320736"><span class="calibre10"><span class="calibre8"><span class="underline">read-time</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos320736"><span class="calibre10"><span class="calibre8"><span class="underline">recompiled</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos677728"><span class="calibre10"><span class="calibre8"><span class="underline">records</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos685935"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos685935"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos699217"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos699217"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos704512"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos704512"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos726645"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos726645"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos195145"><span class="calibre10"><span class="calibre8"><span class="underline">recur</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos543406"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos543406"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos550948"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos550948"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos712847"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos712847"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos467745"><span class="calibre10"><span class="calibre8"><span class="underline">reduce</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos498369"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos498369"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos649759"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos649759"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos962026"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos962026"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1039413"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos1039413"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos995611"><span class="calibre10"><span class="calibre8"><span class="underline">refactoring</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos143914"><span class="calibre10"><span class="calibre8"><span class="underline">reference types</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos431211"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos431211"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos438268"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos438268"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos609594"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos609594"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos717394"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos717394"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos821265"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos821265"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos837118"><span class="calibre10"><span class="calibre8"><span class="underline">8<sup class="calibre135"><small class="calibre32"><a href="#filepos837118"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos844230"><span class="calibre10"><span class="calibre8"><span class="underline">12<sup class="calibre135"><small class="calibre32"><a href="#filepos844230"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos853266"><span class="calibre10"><span class="calibre8"><span class="underline">14<sup class="calibre135"><small class="calibre32"><a href="#filepos853266"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos860093"><span class="calibre10"><span class="calibre8"><span class="underline">15<sup class="calibre135"><small class="calibre32"><a href="#filepos860093"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos876840"><span class="calibre10"><span class="calibre8"><span class="underline">18<sup class="calibre135"><small class="calibre32"><a href="#filepos876840"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos886905"><span class="calibre10"><span class="calibre8"><span class="underline">20<sup class="calibre135"><small class="calibre32"><a href="#filepos886905"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><a href="#filepos894104"><span class="calibre10"><span class="calibre8"><span class="underline">reference types</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos903922"><span class="calibre10"><span class="calibre8"><span class="underline">reference types</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos932849"><span class="calibre10"><span class="calibre8"><span class="underline">reference types</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos939799"><span class="calibre10"><span class="calibre8"><span class="underline">reference types</span></span></span></a><a></a><br class="calibre3"/><a href="#filepos1035854"><span class="calibre10"><span class="calibre8"><span class="underline">reference types</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos606505"><span class="calibre10"><span class="calibre8"><span class="underline">add-watch</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1035854"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1035854"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos837118"><span class="calibre10"><span class="calibre8"><span class="underline">coordinated</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos860093"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos860093"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos1035854"><span class="calibre10"><span class="calibre8"><span class="underline">remove-watch</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos840697"><span class="calibre10"><span class="calibre8"><span class="underline">set-validator</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos840697"><span class="calibre10"><span class="calibre8"><span class="underline">synchronous</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos860093"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos860093"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos876840"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos876840"><span class="calibre33"><span class="calibre8"><span class="underline">rd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos886905"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos886905"><span class="calibre33"><span class="calibre8"><span class="underline">th</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos886905"><span class="calibre10"><span class="calibre8"><span class="underline">uncoordinated</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos844230"><span class="calibre10"><span class="calibre8"><span class="underline">uniform state change model</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos1039413"><span class="calibre10"><span class="calibre8"><span class="underline">watchers</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos136438"><span class="calibre10"><span class="calibre8"><span class="underline">referential transparency</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos510009"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos510009"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos958691"><span class="calibre10"><span class="calibre8"><span class="underline">reflection</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos993007"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos993007"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos821265"><span class="calibre10"><span class="calibre8"><span class="underline">Refs</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos837118"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos837118"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos847407"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos847407"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos886905"><span class="calibre10"><span class="calibre8"><span class="underline">11<sup class="calibre135"><small class="calibre32"><a href="#filepos886905"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos844230"><span class="calibre10"><span class="calibre8"><span class="underline">alter</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos851502"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos851502"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos853266"><span class="calibre10"><span class="calibre8"><span class="underline">commutative</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos851502"><span class="calibre10"><span class="calibre8"><span class="underline">commute</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos833639"><span class="calibre10"><span class="calibre8"><span class="underline">ensure</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos856865"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos856865"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos853266"><span class="calibre10"><span class="calibre8"><span class="underline">ref-set</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos265366"><span class="calibre10"><span class="calibre8"><span class="underline">regular expressions</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos285054"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos285054"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos329219"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos329219"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos324854"><span class="calibre10"><span class="calibre8"><span class="underline">case insensitivity</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos329219"><span class="calibre10"><span class="calibre8"><span class="underline">re-find</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos320736"><span class="calibre10"><span class="calibre8"><span class="underline">regex</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos329219"><span class="calibre10"><span class="calibre8"><span class="underline">re-groups</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos320736"><span class="calibre10"><span class="calibre8"><span class="underline">reluctant quantifiers</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos329219"><span class="calibre10"><span class="calibre8"><span class="underline">re-matcher</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos324854"><span class="calibre10"><span class="calibre8"><span class="underline">re-seq</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos220826"><span class="calibre10"><span class="calibre8"><span class="underline">reify</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos539455"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos539455"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos706927"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos706927"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos733653"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos733653"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos742481"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos742481"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1039413"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos1039413"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos706927"><span class="calibre10"><span class="calibre8"><span class="underline">factory function</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1013697"><span class="calibre10"><span class="calibre8"><span class="underline">relative-units</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1018721"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1018721"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos276130"><span class="calibre10"><span class="calibre8"><span class="underline">rem</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos276130"><span class="calibre10"><span class="calibre8"><span class="underline">remainder</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos907496"><span class="calibre10"><span class="calibre8"><span class="underline">remote-procedure call (RPC)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos920693"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos920693"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos233146"><span class="calibre10"><span class="calibre8"><span class="underline">rename</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos853266"><span class="calibre10"><span class="calibre8"><span class="underline">reordering</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos363711"><span class="calibre10"><span class="calibre8"><span class="underline">replace</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos886905"><span class="calibre10"><span class="calibre8"><span class="underline">reset</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos317285"><span class="calibre10"><span class="calibre8"><span class="underline">resolve</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos939799"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos939799"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos244732"><span class="calibre10"><span class="calibre8"><span class="underline">rest</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos338249"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos338249"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos346086"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos346086"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos377793"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos377793"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos385731"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos385731"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos454430"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos454430"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos474679"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos474679"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos491321"><span class="calibre10"><span class="calibre8"><span class="underline">8<sup class="calibre135"><small class="calibre32"><a href="#filepos491321"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos819388"><span class="calibre10"><span class="calibre8"><span class="underline">reusability</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos491321"><span class="calibre10"><span class="calibre8"><span class="underline">reuse</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos229912"><span class="calibre10"><span class="calibre8"><span class="underline">reverse</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos370789"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos370789"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos988832"><span class="calibre10"><span class="calibre8"><span class="underline">roll</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos189048"><span class="calibre10"><span class="calibre8"><span class="underline">root binding</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos932849"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos932849"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos276130"><span class="calibre10"><span class="calibre8"><span class="underline">root cause</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos294101"><span class="calibre10"><span class="calibre8"><span class="underline">rounding error</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos346086"><span class="calibre10"><span class="calibre8"><span class="underline">rseq</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos359275"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos359275"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos907496"><span class="calibre10"><span class="calibre8"><span class="underline">RSS2</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1022273"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1022273"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos920693"><span class="calibre10"><span class="calibre8"><span class="underline">rss-children</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1022273"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1022273"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos413478"><span class="calibre10"><span class="calibre8"><span class="underline">rsubseq</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos150827"><span class="calibre10"><span class="calibre8"><span class="underline">Ruby (programming language)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos518685"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos518685"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos603106"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos603106"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos603106"><span class="calibre10"><span class="calibre8"><span class="underline">unless</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos539455"><span class="calibre10"><span class="calibre8"><span class="underline">runtime</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span></p><p id="filepos1389962" class="calibre5"><span class="bold">S</span></p><p class="calibre5"><a href="#filepos896931"><span class="calibre10"><span class="calibre8"><span class="underline">SafeArray protocol</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos248530"><span class="calibre10"><span class="calibre8"><span class="underline">Scala (programming language)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos487698"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos487698"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos553922"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos553922"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos624210"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos624210"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos731809"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos731809"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1029566"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos1029566"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos285054"><span class="calibre10"><span class="calibre8"><span class="underline">scalar</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos370789"><span class="calibre10"><span class="calibre8"><span class="underline">Scheme (programming language)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos547587"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos547587"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos547587"><span class="calibre10"><span class="calibre8"><span class="underline">actors</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos742481"><span class="calibre10"><span class="calibre8"><span class="underline">screaming-filter</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos664847"><span class="calibre10"><span class="calibre8"><span class="underline">self</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1032555"><span class="calibre10"><span class="calibre8"><span class="underline">semantic coupling</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos119072"><span class="calibre10"><span class="calibre8"><span class="underline">separation of concerns</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos244732"><span class="calibre10"><span class="calibre8"><span class="underline">seq</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos324854"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos324854"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos334761"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos334761"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos355623"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos355623"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos410404"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos410404"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos712847"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos712847"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1041654"><span class="calibre10"><span class="calibre8"><span class="underline">seq protocol</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos971369"><span class="calibre10"><span class="calibre8"><span class="underline">seq1</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos334761"><span class="calibre10"><span class="calibre8"><span class="underline">sequence abstraction</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos346086"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos346086"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos353159"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos353159"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos406662"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos406662"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos416912"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos416912"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos723655"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos723655"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos457834"><span class="calibre10"><span class="calibre8"><span class="underline">rest vs. next</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos338249"><span class="calibre10"><span class="calibre8"><span class="underline">sequences</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos995611"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos995611"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos953012"><span class="calibre10"><span class="calibre8"><span class="underline">chunked</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos968286"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos968286"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos999044"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos999044"><span class="calibre33"><span class="calibre8"><span class="underline">rd</span></span></span></a></small></sup></span></span></span></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">    </tt></span><a href="#filepos968286"><span class="calibre10"><span class="calibre8"><span class="underline">chunk-at-a-time model</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos252163"><span class="calibre10"><span class="calibre8"><span class="underline">sequentials</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos338249"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos338249"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos737904"><span class="calibre10"><span class="calibre8"><span class="underline">server</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos217773"><span class="calibre10"><span class="calibre8"><span class="underline">set</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos179062"><span class="calibre10"><span class="calibre8"><span class="underline">sets</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos341202"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos341202"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos396742"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos396742"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos406662"><span class="calibre10"><span class="calibre8"><span class="underline">difference</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos403710"><span class="calibre10"><span class="calibre8"><span class="underline">intersection</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos406662"><span class="calibre10"><span class="calibre8"><span class="underline">relative complement</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos406662"><span class="calibre10"><span class="calibre8"><span class="underline">union</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos723655"><span class="calibre10"><span class="calibre8"><span class="underline">setter</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos444400"><span class="calibre10"><span class="calibre8"><span class="underline">shared structure</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos819388"><span class="calibre10"><span class="calibre8"><span class="underline">shared-state concurrency</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos355623"><span class="calibre10"><span class="calibre8"><span class="underline">short</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos958691"><span class="calibre10"><span class="calibre8"><span class="underline">shorts</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos793099"><span class="calibre10"><span class="calibre8"><span class="underline">shuffle</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos191973"><span class="calibre10"><span class="calibre8"><span class="underline">side effects</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos506447"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos506447"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos580168"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos580168"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos603106"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos603106"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos649759"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos649759"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos863130"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos863130"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos886905"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos886905"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1045580"><span class="calibre10"><span class="calibre8"><span class="underline">8<sup class="calibre135"><small class="calibre32"><a href="#filepos1045580"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos108336"><span class="calibre10"><span class="calibre8"><span class="underline">simplicity</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos426405"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos426405"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos988832"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos988832"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos723655"><span class="calibre10"><span class="calibre8"><span class="underline">simplification</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos205283"><span class="calibre10"><span class="calibre8"><span class="underline">single quote</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos856865"><span class="calibre10"><span class="calibre8"><span class="underline">sleep</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos876840"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos876840"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos799935"><span class="calibre10"><span class="calibre8"><span class="underline">slice</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos802733"><span class="calibre10"><span class="calibre8"><span class="underline">Sliceable</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos799935"><span class="calibre10"><span class="calibre8"><span class="underline">sliceCount</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos513175"><span class="calibre10"><span class="calibre8"><span class="underline">slope</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos894104"><span class="calibre10"><span class="calibre8"><span class="underline">slowly</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos986264"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos986264"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos821265"><span class="calibre10"><span class="calibre8"><span class="underline">snapshot</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos824968"><span class="calibre10"><span class="calibre8"><span class="underline">isolation</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos106743"><span class="calibre10"><span class="calibre8"><span class="underline">software transactional memory (STM)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos821265"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos821265"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos847407"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos847407"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos853266"><span class="calibre10"><span class="calibre8"><span class="underline">9<sup class="calibre135"><small class="calibre32"><a href="#filepos853266"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos863130"><span class="calibre10"><span class="calibre8"><span class="underline">13<sup class="calibre135"><small class="calibre32"><a href="#filepos863130"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos886905"><span class="calibre10"><span class="calibre8"><span class="underline">14<sup class="calibre135"><small class="calibre32"><a href="#filepos886905"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos833639"><span class="calibre10"><span class="calibre8"><span class="underline">barging</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos824968"><span class="calibre10"><span class="calibre8"><span class="underline">commit</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos847407"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos847407"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos853266"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos853266"><span class="calibre33"><span class="calibre8"><span class="underline">rd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos853266"><span class="calibre10"><span class="calibre8"><span class="underline">commit-time</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos847407"><span class="calibre10"><span class="calibre8"><span class="underline">in-transaction</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos853266"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos853266"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos824968"><span class="calibre10"><span class="calibre8"><span class="underline">retry</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos396742"><span class="calibre10"><span class="calibre8"><span class="underline">some</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos894104"><span class="calibre10"><span class="calibre8"><span class="underline">sometimes-slowly</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos248530"><span class="calibre10"><span class="calibre8"><span class="underline">sort</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos790133"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos790133"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos498369"><span class="calibre10"><span class="calibre8"><span class="underline">sort-by</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos410404"><span class="calibre10"><span class="calibre8"><span class="underline">sorted-map</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos447193"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos447193"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos400718"><span class="calibre10"><span class="calibre8"><span class="underline">sorted-map-by</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos413478"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos413478"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos396742"><span class="calibre10"><span class="calibre8"><span class="underline">sorted-set</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos447193"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos447193"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos400718"><span class="calibre10"><span class="calibre8"><span class="underline">sorted-set-by</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos479779"><span class="calibre10"><span class="calibre8"><span class="underline">sort-parts</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos175471"><span class="calibre10"><span class="calibre8"><span class="underline">special form</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos182589"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos182589"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos205283"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos205283"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos324854"><span class="calibre10"><span class="calibre8"><span class="underline">split</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos962026"><span class="calibre10"><span class="calibre8"><span class="underline">spot optimizations</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos501688"><span class="calibre10"><span class="calibre8"><span class="underline">spreadsheets</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos532161"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos532161"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos926419"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos926419"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos130968"><span class="calibre10"><span class="calibre8"><span class="underline">SQL</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1003113"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1003113"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1032555"><span class="calibre10"><span class="calibre8"><span class="underline">sqr</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos454430"><span class="calibre10"><span class="calibre8"><span class="underline">stack overflow</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos553922"><span class="calibre10"><span class="calibre8"><span class="underline">errors</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos276130"><span class="calibre10"><span class="calibre8"><span class="underline">stack trace</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos367438"><span class="calibre10"><span class="calibre8"><span class="underline">stacks</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos385731"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos385731"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos716061"><span class="calibre10"><span class="calibre8"><span class="underline">IPersistentStack</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos106743"><span class="calibre10"><span class="calibre8"><span class="underline">state</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos140178"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos140178"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos667913"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos667913"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos717394"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos717394"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos819388"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos819388"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos833639"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos833639"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos844230"><span class="calibre10"><span class="calibre8"><span class="underline">8<sup class="calibre135"><small class="calibre32"><a href="#filepos844230"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos853266"><span class="calibre10"><span class="calibre8"><span class="underline">9<sup class="calibre135"><small class="calibre32"><a href="#filepos853266"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos860093"><span class="calibre10"><span class="calibre8"><span class="underline">10<sup class="calibre135"><small class="calibre32"><a href="#filepos860093"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos866594"><span class="calibre10"><span class="calibre8"><span class="underline">11<sup class="calibre135"><small class="calibre32"><a href="#filepos866594"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos886905"><span class="calibre10"><span class="calibre8"><span class="underline">12<sup class="calibre135"><small class="calibre32"><a href="#filepos886905"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos830061"><span class="calibre10"><span class="calibre8"><span class="underline">managing</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos954859"><span class="calibre10"><span class="calibre8"><span class="underline">static type system</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos954859"><span class="calibre10"><span class="calibre8"><span class="underline">static versus dynamic</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos248530"><span class="calibre10"><span class="calibre8"><span class="underline">Steele, Guy Lewis</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos547587"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos547587"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos570402"><span class="calibre10"><span class="calibre8"><span class="underline">straight-line path</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos856865"><span class="calibre10"><span class="calibre8"><span class="underline">stress</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos172769"><span class="calibre10"><span class="calibre8"><span class="underline">strings</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos314354"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos314354"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos320736"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos320736"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos341202"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos341202"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos237582"><span class="calibre10"><span class="calibre8"><span class="underline">zero-length strings</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos438268"><span class="calibre10"><span class="calibre8"><span class="underline">structural sharing</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1022273"><span class="calibre10"><span class="calibre8"><span class="underline">stubbing</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos400718"><span class="calibre10"><span class="calibre8"><span class="underline">subseq</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos413478"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos413478"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos374641"><span class="calibre10"><span class="calibre8"><span class="underline">subvec</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos746497"><span class="calibre10"><span class="calibre8"><span class="underline">superclass constructor</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos547587"><span class="calibre10"><span class="calibre8"><span class="underline">Sussman, Gerald</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1055195"><span class="calibre10"><span class="calibre8"><span class="underline">Swank-Clojure</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos886905"><span class="calibre10"><span class="calibre8"><span class="underline">swap</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos894104"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos894104"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos487698"><span class="calibre10"><span class="calibre8"><span class="underline">Swing</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos761773"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos761773"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos287038"><span class="calibre10"><span class="calibre8"><span class="underline">Sybil</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos172769"><span class="calibre10"><span class="calibre8"><span class="underline">symbols</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos182589"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos182589"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos189048"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos189048"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos312307"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos312307"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos588824"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos588824"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos627241"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos627241"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos644014"><span class="calibre10"><span class="calibre8"><span class="underline">8<sup class="calibre135"><small class="calibre32"><a href="#filepos644014"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos913773"><span class="calibre10"><span class="calibre8"><span class="underline">10<sup class="calibre135"><small class="calibre32"><a href="#filepos913773"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos208250"><span class="calibre10"><span class="calibre8"><span class="underline">auto-qualification</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos646754"><span class="calibre10"><span class="calibre8"><span class="underline">symbolic mappings</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos111837"><span class="calibre10"><span class="calibre8"><span class="underline">syntax</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos119072"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos119072"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos127416"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos127416"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos781302"><span class="calibre10"><span class="calibre8"><span class="underline">syntactic sugar</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos202245"><span class="calibre10"><span class="calibre8"><span class="underline">syntax-quote</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos208250"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos208250"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos317285"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos317285"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos592974"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos592974"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos620874"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos620874"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos627241"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos627241"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos592974"><span class="calibre10"><span class="calibre8"><span class="underline">nested</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span></p><p id="filepos1421874" class="calibre5"><span class="bold">T</span></p><p class="calibre5"><a href="#filepos543406"><span class="calibre10"><span class="calibre8"><span class="underline">tail position</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos553922"><span class="calibre10"><span class="calibre8"><span class="underline">and recur targets</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos547587"><span class="calibre10"><span class="calibre8"><span class="underline">tail recursion</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos574247"><span class="calibre10"><span class="calibre8"><span class="underline">tail recursive</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos550948"><span class="calibre10"><span class="calibre8"><span class="underline">tail-call</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos483652"><span class="calibre10"><span class="calibre8"><span class="underline">take</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos244732"><span class="calibre10"><span class="calibre8"><span class="underline">terminating condition</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos434853"><span class="calibre10"><span class="calibre8"><span class="underline">test-driven development (TDD)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1001639"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos1001639"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1018721"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos1018721"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos1032555"><span class="calibre10"><span class="calibre8"><span class="underline">specification language</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos495080"><span class="calibre10"><span class="calibre8"><span class="underline">unit tests</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos829703"><span class="calibre10"><span class="calibre8"><span class="underline">there ain’t no such thing as a free lunch</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos627241"><span class="calibre10"><span class="calibre8"><span class="underline">third-party libraries</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos695626"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos695626"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos706927"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos706927"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos431211"><span class="calibre10"><span class="calibre8"><span class="underline">this</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos627241"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos627241"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos664847"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos664847"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos706927"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos706927"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos740177"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos740177"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos939799"><span class="calibre10"><span class="calibre8"><span class="underline">thread-bound</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos189048"><span class="calibre10"><span class="calibre8"><span class="underline">thread-local</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos837118"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos837118"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos932849"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos932849"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos945059"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos945059"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos936347"><span class="calibre10"><span class="calibre8"><span class="underline">thread-local bindings</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1045580"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1045580"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos111837"><span class="calibre10"><span class="calibre8"><span class="underline">threads</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos189048"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos189048"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos773716"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos773716"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos786956"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos786956"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos824968"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos824968"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos837118"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos837118"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos860093"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos860093"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos866594"><span class="calibre10"><span class="calibre8"><span class="underline">8<sup class="calibre135"><small class="calibre32"><a href="#filepos866594"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos883417"><span class="calibre10"><span class="calibre8"><span class="underline">10<sup class="calibre135"><small class="calibre32"><a href="#filepos883417"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos896931"><span class="calibre10"><span class="calibre8"><span class="underline">11<sup class="calibre135"><small class="calibre32"><a href="#filepos896931"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos902134"><span class="calibre10"><span class="calibre8"><span class="underline">12<sup class="calibre135"><small class="calibre32"><a href="#filepos902134"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos917181"><span class="calibre10"><span class="calibre8"><span class="underline">13<sup class="calibre135"><small class="calibre32"><a href="#filepos917181"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos922915"><span class="calibre10"><span class="calibre8"><span class="underline">14<sup class="calibre135"><small class="calibre32"><a href="#filepos922915"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos948562"><span class="calibre10"><span class="calibre8"><span class="underline">15<sup class="calibre135"><small class="calibre32"><a href="#filepos948562"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos968286"><span class="calibre10"><span class="calibre8"><span class="underline">16<sup class="calibre135"><small class="calibre32"><a href="#filepos968286"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1051831"><span class="calibre10"><span class="calibre8"><span class="underline">17<sup class="calibre135"><small class="calibre32"><a href="#filepos1051831"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos870513"><span class="calibre10"><span class="calibre8"><span class="underline">starved</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos742481"><span class="calibre10"><span class="calibre8"><span class="underline">thread-safe</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos837118"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos837118"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos140178"><span class="calibre10"><span class="calibre8"><span class="underline">time</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos821265"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos821265"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos860093"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos860093"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos821265"><span class="calibre10"><span class="calibre8"><span class="underline">timelines</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos847407"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos847407"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos773716"><span class="calibre10"><span class="calibre8"><span class="underline">to-array</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos773716"><span class="calibre10"><span class="calibre8"><span class="underline">to-array-2d</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos723655"><span class="calibre10"><span class="calibre8"><span class="underline">toString</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos562391"><span class="calibre10"><span class="calibre8"><span class="underline">trampoline</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos562391"><span class="calibre10"><span class="calibre8"><span class="underline">trampoline for mutual recursion</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos821265"><span class="calibre10"><span class="calibre8"><span class="underline">transactions</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos833639"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos833639"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos840697"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos840697"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos847407"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos847407"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos886905"><span class="calibre10"><span class="calibre8"><span class="underline">10<sup class="calibre135"><small class="calibre32"><a href="#filepos886905"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos824968"><span class="calibre10"><span class="calibre8"><span class="underline">embedded transactions</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos824968"><span class="calibre10"><span class="calibre8"><span class="underline">retry</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos847407"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos847407"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos860093"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos860093"><span class="calibre33"><span class="calibre8"><span class="underline">rd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos886905"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos886905"><span class="calibre33"><span class="calibre8"><span class="underline">th</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos896931"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos896931"><span class="calibre33"><span class="calibre8"><span class="underline">th</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos860093"><span class="calibre10"><span class="calibre8"><span class="underline">size of</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos431211"><span class="calibre10"><span class="calibre8"><span class="underline">transients</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos953012"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos953012"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos962026"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos962026"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos999044"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos999044"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos962026"><span class="calibre10"><span class="calibre8"><span class="underline">Rule of Transients</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos677728"><span class="calibre10"><span class="calibre8"><span class="underline">TreeNode</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos692267"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos692267"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos699217"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos699217"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos716061"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos716061"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos438268"><span class="calibre10"><span class="calibre8"><span class="underline">trees</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos612640"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos612640"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos619398"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos619398"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos699217"><span class="calibre10"><span class="calibre8"><span class="underline">9<sup class="calibre135"><small class="calibre32"><a href="#filepos699217"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos907496"><span class="calibre10"><span class="calibre8"><span class="underline">10<sup class="calibre135"><small class="calibre32"><a href="#filepos907496"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos971369"><span class="calibre10"><span class="calibre8"><span class="underline">11<sup class="calibre135"><small class="calibre32"><a href="#filepos971369"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1045580"><span class="calibre10"><span class="calibre8"><span class="underline">12<sup class="calibre135"><small class="calibre32"><a href="#filepos1045580"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos447193"><span class="calibre10"><span class="calibre8"><span class="underline">binary</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos685935"><span class="calibre10"><span class="calibre8"><span class="underline">persistent binary</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos447193"><span class="calibre10"><span class="calibre8"><span class="underline">red-black</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos441653"><span class="calibre10"><span class="calibre8"><span class="underline">traversing</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1045580"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1045580"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos447193"><span class="calibre10"><span class="calibre8"><span class="underline">unbalanced</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos464962"><span class="calibre10"><span class="calibre8"><span class="underline">triangle</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos287038"><span class="calibre10"><span class="calibre8"><span class="underline">truncation</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos995611"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos995611"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos236245"><span class="calibre10"><span class="calibre8"><span class="underline">truthiness</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos279910"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos279910"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos265366"><span class="calibre10"><span class="calibre8"><span class="underline">truthy</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos309082"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos309082"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos396742"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos396742"><span class="calibre33"><span class="calibre8"><span class="underline">rd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos467745"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos467745"><span class="calibre33"><span class="calibre8"><span class="underline">th</span></span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos860093"><span class="calibre10"><span class="calibre8"><span class="underline">tuning</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos920693"><span class="calibre10"><span class="calibre8"><span class="underline">tweet-items</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1025528"><span class="calibre10"><span class="calibre8"><span class="underline">tweetless-rss-children</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos913773"><span class="calibre10"><span class="calibre8"><span class="underline">tweet-occurrences</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos907496"><span class="calibre10"><span class="calibre8"><span class="underline">Twitter</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1022273"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1022273"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos291601"><span class="calibre10"><span class="calibre8"><span class="underline">type conversion, automatic</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos799935"><span class="calibre10"><span class="calibre8"><span class="underline">type hints</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos953012"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos953012"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos986264"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos986264"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos999044"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos999044"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span></p><p id="filepos1442861" class="calibre5"><span class="bold">U</span></p><p class="calibre5"><a href="#filepos993007"><span class="calibre10"><span class="calibre8"><span class="underline">unbox</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos294101"><span class="calibre10"><span class="calibre8"><span class="underline">unchecked</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos993007"><span class="calibre10"><span class="calibre8"><span class="underline">unchecked-inc</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos652672"><span class="calibre10"><span class="calibre8"><span class="underline">underscores</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos320736"><span class="calibre10"><span class="calibre8"><span class="underline">Unicode</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos324854"><span class="calibre10"><span class="calibre8"><span class="underline">case insensitivity</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1007562"><span class="calibre10"><span class="calibre8"><span class="underline">unit conversions</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos495080"><span class="calibre10"><span class="calibre8"><span class="underline">unit testing</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1001639"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos1001639"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1018721"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos1018721"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1032555"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos1032555"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1015603"><span class="calibre10"><span class="calibre8"><span class="underline">unit-of-distance</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos658019"><span class="calibre10"><span class="calibre8"><span class="underline">Universal Design Pattern (UDP)</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos674644"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos674644"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos324854"><span class="calibre10"><span class="calibre8"><span class="underline">Unix line terminator</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos793099"><span class="calibre10"><span class="calibre8"><span class="underline">unmodifiable</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos211555"><span class="calibre10"><span class="calibre8"><span class="underline">unquote</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos592974"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos592974"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos603106"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos603106"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos211555"><span class="calibre10"><span class="calibre8"><span class="underline">unquote-splice</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos603106"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos603106"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos262114"><span class="calibre10"><span class="calibre8"><span class="underline">up-arrow key</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos363711"><span class="calibre10"><span class="calibre8"><span class="underline">update-in</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos324854"><span class="calibre10"><span class="calibre8"><span class="underline">uppercase</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span></p><p id="filepos1446908" class="calibre5"><span class="bold">V</span></p><p class="calibre5"><a href="#filepos726645"><span class="calibre10"><span class="calibre8"><span class="underline">validation</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos840697"><span class="calibre10"><span class="calibre8"><span class="underline">validator</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos182589"><span class="calibre10"><span class="calibre8"><span class="underline">variable arguments</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos143914"><span class="calibre10"><span class="calibre8"><span class="underline">variables</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos191973"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos191973"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos886905"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos886905"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos179062"><span class="calibre10"><span class="calibre8"><span class="underline">Vars</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos186016"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos186016"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos202245"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos202245"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos226995"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos226995"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos317285"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos317285"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos495080"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos495080"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos525267"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos525267"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos603106"><span class="calibre10"><span class="calibre8"><span class="underline">8<sup class="calibre135"><small class="calibre32"><a href="#filepos603106"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos644014"><span class="calibre10"><span class="calibre8"><span class="underline">10<sup class="calibre135"><small class="calibre32"><a href="#filepos644014"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos652672"><span class="calibre10"><span class="calibre8"><span class="underline">11<sup class="calibre135"><small class="calibre32"><a href="#filepos652672"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos821265"><span class="calibre10"><span class="calibre8"><span class="underline">12<sup class="calibre135"><small class="calibre32"><a href="#filepos821265"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos837118"><span class="calibre10"><span class="calibre8"><span class="underline">13<sup class="calibre135"><small class="calibre32"><a href="#filepos837118"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos932849"><span class="calibre10"><span class="calibre8"><span class="underline">14<sup class="calibre135"><small class="calibre32"><a href="#filepos932849"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1049237"><span class="calibre10"><span class="calibre8"><span class="underline">20<sup class="calibre135"><small class="calibre32"><a href="#filepos1049237"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos939799"><span class="calibre10"><span class="calibre8"><span class="underline">anonymous</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos606505"><span class="calibre10"><span class="calibre8"><span class="underline">root binding</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos932849"><span class="calibre10"><span class="calibre8"><span class="underline">var</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos939799"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos939799"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos939799"><span class="calibre10"><span class="calibre8"><span class="underline">var-get</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos939799"><span class="calibre10"><span class="calibre8"><span class="underline">with-local-vars</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos175471"><span class="calibre10"><span class="calibre8"><span class="underline">vectors</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos205283"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos205283"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos346086"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos346086"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos353159"><span class="calibre10"><span class="calibre8"><span class="underline">7<sup class="calibre135"><small class="calibre32"><a href="#filepos353159"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos410404"><span class="calibre10"><span class="calibre8"><span class="underline">15<sup class="calibre135"><small class="calibre32"><a href="#filepos410404"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos692267"><span class="calibre10"><span class="calibre8"><span class="underline">17<sup class="calibre135"><small class="calibre32"><a href="#filepos692267"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos367438"><span class="calibre10"><span class="calibre8"><span class="underline">as stacks</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos692267"><span class="calibre10"><span class="calibre8"><span class="underline">IPersistentVector</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos706927"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos706927"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos255350"><span class="calibre10"><span class="calibre8"><span class="underline">of names</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos355623"><span class="calibre10"><span class="calibre8"><span class="underline">of primitives</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos374641"><span class="calibre10"><span class="calibre8"><span class="underline">subvectors</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos355623"><span class="calibre10"><span class="calibre8"><span class="underline">vec</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos191973"><span class="calibre10"><span class="calibre8"><span class="underline">vector</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos202245"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos202245"><span class="calibre33"><span class="calibre8"><span class="underline">nd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos355623"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos355623"><span class="calibre33"><span class="calibre8"><span class="underline">rd</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos487698"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos487698"><span class="calibre33"><span class="calibre8"><span class="underline">th</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos853266"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos853266"><span class="calibre33"><span class="calibre8"><span class="underline">th</span></span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos1010279"><span class="calibre10"><span class="calibre8"><span class="underline">6<sup class="calibre135"><small class="calibre32"><a href="#filepos1010279"><span class="calibre33"><span class="calibre8"><span class="underline">th</span></span></span></a></small></sup></span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos355623"><span class="calibre10"><span class="calibre8"><span class="underline">vector-of</span></span></span></a><a></a><br class="calibre3"/><span class="calibre10"><tt class="calibre11">  </tt></span><a href="#filepos359275"><span class="calibre10"><span class="calibre8"><span class="underline">walking in reverse order</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos535370"><span class="calibre10"><span class="calibre8"><span class="underline">verbosity</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos717394"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos717394"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos140178"><span class="calibre10"><span class="calibre8"><span class="underline">verbs</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos899564"><span class="calibre10"><span class="calibre8"><span class="underline">very bad things</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos265366"><span class="calibre10"><span class="calibre8"><span class="underline">visible</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos746497"><span class="calibre10"><span class="calibre8"><span class="underline">void</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos717394"><span class="calibre10"><span class="calibre8"><span class="underline">volatile</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span></p><p id="filepos1456967" class="calibre5"><span class="bold">W</span></p><p class="calibre5"><a href="#filepos124211"><span class="calibre10"><span class="calibre8"><span class="underline">when</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos198412"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos198412"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos265366"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos265366"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos599655"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos599655"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos624210"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos624210"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos471319"><span class="calibre10"><span class="calibre8"><span class="underline">when-let</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos627241"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos627241"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos603106"><span class="calibre10"><span class="calibre8"><span class="underline">when-not</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos317285"><span class="calibre10"><span class="calibre8"><span class="underline">where-am-i</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos124211"><span class="calibre10"><span class="calibre8"><span class="underline">while</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos285054"><span class="calibre10"><span class="calibre8"><span class="underline">Whitehead, Alfred North</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos324854"><span class="calibre10"><span class="calibre8"><span class="underline">whitespace, ignoring</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos320736"><span class="calibre10"><span class="calibre8"><span class="underline">wit</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos945059"><span class="calibre10"><span class="calibre8"><span class="underline">with-binding</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos353159"><span class="calibre10"><span class="calibre8"><span class="underline">with-open</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos631267"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos631267"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos948562"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos948562"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos945059"><span class="calibre10"><span class="calibre8"><span class="underline">with-out-str</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos945059"><span class="calibre10"><span class="calibre8"><span class="underline">with-precision</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos1025528"><span class="calibre10"><span class="calibre8"><span class="underline">with-redefs</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos631267"><span class="calibre10"><span class="calibre8"><span class="underline">with-resource</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos385731"><span class="calibre10"><span class="calibre8"><span class="underline">workflow</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos570402"><span class="calibre10"><span class="calibre8"><span class="underline">world</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos348941"><span class="calibre10"><span class="calibre8"><span class="underline">worst-case</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos699217"><span class="calibre10"><span class="calibre8"><span class="underline">wrapping</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos917181"><span class="calibre10"><span class="calibre8"><span class="underline">write-once</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span></p><p id="filepos1461242" class="calibre5"><span class="bold">X</span></p><p class="calibre5"><a href="#filepos438268"><span class="calibre10"><span class="calibre8"><span class="underline">xconj</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos444400"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos444400"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos685935"><span class="calibre10"><span class="calibre8"><span class="underline">3<sup class="calibre135"><small class="calibre32"><a href="#filepos685935"><span class="calibre33"><span class="calibre8">rd</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos692267"><span class="calibre10"><span class="calibre8"><span class="underline">4<sup class="calibre135"><small class="calibre32"><a href="#filepos692267"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos699217"><span class="calibre10"><span class="calibre8"><span class="underline">5<sup class="calibre135"><small class="calibre32"><a href="#filepos699217"><span class="calibre33"><span class="calibre8">th</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos262114"><span class="calibre10"><span class="calibre8"><span class="underline">xor</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos252163"><span class="calibre10"><span class="calibre8"><span class="underline">xs</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span><a></a><br class="calibre3"/><a href="#filepos685935"><span class="calibre10"><span class="calibre8"><span class="underline">xseq</span></span></span></a><a></a><span class="calibre10"><tt class="calibre11">, </tt></span><a href="#filepos712847"><span class="calibre10"><span class="calibre8"><span class="underline">2<sup class="calibre135"><small class="calibre32"><a href="#filepos712847"><span class="calibre33"><span class="calibre8">nd</span></span></a></small></sup></span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span></p><p id="filepos1462953" class="calibre5"><span class="bold">Y</span></p><p class="calibre5"><a href="#filepos658019"><span class="calibre10"><span class="calibre8"><span class="underline">Yegge, Steve</span></span></span></a><span class="calibre10"><tt class="calibre11">
</tt></span></p><div class="mbppagebreak"></div><p id="filepos1463166" class="calibre5"><span class="calibre6"><span class="bold">List of Figures</span></span></p><p class="calibre7">Chapter 1. Clojure philosophy</p><blockquote class="calibre21"><a href="#filepos111024"><span class="calibre8"><span class="underline">Figure 1.1. Broad goals of Clojure: this figure shows some of the concepts that underlie the Clojure philosophy, and how they intersect.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos143035"><span class="calibre8"><span class="underline">Figure 1.2. The Runner: a child’s flip book serves to illustrate Clojure’s notions of state, time, and identity. The book itself represents the identity. Whenever you wish to show a change in the illustration, you draw another picture and add it to the end of your flip book. The act of flipping the pages therefore represents the states over time of the image within. Stopping at any given page and observing the particular picture represents the state of the Runner at that moment in time.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos144469"><span class="calibre8"><span class="underline">Figure 1.3. The Mutable Runner: modeling state change with mutation requires that you stock up on erasers. Your book becomes a single page, requiring that in order to model changes, you must physically erase and redraw the parts of the picture requiring change. Using this model, you should see that mutation destroys all notion of time, and state and identity become one.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos154603"><span class="calibre8"><span class="underline">Figure 1.4. The corresponding chessboard layout</span></span></a><br class="calibre3"/></blockquote><p class="calibre5">Chapter 3. Dipping our toes in the pool</p><blockquote class="calibre21"><a href="#filepos273649"><span class="calibre8"><span class="underline">Figure 3.1. Visualization of xor. This is the graphic drawn by the six or so lines of code we’ve looked at so far—a visual representation of Clojure’s bit-xor function.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos281414"><span class="calibre8"><span class="underline">Figure 3.2. Three possible results from draw-values. The draw-values function you’ve written can be used to create a variety of graphics. Here are examples, from left to right, of bit-and, +, and *.</span></span></a><br class="calibre3"/></blockquote><p class="calibre5">Chapter 5. Composite data types</p><blockquote class="calibre21"><a href="#filepos344670"><span class="calibre8"><span class="underline">Figure 5.1. Each cons-cell is a simple pair, a car and a cdr. A. A list with two cells, each of which has a value X and Y as the head (the car in Lisp terminology) and a list as the tail (the cdr). This is very similar to first and rest in Clojure sequences. B. A cons-cell with a simple value for both the head and tail. This is called a dotted pair but is not supported by any of Clojure’s built in types.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos352083"><span class="calibre8"><span class="underline">Figure 5.2. Overtaking the smaller. In Big-O, regardless of the other ancillary costs, the higher order of magnitude will always overtake the lower eventually.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos393595"><span class="calibre8"><span class="underline">Figure 5.3. The two collections used internally in a single queue. peek returns the front item of the seq, pop returns a new queue with the front of the seq left off, and conj adds a new item to the back of the vector.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos404423"><span class="calibre8"><span class="underline">Figure 5.4. Basic set operations. The three Venn diagrams show a graphical representation of Clojure’s set functions: intersection, union, and difference.</span></span></a><br class="calibre3"/></blockquote><p class="calibre5">Chapter 6. Being lazy and set in your ways</p><blockquote class="calibre21"><a href="#filepos445764"><span class="calibre8"><span class="underline">Figure 6.1. Shared structure tree: no matter how big the left side of a tree’s root node is, something can be inserted on the right side without copying, changing, or even examining the left side. All those values will be included in the new tree, along with the inserted value.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos462756"><span class="calibre8"><span class="underline">Figure 6.2. Each step of a lazy seq may be in one of two states. If the step is unrealized, it’ll contain a function or closure of no arguments (a thunk) that can be called later to realize the step. When this happens, the thunk’s return value is cached instead, and the thunk itself is released as pictured in the first two lazy seq boxes, transitioning the step to the realized state. Note that although not shown here, a realized lazy seq may simply contain nothing at all, called nil, indicating the end of the seq.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos474086"><span class="calibre8"><span class="underline">Figure 6.3. Lazy linked-list example. Each node of this linked list contains a value (the head) and a delay (the tail). The creation of the next part is forced by a call to tail—it doesn’t exist until then.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos480146"><span class="calibre8"><span class="underline">Figure 6.4. The qsort function shown earlier would use a structure like this for its work list when sorting the vector [2 1 4 3]. Note that all the parts described by a standard quicksort implementation are represented here.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos482180"><span class="calibre8"><span class="underline">Figure 6.5. Internal structure of qsort. Each filter and remove lazily returns items from its parent sequence only as required. So to return the first two items of the seq returned by qsort, no remove steps are required from either level A or B. To generate the sequence (4), a single remove step at level B would be needed to eliminate everything less than 3. As more items are forced from the seq returned by qsort, more of the internal filter and remove steps will be run.</span></span></a><br class="calibre3"/></blockquote><p class="calibre5">Chapter 7. Functional programming</p><blockquote class="calibre21"><a href="#filepos552315"><span class="calibre8"><span class="underline">Figure 7.1. Generalized tail-call optimization: if you know that A calls B in the tail position, then you also know that A’s resources are no longer needed, allowing Scheme to deallocate them and defer to B for the return call instead.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos565086"><span class="calibre8"><span class="underline">Figure 7.2. Elevator trampoline: the trampoline function explicitly bounces between mutually recursive calls.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos578930"><span class="calibre8"><span class="underline">Figure 7.3. A graphical representation of Z World clearly shows the optimal/only path.</span></span></a><br class="calibre3"/></blockquote><p class="calibre5">Chapter 8. Macros</p><blockquote class="calibre21"><a href="#filepos586117"><span class="calibre8"><span class="underline">Figure 8.1. Arrow macro: each expression is inserted into the following one at compile time, allowing you to write the whole expression inside-out when that feels more natural.</span></span></a><br class="calibre3"/></blockquote><p class="calibre5">Chapter 9. Combining data and code</p><blockquote class="calibre21"><a href="#filepos645083"><span class="calibre8"><span class="underline">Figure 9.1. The logical layout of namespaces. The process to resolve a Var joy.ns/authors includes a symbolic resolution of the namespace and the Var name. The result is the Var itself. Aliases created with :use work as expected.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos652310"><span class="calibre8"><span class="underline">Figure 9.2. Namespace private directories: the directories layout for an illustrative joy.contracts namespace</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos653707"><span class="calibre8"><span class="underline">Figure 9.3. Namespace private source: the top of the source file for the joy.contracts namespace</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos656017"><span class="calibre8"><span class="underline">Figure 9.4. Private API directories: using the folder layout to hide namespace implementation details</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos656809"><span class="calibre8"><span class="underline">Figure 9.5. Private API source: the client-facing API is located in contracts.clj and the private API in impl.clj.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos672728"><span class="calibre8"><span class="underline">Figure 9.6. Hierarchy conflict: most languages allowing type derivations use a built-in conflict-resolution strategy. In the case of CLOS, it’s fully customizable. Clojure requires conflicts to be resolved with prefer-method.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos698862"><span class="calibre8"><span class="underline">Figure 9.7. As opposed to the notion of monkey-patching and wrapping, the polymorphism in Clojure resides in the functions themselves and not in the classes worked with.</span></span></a><br class="calibre3"/></blockquote><p class="calibre5">Chapter 10. Java.next</p><blockquote class="calibre21"><a href="#filepos742637"><span class="calibre8"><span class="underline">Figure 10.1. Proxy lookup: the instance returned by proxy is a proper proxy that does method dispatch to functions in a lookup table. These functions can therefore be swapped out with replacements as needed.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos753417"><span class="calibre8"><span class="underline">Figure 10.2. A simple use of DynaFrame: now that you’ve compiled the DynaFrame class, you can start using it to display simple GUIs.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos754370"><span class="calibre8"><span class="underline">Figure 10.3. A simple dynamic update of DynaFrame: we can update the DynaFrame on the fly without restarting.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos759769"><span class="calibre8"><span class="underline">Figure 10.4. Basic GUI containers: using only a handful of rudimentary containers, we can build neato GUI prototypes.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos763424"><span class="calibre8"><span class="underline">Figure 10.5. DynaFrame alerts: we can create slightly more complex GUIs and attach actions on the fly.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos764901"><span class="calibre8"><span class="underline">Figure 10.6. A much more elaborate DynaFrame GUI: there’s no limit to the complexity of this simple GUI model. Go ahead and experiment to your heart’s content.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos815962"><span class="calibre8"><span class="underline">Figure 10.7. Outside-in and inside-out error handling. There are two ways to handle errors in Clojure. The typical way is to let exceptions flow from the inner forms to the outer. The other way, discussed in section 13.4, uses dynamic bindings to “reach into” the inner forms to handle them immediately.</span></span></a><br class="calibre3"/></blockquote><p class="calibre5">Chapter 11. Mutation</p><blockquote class="calibre21"><a href="#filepos826884"><span class="calibre8"><span class="underline">Figure 11.1. Illustrating an STM retry: Clojure’s STM works much like a database.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos828391"><span class="calibre8"><span class="underline">Figure 11.2. Clojure’s embedded transactions: a restart in any of Clojure’s embedded transactions A, B, b, and C causes a restart in the whole subsuming transaction. This is unlike a fully embedded transaction system where the subtransactions can be used to restrain the scope of restarts.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos838084"><span class="calibre8"><span class="underline">Figure 11.3. Clojure’s four reference types are listed across the top, with their features listed down the left. Atoms are for lone synchronous objects. Agents are for asynchronous actions. Vars are for thread-local storage. Refs are for synchronously coordinating multiple objects.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos847883"><span class="calibre8"><span class="underline">Figure 11.4. Alter path: the in-transaction value 9 for the Ref num-moves is retrieved in the body of the transaction and manipulated with the alter function inc. This resulting value 10 is eventually used for the commit-time value, unless a retry is required.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos850181"><span class="calibre8"><span class="underline">Figure 11.5. Splitting coordinated Refs: if Refs A and B should be coordinated, then splitting their updates across different transactions is dangerous. Value a? is eventually committed to A, but the update for B never commits due to retry and coordination is lost. Another error occurs if B’s change depends on A’s value and A and B are split across transactions. There are no guarantees that the dependent values refer to the same timeline.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos853937"><span class="calibre8"><span class="underline">Figure 11.6. Commute path: the in-transaction value 9 in the num-moves Ref is retrieved in the body of the transaction and manipulated with the commute function. But the commute function inc is again run at commit time with the current value 13 contained in the Ref. The result of this action serves as the committed value 14.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos865644"><span class="calibre8"><span class="underline">Figure 11.7. Clojure agents versus Erlang processes: each Agent and process starts with the value 1. Both receive an inc request simultaneously but can only process one at a time, so more are queued. Requests to the process are queued until a response can be delivered, whereas any number of simultaneous derefs can be done on an Agent. Despite what this illustration may suggest, an Agent is not just an actor with a hat on.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos875814"><span class="calibre8"><span class="underline">Figure 11.8. Agents using send versus send-off. When an Agent is idle, no CPU resources are being consumed. Each action is sent to an Agent using either send or send-off, which determines which thread pool will be used to dequeue and apply the action. Because actions queued with send are applied by a limited thread pool, the Agents queue up for access to these threads, a constraint that doesn’t apply to actions queued with send-off.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos938265"><span class="calibre8"><span class="underline">Figure 11.9. Thread-local Var bindings. This illustration depicts a single Var being used from three different threads. Each rounded box is a Var binding, either thread-local or root. Each star is the Var being deref’ed, with the solid arrow pointing to the binding used. The dotted lines point from a thread-local binding to the next binding on the stack.</span></span></a><br class="calibre3"/></blockquote><p class="calibre5">Chapter 12. Performance</p><blockquote class="calibre21"><a href="#filepos971780"><span class="calibre8"><span class="underline">Figure 12.1. Clojure’s chunked sequences allow a windowed view of a sequence. This model is more efficient, in that it allows for larger swaths of memory to be reclaimed by the garbage collector and better cache locality in general. There’s a cost to total laziness, but often the benefit gained is worth the cost.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos974986"><span class="calibre8"><span class="underline">Figure 12.2. Using seq1, you can again reclaim the one-at-a-time sequence model. Though not as efficient as the chunked model, it does again provide total sequence laziness.</span></span></a><br class="calibre3"/></blockquote><div class="mbppagebreak"></div><p id="filepos1479906" class="calibre5"><span class="calibre6"><span class="bold">List of Tables</span></span></p><p class="calibre7">Chapter 1. Clojure philosophy</p><blockquote class="calibre21"><a href="#filepos120543"><span class="calibre8"><span class="underline">Table 1.1. Separation of concerns in Clojure</span></span></a><br class="calibre3"/></blockquote><p class="calibre5">Chapter 4. On scalars</p><blockquote class="calibre21"><a href="#filepos325186"><span class="calibre8"><span class="underline">Table 4.1. Regex flags: these are the flags that can be used within Clojure regular expression patterns, their long name, and a description of what they do. See Java’s documentation for the java.util. regex.Pattern class for more details.</span></span></a><br class="calibre3"/></blockquote><p class="calibre5">Chapter 5. Composite data types</p><blockquote class="calibre21"><a href="#filepos361034"><span class="calibre8"><span class="underline">Table 5.1. Vector lookup options: the three ways to look up an item in a vector and how each responds to different exceptional circumstances</span></span></a><br class="calibre3"/></blockquote><p class="calibre5">Chapter 7. Functional programming</p><blockquote class="calibre21"><a href="#filepos554649"><span class="calibre8"><span class="underline">Table 7.1. Tail positions and recur targets</span></span></a><br class="calibre3"/></blockquote><p class="calibre5">Chapter 10. Java.next</p><blockquote class="calibre21"><a href="#filepos777777"><span class="calibre8"><span class="underline">Table 10.1. Array type class names and dimensions</span></span></a><br class="calibre3"/></blockquote><p class="calibre5">Chapter 11. Mutation</p><blockquote class="calibre21"><a href="#filepos942578"><span class="calibre8"><span class="underline">Table 11.1. Var states</span></span></a><br class="calibre3"/></blockquote><div class="mbppagebreak"></div><p id="filepos1481669" class="calibre5"><span class="calibre6"><span class="bold">List of Listings</span></span></p><p class="calibre7">Chapter 1. Clojure philosophy</p><blockquote class="calibre21"><a href="#filepos132659"><span class="calibre8"><span class="underline">Listing 1.1. A domain-specific language for embedding SQL queries in Clojure</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos149136"><span class="calibre8"><span class="underline">Listing 1.2. Clojure’s polymorphic protocols</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos154043"><span class="calibre8"><span class="underline">Listing 1.3. A simple chessboard representation in Clojure</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos156852"><span class="calibre8"><span class="underline">Listing 1.4. Querying the squares of a chessboard</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos157551"><span class="calibre8"><span class="underline">Listing 1.5. Using block-level encapsulation</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos159063"><span class="calibre8"><span class="underline">Listing 1.6. Local encapsulation</span></span></a><br class="calibre3"/></blockquote><p class="calibre5">Chapter 4. On scalars</p><blockquote class="calibre21"><a href="#filepos293214"><span class="calibre8"><span class="underline">Listing 4.1. Automatic promotion in Clojure</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos297184"><span class="calibre8"><span class="underline">Listing 4.2. Illustrating the Patriot missile tragedy</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos301601"><span class="calibre8"><span class="underline">Listing 4.3. Floating-point arithmetic isn’t associative or distributive.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos302924"><span class="calibre8"><span class="underline">Listing 4.4. Being rational preserves associativity and distributive natures.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos308601"><span class="calibre8"><span class="underline">Listing 4.5. Using a keyword as a function directive</span></span></a><br class="calibre3"/></blockquote><p class="calibre5">Chapter 5. Composite data types</p><blockquote class="calibre21"><a href="#filepos366893"><span class="calibre8"><span class="underline">Listing 5.1. A function for finding the neighbors of a spot on a 2D matrix</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos422521"><span class="calibre8"><span class="underline">Listing 5.2. First cut at our position function</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos424090"><span class="calibre8"><span class="underline">Listing 5.3. An index function</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos427099"><span class="calibre8"><span class="underline">Listing 5.4. Our final version of pos</span></span></a><br class="calibre3"/></blockquote><p class="calibre5">Chapter 6. Being lazy and set in your ways</p><blockquote class="calibre21"><a href="#filepos452795"><span class="calibre8"><span class="underline">Listing 6.1. Short-circuiting if expression</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos467498"><span class="calibre8"><span class="underline">Listing 6.2. Infinite sequences foster declarative solutions.</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos478379"><span class="calibre8"><span class="underline">Listing 6.3. A lazy, tail-recursive quicksort implementation</span></span></a><br class="calibre3"/></blockquote><p class="calibre5">Chapter 7. Functional programming</p><blockquote class="calibre21"><a href="#filepos513725"><span class="calibre8"><span class="underline">Listing 7.1. Named arguments in Clojure functions</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos515915"><span class="calibre8"><span class="underline">Listing 7.2. Testing the slope function constraints</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos518864"><span class="calibre8"><span class="underline">Listing 7.3. Menu constraints</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos544926"><span class="calibre8"><span class="underline">Listing 7.4. A version of pow using mundane recursion</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos546930"><span class="calibre8"><span class="underline">Listing 7.5. A version of pow using tail recursion, accumulator, and helper function</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos562122"><span class="calibre8"><span class="underline">Listing 7.6. Using mutually recursive functions to implement a finite state machine</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos566933"><span class="calibre8"><span class="underline">Listing 7.7. Factorial function using continuation-passing style</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos567603"><span class="calibre8"><span class="underline">Listing 7.8. Continuation-passing style function generator</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos572883"><span class="calibre8"><span class="underline">Listing 7.9. A straight-line h function to estimate remaining path cost</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos573913"><span class="calibre8"><span class="underline">Listing 7.10. A g function used to calculate the cost of the path traversed so far</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos574431"><span class="calibre8"><span class="underline">Listing 7.11. f function to calculate the estimated cost of the path (+ (g ...) (h ...))</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos576669"><span class="calibre8"><span class="underline">Listing 7.12. The main A* algorithm</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos578082"><span class="calibre8"><span class="underline">Listing 7.13. Running the A* algorithm on the Z World</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos579454"><span class="calibre8"><span class="underline">Listing 7.14. The Shrubbery World</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos579953"><span class="calibre8"><span class="underline">Listing 7.15. The bunny world</span></span></a><br class="calibre3"/></blockquote><p class="calibre5">Chapter 8. Macros</p><blockquote class="calibre21"><a href="#filepos592485"><span class="calibre8"><span class="underline">Listing 8.1. An implementation of eval taking a local context</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos605299"><span class="calibre8"><span class="underline">Listing 8.2. A Clojure Implementation of unless</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos606658"><span class="calibre8"><span class="underline">Listing 8.3. Name capture in unless</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos614432"><span class="calibre8"><span class="underline">Listing 8.4. Domain DSL’s underlying form</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos618979"><span class="calibre8"><span class="underline">Listing 8.5. Exploring the domain DSL results</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos620626"><span class="calibre8"><span class="underline">Listing 8.6. An XML transformation of the domain DSL structure</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos627003"><span class="calibre8"><span class="underline">Listing 8.7. An example of anaphora and its weakness</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos631838"><span class="calibre8"><span class="underline">Listing 8.8. An example of with-open</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos632346"><span class="calibre8"><span class="underline">Listing 8.9. A more general template for with-open-like macros</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos636559"><span class="calibre8"><span class="underline">Listing 8.10. The contract top-level macro</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos638511"><span class="calibre8"><span class="underline">Listing 8.11. The contract auxiliary function build-contract</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos639229"><span class="calibre8"><span class="underline">Listing 8.12. Composition of contract function and constrained function</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos639698"><span class="calibre8"><span class="underline">Listing 8.13. Contract for multiple-arity functions</span></span></a><br class="calibre3"/></blockquote><p class="calibre5">Chapter 9. Combining data and code</p><blockquote class="calibre21"><a href="#filepos645922"><span class="calibre8"><span class="underline">Listing 9.1. Namespace navigation</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos687613"><span class="calibre8"><span class="underline">Listing 9.2. Persistent binary tree built of records</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos701372"><span class="calibre8"><span class="underline">Listing 9.3. Complete implementations of FIXO for TreeNode and vector</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos705474"><span class="calibre8"><span class="underline">Listing 9.4. Using a map to extend FIXO to TreeNode</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos707240"><span class="calibre8"><span class="underline">Listing 9.5. Size-limited stack FIXO using reify</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos711083"><span class="calibre8"><span class="underline">Listing 9.6. Method implementations in defrecord</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos717118"><span class="calibre8"><span class="underline">Listing 9.7. Implementing map interfaces with deftype</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos726757"><span class="calibre8"><span class="underline">Listing 9.8. A chess move record</span></span></a><br class="calibre3"/></blockquote><p class="calibre5">Chapter 10. Java.next</p><blockquote class="calibre21"><a href="#filepos738154"><span class="calibre8"><span class="underline">Listing 10.1. A simple dynamic web service</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos739919"><span class="calibre8"><span class="underline">Listing 10.2. Convenience functions for changing the web service message</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos749927"><span class="calibre8"><span class="underline">Listing 10.3. The DynaFrame class namespace declaration</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos760452"><span class="calibre8"><span class="underline">Listing 10.4. Simple GUI containers</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos762231"><span class="calibre8"><span class="underline">Listing 10.5. A set of simple widgets</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos765317"><span class="calibre8"><span class="underline">Listing 10.6. A more complex GUI example</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos786310"><span class="calibre8"><span class="underline">Listing 10.7. Useful comparison functions</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos791159"><span class="calibre8"><span class="underline">Listing 10.8. java.util.List conformance for sequences and seqs</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos800265"><span class="calibre8"><span class="underline">Listing 10.9. An interface defining a sliceable object</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos801177"><span class="calibre8"><span class="underline">Listing 10.10. A dummy reified ISliceable</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos802096"><span class="calibre8"><span class="underline">Listing 10.11. Using a protocol to extend ISliceable</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos803012"><span class="calibre8"><span class="underline">Listing 10.12. Extending strings along the Sliceable protocol</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos812573"><span class="calibre8"><span class="underline">Listing 10.13. Throwing a compile-time exception</span></span></a><br class="calibre3"/></blockquote><p class="calibre5">Chapter 11. Mutation</p><blockquote class="calibre21"><a href="#filepos845435"><span class="calibre8"><span class="underline">Listing 11.1. Using alter to update a Ref</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos859869"><span class="calibre8"><span class="underline">Listing 11.2. How to make a Ref squirm</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos893807"><span class="calibre8"><span class="underline">Listing 11.3. A resettable memoize function</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos897979"><span class="calibre8"><span class="underline">Listing 11.4. A simple SafeArray protocol</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos901733"><span class="calibre8"><span class="underline">Listing 11.5. An implementation of the SafeArray protocol using the locking macro</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos903555"><span class="calibre8"><span class="underline">Listing 11.6. An implementation of the SafeArray protocol using ReentrantLock</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos912196"><span class="calibre8"><span class="underline">Listing 11.7. Creating a future task to count word occurrences in a tweet</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos913208"><span class="calibre8"><span class="underline">Listing 11.8. A macro to dispatch a sequence of futures</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos915023"><span class="calibre8"><span class="underline">Listing 11.9. Counting string occurrences in Twitter feeds fetched in parallel</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos918866"><span class="calibre8"><span class="underline">Listing 11.10. A macro to dispatch a sequence of promises across a number of threads</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos923086"><span class="calibre8"><span class="underline">Listing 11.11. A macro for transforming a callback-based function to a blocking call</span></span></a><br class="calibre3"/></blockquote><p class="calibre5">Chapter 12. Performance</p><blockquote class="calibre21"><a href="#filepos966899"><span class="calibre8"><span class="underline">Listing 12.1. A concatenation function using transients</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos974049"><span class="calibre8"><span class="underline">Listing 12.2. A dechunkifying seq1 function</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos980877"><span class="calibre8"><span class="underline">Listing 12.3. A protocol for caching</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos981713"><span class="calibre8"><span class="underline">Listing 12.4. A basic cache type</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos983962"><span class="calibre8"><span class="underline">Listing 12.5. A type implementing pluggable memoization</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos985718"><span class="calibre8"><span class="underline">Listing 12.6. A function for applying pluggable memoization to a function</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos995383"><span class="calibre8"><span class="underline">Listing 12.7. Using coercion to gain speed</span></span></a><br class="calibre3"/></blockquote><p class="calibre5">Chapter 13. Clojure changes the way you think</p><blockquote class="calibre21"><a href="#filepos1006584"><span class="calibre8"><span class="underline">Listing 13.1. Examples of Clojure’s relational algebra functions</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos1013436"><span class="calibre8"><span class="underline">Listing 13.2. A function for calculating compositional units of a base unit</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos1015317"><span class="calibre8"><span class="underline">Listing 13.3. A defunits-of macro</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos1023771"><span class="calibre8"><span class="underline">Listing 13.4. Macro to aid in mocking</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos1025228"><span class="calibre8"><span class="underline">Listing 13.5. Using with-redefs to create stubs</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos1028876"><span class="calibre8"><span class="underline">Listing 13.6. clojure.test as a partial specification</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos1039165"><span class="calibre8"><span class="underline">Listing 13.7. A macro to create spreadsheet-cell-like formulas</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos1049540"><span class="calibre8"><span class="underline">Listing 13.8. Handling nefarious tree nodes with exceptions</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos1058516"><span class="calibre8"><span class="underline">Listing 13.9. A modest debug console reader</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos1060199"><span class="calibre8"><span class="underline">Listing 13.10. Creating a map of the local context using &amp;env</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos1061580"><span class="calibre8"><span class="underline">Listing 13.11. The implementation of a breakpoint macro</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos1063085"><span class="calibre8"><span class="underline">Listing 13.12. Using multiple breakpoints in function keys-apply</span></span></a><br class="calibre3"/></blockquote><blockquote class="calibre20"><a href="#filepos1064108"><span class="calibre8"><span class="underline">Listing 13.13. Using a breakpoint in a macro awhen</span></span></a><br class="calibre3"/></blockquote><div class="mbppagebreak"></div><p id="filepos1500620" class="calibre1"><span class="calibre2"><span class="bold">Table of Contents</span></span></p><p class="calibre136"><a href="#filepos466">Copyright</a></p><p class="calibre137"><a href="#filepos3680">Dedication</a></p><p class="calibre137"><a href="#filepos4307">Brief Table of Contents</a></p><p class="calibre137"><a href="#filepos8993">Table of Contents</a></p><p class="calibre137"><a href="#filepos63754">Foreword</a></p><p class="calibre137"><a href="#filepos68289">Preface</a></p><p class="calibre137"><a href="#filepos71697">Acknowledgments</a></p><p class="calibre137"><a href="#filepos75292">About This Book</a></p><p class="calibre137"><a href="#filepos105806">Part 1. Foundations</a></p><p class="calibre137"><a href="#filepos106322">Chapter 1. Clojure philosophy</a></p><p class="calibre137"><a href="#filepos163683">Chapter 2. Drinking from the Clojure firehose</a></p><p class="calibre137"><a href="#filepos235819">Chapter 3. Dipping our toes in the pool</a></p><p class="calibre137"><a href="#filepos284570">Part 2. Data types</a></p><p class="calibre137"><a href="#filepos284964">Chapter 4. On scalars</a></p><p class="calibre137"><a href="#filepos332652">Chapter 5. Composite data types</a></p><p class="calibre137"><a href="#filepos428825">Part 3. Functional programming</a></p><p class="calibre137"><a href="#filepos429362">Chapter 6. Being lazy and set in your ways</a></p><p class="calibre137"><a href="#filepos485904">Chapter 7. Functional programming</a></p><p class="calibre137"><a href="#filepos582206">Part 4. Large-scale design</a></p><p class="calibre137"><a href="#filepos582816">Chapter 8. Macros</a></p><p class="calibre137"><a href="#filepos642230">Chapter 9. Combining data and code</a></p><p class="calibre137"><a href="#filepos731329">Chapter 10. Java.next</a></p><p class="calibre137"><a href="#filepos818901">Chapter 11. Mutation</a></p><p class="calibre137"><a href="#filepos952172">Part 5. Tangential considerations</a></p><p class="calibre137"><a href="#filepos952602">Chapter 12. Performance</a></p><p class="calibre137"><a href="#filepos1001213">Chapter 13. Clojure changes the way you think</a></p><p class="calibre137"><a href="#filepos1067612">Resources</a></p><p class="calibre137"><a href="#filepos1088739">Index</a></p><p class="calibre137"><a href="#filepos1463166">List of Figures</a></p><p class="calibre137"><a href="#filepos1479906">List of Tables</a></p><p class="calibre137"><a href="#filepos1481669">List of Listings</a></p><div class="mbppagebreak"></div><a></a>
<a></a>
<a></a></div>

{% endraw %}

